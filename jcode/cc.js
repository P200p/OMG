System.register([], (function (t, e) { "use strict"; return { execute: function () { function i(t, e) { for (var i = 0; i < e.length; i++) { var n = e[i]; n.enumerable = n.enumerable || !1, n.configurable = !0, "value" in n && (n.writable = !0), Object.defineProperty(t, g(n.key), n) } } function n(t, e, n) { return e && i(t.prototype, e), n && i(t, n), Object.defineProperty(t, "prototype", { writable: !1 }), t } function r() { return r = Object.assign ? Object.assign.bind() : function (t) { for (var e = 1; e < arguments.length; e++) { var i = arguments[e]; for (var n in i) Object.prototype.hasOwnProperty.call(i, n) && (t[n] = i[n]) } return t }, r.apply(this, arguments) } function s(t, e) { t.prototype = Object.create(e.prototype), t.prototype.constructor = t, o(t, e) } function a(t) { return a = Object.setPrototypeOf ? Object.getPrototypeOf.bind() : function (t) { return t.__proto__ || Object.getPrototypeOf(t) }, a(t) } function o(t, e) { return o = Object.setPrototypeOf ? Object.setPrototypeOf.bind() : function (t, e) { return t.__proto__ = e, t }, o(t, e) } function u() { if ("undefined" == typeof Reflect || !Reflect.construct) return !1; if (Reflect.construct.sham) return !1; if ("function" == typeof Proxy) return !0; try { return Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], (function () { }))), !0 } catch (t) { return !1 } } function h(t, e, i) { return h = u() ? Reflect.construct.bind() : function (t, e, i) { var n = [null]; n.push.apply(n, e); var r = new (Function.bind.apply(t, n)); return i && o(r, i.prototype), r }, h.apply(null, arguments) } function c(t) { var e = "function" == typeof Map ? new Map : void 0; return c = function (t) { if (null === t || (i = t, -1 === Function.toString.call(i).indexOf("[native code]"))) return t; var i; if ("function" != typeof t) throw new TypeError("Super expression must either be null or a function"); if (void 0 !== e) { if (e.has(t)) return e.get(t); e.set(t, n) } function n() { return h(t, arguments, a(this).constructor) } return n.prototype = Object.create(t.prototype, { constructor: { value: n, enumerable: !1, writable: !0, configurable: !0 } }), o(n, t) }, c(t) } function l(t) { if (void 0 === t) throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); return t } function f(t, e) { if (t) { if ("string" == typeof t) return d(t, e); var i = Object.prototype.toString.call(t).slice(8, -1); return "Object" === i && t.constructor && (i = t.constructor.name), "Map" === i || "Set" === i ? Array.from(t) : "Arguments" === i || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i) ? d(t, e) : void 0 } } function d(t, e) { (null == e || e > t.length) && (e = t.length); for (var i = 0, n = new Array(e); i < e; i++)n[i] = t[i]; return n } function p(t, e) { var i = "undefined" != typeof Symbol && t[Symbol.iterator] || t["@@iterator"]; if (i) return (i = i.call(t)).next.bind(i); if (Array.isArray(t) || (i = f(t)) || e) { i && (t = i); var n = 0; return function () { return n >= t.length ? { done: !0 } : { done: !1, value: t[n++] } } } throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.") } function _(t, e) { if ("object" != typeof t || null === t) return t; var i = t[Symbol.toPrimitive]; if (void 0 !== i) { var n = i.call(t, e); if ("object" != typeof n) return n; throw new TypeError("@@toPrimitive must return a primitive value.") } return String(t) } function g(t) { var e = _(t, "string"); return "symbol" == typeof e ? e : String(e) } function m(t, e, i, n, r) { var s = {}; return Object.keys(n).forEach((function (t) { s[t] = n[t] })), s.enumerable = !!s.enumerable, s.configurable = !!s.configurable, ("value" in s || s.initializer) && (s.writable = !0), s = i.slice().reverse().reduce((function (i, n) { return n(t, e, i) || i }), s), r && void 0 !== s.initializer && (s.value = s.initializer ? s.initializer.call(r) : void 0, s.initializer = void 0), void 0 === s.initializer && (Object.defineProperty(t, e, s), s = null), s } function v(t, e) { const i = "undefined" == typeof window ? global : window; return void 0 === i[t] ? i[t] = e : i[t] } t({ BitMask: Se, CCClass: Pi, Enum: Ee, Eventify: bo, WorldNode3DToLocalNodeUI: jo, WorldNode3DToWorldNodeUI: Xo, __checkObsoleteInNamespace__: function (t) { return bt || (bt = "undefined" == typeof Proxy ? {} : new Proxy(t, { get: function (t, e, i) { return Tt(e), Reflect.get(t, e, i) } })), bt }, __checkObsolete__: function (t) { for (var e, i = p(t); !(e = i()).done;)Tt(e.value) }, _resetDebugSetting: Y, absMax: cn, absMaxComponent: hn, applyMixins: function (t, e) { e.forEach((function (e) { Object.getOwnPropertyNames(e.prototype).forEach((function (i) { "constructor" !== i && Object.defineProperty(t.prototype, i, Object.getOwnPropertyDescriptor(e.prototype, i)) })) })) }, approx: ji, assert: X, assertID: at, assertIsNonNullable: function () { }, assertIsTrue: function () { }, assertsArrayIndex: Te, bezier: bl, bezierByTime: kl, binarySearch: function (t, e) { return Eu(t, e, 0) }, binarySearchBy: function (t, e, i) { for (var n = 0, r = t.length - 1, s = r >>> 1; n <= r; s = n + r >>> 1) { var a = t[s]; if (i(a, e) < 0) r = s - 1; else { if (!(i(a, e) > 0)) return s; n = s + 1 } } return ~n }, binarySearchEpsilon: Eu, ccenum: De, clamp: Xi, clamp01: qi, color: sr, debug: q, debugID: tt, deprecateModuleExportedName: St, deserialize: Jm, enumerableProps: ln, equals: Wi, error: j, errorID: rt, find: dP, flattenCodeArray: Uf, floatToHalf: gn, formerlySerializedAs: ih, fragmentText: ZO, getBaselineOffset: RO, getEnglishWordPartAtFirst: KO, getEnglishWordPartAtLast: QO, getError: ut, getSerializationMetadata: function (t) { return t[th] }, getSymbolAt: WO, getSymbolCodeAt: jO, getSymbolLength: HO, halfToFloat: mn, instantiate: mW, inverseLerp: un, isCCClassOrFastDefined: Bi, isCCObject: co, isDisplayStats: ht, isEnglishWordPartAtFirst: function (t) { return zO.test(t) }, isEnglishWordPartAtLast: function (t) { return NO.test(t) }, isUnicodeCJK: UO, isUnicodeSpace: VO, isValid: lo, lerp: Yi, log: H, logID: J, mat4: jr, murmurhash2_32_gc: Lf, nextPow2: sn, pingPong: on, pseudoRandom: en, pseudoRandomRange: nn, pseudoRandomRangeInt: rn, quat: Mr, random: Zi, randomRange: $i, randomRangeInt: tn, rect: ds, repeat: an, safeMeasureText: GO, setDefaultLogTimes: function (t) { t > 0 && (mt = t) }, setDisplayStats: ct, setPropertyEnumType: function (t, e, i) { vi(ei(t), e, i) }, setPropertyEnumTypeOnAttrs: vi, setRandGenerator: Ji, shift: function (t, e, i) { if (Te(t, e), Te(t, i), e === i) return t; var n = t[e]; if (e < i) for (var r = e + 1; r <= i; ++r)t[r - 1] = t[r]; else for (var s = e; s !== i; --s)t[s] = t[s - 1]; return t[i] = n, t }, size: hs, toDegree: Qi, toRadian: Ki, tween: c$, tweenUtil: l$, v2: os, v3: Qn, v4: Bn, warn: W, warnID: it }), v("CC_WECHAT", !1), v("CC_XIAOMI", !1), v("CC_ALIPAY", !1), v("CC_BYTEDANCE", !1), v("CC_OPPO", !1), v("CC_VIVO", !1), v("CC_HUAWEI", !1), v("CC_MIGU", !1), v("CC_HONOR", !1), v("CC_COCOS_RUNTIME", !1); const y = !1; v("CC_EDITOR", !1); const b = !1; v("CC_PREVIEW", !1), v("CC_BUILD", !0), v("CC_TEST", !1), v("CC_DEBUG", !1), v("CC_DEV", !1), v("CC_MINIGAME", !1), v("CC_RUNTIME_BASED", !1), v("CC_SUPPORT_JIT", !0), v("CC_JSB", !1); const w = !1; var x = "undefined" == typeof window ? global : window, S = t("cclegacy", { _global: x }), T = S; S.internal = {}; var I = t("VERSION", "3.8.6"); x.CocosEngine = T.ENGINE_VERSION = I, x.cc = T; var E = void 0 !== globalThis.jsb && void 0 !== jsb.window ? jsb.window : globalThis; x.ccwindow = E; function A(t, e) { return t ^ (t ^ e) & -(t < e) } function C(t) { var e, i; return e = (t > 65535) << 4, e |= i = ((t >>>= e) > 255) << 3, e |= i = ((t >>>= i) > 15) << 2, (e |= i = ((t >>>= i) > 3) << 1) | (t >>>= i) >> 1 } function D(t) { return 16843009 * ((t = (858993459 & (t -= t >>> 1 & 1431655765)) + (t >>> 2 & 858993459)) + (t >>> 4) & 252645135) >>> 24 } function R(t) { var e = 32; return (t &= -t) && e--, 65535 & t && (e -= 16), 16711935 & t && (e -= 8), 252645135 & t && (e -= 4), 858993459 & t && (e -= 2), 1431655765 & t && (e -= 1), e } function P(t) { return --t, t |= t >>> 1, t |= t >>> 2, t |= t >>> 4, t |= t >>> 8, 1 + (t |= t >>> 16) } var B = new Array(256); !function (t) { for (var e = 0; e < 256; ++e) { var i = e, n = e, r = 7; for (i >>>= 1; i; i >>>= 1)n <<= 1, n |= 1 & i, --r; t[e] = n << r & 255 } }(B); var M = Object.freeze({ __proto__: null, INT_BITS: 32, INT_MAX: 2147483647, INT_MIN: -1 << 31, abs: function (t) { var e = t >> 31; return (t ^ e) - e }, countTrailingZeros: R, deinterleave2: function (t, e) { return (t = 65535 & ((t = 16711935 & ((t = 252645135 & ((t = 858993459 & ((t = t >>> e & 1431655765) | t >>> 1)) | t >>> 2)) | t >>> 4)) | t >>> 16)) << 16 >> 16 }, deinterleave3: function (t, e) { return (t = 1023 & ((t = 4278190335 & ((t = 251719695 & ((t = 3272356035 & ((t = t >>> e & 1227133513) | t >>> 2)) | t >>> 4)) | t >>> 8)) | t >>> 16)) << 22 >> 22 }, interleave2: function (t, e) { return (t = 1431655765 & ((t = 858993459 & ((t = 252645135 & ((t = 16711935 & ((t &= 65535) | t << 8)) | t << 4)) | t << 2)) | t << 1)) | (e = 1431655765 & ((e = 858993459 & ((e = 252645135 & ((e = 16711935 & ((e &= 65535) | e << 8)) | e << 4)) | e << 2)) | e << 1)) << 1 }, interleave3: function (t, e, i) { return t = 1227133513 & ((t = 3272356035 & ((t = 251719695 & ((t = 4278190335 & ((t &= 1023) | t << 16)) | t << 8)) | t << 4)) | t << 2), (t |= (e = 1227133513 & ((e = 3272356035 & ((e = 251719695 & ((e = 4278190335 & ((e &= 1023) | e << 16)) | e << 8)) | e << 4)) | e << 2)) << 1) | (i = 1227133513 & ((i = 3272356035 & ((i = 251719695 & ((i = 4278190335 & ((i &= 1023) | i << 16)) | i << 8)) | i << 4)) | i << 2)) << 2 }, isPow2: function (t) { return !(t & t - 1 || !t) }, log10: function (t) { return t >= 1e9 ? 9 : t >= 1e8 ? 8 : t >= 1e7 ? 7 : t >= 1e6 ? 6 : t >= 1e5 ? 5 : t >= 1e4 ? 4 : t >= 1e3 ? 3 : t >= 100 ? 2 : t >= 10 ? 1 : 0 }, log2: C, max: A, min: function (t, e) { return e ^ (t ^ e) & -(t < e) }, nextCombination: function (t) { var e = t | t - 1; return e + 1 | (~e & -~e) - 1 >>> R(t) + 1 }, nextPow2: P, parity: function (t) { return t ^= t >>> 16, t ^= t >>> 8, t ^= t >>> 4, 27030 >>> (t &= 15) & 1 }, popCount: D, prevPow2: function (t) { return t |= t >>> 1, t |= t >>> 2, t |= t >>> 4, t |= t >>> 8, (t |= t >>> 16) - (t >>> 1) }, reverse: function (t) { return B[255 & t] << 24 | B[t >>> 8 & 255] << 16 | B[t >>> 16 & 255] << 8 | B[t >>> 24 & 255] }, sign: function (t) { return (t > 0) - (t < 0) } }); t("bits", M); var O = E.document, L = "https://github.com/cocos/cocos-engine/blob/" + I + "/EngineErrorMap.md", F = null, k = console.log.bind(console), N = k, z = k, U = function (t, e) { if (!t) { for (var i = arguments.length, n = new Array(i > 2 ? i - 2 : 0), r = 2; r < i; r++)n[r - 2] = arguments[r]; console.log("ASSERT: " + G.apply(void 0, [e].concat(n))) } }, V = k; function G() { for (var t = arguments.length, e = new Array(t), i = 0; i < t; i++)e[i] = arguments[i]; return T.js.formatStr.apply(null, e) } function H() { return k.apply(void 0, arguments) } function W() { return N.apply(void 0, arguments) } function j() { return z.apply(void 0, arguments) } function X(t, e) { for (var i = arguments.length, n = new Array(i > 2 ? i - 2 : 0), r = 2; r < i; r++)n[r - 2] = arguments[r]; return U.apply(void 0, [t, e].concat(n)) } function q() { return V.apply(void 0, arguments) } function Y(t) { if (k = N = z = U = V = function () { }, 0 !== t) { if (t > 4) { var e = function (t) { if (T.game.canvas) { if (!F) { var e = O.createElement("Div"); e.setAttribute("id", "logInfoDiv"), e.setAttribute("width", "200"); var i = T.game.canvas.height; e.setAttribute("height", "" + i); var n = e.style; n.zIndex = "99999", n.position = "absolute", n.top = n.left = "0", (F = O.createElement("textarea")).setAttribute("rows", "20"), F.setAttribute("cols", "30"), F.setAttribute("disabled", "true"); var r = F.style; r.backgroundColor = "transparent", r.borderBottom = "1px solid #cccccc", r.borderTopWidth = r.borderLeftWidth = r.borderRightWidth = "0px", r.borderTopStyle = r.borderLeftStyle = r.borderRightStyle = "none", r.padding = "0px", r.margin = "0px", e.appendChild(F), T.game.canvas.parentNode.appendChild(e) } F.value = F.value + t + "\r\n", F.scrollTop = F.scrollHeight } }; z = function () { e("ERROR :  " + G.apply(void 0, arguments)) }, U = function (t, i) { if (!t) { for (var n = arguments.length, r = new Array(n > 2 ? n - 2 : 0), s = 2; s < n; s++)r[s - 2] = arguments[s]; e("ASSERT: " + G.apply(void 0, [i].concat(r))) } }, 7 !== t && (N = function () { e("WARN :  " + G.apply(void 0, arguments)) }), 5 === t && (k = function () { e(G.apply(void 0, arguments)) }) } else console && (console.error || (console.error = console.log), console.warn || (console.warn = console.log), z = console.error.bind ? console.error.bind(console) : function () { for (var t = arguments.length, e = new Array(t), i = 0; i < t; i++)e[i] = arguments[i]; return console.error.apply(console, e) }, U = function (t, e) { if (!t) { for (var i = arguments.length, n = new Array(i > 2 ? i - 2 : 0), r = 2; r < i; r++)n[r - 2] = arguments[r]; var s = G.apply(void 0, [e].concat(n)); throw new Error(s) } }); if (4 !== t && (N = console.warn.bind ? console.warn.bind(console) : function () { for (var t = arguments.length, e = new Array(t), i = 0; i < t; i++)e[i] = arguments[i]; return console.warn.apply(console, e) }), t <= 2 && (k = console.log.bind ? console.log.bind(console) : function () { for (var t = arguments.length, e = new Array(t), i = 0; i < t; i++)e[i] = arguments[i]; return console.log.apply(console, e) }), t <= 1 && "function" == typeof console.debug) { var i = console.debug.bind(console); V = function () { return i.apply(void 0, arguments) } } } } function K(t) { j(t.stack || t) } function Q(t) { return function (e) { for (var i = t + " " + e + ", please go to " + L + "#" + e + " to see details.", n = arguments.length, r = new Array(n > 1 ? n - 1 : 0), s = 1; s < n; s++)r[s - 1] = arguments[s]; return 0 === r.length ? i : i + " Arguments: " + r.join(", ") } } var Z = Q("Log"); function J(t) { for (var e = arguments.length, i = new Array(e > 1 ? e - 1 : 0), n = 1; n < e; n++)i[n - 1] = arguments[n]; H(Z.apply(void 0, [t].concat(i))) } var $ = Q("Debug"); function tt(t) { for (var e = arguments.length, i = new Array(e > 1 ? e - 1 : 0), n = 1; n < e; n++)i[n - 1] = arguments[n]; q($.apply(void 0, [t].concat(i))) } var et = Q("Warning"); function it(t) { for (var e = arguments.length, i = new Array(e > 1 ? e - 1 : 0), n = 1; n < e; n++)i[n - 1] = arguments[n]; W(et.apply(void 0, [t].concat(i))) } var nt = Q("Error"); function rt(t) { for (var e = arguments.length, i = new Array(e > 1 ? e - 1 : 0), n = 1; n < e; n++)i[n - 1] = arguments[n]; j(nt.apply(void 0, [t].concat(i))) } var st = Q("Assert"); function at(t, e) { if (!t) { for (var i = arguments.length, n = new Array(i > 2 ? i - 2 : 0), r = 2; r < i; r++)n[r - 2] = arguments[r]; X(!1, st.apply(void 0, [e].concat(n))) } } var ot = t("DebugMode", { NONE: 0, VERBOSE: 1, INFO: 2, WARN: 3, ERROR: 4, INFO_FOR_WEB_PAGE: 5, WARN_FOR_WEB_PAGE: 6, ERROR_FOR_WEB_PAGE: 7 }); function ut(t) { for (var e = arguments.length, i = new Array(e > 1 ? e - 1 : 0), n = 1; n < e; n++)i[n - 1] = arguments[n]; return nt.apply(void 0, [t].concat(i)) } function ht() { return !!T.profiler && T.profiler.isShowingStats() } function ct(t) { T.profiler && (t ? T.profiler.showStats() : T.profiler.hideStats()) } var lt, ft, dt, pt, _t, gt = Object.freeze({ __proto__: null, DebugMode: ot, _resetDebugSetting: Y, _throw: K, assert: X, assertID: at, debug: q, debugID: tt, error: j, errorID: rt, getError: ut, isDisplayStats: ht, log: H, logID: J, setDisplayStats: ct, warn: W, warnID: it }), mt = 10; t("replaceProperty", lt), t("removeProperty", ft), t("markAsWarning", dt); var vt = 0, yt = new Map; pt = function (t, e, i, n, r, s, a) { var o = yt.get(s); o && o.logTimes > o.count && (r("'%s' is deprecated, please use '%s' instead. " + a, t + "." + e, i + "." + n), o.count++) }, t("replaceProperty", lt = function (t, e, i) { null != t && i.forEach((function (i) { var n = vt++; yt.set(n, { id: n, count: 0, logTimes: void 0 !== i.logTimes ? i.logTimes : mt }); var r = null != i.target ? i.target : t, s = null != i.newName ? i.newName : i.name, a = null != i.targetName ? i.targetName : e, o = r === t, u = i.suggest ? "(" + i.suggest + ")" : ""; if (null != i.customFunction) t[i.name] = function () { var t; return pt(e, i.name, a, s, W, n, u), (t = i.customFunction).call.apply(t, [this].concat(Array.prototype.slice.call(arguments))) }; else if (null != i.customSetter || null != i.customGetter) { var h = null != i.customSetter, c = null != i.customGetter; h && c ? Object.defineProperty(t, i.name, { get: function () { return pt(e, i.name, a, s, W, n, u), i.customGetter.call(this) }, set: function (t) { pt(e, i.name, a, s, W, n, u), i.customSetter.call(this, t) }, enumerable: !1 }) : h ? Object.defineProperty(t, i.name, { set: function (t) { pt(e, i.name, a, s, W, n, u), i.customSetter.call(this, t) }, enumerable: !1 }) : c && Object.defineProperty(t, i.name, { get: function () { return pt(e, i.name, a, s, W, n, u), i.customGetter.call(this) }, enumerable: !1 }) } else Object.defineProperty(t, i.name, { get: function () { return pt(e, i.name, a, s, W, n, u), o ? this[s] : r[s] }, set: function (t) { pt(e, i.name, a, s, W, n, u), o ? this[s] = t : r[s] = t }, enumerable: !1 }) })) }), _t = function (t, e, i, n, r) { var s = yt.get(n); s && s.logTimes > s.count && (i("'%s' has been removed. " + r, t + "." + e), s.count++) }, t("removeProperty", ft = function (t, e, i) { null != t && i.forEach((function (i) { var n = vt++; yt.set(n, { id: n, count: 0, logTimes: void 0 !== i.logTimes ? i.logTimes : mt }); var r = i.suggest ? "(" + i.suggest + ")" : ""; Object.defineProperty(t, i.name, { get: function () { return _t(e, i.name, j, n, r) }, set: function () { _t(e, i.name, j, n, r) }, enumerable: !1 }) })) }), t("markAsWarning", dt = function () { }); var bt, wt, xt = {}; function St(t) { for (var e in t) { var i = t[e]; xt[e] = i } } function Tt(t) { var e = xt[t]; if (e) { var i = e.newName, n = e.since; e.removed ? i ? rt(16003, t, n, i) : rt(16002, t, n) : i ? it(16001, t, n, i) : it(16e3, t, n) } } var It = function () { function t(t) { this.id = 0 | 998 * Math.random(), this.prefix = t ? t + "." : "" } return t.prototype.getNewId = function () { return this.prefix + (++this.id).toString() }, t }(); wt = It, It.global = new wt("global"); var Et = new It("TmpCId."), At = "undefined" == typeof Symbol ? "__aliases__" : Symbol("[[Aliases]]"), Ct = "__classname__", Dt = "__cid__"; function Rt(t) { return "number" == typeof t || t instanceof Number } function Pt(t) { return "string" == typeof t || t instanceof String } function Bt(t) { for (var e in t) return !1; return !0 } var Mt, Ot = (Mt = { value: void 0, enumerable: !1, writable: !1, configurable: !0 }, function (t, e, i, n, r) { Mt.value = i, Mt.writable = n, Mt.enumerable = r, Object.defineProperty(t, e, Mt), Mt.value = void 0 }), Lt = function () { var t = { get: void 0, set: void 0, enumerable: !1 }; return function (e, i, n, r, s, a) { void 0 === s && (s = !1), void 0 === a && (a = !1), "boolean" == typeof r && (J(1031), s = r, r = void 0), t.get = n, t.set = r, t.enumerable = s, t.configurable = a, Object.defineProperty(e, i, t), t.get = void 0, t.set = void 0 } }(), Ft = function () { var t = { get: void 0, enumerable: !1, configurable: !1 }; return function (e, i, n, r, s) { t.get = n, t.enumerable = r, t.configurable = s, Object.defineProperty(e, i, t), t.get = void 0 } }(), kt = function () { var t = { set: void 0, enumerable: !1, configurable: !1 }; return function (e, i, n, r, s) { t.set = n, t.enumerable = r, t.configurable = s, Object.defineProperty(e, i, t), t.set = void 0 } }(); function Nt(t) { var e = Object.create(null); return t && (e["."] = 1, e["/"] = 1, delete e["."], delete e["/"]), e } function zt(t) { if ("function" == typeof t) { var e = t.prototype; if (e && e.hasOwnProperty(Ct) && e[Ct]) return e[Ct]; var i = ""; if (t.name) i = t.name; else if (t.toString) { var n, r = t.toString(); (n = "[" === r.charAt(0) ? /\[\w+\s*(\w+)\]/.exec(r) : /^function\s*(\w+)/.exec(r)) && 2 === n.length && (i = n[1]) } return "Object" !== i ? i : "" } return t && t.constructor ? zt(t.constructor) : "" } function Ut(t, e, i, n) { var r = /([^.]+)$/, s = r.exec(e)[0], a = r.exec(i)[0]; function o() { return this[a] } n ? Lt(t, s, o, (function (t) { this[a] = t })) : Ft(t, s, o) } function Vt(t, e, i, n) { for (var r in i) Ut(t, e + "." + r, i[r], n) } var Gt = /(%d)|(%s)/, Ht = /%s/; function Wt(t) { for (var e = arguments.length, i = new Array(e > 1 ? e - 1 : 0), n = 1; n < e; n++)i[n - 1] = arguments[n]; if (0 === arguments.length) return ""; if (0 === i.length) return "" + t; if ("string" == typeof t && Gt.test(t)) for (var r, s = p(i); !(r = s()).done;) { var a = r.value, o = "number" == typeof a ? Gt : Ht; if (o.test(t)) { var u = "" + a; t = t.replace(o, u) } else t += " " + a } else for (var h, c = p(i); !(h = c()).done;)t += " " + h.value; return t } function jt() { for (var t = arguments.length - 1, e = new Array(t), i = 0; i < t; ++i)e[i] = arguments[i + 1]; return e } function Xt(t, e) { for (; t;) { var i = Object.getOwnPropertyDescriptor(t, e); if (i) return i; t = Object.getPrototypeOf(t) } return null } function qt(t, e, i) { var n = Xt(e, t); n && Object.defineProperty(i, t, n) } function Yt(t) { t = t || {}; for (var e = 0; e < (arguments.length <= 1 ? 0 : arguments.length - 1); ++e) { var i = e + 1 < 1 || arguments.length <= e + 1 ? void 0 : arguments[e + 1]; if (i) { if ("object" != typeof i) { rt(5402, i); continue } for (var n in i) n in t || qt(n, i, t) } } return t } function Kt(t) { t = t || {}; for (var e = 0; e < (arguments.length <= 1 ? 0 : arguments.length - 1); ++e) { var i = e + 1 < 1 || arguments.length <= e + 1 ? void 0 : arguments[e + 1]; if (i) { if ("object" != typeof i) { rt(5403, i); continue } for (var n in i) qt(n, i, t) } } return t } function Qt(t, e) { for (var i in e) e.hasOwnProperty(i) && (t[i] = e[i]); return t.prototype = Object.create(e.prototype, { constructor: { value: t, writable: !0, configurable: !0 } }), t } function Zt(t) { var e = t.prototype, i = e && Object.getPrototypeOf(e); return i && i.constructor } function Jt(t, e) { if (t && e) { if ("function" != typeof t) return !1; if ("function" != typeof e) return !1; if (t === e) return !0; for (; ;) { if (!(t = Zt(t))) return !1; if (t === e) return !0 } } return !1 } function $t(t) { for (var e = 0, i = Object.keys(t); e < i.length; e++)delete t[i[e]] } var te = Nt(!0), ee = Nt(!0); function ie(t, e, i) { return function (n, r) { if (r.prototype.hasOwnProperty(t) && delete e[r.prototype[t]], Ot(r.prototype, t, n), n) { var s = e[n]; !i && s && s !== r ? rt(16334, t, n, "") : e[n] = r } } } var ne = ie("__cid__", te, !1), re = ie("__classname__", ee, !0); function se(t, e) { if (re(t, e), !e.prototype.hasOwnProperty(Dt)) { var i = t || Et.getNewId(); i && ne(i, e) } } function ae(t, e) { var i = ee[e], n = te[e], r = !0; if (i && i !== t && (rt(16335, e), r = !1), n && n !== t && (rt(16336, e), r = !1), r) { var s = t[At]; s || (s = [], t[At] = s), s.push(e), ee[e] = t, te[e] = t } } function oe() { for (var t = arguments.length, e = new Array(t), i = 0; i < t; i++)e[i] = arguments[i]; for (var n = 0, r = e; n < r.length; n++) { var s = r[n].prototype, a = s[Dt]; a && delete te[a]; var o = s[Ct]; o && delete ee[o]; var u = s[At]; if (u) for (var h = 0; h < u.length; ++h) { var c = u[h]; delete ee[c], delete te[c] } } } function ue(t) { return he(t) } function he(t) { return te[t] } function ce(t) { return ee[t] } function le(t) { return fe(t) } function fe(t) { if ("function" == typeof t && t.prototype.hasOwnProperty(Dt)) return t.prototype[Dt]; if (t && t.constructor) { var e = t.constructor.prototype; if (e && e.hasOwnProperty(Dt)) return t[Dt] } return "" } var de = function () { var t = e.prototype; function e(t, e) { this.count = 0; var i = void 0 === e ? t : e, n = void 0 === e ? null : t; this._pool = new Array(i), this._cleanup = n } return t.get = function () { return this._get() }, t._get = function () { if (this.count > 0) { --this.count; var t = this._pool[this.count]; return this._pool[this.count] = null, t } return null }, t.put = function (t) { var e = this._pool; if (this.count < e.length) { if (this._cleanup && !1 === this._cleanup(t)) return; e[this.count] = t, ++this.count } }, t.resize = function (t) { t >= 0 && (this._pool.length = t, this.count > t && (this.count = t)) }, e }(), pe = function () { function t(t) { this.i = 0, this.array = t } var e = t.prototype; return e.remove = function (t) { var e = this.array.indexOf(t); e >= 0 && this.removeAt(e) }, e.removeAt = function (t) { this.array.splice(t, 1), t <= this.i && --this.i }, e.fastRemove = function (t) { var e = this.array.indexOf(t); e >= 0 && this.fastRemoveAt(e) }, e.fastRemoveAt = function (t) { var e = this.array; e[t] = e[e.length - 1], --e.length, t <= this.i && --this.i }, e.push = function (t) { this.array.push(t) }, n(t, [{ key: "length", get: function () { return this.array.length }, set: function (t) { this.array.length = t, this.i >= t && (this.i = t - 1) } }]), t }(); function _e(t, e) { t.splice(e, 1) } function ge(t, e) { var i = t.length; e < 0 || e >= i || (t[e] = t[i - 1], t.length = i - 1) } function me(t, e) { var i = t.indexOf(e); return i >= 0 && (_e(t, i), !0) } function ve(t, e) { var i = t.indexOf(e); i >= 0 && (t[i] = t[t.length - 1], --t.length) } function ye(t) { for (var e = 0, i = arguments.length <= 1 ? 0 : arguments.length - 1; e < i; ++e)t[e] = e + 1 < 1 || arguments.length <= e + 1 ? void 0 : arguments[e + 1] } var be = Object.freeze({ __proto__: null, MutableForwardIterator: pe, appendObjectsAt: function (t, e, i) { return t.splice.apply(t, [i, 0].concat(e)), t }, contains: function (t, e) { return t.indexOf(e) >= 0 }, copy: function (t) { for (var e = t.length, i = new Array(e), n = 0; n < e; n += 1)i[n] = t[n]; return i }, fastRemove: ve, fastRemoveAt: ge, fillItems: ye, remove: me, removeArray: function (t, e) { for (var i = 0, n = e.length; i < n; i++)me(t, e[i]) }, removeAt: _e, removeIf: function (t, e) { var i = t.findIndex(e); if (i >= 0) { var n = t[i]; return _e(t, i), n } }, verifyType: function (t, e) { if (t && t.length > 0) for (var i, n = p(t); !(i = n()).done;)if (!(i.value instanceof e)) return J(1300), !1; return !0 } }), we = { IDGenerator: It, Pool: de, array: be, isNumber: Rt, isString: Pt, isEmptyObject: Bt, getPropertyDescriptor: Xt, addon: Yt, mixin: Kt, extend: Qt, getSuper: Zt, isChildClassOf: Jt, clear: $t, value: Ot, getset: Lt, get: Ft, set: kt, unregisterClass: oe, getClassName: zt, setClassName: se, setClassAlias: ae, getClassByName: ce, getClassById: he, get _registeredClassNames() { return r({}, ee) }, set _registeredClassNames(t) { $t(ee), Object.assign(ee, t) }, get _registeredClassIds() { return r({}, te) }, set _registeredClassIds(t) { $t(te), Object.assign(te, t) }, _getClassId: le, getClassId: fe, _setClassId: ne, _getClassById: ue, obsolete: Ut, obsoletes: Vt, formatStr: Wt, shiftArguments: jt, createMap: Nt }; T.js = we; var xe = Object.freeze({ __proto__: null, IDGenerator: It, Pool: de, _getClassById: ue, _getClassId: le, _idToClass: te, _nameToClass: ee, _setClassId: ne, addon: Yt, array: be, clear: $t, copyAllProperties: function (t, e, i) { for (var n = Object.getOwnPropertyNames(t), r = 0, s = n.length; r < s; ++r) { var a = n[r]; -1 === i.indexOf(a) && qt(a, t, e) } }, createMap: Nt, extend: Qt, formatStr: Wt, get: Ft, getClassById: he, getClassByName: ce, getClassId: fe, getClassName: zt, getPropertyDescriptor: Xt, getSuper: Zt, getset: Lt, isChildClassOf: Jt, isEmptyObject: Bt, isNumber: Rt, isString: Pt, js: we, mixin: Kt, obsolete: Ut, obsoletes: Vt, set: kt, setClassAlias: ae, setClassName: se, shiftArguments: jt, unregisterClass: oe, value: Ot }); function Se(t) { if ("__bitmask__" in t) return t; Ot(t, "__bitmask__", null, !0); for (var e = -1, i = Object.keys(t), n = 0; n < i.length; n++) { var r = i[n], s = t[r]; if (-1 === s) s = ++e, t[r] = s; else if ("number" == typeof s) e = s; else if ("string" == typeof s && Number.isInteger(parseFloat(r))) continue; var a = "" + s; r !== a && Ot(t, a, r) } return t } function Te(t, e) { e >= 0 && t.length, t.length } t("js", xe), Se.isBitMask = function (t) { return t && Object.prototype.hasOwnProperty.call(t, "__bitmask__") }, Se.getList = function (t) { return t.__bitmask__ ? t.__bitmask__ : Se.update(t) }, Se.update = function (t) { Array.isArray(t.__bitmask__) || (t.__bitmask__ = []); var e = t.__bitmask__; for (var i in e.length = 0, t) { var n = t[i]; Number.isInteger(n) && e.push({ name: i, value: n }) } return e.sort((function (t, e) { return t.value - e.value })), e }, T.BitMask = Se; var Ie = Object.prototype.hasOwnProperty; function Ee(t) { return "__enums__" in t ? t : (Ot(t, "__enums__", null, !0), Ee.update(t)) } function Ae(t) { Ie.call(t, "__enums__") } function Ce(t) { Ae(t); var e = t.__enums__ || []; e.length = 0; var i = !0; for (var n in t) { var r = t[n], s = Number.isInteger(r); s || (i = !1), (s || "string" == typeof r && t[r] !== Number.parseInt(n)) && e.push({ name: n, value: r }) } return i && e.sort((function (t, e) { return t.value - e.value })), t.__enums__ = e, e } function De(t) { "__enums__" in t || Ot(t, "__enums__", null, !0) } Ee.update = function (t) { for (var e = -1, i = Object.keys(t), n = 0; n < i.length; n++) { var r = i[n], s = t[r]; if (-1 === s) s = ++e, t[r] = s; else if ("number" == typeof s) e = s; else if ("string" == typeof s && Number.isInteger(parseFloat(r))) continue; var a = "" + s; r !== a && Ot(t, a, r) } return Array.isArray(t.__enums__) && Ce(t), t }, Ee.isEnum = function (t) { return t && Ie.call(t, "__enums__") }, Ee.getList = function (t) { return Ae(t), t.__enums__ ? t.__enums__ : Ce(t) }, Ee.sortList = function (t, e) { Ae(t), Array.isArray(t.__enums__) && t.__enums__.sort(e) }, T.Enum = Ee; var Re = t("ValueType", function () { function t() { } var e = t.prototype; return e.clone = function () { return rt(100, zt(this) + ".clone"), this }, e.equals = function () { return !1 }, e.set = function () { rt(100, zt(this) + ".set") }, e.toString = function () { return "" }, t }()); se("cc.ValueType", Re), T.ValueType = Re; var Pe = t("SettingsCategory", { PATH: "path", ENGINE: "engine", ASSETS: "assets", SCRIPTING: "scripting", PHYSICS: "physics", RENDERING: "rendering", LAUNCH: "launch", SCREEN: "screen", SPLASH_SCREEN: "splashScreen", ANIMATION: "animation", PROFILING: "profiling", PLUGINS: "plugins", XR: "xr" }), Be = t("Settings", function () { function t() { this._settings = {}, this._override = {} } var e = t.prototype; return e.init = function (t, e) { var i = this; for (var n in void 0 === t && (t = ""), void 0 === e && (e = {}), e) { var r = e[n]; if (r) for (var s in r) this.overrideSettings(n, s, r[s]) } return t ? new Promise((function (e, n) { var r = new XMLHttpRequest; r.open("GET", t), r.responseType = "text", r.onload = function () { i._settings = JSON.parse(r.response), e() }, r.onerror = function () { n(new Error("request settings failed!")) }, r.send(null) })) : Promise.resolve() }, e.overrideSettings = function (t, e, i) { t in this._override || (this._override[t] = {}), this._override[t][e] = i }, e.querySettings = function (t, e) { if (t in this._override) { var i = this._override[t]; if (i && e in i) return i[e] } if (t in this._settings) { var n = this._settings[t]; if (n && e in n) return n[e] } return null }, t }()); Be.Category = Pe; var Me, Oe = t("settings", new Be); T.settings = Oe, function (t) { t[t.PORTRAIT = 1] = "PORTRAIT", t[t.PORTRAIT_UPSIDE_DOWN = 2] = "PORTRAIT_UPSIDE_DOWN", t[t.LANDSCAPE_LEFT = 4] = "LANDSCAPE_LEFT", t[t.LANDSCAPE_RIGHT = 8] = "LANDSCAPE_RIGHT", t[t.LANDSCAPE = 12] = "LANDSCAPE", t[t.AUTO = 13] = "AUTO" }(Me || (Me = {})); var Le = t("macro", { SUPPORT_TEXTURE_FORMATS: [".astc", ".pkm", ".pvr", ".webp", ".jpg", ".jpeg", ".bmp", ".png"], KEY: { none: 0, back: 6, menu: 18, backspace: 8, tab: 9, enter: 13, shift: 16, ctrl: 17, alt: 18, pause: 19, capslock: 20, escape: 27, space: 32, pageup: 33, pagedown: 34, end: 35, home: 36, left: 37, up: 38, right: 39, down: 40, select: 41, insert: 45, Delete: 46, 0: 48, 1: 49, 2: 50, 3: 51, 4: 52, 5: 53, 6: 54, 7: 55, 8: 56, 9: 57, a: 65, b: 66, c: 67, d: 68, e: 69, f: 70, g: 71, h: 72, i: 73, j: 74, k: 75, l: 76, m: 77, n: 78, o: 79, p: 80, q: 81, r: 82, s: 83, t: 84, u: 85, v: 86, w: 87, x: 88, y: 89, z: 90, num0: 96, num1: 97, num2: 98, num3: 99, num4: 100, num5: 101, num6: 102, num7: 103, num8: 104, num9: 105, "*": 106, "+": 107, "-": 109, numdel: 110, "/": 111, f1: 112, f2: 113, f3: 114, f4: 115, f5: 116, f6: 117, f7: 118, f8: 119, f9: 120, f10: 121, f11: 122, f12: 123, numlock: 144, scrolllock: 145, ";": 186, semicolon: 186, equal: 187, "=": 187, ",": 188, comma: 188, dash: 189, ".": 190, period: 190, forwardslash: 191, grave: 192, "[": 219, openbracket: 219, backslash: 220, "]": 221, closebracket: 221, quote: 222, dpadLeft: 1e3, dpadRight: 1001, dpadUp: 1003, dpadDown: 1004, dpadCenter: 1005 }, RAD: Math.PI / 180, DEG: 180 / Math.PI, REPEAT_FOREVER: Number.MAX_VALUE - 1, FLT_EPSILON: 1.192092896e-7, ORIENTATION_PORTRAIT: Me.PORTRAIT, ORIENTATION_PORTRAIT_UPSIDE_DOWN: Me.PORTRAIT_UPSIDE_DOWN, ORIENTATION_LANDSCAPE: Me.LANDSCAPE, ORIENTATION_LANDSCAPE_LEFT: Me.LANDSCAPE_LEFT, ORIENTATION_LANDSCAPE_RIGHT: Me.LANDSCAPE_RIGHT, ORIENTATION_AUTO: Me.AUTO, ENABLE_TILEDMAP_CULLING: !0, TOUCH_TIMEOUT: 5e3, ENABLE_TRANSPARENT_CANVAS: !1, ENABLE_WEBGL_ANTIALIAS: !0, ENABLE_FLOAT_OUTPUT: !1, CLEANUP_IMAGE_CACHE: !1, ENABLE_MULTI_TOUCH: !0, MAX_LABEL_CANVAS_POOL_SIZE: 20, ENABLE_WEBGL_HIGHP_STRUCT_VALUES: !1, BATCHER2D_MEM_INCREMENT: 144, CUSTOM_PIPELINE_NAME: "Builtin", init: function () { var t = Oe.querySettings("engine", "macros"); if (t) for (var e in t) Le[e] = t[e] } }); function Fe(t, e) { for (var i = arguments.length, n = new Array(i > 2 ? i - 2 : 0), r = 2; r < i; r++)n[r - 2] = arguments[r]; var s = performance.now(), a = requestAnimationFrame || window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame; return void 0 === a ? setTimeout.apply(void 0, [t, e].concat(n)) : a((function i() { performance.now() - s < e ? a(i) : t.apply(void 0, n) })) } T.macro = Le; for (var ke = /^(?:cc|dragonBones|sp|ccsg)\..+/, Ne = new Array(123), ze = 0; ze < 123; ++ze)Ne[ze] = 64; for (var Ue = 0; Ue < 64; ++Ue)Ne["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(Ue)] = Ue; var Ve = Ne; function Ge(t, e, i) { function n(t, e, i, n) { var r = Object.getOwnPropertyDescriptor(t, e); if (r) r.get && i && (t[i] = r.get), r.set && n && (t[n] = r.set); else { var s = t[i]; Lt(t, e, s, t[n]) } } for (var r, s = t.prototype, a = 0, o = e.length; a < o; ++a) { var u = (r = e[a])[0].toUpperCase() + r.slice(1); n(s, r, "get" + u, "set" + u) } for (r in i) { var h = i[r]; n(s, r, h[0], h[1]) } } function He(t, e, i, n) { var r = t[e]; r ? Array.isArray(r) ? n ? (r.push(r[0]), r[0] = i) : r.push(i) : t[e] = n ? [i, r] : [r, i] : t[e] = i } function We(t, e) { if ("function" == typeof t.contains) return t.contains(e); if ("function" == typeof t.compareDocumentPosition) return !!(16 & t.compareDocumentPosition(e)); var i = e.parentNode; if (i) do { if (i === t) return !0; i = i.parentNode } while (null !== i); return !1 } function je(t) { return "object" == typeof window && "function" == typeof Node ? t instanceof Node : !!t && "object" == typeof t && "number" == typeof t.nodeType && "string" == typeof t.nodeName } function Xe(t) { for (var e = arguments.length, i = new Array(e > 1 ? e - 1 : 0), n = 1; n < e; n++)i[n - 1] = arguments[n]; t && Fe((function () { t.apply(void 0, i) }), 0) } function qe(t) { return !(!t || t.constructor !== Object) && Bt(t) } function Ye(t, e, i) { if (e > i) { var n = e; e = i, i = n } return t < e ? e : t < i ? t : i } function Ke(t) { return t * Le.RAD } function Qe(t) { return t * Le.DEG } T.misc = { BUILTIN_CLASSID_RE: ke, BASE64_VALUES: Ve, propertyDefine: Ge, pushToMap: He, contains: We, isDomNode: je, callInNextTick: Xe, isPlainEmptyObj_DEV: qe, clampf: Ye, degreesToRadians: Ke, radiansToDegrees: Qe }, t("misc", Object.freeze({ __proto__: null, BASE64_VALUES: Ve, BUILTIN_CLASSID_RE: ke, callInNextTick: Xe, clampf: Ye, contains: We, degreesToRadians: Ke, isDomNode: je, isPlainEmptyObj_DEV: qe, propertyDefine: Ge, pushToMap: He, radiansToDegrees: Qe, tryCatchFunctor_EDITOR: function (t) { return Function("target", "try {\n  target." + t + "();\n}\ncatch (e) {\n  cc._throw(e);\n}") } })); var Ze = "$_$"; function Je(t, e) { var i = e ? Object.create(e) : {}; return Ot(t, "__attrs__", i), i } function $e(t) { if ("function" != typeof t) return Je(t, ei(t.constructor)); for (var e, i = T.Class.getInheritanceChain(t), n = i.length - 1; n >= 0; n--) { var r = i[n]; r.hasOwnProperty("__attrs__") && r.__attrs__ || Je(r, (e = i[n + 1]) && e.__attrs__) } return Je(t, (e = i[0]) && e.__attrs__), t.__attrs__ } function ti(t, e) { var i = ei(t), n = e + Ze, r = {}; for (var s in i) s.startsWith(n) && (r[s.slice(n.length)] = i[s]); return r } function ei(t) { return t.hasOwnProperty("__attrs__") && t.__attrs__ || $e(t) } function ii(t, e, i, n) { ei(t)[e + Ze + i] = n } var ni = function () { function t(t, e) { this.name = t, this.default = e } return t.prototype.toString = function () { return this.name }, t }(), ri = t("CCInteger", new ni("Integer", 0)); T.Integer = ri, T.CCInteger = ri; var si = t("CCFloat", new ni("Float", 0)); T.Float = si, T.CCFloat = si; var ai = t("CCBoolean", new ni("Boolean", !1)); T.Boolean = ai, T.CCBoolean = ai; var oi = t("CCString", new ni("String", "")); function ui(t, e) { return function (i, n) { var r = '"' + zt(i) + "." + n + '"', s = ti(i, n), a = s.type; if (a === ri || a === si ? a = "Number" : a !== oi && a !== ai || (a = "" + a), a === t) { if (s.hasOwnProperty("default")) { var o = s.default; if (void 0 !== o && !Array.isArray(o) && !qe(o)) { var u = typeof o, h = t.toLowerCase(); if (u === h) if ("object" === h) { if (!o || o instanceof s.ctor) return; it(3605, r, zt(s.ctor)) } else "Number" !== t && it(3606, e, r, t); else { if ("function" === u) return; t === oi.default && null == o ? it(3607, r) : it(3611, e, r, u) } delete s.type } } } else it(3604, r) } } T.String = oi, T.CCString = oi; var hi = Object.freeze({ __proto__: null, CCBoolean: ai, CCFloat: si, CCInteger: ri, CCString: oi, DELIMETER: Ze, PrimitiveType: ni, attr: ti, createAttrs: $e, createAttrsSingle: Je, getClassAttrs: ei, getObjTypeChecker_ET: function (t) { return function (e, i) { ui("Object", "type")(e, i); var n = ei(e)[i + Ze + "default"], r = T.Class.getDefault(n); if (!Array.isArray(r) && Jt(t, T.ValueType)) { var s = zt(t), a = Wt('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.', zt(e), i, s); n ? H(a) : it(3612, a, s, zt(e), i, s) } } }, getTypeChecker_ET: ui, setClassAttr: ii }), ci = { default: {}, serializable: {}, editorOnly: {}, formerlySerializedAs: {} }; function li(t, e, i, n) { if (!t.get && !t.set && t.hasOwnProperty("default")) { var r = "_N$" + e; t.get = function () { return this[r] }, t.set = function (t) { var e = this[r]; this[r] = t, i.call(this, e) }; var s = {}; for (var a in n[r] = s, ci) { var o = ci[a]; t.hasOwnProperty(a) && (s[a] = t[a], o.canUsedInGet || delete t[a]) } } } function fi(t, e, i, n) { if (Array.isArray(e)) { if (!(e.length > 0)) return rt(5508, i, n); t.type = e = e[0] } "function" == typeof e && (e === String ? t.type = T.String : e === Boolean ? t.type = T.Boolean : e === Number && (t.type = T.Float)) } function di(t, e, i) { var n = t || void 0 === e ? { _short: !0 } : { _short: !0, default: e }; return i && (n.type = i), n } function pi(t, e) { if (!t || t.constructor !== Object) { if (Array.isArray(t) && t.length > 0) return di(e, [], t); if ("function" == typeof t) { var i = t; return di(e, Jt(i, T.ValueType) ? new i : null, i) } return t instanceof ni ? di(e, void 0, t) : di(e, t) } return null } function _i(t, e) { for (var i in t) { var n = t[i], r = pi(n, !1); if (r && (n = t[i] = r), n) { var s = n.notify; s && li(n, i, s, t), "type" in n && fi(n, n.type, e, i) } } } var gi = []; function mi() { return gi[gi.length - 1] } function vi(t, e, i) { t["" + e + Ze + "type"] = "Enum", t["" + e + Ze + "enumList"] = Ee.getList(i) } T._RF = { push: function (t, e, i, n) { void 0 === i && (i = e, e = ""), gi.push({ uuid: e, script: i, module: t, exports: t.exports, beh: null, importMeta: n }) }, pop: function () { var t = gi.pop(), e = t.module, i = e.exports; if (i === t.exports) { for (var n in i) return; e.exports = i = t.cls } }, peek: mi }; var yi = Ze, bi = "__ctors__", wi = t("ENUM_TAG", "Enum"), xi = t("BITMASK_TAG", "BitMask"); function Si(t, e) { t.indexOf(e) < 0 && t.push(e) } function Ti(t, e) { Si(t.__props__, e) } function Ii(t, e, i, n) { Ti(t, i), Oi(t, n, e, i) } function Ei(t, e, i, n) { var r = n.get; n.set, r && (Oi(t, n, e, i), ii(t, i, "serializable", !1)) } function Ai(t) { return "function" == typeof t ? t() : t } function Ci(t, e, i) { var n = i.ctor; return Ot(n, bi, !0, !0), n.prototype, e && (n.$super = e), se(t, n), n } function Di(t, e, i) { var n = T.Component, r = mi(); if (r && Jt(e, n)) { if (Jt(r.cls, n)) return rt(3615), null; t = t || r.script } var s = Ci(t, e, i); if (r) if (Jt(e, n)) { var a = r.uuid; a && ne(a, s), r.cls = s } else Jt(r.cls, n) || (r.cls = s); return s } function Ri(t, e, i, n) { if (t.__props__ = [], n && n.__props__ && (t.__props__ = n.__props__.slice()), i) for (var r in _i(i, e), i) { var s = i[r]; s.get || s.set ? Ei(t, e, r, s) : Ii(t, e, r, s) } var a = ei(t); t.__values__ = t.__props__.filter((function (t) { return !1 !== a["" + t + yi + "serializable"] })) } function Pi(t) { var e = t.name, i = t.extends, n = Di(e, i, t); e || (e = T.js.getClassName(n)), n._sealed = !0, i && (i._sealed = !1), Ri(n, e, t.properties, i); var r = t.editor; return r && Jt(i, T.Component) && T.Component._registerEditorProps(n, r), n } function Bi(t) { return null == t || null == t.hasOwnProperty ? void 0 : t.hasOwnProperty("__values__") } Pi._isCCClass = function (t) { return null == t || null == t.hasOwnProperty ? void 0 : t.hasOwnProperty(bi) }, Pi.fastDefine = function (t, e, i) { se(t, e); for (var n = e.__props__ = e.__values__ = Object.keys(i), r = ei(e), s = 0; s < n.length; s++) { var a = n[s]; r[a + yi + "visible"] = !1, r[a + yi + "default"] = i[a] } }, Pi.Attr = hi, Pi.attr = ti, Pi.isCCClassOrFastDefined = Bi, Pi.getInheritanceChain = function (t) { for (var e = []; t = Zt(t);)t !== Object && e.push(t); return e }; var Mi = { Integer: "Number", Float: "Number", Boolean: "Boolean", String: "String" }; function Oi(t, e, i, n) { var r = null, s = ""; function a() { return s = n + yi, r = ei(t) } "type" in e && void 0 === e.type && it(3660, n, i); var o = e.type; o && (Mi[o] ? (r || a())[s + "type"] = o : "Object" === o || ("object" == typeof o ? Ee.isEnum(o) ? vi(r || a(), n, o) : Se.isBitMask(o) && ((r || a())[s + "type"] = xi, r[s + "bitmaskList"] = Se.getList(o)) : "function" == typeof o && ((r || a())[s + "type"] = "Object", r[s + "ctor"] = o))), "default" in e && ((r || a())[s + "default"] = e.default); var u, h = function (t, i) { if (t in e) { var n = e[t]; typeof n === i && ((r || a())[s + t] = n) } }; e.editorOnly && ((r || a())[s + "editorOnly"] = !0), 1 & e.__internalFlags ? u = !0 === e.serializable || !!(4 & e.__internalFlags) : !1 === e.serializable && (u = !1), void 0 !== u && ((r || a())[s + "serializable"] = u), h("formerlySerializedAs", "string"); var c = e.range; c && Array.isArray(c) && c.length >= 2 && ((r || a())[s + "min"] = c[0], r[s + "max"] = c[1], c.length > 2 && (r[s + "step"] = c[2])), h("step", "number"), h("userData", "object") } Pi.isArray = function (t) { return t = Ai(t), Array.isArray(t) }, Pi.getDefault = Ai, Pi.escapeForJS = function (t) { return JSON.stringify(t).replace(/\u2028/g, "\\u2028").replace(/\u2029/g, "\\u2029") }, Pi.IDENTIFIER_RE = /^[A-Za-z_$][0-9A-Za-z_$]*$/, Pi.getNewValueTypeCode = function (t) { for (var e = zt(t), i = t.constructor, n = "new " + e + "(", r = 0; r < i.__props__.length; r++)n += t[i.__props__[r]], r < i.__props__.length - 1 && (n += ","); return n + ")" }, T.Class = Pi; var Li = Math.abs, Fi = Math.floor, ki = Math.PI, Ni = ki / 180, zi = 180 / ki, Ui = Math.random, Vi = t("HALF_PI", .5 * ki), Gi = t("TWO_PI", 2 * ki), Hi = t("EPSILON", 1e-6); function Wi(t, e) { return Li(t - e) <= Hi * Math.max(1, Li(t), Li(e)) } function ji(t, e, i) { return i = i || Hi, Li(t - e) <= i } function Xi(t, e, i) { if (e > i) { var n = e; e = i, i = n } return t < e ? e : t > i ? i : t } function qi(t) { return t < 0 ? 0 : t > 1 ? 1 : t } function Yi(t, e, i) { return t + (e - t) * i } function Ki(t) { return t * Ni } function Qi(t) { return t * zi } function Zi() { return Ui() } function Ji(t) { Ui = t } function $i(t, e) { return Zi() * (e - t) + t } function tn(t, e) { return Fi($i(t, e)) } function en(t) { return (t = (9301 * t + 49297) % 233280) / 233280 } function nn(t, e, i) { return en(t) * (i - e) + e } function rn(t, e, i) { return Fi(nn(t, e, i)) } function sn(t) { return P(t) } function an(t, e) { return t - Fi(t / e) * e } function on(t, e) { return t = an(t, 2 * e), e - Li(t - e) } function un(t, e, i) { return (i - t) / (e - t) } function hn(t) { return Li(t.x) > Li(t.y) ? Li(t.x) > Li(t.z) ? t.x : t.z : Li(t.y) > Li(t.z) ? t.y : t.z } function cn(t, e) { return Li(t) > Li(e) ? t : e } function ln(t, e) { e.forEach((function (e) { Object.defineProperty(t, e, { enumerable: !0 }) })) } var fn, dn, pn = (fn = new Float32Array(1), dn = new Int32Array(fn.buffer), function (t) { fn[0] = t; var e = dn[0], i = e >> 16 & 32768, n = 2147483647 & e, r = n - (112 << 23) + 4096 >> 13; return r = n < 113 << 23 ? 0 : r, r = n >= 143 << 23 ? 31744 : r, r = n > 255 << 23 ? 32256 : r, dn[0] = i | r, dn[0] }), _n = function () { var t = new Float32Array(1), e = new Int32Array(t.buffer); return function (i) { var n, r = 32767 & i, s = r << 13; return 31744 !== s ? (s += 112 << 23, 0 === r ? s = (1048575 & s) >> 1 : 32767 === r && (s = 2147483647)) : s = 2139095040, n = (i >> 15 & 1) << 31 | s, e[0] = n, t[0] } }(); function gn(t) { return pn(t) } function mn(t) { return _n(t) } var vn = Math.abs, yn = Math.max, bn = Math.min, wn = Math.PI, xn = Math.sin, Sn = Math.cos, Tn = Math.atan2, In = Math.sqrt, En = Math.ceil, An = Math.floor, Cn = Math.round; function Dn(t, e, i, n) { return Object.freeze(new Pn(t, e, i, n)) } var Rn, Pn = t("Vec4", function (t) { function e(e, i, n, r) { var s; return s = t.call(this) || this, "object" == typeof e ? (s.x = e.x, s.y = e.y, s.z = e.z, s.w = e.w) : (s.x = e || 0, s.y = i || 0, s.z = n || 0, s.w = r || 0), s } s(e, t), e.clone = function (t) { return new e(t.x, t.y, t.z, t.w) }, e.copy = function (t, e) { return t.x = e.x, t.y = e.y, t.z = e.z, t.w = e.w, t }, e.set = function (t, e, i, n, r) { return t.x = e, t.y = i, t.z = n, t.w = r, t }, e.fromColor = function (t, e) { return t.x = e.r, t.y = e.g, t.z = e.b, t.w = e.a, t }, e.angle = function (t, e) { var i = t.y * e.z - t.z * e.y, n = t.z * e.x - t.x * e.z, r = t.x * e.y - t.y * e.x, s = t.x * e.x + t.y * e.y + t.z * e.z; return Tn(In(i * i + n * n + r * r), s) }, e.add = function (t, e, i) { return t.x = e.x + i.x, t.y = e.y + i.y, t.z = e.z + i.z, t.w = e.w + i.w, t }, e.subtract = function (t, e, i) { return t.x = e.x - i.x, t.y = e.y - i.y, t.z = e.z - i.z, t.w = e.w - i.w, t }, e.multiply = function (t, e, i) { return t.x = e.x * i.x, t.y = e.y * i.y, t.z = e.z * i.z, t.w = e.w * i.w, t }, e.divide = function (t, e, i) { return t.x = e.x / i.x, t.y = e.y / i.y, t.z = e.z / i.z, t.w = e.w / i.w, t }, e.ceil = function (t, e) { return t.x = En(e.x), t.y = En(e.y), t.z = En(e.z), t.w = En(e.w), t }, e.floor = function (t, e) { return t.x = An(e.x), t.y = An(e.y), t.z = An(e.z), t.w = An(e.w), t }, e.min = function (t, e, i) { return t.x = bn(e.x, i.x), t.y = bn(e.y, i.y), t.z = bn(e.z, i.z), t.w = bn(e.w, i.w), t }, e.max = function (t, e, i) { return t.x = yn(e.x, i.x), t.y = yn(e.y, i.y), t.z = yn(e.z, i.z), t.w = yn(e.w, i.w), t }, e.round = function (t, e) { return t.x = Cn(e.x), t.y = Cn(e.y), t.z = Cn(e.z), t.w = Cn(e.w), t }, e.multiplyScalar = function (t, e, i) { return t.x = e.x * i, t.y = e.y * i, t.z = e.z * i, t.w = e.w * i, t }, e.scaleAndAdd = function (t, e, i, n) { return t.x = e.x + i.x * n, t.y = e.y + i.y * n, t.z = e.z + i.z * n, t.w = e.w + i.w * n, t }, e.distance = function (t, e) { var i = e.x - t.x, n = e.y - t.y, r = e.z - t.z, s = e.w - t.w; return In(i * i + n * n + r * r + s * s) }, e.squaredDistance = function (t, e) { var i = e.x - t.x, n = e.y - t.y, r = e.z - t.z, s = e.w - t.w; return i * i + n * n + r * r + s * s }, e.len = function (t) { var e = t.x, i = t.y, n = t.z, r = t.w; return In(e * e + i * i + n * n + r * r) }, e.lengthSqr = function (t) { var e = t.x, i = t.y, n = t.z, r = t.w; return e * e + i * i + n * n + r * r }, e.negate = function (t, e) { return t.x = -e.x, t.y = -e.y, t.z = -e.z, t.w = -e.w, t }, e.inverse = function (t, e) { return t.x = 1 / e.x, t.y = 1 / e.y, t.z = 1 / e.z, t.w = 1 / e.w, t }, e.inverseSafe = function (t, e) { var i = e.x, n = e.y, r = e.z, s = e.w; return vn(i) < Hi ? t.x = 0 : t.x = 1 / i, vn(n) < Hi ? t.y = 0 : t.y = 1 / n, vn(r) < Hi ? t.z = 0 : t.z = 1 / r, vn(s) < Hi ? t.w = 0 : t.w = 1 / s, t }, e.normalize = function (t, e) { var i = e.x, n = e.y, r = e.z, s = e.w, a = i * i + n * n + r * r + s * s; return a > 0 ? (a = 1 / In(a), t.x = i * a, t.y = n * a, t.z = r * a, t.w = s * a) : (t.x = 0, t.y = 0, t.z = 0, t.w = 0), t }, e.dot = function (t, e) { return t.x * e.x + t.y * e.y + t.z * e.z + t.w * e.w }, e.lerp = function (t, e, i, n) { return t.x = e.x + n * (i.x - e.x), t.y = e.y + n * (i.y - e.y), t.z = e.z + n * (i.z - e.z), t.w = e.w + n * (i.w - e.w), t }, e.scale = function (t, e, i) { return t.x = e.x * i, t.y = e.y * i, t.z = e.z * i, t.w = e.w * i, t }, e.random = function (t, e) { e = e || 1; var i = 2 * Zi() * wn, n = 2 * Zi() - 1, r = In(1 - n * n); return t.x = r * Sn(i) * e, t.y = r * xn(i) * e, t.z = n * e, t.w = 0, t }, e.transformMat4 = function (t, e, i) { var n = e.x, r = e.y, s = e.z, a = e.w; return t.x = i.m00 * n + i.m04 * r + i.m08 * s + i.m12 * a, t.y = i.m01 * n + i.m05 * r + i.m09 * s + i.m13 * a, t.z = i.m02 * n + i.m06 * r + i.m10 * s + i.m14 * a, t.w = i.m03 * n + i.m07 * r + i.m11 * s + i.m15 * a, t }, e.transformAffine = function (t, e, i) { var n = e.x, r = e.y, s = e.z, a = e.w; return t.x = i.m00 * n + i.m04 * r + i.m08 * s + i.m12 * a, t.y = i.m01 * n + i.m05 * r + i.m09 * s + i.m13 * a, t.z = i.m02 * n + i.m06 * r + i.m10 * s + i.m14 * a, t.w = e.w, t }, e.transformQuat = function (t, e, i) { var n = e.x, r = e.y, s = e.z, a = i.x, o = i.y, u = i.z, h = i.w, c = h * n + o * s - u * r, l = h * r + u * n - a * s, f = h * s + a * r - o * n, d = -a * n - o * r - u * s; return t.x = c * h + d * -a + l * -u - f * -o, t.y = l * h + d * -o + f * -a - c * -u, t.z = f * h + d * -u + c * -o - l * -a, t.w = e.w, t }, e.toArray = function (t, e, i) { return void 0 === i && (i = 0), t[i + 0] = e.x, t[i + 1] = e.y, t[i + 2] = e.z, t[i + 3] = e.w, t }, e.fromArray = function (t, e, i) { return void 0 === i && (i = 0), t.x = e[i + 0], t.y = e[i + 1], t.z = e[i + 2], t.w = e[i + 3], t }, e.strictEquals = function (t, e) { return t.x === e.x && t.y === e.y && t.z === e.z && t.w === e.w }, e.equals = function (t, e, i) { void 0 === i && (i = Hi); var n = 1 / 0; return !(vn(t.x) === n || vn(t.y) === n || vn(t.z) === n || vn(t.w) === n || vn(e.x) === n || vn(e.y) === n || vn(e.z) === n || vn(e.w) === n) && vn(t.x - e.x) <= i * yn(1, vn(t.x), vn(e.x)) && vn(t.y - e.y) <= i * yn(1, vn(t.y), vn(e.y)) && vn(t.z - e.z) <= i * yn(1, vn(t.z), vn(e.z)) && vn(t.w - e.w) <= i * yn(1, vn(t.w), vn(e.w)) }; var i = e.prototype; return i.clone = function () { return new e(this.x, this.y, this.z, this.w) }, i.set = function (t, e, i, n) { return "object" == typeof t ? (this.x = t.x, this.y = t.y, this.z = t.z, this.w = t.w) : (this.x = t || 0, this.y = e || 0, this.z = i || 0, this.w = n || 0), this }, i.equals = function (t, e) { void 0 === e && (e = Hi); var i = this; return vn(i.x - t.x) <= e * yn(1, vn(i.x), vn(t.x)) && vn(i.y - t.y) <= e * yn(1, vn(i.y), vn(t.y)) && vn(i.z - t.z) <= e * yn(1, vn(i.z), vn(t.z)) && vn(i.w - t.w) <= e * yn(1, vn(i.w), vn(t.w)) }, i.equals4f = function (t, e, i, n, r) { void 0 === r && (r = Hi); var s = this; return vn(s.x - t) <= r * yn(1, vn(s.x), vn(t)) && vn(s.y - e) <= r * yn(1, vn(s.y), vn(e)) && vn(s.z - i) <= r * yn(1, vn(s.z), vn(i)) && vn(s.w - n) <= r * yn(1, vn(s.w), vn(n)) }, i.strictEquals = function (t) { return this.x === t.x && this.y === t.y && this.z === t.z && this.w === t.w }, i.strictEquals4f = function (t, e, i, n) { return this.x === t && this.y === e && this.z === i && this.w === n }, i.lerp = function (t, e) { var i = this, n = i.x, r = i.y, s = i.z, a = i.w; return i.x = n + e * (t.x - n), i.y = r + e * (t.y - r), i.z = s + e * (t.z - s), i.w = a + e * (t.w - a), i }, i.toString = function () { return "(" + this.x + ", " + this.y + ", " + this.z + ", " + this.w + ")" }, i.clampf = function (t, e) { var i = this; return i.x = Xi(i.x, t.x, e.x), i.y = Xi(i.y, t.y, e.y), i.z = Xi(i.z, t.z, e.z), i.w = Xi(i.w, t.w, e.w), i }, i.add = function (t) { var e = this; return e.x += t.x, e.y += t.y, e.z += t.z, e.w += t.w, e }, i.add4f = function (t, e, i, n) { var r = this; return r.x += t, r.y += e, r.z += i, r.w += n, r }, i.subtract = function (t) { var e = this; return e.x -= t.x, e.y -= t.y, e.z -= t.z, e.w -= t.w, e }, i.subtract4f = function (t, e, i, n) { var r = this; return r.x -= t, r.y -= e, r.z -= i, r.w -= n, r }, i.multiplyScalar = function (t) { var e = this; return e.x *= t, e.y *= t, e.z *= t, e.w *= t, e }, i.multiply = function (t) { var e = this; return e.x *= t.x, e.y *= t.y, e.z *= t.z, e.w *= t.w, e }, i.multiply4f = function (t, e, i, n) { var r = this; return r.x *= t, r.y *= e, r.z *= i, r.w *= n, r }, i.divide = function (t) { var e = this; return e.x /= t.x, e.y /= t.y, e.z /= t.z, e.w /= t.w, e }, i.divide4f = function (t, e, i, n) { var r = this; return r.x /= t, r.y /= e, r.z /= i, r.w /= n, r }, i.negative = function () { var t = this; return t.x = -t.x, t.y = -t.y, t.z = -t.z, t.w = -t.w, t }, i.dot = function (t) { var e = this; return e.x * t.x + e.y * t.y + e.z * t.z + e.w * t.w }, i.cross = function (t) { var e = this, i = e.x, n = e.y, r = e.z, s = t.x, a = t.y, o = t.z; return e.x = n * o - r * a, e.y = r * s - i * o, e.z = i * a - n * s, e }, i.length = function () { var t = this, e = t.x, i = t.y, n = t.z, r = t.w; return In(e * e + i * i + n * n + r * r) }, i.lengthSqr = function () { var t = this, e = t.x, i = t.y, n = t.z, r = t.w; return e * e + i * i + n * n + r * r }, i.normalize = function () { var t = this, e = t.x, i = t.y, n = t.z, r = t.w, s = e * e + i * i + n * n + r * r; return s > 0 && (s = 1 / In(s), t.x = e * s, t.y = i * s, t.z = n * s, t.w = r * s), t }, i.scale = function (t) { var e = this; return e.x *= t, e.y *= t, e.z *= t, e.w *= t, e }, i.transformMat4 = function (t) { var e = this, i = e.x, n = e.y, r = e.z, s = e.w; return e.x = t.m00 * i + t.m04 * n + t.m08 * r + t.m12 * s, e.y = t.m01 * i + t.m05 * n + t.m09 * r + t.m13 * s, e.z = t.m02 * i + t.m06 * n + t.m10 * r + t.m14 * s, e.w = t.m03 * i + t.m07 * n + t.m11 * r + t.m15 * s, e }, e }(Re)); function Bn(t, e, i, n) { return new Pn(t, e, i, n) } Pn.ZERO = Dn(0, 0, 0, 0), Pn.ONE = Dn(1, 1, 1, 1), Pn.NEG_ONE = Dn(-1, -1, -1, -1), Pn.UNIT_X = Dn(1, 0, 0, 0), Pn.UNIT_Y = Dn(0, 1, 0, 0), Pn.UNIT_Z = Dn(0, 0, 1, 0), Pn.UNIT_W = Dn(0, 0, 0, 1), Pi.fastDefine("cc.Vec4", Pn, { x: 0, y: 0, z: 0, w: 0 }), T.Vec4 = Pn, T.v4 = Bn; var Mn = Math.abs, On = Math.max, Ln = Math.min, Fn = Math.PI, kn = Math.acos, Nn = Math.sin, zn = Math.cos, Un = Math.sqrt, Vn = Math.ceil, Gn = Math.floor, Hn = Math.round; function Wn(t, e, i) { return Object.freeze(new Kn(t, e, i)) } var jn, Xn, qn, Yn, Kn = t("Vec3", function (t) { function e(e, i, n) { var r; return r = t.call(this) || this, "object" == typeof e ? (r.x = e.x, r.y = e.y, r.z = e.z) : (r.x = e || 0, r.y = i || 0, r.z = n || 0), r } s(e, t), e.zero = function (t) { return t.x = 0, t.y = 0, t.z = 0, t }, e.clone = function (t) { return new e(t.x, t.y, t.z) }, e.copy = function (t, e) { return t.x = e.x, t.y = e.y, t.z = e.z, t }, e.set = function (t, e, i, n) { return t.x = e, t.y = i, t.z = n, t }, e.add = function (t, e, i) { return t.x = e.x + i.x, t.y = e.y + i.y, t.z = e.z + i.z, t }, e.subtract = function (t, e, i) { return t.x = e.x - i.x, t.y = e.y - i.y, t.z = e.z - i.z, t }, e.multiply = function (t, e, i) { return t.x = e.x * i.x, t.y = e.y * i.y, t.z = e.z * i.z, t }, e.divide = function (t, e, i) { return t.x = e.x / i.x, t.y = e.y / i.y, t.z = e.z / i.z, t }, e.ceil = function (t, e) { return t.x = Vn(e.x), t.y = Vn(e.y), t.z = Vn(e.z), t }, e.floor = function (t, e) { return t.x = Gn(e.x), t.y = Gn(e.y), t.z = Gn(e.z), t }, e.min = function (t, e, i) { return t.x = Ln(e.x, i.x), t.y = Ln(e.y, i.y), t.z = Ln(e.z, i.z), t }, e.max = function (t, e, i) { return t.x = On(e.x, i.x), t.y = On(e.y, i.y), t.z = On(e.z, i.z), t }, e.round = function (t, e) { return t.x = Hn(e.x), t.y = Hn(e.y), t.z = Hn(e.z), t }, e.multiplyScalar = function (t, e, i) { return t.x = e.x * i, t.y = e.y * i, t.z = e.z * i, t }, e.scaleAndAdd = function (t, e, i, n) { return t.x = e.x + i.x * n, t.y = e.y + i.y * n, t.z = e.z + i.z * n, t }, e.distance = function (t, e) { var i = e.x - t.x, n = e.y - t.y, r = e.z - t.z; return Un(i * i + n * n + r * r) }, e.squaredDistance = function (t, e) { var i = e.x - t.x, n = e.y - t.y, r = e.z - t.z; return i * i + n * n + r * r }, e.len = function (t) { var e = t.x, i = t.y, n = t.z; return Un(e * e + i * i + n * n) }, e.lengthSqr = function (t) { var e = t.x, i = t.y, n = t.z; return e * e + i * i + n * n }, e.negate = function (t, e) { return t.x = -e.x, t.y = -e.y, t.z = -e.z, t }, e.invert = function (t, e) { return t.x = 1 / e.x, t.y = 1 / e.y, t.z = 1 / e.z, t }, e.invertSafe = function (t, e) { var i = e.x, n = e.y, r = e.z; return Mn(i) < Hi ? t.x = 0 : t.x = 1 / i, Mn(n) < Hi ? t.y = 0 : t.y = 1 / n, Mn(r) < Hi ? t.z = 0 : t.z = 1 / r, t }, e.normalize = function (t, e) { var i = e.x, n = e.y, r = e.z, s = i * i + n * n + r * r; return s > 0 ? (s = 1 / Un(s), t.x = i * s, t.y = n * s, t.z = r * s) : (t.x = 0, t.y = 0, t.z = 0), t }, e.dot = function (t, e) { return t.x * e.x + t.y * e.y + t.z * e.z }, e.cross = function (t, e, i) { var n = e.x, r = e.y, s = e.z, a = i.x, o = i.y, u = i.z; return t.x = r * u - s * o, t.y = s * a - n * u, t.z = n * o - r * a, t }, e.lerp = function (t, e, i, n) { return t.x = e.x + n * (i.x - e.x), t.y = e.y + n * (i.y - e.y), t.z = e.z + n * (i.z - e.z), t }, e.random = function (t, e) { e = e || 1; var i = 2 * Zi() * Fn, n = 2 * Zi() - 1, r = Un(1 - n * n); return t.x = r * zn(i) * e, t.y = r * Nn(i) * e, t.z = n * e, t }, e.transformMat4 = function (t, e, i) { var n = e.x, r = e.y, s = e.z, a = i.m03 * n + i.m07 * r + i.m11 * s + i.m15; return a = a ? 1 / a : 1, t.x = (i.m00 * n + i.m04 * r + i.m08 * s + i.m12) * a, t.y = (i.m01 * n + i.m05 * r + i.m09 * s + i.m13) * a, t.z = (i.m02 * n + i.m06 * r + i.m10 * s + i.m14) * a, t }, e.transformMat4Normal = function (t, e, i) { var n = e.x, r = e.y, s = e.z, a = i.m03 * n + i.m07 * r + i.m11 * s; return a = a ? 1 / a : 1, t.x = (i.m00 * n + i.m04 * r + i.m08 * s) * a, t.y = (i.m01 * n + i.m05 * r + i.m09 * s) * a, t.z = (i.m02 * n + i.m06 * r + i.m10 * s) * a, t }, e.transformMat3 = function (t, e, i) { var n = e.x, r = e.y, s = e.z; return t.x = n * i.m00 + r * i.m03 + s * i.m06, t.y = n * i.m01 + r * i.m04 + s * i.m07, t.z = n * i.m02 + r * i.m05 + s * i.m08, t }, e.transformAffine = function (t, e, i) { var n = e.x, r = e.y, s = e.z; return t.x = i.m00 * n + i.m04 * r + i.m08 * s + i.m12, t.y = i.m01 * n + i.m05 * r + i.m09 * s + i.m13, t.z = i.m02 * n + i.m06 * r + i.m10 * s + i.m14, t }, e.transformQuat = function (t, e, i) { var n = i.w * e.x + i.y * e.z - i.z * e.y, r = i.w * e.y + i.z * e.x - i.x * e.z, s = i.w * e.z + i.x * e.y - i.y * e.x, a = -i.x * e.x - i.y * e.y - i.z * e.z; return t.x = n * i.w + a * -i.x + r * -i.z - s * -i.y, t.y = r * i.w + a * -i.y + s * -i.x - n * -i.z, t.z = s * i.w + a * -i.z + n * -i.y - r * -i.x, t }, e.transformRTS = function (t, e, i, n, r) { var s = e.x * r.x, a = e.y * r.y, o = e.z * r.z, u = i.w * s + i.y * o - i.z * a, h = i.w * a + i.z * s - i.x * o, c = i.w * o + i.x * a - i.y * s, l = -i.x * s - i.y * a - i.z * o; return t.x = u * i.w + l * -i.x + h * -i.z - c * -i.y + n.x, t.y = h * i.w + l * -i.y + c * -i.x - u * -i.z + n.y, t.z = c * i.w + l * -i.z + u * -i.y - h * -i.x + n.z, t }, e.transformInverseRTS = function (t, e, i, n, r) { var s = e.x - n.x, a = e.y - n.y, o = e.z - n.z, u = i.w * s - i.y * o + i.z * a, h = i.w * a - i.z * s + i.x * o, c = i.w * o - i.x * a + i.y * s, l = i.x * s + i.y * a + i.z * o; return t.x = (u * i.w + l * i.x + h * i.z - c * i.y) / r.x, t.y = (h * i.w + l * i.y + c * i.x - u * i.z) / r.y, t.z = (c * i.w + l * i.z + u * i.y - h * i.x) / r.z, t }, e.rotateX = function (t, e, i, n) { var r = e.x - i.x, s = e.y - i.y, a = e.z - i.z, o = zn(n), u = Nn(n), h = r, c = s * o - a * u, l = s * u + a * o; return t.x = h + i.x, t.y = c + i.y, t.z = l + i.z, t }, e.rotateY = function (t, e, i, n) { var r = e.x - i.x, s = e.y - i.y, a = e.z - i.z, o = zn(n), u = Nn(n), h = a * u + r * o, c = s, l = a * o - r * u; return t.x = h + i.x, t.y = c + i.y, t.z = l + i.z, t }, e.rotateZ = function (t, e, i, n) { var r = e.x - i.x, s = e.y - i.y, a = e.z - i.z, o = zn(n), u = Nn(n), h = r * o - s * u, c = r * u + s * o, l = a; return t.x = h + i.x, t.y = c + i.y, t.z = l + i.z, t }, e.rotateN = function (t, e, i, n, r) { var s = e.x - i.x, a = e.y - i.y, o = e.z - i.z, u = n.x, h = n.y, c = n.z, l = zn(r), f = Nn(r), d = s * (u * u * (1 - l) + l) + a * (u * h * (1 - l) - c * f) + o * (u * c * (1 - l) + h * f), p = s * (u * h * (1 - l) + c * f) + a * (h * h * (1 - l) + l) + o * (h * c * (1 - l) - u * f), _ = s * (u * c * (1 - l) - h * f) + a * (h * c * (1 - l) + u * f) + o * (c * c * (1 - l) + l); return t.x = d + i.x, t.y = p + i.y, t.z = _ + i.z, t }, e.toArray = function (t, e, i) { return void 0 === i && (i = 0), t[i + 0] = e.x, t[i + 1] = e.y, t[i + 2] = e.z, t }, e.fromArray = function (t, e, i) { return void 0 === i && (i = 0), t.x = e[i + 0], t.y = e[i + 1], t.z = e[i + 2], t }, e.strictEquals = function (t, e) { return t.x === e.x && t.y === e.y && t.z === e.z }, e.equals = function (t, e, i) { void 0 === i && (i = Hi); var n = t.x, r = t.y, s = t.z, a = e.x, o = e.y, u = e.z; return Mn(n - a) <= i * On(1, Mn(n), Mn(a)) && Mn(r - o) <= i * On(1, Mn(r), Mn(o)) && Mn(s - u) <= i * On(1, Mn(s), Mn(u)) }, e.angle = function (t, e) { var i = t.x * t.x + t.y * t.y + t.z * t.z, n = e.x * e.x + e.y * e.y + e.z * e.z; if (0 === i || 0 === n) return 0; var r = (t.x * e.x + t.y * e.y + t.z * e.z) / Un(i * n); return r = Xi(r, -1, 1), kn(r) }, e.projectOnPlane = function (t, i, n) { return e.subtract(t, i, e.project(t, i, n)) }, e.project = function (t, i, n) { var r = e.lengthSqr(n); return r < 1e-6 ? e.set(t, 0, 0, 0) : e.multiplyScalar(t, n, e.dot(i, n) / r) }, e.moveTowards = function (t, e, i, n) { var r = i.x - e.x, s = i.y - e.y, a = i.z - e.z, o = r * r + s * s + a * a; if (0 === o || n >= 0 && o < n * n) return t.x = i.x, t.y = i.y, t.z = i.z, t; var u = n / Un(o); return t.x = e.x + r * u, t.y = e.y + s * u, t.z = e.z + a * u, t }, e.generateOrthogonal = function (t, i) { var n = i.x, r = i.y, s = i.z, a = Mn(n), o = Mn(r), u = Mn(s); return a < o && a < u ? e.set(t, 0, s, -r) : o < u ? e.set(t, s, 0, -n) : e.set(t, r, -n, 0), e.normalize(t, t) }; var i = e.prototype; return i.clone = function () { return new e(this.x, this.y, this.z) }, i.set = function (t, e, i) { return "object" == typeof t ? (this.x = t.x, this.y = t.y, this.z = t.z) : (this.x = t || 0, this.y = e || 0, this.z = i || 0), this }, i.equals = function (t, e) { return void 0 === e && (e = Hi), Mn(this.x - t.x) <= e && Mn(this.y - t.y) <= e && Mn(this.z - t.z) <= e }, i.equals3f = function (t, e, i, n) { return void 0 === n && (n = Hi), Mn(this.x - t) <= n && Mn(this.y - e) <= n && Mn(this.z - i) <= n }, i.strictEquals = function (t) { return this.x === t.x && this.y === t.y && this.z === t.z }, i.strictEquals3f = function (t, e, i) { return this.x === t && this.y === e && this.z === i }, i.toString = function () { return "(" + this.x + ", " + this.y + ", " + this.z + ")" }, i.lerp = function (t, e) { return this.x += e * (t.x - this.x), this.y += e * (t.y - this.y), this.z += e * (t.z - this.z), this }, i.add = function (t) { return this.x += t.x, this.y += t.y, this.z += t.z, this }, i.add3f = function (t, e, i) { return this.x += t, this.y += e, this.z += i, this }, i.subtract = function (t) { return this.x -= t.x, this.y -= t.y, this.z -= t.z, this }, i.subtract3f = function (t, e, i) { return this.x -= t, this.y -= e, this.z -= i, this }, i.multiplyScalar = function (t) { return "object" == typeof t && it(16357), this.x *= t, this.y *= t, this.z *= t, this }, i.multiply = function (t) { return "object" != typeof t && it(16358), this.x *= t.x, this.y *= t.y, this.z *= t.z, this }, i.multiply3f = function (t, e, i) { return this.x *= t, this.y *= e, this.z *= i, this }, i.divide = function (t) { return this.x /= t.x, this.y /= t.y, this.z /= t.z, this }, i.divide3f = function (t, e, i) { return this.x /= t, this.y /= e, this.z /= i, this }, i.negative = function () { return this.x = -this.x, this.y = -this.y, this.z = -this.z, this }, i.clampf = function (t, e) { return this.x = Xi(this.x, t.x, e.x), this.y = Xi(this.y, t.y, e.y), this.z = Xi(this.z, t.z, e.z), this }, i.dot = function (t) { return this.x * t.x + this.y * t.y + this.z * t.z }, i.cross = function (t) { var e = this.x, i = this.y, n = this.z, r = t.x, s = t.y, a = t.z; return this.x = i * a - n * s, this.y = n * r - e * a, this.z = e * s - i * r, this }, i.length = function () { var t = this; return Un(t.x * t.x + t.y * t.y + t.z * t.z) }, i.lengthSqr = function () { var t = this; return t.x * t.x + t.y * t.y + t.z * t.z }, i.normalize = function () { var t = this, e = t.x, i = t.y, n = t.z, r = e * e + i * i + n * n; return r > 0 && (r = 1 / Un(r), t.x = e * r, t.y = i * r, t.z = n * r), t }, i.transformMat4 = function (t) { var e = this, i = e.x, n = e.y, r = e.z, s = t.m03 * i + t.m07 * n + t.m11 * r + t.m15; return s = s ? 1 / s : 1, e.x = (t.m00 * i + t.m04 * n + t.m08 * r + t.m12) * s, e.y = (t.m01 * i + t.m05 * n + t.m09 * r + t.m13) * s, e.z = (t.m02 * i + t.m06 * n + t.m10 * r + t.m14) * s, e }, i.toVec2 = function () { return new T.Vec2(this.x, this.y) }, e }(Re)); function Qn(t, e, i) { return new Kn(t, e, i) } Rn = Kn, Kn.UNIT_X = Wn(1, 0, 0), Kn.UNIT_Y = Wn(0, 1, 0), Kn.UNIT_Z = Wn(0, 0, 1), Kn.RIGHT = Wn(1, 0, 0), Kn.UP = Wn(0, 1, 0), Kn.FORWARD = Wn(0, 0, -1), Kn.ZERO = Wn(0, 0, 0), Kn.ONE = Wn(1, 1, 1), Kn.NEG_ONE = Wn(-1, -1, -1), Kn.slerp = (jn = new Rn, Xn = new Rn, qn = new Rn, function (t, e, i, n) { var r = 1e-5, s = Rn.len(e), a = Rn.len(i); if (s < r || a < r) return Rn.lerp(t, e, i, n); var o = Yi(s, a, n), u = Rn.dot(e, i) / (s * a); if (u > .99999) return Rn.lerp(t, e, i, n); if (u < -.99999) { var h = Rn.multiplyScalar(jn, e, 1 / s), c = Rn.generateOrthogonal(Xn, h); return Jn(qn, h, c, Fn * n), Rn.multiplyScalar(t, qn, o), t } var l = u, f = kn(l) * n, d = Rn.multiplyScalar(jn, e, 1 / s), p = Rn.multiplyScalar(Xn, i, 1 / a); return Rn.scaleAndAdd(qn, p, d, -l), Rn.normalize(qn, qn), Rn.multiplyScalar(qn, qn, Nn(f)), Rn.scaleAndAdd(qn, qn, d, zn(f)), Rn.multiplyScalar(t, qn, o), t }), Kn.signedAngle = (Yn = new Rn, function (t, e, i) { var n = Rn.angle(t, e), r = Rn.cross(Yn, t, e); return Rn.dot(r, i) < 0 ? -n : n }), Pi.fastDefine("cc.Vec3", Kn, { x: 0, y: 0, z: 0 }), T.Vec3 = Kn; var Zn, Jn = (Zn = { x: 0, y: 0, z: 0, w: 0 }, function (t, e, i, n) { var r = .5 * n, s = Nn(r); return Zn.x = s * i.x, Zn.y = s * i.y, Zn.z = s * i.z, Zn.w = zn(r), Kn.transformQuat(t, e, Zn), t }); T.v3 = Qn; var $n = 1 / 255, tr = Math.abs, er = Math.max; function ir(t, e, i, n) { return Object.freeze(new rr(t, e, i, n)) } var nr, rr = t("Color", function (t) { function e(e, i, n, r) { var s; return (s = t.call(this) || this)._data = new Uint8ClampedArray(4), "string" == typeof e ? s.fromHEX(e) : void 0 !== i ? s.set(e, i, n, r) : s.set(e), s } s(e, t), e.clone = function (t) { var i = new e; return i.r = t.r, i.g = t.g, i.b = t.b, i.a = t.a, i }, e.copy = function (t, e) { return t.r = e.r, t.g = e.g, t.b = e.b, t.a = e.a, t }, e.set = function (t, e, i, n, r) { return t.r = e, t.g = i, t.b = n, t.a = r, t }, e.toVec4 = function (t, e) { var i = t._data; return (e = void 0 !== e ? e : new Pn).x = i[0] * $n, e.y = i[1] * $n, e.z = i[2] * $n, e.w = i[3] * $n, e }, e.fromVec4 = function (t, i) { var n = (i = void 0 === i ? new e : i)._data; return n[0] = t.x / $n, n[1] = t.y / $n, n[2] = t.z / $n, n[3] = t.w / $n, i }, e.fromHEX = function (t, e) { var i; return "string" == typeof e ? (6 === (e = "#" === e[0] ? e.substring(1) : e).length ? e += "FF" : 3 === e.length ? e = e[0] + e[0] + e[1] + e[1] + e[2] + e[2] + "FF" : 4 === e.length && (e = e[0] + e[0] + e[1] + e[1] + e[2] + e[2] + e[3] + e[3]), i = Number("0x" + e)) : (e < 16777216 && (e = 255 + (e << 8)), i = e), t.r = i >>> 24, t.g = (16711680 & i) >>> 16, t.b = (65280 & i) >>> 8, t.a = 255 & i, t }, e.add = function (t, e, i) { return t.r = e.r + i.r, t.g = e.g + i.g, t.b = e.b + i.b, t.a = e.a + i.a, t }, e.subtract = function (t, e, i) { return t.r = e.r - i.r, t.g = e.g - i.g, t.b = e.b - i.b, t.a = e.a - i.a, t }, e.multiply = function (t, e, i) { return t.r = e.r * i.r, t.g = e.g * i.g, t.b = e.b * i.b, t.a = e.a * i.a, t }, e.divide = function (t, e, i) { return t.r = e.r / i.r, t.g = e.g / i.g, t.b = e.b / i.b, t.a = e.a / i.a, t }, e.scale = function (t, e, i) { return t.r = e.r * i, t.g = e.g * i, t.b = e.b * i, t.a = e.a * i, t }, e.lerp = function (t, e, i, n) { var r = e.r, s = e.g, a = e.b, o = e.a; return t.r = r + (i.r - r) * n, t.g = s + (i.g - s) * n, t.b = a + (i.b - a) * n, t.a = o + (i.a - o) * n, t }, e.toArray = function (t, i, n) { void 0 === n && (n = 0); var r = i instanceof e || i.a > 1 ? 1 / 255 : 1; return t[n + 0] = i.r * r, t[n + 1] = i.g * r, t[n + 2] = i.b * r, t[n + 3] = i.a * r, t }, e.fromArray = function (t, e, i) { return void 0 === i && (i = 0), e.r = 255 * t[i + 0], e.g = 255 * t[i + 1], e.b = 255 * t[i + 2], e.a = 255 * t[i + 3], e }, e.fromUint32 = function (t, e) { return e >>>= 0, t.r = 255 & e, t.g = e >> 8 & 255, t.b = e >> 16 & 255, t.a = e >> 24 & 255, t }, e.toUint32 = function (t) { return (t.a << 24 | t.b << 16 | t.g << 8 | t.r) >>> 0 }, e.strictEquals = function (t, e) { return t.r === e.r && t.g === e.g && t.b === e.b && t.a === e.a }, e.equals = function (t, e, i) { return void 0 === i && (i = Hi), !(tr(t.r) === 1 / 0 || tr(t.g) === 1 / 0 || tr(t.b) === 1 / 0 || tr(t.a) === 1 / 0) && tr(t.r - e.r) <= i * er(1, tr(t.r), tr(e.r)) && tr(t.g - e.g) <= i * er(1, tr(t.g), tr(e.g)) && tr(t.b - e.b) <= i * er(1, tr(t.b), tr(e.b)) && tr(t.a - e.a) <= i * er(1, tr(t.a), tr(e.a)) }, e.hex = function (t) { return (255 * t.r << 24 | 255 * t.g << 16 | 255 * t.b << 8 | 255 * t.a) >>> 0 }; var i = e.prototype; return i.clone = function () { var t = new e; return t._data.set(this._data), t }, i.equals = function (t) { var e = t, i = this._data; return t && i[0] === e.r && i[1] === e.g && i[2] === e.b && i[3] === e.a }, i.lerp = function (t, i) { return e.lerp(this, this, t, i), this }, i.toString = function () { return "rgba(" + this.r.toFixed() + ", " + this.g.toFixed() + ", " + this.b.toFixed() + ", " + this.a.toFixed() + ")" }, i.toCSS = function (t) { return void 0 === t && (t = "rgba"), "rgba" === t ? "rgba(" + this.r + "," + this.g + "," + this.b + "," + (this.a * $n).toFixed(2) + ")" : "rgb" === t ? "rgb(" + this.r + "," + this.g + "," + this.b + ")" : "#" + this.toHEX(t) }, i.fromHEX = function (t) { var e; return "string" == typeof t ? (6 === (t = "#" === t[0] ? t.substring(1) : t).length ? t += "FF" : 3 === t.length ? t = t[0] + t[0] + t[1] + t[1] + t[2] + t[2] + "FF" : 4 === t.length && (t = t[0] + t[0] + t[1] + t[1] + t[2] + t[2] + t[3] + t[3]), e = Number("0x" + t)) : (t < 16777216 && (t = 255 + (t << 8)), e = t), this.r = e >>> 24, this.g = (16711680 & e) >>> 16, this.b = (65280 & e) >>> 8, this.a = 255 & e, this }, i.toHEX = function (t) { void 0 === t && (t = "#rrggbb"); var e = this._data, i = "0", n = [(e[0] < 16 ? i : "") + e[0].toString(16), (e[1] < 16 ? i : "") + e[1].toString(16), (e[2] < 16 ? i : "") + e[2].toString(16)]; return "#rgb" === t ? (n[0] = n[0][0], n[1] = n[1][0], n[2] = n[2][0]) : "#rrggbbaa" === t && n.push((e[3] < 16 ? i : "") + e[3].toString(16)), n.join("") }, i.toRGBValue = function () { return this._data[2] << 16 | this._data[1] << 8 | this._data[0] }, i.fromHSV = function (t, e, i) { var n = 0, r = 0, s = 0; if (0 === e) n = r = s = i; else if (0 === i) n = r = s = 0; else { 1 === t && (t = 0), t *= 6; var a = Math.floor(t), o = t - a, u = i * (1 - e), h = i * (1 - e * o), c = i * (1 - e * (1 - o)); switch (a) { default: case 0: n = i, r = c, s = u; break; case 1: n = h, r = i, s = u; break; case 2: n = u, r = i, s = c; break; case 3: n = u, r = h, s = i; break; case 4: n = c, r = u, s = i; break; case 5: n = i, r = u, s = h } } var l = this._data; return l[0] = 255 * n, l[1] = 255 * r, l[2] = 255 * s, this }, i.toHSV = function () { var t = this._data[0] * $n, e = this._data[1] * $n, i = this._data[2] * $n, n = { h: 0, s: 0, v: 0 }, r = Math.max(t, e, i), s = Math.min(t, e, i), a = 0; return n.v = r, n.s = r ? (r - s) / r : 0, n.s ? (a = r - s, n.h = t === r ? (e - i) / a : e === r ? 2 + (i - t) / a : 4 + (t - e) / a, n.h /= 6, n.h < 0 && (n.h += 1)) : n.h = 0, n }, i.set = function (t, e, i, n) { var r = this._data; if ("object" == typeof t) { var s, a, o, u, h = t; h._data ? r.set(h._data) : (r[0] = null !== (s = h.r) && void 0 !== s ? s : 0, r[1] = null !== (a = h.g) && void 0 !== a ? a : 0, r[2] = null !== (o = h.b) && void 0 !== o ? o : 0, r[3] = null !== (u = h.a) && void 0 !== u ? u : 255) } else r[0] = null != t ? t : 0, r[1] = null != e ? e : 0, r[2] = null != i ? i : 0, r[3] = null != n ? n : 255; return this }, i.multiply = function (t) { var e = this._data; return e[0] *= t.r / 255, e[1] *= t.g / 255, e[2] *= t.b / 255, e[3] *= t.a / 255, this }, i.getModifiableProperties = function () { return ["r", "g", "b", "a"] }, n(e, [{ key: "r", get: function () { return this._data[0] }, set: function (t) { this._data[0] = t } }, { key: "g", get: function () { return this._data[1] }, set: function (t) { this._data[1] = t } }, { key: "b", get: function () { return this._data[2] }, set: function (t) { this._data[2] = t } }, { key: "a", get: function () { return this._data[3] }, set: function (t) { this._data[3] = t } }, { key: "x", get: function () { return this._data[0] * $n }, set: function (t) { this._data[0] = 255 * t } }, { key: "y", get: function () { return this._data[1] * $n }, set: function (t) { this._data[1] = 255 * t } }, { key: "z", get: function () { return this._data[2] * $n }, set: function (t) { this._data[2] = 255 * t } }, { key: "w", get: function () { return this._data[3] * $n }, set: function (t) { this._data[3] = 255 * t } }]), e }(Re)); function sr(t, e, i, n) { return new rr(t, e, i, n) } function ar(t, e, i) { if (e > i) { var n = e; e = i, i = n } return t < e ? e : t > i ? i : t } function or(t) { var e = t.clone(); return e.x = Math.floor(t.x), e.y = Math.floor(t.y), e.z = Math.floor(t.z), e } rr.WHITE = ir(255, 255, 255, 255), rr.GRAY = ir(127, 127, 127, 255), rr.BLACK = ir(0, 0, 0, 255), rr.TRANSPARENT = ir(0, 0, 0, 0), rr.RED = ir(255, 0, 0, 255), rr.GREEN = ir(0, 255, 0, 255), rr.BLUE = ir(0, 0, 255, 255), rr.CYAN = ir(0, 255, 255, 255), rr.MAGENTA = ir(255, 0, 255, 255), rr.YELLOW = ir(255, 255, 0, 255), Pi.fastDefine("cc.Color", rr, { r: 0, g: 0, b: 0, a: 255 }), T.Color = rr, T.color = sr; var ur = Math.abs, hr = Math.max, cr = t("Mat3", function (t) { function e(e, i, n, r, s, a, o, u, h) { var c; void 0 === e && (e = 1), void 0 === i && (i = 0), void 0 === n && (n = 0), void 0 === r && (r = 0), void 0 === s && (s = 1), void 0 === a && (a = 0), void 0 === o && (o = 0), void 0 === u && (u = 0), void 0 === h && (h = 1); var f = l(c = t.call(this) || this); return "object" == typeof e ? (f.m00 = e.m00, f.m01 = e.m01, f.m02 = e.m02, f.m03 = e.m03, f.m04 = e.m04, f.m05 = e.m05, f.m06 = e.m06, f.m07 = e.m07, f.m08 = e.m08) : (f.m00 = e, f.m01 = i, f.m02 = n, f.m03 = r, f.m04 = s, f.m05 = a, f.m06 = o, f.m07 = u, f.m08 = h), c } s(e, t), e.clone = function (t) { return new e(t.m00, t.m01, t.m02, t.m03, t.m04, t.m05, t.m06, t.m07, t.m08) }, e.copy = function (t, e) { return t.m00 = e.m00, t.m01 = e.m01, t.m02 = e.m02, t.m03 = e.m03, t.m04 = e.m04, t.m05 = e.m05, t.m06 = e.m06, t.m07 = e.m07, t.m08 = e.m08, t }, e.set = function (t, e, i, n, r, s, a, o, u, h) { return t.m00 = e, t.m01 = i, t.m02 = n, t.m03 = r, t.m04 = s, t.m05 = a, t.m06 = o, t.m07 = u, t.m08 = h, t }, e.identity = function (t) { return t.m00 = 1, t.m01 = 0, t.m02 = 0, t.m03 = 0, t.m04 = 1, t.m05 = 0, t.m06 = 0, t.m07 = 0, t.m08 = 1, t }, e.transpose = function (t, e) { if (t === e) { var i = e.m01, n = e.m02, r = e.m05; t.m01 = e.m03, t.m02 = e.m06, t.m03 = i, t.m05 = e.m07, t.m06 = n, t.m07 = r } else t.m00 = e.m00, t.m01 = e.m03, t.m02 = e.m06, t.m03 = e.m01, t.m04 = e.m04, t.m05 = e.m07, t.m06 = e.m02, t.m07 = e.m05, t.m08 = e.m08; return t }, e.invert = function (t, i) { var n = i.m00, r = i.m01, s = i.m02, a = i.m03, o = i.m04, u = i.m05, h = i.m06, c = i.m07, l = i.m08, f = l * o - u * c, d = -l * a + u * h, p = c * a - o * h, _ = n * f + r * d + s * p; return 0 === _ ? (e.set(t, 0, 0, 0, 0, 0, 0, 0, 0, 0), t) : (_ = 1 / _, t.m00 = f * _, t.m01 = (-l * r + s * c) * _, t.m02 = (u * r - s * o) * _, t.m03 = d * _, t.m04 = (l * n - s * h) * _, t.m05 = (-u * n + s * a) * _, t.m06 = p * _, t.m07 = (-c * n + r * h) * _, t.m08 = (o * n - r * a) * _, t) }, e.determinant = function (t) { var e = t.m00, i = t.m01, n = t.m02, r = t.m03, s = t.m04, a = t.m05, o = t.m06, u = t.m07, h = t.m08; return e * (h * s - a * u) + i * (-h * r + a * o) + n * (u * r - s * o) }, e.multiply = function (t, e, i) { var n = e.m00, r = e.m01, s = e.m02, a = e.m03, o = e.m04, u = e.m05, h = e.m06, c = e.m07, l = e.m08, f = i.m00, d = i.m01, p = i.m02, _ = i.m03, g = i.m04, m = i.m05, v = i.m06, y = i.m07, b = i.m08; return t.m00 = f * n + d * a + p * h, t.m01 = f * r + d * o + p * c, t.m02 = f * s + d * u + p * l, t.m03 = _ * n + g * a + m * h, t.m04 = _ * r + g * o + m * c, t.m05 = _ * s + g * u + m * l, t.m06 = v * n + y * a + b * h, t.m07 = v * r + y * o + b * c, t.m08 = v * s + y * u + b * l, t }, e.multiplyMat4 = function (t, e, i) { var n = e.m00, r = e.m01, s = e.m02, a = e.m03, o = e.m04, u = e.m05, h = e.m06, c = e.m07, l = e.m08, f = i.m00, d = i.m01, p = i.m02, _ = i.m04, g = i.m05, m = i.m06, v = i.m08, y = i.m09, b = i.m10; return t.m00 = f * n + d * a + p * h, t.m01 = f * r + d * o + p * c, t.m02 = f * s + d * u + p * l, t.m03 = _ * n + g * a + m * h, t.m04 = _ * r + g * o + m * c, t.m05 = _ * s + g * u + m * l, t.m06 = v * n + y * a + b * h, t.m07 = v * r + y * o + b * c, t.m08 = v * s + y * u + b * l, t }, e.transform = function (t, e, i) { this.translate(t, e, i) }, e.translate = function (t, e, i) { var n = e.m00, r = e.m01, s = e.m02, a = e.m03, o = e.m04, u = e.m05, h = e.m06, c = e.m07, l = e.m08, f = i.x, d = i.y; return t.m00 = n, t.m01 = r, t.m02 = s, t.m03 = a, t.m04 = o, t.m05 = u, t.m06 = f * n + d * a + h, t.m07 = f * r + d * o + c, t.m08 = f * s + d * u + l, t }, e.scale = function (t, e, i) { var n = i.x, r = i.y; return t.m00 = n * e.m00, t.m01 = n * e.m01, t.m02 = n * e.m02, t.m03 = r * e.m03, t.m04 = r * e.m04, t.m05 = r * e.m05, t.m06 = e.m06, t.m07 = e.m07, t.m08 = e.m08, t }, e.rotate = function (t, e, i) { var n = e.m00, r = e.m01, s = e.m02, a = e.m03, o = e.m04, u = e.m05, h = e.m06, c = e.m07, l = e.m08, f = Math.sin(i), d = Math.cos(i); return t.m00 = d * n + f * a, t.m01 = d * r + f * o, t.m02 = d * s + f * u, t.m03 = d * a - f * n, t.m04 = d * o - f * r, t.m05 = d * u - f * s, t.m06 = h, t.m07 = c, t.m08 = l, t }, e.fromMat4 = function (t, e) { return t.m00 = e.m00, t.m01 = e.m01, t.m02 = e.m02, t.m03 = e.m04, t.m04 = e.m05, t.m05 = e.m06, t.m06 = e.m08, t.m07 = e.m09, t.m08 = e.m10, t }, e.fromViewUp = function (t, i, n) { return Kn.lengthSqr(i) < Hi * Hi ? (e.identity(t), t) : (n = n || Kn.UNIT_Y, Kn.normalize(fr, Kn.cross(fr, n, i)), Kn.lengthSqr(fr) < Hi * Hi ? (e.identity(t), t) : (Kn.cross(dr, i, fr), e.set(t, fr.x, fr.y, fr.z, dr.x, dr.y, dr.z, i.x, i.y, i.z), t)) }, e.fromTranslation = function (t, e) { return t.m00 = 1, t.m01 = 0, t.m02 = 0, t.m03 = 0, t.m04 = 1, t.m05 = 0, t.m06 = e.x, t.m07 = e.y, t.m08 = 1, t }, e.fromScaling = function (t, e) { return t.m00 = e.x, t.m01 = 0, t.m02 = 0, t.m03 = 0, t.m04 = e.y, t.m05 = 0, t.m06 = 0, t.m07 = 0, t.m08 = 1, t }, e.fromRotation = function (t, e) { var i = Math.sin(e), n = Math.cos(e); return t.m00 = n, t.m01 = i, t.m02 = 0, t.m03 = -i, t.m04 = n, t.m05 = 0, t.m06 = 0, t.m07 = 0, t.m08 = 1, t }, e.fromQuat = function (t, e) { var i = e.x, n = e.y, r = e.z, s = e.w, a = i + i, o = n + n, u = r + r, h = i * a, c = n * a, l = n * o, f = r * a, d = r * o, p = r * u, _ = s * a, g = s * o, m = s * u; return t.m00 = 1 - l - p, t.m03 = c - m, t.m06 = f + g, t.m01 = c + m, t.m04 = 1 - h - p, t.m07 = d - _, t.m02 = f - g, t.m05 = d + _, t.m08 = 1 - h - l, t }, e.inverseTransposeMat4 = function (t, e) { var i = e.m00, n = e.m01, r = e.m02, s = e.m03, a = e.m04, o = e.m05, u = e.m06, h = e.m07, c = e.m08, l = e.m09, f = e.m10, d = e.m11, p = e.m12, _ = e.m13, g = e.m14, m = e.m15, v = i * o - n * a, y = i * u - r * a, b = i * h - s * a, w = n * u - r * o, x = n * h - s * o, S = r * h - s * u, T = c * _ - l * p, I = c * g - f * p, E = c * m - d * p, A = l * g - f * _, C = l * m - d * _, D = f * m - d * g, R = v * D - y * C + b * A + w * E - x * I + S * T; return R ? (R = 1 / R, t.m00 = (o * D - u * C + h * A) * R, t.m01 = (u * E - a * D - h * I) * R, t.m02 = (a * C - o * E + h * T) * R, t.m03 = (r * C - n * D - s * A) * R, t.m04 = (i * D - r * E + s * I) * R, t.m05 = (n * E - i * C - s * T) * R, t.m06 = (_ * S - g * x + m * w) * R, t.m07 = (g * b - p * S - m * y) * R, t.m08 = (p * x - _ * b + m * v) * R, t) : null }, e.toArray = function (t, e, i) { return void 0 === i && (i = 0), t[i + 0] = e.m00, t[i + 1] = e.m01, t[i + 2] = e.m02, t[i + 3] = e.m03, t[i + 4] = e.m04, t[i + 5] = e.m05, t[i + 6] = e.m06, t[i + 7] = e.m07, t[i + 8] = e.m08, t }, e.fromArray = function (t, e, i) { return void 0 === i && (i = 0), t.m00 = e[i + 0], t.m01 = e[i + 1], t.m02 = e[i + 2], t.m03 = e[i + 3], t.m04 = e[i + 4], t.m05 = e[i + 5], t.m06 = e[i + 6], t.m07 = e[i + 7], t.m08 = e[i + 8], t }, e.add = function (t, e, i) { return t.m00 = e.m00 + i.m00, t.m01 = e.m01 + i.m01, t.m02 = e.m02 + i.m02, t.m03 = e.m03 + i.m03, t.m04 = e.m04 + i.m04, t.m05 = e.m05 + i.m05, t.m06 = e.m06 + i.m06, t.m07 = e.m07 + i.m07, t.m08 = e.m08 + i.m08, t }, e.subtract = function (t, e, i) { return t.m00 = e.m00 - i.m00, t.m01 = e.m01 - i.m01, t.m02 = e.m02 - i.m02, t.m03 = e.m03 - i.m03, t.m04 = e.m04 - i.m04, t.m05 = e.m05 - i.m05, t.m06 = e.m06 - i.m06, t.m07 = e.m07 - i.m07, t.m08 = e.m08 - i.m08, t }, e.multiplyScalar = function (t, e, i) { return t.m00 = e.m00 * i, t.m01 = e.m01 * i, t.m02 = e.m02 * i, t.m03 = e.m03 * i, t.m04 = e.m04 * i, t.m05 = e.m05 * i, t.m06 = e.m06 * i, t.m07 = e.m07 * i, t.m08 = e.m08 * i, t }, e.multiplyScalarAndAdd = function (t, e, i, n) { return t.m00 = i.m00 * n + e.m00, t.m01 = i.m01 * n + e.m01, t.m02 = i.m02 * n + e.m02, t.m03 = i.m03 * n + e.m03, t.m04 = i.m04 * n + e.m04, t.m05 = i.m05 * n + e.m05, t.m06 = i.m06 * n + e.m06, t.m07 = i.m07 * n + e.m07, t.m08 = i.m08 * n + e.m08, t }, e.strictEquals = function (t, e) { return t.m00 === e.m00 && t.m01 === e.m01 && t.m02 === e.m02 && t.m03 === e.m03 && t.m04 === e.m04 && t.m05 === e.m05 && t.m06 === e.m06 && t.m07 === e.m07 && t.m08 === e.m08 }, e.equals = function (t, e, i) { return void 0 === i && (i = Hi), ur(t.m00 - e.m00) <= i * hr(1, ur(t.m00), ur(e.m00)) && ur(t.m01 - e.m01) <= i * hr(1, ur(t.m01), ur(e.m01)) && ur(t.m02 - e.m02) <= i * hr(1, ur(t.m02), ur(e.m02)) && ur(t.m03 - e.m03) <= i * hr(1, ur(t.m03), ur(e.m03)) && ur(t.m04 - e.m04) <= i * hr(1, ur(t.m04), ur(e.m04)) && ur(t.m05 - e.m05) <= i * hr(1, ur(t.m05), ur(e.m05)) && ur(t.m06 - e.m06) <= i * hr(1, ur(t.m06), ur(e.m06)) && ur(t.m07 - e.m07) <= i * hr(1, ur(t.m07), ur(e.m07)) && ur(t.m08 - e.m08) <= i * hr(1, ur(t.m08), ur(e.m08)) }, e.toEuler = function (t, e) { var i = t.m00, n = t.m01; t.m02; var r = t.m03, s = t.m04; t.m05; var a = t.m06, o = t.m07, u = t.m08; return o < .999 ? o > -.999 ? (e.x = Math.asin(-o), e.y = Math.atan2(a, u), e.z = Math.atan2(n, s), !0) : (e.x = Vi, e.y = Math.atan2(r, i), e.z = 0, !1) : (e.x = -Vi, e.y = Math.atan2(-r, i), e.z = 0, !1) }; var i = e.prototype; return i.clone = function () { return new e(this) }, i.set = function (t, e, i, n, r, s, a, o, u) { void 0 === t && (t = 1), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 0), void 0 === r && (r = 1), void 0 === s && (s = 0), void 0 === a && (a = 0), void 0 === o && (o = 0), void 0 === u && (u = 1); var h = this; return "object" == typeof t ? (h.m00 = t.m00, h.m01 = t.m01, h.m02 = t.m02, h.m03 = t.m03, h.m04 = t.m04, h.m05 = t.m05, h.m06 = t.m06, h.m07 = t.m07, h.m08 = t.m08) : (h.m00 = t, h.m01 = e, h.m02 = i, h.m03 = n, h.m04 = r, h.m05 = s, h.m06 = a, h.m07 = o, h.m08 = u), h }, i.equals = function (t, i) { return void 0 === i && (i = Hi), e.equals(this, t, i) }, i.strictEquals = function (t) { return e.strictEquals(this, t) }, i.toString = function () { var t = this; return "[\n" + t.m00 + ", " + t.m01 + ", " + t.m02 + ",\n" + t.m03 + ", " + t.m04 + ", " + t.m05 + ",\n" + t.m06 + ", " + t.m07 + ", " + t.m08 + "\n]" }, i.identity = function () { return e.identity(this) }, i.transpose = function () { var t = this, e = t.m01, i = t.m02, n = t.m05; return t.m01 = t.m03, t.m02 = t.m06, t.m03 = e, t.m05 = t.m07, t.m06 = i, t.m07 = n, t }, i.invert = function () { return e.invert(this, this) }, i.determinant = function () { return e.determinant(this) }, i.add = function (t) { var e = this; return e.m00 += t.m00, e.m01 += t.m01, e.m02 += t.m02, e.m03 += t.m03, e.m04 += t.m04, e.m05 += t.m05, e.m06 += t.m06, e.m07 += t.m07, e.m08 += t.m08, e }, i.subtract = function (t) { var e = this; return e.m00 -= t.m00, e.m01 -= t.m01, e.m02 -= t.m02, e.m03 -= t.m03, e.m04 -= t.m04, e.m05 -= t.m05, e.m06 -= t.m06, e.m07 -= t.m07, e.m08 -= t.m08, e }, i.multiply = function (t) { return e.multiply(this, this, t) }, i.multiplyScalar = function (t) { var e = this; return e.m00 *= t, e.m01 *= t, e.m02 *= t, e.m03 *= t, e.m04 *= t, e.m05 *= t, e.m06 *= t, e.m07 *= t, e.m08 *= t, e }, i.scale = function (t) { var e = t.x, i = t.y, n = this; return n.m00 *= e, n.m01 *= e, n.m02 *= e, n.m03 *= i, n.m04 *= i, n.m05 *= i, n }, i.rotate = function (t) { var e = this, i = e.m00, n = e.m01, r = e.m02, s = e.m03, a = e.m04, o = e.m05, u = e.m06, h = e.m07, c = e.m08, l = Math.sin(t), f = Math.cos(t); return e.m00 = f * i + l * s, e.m01 = f * n + l * a, e.m02 = f * r + l * o, e.m03 = f * s - l * i, e.m04 = f * a - l * n, e.m05 = f * o - l * r, e.m06 = u, e.m07 = h, e.m08 = c, e }, i.fromQuat = function (t) { var e = t.x, i = t.y, n = t.z, r = t.w, s = e + e, a = i + i, o = n + n, u = e * s, h = i * s, c = i * a, l = n * s, f = n * a, d = n * o, p = r * s, _ = r * a, g = r * o, m = this; return m.m00 = 1 - c - d, m.m03 = h - g, m.m06 = l + _, m.m01 = h + g, m.m04 = 1 - u - d, m.m07 = f - p, m.m02 = l - _, m.m05 = f + p, m.m08 = 1 - u - c, m }, e }(Re)); nr = cr, cr.IDENTITY = Object.freeze(new nr); var lr, fr = new Kn, dr = new Kn; Pi.fastDefine("cc.Mat3", cr, { m00: 1, m01: 0, m02: 0, m03: 0, m04: 1, m05: 0, m06: 0, m07: 0, m08: 1 }), T.Mat3 = cr; var pr = Math.abs, _r = Math.max, gr = Math.min, mr = Math.PI, vr = Math.acos, yr = Math.sin, br = Math.cos, wr = Math.sqrt, Sr = Math.atan2, Tr = Math.asin, Ir = Math.sign, Er = t("Quat", function (t) { function e(e, i, n, r) { var s; return s = t.call(this) || this, "object" == typeof e ? (s.x = e.x, s.y = e.y, s.z = e.z, s.w = e.w) : (s.x = e || 0, s.y = i || 0, s.z = n || 0, s.w = null != r ? r : 1), s } s(e, t), e.clone = function (t) { return new e(t.x, t.y, t.z, t.w) }, e.copy = function (t, e) { return t.x = e.x, t.y = e.y, t.z = e.z, t.w = e.w, t }, e.set = function (t, e, i, n, r) { return t.x = e, t.y = i, t.z = n, t.w = r, t }, e.identity = function (t) { return t.x = 0, t.y = 0, t.z = 0, t.w = 1, t }, e.rotationTo = function (t, i, n) { var r = Kn.dot(i, n); return r < -.999999 ? (Kn.cross(Rr, Kn.UNIT_X, i), Rr.length() < 1e-6 && Kn.cross(Rr, Kn.UNIT_Y, i), Kn.normalize(Rr, Rr), e.fromAxisAngle(t, Rr, mr), t) : r > .999999 ? (t.x = 0, t.y = 0, t.z = 0, t.w = 1, t) : (Kn.cross(Rr, i, n), t.x = Rr.x, t.y = Rr.y, t.z = Rr.z, t.w = 1 + r, e.normalize(t, t)) }, e.getAxisAngle = function (t, e) { var i = 2 * vr(e.w), n = yr(i / 2); return 0 !== n ? (t.x = e.x / n, t.y = e.y / n, t.z = e.z / n) : (t.x = 1, t.y = 0, t.z = 0), i }, e.multiply = function (t, e, i) { var n = e.x * i.w + e.w * i.x + e.y * i.z - e.z * i.y, r = e.y * i.w + e.w * i.y + e.z * i.x - e.x * i.z, s = e.z * i.w + e.w * i.z + e.x * i.y - e.y * i.x, a = e.w * i.w - e.x * i.x - e.y * i.y - e.z * i.z; return t.x = n, t.y = r, t.z = s, t.w = a, t }, e.multiplyScalar = function (t, e, i) { return t.x = e.x * i, t.y = e.y * i, t.z = e.z * i, t.w = e.w * i, t }, e.scaleAndAdd = function (t, e, i, n) { return t.x = e.x + i.x * n, t.y = e.y + i.y * n, t.z = e.z + i.z * n, t.w = e.w + i.w * n, t }, e.rotateX = function (t, e, i) { var n = yr(i *= .5), r = br(i), s = e.x, a = e.y, o = e.z, u = e.w; return t.x = s * r + u * n, t.y = a * r + o * n, t.z = o * r - a * n, t.w = u * r - s * n, t }, e.rotateY = function (t, e, i) { var n = yr(i *= .5), r = br(i), s = e.x, a = e.y, o = e.z, u = e.w; return t.x = s * r - o * n, t.y = a * r + u * n, t.z = o * r + s * n, t.w = u * r - a * n, t }, e.rotateZ = function (t, e, i) { var n = yr(i *= .5), r = br(i), s = e.x, a = e.y, o = e.z, u = e.w; return t.x = s * r + a * n, t.y = a * r - s * n, t.z = o * r + u * n, t.w = u * r - o * n, t }, e.rotateAround = function (t, i, n, r) { return e.invert(Cr, i), Kn.transformQuat(Rr, n, Cr), e.fromAxisAngle(Cr, Rr, r), e.multiply(t, i, Cr), t }, e.rotateAroundLocal = function (t, i, n, r) { return e.fromAxisAngle(Cr, n, r), e.multiply(t, i, Cr), t }, e.calculateW = function (t, e) { return t.x = e.x, t.y = e.y, t.z = e.z, t.w = wr(pr(1 - e.x * e.x - e.y * e.y - e.z * e.z)), t }, e.dot = function (t, e) { return t.x * e.x + t.y * e.y + t.z * e.z + t.w * e.w }, e.lerp = function (t, e, i, n) { return t.x = e.x + n * (i.x - e.x), t.y = e.y + n * (i.y - e.y), t.z = e.z + n * (i.z - e.z), t.w = e.w + n * (i.w - e.w), t }, e.slerp = function (t, e, i, n) { var r = 0, s = 0, a = i.x, o = i.y, u = i.z, h = i.w, c = e.x * i.x + e.y * i.y + e.z * i.z + e.w * i.w; if (c < 0 && (c = -c, a = -a, o = -o, u = -u, h = -h), 1 - c > 1e-6) { var l = vr(c), f = yr(l); r = yr((1 - n) * l) / f, s = yr(n * l) / f } else r = 1 - n, s = n; return t.x = r * e.x + s * a, t.y = r * e.y + s * o, t.z = r * e.z + s * u, t.w = r * e.w + s * h, t }, e.sqlerp = function (t, i, n, r, s, a) { return e.slerp(Cr, i, s, a), e.slerp(Dr, n, r, a), e.slerp(t, Cr, Dr, 2 * a * (1 - a)), t }, e.invert = function (t, e) { var i = e.x * e.x + e.y * e.y + e.z * e.z + e.w * e.w, n = i ? 1 / i : 0; return t.x = -e.x * n, t.y = -e.y * n, t.z = -e.z * n, t.w = e.w * n, t }, e.conjugate = function (t, e) { return t.x = -e.x, t.y = -e.y, t.z = -e.z, t.w = e.w, t }, e.len = function (t) { return wr(t.x * t.x + t.y * t.y + t.z * t.z + t.w * t.w) }, e.lengthSqr = function (t) { return t.x * t.x + t.y * t.y + t.z * t.z + t.w * t.w }, e.normalize = function (t, e) { var i = e.x * e.x + e.y * e.y + e.z * e.z + e.w * e.w; return i > 0 ? (i = 1 / wr(i), t.x = e.x * i, t.y = e.y * i, t.z = e.z * i, t.w = e.w * i) : (t.x = 0, t.y = 0, t.z = 0, t.w = 0), t }, e.fromAxes = function (t, i, n, r) { return cr.set(Pr, i.x, i.y, i.z, n.x, n.y, n.z, r.x, r.y, r.z), e.normalize(t, e.fromMat3(t, Pr)) }, e.fromViewUp = function (t, i, n) { return cr.fromViewUp(Pr, i, n), e.normalize(t, e.fromMat3(t, Pr)) }, e.fromAxisAngle = function (t, e, i) { var n = yr(i *= .5); return t.x = n * e.x, t.y = n * e.y, t.z = n * e.z, t.w = br(i), t }, e.fromMat3 = function (t, e) { var i = e.m00, n = e.m01, r = e.m02, s = e.m03, a = e.m04, o = e.m05, u = e.m06, h = e.m07, c = e.m08, l = i - a - c, f = a - i - c, d = c - i - a, p = 0, _ = i + a + c; l > _ && (_ = l, p = 1), f > _ && (_ = f, p = 2), d > _ && (_ = d, p = 3); var g = .5 * wr(_ + 1), m = .25 / g; switch (p) { case 0: t.w = g, t.x = (o - h) * m, t.y = (u - r) * m, t.z = (n - s) * m; break; case 1: t.w = (o - h) * m, t.x = g, t.y = (n + s) * m, t.z = (u + r) * m; break; case 2: t.w = (u - r) * m, t.x = (n + s) * m, t.y = g, t.z = (o + h) * m; break; case 3: t.w = (n - s) * m, t.x = (u + r) * m, t.y = (o + h) * m, t.z = g; break; default: t.w = 1, t.x = 0, t.y = 0, t.z = 0 }return t }, e.fromEuler = function (t, e, i, n) { i *= Br, n *= Br; var r = yr(e *= Br), s = br(e), a = yr(i), o = br(i), u = yr(n), h = br(n); return t.x = r * o * h + s * a * u, t.y = s * a * h + r * o * u, t.z = s * o * u - r * a * h, t.w = s * o * h - r * a * u, t }, e.fromAngleZ = function (t, e) { return e *= Br, t.x = t.y = 0, t.z = yr(e), t.w = br(e), t }, e.toAxisX = function (t, e) { var i = 2 * e.y, n = 2 * e.z; return t.x = 1 - i * e.y - n * e.z, t.y = i * e.x + n * e.w, t.z = n * e.x - i * e.w, t }, e.toAxisY = function (t, e) { var i = 2 * e.x, n = 2 * e.y, r = 2 * e.z; return t.x = n * e.x - r * e.w, t.y = 1 - i * e.x - r * e.z, t.z = r * e.y + i * e.w, t }, e.toAxisZ = function (t, e) { var i = 2 * e.x, n = 2 * e.y, r = 2 * e.z; return t.x = r * e.x + n * e.w, t.y = r * e.y - i * e.w, t.z = 1 - i * e.x - n * e.y, t }, e.toEuler = function (t, e, i) { var n = e.x, r = e.y, s = e.z, a = e.w, o = 0, u = 0, h = 0, c = n * r + s * a; if (c > .499999) o = 0, u = Qi(2 * Sr(n, a)), h = 90; else if (c < -.499999) o = 0, u = -Qi(2 * Sr(n, a)), h = -90; else { var l = r * r, f = s * s; o = Qi(Sr(2 * n * a - 2 * r * s, 1 - n * n * 2 - 2 * f)), u = Qi(Sr(2 * r * a - 2 * n * s, 1 - 2 * l - 2 * f)), h = Qi(Tr(2 * c)), i && (o = -180 * Ir(o + 1e-6) + o, u = -180 * Ir(u + 1e-6) + u, h = 180 * Ir(h + 1e-6) - h) } return t.x = o, t.y = u, t.z = h, t }, e.toEulerInYXZOrder = function (t, e) { cr.fromQuat(Pr, e), cr.toEuler(Pr, t), t.x = Qi(t.x), t.y = Qi(t.y), t.z = Qi(t.z) }, e.toArray = function (t, e, i) { return void 0 === i && (i = 0), t[i + 0] = e.x, t[i + 1] = e.y, t[i + 2] = e.z, t[i + 3] = e.w, t }, e.fromArray = function (t, e, i) { return void 0 === i && (i = 0), t.x = e[i + 0], t.y = e[i + 1], t.z = e[i + 2], t.w = e[i + 3], t }, e.strictEquals = function (t, e) { return t.x === e.x && t.y === e.y && t.z === e.z && t.w === e.w }, e.equals = function (t, e, i) { return void 0 === i && (i = Hi), pr(t.x - e.x) <= i * _r(1, pr(t.x), pr(e.x)) && pr(t.y - e.y) <= i * _r(1, pr(t.y), pr(e.y)) && pr(t.z - e.z) <= i * _r(1, pr(t.z), pr(e.z)) && pr(t.w - e.w) <= i * _r(1, pr(t.w), pr(e.w)) }, e.angle = function (t, i) { var n = gr(pr(e.dot(t, i)), 1); return 2 * vr(n) }, e.rotateTowards = function (t, i, n, r) { var s = e.angle(i, n); if (0 === s) return t.x = n.x, t.y = n.y, t.z = n.z, t.w = n.w, t; var a = gr(r / Qi(s), 1); return e.slerp(t, i, n, a) }; var i = e.prototype; return i.clone = function () { return new e(this.x, this.y, this.z, this.w) }, i.set = function (t, e, i, n) { return "object" == typeof t ? (this.x = t.x, this.y = t.y, this.z = t.z, this.w = t.w) : (this.x = t || 0, this.y = e || 0, this.z = i || 0, this.w = null != n ? n : 1), this }, i.equals = function (t, i) { return void 0 === i && (i = Hi), e.equals(this, t, i) }, i.strictEquals = function (t) { return t && this.x === t.x && this.y === t.y && this.z === t.z && this.w === t.w }, i.getEulerAngles = function (t) { return e.toEuler(t, this) }, i.lerp = function (t, e) { var i = this; return i.x += e * (t.x - i.x), i.y += e * (t.y - i.y), i.z += e * (t.z - i.z), i.w += e * (t.w - i.w), i }, i.slerp = function (t, i) { return e.slerp(this, this, t, i) }, i.length = function () { var t = this, e = t.x, i = t.y, n = t.z, r = t.w; return wr(e * e + i * i + n * n + r * r) }, i.lengthSqr = function () { var t = this, e = t.x, i = t.y, n = t.z, r = t.w; return e * e + i * i + n * n + r * r }, i.toString = function () { return "(" + this.x + ", " + this.y + ", " + this.z + ", " + this.w + ")" }, e }(Re)); lr = Er, Er.IDENTITY = Object.freeze(new lr); var Ar, Cr = new Er, Dr = new Er, Rr = new Kn, Pr = new cr, Br = .5 * mr / 180; function Mr(t, e, i, n) { return void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 1), new Er(t, e, i, n) } Pi.fastDefine("cc.Quat", Er, { x: 0, y: 0, z: 0, w: 1 }), T.Quat = Er, T.quat = Mr; var Or = Object.freeze, Lr = t("preTransforms", Or([Or([1, 0, 0, 1]), Or([0, 1, -1, 0]), Or([-1, 0, 0, -1]), Or([0, -1, 1, 0])])), Fr = Math.abs, kr = Math.max, Nr = Math.sqrt, zr = Math.sin, Ur = Math.cos, Vr = Math.tan, Gr = t("Mat4", function (t) { function e(e, i, n, r, s, a, o, u, h, c, f, d, p, _, g, m) { var v; void 0 === e && (e = 1), void 0 === i && (i = 0), void 0 === n && (n = 0), void 0 === r && (r = 0), void 0 === s && (s = 0), void 0 === a && (a = 1), void 0 === o && (o = 0), void 0 === u && (u = 0), void 0 === h && (h = 0), void 0 === c && (c = 0), void 0 === f && (f = 1), void 0 === d && (d = 0), void 0 === p && (p = 0), void 0 === _ && (_ = 0), void 0 === g && (g = 0), void 0 === m && (m = 1); var y = l(v = t.call(this) || this); return "object" == typeof e ? (y.m00 = e.m00, v.m01 = e.m01, v.m02 = e.m02, v.m03 = e.m03, y.m04 = e.m04, v.m05 = e.m05, v.m06 = e.m06, v.m07 = e.m07, y.m08 = e.m08, v.m09 = e.m09, v.m10 = e.m10, v.m11 = e.m11, y.m12 = e.m12, v.m13 = e.m13, v.m14 = e.m14, v.m15 = e.m15) : (y.m00 = e, v.m01 = i, v.m02 = n, v.m03 = r, y.m04 = s, v.m05 = a, v.m06 = o, v.m07 = u, y.m08 = h, v.m09 = c, v.m10 = f, v.m11 = d, y.m12 = p, v.m13 = _, v.m14 = g, v.m15 = m), v } s(e, t), e.clone = function (t) { return new e(t.m00, t.m01, t.m02, t.m03, t.m04, t.m05, t.m06, t.m07, t.m08, t.m09, t.m10, t.m11, t.m12, t.m13, t.m14, t.m15) }, e.copy = function (t, e) { return t.m00 = e.m00, t.m01 = e.m01, t.m02 = e.m02, t.m03 = e.m03, t.m04 = e.m04, t.m05 = e.m05, t.m06 = e.m06, t.m07 = e.m07, t.m08 = e.m08, t.m09 = e.m09, t.m10 = e.m10, t.m11 = e.m11, t.m12 = e.m12, t.m13 = e.m13, t.m14 = e.m14, t.m15 = e.m15, t }, e.set = function (t, e, i, n, r, s, a, o, u, h, c, l, f, d, p, _, g) { return t.m00 = e, t.m01 = i, t.m02 = n, t.m03 = r, t.m04 = s, t.m05 = a, t.m06 = o, t.m07 = u, t.m08 = h, t.m09 = c, t.m10 = l, t.m11 = f, t.m12 = d, t.m13 = p, t.m14 = _, t.m15 = g, t }, e.identity = function (t) { return t.m00 = 1, t.m01 = 0, t.m02 = 0, t.m03 = 0, t.m04 = 0, t.m05 = 1, t.m06 = 0, t.m07 = 0, t.m08 = 0, t.m09 = 0, t.m10 = 1, t.m11 = 0, t.m12 = 0, t.m13 = 0, t.m14 = 0, t.m15 = 1, t }, e.zero = function (t) { return t.m00 = 0, t.m01 = 0, t.m02 = 0, t.m03 = 0, t.m04 = 0, t.m05 = 0, t.m06 = 0, t.m07 = 0, t.m08 = 0, t.m09 = 0, t.m10 = 0, t.m11 = 0, t.m12 = 0, t.m13 = 0, t.m14 = 0, t.m15 = 0, t }, e.transpose = function (t, e) { if (t === e) { var i = e.m01, n = e.m02, r = e.m03, s = e.m06, a = e.m07, o = e.m11; t.m01 = e.m04, t.m02 = e.m08, t.m03 = e.m12, t.m04 = i, t.m06 = e.m09, t.m07 = e.m13, t.m08 = n, t.m09 = s, t.m11 = e.m14, t.m12 = r, t.m13 = a, t.m14 = o } else t.m00 = e.m00, t.m01 = e.m04, t.m02 = e.m08, t.m03 = e.m12, t.m04 = e.m01, t.m05 = e.m05, t.m06 = e.m09, t.m07 = e.m13, t.m08 = e.m02, t.m09 = e.m06, t.m10 = e.m10, t.m11 = e.m14, t.m12 = e.m03, t.m13 = e.m07, t.m14 = e.m11, t.m15 = e.m15; return t }, e.invert = function (t, i) { var n = i.m00, r = i.m01, s = i.m02, a = i.m03, o = i.m04, u = i.m05, h = i.m06, c = i.m07, l = i.m08, f = i.m09, d = i.m10, p = i.m11, _ = i.m12, g = i.m13, m = i.m14, v = i.m15, y = n * u - r * o, b = n * h - s * o, w = n * c - a * o, x = r * h - s * u, S = r * c - a * u, T = s * c - a * h, I = l * g - f * _, E = l * m - d * _, A = l * v - p * _, C = f * m - d * g, D = f * v - p * g, R = d * v - p * m, P = y * R - b * D + w * C + x * A - S * E + T * I; return 0 === P ? e.zero(t) : (P = 1 / P, t.m00 = (u * R - h * D + c * C) * P, t.m01 = (s * D - r * R - a * C) * P, t.m02 = (g * T - m * S + v * x) * P, t.m03 = (d * S - f * T - p * x) * P, t.m04 = (h * A - o * R - c * E) * P, t.m05 = (n * R - s * A + a * E) * P, t.m06 = (m * w - _ * T - v * b) * P, t.m07 = (l * T - d * w + p * b) * P, t.m08 = (o * D - u * A + c * I) * P, t.m09 = (r * A - n * D - a * I) * P, t.m10 = (_ * S - g * w + v * y) * P, t.m11 = (f * w - l * S - p * y) * P, t.m12 = (u * E - o * C - h * I) * P, t.m13 = (n * C - r * E + s * I) * P, t.m14 = (g * b - _ * x - m * y) * P, t.m15 = (l * x - f * b + d * y) * P, t) }, e.determinant = function (t) { var e = t.m00, i = t.m01, n = t.m02, r = t.m03, s = t.m04, a = t.m05, o = t.m06, u = t.m07, h = t.m08, c = t.m09, l = t.m10, f = t.m11, d = t.m12, p = t.m13, _ = t.m14, g = t.m15; return (e * a - i * s) * (l * g - f * _) - (e * o - n * s) * (c * g - f * p) + (e * u - r * s) * (c * _ - l * p) + (i * o - n * a) * (h * g - f * d) - (i * u - r * a) * (h * _ - l * d) + (n * u - r * o) * (h * p - c * d) }, e.multiply = function (t, e, i) { var n = e.m00, r = e.m01, s = e.m02, a = e.m03, o = e.m04, u = e.m05, h = e.m06, c = e.m07, l = e.m08, f = e.m09, d = e.m10, p = e.m11, _ = e.m12, g = e.m13, m = e.m14, v = e.m15, y = i.m00, b = i.m01, w = i.m02, x = i.m03; return t.m00 = y * n + b * o + w * l + x * _, t.m01 = y * r + b * u + w * f + x * g, t.m02 = y * s + b * h + w * d + x * m, t.m03 = y * a + b * c + w * p + x * v, y = i.m04, b = i.m05, w = i.m06, x = i.m07, t.m04 = y * n + b * o + w * l + x * _, t.m05 = y * r + b * u + w * f + x * g, t.m06 = y * s + b * h + w * d + x * m, t.m07 = y * a + b * c + w * p + x * v, y = i.m08, b = i.m09, w = i.m10, x = i.m11, t.m08 = y * n + b * o + w * l + x * _, t.m09 = y * r + b * u + w * f + x * g, t.m10 = y * s + b * h + w * d + x * m, t.m11 = y * a + b * c + w * p + x * v, y = i.m12, b = i.m13, w = i.m14, x = i.m15, t.m12 = y * n + b * o + w * l + x * _, t.m13 = y * r + b * u + w * f + x * g, t.m14 = y * s + b * h + w * d + x * m, t.m15 = y * a + b * c + w * p + x * v, t }, e.transform = function (t, e, i) { var n = i.x, r = i.y, s = i.z; if (e === t) t.m12 = e.m00 * n + e.m04 * r + e.m08 * s + e.m12, t.m13 = e.m01 * n + e.m05 * r + e.m09 * s + e.m13, t.m14 = e.m02 * n + e.m06 * r + e.m10 * s + e.m14, t.m15 = e.m03 * n + e.m07 * r + e.m11 * s + e.m15; else { var a = e.m00, o = e.m01, u = e.m02, h = e.m03, c = e.m04, l = e.m05, f = e.m06, d = e.m07, p = e.m08, _ = e.m09, g = e.m10, m = e.m11; t.m00 = a, t.m01 = o, t.m02 = u, t.m03 = h, t.m04 = c, t.m05 = l, t.m06 = f, t.m07 = d, t.m08 = p, t.m09 = _, t.m10 = g, t.m11 = m, t.m12 = a * n + c * r + p * s + e.m12, t.m13 = o * n + l * r + _ * s + e.m13, t.m14 = u * n + f * r + g * s + e.m14, t.m15 = h * n + d * r + m * s + e.m15 } return t }, e.translate = function (t, e, i) { return e === t ? (t.m12 += i.x, t.m13 += i.y, t.m14 += i.z) : (t.m00 = e.m00, t.m01 = e.m01, t.m02 = e.m02, t.m03 = e.m03, t.m04 = e.m04, t.m05 = e.m05, t.m06 = e.m06, t.m07 = e.m07, t.m08 = e.m08, t.m09 = e.m09, t.m10 = e.m10, t.m11 = e.m11, t.m12 = e.m12 + i.x, t.m13 = e.m13 + i.y, t.m14 = e.m14 + i.z, t.m15 = e.m15), t }, e.scale = function (t, e, i) { var n = i.x, r = i.y, s = i.z; return t.m00 = e.m00 * n, t.m01 = e.m01 * n, t.m02 = e.m02 * n, t.m03 = e.m03 * n, t.m04 = e.m04 * r, t.m05 = e.m05 * r, t.m06 = e.m06 * r, t.m07 = e.m07 * r, t.m08 = e.m08 * s, t.m09 = e.m09 * s, t.m10 = e.m10 * s, t.m11 = e.m11 * s, t.m12 = e.m12, t.m13 = e.m13, t.m14 = e.m14, t.m15 = e.m15, t }, e.rotate = function (t, e, i, n) { var r = n.x, s = n.y, a = n.z, o = Nr(r * r + s * s + a * a); if (Fr(o) < Hi) return null; r *= o = 1 / o, s *= o, a *= o; var u = zr(i), h = Ur(i), c = 1 - h, l = e.m00, f = e.m01, d = e.m02, p = e.m03, _ = e.m04, g = e.m05, m = e.m06, v = e.m07, y = e.m08, b = e.m09, w = e.m10, x = e.m11, S = r * r * c + h, T = s * r * c + a * u, I = a * r * c - s * u, E = r * s * c - a * u, A = s * s * c + h, C = a * s * c + r * u, D = r * a * c + s * u, R = s * a * c - r * u, P = a * a * c + h; return t.m00 = l * S + _ * T + y * I, t.m01 = f * S + g * T + b * I, t.m02 = d * S + m * T + w * I, t.m03 = p * S + v * T + x * I, t.m04 = l * E + _ * A + y * C, t.m05 = f * E + g * A + b * C, t.m06 = d * E + m * A + w * C, t.m07 = p * E + v * A + x * C, t.m08 = l * D + _ * R + y * P, t.m09 = f * D + g * R + b * P, t.m10 = d * D + m * R + w * P, t.m11 = p * D + v * R + x * P, e !== t && (t.m12 = e.m12, t.m13 = e.m13, t.m14 = e.m14, t.m15 = e.m15), t }, e.rotateX = function (t, e, i) { var n = zr(i), r = Ur(i), s = e.m04, a = e.m05, o = e.m06, u = e.m07, h = e.m08, c = e.m09, l = e.m10, f = e.m11; return e !== t && (t.m00 = e.m00, t.m01 = e.m01, t.m02 = e.m02, t.m03 = e.m03, t.m12 = e.m12, t.m13 = e.m13, t.m14 = e.m14, t.m15 = e.m15), t.m04 = s * r + h * n, t.m05 = a * r + c * n, t.m06 = o * r + l * n, t.m07 = u * r + f * n, t.m08 = h * r - s * n, t.m09 = c * r - a * n, t.m10 = l * r - o * n, t.m11 = f * r - u * n, t }, e.rotateY = function (t, e, i) { var n = zr(i), r = Ur(i), s = e.m00, a = e.m01, o = e.m02, u = e.m03, h = e.m08, c = e.m09, l = e.m10, f = e.m11; return e !== t && (t.m04 = e.m04, t.m05 = e.m05, t.m06 = e.m06, t.m07 = e.m07, t.m12 = e.m12, t.m13 = e.m13, t.m14 = e.m14, t.m15 = e.m15), t.m00 = s * r - h * n, t.m01 = a * r - c * n, t.m02 = o * r - l * n, t.m03 = u * r - f * n, t.m08 = s * n + h * r, t.m09 = a * n + c * r, t.m10 = o * n + l * r, t.m11 = u * n + f * r, t }, e.rotateZ = function (t, e, i) { var n = zr(i), r = Ur(i), s = e.m00, a = e.m01, o = e.m02, u = e.m03, h = e.m04, c = e.m05, l = e.m06, f = e.m07; return e !== t && (t.m08 = e.m08, t.m09 = e.m09, t.m10 = e.m10, t.m11 = e.m11, t.m12 = e.m12, t.m13 = e.m13, t.m14 = e.m14, t.m15 = e.m15), t.m00 = s * r + h * n, t.m01 = a * r + c * n, t.m02 = o * r + l * n, t.m03 = u * r + f * n, t.m04 = h * r - s * n, t.m05 = c * r - a * n, t.m06 = l * r - o * n, t.m07 = f * r - u * n, t }, e.fromTranslation = function (t, i) { return e.identity(t), t.m12 = i.x, t.m13 = i.y, t.m14 = i.z, t }, e.fromScaling = function (t, i) { return e.identity(t), t.m00 = i.x, t.m05 = i.y, t.m10 = i.z, t }, e.fromRotation = function (t, e, i) { var n = i.x, r = i.y, s = i.z, a = Nr(n * n + r * r + s * s); if (Fr(a) < Hi) return null; n *= a = 1 / a, r *= a, s *= a; var o = zr(e), u = Ur(e), h = 1 - u; return t.m00 = n * n * h + u, t.m01 = r * n * h + s * o, t.m02 = s * n * h - r * o, t.m03 = 0, t.m04 = n * r * h - s * o, t.m05 = r * r * h + u, t.m06 = s * r * h + n * o, t.m07 = 0, t.m08 = n * s * h + r * o, t.m09 = r * s * h - n * o, t.m10 = s * s * h + u, t.m11 = 0, t.m12 = 0, t.m13 = 0, t.m14 = 0, t.m15 = 1, t }, e.fromXRotation = function (t, i) { var n = zr(i), r = Ur(i); return e.identity(t), t.m05 = r, t.m06 = n, t.m09 = -n, t.m10 = r, t }, e.fromYRotation = function (t, i) { var n = zr(i), r = Ur(i); return e.identity(t), t.m00 = r, t.m02 = -n, t.m08 = n, t.m10 = r, t }, e.fromZRotation = function (t, i) { var n = zr(i), r = Ur(i); return e.identity(t), t.m00 = r, t.m01 = n, t.m04 = -n, t.m05 = r, t }, e.fromRT = function (t, e, i) { var n = e.x, r = e.y, s = e.z, a = e.w, o = n + n, u = r + r, h = s + s, c = n * o, l = n * u, f = n * h, d = r * u, p = r * h, _ = s * h, g = a * o, m = a * u, v = a * h; return t.m00 = 1 - (d + _), t.m01 = l + v, t.m02 = f - m, t.m03 = 0, t.m04 = l - v, t.m05 = 1 - (c + _), t.m06 = p + g, t.m07 = 0, t.m08 = f + m, t.m09 = p - g, t.m10 = 1 - (c + d), t.m11 = 0, t.m12 = i.x, t.m13 = i.y, t.m14 = i.z, t.m15 = 1, t }, e.getTranslation = function (t, e) { return t.x = e.m12, t.y = e.m13, t.z = e.m14, t }, e.getScaling = function (t, e) { var i = Wr.m00 = e.m00, n = Wr.m01 = e.m01, r = Wr.m02 = e.m02, s = Wr.m03 = e.m04, a = Wr.m04 = e.m05, o = Wr.m05 = e.m06, u = Wr.m06 = e.m08, h = Wr.m07 = e.m09, c = Wr.m08 = e.m10; return t.x = Nr(i * i + n * n + r * r), t.y = Nr(s * s + a * a + o * o), t.z = Nr(u * u + h * h + c * c), cr.determinant(Wr) < 0 && (t.x *= -1), t }, e.getRotation = function (t, e) { var i = e.m00 + e.m05 + e.m10, n = 0; return i > 0 ? (n = 2 * Nr(i + 1), t.w = .25 * n, t.x = (e.m06 - e.m09) / n, t.y = (e.m08 - e.m02) / n, t.z = (e.m01 - e.m04) / n) : e.m00 > e.m05 && e.m00 > e.m10 ? (n = 2 * Nr(1 + e.m00 - e.m05 - e.m10), t.w = (e.m06 - e.m09) / n, t.x = .25 * n, t.y = (e.m01 + e.m04) / n, t.z = (e.m08 + e.m02) / n) : e.m05 > e.m10 ? (n = 2 * Nr(1 + e.m05 - e.m00 - e.m10), t.w = (e.m08 - e.m02) / n, t.x = (e.m01 + e.m04) / n, t.y = .25 * n, t.z = (e.m06 + e.m09) / n) : (n = 2 * Nr(1 + e.m10 - e.m00 - e.m05), t.w = (e.m01 - e.m04) / n, t.x = (e.m08 + e.m02) / n, t.y = (e.m06 + e.m09) / n, t.z = .25 * n), t }, e.toRTS = function (t, i, n, r) { e.toSRT(t, i, n, r) }, e.toSRT = function (t, e, i, n) { i && Kn.set(i, t.m12, t.m13, t.m14); var r = Kn.set(Hr, t.m00, t.m01, t.m02).length(), s = Kn.set(Hr, t.m04, t.m05, t.m06).length(), a = Kn.set(Hr, t.m08, t.m09, t.m10).length(); if (n && (n.x = r, n.y = s, n.z = a), 0 !== r && 0 !== s && 0 !== a) { Wr.m00 = t.m00 / r, Wr.m01 = t.m01 / r, Wr.m02 = t.m02 / r, Wr.m03 = t.m04 / s, Wr.m04 = t.m05 / s, Wr.m05 = t.m06 / s, Wr.m06 = t.m08 / a, Wr.m07 = t.m09 / a, Wr.m08 = t.m10 / a; var o = cr.determinant(Wr); n && o < 0 && (n.x *= -1), e && (o < 0 && (Wr.m00 *= -1, Wr.m01 *= -1, Wr.m02 *= -1), Er.fromMat3(e, Wr)) } else e && Er.identity(e) }, e.toEuler = function (t, e) { return cr.set(Wr, t.m00, t.m01, t.m02, t.m04, t.m05, t.m06, t.m08, t.m09, t.m10), cr.toEuler(Wr, e) }, e.fromRTS = function (t, i, n, r) { return e.fromSRT(t, i, n, r) }, e.fromSRT = function (t, e, i, n) { var r = e.x, s = e.y, a = e.z, o = e.w, u = r + r, h = s + s, c = a + a, l = r * u, f = r * h, d = r * c, p = s * h, _ = s * c, g = a * c, m = o * u, v = o * h, y = o * c, b = n.x, w = n.y, x = n.z; return t.m00 = (1 - (p + g)) * b, t.m01 = (f + y) * b, t.m02 = (d - v) * b, t.m03 = 0, t.m04 = (f - y) * w, t.m05 = (1 - (l + g)) * w, t.m06 = (_ + m) * w, t.m07 = 0, t.m08 = (d + v) * x, t.m09 = (_ - m) * x, t.m10 = (1 - (l + p)) * x, t.m11 = 0, t.m12 = i.x, t.m13 = i.y, t.m14 = i.z, t.m15 = 1, t }, e.fromRTSOrigin = function (t, i, n, r, s) { return e.fromSRTOrigin(t, i, n, r, s) }, e.fromSRTOrigin = function (t, e, i, n, r) { var s = e.x, a = e.y, o = e.z, u = e.w, h = s + s, c = a + a, l = o + o, f = s * h, d = s * c, p = s * l, _ = a * c, g = a * l, m = o * l, v = u * h, y = u * c, b = u * l, w = n.x, x = n.y, S = n.z, T = r.x, I = r.y, E = r.z; return t.m00 = (1 - (_ + m)) * w, t.m01 = (d + b) * w, t.m02 = (p - y) * w, t.m03 = 0, t.m04 = (d - b) * x, t.m05 = (1 - (f + m)) * x, t.m06 = (g + v) * x, t.m07 = 0, t.m08 = (p + y) * S, t.m09 = (g - v) * S, t.m10 = (1 - (f + _)) * S, t.m11 = 0, t.m12 = i.x + T - (t.m00 * T + t.m04 * I + t.m08 * E), t.m13 = i.y + I - (t.m01 * T + t.m05 * I + t.m09 * E), t.m14 = i.z + E - (t.m02 * T + t.m06 * I + t.m10 * E), t.m15 = 1, t }, e.fromQuat = function (t, e) { var i = e.x, n = e.y, r = e.z, s = e.w, a = i + i, o = n + n, u = r + r, h = i * a, c = n * a, l = n * o, f = r * a, d = r * o, p = r * u, _ = s * a, g = s * o, m = s * u; return t.m00 = 1 - l - p, t.m01 = c + m, t.m02 = f - g, t.m03 = 0, t.m04 = c - m, t.m05 = 1 - h - p, t.m06 = d + _, t.m07 = 0, t.m08 = f + g, t.m09 = d - _, t.m10 = 1 - h - l, t.m11 = 0, t.m12 = 0, t.m13 = 0, t.m14 = 0, t.m15 = 1, t }, e.frustum = function (t, e, i, n, r, s, a) { var o = 1 / (i - e), u = 1 / (r - n), h = 1 / (s - a); return t.m00 = 2 * s * o, t.m01 = 0, t.m02 = 0, t.m03 = 0, t.m04 = 0, t.m05 = 2 * s * u, t.m06 = 0, t.m07 = 0, t.m08 = (i + e) * o, t.m09 = (r + n) * u, t.m10 = (a + s) * h, t.m11 = -1, t.m12 = 0, t.m13 = 0, t.m14 = a * s * 2 * h, t.m15 = 0, t }, e.perspective = function (t, e, i, n, r, s, a, o, u) { void 0 === s && (s = !0), void 0 === a && (a = -1), void 0 === o && (o = 1), void 0 === u && (u = 0); var h = 1 / Vr(e / 2), c = 1 / (n - r), l = s ? h / i : h, f = (s ? h : h * i) * o, d = Lr[u]; return t.m00 = l * d[0], t.m01 = l * d[1], t.m02 = 0, t.m03 = 0, t.m04 = f * d[2], t.m05 = f * d[3], t.m06 = 0, t.m07 = 0, t.m08 = 0, t.m09 = 0, t.m10 = (r - a * n) * c, t.m11 = -1, t.m12 = 0, t.m13 = 0, t.m14 = r * n * c * (1 - a), t.m15 = 0, t }, e.ortho = function (t, e, i, n, r, s, a, o, u, h) { void 0 === o && (o = -1), void 0 === u && (u = 1), void 0 === h && (h = 0); var c = 1 / (e - i), l = 1 / (n - r) * u, f = 1 / (s - a), d = -2 * c, p = -2 * l, _ = (e + i) * c, g = (r + n) * l, m = Lr[h]; return t.m00 = d * m[0], t.m01 = d * m[1], t.m02 = 0, t.m03 = 0, t.m04 = p * m[2], t.m05 = p * m[3], t.m06 = 0, t.m07 = 0, t.m08 = 0, t.m09 = 0, t.m10 = f * (1 - o), t.m11 = 0, t.m12 = _ * m[0] + g * m[2], t.m13 = _ * m[1] + g * m[3], t.m14 = (s - o * a) * f, t.m15 = 1, t }, e.lookAt = function (t, e, i, n) { var r = e.x, s = e.y, a = e.z, o = n.x, u = n.y, h = n.z, c = r - i.x, l = s - i.y, f = a - i.z, d = 1 / Nr(c * c + l * l + f * f), p = u * (f *= d) - h * (l *= d), _ = h * (c *= d) - o * f, g = o * l - u * c, m = l * (g *= d = 1 / Nr(p * p + _ * _ + g * g)) - f * (_ *= d), v = f * (p *= d) - c * g, y = c * _ - l * p; return t.m00 = p, t.m01 = m, t.m02 = c, t.m03 = 0, t.m04 = _, t.m05 = v, t.m06 = l, t.m07 = 0, t.m08 = g, t.m09 = y, t.m10 = f, t.m11 = 0, t.m12 = -(p * r + _ * s + g * a), t.m13 = -(m * r + v * s + y * a), t.m14 = -(c * r + l * s + f * a), t.m15 = 1, t }, e.inverseTranspose = function (t, e) { var i = e.m00, n = e.m01, r = e.m02, s = e.m03, a = e.m04, o = e.m05, u = e.m06, h = e.m07, c = e.m08, l = e.m09, f = e.m10, d = e.m11, p = e.m12, _ = e.m13, g = e.m14, m = e.m15, v = i * o - n * a, y = i * u - r * a, b = i * h - s * a, w = n * u - r * o, x = n * h - s * o, S = r * h - s * u, T = c * _ - l * p, I = c * g - f * p, E = c * m - d * p, A = l * g - f * _, C = l * m - d * _, D = f * m - d * g, R = v * D - y * C + b * A + w * E - x * I + S * T; return R ? (R = 1 / R, t.m00 = (o * D - u * C + h * A) * R, t.m01 = (u * E - a * D - h * I) * R, t.m02 = (a * C - o * E + h * T) * R, t.m03 = 0, t.m04 = (r * C - n * D - s * A) * R, t.m05 = (i * D - r * E + s * I) * R, t.m06 = (n * E - i * C - s * T) * R, t.m07 = 0, t.m08 = (_ * S - g * x + m * w) * R, t.m09 = (g * b - p * S - m * y) * R, t.m10 = (p * x - _ * b + m * v) * R, t.m11 = 0, t.m12 = 0, t.m13 = 0, t.m14 = 0, t.m15 = 1, t) : null }, e.toArray = function (t, e, i) { return void 0 === i && (i = 0), t[i + 0] = e.m00, t[i + 1] = e.m01, t[i + 2] = e.m02, t[i + 3] = e.m03, t[i + 4] = e.m04, t[i + 5] = e.m05, t[i + 6] = e.m06, t[i + 7] = e.m07, t[i + 8] = e.m08, t[i + 9] = e.m09, t[i + 10] = e.m10, t[i + 11] = e.m11, t[i + 12] = e.m12, t[i + 13] = e.m13, t[i + 14] = e.m14, t[i + 15] = e.m15, t }, e.fromArray = function (t, e, i) { return void 0 === i && (i = 0), t.m00 = e[i + 0], t.m01 = e[i + 1], t.m02 = e[i + 2], t.m03 = e[i + 3], t.m04 = e[i + 4], t.m05 = e[i + 5], t.m06 = e[i + 6], t.m07 = e[i + 7], t.m08 = e[i + 8], t.m09 = e[i + 9], t.m10 = e[i + 10], t.m11 = e[i + 11], t.m12 = e[i + 12], t.m13 = e[i + 13], t.m14 = e[i + 14], t.m15 = e[i + 15], t }, e.add = function (t, e, i) { return t.m00 = e.m00 + i.m00, t.m01 = e.m01 + i.m01, t.m02 = e.m02 + i.m02, t.m03 = e.m03 + i.m03, t.m04 = e.m04 + i.m04, t.m05 = e.m05 + i.m05, t.m06 = e.m06 + i.m06, t.m07 = e.m07 + i.m07, t.m08 = e.m08 + i.m08, t.m09 = e.m09 + i.m09, t.m10 = e.m10 + i.m10, t.m11 = e.m11 + i.m11, t.m12 = e.m12 + i.m12, t.m13 = e.m13 + i.m13, t.m14 = e.m14 + i.m14, t.m15 = e.m15 + i.m15, t }, e.subtract = function (t, e, i) { return t.m00 = e.m00 - i.m00, t.m01 = e.m01 - i.m01, t.m02 = e.m02 - i.m02, t.m03 = e.m03 - i.m03, t.m04 = e.m04 - i.m04, t.m05 = e.m05 - i.m05, t.m06 = e.m06 - i.m06, t.m07 = e.m07 - i.m07, t.m08 = e.m08 - i.m08, t.m09 = e.m09 - i.m09, t.m10 = e.m10 - i.m10, t.m11 = e.m11 - i.m11, t.m12 = e.m12 - i.m12, t.m13 = e.m13 - i.m13, t.m14 = e.m14 - i.m14, t.m15 = e.m15 - i.m15, t }, e.multiplyScalar = function (t, e, i) { return t.m00 = e.m00 * i, t.m01 = e.m01 * i, t.m02 = e.m02 * i, t.m03 = e.m03 * i, t.m04 = e.m04 * i, t.m05 = e.m05 * i, t.m06 = e.m06 * i, t.m07 = e.m07 * i, t.m08 = e.m08 * i, t.m09 = e.m09 * i, t.m10 = e.m10 * i, t.m11 = e.m11 * i, t.m12 = e.m12 * i, t.m13 = e.m13 * i, t.m14 = e.m14 * i, t.m15 = e.m15 * i, t }, e.multiplyScalarAndAdd = function (t, e, i, n) { return t.m00 = e.m00 + i.m00 * n, t.m01 = e.m01 + i.m01 * n, t.m02 = e.m02 + i.m02 * n, t.m03 = e.m03 + i.m03 * n, t.m04 = e.m04 + i.m04 * n, t.m05 = e.m05 + i.m05 * n, t.m06 = e.m06 + i.m06 * n, t.m07 = e.m07 + i.m07 * n, t.m08 = e.m08 + i.m08 * n, t.m09 = e.m09 + i.m09 * n, t.m10 = e.m10 + i.m10 * n, t.m11 = e.m11 + i.m11 * n, t.m12 = e.m12 + i.m12 * n, t.m13 = e.m13 + i.m13 * n, t.m14 = e.m14 + i.m14 * n, t.m15 = e.m15 + i.m15 * n, t }, e.strictEquals = function (t, e) { return t.m00 === e.m00 && t.m01 === e.m01 && t.m02 === e.m02 && t.m03 === e.m03 && t.m04 === e.m04 && t.m05 === e.m05 && t.m06 === e.m06 && t.m07 === e.m07 && t.m08 === e.m08 && t.m09 === e.m09 && t.m10 === e.m10 && t.m11 === e.m11 && t.m12 === e.m12 && t.m13 === e.m13 && t.m14 === e.m14 && t.m15 === e.m15 }, e.equals = function (t, e, i) { return void 0 === i && (i = Hi), Fr(t.m00 - e.m00) <= i * kr(1, Fr(t.m00), Fr(e.m00)) && Fr(t.m01 - e.m01) <= i * kr(1, Fr(t.m01), Fr(e.m01)) && Fr(t.m02 - e.m02) <= i * kr(1, Fr(t.m02), Fr(e.m02)) && Fr(t.m03 - e.m03) <= i * kr(1, Fr(t.m03), Fr(e.m03)) && Fr(t.m04 - e.m04) <= i * kr(1, Fr(t.m04), Fr(e.m04)) && Fr(t.m05 - e.m05) <= i * kr(1, Fr(t.m05), Fr(e.m05)) && Fr(t.m06 - e.m06) <= i * kr(1, Fr(t.m06), Fr(e.m06)) && Fr(t.m07 - e.m07) <= i * kr(1, Fr(t.m07), Fr(e.m07)) && Fr(t.m08 - e.m08) <= i * kr(1, Fr(t.m08), Fr(e.m08)) && Fr(t.m09 - e.m09) <= i * kr(1, Fr(t.m09), Fr(e.m09)) && Fr(t.m10 - e.m10) <= i * kr(1, Fr(t.m10), Fr(e.m10)) && Fr(t.m11 - e.m11) <= i * kr(1, Fr(t.m11), Fr(e.m11)) && Fr(t.m12 - e.m12) <= i * kr(1, Fr(t.m12), Fr(e.m12)) && Fr(t.m13 - e.m13) <= i * kr(1, Fr(t.m13), Fr(e.m13)) && Fr(t.m14 - e.m14) <= i * kr(1, Fr(t.m14), Fr(e.m14)) && Fr(t.m15 - e.m15) <= i * kr(1, Fr(t.m15), Fr(e.m15)) }; var i = e.prototype; return i.clone = function () { return new e(this.m00, this.m01, this.m02, this.m03, this.m04, this.m05, this.m06, this.m07, this.m08, this.m09, this.m10, this.m11, this.m12, this.m13, this.m14, this.m15) }, i.set = function (t, e, i, n, r, s, a, o, u, h, c, l, f, d, p, _) { void 0 === t && (t = 1), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 0), void 0 === r && (r = 0), void 0 === s && (s = 1), void 0 === a && (a = 0), void 0 === o && (o = 0), void 0 === u && (u = 0), void 0 === h && (h = 0), void 0 === c && (c = 1), void 0 === l && (l = 0), void 0 === f && (f = 0), void 0 === d && (d = 0), void 0 === p && (p = 0), void 0 === _ && (_ = 1); var g = this; return "object" == typeof t ? (g.m01 = t.m01, g.m02 = t.m02, g.m03 = t.m03, g.m04 = t.m04, g.m05 = t.m05, g.m06 = t.m06, g.m07 = t.m07, g.m08 = t.m08, g.m09 = t.m09, g.m10 = t.m10, g.m11 = t.m11, g.m12 = t.m12, g.m13 = t.m13, g.m14 = t.m14, g.m15 = t.m15, g.m00 = t.m00) : (g.m01 = e, g.m02 = i, g.m03 = n, g.m04 = r, g.m05 = s, g.m06 = a, g.m07 = o, g.m08 = u, g.m09 = h, g.m10 = c, g.m11 = l, g.m12 = f, g.m13 = d, g.m14 = p, g.m15 = _, g.m00 = t), g }, i.equals = function (t, e) { void 0 === e && (e = Hi); var i = 1 / 0, n = this, r = n.m00, s = n.m01, a = n.m02, o = n.m03, u = n.m04, h = n.m05, c = n.m06, l = n.m07, f = n.m08, d = n.m09, p = n.m10, _ = n.m11, g = n.m12, m = n.m13, v = n.m14, y = n.m15; return !(Fr(r) === i || Fr(s) === i || Fr(a) === i || Fr(o) === i || Fr(u) === i || Fr(h) === i || Fr(c) === i || Fr(l) === i || Fr(f) === i || Fr(d) === i || Fr(p) === i || Fr(_) === i || Fr(g) === i || Fr(m) === i || Fr(v) === i || Fr(y) === i) && Fr(r - t.m00) <= e * kr(1, Fr(r), Fr(t.m00)) && Fr(s - t.m01) <= e * kr(1, Fr(s), Fr(t.m01)) && Fr(a - t.m02) <= e * kr(1, Fr(a), Fr(t.m02)) && Fr(o - t.m03) <= e * kr(1, Fr(o), Fr(t.m03)) && Fr(u - t.m04) <= e * kr(1, Fr(u), Fr(t.m04)) && Fr(h - t.m05) <= e * kr(1, Fr(h), Fr(t.m05)) && Fr(c - t.m06) <= e * kr(1, Fr(c), Fr(t.m06)) && Fr(l - t.m07) <= e * kr(1, Fr(l), Fr(t.m07)) && Fr(f - t.m08) <= e * kr(1, Fr(f), Fr(t.m08)) && Fr(d - t.m09) <= e * kr(1, Fr(d), Fr(t.m09)) && Fr(p - t.m10) <= e * kr(1, Fr(p), Fr(t.m10)) && Fr(_ - t.m11) <= e * kr(1, Fr(_), Fr(t.m11)) && Fr(g - t.m12) <= e * kr(1, Fr(g), Fr(t.m12)) && Fr(m - t.m13) <= e * kr(1, Fr(m), Fr(t.m13)) && Fr(v - t.m14) <= e * kr(1, Fr(v), Fr(t.m14)) && Fr(y - t.m15) <= e * kr(1, Fr(y), Fr(t.m15)) }, i.strictEquals = function (t) { var e = this; return e.m00 === t.m00 && e.m01 === t.m01 && e.m02 === t.m02 && e.m03 === t.m03 && e.m04 === t.m04 && e.m05 === t.m05 && e.m06 === t.m06 && e.m07 === t.m07 && e.m08 === t.m08 && e.m09 === t.m09 && e.m10 === t.m10 && e.m11 === t.m11 && e.m12 === t.m12 && e.m13 === t.m13 && e.m14 === t.m14 && e.m15 === t.m15 }, i.toString = function () { var t = this; return "[\n" + t.m00 + ", " + t.m01 + ", " + t.m02 + ", " + t.m03 + ",\n" + t.m04 + ", " + t.m05 + ", " + t.m06 + ", " + t.m07 + ",\n" + t.m08 + ", " + t.m09 + ", " + t.m10 + ", " + t.m11 + ",\n" + t.m12 + ", " + t.m13 + ", " + t.m14 + ", " + t.m15 + "\n]" }, i.identity = function () { return e.identity(this) }, i.zero = function () { return e.zero(this) }, i.transpose = function () { var t = this, e = t.m01, i = t.m02, n = t.m03, r = t.m06, s = t.m07, a = t.m11; return t.m01 = t.m04, t.m02 = t.m08, t.m03 = t.m12, t.m04 = e, t.m06 = t.m09, t.m07 = t.m13, t.m08 = i, t.m09 = r, t.m11 = t.m14, t.m12 = n, t.m13 = s, t.m14 = a, t }, i.invert = function () { var t = this, e = t.m00, i = t.m01, n = t.m02, r = t.m03, s = t.m04, a = t.m05, o = t.m06, u = t.m07, h = t.m08, c = t.m09, l = t.m10, f = t.m11, d = t.m12, p = t.m13, _ = t.m14, g = t.m15, m = e * a - i * s, v = e * o - n * s, y = e * u - r * s, b = i * o - n * a, w = i * u - r * a, x = n * u - r * o, S = h * p - c * d, T = h * _ - l * d, I = h * g - f * d, E = c * _ - l * p, A = c * g - f * p, C = l * g - f * _, D = m * C - v * A + y * E + b * I - w * T + x * S; return 0 === D ? (t.set(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0), t) : (D = 1 / D, t.m00 = (a * C - o * A + u * E) * D, t.m01 = (n * A - i * C - r * E) * D, t.m02 = (p * x - _ * w + g * b) * D, t.m03 = (l * w - c * x - f * b) * D, t.m04 = (o * I - s * C - u * T) * D, t.m05 = (e * C - n * I + r * T) * D, t.m06 = (_ * y - d * x - g * v) * D, t.m07 = (h * x - l * y + f * v) * D, t.m08 = (s * A - a * I + u * S) * D, t.m09 = (i * I - e * A - r * S) * D, t.m10 = (d * w - p * y + g * m) * D, t.m11 = (c * y - h * w - f * m) * D, t.m12 = (a * T - s * E - o * S) * D, t.m13 = (e * E - i * T + n * S) * D, t.m14 = (p * v - d * b - _ * m) * D, t.m15 = (h * b - c * v + l * m) * D, t) }, i.determinant = function () { var t = this, e = t.m00, i = t.m01, n = t.m02, r = t.m03, s = t.m04, a = t.m05, o = t.m06, u = t.m07, h = t.m08, c = t.m09, l = t.m10, f = t.m11, d = t.m12, p = t.m13, _ = t.m14, g = t.m15; return (e * a - i * s) * (l * g - f * _) - (e * o - n * s) * (c * g - f * p) + (e * u - r * s) * (c * _ - l * p) + (i * o - n * a) * (h * g - f * d) - (i * u - r * a) * (h * _ - l * d) + (n * u - r * o) * (h * p - c * d) }, i.add = function (t) { var e = this; return e.m00 += t.m00, e.m01 += t.m01, e.m02 += t.m02, e.m03 += t.m03, e.m04 += t.m04, e.m05 += t.m05, e.m06 += t.m06, e.m07 += t.m07, e.m08 += t.m08, e.m09 += t.m09, e.m10 += t.m10, e.m11 += t.m11, e.m12 += t.m12, e.m13 += t.m13, e.m14 += t.m14, e.m15 += t.m15, e }, i.subtract = function (t) { var e = this; return e.m00 -= t.m00, e.m01 -= t.m01, e.m02 -= t.m02, e.m03 -= t.m03, e.m04 -= t.m04, e.m05 -= t.m05, e.m06 -= t.m06, e.m07 -= t.m07, e.m08 -= t.m08, e.m09 -= t.m09, e.m10 -= t.m10, e.m11 -= t.m11, e.m12 -= t.m12, e.m13 -= t.m13, e.m14 -= t.m14, e.m15 -= t.m15, e }, i.multiply = function (t) { return e.multiply(this, this, t) }, i.multiplyScalar = function (t) { var e = this; return e.m00 *= t, e.m01 *= t, e.m02 *= t, e.m03 *= t, e.m04 *= t, e.m05 *= t, e.m06 *= t, e.m07 *= t, e.m08 *= t, e.m09 *= t, e.m10 *= t, e.m11 *= t, e.m12 *= t, e.m13 *= t, e.m14 *= t, e.m15 *= t, e }, i.translate = function (t) { return this.m12 += t.x, this.m13 += t.y, this.m14 += t.z, this }, i.transform = function (t) { var e = t.x, i = t.y, n = t.z, r = this, s = r.m00, a = r.m01, o = r.m02, u = r.m03, h = r.m04, c = r.m05, l = r.m06, f = r.m07, d = r.m08, p = r.m09, _ = r.m10, g = r.m11; return r.m12 = s * e + h * i + d * n + r.m12, r.m13 = a * e + c * i + p * n + r.m13, r.m14 = o * e + l * i + _ * n + r.m14, r.m15 = u * e + f * i + g * n + r.m15, r }, i.scale = function (t) { var e = t.x, i = t.y, n = t.z, r = this; return r.m00 *= e, r.m01 *= e, r.m02 *= e, r.m03 *= e, r.m04 *= i, r.m05 *= i, r.m06 *= i, r.m07 *= i, r.m08 *= n, r.m09 *= n, r.m10 *= n, r.m11 *= n, r }, i.rotate = function (t, e) { var i = e.x, n = e.y, r = e.z, s = Nr(i * i + n * n + r * r); if (Fr(s) < Hi) return null; i *= s = 1 / s, n *= s, r *= s; var a = zr(t), o = Ur(t), u = 1 - o, h = this, c = h.m00, l = h.m01, f = h.m02, d = h.m03, p = h.m04, _ = h.m05, g = h.m06, m = h.m07, v = h.m08, y = h.m09, b = h.m10, w = h.m11, x = i * i * u + o, S = n * i * u + r * a, T = r * i * u - n * a, I = i * n * u - r * a, E = n * n * u + o, A = r * n * u + i * a, C = i * r * u + n * a, D = n * r * u - i * a, R = r * r * u + o; return h.m00 = c * x + p * S + v * T, h.m01 = l * x + _ * S + y * T, h.m02 = f * x + g * S + b * T, h.m03 = d * x + m * S + w * T, h.m04 = c * I + p * E + v * A, h.m05 = l * I + _ * E + y * A, h.m06 = f * I + g * E + b * A, h.m07 = d * I + m * E + w * A, h.m08 = c * C + p * D + v * R, h.m09 = l * C + _ * D + y * R, h.m10 = f * C + g * D + b * R, h.m11 = d * C + m * D + w * R, h }, i.getTranslation = function (t) { return t.x = this.m12, t.y = this.m13, t.z = this.m14, t }, i.getScale = function (t) { var e = this, i = Wr.m00 = e.m00, n = Wr.m01 = e.m01, r = Wr.m02 = e.m02, s = Wr.m03 = e.m04, a = Wr.m04 = e.m05, o = Wr.m05 = e.m06, u = Wr.m06 = e.m08, h = Wr.m07 = e.m09, c = Wr.m08 = e.m10; return t.x = Nr(i * i + n * n + r * r), t.y = Nr(s * s + a * a + o * o), t.z = Nr(u * u + h * h + c * c), cr.determinant(Wr) < 0 && (t.x *= -1), t }, i.getRotation = function (t) { var e = this, i = Kn.set(Hr, e.m00, e.m01, e.m02).length(), n = Kn.set(Hr, e.m04, e.m05, e.m06).length(), r = Kn.set(Hr, e.m08, e.m09, e.m10).length(); return Wr.m00 = e.m00 / i, Wr.m01 = e.m01 / i, Wr.m02 = e.m02 / i, Wr.m03 = e.m04 / n, Wr.m04 = e.m05 / n, Wr.m05 = e.m06 / n, Wr.m06 = e.m08 / r, Wr.m07 = e.m09 / r, Wr.m08 = e.m10 / r, cr.determinant(Wr) < 0 && (Wr.m00 *= -1, Wr.m01 *= -1, Wr.m02 *= -1), Er.fromMat3(t, Wr) }, i.fromRTS = function (t, i, n) { return e.fromSRT(this, t, i, n) }, i.fromSRT = function (t, i, n) { return e.fromSRT(this, t, i, n) }, i.fromQuat = function (t) { return e.fromQuat(this, t) }, e }(Re)); Ar = Gr, Gr.IDENTITY = Object.freeze(new Ar); var Hr = new Kn, Wr = new cr; function jr(t, e, i, n, r, s, a, o, u, h, c, l, f, d, p, _) { return new Gr(t, e, i, n, r, s, a, o, u, h, c, l, f, d, p, _) } Pi.fastDefine("cc.Mat4", Gr, { m00: 1, m01: 0, m02: 0, m03: 0, m04: 0, m05: 1, m06: 0, m07: 0, m08: 0, m09: 0, m10: 1, m11: 0, m12: 0, m13: 0, m14: 0, m15: 1 }), T.Mat4 = Gr, T.mat4 = jr; var Xr = Math.abs, qr = Math.max, Yr = Math.min, Kr = Math.PI, Qr = Math.acos, Zr = Math.sin, Jr = Math.cos, $r = Math.sqrt, ts = Math.atan2, es = Math.ceil, is = Math.floor, ns = Math.round; function rs(t, e) { return Object.freeze(new as(t, e)) } var ss, as = t("Vec2", function (t) { function e(e, i) { var n; return n = t.call(this) || this, "object" == typeof e ? (n.x = e.x, n.y = e.y) : (n.x = e || 0, n.y = i || 0), n } s(e, t), e.clone = function (t) { return new e(t.x, t.y) }, e.copy = function (t, e) { return t.x = e.x, t.y = e.y, t }, e.set = function (t, e, i) { return t.x = e, t.y = i, t }, e.add = function (t, e, i) { return t.x = e.x + i.x, t.y = e.y + i.y, t }, e.subtract = function (t, e, i) { return t.x = e.x - i.x, t.y = e.y - i.y, t }, e.multiply = function (t, e, i) { return t.x = e.x * i.x, t.y = e.y * i.y, t }, e.divide = function (t, e, i) { return t.x = e.x / i.x, t.y = e.y / i.y, t }, e.ceil = function (t, e) { return t.x = es(e.x), t.y = es(e.y), t }, e.floor = function (t, e) { return t.x = is(e.x), t.y = is(e.y), t }, e.min = function (t, e, i) { return t.x = Yr(e.x, i.x), t.y = Yr(e.y, i.y), t }, e.max = function (t, e, i) { return t.x = qr(e.x, i.x), t.y = qr(e.y, i.y), t }, e.round = function (t, e) { return t.x = ns(e.x), t.y = ns(e.y), t }, e.multiplyScalar = function (t, e, i) { return t.x = e.x * i, t.y = e.y * i, t }, e.scaleAndAdd = function (t, e, i, n) { return t.x = e.x + i.x * n, t.y = e.y + i.y * n, t }, e.distance = function (t, e) { var i = e.x - t.x, n = e.y - t.y; return $r(i * i + n * n) }, e.squaredDistance = function (t, e) { var i = e.x - t.x, n = e.y - t.y; return i * i + n * n }, e.len = function (t) { var e = t.x, i = t.y; return $r(e * e + i * i) }, e.lengthSqr = function (t) { var e = t.x, i = t.y; return e * e + i * i }, e.negate = function (t, e) { return t.x = -e.x, t.y = -e.y, t }, e.inverse = function (t, e) { return t.x = 1 / e.x, t.y = 1 / e.y, t }, e.inverseSafe = function (t, e) { var i = e.x, n = e.y; return Xr(i) < Hi ? t.x = 0 : t.x = 1 / i, Xr(n) < Hi ? t.y = 0 : t.y = 1 / n, t }, e.normalize = function (t, e) { var i = e.x, n = e.y, r = i * i + n * n; return r > 0 ? (r = 1 / $r(r), t.x = i * r, t.y = n * r) : (t.x = 0, t.y = 0), t }, e.dot = function (t, e) { return t.x * e.x + t.y * e.y }, e.cross = function (t, e, i) { return t instanceof Kn ? (t.x = t.y = 0, t.z = e.x * i.y - e.y * i.x, t) : t.x * e.y - t.y * e.x }, e.lerp = function (t, e, i, n) { var r = e.x, s = e.y; return t.x = r + n * (i.x - r), t.y = s + n * (i.y - s), t }, e.random = function (t, e) { e = e || 1; var i = 2 * Zi() * Kr; return t.x = Jr(i) * e, t.y = Zr(i) * e, t }, e.transformMat3 = function (t, e, i) { var n = e.x, r = e.y; return t.x = i.m00 * n + i.m03 * r + i.m06, t.y = i.m01 * n + i.m04 * r + i.m07, t }, e.transformMat4 = function (t, e, i) { var n = e.x, r = e.y; return t.x = i.m00 * n + i.m04 * r + i.m12, t.y = i.m01 * n + i.m05 * r + i.m13, t }, e.str = function (t) { return "Vec2(" + t.x + ", " + t.y + ")" }, e.toArray = function (t, e, i) { return void 0 === i && (i = 0), t[i + 0] = e.x, t[i + 1] = e.y, t }, e.fromArray = function (t, e, i) { return void 0 === i && (i = 0), t.x = e[i + 0], t.y = e[i + 1], t }, e.strictEquals = function (t, e) { return t.x === e.x && t.y === e.y }, e.equals = function (t, e, i) { return void 0 === i && (i = Hi), Xr(t.x - e.x) <= i * qr(1, Xr(t.x), Xr(e.x)) && Xr(t.y - e.y) <= i * qr(1, Xr(t.y), Xr(e.y)) }, e.angle = function (t, e) { var i = t.x * t.x + t.y * t.y, n = e.x * e.x + e.y * e.y; if (0 === i || 0 === n) return 0; var r = (t.x * e.x + t.y * e.y) / $r(i * n); return r = Xi(r, -1, 1), Qr(r) }; var i = e.prototype; return i.clone = function () { return new e(this.x, this.y) }, i.set = function (t, e) { return "object" == typeof t ? (this.x = t.x, this.y = t.y) : (this.x = t || 0, this.y = e || 0), this }, i.equals = function (t, i) { return void 0 === i && (i = Hi), e.equals(this, t, i) }, i.equals2f = function (t, e, i) { return void 0 === i && (i = Hi), Xr(this.x - t) <= i * qr(1, Xr(this.x), Xr(t)) && Xr(this.y - e) <= i * qr(1, Xr(this.y), Xr(e)) }, i.strictEquals = function (t) { return t && this.x === t.x && this.y === t.y }, i.strictEquals2f = function (t, e) { return this.x === t && this.y === e }, i.toString = function () { return "(" + this.x + ", " + this.y + ")" }, i.lerp = function (t, e) { var i = this.x, n = this.y; return this.x = i + e * (t.x - i), this.y = n + e * (t.y - n), this }, i.clampf = function (t, e) { return this.x = Xi(this.x, t.x, e.x), this.y = Xi(this.y, t.y, e.y), this }, i.add = function (t) { return this.x += t.x, this.y += t.y, this }, i.add2f = function (t, e) { return this.x += t, this.y += e, this }, i.subtract = function (t) { return this.x -= t.x, this.y -= t.y, this }, i.subtract2f = function (t, e) { return this.x -= t, this.y -= e, this }, i.multiplyScalar = function (t) { return "object" == typeof t && it(16359), this.x *= t, this.y *= t, this }, i.multiply = function (t) { return "object" != typeof t && it(16360), this.x *= t.x, this.y *= t.y, this }, i.multiply2f = function (t, e) { return this.x *= t, this.y *= e, this }, i.divide = function (t) { return this.x /= t.x, this.y /= t.y, this }, i.divide2f = function (t, e) { return this.x /= t, this.y /= e, this }, i.negative = function () { return this.x = -this.x, this.y = -this.y, this }, i.dot = function (t) { return this.x * t.x + this.y * t.y }, i.cross = function (t) { return this.x * t.y - this.y * t.x }, i.length = function () { return $r(this.x * this.x + this.y * this.y) }, i.lengthSqr = function () { return this.x * this.x + this.y * this.y }, i.normalize = function () { var t = this, e = t.x, i = t.y, n = e * e + i * i; return n > 0 && (n = 1 / $r(n), t.x *= n, t.y *= n), t }, i.angle = function (t) { var e = this.lengthSqr(), i = t.lengthSqr(); if (0 === e || 0 === i) return 0; var n = this.dot(t) / $r(e * i); return n = Xi(n, -1, 1), Qr(n) }, i.signAngle = function (t) { var e = this.cross(t), i = this.dot(t); return ts(e, i) }, i.rotate = function (t) { var e = this.x, i = this.y, n = Zr(t), r = Jr(t); return this.x = r * e - n * i, this.y = n * e + r * i, this }, i.project = function (t) { var e = this.dot(t) / t.dot(t); return this.x = t.x * e, this.y = t.y * e, this }, i.transformMat4 = function (t) { var e = this.x, i = this.y; return this.x = t.m00 * e + t.m04 * i + t.m12, this.y = t.m01 * e + t.m05 * i + t.m13, this }, i.toVec3 = function () { return new Kn(this.x, this.y, 0) }, e }(Re)); function os(t, e) { return new as(t, e) } as.ZERO = rs(0, 0), as.ONE = rs(1, 1), as.NEG_ONE = rs(-1, -1), as.UNIT_X = rs(1, 0), as.UNIT_Y = rs(0, 1), Pi.fastDefine("cc.Vec2", as, { x: 0, y: 0 }), T.Vec2 = as, T.v2 = os, lt(as, "Vec2", [{ name: "sub", newName: "subtract", target: as, targetName: "Vec2" }, { name: "mul", newName: "multiply", target: as, targetName: "Vec2" }, { name: "div", newName: "divide", target: as, targetName: "Vec2" }, { name: "dist", newName: "distance", target: as, targetName: "Vec2" }, { name: "sqrDist", newName: "squaredDistance", target: as, targetName: "Vec2" }, { name: "mag", newName: "len", target: as, targetName: "Vec2" }, { name: "sqrMag", newName: "lengthSqr", target: as, targetName: "Vec2" }, { name: "scale", newName: "multiplyScalar", target: as, targetName: "Vec2" }, { name: "exactEquals", newName: "strictEquals", target: as, targetName: "Vec2" }]), lt(as.prototype, "Vec2", [{ name: "mag", newName: "length", target: as.prototype, targetName: "Vec2" }, { name: "magSqr", newName: "lengthSqr", target: as.prototype, targetName: "Vec2" }, { name: "scale", newName: "multiplyScalar", target: as.prototype, targetName: "Vec2" }, { name: "exactEquals", newName: "strictEquals", target: as.prototype, targetName: "Vec2" }]), lt(Kn, "Vec3", [{ name: "sub", newName: "subtract", target: Kn, targetName: "Vec3" }, { name: "mul", newName: "multiply", target: Kn, targetName: "Vec3" }, { name: "div", newName: "divide", target: Kn, targetName: "Vec3" }, { name: "dist", newName: "distance", target: Kn, targetName: "Vec3" }, { name: "sqrDist", newName: "squaredDistance", target: Kn, targetName: "Vec3" }, { name: "mag", newName: "len", target: Kn, targetName: "Vec3" }, { name: "sqrMag", newName: "lengthSqr", target: Kn, targetName: "Vec3" }, { name: "scale", newName: "multiplyScalar", target: Kn, targetName: "Vec3" }, { name: "exactEquals", newName: "strictEquals", target: Kn, targetName: "Vec3" }]), lt(Kn.prototype, "Vec3", [{ name: "mag", newName: "length", target: Kn.prototype, targetName: "Vec3" }, { name: "magSqr", newName: "lengthSqr", target: Kn.prototype, targetName: "Vec3" }, { name: "scale", newName: "multiplyScalar", target: Kn.prototype, targetName: "Vec3" }, { name: "exactEquals", newName: "strictEquals", target: Kn.prototype, targetName: "Vec3" }]), lt(Pn, "Vec4", [{ name: "sub", newName: "subtract", target: Pn, targetName: "Vec4" }, { name: "mul", newName: "multiply", target: Pn, targetName: "Vec4" }, { name: "div", newName: "divide", target: Pn, targetName: "Vec4" }, { name: "dist", newName: "distance", target: Pn, targetName: "Vec4" }, { name: "sqrDist", newName: "squaredDistance", target: Pn, targetName: "Vec4" }, { name: "mag", newName: "len", target: Pn, targetName: "Vec4" }, { name: "sqrMag", newName: "lengthSqr", target: Pn, targetName: "Vec4" }, { name: "scale", newName: "multiplyScalar", target: Pn, targetName: "Vec4" }, { name: "exactEquals", newName: "strictEquals", target: Pn, targetName: "Vec4" }]), lt(Pn.prototype, "Vec4", [{ name: "mag", newName: "length", target: Pn.prototype, targetName: "Vec4" }, { name: "magSqr", newName: "lengthSqr", target: Pn.prototype, targetName: "Vec4" }, { name: "scale", newName: "multiplyScalar", target: Pn.prototype, targetName: "Vec4" }, { name: "exactEquals", newName: "strictEquals", target: Pn.prototype, targetName: "Vec4" }]), lt(Er, "Quat", [{ name: "mag", newName: "len", target: Er, targetName: "Quat" }, { name: "mul", newName: "multiply", target: Er, targetName: "Quat" }, { name: "sqrMag", newName: "lengthSqr", target: Er, targetName: "Quat" }, { name: "scale", newName: "multiplyScalar", target: Er, targetName: "Quat" }, { name: "exactEquals", newName: "strictEquals", target: Er, targetName: "Quat" }]), lt(Er.prototype, "Quat", [{ name: "scale", newName: "multiplyScalar", target: Er.prototype, targetName: "Quat" }, { name: "exactEquals", newName: "strictEquals", target: Er.prototype, targetName: "Quat" }]), lt(rr, "Color", [{ name: "sub", newName: "subtract", target: rr, targetName: "Color" }, { name: "mul", newName: "multiply", target: rr, targetName: "Color" }, { name: "div", newName: "divide", target: rr, targetName: "Color" }, { name: "exactEquals", newName: "strictEquals", target: rr, targetName: "Color" }, { name: "fromHex", newName: "fromHEX", customFunction: function () { for (var t = arguments.length, e = new Array(t), i = 0; i < t; i++)e[i] = arguments[i]; var n = e[1].toString(16); return T.Color.fromHEX(e[0], n) } }]), lt(cr, "Mat3", [{ name: "sub", newName: "subtract", target: cr, targetName: "Mat3" }, { name: "mul", newName: "multiply", target: cr, targetName: "Mat3" }, { name: "exactEquals", newName: "strictEquals", target: cr, targetName: "Mat3" }, { name: "transfrom", newName: "transform", target: cr, targetName: "Mat3" }]), lt(cr.prototype, "Mat3", [{ name: "sub", newName: "subtract", target: cr.prototype, targetName: "Mat3" }, { name: "mul", newName: "multiply", target: cr.prototype, targetName: "Mat3" }, { name: "mulScalar", newName: "multiplyScalar", target: cr.prototype, targetName: "Mat3" }, { name: "exactEquals", newName: "strictEquals", target: cr.prototype, targetName: "Mat3" }]), lt(Gr, "Mat4", [{ name: "sub", newName: "subtract", target: Gr, targetName: "Mat4" }, { name: "mul", newName: "multiply", target: Gr, targetName: "Mat4" }, { name: "exactEquals", newName: "strictEquals", target: Gr, targetName: "Mat4" }]), lt(Gr.prototype, "Mat4", [{ name: "sub", newName: "subtract", target: Gr.prototype, targetName: "Mat4" }, { name: "mul", newName: "multiply", target: Gr.prototype, targetName: "Mat4" }, { name: "mulScalar", newName: "multiplyScalar", target: Gr.prototype, targetName: "Mat4" }, { name: "exactEquals", newName: "strictEquals", target: Gr.prototype, targetName: "Mat4" }]); var us = t("Size", function (t) { function e(e, i) { var n; return n = t.call(this) || this, "object" == typeof e ? (n.width = e.width, n.height = e.height) : (n.width = e || 0, n.height = i || 0), n } s(e, t), e.lerp = function (t, e, i, n) { return t.width = e.width + (i.width - e.width) * n, t.height = e.height + (i.height - e.height) * n, t }, e.equals = function (t, e) { return t.width === e.width && t.height === e.height }; var i = e.prototype; return i.clone = function () { return new e(this.width, this.height) }, i.set = function (t, e) { return "object" == typeof t ? (this.height = t.height, this.width = t.width) : (this.width = t || 0, this.height = e || 0), this }, i.equals = function (t) { return this.width === t.width && this.height === t.height }, i.lerp = function (t, e) { return this.width += (t.width - this.width) * e, this.height += (t.height - this.height) * e, this }, i.toString = function () { return "(" + this.width + ", " + this.height + ")" }, n(e, [{ key: "x", get: function () { return this.width }, set: function (t) { this.width = t } }, { key: "y", get: function () { return this.height }, set: function (t) { this.height = t } }]), e }(Re)); function hs(t, e) { return void 0 === t && (t = 0), void 0 === e && (e = 0), new us(t, e) } ss = us, us.ZERO = Object.freeze(new ss(0, 0)), us.ONE = Object.freeze(new ss(1, 1)), Pi.fastDefine("cc.Size", us, { width: 0, height: 0 }), T.size = hs, T.Size = us; var cs = Math.max, ls = Math.min, fs = t("Rect", function (t) { function e(e, i, n, r) { var s; return s = t.call(this) || this, "object" == typeof e ? (s.x = e.x, s.y = e.y, s.width = e.width, s.height = e.height) : (s.x = e || 0, s.y = i || 0, s.width = n || 0, s.height = r || 0), s } s(e, t), e.fromMinMax = function (t, e, i) { var n = ls(e.x, i.x), r = ls(e.y, i.y), s = cs(e.x, i.x), a = cs(e.y, i.y); return t.x = n, t.y = r, t.width = s - n, t.height = a - r, t }, e.lerp = function (t, e, i, n) { var r = e.x, s = e.y, a = e.width, o = e.height; return t.x = r + (i.x - r) * n, t.y = s + (i.y - s) * n, t.width = a + (i.width - a) * n, t.height = o + (i.height - o) * n, t }, e.intersection = function (t, e, i) { var n = e.x, r = e.y, s = e.x + e.width, a = e.y + e.height, o = i.x, u = i.y, h = i.x + i.width, c = i.y + i.height; return t.x = cs(n, o), t.y = cs(r, u), t.width = ls(s, h) - t.x, t.height = ls(a, c) - t.y, t }, e.union = function (t, e, i) { var n = e.x, r = e.y, s = e.width, a = e.height, o = i.x, u = i.y, h = i.width, c = i.height; return t.x = ls(n, o), t.y = ls(r, u), t.width = cs(n + s, o + h) - t.x, t.height = cs(r + a, u + c) - t.y, t }, e.equals = function (t, e) { return t.x === e.x && t.y === e.y && t.width === e.width && t.height === e.height }; var i = e.prototype; return i.clone = function () { return new e(this.x, this.y, this.width, this.height) }, i.set = function (t, e, i, n) { var r = this; return "object" == typeof t ? (r.x = t.x, r.y = t.y, r.width = t.width, r.height = t.height) : (r.x = t || 0, r.y = e || 0, r.width = i || 0, r.height = n || 0), r }, i.equals = function (t) { var e = this; return e.x === t.x && e.y === t.y && e.width === t.width && e.height === t.height }, i.lerp = function (t, e) { var i = this, n = i.x, r = i.y, s = i.width, a = i.height; return i.x = n + (t.x - n) * e, i.y = r + (t.y - r) * e, i.width = s + (t.width - s) * e, i.height = a + (t.height - a) * e, i }, i.toString = function () { var t = this; return "(" + t.x + ", " + t.y + ", " + t.width + ", " + t.height + ")" }, i.intersects = function (t) { var e = this, i = e.x + e.width, n = e.y + e.height, r = t.x + t.width, s = t.y + t.height; return !(i < t.x || r < e.x || n < t.y || s < e.y) }, i.contains = function (t) { var e = this; return e.x <= t.x && e.x + e.width >= t.x && e.y <= t.y && e.y + e.height >= t.y }, i.containsRect = function (t) { var e = this; return e.x <= t.x && e.x + e.width >= t.x + t.width && e.y <= t.y && e.y + e.height >= t.y + t.height }, i.transformMat4 = function (t) { var e = this, i = e.x, n = e.y, r = i + e.width, s = n + e.height, a = t.m00 * i + t.m04 * n + t.m12, o = t.m01 * i + t.m05 * n + t.m13, u = t.m00 * r + t.m04 * n + t.m12, h = t.m01 * r + t.m05 * n + t.m13, c = t.m00 * i + t.m04 * s + t.m12, l = t.m01 * i + t.m05 * s + t.m13, f = t.m00 * r + t.m04 * s + t.m12, d = t.m01 * r + t.m05 * s + t.m13, p = ls(a, u, c, f), _ = cs(a, u, c, f), g = ls(o, h, l, d), m = cs(o, h, l, d); return e.x = p, e.y = g, e.width = _ - p, e.height = m - g, e }, i.transformMat4ToPoints = function (t, e, i, n, r) { var s = this, a = s.x, o = s.y, u = a + s.width, h = o + s.height; e.x = t.m00 * a + t.m04 * o + t.m12, e.y = t.m01 * a + t.m05 * o + t.m13, r.x = t.m00 * u + t.m04 * o + t.m12, r.y = t.m01 * u + t.m05 * o + t.m13, i.x = t.m00 * a + t.m04 * h + t.m12, i.y = t.m01 * a + t.m05 * h + t.m13, n.x = t.m00 * u + t.m04 * h + t.m12, n.y = t.m01 * u + t.m05 * h + t.m13 }, n(e, [{ key: "xMin", get: function () { return this.x }, set: function (t) { this.width += this.x - t, this.x = t } }, { key: "yMin", get: function () { return this.y }, set: function (t) { this.height += this.y - t, this.y = t } }, { key: "xMax", get: function () { return this.x + this.width }, set: function (t) { this.width = t - this.x } }, { key: "yMax", get: function () { return this.y + this.height }, set: function (t) { this.height = t - this.y } }, { key: "center", get: function () { return new as(this.x + .5 * this.width, this.y + .5 * this.height) }, set: function (t) { this.x = t.x - .5 * this.width, this.y = t.y - .5 * this.height } }, { key: "origin", get: function () { return new as(this.x, this.y) }, set: function (t) { this.x = t.x, this.y = t.y } }, { key: "size", get: function () { return new us(this.width, this.height) }, set: function (t) { this.width = t.width, this.height = t.height } }, { key: "z", get: function () { return this.width }, set: function (t) { this.width = t } }, { key: "w", get: function () { return this.height }, set: function (t) { this.height = t } }]), e }(Re)); function ds(t, e, i, n) { return void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 0), new fs(t, e, i, n) } Pi.fastDefine("cc.Rect", fs, { x: 0, y: 0, width: 0, height: 0 }), T.Rect = fs, T.rect = ds; var ps = t("MATH_FLOAT_ARRAY", Float64Array), _s = t("MathBase", function (t) { function e() { return t.apply(this, arguments) || this } return s(e, t), e.createFloatArray = function (t) { return new ps(t) }, n(e, [{ key: "array", get: function () { return this._array } }]), e }(Re)), gs = Object.freeze({ __proto__: null, Color: rr, EPSILON: Hi, HALF_PI: Vi, MATH_FLOAT_ARRAY: ps, Mat3: cr, Mat4: Gr, MathBase: _s, Quat: Er, Rect: fs, Size: us, TWO_PI: Gi, Vec2: as, Vec3: Kn, Vec4: Pn, absMax: cn, absMaxComponent: hn, approx: ji, bits: M, clamp: Xi, clamp01: qi, color: sr, enumerableProps: ln, equals: Wi, floatToHalf: gn, halfToFloat: mn, inverseLerp: un, lerp: Yi, mat4: jr, nextPow2: sn, pingPong: on, preTransforms: Lr, pseudoRandom: en, pseudoRandomRange: nn, pseudoRandomRangeInt: rn, quat: Mr, random: Zi, randomRange: $i, randomRangeInt: tn, rect: ds, repeat: an, setRandGenerator: Ji, size: hs, toDegree: Qi, toRadian: Ki, v2: os, v3: Qn, v4: Bn }); t("math", gs); var ms = new Kn, vs = new Kn, ys = new Kn, bs = new Kn, ws = new Kn, xs = new Kn, Ss = new Array(3), Ts = new Array(3); function Is(t, e) { return Kn.dot(e.n, t) - e.d } function Es(t, e, i) { return Kn.copy(t, e), Kn.subtract(ws, i.center, i.halfExtents), Kn.add(xs, i.center, i.halfExtents), t.x = t.x < ws.x ? ws.x : t.x, t.y = t.y < ws.y ? ws.y : t.y, t.z = t.z < ws.z ? ws.z : t.z, t.x = t.x > xs.x ? xs.x : t.x, t.y = t.y > xs.y ? xs.y : t.y, t.z = t.z > xs.z ? xs.z : t.z, t } function As(t, e, i) { Kn.set(ms, i.orientation.m00, i.orientation.m01, i.orientation.m02), Kn.set(vs, i.orientation.m03, i.orientation.m04, i.orientation.m05), Kn.set(ys, i.orientation.m06, i.orientation.m07, i.orientation.m08), Ss[0] = ms, Ss[1] = vs, Ss[2] = ys, Ts[0] = i.halfExtents.x, Ts[1] = i.halfExtents.y, Ts[2] = i.halfExtents.z, Kn.subtract(bs, e, i.center), Kn.set(t, i.center.x, i.center.y, i.center.z); for (var n = 0; n < 3; n++) { var r = Kn.dot(bs, Ss[n]); r > Ts[n] && (r = Ts[n]), r < -Ts[n] && (r = -Ts[n]), t.x += r * Ss[n].x, t.y += r * Ss[n].y, t.z += r * Ss[n].z } return t } var Cs = Object.freeze({ __proto__: null, point_plane: Is, pt_point_aabb: Es, pt_point_line: function (t, e, i, n) { Kn.subtract(ms, i, n); var r = ms.clone(), s = Kn.lengthSqr(r); if (0 === s) Kn.copy(t, i); else { Kn.subtract(ms, e, i); var a = Kn.dot(ms, r) / s; a < 0 ? Kn.copy(t, i) : a > 1 ? Kn.copy(t, n) : Kn.scaleAndAdd(t, i, r, a) } }, pt_point_obb: As, pt_point_plane: function (t, e, i) { var n = Is(e, i); return Kn.subtract(t, e, Kn.multiplyScalar(t, i.n, n)) } }), Ds = function () { function t(t, e, i, n, r, s) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 0), void 0 === r && (r = 0), void 0 === s && (s = -1), this.s = void 0, this.e = void 0, this._type = void 0, this._type = 2, this.s = new Kn(t, e, i), this.e = new Kn(n, r, s) } return t.create = function (e, i, n, r, s, a) { return new t(e, i, n, r, s, a) }, t.clone = function (e) { return new t(e.s.x, e.s.y, e.s.z, e.e.x, e.e.y, e.e.z) }, t.copy = function (t, e) { return Kn.copy(t.s, e.s), Kn.copy(t.e, e.e), t }, t.fromPoints = function (t, e, i) { return Kn.copy(t.s, e), Kn.copy(t.e, i), t }, t.set = function (t, e, i, n, r, s, a) { return t.s.x = e, t.s.y = i, t.s.z = n, t.e.x = r, t.e.y = s, t.e.z = a, t }, t.len = function (t) { return Kn.distance(t.s, t.e) }, t.prototype.length = function () { return Kn.distance(this.s, this.e) }, n(t, [{ key: "type", get: function () { return this._type } }]), t }(), Rs = function () { function t(t, e, i, n, r, s) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 0), void 0 === r && (r = 0), void 0 === s && (s = -1), this._type = 1, this.o = new Kn(t, e, i), this.d = new Kn(n, r, s) } return t.create = function (e, i, n, r, s, a) { return void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 0), void 0 === r && (r = 0), void 0 === s && (s = 0), void 0 === a && (a = 1), new t(e, i, n, r, s, a) }, t.clone = function (e) { return new t(e.o.x, e.o.y, e.o.z, e.d.x, e.d.y, e.d.z) }, t.copy = function (t, e) { return Kn.copy(t.o, e.o), Kn.copy(t.d, e.d), t }, t.fromPoints = function (t, e, i) { return Kn.copy(t.o, e), Kn.normalize(t.d, Kn.subtract(t.d, i, e)), t }, t.set = function (t, e, i, n, r, s, a) { return t.o.x = e, t.o.y = i, t.o.z = n, t.d.x = r, t.d.y = s, t.d.z = a, t }, t.prototype.computeHit = function (t, e) { Kn.normalize(t, this.d), Kn.scaleAndAdd(t, this.o, t, e) }, n(t, [{ key: "type", get: function () { return this._type } }]), t }(), Ps = new Kn, Bs = new Kn, Ms = new Kn, Os = new Kn; function Ls(t) { return Math.max(Math.max(t.x, t.y), t.z) } var Fs, ks, Ns, zs, Us, Vs = function () { function t(t, e, i, n) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 1), this._type = 4, this._center = new Kn(t, e, i), this._radius = n } t.create = function (e, i, n, r) { return new t(e, i, n, r) }, t.clone = function (e) { return new t(e.center.x, e.center.y, e.center.z, e.radius) }, t.copy = function (t, e) { return Kn.copy(t.center, e.center), t.radius = e.radius, t }, t.fromPoints = function (t, e, i) { return Kn.multiplyScalar(t.center, Kn.add(Ps, e, i), .5), t.radius = .5 * Kn.subtract(Ps, i, e).length(), t }, t.set = function (t, e, i, n, r) { return t.center.x = e, t.center.y = i, t.center.z = n, t.radius = r, t }; var e = t.prototype; return e.destroy = function () { }, e.clone = function () { return t.clone(this) }, e.copy = function (e) { return t.copy(this, e) }, e.getBoundary = function (t, e) { Kn.set(t, this.center.x - this.radius, this.center.y - this.radius, this.center.z - this.radius), Kn.set(e, this.center.x + this.radius, this.center.y + this.radius, this.center.z + this.radius) }, e.transform = function (t, e, i, n, r) { Kn.transformMat4(r.center, this.center, t), r.radius = this.radius * Ls(n) }, e.translateAndRotate = function (t, e, i) { Kn.transformMat4(i.center, this.center, t) }, e.setScale = function (t, e) { e.radius = this.radius * Ls(t) }, e.mergePoint = function (t) { this.radius < 0 && (this.center.set(t), this.radius = 0), Kn.subtract(Bs, t, this.center); var e = Bs.length(); if (e > this.radius) { var i = .5 * (e - this.radius); this.radius += i, Kn.multiplyScalar(Bs, Bs, i / e), Kn.add(this.center, this.center, Bs) } }, e.mergePoints = function (t) { var e = t.length; if (!(e < 1)) { this.radius = -1; for (var i = 0; i < e; i++)this.mergePoint(t[i]) } }, e.mergeAABB = function (t) { t.getBoundary(Ms, Os), this.mergePoint(Ms), this.mergePoint(Os) }, n(t, [{ key: "center", get: function () { return this._center }, set: function (t) { this._center = t } }, { key: "radius", get: function () { return this._radius }, set: function (t) { this._radius = t } }, { key: "type", get: function () { return this._type } }]), t }(), Gs = Kn.squaredDistance, Hs = Kn.subtract, Ws = Kn.dot, js = Kn.set, Xs = Kn.cross, qs = Kn.multiplyScalar, Ys = Kn.copy, Ks = Kn.add, Qs = Kn.scaleAndAdd, Zs = Math.max, Js = Math.min, $s = Math.abs, ta = function (t, e) { var i = Ws(t.d, e.n); if ($s(i) < Number.EPSILON) return 0; var n = -Is(t.o, e) / i; return n < 0 ? 0 : n }, ea = (Fs = Qn(), ks = Qn(), Ns = Qn(), zs = Qn(), Us = Qn(), function (t, e, i) { Hs(Fs, e.b, e.a), Hs(ks, e.c, e.a), Xs(Ns, t.d, ks); var n = Ws(Fs, Ns); if (n < Number.EPSILON && (!i || n > -Number.EPSILON)) return 0; var r = 1 / n; Hs(zs, t.o, e.a); var s = Ws(zs, Ns) * r; if (s < 0 || s > 1) return 0; Xs(Us, zs, Fs); var a = Ws(t.d, Us) * r; if (a < 0 || s + a > 1) return 0; var o = Ws(ks, Us) * r; return o < 0 ? 0 : o }), ia = function () { var t = Qn(); return function (e, i) { var n = i.radius, r = i.center, s = e.o, a = e.d, o = n * n; Hs(t, r, s); var u = t.lengthSqr(), h = Ws(t, a), c = o - (u - h * h); if (c < 0) return 0; var l = Math.sqrt(c), f = u < o ? h + l : h - l; return f < 0 ? 0 : f } }(), na = function () { var t = Qn(), e = Qn(); return function (i, n) { return Hs(t, n.center, n.halfExtents), Ks(e, n.center, n.halfExtents), ra(i, t, e) } }(); function ra(t, e, i) { var n = t.o, r = t.d, s = 1 / r.x, a = 1 / r.y, o = 1 / r.z, u = (e.x - n.x) * s, h = (i.x - n.x) * s, c = (e.y - n.y) * a, l = (i.y - n.y) * a, f = (e.z - n.z) * o, d = (i.z - n.z) * o, p = Zs(Zs(Js(u, h), Js(c, l)), Js(f, d)), _ = Js(Js(Zs(u, h), Zs(c, l)), Zs(f, d)); return _ < 0 || p > _ ? 0 : p > 0 ? p : _ } var sa = function () { var t = Qn(), e = Qn(), i = Qn(), n = Qn(), r = Qn(), s = Qn(), a = Qn(), o = new Array(3), u = new Array(3), h = new Array(3), c = new Array(6); return function (l, f) { var d = f.halfExtents, p = f.orientation; o[0] = d.x, o[1] = d.y, o[2] = d.z, t = f.center, e = l.o, i = l.d, js(n, p.m00, p.m01, p.m02), js(r, p.m03, p.m04, p.m05), js(s, p.m06, p.m07, p.m08), Hs(a, t, e), u[0] = Ws(n, i), u[1] = Ws(r, i), u[2] = Ws(s, i), h[0] = Ws(n, a), h[1] = Ws(r, a), h[2] = Ws(s, a); for (var _ = 0; _ < 3; ++_) { if (0 === u[_]) { if (-h[_] - o[_] > 0 || -h[_] + o[_] < 0) return 0; u[_] = 1e-7 } c[2 * _ + 0] = (h[_] + o[_]) / u[_], c[2 * _ + 1] = (h[_] - o[_]) / u[_] } var g = Zs(Zs(Js(c[0], c[1]), Js(c[2], c[3])), Js(c[4], c[5])), m = Js(Js(Zs(c[0], c[1]), Zs(c[2], c[3])), Zs(c[4], c[5])); return m < 0 || g > m ? 0 : g > 0 ? g : m } }(), aa = function () { var t = Qn(), e = Qn(), i = Qn(), n = Qn(), r = Qn(), s = Qn(), a = Qn(), o = new Vs; return function (u, h) { var c = h.ellipseCenter0, l = h.ellipseCenter1, f = Hs(e, l, c); if (f.length() < Hi) return o.radius = h.radius, o.center.set(h.ellipseCenter0), Wa.raySphere(u, o); var d = u.o, p = Hs(i, d, c), _ = Kn.normalize(t, u.d), g = Xs(n, _, f), m = g.lengthSqr(); if (0 === m) { o.radius = h.radius; var v = Hs(r, l, d); return p.lengthSqr() < v.lengthSqr() ? o.center.set(c) : o.center.set(l), Wa.raySphere(u, o) } var y = Xs(r, p, f), b = f.lengthSqr(), w = 2 * Ws(g, y), x = h.radius * h.radius, S = w * w - 4 * m * (y.lengthSqr() - x * b); if (S < 0) return 0; var T = (-w - Math.sqrt(S)) / (2 * m); if (T < 0) { o.radius = h.radius; var I = Hs(s, l, d); return p.lengthSqr() < I.lengthSqr() ? o.center.set(h.ellipseCenter0) : o.center.set(h.ellipseCenter1), Wa.raySphere(u, o) } var E = Qs(s, u.o, _, T), A = Hs(a, E, c), C = Ws(A, f) / b; return C >= 0 && C <= 1 ? T : C < 0 ? (o.radius = h.radius, o.center.set(h.ellipseCenter0), Wa.raySphere(u, o)) : C > 1 ? (o.radius = h.radius, o.center.set(h.ellipseCenter1), Wa.raySphere(u, o)) : 0 } }(), oa = function () { var t = Qn(); return function (e, i) { Hs(t, e.e, e.s); var n = -Is(e.s, i) / Ws(t, i.n); return n < 0 || n > 1 ? 0 : n } }(), ua = function () { var t = Qn(), e = Qn(), i = Qn(), n = Qn(), r = Qn(), s = Qn(); return function (a, o, u) { Hs(t, o.b, o.a), Hs(e, o.c, o.a), Hs(i, a.s, a.e), Xs(r, t, e); var h = Ws(i, r); if (h <= 0) return 0; Hs(n, a.s, o.a); var c = Ws(n, r); if (c < 0 || c > h) return 0; Xs(s, i, n); var l = Ws(e, s); if (l < 0 || l > h) return 0; var f = -Ws(t, s); if (f < 0 || l + f > h) return 0; if (u) { var d = 1 / h, p = 1 - (l *= d) - (f *= d); js(u, o.a.x * p + o.b.x * l + o.c.x * f, o.a.y * p + o.b.y * l + o.c.y * f, o.a.z * p + o.b.z * l + o.c.z * f) } return 1 } }(), ha = new Rs; function ca(t, e) { ha.o.set(t.s), Hs(ha.d, t.e, t.s), ha.d.normalize(); var i = na(ha, e); return i <= t.length() ? i : 0 } function la(t, e) { ha.o.set(t.s), Hs(ha.d, t.e, t.s), ha.d.normalize(); var i = sa(ha, e); return i <= t.length() ? i : 0 } function fa(t, e) { ha.o.set(t.s), Hs(ha.d, t.e, t.s), ha.d.normalize(); var i = ia(ha, e); return i <= t.length() ? i : 0 } var da, pa, _a, ga, ma = (da = Qn(), pa = Qn(), _a = Qn(), ga = Qn(), function (t, e) { return Hs(da, t.center, t.halfExtents), Ks(pa, t.center, t.halfExtents), Hs(_a, e.center, e.halfExtents), Ks(ga, e.center, e.halfExtents), da.x <= ga.x && pa.x >= _a.x && da.y <= ga.y && pa.y >= _a.y && da.z <= ga.z && pa.z >= _a.z }); function va(t, e, i) { js(i[0], t.x, e.y, e.z), js(i[1], t.x, e.y, t.z), js(i[2], t.x, t.y, e.z), js(i[3], t.x, t.y, t.z), js(i[4], e.x, e.y, e.z), js(i[5], e.x, e.y, t.z), js(i[6], e.x, t.y, e.z), js(i[7], e.x, t.y, t.z) } function ya(t, e, i, n, r, s) { js(s[0], t.x + i.x * e.x + n.x * e.y + r.x * e.z, t.y + i.y * e.x + n.y * e.y + r.y * e.z, t.z + i.z * e.x + n.z * e.y + r.z * e.z), js(s[1], t.x - i.x * e.x + n.x * e.y + r.x * e.z, t.y - i.y * e.x + n.y * e.y + r.y * e.z, t.z - i.z * e.x + n.z * e.y + r.z * e.z), js(s[2], t.x + i.x * e.x - n.x * e.y + r.x * e.z, t.y + i.y * e.x - n.y * e.y + r.y * e.z, t.z + i.z * e.x - n.z * e.y + r.z * e.z), js(s[3], t.x + i.x * e.x + n.x * e.y - r.x * e.z, t.y + i.y * e.x + n.y * e.y - r.y * e.z, t.z + i.z * e.x + n.z * e.y - r.z * e.z), js(s[4], t.x - i.x * e.x - n.x * e.y - r.x * e.z, t.y - i.y * e.x - n.y * e.y - r.y * e.z, t.z - i.z * e.x - n.z * e.y - r.z * e.z), js(s[5], t.x + i.x * e.x - n.x * e.y - r.x * e.z, t.y + i.y * e.x - n.y * e.y - r.y * e.z, t.z + i.z * e.x - n.z * e.y - r.z * e.z), js(s[6], t.x - i.x * e.x + n.x * e.y - r.x * e.z, t.y - i.y * e.x + n.y * e.y - r.y * e.z, t.z - i.z * e.x + n.z * e.y - r.z * e.z), js(s[7], t.x - i.x * e.x - n.x * e.y + r.x * e.z, t.y - i.y * e.x - n.y * e.y + r.y * e.z, t.z - i.z * e.x - n.z * e.y + r.z * e.z) } function ba(t, e) { for (var i = Ws(e, t[0]), n = i, r = 1; r < 8; ++r) { var s = Ws(e, t[r]); i = s < i ? s : i, n = s > n ? s : n } return [i, n] } var wa, xa, Sa, Ta, Ia, Ea = function () { for (var t = new Array(15), e = 0; e < 15; e++)t[e] = Qn(); for (var i = new Array(8), n = new Array(8), r = 0; r < 8; r++)i[r] = Qn(), n[r] = Qn(); var s = Qn(), a = Qn(); return function (e, r) { var o = r.orientation; js(t[0], 1, 0, 0), js(t[1], 0, 1, 0), js(t[2], 0, 0, 1), js(t[3], o.m00, o.m01, o.m02), js(t[4], o.m03, o.m04, o.m05), js(t[5], o.m06, o.m07, o.m08); for (var u = 0; u < 3; ++u)Xs(t[6 + 3 * u], t[u], t[3]), Xs(t[7 + 3 * u], t[u], t[4]), Xs(t[7 + 3 * u], t[u], t[5]); Hs(s, e.center, e.halfExtents), Ks(a, e.center, e.halfExtents), va(s, a, i), ya(r.center, r.halfExtents, t[3], t[4], t[5], n); for (var h = 0; h < 15; ++h) { var c = ba(i, t[h]), l = ba(n, t[h]); if (l[0] > c[1] || c[0] > l[1]) return 0 } return 1 } }(), Aa = function (t, e) { var i = t.halfExtents, n = e.n, r = i.x * $s(n.x) + i.y * $s(n.y) + i.z * $s(n.z), s = Ws(n, t.center); return s + r < e.d ? -1 : s - r > e.d ? 0 : 1 }, Ca = function (t, e) { for (var i = e.planes, n = 0; n < i.length; n++)if (-1 === Aa(t, i[n])) return 0; return 1 }, Da = function () { for (var t = new Array(8), e = 0, i = 0, n = 0; n < t.length; n++)t[n] = Qn(); return function (n, r) { for (var s = r.vertices, a = n.halfExtents, o = 0, u = !1, h = 0; h < r.planes.length; h++) { if (-1 === (o = Aa(n, r.planes[h]))) return 0; 1 === o && (u = !0) } if (!u) return 1; for (var c = 0; c < s.length; c++)Hs(t[c], s[c], n.center); e = 0, i = 0; for (var l = 0; l < s.length; l++)t[l].x > a.x ? e++ : t[l].x < -a.x && i++; if (e === s.length || i === s.length) return 0; e = 0, i = 0; for (var f = 0; f < s.length; f++)t[f].y > a.y ? e++ : t[f].y < -a.y && i++; if (e === s.length || i === s.length) return 0; e = 0, i = 0; for (var d = 0; d < s.length; d++)t[d].z > a.z ? e++ : t[d].z < -a.z && i++; return e === s.length || i === s.length ? 0 : 1 } }(), Ra = (wa = Qn(), xa = new cr, function (t, e) { return Hs(wa, e, t.center), Kn.transformMat3(wa, wa, cr.transpose(xa, t.orientation)), i = wa, n = t.halfExtents, $s(i.x) < n.x && $s(i.y) < n.y && $s(i.z) < n.z; var i, n }), Pa = (Sa = function (t, e, i, n) { return $s(t.x * e + t.y * i + t.z * n) }, function (t, e) { var i = t.orientation, n = t.halfExtents, r = e.n, s = e.d, a = n.x * Sa(r, i.m00, i.m01, i.m02) + n.y * Sa(r, i.m03, i.m04, i.m05) + n.z * Sa(r, i.m06, i.m07, i.m08), o = Ws(r, t.center); return o + a < s ? -1 : o - a > s ? 0 : 1 }), Ba = function (t, e) { for (var i = e.planes, n = 0; n < i.length; n++)if (-1 === Pa(t, i[n])) return 0; return 1 }, Ma = function () { for (var t = new Array(8), e = 0, i = 0, n = 0, r = 0; r < t.length; r++)t[r] = Qn(); var s = function (t, e, i, n) { return t.x * e + t.y * i + t.z * n }; return function (r, a) { for (var o = r.orientation, u = r.halfExtents, h = a.vertices, c = a.planes, l = 0, f = !1, d = 0; d < c.length; d++) { if (-1 === (l = Pa(r, c[d]))) return 0; 1 === l && (f = !0) } if (!f) return 1; for (var p = 0; p < h.length; p++)Hs(t[p], h[p], r.center); i = 0, n = 0; for (var _ = 0; _ < h.length; _++)(e = s(t[_], o.m00, o.m01, o.m02)) > u.x ? i++ : e < -u.x && n++; if (i === h.length || n === h.length) return 0; i = 0, n = 0; for (var g = 0; g < h.length; g++)(e = s(t[g], o.m03, o.m04, o.m05)) > u.y ? i++ : e < -u.y && n++; if (i === h.length || n === h.length) return 0; i = 0, n = 0; for (var m = 0; m < h.length; m++)(e = s(t[m], o.m06, o.m07, o.m08)) > u.z ? i++ : e < -u.z && n++; return i === h.length || n === h.length ? 0 : 1 } }(), Oa = function () { for (var t = new Array(15), e = 0; e < 15; e++)t[e] = Qn(); for (var i = new Array(8), n = new Array(8), r = 0; r < 8; r++)i[r] = Qn(), n[r] = Qn(); return function (e, r) { var s = e.orientation, a = r.orientation; js(t[0], s.m00, s.m01, s.m02), js(t[1], s.m03, s.m04, s.m05), js(t[2], s.m06, s.m07, s.m08), js(t[3], a.m00, a.m01, a.m02), js(t[4], a.m03, a.m04, a.m05), js(t[5], a.m06, a.m07, a.m08); for (var o = 0; o < 3; ++o)Xs(t[6 + 3 * o], t[o], t[3]), Xs(t[7 + 3 * o], t[o], t[4]), Xs(t[8 + 3 * o], t[o], t[5]); ya(e.center, e.halfExtents, t[0], t[1], t[2], i), ya(r.center, r.halfExtents, t[3], t[4], t[5], n); for (var u = 0; u < 15; ++u) { var h = ba(i, t[u]), c = ba(n, t[u]); if (c[0] > h[1] || h[0] > c[1]) return 0 } return 1 } }(), La = function () { for (var t = new Vs, e = Qn(), i = Qn(), n = Qn(), r = new Array(8), s = 0; s < 8; s++)r[s] = Qn(); for (var a = new Array(8), o = 0; o < 8; o++)a[o] = Qn(); return function (s, o) { var u = o.ellipseCenter0, h = o.ellipseCenter1, c = o.radius; if (0 === Gs(u, h)) return t.radius = o.radius, t.center.set(u), Wa.sphereOBB(t, s); var l = s.orientation; e.x = l.m00, e.y = l.m01, e.z = l.m02, i.x = l.m03, i.y = l.m04, i.z = l.m05, n.x = l.m06, n.y = l.m07, n.z = l.m08, ya(s.center, s.halfExtents, e, i, n, r); var f = a, d = Ys(f[0], e), p = Ys(f[1], i), _ = Ys(f[2], n); Hs(f[3], o.center, s.center).normalize(); var g = Hs(f[4], u, h); g.normalize(), Xs(f[5], d, g), Xs(f[6], p, g), Xs(f[7], _, g); for (var m = 0; m < 8; ++m) { var v = ba(r, f[m]), y = Ws(f[m], u), b = Ws(f[m], h), w = Zs(y, b) + c; if (Js(y, b) - c > v[1] || v[0] > w) return 0 } return 1 } }(), Fa = function (t, e) { var i = Ws(e.n, t.center), n = t.radius * e.n.length(); return i + n < e.d ? -1 : i - n > e.d ? 0 : 1 }, ka = function (t, e) { for (var i = e.planes, n = 0; n < i.length; n++)if (-1 === Fa(t, i[n])) return 0; return 1 }, Na = (Ta = Qn(), Ia = [1, -1, 1, -1, 1, -1], function (t, e) { for (var i = 0; i < 6; i++) { var n = e.planes[i], r = t.radius, s = t.center, a = n.n, o = n.d, u = Ws(a, s); if (u + r < o) return 0; if (!(u - r > o)) { Ks(Ta, s, qs(Ta, a, r)); for (var h = 0; h < 6; h++)if (h !== i && h !== i + Ia[i]) { var c = e.planes[h]; if (Ws(c.n, Ta) < c.d) return 0 } } } return 1 }), za = function (t, e) { var i = t.radius + e.radius; return Gs(t.center, e.center) < i * i }, Ua = function () { var t = Qn(); return function (e, i) { var n = e.radius; return Es(t, e.center, i), Gs(e.center, t) < n * n } }(), Va = function () { var t = Qn(); return function (e, i) { var n = e.radius; return As(t, e.center, i), Gs(e.center, t) < n * n } }(), Ga = function () { var t = Qn(), e = Qn(); return function (i, n) { var r = n.ellipseCenter0, s = n.ellipseCenter1, a = i.center, o = i.radius + n.radius, u = o * o, h = Gs(r, s); if (0 === h) return Gs(a, n.center) < u; Hs(t, a, r), Hs(e, s, r); var c = Ws(t, e) / h; return c < 0 ? Gs(a, r) < u : c > 1 ? Gs(a, s) < u : (Qs(t, r, e, c), Gs(a, t) < u) } }(), Ha = function () { var t = Qn(), e = Qn(), i = Qn(), n = Qn(), r = Qn(), s = Qn(); return function (a, o) { var u, h, c = a.ellipseCenter0, l = a.ellipseCenter1, f = o.ellipseCenter1, d = o.ellipseCenter0, p = Hs(t, l, c), _ = Hs(e, f, d), g = Hs(i, c, d), m = Ws(p, p), v = Ws(p, _), y = Ws(_, _), b = Ws(p, g), w = Ws(_, g), x = m * y - v * v, S = x, T = x; x < Hi ? (u = 0, S = 1, h = w, T = y) : (h = m * w - v * b, (u = v * w - y * b) < 0 ? (u = 0, h = w, T = y) : u > S && (u = S, h = w + v, T = y)), h < 0 ? (h = 0, -b < 0 ? u = 0 : -b > m ? u = S : (u = -b, S = m)) : h > T && (h = T, -b + v < 0 ? u = 0 : -b + v > m ? u = S : (u = -b + v, S = m)); var I = $s(u) < Hi ? 0 : u / S, E = $s(h) < Hi ? 0 : h / T, A = n; A.set(g), A.add(qs(r, p, I)), A.subtract(qs(s, _, E)); var C = a.radius + o.radius; return A.lengthSqr() < C * C } }(), Wa = { raySphere: ia, rayAABB: na, rayOBB: sa, rayPlane: ta, rayTriangle: ea, rayCapsule: aa, raySubMesh: null, rayMesh: null, rayModel: null, lineSphere: fa, lineAABB: ca, lineOBB: la, linePlane: oa, lineTriangle: ua, sphereWithSphere: za, sphereAABB: Ua, sphereOBB: Va, spherePlane: Fa, sphereFrustum: ka, sphereFrustumAccurate: Na, sphereCapsule: Ga, aabbWithAABB: ma, aabbWithOBB: Ea, aabbPlane: Aa, aabbFrustum: Ca, aabbFrustumAccurate: Da, obbWithOBB: Oa, obbPlane: Pa, obbFrustum: Ba, obbFrustumAccurate: Ma, obbPoint: Ra, obbCapsule: La, aabbFrustumCompletelyInside: function (t, e) { for (var i = e.planes, n = 0; n < i.length; n++)if (0 !== Aa(t, i[n])) return 0; return 1 }, capsuleWithCapsule: Ha, resolve: function (t, e, i) { void 0 === i && (i = null); var n = t._type, r = e._type, s = this[n | r]; return n < r ? s(t, e, i) : s(e, t, i) } }; Wa[5] = ia, Wa[9] = na, Wa[17] = sa, Wa[33] = ta, Wa[65] = ea, Wa[513] = aa, Wa[6] = fa, Wa[10] = ca, Wa[18] = la, Wa[34] = oa, Wa[66] = ua, Wa[4] = za, Wa[12] = Ua, Wa[20] = Va, Wa[36] = Fa, Wa[132] = ka, Wa[260] = Na, Wa[516] = Ga, Wa[8] = ma, Wa[24] = Ea, Wa[40] = Aa, Wa[136] = Ca, Wa[264] = Da, Wa[16] = Oa, Wa[48] = Pa, Wa[144] = Ba, Wa[272] = Ma, Wa[528] = La, Wa[512] = Ha, lt(Ds.prototype, "line", [{ name: "mag", newName: "len" }, { name: "magnitude", newName: "len" }]), ft(Wa, "intersect", [{ name: "line_quad" }]); var ja = new Kn(0, 0, 0), Xa = new Kn(0, 0, 0), qa = jr(), Ya = Bn(), Ka = function () { function t(t, e, i, n) { void 0 === t && (t = 0), void 0 === e && (e = 1), void 0 === i && (i = 0), void 0 === n && (n = 0), this._type = 32, this.n = new Kn(t, e, i), this.d = n } return t.create = function (e, i, n, r) { return new t(e, i, n, r) }, t.clone = function (e) { return new t(e.n.x, e.n.y, e.n.z, e.d) }, t.copy = function (t, e) { return Kn.copy(t.n, e.n), t.d = e.d, t }, t.fromPoints = function (t, e, i, n) { return Kn.subtract(ja, i, e), Kn.subtract(Xa, n, e), Kn.normalize(t.n, Kn.cross(t.n, ja, Xa)), t.d = Kn.dot(t.n, e), t }, t.set = function (t, e, i, n, r) { return t.n.x = e, t.n.y = i, t.n.z = n, t.d = r, t }, t.fromNormalAndPoint = function (t, e, i) { return Kn.copy(t.n, e), t.d = Kn.dot(e, i), t }, t.normalize = function (t, e) { var i = e.n.length(); return Kn.normalize(t.n, e.n), i > 0 && (t.d = e.d / i), t }, t.prototype.transform = function (t) { Gr.invert(qa, t), Gr.transpose(qa, qa), Pn.set(Ya, this.n.x, this.n.y, this.n.z, -this.d), Pn.transformMat4(Ya, Ya, qa), Kn.set(this.n, Ya.x, Ya.y, Ya.z), this.d = -Ya.w }, n(t, [{ key: "type", get: function () { return this._type } }, { key: "x", get: function () { return this.n.x }, set: function (t) { this.n.x = t } }, { key: "y", get: function () { return this.n.y }, set: function (t) { this.n.y = t } }, { key: "z", get: function () { return this.n.z }, set: function (t) { this.n.z = t } }, { key: "w", get: function () { return this.d }, set: function (t) { this.d = t } }]), t }(), Qa = function () { function t(t, e, i, n, r, s, a, o, u) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 1), void 0 === r && (r = 0), void 0 === s && (s = 0), void 0 === a && (a = 0), void 0 === o && (o = 1), void 0 === u && (u = 0), this._type = 64, this.a = new Kn(t, e, i), this.b = new Kn(n, r, s), this.c = new Kn(a, o, u) } return t.create = function (e, i, n, r, s, a, o, u, h) { return void 0 === e && (e = 1), void 0 === i && (i = 0), void 0 === n && (n = 0), void 0 === r && (r = 0), void 0 === s && (s = 0), void 0 === a && (a = 0), void 0 === o && (o = 0), void 0 === u && (u = 0), void 0 === h && (h = 1), new t(e, i, n, r, s, a, o, u, h) }, t.clone = function (e) { return new t(e.a.x, e.a.y, e.a.z, e.b.x, e.b.y, e.b.z, e.c.x, e.c.y, e.c.z) }, t.copy = function (t, e) { return Kn.copy(t.a, e.a), Kn.copy(t.b, e.b), Kn.copy(t.c, e.c), t }, t.fromPoints = function (t, e, i, n) { return Kn.copy(t.a, e), Kn.copy(t.b, i), Kn.copy(t.c, n), t }, t.set = function (t, e, i, n, r, s, a, o, u, h) { return t.a.x = e, t.a.y = i, t.a.z = n, t.b.x = r, t.b.y = s, t.b.z = a, t.c.x = o, t.c.y = u, t.c.z = h, t }, n(t, [{ key: "type", get: function () { return this._type } }]), t }(); St({ replaceProperty: { since: "3.6.0", removed: !1 }, removeProperty: { since: "3.6.0", removed: !1 }, markAsWarning: { since: "3.6.0", removed: !1 }, setDefaultLogTimes: { since: "3.6.0", removed: !1 } }); var Za = function () { function t() { this._poolHandle = -1, $a.addContainer(this) } return t.prototype.destroy = function () { $a.removeContainer(this) }, t }(), Ja = function () { function t() { this._pools = [], this._lastShrinkPassed = 0, this.shrinkTimeSpan = 5 } var e = t.prototype; return e.addContainer = function (t) { -1 === t._poolHandle && (t._poolHandle = this._pools.length, this._pools.push(t)) }, e.removeContainer = function (t) { -1 !== t._poolHandle && (this._pools[this._pools.length - 1]._poolHandle = t._poolHandle, ge(this._pools, t._poolHandle), t._poolHandle = -1) }, e.tryShrink = function () { for (var t = 0; t < this._pools.length; t++)this._pools[t].tryShrink() }, e.update = function (t) { this._lastShrinkPassed += t, this._lastShrinkPassed > this.shrinkTimeSpan && (this.tryShrink(), this._lastShrinkPassed -= this.shrinkTimeSpan) }, t }(), $a = new Ja, to = t("Pool", function (t) { function e(e, i, n, r) { var s; (s = t.call(this) || this)._freePool = [], s._ctor = e, s._dtor = n || null, s._elementsPerBatch = Math.max(i, 1), s._shrinkThreshold = r ? A(r, 1) : s._elementsPerBatch, s._nextAvail = s._elementsPerBatch - 1; for (var a = 0; a < s._elementsPerBatch; ++a)s._freePool.push(e()); return s } s(e, t); var i = e.prototype; return i.alloc = function () { if (this._nextAvail < 0) { this._freePool.length = this._elementsPerBatch; for (var t = 0; t < this._elementsPerBatch; t++)this._freePool[t] = this._ctor(); this._nextAvail = this._elementsPerBatch - 1 } return this._freePool[this._nextAvail--] }, i.free = function (t) { this._freePool[++this._nextAvail] = t }, i.freeArray = function (t) { this._freePool.length = this._nextAvail + 1, Array.prototype.push.apply(this._freePool, t), this._nextAvail += t.length }, i.tryShrink = function () { var t = this._nextAvail + 1; if (!(t <= this._shrinkThreshold)) { var e; if (e = t >> 1 >= this._shrinkThreshold ? t >> 1 : Math.floor((t - this._shrinkThreshold + 1) / 2), this._dtor) for (var i = this._nextAvail - e + 1; i <= this._nextAvail; ++i)this._dtor(this._freePool[i]); this._nextAvail -= e, this._freePool.length = this._nextAvail + 1 } }, i.destroy = function () { var e = arguments.length > 0 ? arguments[0] : null; e && it(14100); var i = e || this._dtor; if (i) for (var n = 0; n <= this._nextAvail; n++)i(this._freePool[n]); this._freePool.length = 0, this._nextAvail = -1, t.prototype.destroy.call(this) }, e }(Za)), eo = t("RecyclePool", function (t) { function e(e, i, n) { var r; (r = t.call(this) || this)._count = 0, r._fn = e, r._dtor = n || null, r._data = new Array(i), r._initSize = i; for (var s = 0; s < i; ++s)r._data[s] = e(); return r } s(e, t); var i = e.prototype; return i.reset = function () { this._count = 0 }, i.resize = function (t) { if (t > this._data.length) for (var e = this._data.length; e < t; ++e)this._data[e] = this._fn() }, i.add = function () { return this._count >= this._data.length && this.resize(this._data.length << 1), this._data[this._count++] }, i.destroy = function () { if (this._dtor) for (var e = 0; e < this._data.length; e++)this._dtor(this._data[e]); this._data.length = 0, this._count = 0, t.prototype.destroy.call(this) }, i.tryShrink = function () { if (this._data.length >> 2 > this._count) { var t = Math.max(this._initSize, this._data.length >> 1); if (this._dtor) for (var e = t; e < this._data.length; e++)this._dtor(this._data[e]); this._data.length = t } }, i.removeAt = function (t) { if (!(t >= this._count)) { var e = this._count - 1, i = this._data[t]; this._data[t] = this._data[e], this._data[e] = i, this._count -= 1 } }, n(e, [{ key: "length", get: function () { return this._count } }, { key: "data", get: function () { return this._data } }]), e }(Za)), io = t("CachedArray", function (t) { function e(e, i) { var n; return (n = t.call(this) || this).length = 0, n._initSize = 0, n.array = new Array(e), n._initSize = e, n._compareFn = i, n } s(e, t); var i = e.prototype; return i.push = function (t) { this.array[this.length++] = t }, i.pop = function () { return this.array[--this.length] }, i.get = function (t) { return this.array[t] }, i.clear = function () { this.length = 0 }, i.destroy = function () { this.length = 0, this.array.length = 0, t.prototype.destroy.call(this) }, i.tryShrink = function () { this.array.length >> 2 > this.length && (this.array.length = Math.max(this._initSize, this.array.length >> 1)) }, i.sort = function () { this.array.length = this.length, this.array.sort(this._compareFn) }, i.concat = function (t) { for (var e = 0; e < t.length; ++e)this.array[this.length++] = t[e] }, i.fastRemove = function (t) { if (!(t >= this.length || t < 0)) { var e = --this.length; this.array[t] = this.array[e] } }, i.indexOf = function (t) { for (var e = 0, i = this.length; e < i; ++e)if (this.array[e] === t) return e; return -1 }, e }(Za)); t("memop", Object.freeze({ __proto__: null, CachedArray: io, Pool: to, RecyclePool: eo })); var no = t("editorExtrasTag", "__editorExtras__"), ro = t("CCObjectFlags", { Destroyed: 1, RealDestroyed: 2, ToDestroy: 4, DontSave: 8, EditorOnly: 16, Dirty: 32, DontDestroy: 64, Destroying: 128, Deactivating: 256, LockedInEditor: 512, HideInHierarchy: 1024, IsOnEnableCalled: 2048, IsEditorOnEnableCalled: 4096, IsPreloadStarted: 8192, IsOnLoadCalled: 16384, IsOnLoadStarted: 32768, IsStartCalled: 65536, IsRotationLocked: 131072, IsScaleLocked: 262144, IsAnchorLocked: 524288, IsSizeLocked: 1048576, IsPositionLocked: 2097152, PersistentMask: -4192741, AllHideMasks: 1560 }), so = []; function ao(t, e) { var i, n = t instanceof T.Node || t instanceof T.Component, r = n ? "_id" : null, s = {}; for (i in t) if (t.hasOwnProperty(i)) { if (i === r) continue; switch (typeof t[i]) { case "string": s[i] = ""; break; case "object": case "function": s[i] = null } } if (Pi._isCCClass(e)) for (var a = T.Class.Attr.getClassAttrs(e), o = e.__props__, u = 0; u < o.length; u++) { var h = "" + (i = o[u]); if (h in a) { if (n && "_id" === i) continue; switch (typeof a[h]) { case "string": s[i] = ""; break; case "object": case "function": s[i] = null; break; case "undefined": s[i] = void 0 } } } var c = ""; for (i in s) { var l; l = Pi.IDENTIFIER_RE.test(i) ? "o." + i + "=" : "o[" + Pi.escapeForJS(i) + "]="; var f = s[i]; "" === f && (f = '""'), c += l + f + ";\n" } return Function("o", c) } var oo = t("CCObject", function () { function t(t) { void 0 === t && (t = ""), this._objFlags = 0, this._name = t } t._deferredDestroy = function () { for (var t = so.length, e = 0; e < t; ++e) { var i = so[e]; 1 & i._objFlags || i._destroyImmediate() } t === so.length ? so.length = 0 : so.splice(0, t) }; var e = t.prototype; return e.destroy = function () { return 1 & this._objFlags ? (it(5e3), !1) : !(4 & this._objFlags || (this._objFlags |= 4, so.push(this), 0)) }, e._destruct = function () { var t, e = this.constructor; Object.prototype.hasOwnProperty.call(e, "__destruct__") ? t = e.__destruct__ : (t = ao(this, e), Ot(e, "__destruct__", t, !0)), t(this) }, e._destroyImmediate = function () { var t; 1 & this._objFlags ? rt(5e3) : (null == (t = this._onPreDestroy) || t.call(this), this._destruct(), this._objFlags |= 1) }, n(t, [{ key: "name", get: function () { return this._name }, set: function (t) { this._name = t } }, { key: "hideFlags", get: function () { return 1560 & this._objFlags }, set: function (t) { var e = 1560 & t; this._objFlags = -1561 & this._objFlags | e } }, { key: "isValid", get: function () { return !(1 & this._objFlags) } }]), t }()); oo.prototype._deserialize = null, Pi.fastDefine("cc.Object", oo, { _name: "", _objFlags: 0 }); var uo = {}; for (var ho in ro) "string" == typeof ho && "number" == typeof ro[ho] && (uo[ho] = ro[ho]); function co(t) { return t instanceof oo } function lo(t, e) { return "object" == typeof t ? !(!t || t._objFlags & (e ? 5 : 1)) : void 0 !== t } Ot(oo, "Flags", uo), T.isValid = lo, T.Object = oo; var fo = ge; function po() { } var _o = function () { function t() { this.callback = po, this.target = void 0, this.once = !1 } var e = t.prototype; return e.set = function (t, e, i) { this.callback = t || po, this.target = e, this.once = !!i }, e.reset = function () { this.target = void 0, this.callback = po, this.once = !1 }, e.check = function () { return !(co(this.target) && !lo(this.target, !0)) }, t }(), go = new to((function () { return new _o }), 32), mo = function () { function t() { this.callbackInfos = [], this.isInvoking = !1, this.containCanceled = !1 } var e = t.prototype; return e.removeByCallback = function (t) { for (var e = 0; e < this.callbackInfos.length; ++e) { var i = this.callbackInfos[e]; i && i.callback === t && (i.reset(), go.free(i), fo(this.callbackInfos, e), --e) } }, e.removeByTarget = function (t) { for (var e = 0; e < this.callbackInfos.length; ++e) { var i = this.callbackInfos[e]; i && i.target === t && (i.reset(), go.free(i), fo(this.callbackInfos, e), --e) } }, e.cancel = function (t) { var e = this.callbackInfos[t]; e && (e.reset(), this.isInvoking ? this.callbackInfos[t] = null : fo(this.callbackInfos, t), go.free(e)), this.containCanceled = !0 }, e.cancelAll = function () { for (var t = 0; t < this.callbackInfos.length; t++) { var e = this.callbackInfos[t]; e && (e.reset(), go.free(e), this.callbackInfos[t] = null) } this.containCanceled = !0 }, e.purgeCanceled = function () { for (var t = this.callbackInfos.length - 1; t >= 0; --t)this.callbackInfos[t] || fo(this.callbackInfos, t); this.containCanceled = !1 }, e.clear = function () { this.cancelAll(), this.callbackInfos.length = 0, this.isInvoking = !1, this.containCanceled = !1 }, t }(), vo = new to((function () { return new mo }), 16), yo = t("CallbacksInvoker", function () { function t() { this._callbackTable = Nt(!0), this._offCallback = void 0 } var e = t.prototype; return e.on = function (t, e, i, n) { if (!this.hasEventListener(t, e, i)) { var r = this._callbackTable[t]; r || (r = this._callbackTable[t] = vo.alloc()); var s = go.alloc(); s.set(e, i, n), r.callbackInfos.push(s) } return e }, e.hasEventListener = function (t, e, i) { var n = this._callbackTable && this._callbackTable[t]; if (!n) return !1; var r = n.callbackInfos; if (!e) { if (n.isInvoking) { for (var s = 0; s < r.length; ++s)if (r[s]) return !0; return !1 } return r.length > 0 } for (var a = 0; a < r.length; ++a) { var o = r[a]; if (o && o.check() && o.callback === e && o.target === i) return !0 } return !1 }, e.removeAll = function (t) { var e = typeof t; if ("string" === e || "number" === e) { var i = this._callbackTable && this._callbackTable[t]; i && (i.isInvoking ? i.cancelAll() : (i.clear(), vo.free(i), delete this._callbackTable[t])) } else if (t) for (var n in this._callbackTable) { var r = this._callbackTable[n]; if (r.isInvoking) for (var s = r.callbackInfos, a = 0; a < s.length; ++a) { var o = s[a]; o && o.target === t && r.cancel(a) } else r.removeByTarget(t) } }, e.off = function (t, e, i) { var n, r = this._callbackTable && this._callbackTable[t]; if (r) { var s = r.callbackInfos; if (e) for (var a = 0; a < s.length; ++a) { var o = s[a]; if (o && o.callback === e && o.target === i) { r.cancel(a); break } } else this.removeAll(t) } null == (n = this._offCallback) || n.call(this) }, e.emit = function (t, e, i, n, r, s) { var a = this._callbackTable && this._callbackTable[t]; if (a) { var o = !a.isInvoking; a.isInvoking = !0; for (var u = a.callbackInfos, h = 0, c = u.length; h < c; ++h) { var l = u[h]; if (l) { var f = l.callback, d = l.target; l.once && this.off(t, f, d), l.check() ? d ? f.call(d, e, i, n, r, s) : f(e, i, n, r, s) : this.off(t, f, d) } } o && (a.isInvoking = !1, a.containCanceled && a.purgeCanceled()) } }, e.clear = function () { for (var t in this._callbackTable) { var e = this._callbackTable[t]; e && (e.clear(), vo.free(e), delete this._callbackTable[t]) } }, e._registerOffCallback = function (t) { this._offCallback = t }, t }()); function bo(t) { for (var e = function (t) { function e() { for (var e, i = arguments.length, n = new Array(i), r = 0; r < i; r++)n[r] = arguments[r]; return (e = t.call.apply(t, [this].concat(n)) || this)._callbackTable = Nt(!0), e } s(e, t); var i = e.prototype; return i.once = function (t, e, i) { return this.on(t, e, i, !0) }, i.targetOff = function (t) { this.removeAll(t) }, e }(t), i = yo.prototype, n = Object.getOwnPropertyNames(i).concat(Object.getOwnPropertySymbols(i)), r = 0; r < n.length; ++r) { var a = n[r]; if (!(a in e.prototype)) { var o = Object.getOwnPropertyDescriptor(i, a); o && Object.defineProperty(e.prototype, a, o) } } return e } var wo = t("EventTarget", bo((function () { }))); T.EventTarget = wo; var xo, So, To, Io, Eo, Ao, Co = t("AsyncDelegate", function () { function t() { this._delegates = [] } var e = t.prototype; return e.add = function (t) { this._delegates.includes(t) || this._delegates.push(t) }, e.hasListener = function (t) { return this._delegates.includes(t) }, e.remove = function (t) { ve(this._delegates, t) }, e.dispatch = function () { for (var t = arguments, e = arguments.length, i = new Array(e), n = 0; n < e; n++)i[n] = arguments[n]; return Promise.all(this._delegates.map((function (e) { return e.apply(void 0, t) })).filter(Boolean)) }, t }()); !function (t) { t.UNKNOWN = "unknown", t.WECHAT = "wechat", t.ANDROID = "androidbrowser", t.IE = "ie", t.EDGE = "edge", t.QQ = "qqbrowser", t.MOBILE_QQ = "mqqbrowser", t.UC = "ucbrowser", t.UCBS = "ucbs", t.BROWSER_360 = "360browser", t.BAIDU_APP = "baiduboxapp", t.BAIDU = "baidubrowser", t.MAXTHON = "maxthon", t.OPERA = "opera", t.OUPENG = "oupeng", t.MIUI = "miuibrowser", t.FIREFOX = "firefox", t.SAFARI = "safari", t.CHROME = "chrome", t.LIEBAO = "liebao", t.QZONE = "qzone", t.SOUGOU = "sogou", t.HUAWEI = "huawei" }(xo || (xo = {})), function (t) { t.UNKNOWN = "unknown", t.ENGLISH = "en", t.CHINESE = "zh", t.FRENCH = "fr", t.ITALIAN = "it", t.GERMAN = "de", t.SPANISH = "es", t.DUTCH = "du", t.RUSSIAN = "ru", t.KOREAN = "ko", t.JAPANESE = "ja", t.HUNGARIAN = "hu", t.PORTUGUESE = "pt", t.ARABIC = "ar", t.NORWEGIAN = "no", t.POLISH = "pl", t.TURKISH = "tr", t.UKRAINIAN = "uk", t.ROMANIAN = "ro", t.BULGARIAN = "bg", t.HINDI = "hi" }(So || (So = {})), function (t) { t[t.NONE = 0] = "NONE", t[t.LAN = 1] = "LAN", t[t.WWAN = 2] = "WWAN" }(To || (To = {})), function (t) { t.UNKNOWN = "Unknown", t.IOS = "iOS", t.ANDROID = "Android", t.WINDOWS = "Windows", t.LINUX = "Linux", t.OSX = "OS X", t.OHOS = "OHOS", t.OPENHARMONY = "OpenHarmony" }(Io || (Io = {})), function (t) { t.UNKNOWN = "UNKNOWN", t.EDITOR_PAGE = "EDITOR_PAGE", t.EDITOR_CORE = "EDITOR_CORE", t.MOBILE_BROWSER = "MOBILE_BROWSER", t.DESKTOP_BROWSER = "DESKTOP_BROWSER", t.WIN32 = "WIN32", t.ANDROID = "ANDROID", t.IOS = "IOS", t.MACOS = "MACOS", t.OHOS = "OHOS", t.OPENHARMONY = "OPENHARMONY", t.WECHAT_GAME = "WECHAT_GAME", t.WECHAT_MINI_PROGRAM = "WECHAT_MINI_PROGRAM", t.XIAOMI_QUICK_GAME = "XIAOMI_QUICK_GAME", t.ALIPAY_MINI_GAME = "ALIPAY_MINI_GAME", t.TAOBAO_CREATIVE_APP = "TAOBAO_CREATIVE_APP", t.TAOBAO_MINI_GAME = "TAOBAO_MINI_GAME", t.BYTEDANCE_MINI_GAME = "BYTEDANCE_MINI_GAME", t.OPPO_MINI_GAME = "OPPO_MINI_GAME", t.VIVO_MINI_GAME = "VIVO_MINI_GAME", t.HUAWEI_QUICK_GAME = "HUAWEI_QUICK_GAME", t.MIGU_MINI_GAME = "MIGU_MINI_GAME", t.HONOR_MINI_GAME = "HONOR_MINI_GAME" }(Eo || (Eo = {})), function (t) { t.WEBP = "WEBP", t.IMAGE_BITMAP = "IMAGE_BITMAP", t.WEB_VIEW = "WEB_VIEW", t.VIDEO_PLAYER = "VIDEO_PLAYER", t.SAFE_AREA = "SAFE_AREA", t.HPE = "HPE", t.INPUT_TOUCH = "INPUT_TOUCH", t.EVENT_KEYBOARD = "EVENT_KEYBOARD", t.EVENT_MOUSE = "EVENT_MOUSE", t.EVENT_TOUCH = "EVENT_TOUCH", t.EVENT_ACCELEROMETER = "EVENT_ACCELEROMETER", t.EVENT_GAMEPAD = "EVENT_GAMEPAD", t.EVENT_HANDLE = "EVENT_HANDLE", t.EVENT_HMD = "EVENT_HMD", t.EVENT_HANDHELD = "EVENT_HANDHELD", t.WASM = "WASM" }(Ao || (Ao = {})); var Do = function (t) { function e() { var e, i; (i = t.call(this) || this)._battery = null, i._initPromise = []; var n, r = window.navigator, s = r.userAgent.toLowerCase(); null == r.getBattery || r.getBattery().then((function (t) { i._battery = t })), i.networkType = To.LAN, i.isNative = !1, i.isBrowser = !0, i.isMobile = /mobile|android|iphone|ipad/.test(s), i.platform = i.isMobile ? Eo.MOBILE_BROWSER : Eo.DESKTOP_BROWSER, i.isLittleEndian = (n = new ArrayBuffer(2), new DataView(n).setInt16(0, 256, !0), 256 === new Int16Array(n)[0]); var a = r.language; i.nativeLanguage = a.toLowerCase(), a = (a = a || r.browserLanguage) ? a.split("-")[0] : So.ENGLISH, i.language = a; var o = !1, u = !1, h = "", c = 0, l = /android\s*(\d+(?:\.\d+)*)/i.exec(s) || /android\s*(\d+(?:\.\d+)*)/i.exec(r.platform); l && (o = !0, h = l[1] || "", c = parseInt(h) || 0), (l = /(iPad|iPhone|iPod).*OS ((\d+_?){2,3})/i.exec(s)) ? (u = !0, h = l[2] || "", c = parseInt(h) || 0) : (/(iPhone|iPad|iPod)/.exec(r.platform) || "MacIntel" === r.platform && r.maxTouchPoints && r.maxTouchPoints > 1) && (u = !0, h = "", c = 0); var f = Io.UNKNOWN; -1 !== r.appVersion.indexOf("Win") ? f = Io.WINDOWS : u ? f = Io.IOS : -1 !== r.appVersion.indexOf("Mac") ? f = Io.OSX : -1 !== r.appVersion.indexOf("X11") && -1 === r.appVersion.indexOf("Linux") ? f = Io.LINUX : o ? f = Io.ANDROID : -1 === r.appVersion.indexOf("Linux") && -1 === s.indexOf("ubuntu") || (f = Io.LINUX), i.os = f, i.osVersion = h, i.osMainVersion = c, i.browserType = xo.UNKNOWN; var d = /wechat|weixin|micromessenger/i.exec(s) || /mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|ucbs|360 aphone|360browser|baiduboxapp|baidubrowser|maxthon|mxbrowser|miuibrowser/i.exec(s) || /qq|qqbrowser|ucbrowser|ubrowser|edge|HuaweiBrowser/i.exec(s) || /chrome|safari|firefox|trident|opera|opr\/|oupeng/i.exec(s), p = d ? d[0].toLowerCase() : Io.UNKNOWN; ("safari" === p && o || "qq" === p && /android.*applewebkit/i.test(s)) && (p = xo.ANDROID); var _ = { micromessenger: xo.WECHAT, wechat: xo.WECHAT, weixin: xo.WECHAT, trident: xo.IE, edge: xo.EDGE, "360 aphone": xo.BROWSER_360, mxbrowser: xo.MAXTHON, "opr/": xo.OPERA, ubrowser: xo.UC, huaweibrowser: xo.HUAWEI }; i.browserType = _[p] || p, i.browserVersion = ""; var g = /(mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|uc|ucbs|360 aphone|360|baiduboxapp|baidu|maxthon|mxbrowser|miui(?:.hybrid)?)(mobile)?(browser)?\/?([\d.]+)/i.exec(s); g || (g = /(qq|chrome|safari|firefox|trident|opera|opr\/|oupeng)(mobile)?(browser)?\/?([\d.]+)/i.exec(s)), i.browserVersion = g ? g[4] : "", i.isXR = !1; var m, v = document.createElement("canvas"); v.getContext("2d"); try { m = v.toDataURL("image/webp").startsWith("data:image/webp") } catch (t) { m = !1 } if (i.os === Io.IOS) { var w, x = null == (w = / applewebkit\/(\d+)/.exec(s)) ? void 0 : w[1]; "string" == typeof x && Number.parseInt(x) >= 604 && (m = !0) } else if (i.browserType === xo.SAFARI) { var S, T = null == (S = / version\/(\d+)/.exec(s)) ? void 0 : S[1]; "string" == typeof T && Number.parseInt(T) >= 14 && (m = !0) } var I = void 0 !== document.documentElement.ontouchstart || void 0 !== document.ontouchstart || y, E = void 0 !== document.documentElement.onmouseup || y, A = void 0 !== navigator.xr, C = function () { if ((i.os === Io.IOS || i.os === Io.OSX) && /(OS 15_4)|(Version\/15.4)/.test(window.navigator.userAgent)) return !1; try { if ("object" == typeof WebAssembly && "function" == typeof WebAssembly.instantiate) { var t = new WebAssembly.Module(new Uint8Array([0, 97, 115, 109, 1, 0, 0, 0])); if (t instanceof WebAssembly.Module) return new WebAssembly.Instance(t) instanceof WebAssembly.Instance } } catch (t) { return !1 } return !1 }(); return i._featureMap = ((e = {})[Ao.WEBP] = m, e[Ao.IMAGE_BITMAP] = !1, e[Ao.WEB_VIEW] = !0, e[Ao.VIDEO_PLAYER] = !0, e[Ao.SAFE_AREA] = !1, e[Ao.HPE] = !1, e[Ao.INPUT_TOUCH] = I, e[Ao.EVENT_KEYBOARD] = void 0 !== document.documentElement.onkeyup || y, e[Ao.EVENT_MOUSE] = E, e[Ao.EVENT_TOUCH] = I || E, e[Ao.EVENT_ACCELEROMETER] = void 0 !== window.DeviceMotionEvent || void 0 !== window.DeviceOrientationEvent, e[Ao.EVENT_GAMEPAD] = void 0 !== navigator.getGamepads || void 0 !== navigator.webkitGetGamepads || A, e[Ao.EVENT_HANDLE] = b, e[Ao.EVENT_HMD] = A, e[Ao.EVENT_HANDHELD] = A, e[Ao.WASM] = C, e), i._initPromise.push(i._supportsImageBitmapPromise()), i._registerEvent(), i } s(e, t); var i = e.prototype; return i._supportsImageBitmapPromise = function () { var t = this; if ("undefined" != typeof createImageBitmap && "undefined" != typeof Blob) { var e = document.createElement("canvas"); e.width = e.height = 2; var i = createImageBitmap(e); if (i instanceof Promise) return i.then((function (e) { e && e.close && (t._setFeature(Ao.IMAGE_BITMAP, !0), e.close()) })) } return Promise.resolve() }, i._registerEvent = function () { var t, e = this; t = void 0 !== document.hidden ? "hidden" : void 0 !== document.mozHidden ? "mozHidden" : void 0 !== document.msHidden ? "msHidden" : void 0 !== document.webkitHidden ? "webkitHidden" : "hidden"; var i = !1, n = function () { i || (i = !0, e.emit("hide")) }, r = function (t, n, r, s, a) { i && (i = !1, e.emit("show", t, n, r, s, a)) }; if (t) for (var s = ["visibilitychange", "mozvisibilitychange", "msvisibilitychange", "webkitvisibilitychange", "qbrowserVisibilityChange"], a = 0; a < s.length; a++)document.addEventListener(s[a], (function (e) { var i = document[t]; (i = i || e.hidden) ? n() : r() })); else window.addEventListener("blur", n), window.addEventListener("focus", r); window.navigator.userAgent.indexOf("MicroMessenger") > -1 && (window.onfocus = r), "onpageshow" in window && "onpagehide" in window && (window.addEventListener("pagehide", n), window.addEventListener("pageshow", r), document.addEventListener("pagehide", n), document.addEventListener("pageshow", r)) }, i._setFeature = function (t, e) { return this._featureMap[t] = e }, i.init = function () { return Promise.all(this._initPromise) }, i.hasFeature = function (t) { return this._featureMap[t] }, i.getBatteryLevel = function () { return this._battery ? this._battery.level : 1 }, i.triggerGC = function () { }, i.openURL = function (t) { window.open(t) }, i.now = function () { return Date.now ? Date.now() : +new Date }, i.restartJSVM = function () { }, i.exit = function () { window.close() }, i.close = function () { this.emit("close") }, e }(wo), Ro = new Do, Po = /(\.[^./?\\]*)(\?.*)?$/, Bo = /((.*)(\/|\\|\\\\))?(.*?\..*$)?/, Mo = /[^./]+\/\.\.\//; function Oo() { for (var t = "", e = arguments.length, i = new Array(e), n = 0; n < e; n++)i[n] = arguments[n]; return i.forEach((function (e) { t = (t + ("" === t ? "" : "/") + e).replace(/(\/|\\\\)$/, "") })), t } function Lo(t) { var e = Po.exec(t); return e ? e[1] : "" } function Fo(t) { if (t) { var e = t.lastIndexOf("."); if (-1 !== e) return t.substring(0, e) } return t } function ko(t, e) { var i = t.indexOf("?"); i > 0 && (t = t.substring(0, i)); var n = /(\/|\\)([^/\\]+)$/g.exec(t.replace(/(\/|\\)$/, "")); if (!n) return t; var r = n[2]; return e && t.substring(t.length - e.length).toLowerCase() === e.toLowerCase() ? r.substring(0, r.length - e.length) : r } function No(t) { var e = Bo.exec(t); return e ? e[2] : "" } function zo(t, e) { e = e || ""; var i = t.indexOf("?"), n = ""; return i > 0 && (n = t.substring(i), t = t.substring(0, i)), (i = t.lastIndexOf(".")) < 0 ? t + e + n : t.substring(0, i) + e + n } function Uo(t, e, i) { if (0 === e.indexOf(".")) return zo(t, e); var n = t.indexOf("?"), r = "", s = i ? Lo(t) : ""; return n > 0 && (r = t.substring(n), t = t.substring(0, n)), n = (n = t.lastIndexOf("/")) <= 0 ? 0 : n + 1, t.substring(0, n) + e + s + r } function Vo(t) { var e = t = String(t); do { e = t, t = t.replace(Mo, "") } while (e.length !== t.length); return t } function Go(t) { return t.replace(/[/\\]$/, "") } function Ho() { return Ro.os === Io.WINDOWS ? "\\" : "/" } t("path", Object.freeze({ __proto__: null, _normalize: Vo, basename: ko, changeBasename: Uo, changeExtname: zo, dirname: No, extname: Lo, getSeperator: Ho, join: Oo, mainFileName: Fo, stripSep: Go })); var Wo = new Kn; function jo(t, e, i, n) { n || (n = new Kn), t.convertToUINode(e, i, n); var r = i.position; return n.add(r), n } function Xo(t, e, i) { return i || (i = new Kn), t.worldToScreen(e, i), i.x /= T.view.getScaleX(), i.y /= T.view.getScaleY(), i } var qo = t("convertUtils", { WorldNode3DToLocalNodeUI: jo, WorldNode3DToWorldNodeUI: Xo }); T.pipelineUtils = qo, lt(T.pipelineUtils, "cc.pipelineUtils", [{ name: "WorldNode3DToLocalNodeUI", newName: "convertToUINode", targetName: "cc.Camera.prototype", customFunction: function () { for (var t = arguments.length, e = new Array(t), i = 0; i < t; i++)e[i] = arguments[i]; var n = e[0], r = e[3] || Wo; return n.convertToUINode(e[1], e[2], r), r.add(e[2].position), e[3] || r.clone() } }]); var Yo, Ko = { auto: Me.AUTO, landscape: Me.LANDSCAPE, portrait: Me.PORTRAIT }; !function (t) { t[t.Unknown = 0] = "Unknown", t[t.SubFrame = 1] = "SubFrame", t[t.BrowserWindow = 2] = "BrowserWindow", t[t.Fullscreen = 3] = "Fullscreen" }(Yo || (Yo = {})); var Qo = function (t) { s(i, t); var e = i.prototype; function i() { var e, i, n, r, s, a; (e = t.call(this) || this).isFrameRotated = !1, e.handleResizeEvent = !0, e._gameFrame = void 0, e._gameContainer = void 0, e._gameCanvas = void 0, e._isProportionalToFrame = !1, e._cachedFrameStyle = { width: "0px", height: "0px" }, e._cachedContainerStyle = { width: "0px", height: "0px" }, e._cbToUpdateFrameBuffer = void 0, e._supportFullScreen = !1, e._touchEventName = void 0, e._onFullscreenChange = void 0, e._onFullscreenError = void 0, e._orientationChangeTimeoutId = -1, e._cachedFrameSize = new us(0, 0), e._exactFitScreen = !1, e._isHeadlessMode = !1, e._fn = {}, e._fnGroup = [["requestFullscreen", "exitFullscreen", "fullscreenchange", "fullscreenEnabled", "fullscreenElement", "fullscreenerror"], ["requestFullScreen", "exitFullScreen", "fullScreenchange", "fullScreenEnabled", "fullScreenElement", "fullscreenerror"], ["webkitRequestFullScreen", "webkitCancelFullScreen", "webkitfullscreenchange", "webkitIsFullScreen", "webkitCurrentFullScreenElement", "webkitfullscreenerror"], ["mozRequestFullScreen", "mozCancelFullScreen", "mozfullscreenchange", "mozFullScreen", "mozFullScreenElement", "mozfullscreenerror"], ["msRequestFullscreen", "msExitFullscreen", "MSFullscreenChange", "msFullscreenEnabled", "msFullscreenElement", "msfullscreenerror"]], e._resolutionScale = 1, e._orientation = Me.AUTO, e._orientationDevice = Me.AUTO, e._gameFrame = document.getElementById("GameDiv"), e._gameContainer = document.getElementById("Cocos3dGameContainer"), e._gameCanvas = document.getElementById("GameCanvas"), e._gameFrame || (e._gameFrame = document.createElement("div"), e._gameFrame.setAttribute("id", "GameDiv"), null == (i = e._gameCanvas) || null == (n = i.parentNode) || n.insertBefore(e._gameFrame, e._gameCanvas), e._gameFrame.appendChild(e._gameCanvas)), e._gameContainer || (e._gameContainer = document.createElement("div"), e._gameContainer.setAttribute("id", "Cocos3dGameContainer"), null == (r = e._gameCanvas) || null == (s = r.parentNode) || s.insertBefore(e._gameContainer, e._gameCanvas), e._gameContainer.appendChild(e._gameCanvas)); for (var o = e._fnGroup, u = 0; u < o.length; u++)if (a = o[u], void 0 !== document[a[1]]) { for (var h = 0; h < a.length; h++)e._fn[o[0][h]] = a[h]; break } return e._supportFullScreen = void 0 !== e._fn.requestFullscreen, e._touchEventName = "ontouchstart" in window ? "touchend" : "mousedown", e._registerEvent(), e } return e._updateFrame = function () { this._updateFrameState(), this._resizeFrame() }, e.init = function (t, e) { this._cbToUpdateFrameBuffer = e, this.orientation = Ko[t.configOrientation], this._exactFitScreen = t.exactFitScreen, this._isHeadlessMode = t.isHeadlessMode, this._resizeFrame() }, e.requestFullScreen = function () { var t = this; return new Promise((function (e, i) { t.isFullScreen ? e() : (t._cachedFrameSize = t.windowSize, t._doRequestFullScreen().then((function () { e() })).catch((function () { var n = t._getFullscreenTarget(); n ? n.addEventListener(t._touchEventName, (function () { t._doRequestFullScreen().then((function () { e() })).catch(i) }), { once: !0, capture: !0 }) : i(new Error("Cannot access fullscreen target")) }))) })) }, e.exitFullScreen = function () { var t = this; return new Promise((function (e, i) { var n = document[t._fn.exitFullscreen](); window.Promise && n instanceof Promise ? n.then((function () { t.windowSize = t._cachedFrameSize, e() })).catch(i) : (t.windowSize = t._cachedFrameSize, e()) })) }, e._registerEvent = function () { var t = this; document.addEventListener(this._fn.fullscreenerror, (function () { null == t._onFullscreenError || t._onFullscreenError() })), window.addEventListener("resize", (function () { t._updateFrame() })); var e, i = function (e) { e !== t._orientationDevice && (t._orientationDevice = e, t._updateFrame(), t.emit("orientation-change", e)) }, n = function () { var e = Me.PORTRAIT; switch (window.orientation) { case 0: e = Me.PORTRAIT; break; case 90: e = Me.LANDSCAPE_RIGHT; break; case -90: e = Me.LANDSCAPE_LEFT; break; case 180: e = Me.PORTRAIT_UPSIDE_DOWN; break; default: e = t._orientationDevice }return e }, r = function () { -1 !== t._orientationChangeTimeoutId && clearTimeout(t._orientationChangeTimeoutId), t._orientationChangeTimeoutId = setTimeout((function () { e() }), 200) }; if ("function" == typeof window.matchMedia) { !function e() { var i = window.devicePixelRatio, n = window.matchMedia("(resolution: " + i + "dppx)"); n.addEventListener ? n.addEventListener("change", (function () { t.emit("window-resize", t.windowSize.width, t.windowSize.height), e() }), { once: !0 }) : n.addListener && n.addListener((function () { t.emit("window-resize", t.windowSize.width, t.windowSize.height) })) }(); var s = window.matchMedia("(orientation: portrait)"), a = window.matchMedia("(orientation: landscape)"), o = screen.orientation; e = function () { var e = t._orientationDevice; s.matches ? (e = Me.PORTRAIT, o && (e = "portrait-primary" === screen.orientation.type ? Me.PORTRAIT : Me.PORTRAIT_UPSIDE_DOWN)) : a.matches && (e = Me.LANDSCAPE, o && (e = "landscape-primary" === screen.orientation.type ? Me.LANDSCAPE_LEFT : Me.LANDSCAPE_RIGHT)), i(e) }, s.addEventListener ? (s.addEventListener("change", r), a.addEventListener("change", r)) : s.addListener && (s.addListener(r), a.addListener(r)) } else e = function () { var t = n(); i(t) }, window.addEventListener("orientationchange", r); document.addEventListener(this._fn.fullscreenchange, (function () { null == t._onFullscreenChange || t._onFullscreenChange(), t.emit("fullscreen-change", t.windowSize.width, t.windowSize.height) })) }, e._convertToSizeInCssPixels = function (t) { var e = t.clone(), i = this.devicePixelRatio; return e.width /= i, e.height /= i, e }, e._resizeFrame = function (t) { if (this._gameFrame) { if (this._gameFrame.style.display = "flex", this._gameFrame.style["justify-content"] = "center", this._gameFrame.style["align-items"] = "center", this._windowType === Yo.SubFrame) { if (!t) return void this._updateContainer(); this._gameFrame.style.width = t.width + "px", this._gameFrame.style.height = t.height + "px" } else { var e = window.innerWidth, i = window.innerHeight, n = document.body.scrollHeight - i; Ro.os === Io.ANDROID && i < n && (i += n), this.isFrameRotated ? (this._gameFrame.style["-webkit-transform"] = "rotate(90deg)", this._gameFrame.style.transform = "rotate(90deg)", this._gameFrame.style["-webkit-transform-origin"] = "0px 0px 0px", this._gameFrame.style.transformOrigin = "0px 0px 0px", this._gameFrame.style.margin = "0 0 0 " + e + "px", this._gameFrame.style.width = i + "px", this._gameFrame.style.height = e + "px") : (this._gameFrame.style["-webkit-transform"] = "rotate(0deg)", this._gameFrame.style.transform = "rotate(0deg)", this._gameFrame.style.margin = "0px auto", this._gameFrame.style.width = e + "px", this._gameFrame.style.height = i + "px") } this._updateContainer() } }, e._getFullscreenTarget = function () { var t = this._windowType; return t === Yo.Fullscreen ? document[this._fn.fullscreenElement] : t === Yo.SubFrame ? this._gameFrame : document.body }, e._doRequestFullScreen = function () { var t = this; return new Promise((function (e, i) { if (t._supportFullScreen) { var n = t._getFullscreenTarget(); if (n) { t._onFullscreenChange = void 0, t._onFullscreenError = void 0; var r = n[t._fn.requestFullscreen](); window.Promise && r instanceof Promise ? r.then(e).catch(i) : (t._onFullscreenChange = e, t._onFullscreenError = i) } else i(new Error("Cannot access fullscreen target")) } else i(new Error("fullscreen is not supported")) })) }, e._updateFrameState = function () { var t = this.orientation, e = window.innerWidth > window.innerHeight; this.isFrameRotated = Ro.isMobile && (e && t === Me.PORTRAIT || !e && t === Me.LANDSCAPE) }, e._updateContainer = function () { if (this._gameContainer) { if (this.isProportionalToFrame) { if (!this._gameFrame) return void it(9201); var t, e, i = T.view.getDesignResolutionSize(), n = this._gameFrame, r = n.clientWidth, s = n.clientHeight, a = i.width, o = i.height, u = r / a, h = s / o, c = this._gameContainer.style; u < h ? (t = r, e = o * u) : (t = a * h, e = s), c.width = t + "px", c.height = e + "px" } else { var l = this._gameContainer.style; l.width = "100%", l.height = "100%" } !this._gameFrame || this._cachedFrameStyle.width === this._gameFrame.style.width && this._cachedFrameStyle.height === this._gameFrame.style.height && this._cachedContainerStyle.width === this._gameContainer.style.width && this._cachedContainerStyle.height === this._gameContainer.style.height || (this.emit("window-resize", this.windowSize.width, this.windowSize.height), this._cachedFrameStyle.width = this._gameFrame.style.width, this._cachedFrameStyle.height = this._gameFrame.style.height, this._cachedContainerStyle.width = this._gameContainer.style.width, this._cachedContainerStyle.height = this._gameContainer.style.height) } else it(9201) }, n(i, [{ key: "supportFullScreen", get: function () { return this._supportFullScreen } }, { key: "isFullScreen", get: function () { return !!this._supportFullScreen && !!document[this._fn.fullscreenElement] } }, { key: "devicePixelRatio", get: function () { var t; return Math.min(null !== (t = window.devicePixelRatio) && void 0 !== t ? t : 1, 2) } }, { key: "windowSize", get: function () { var t = this._windowSizeInCssPixels, e = this.devicePixelRatio; return t.width *= e, t.height *= e, t }, set: function (t) { this._windowType === Yo.SubFrame ? this._resizeFrame(this._convertToSizeInCssPixels(t)) : it(9202) } }, { key: "resolution", get: function () { var t = this.windowSize, e = this.resolutionScale; return new us(t.width * e, t.height * e) } }, { key: "resolutionScale", get: function () { return this._resolutionScale }, set: function (t) { var e; t !== this._resolutionScale && (this._resolutionScale = t, null == (e = this._cbToUpdateFrameBuffer) || e.call(this)) } }, { key: "orientation", get: function () { return this._orientation }, set: function (t) { this._orientation !== t && (this._orientation = t, this._updateFrame()) } }, { key: "safeAreaEdge", get: function () { var t = this.devicePixelRatio; return { top: parseInt(getComputedStyle(document.documentElement).getPropertyValue("--safe-top") || "0") * t, bottom: parseInt(getComputedStyle(document.documentElement).getPropertyValue("--safe-bottom") || "0") * t, left: parseInt(getComputedStyle(document.documentElement).getPropertyValue("--safe-left") || "0") * t, right: parseInt(getComputedStyle(document.documentElement).getPropertyValue("--safe-right") || "0") * t } } }, { key: "isProportionalToFrame", get: function () { return this._isProportionalToFrame }, set: function (t) { this._isProportionalToFrame !== t && (this._isProportionalToFrame = t, this._updateContainer()) } }, { key: "_windowSizeInCssPixels", get: function () { if (this.isProportionalToFrame) return this._gameContainer ? new us(this._gameContainer.clientWidth, this._gameContainer.clientHeight) : (it(9201), new us(0, 0)); var t, e, i; switch (this._windowType) { case Yo.SubFrame: return this._gameFrame ? new us(this._gameFrame.clientWidth, this._gameFrame.clientHeight) : (it(9201), new us(0, 0)); case Yo.Fullscreen: return t = this._getFullscreenTarget(), e = this.isFrameRotated ? t.clientHeight : t.clientWidth, i = this.isFrameRotated ? t.clientWidth : t.clientHeight, new us(e, i); case Yo.BrowserWindow: return e = this.isFrameRotated ? window.innerHeight : window.innerWidth, i = this.isFrameRotated ? window.innerWidth : window.innerHeight, new us(e, i); case Yo.Unknown: default: return new us(1, 1) } } }, { key: "_windowType", get: function () { return this._isHeadlessMode ? Yo.Unknown : this.isFullScreen ? Yo.Fullscreen : this._gameFrame ? this._exactFitScreen ? Yo.BrowserWindow : Yo.SubFrame : (it(9201), Yo.Unknown) } }]), i }(wo), Zo = new Qo, Jo = function () { function t() { } var e = t.prototype; return e.init = function () { var t, e, i = null === (t = Oe.querySettings("screen", "exactFitScreen")) || void 0 === t || t, n = null !== (e = Oe.querySettings("screen", "orientation")) && void 0 !== e ? e : "auto", r = 3 === Oe.querySettings("rendering", "renderMode"); Zo.init({ exactFitScreen: i, configOrientation: n, isHeadlessMode: r }, (function () { var t, e = T.director; null != (t = e.root) && t.pipeline ? e.root.pipeline.shadingScale = Zo.resolutionScale : it(1220) })) }, e.fullScreen = function () { return Zo.isFullScreen }, e.requestFullScreen = function (t, e, i) { return arguments.length > 0 && it(1400, "screen.requestFullScreen(element, onFullScreenChange?, onFullScreenError?)", "screen.requestFullScreen(): Promise"), Zo.requestFullScreen().then((function () { null == e || e.call(document) })).catch((function (t) { j(t), null == i || i.call(document) })) }, e.exitFullScreen = function () { return Zo.exitFullScreen() }, e.autoFullScreen = function (t, e) { var i; null == (i = this.requestFullScreen(t, e)) || i.catch((function (t) { W(t) })) }, e.disableAutoFullScreen = function () { }, e.on = function (t, e, i) { Zo.on(t, e, i) }, e.once = function (t, e, i) { Zo.once(t, e, i) }, e.off = function (t, e, i) { Zo.off(t, e, i) }, n(t, [{ key: "devicePixelRatio", get: function () { return Zo.devicePixelRatio } }, { key: "windowSize", get: function () { return Zo.windowSize }, set: function (t) { Zo.windowSize = t } }, { key: "resolution", get: function () { return Zo.resolution } }, { key: "supportsFullScreen", get: function () { return Zo.supportFullScreen } }]), t }(), $o = t("screen", new Jo); T.screen = $o; var tu = t("sys", { Feature: Ao, hasFeature: function (t) { return Ro.hasFeature(t) }, NetworkType: To, Language: So, OS: Io, Platform: Eo, BrowserType: xo, isNative: Ro.isNative, isBrowser: Ro.isBrowser, isMobile: Ro.isMobile, isLittleEndian: Ro.isLittleEndian, platform: Ro.platform, language: Ro.language, languageCode: Ro.nativeLanguage, os: Ro.os, osVersion: Ro.osVersion, osMainVersion: Ro.osMainVersion, browserType: Ro.browserType, browserVersion: Ro.browserVersion, isXR: Ro.isXR, windowPixelResolution: $o.windowSize, capabilities: { canvas: !0, opengl: !0, webp: Ro.hasFeature(Ao.WEBP), imageBitmap: Ro.hasFeature(Ao.IMAGE_BITMAP), touches: Ro.hasFeature(Ao.INPUT_TOUCH), mouse: Ro.hasFeature(Ao.EVENT_MOUSE), keyboard: Ro.hasFeature(Ao.EVENT_KEYBOARD), accelerometer: Ro.hasFeature(Ao.EVENT_ACCELEROMETER) }, localStorage: {}, getNetworkType: function () { return Ro.networkType }, getBatteryLevel: function () { return Ro.getBatteryLevel() }, garbageCollect: function () { Ro.triggerGC() }, isObjectValid: function (t) { return null != t }, __isWebIOS14OrIPadOS14Env: !1, dump: function () { var t = ""; t += "isMobile : " + this.isMobile + "\r\n", t += "language : " + this.language + "\r\n", t += "browserType : " + this.browserType + "\r\n", t += "browserVersion : " + this.browserVersion + "\r\n", t += "supports webp: " + tu.hasFeature(Ao.WEBP) + "\r\n", t += "supports bitmap: " + tu.hasFeature(Ao.IMAGE_BITMAP) + "\r\n", t += "supports touches: " + tu.hasFeature(Ao.INPUT_TOUCH) + "\r\n", t += "supports mouse: " + tu.hasFeature(Ao.EVENT_MOUSE) + "\r\n", t += "supports keyboard: " + tu.hasFeature(Ao.EVENT_KEYBOARD) + "\r\n", t += "supports accelerometer: " + tu.hasFeature(Ao.EVENT_ACCELEROMETER) + "\r\n", t += "os : " + this.os + "\r\n", t += "osVersion : " + this.osVersion + "\r\n", t += "platform : " + this.platform + "\r\n", H(t += "Using " + (T.game.renderType === T.game.RENDER_TYPE_WEBGL ? "WEBGL" : "CANVAS") + " renderer.\r\n") }, openURL: function (t) { Ro.openURL(t) }, init: function () { var t = this; return Promise.resolve().then((function () { return Ro.init() })).then((function () { try { var e = tu.localStorage = window.localStorage; e.setItem("storage", ""), e.removeItem("storage"), e = null } catch (e) { var i = function () { it(5200) }; t.localStorage = { getItem: i, setItem: i, clear: i, removeItem: i, key: i, length: 0 } } t.__isWebIOS14OrIPadOS14Env = (tu.os === Io.IOS || tu.os === Io.OSX) && Ro.isBrowser && /(OS 14)|(Version\/14)/.test(window.navigator.userAgent) })) }, now: function () { return Ro.now() }, restartVM: function () { Ro.restartJSVM() }, getSafeAreaRect: function (t) { void 0 === t && (t = !0); var e = T.view, i = Zo.safeAreaEdge; t && (Zo.orientation === Le.ORIENTATION_PORTRAIT ? i.top < i.bottom ? i.top = i.bottom : i.bottom = i.top : i.left < i.right ? i.left = i.right : i.right = i.left); var n = Zo.windowSize, r = new as(i.left, i.bottom), s = new as(n.width - i.right, n.height - i.top); e._convertToUISpace(r), e._convertToUISpace(s); var a = r.x, o = r.y, u = s.x - r.x, h = s.y - r.y; return new fs(a, o, u, h) } }); T.sys = tu, dt(T, "cc", [{ name: "winSize", suggest: "please use view.getVisibleSize() instead." }]), dt(tu, "sys", [{ name: "capabilities", suggest: "please use sys.hasFeature() method instead." }]), lt(tu, "sys", ["UNKNOWN", "ENGLISH", "CHINESE", "FRENCH", "ITALIAN", "GERMAN", "SPANISH", "DUTCH", "RUSSIAN", "KOREAN", "JAPANESE", "HUNGARIAN", "PORTUGUESE", "ARABIC", "NORWEGIAN", "POLISH", "TURKISH", "UKRAINIAN", "ROMANIAN", "BULGARIAN"].map((function (t) { return { name: "LANGUAGE_" + t, newName: t, target: tu.Language, targetName: "sys.Language" } }))), lt(tu, "sys", ["UNKNOWN", "IOS", "ANDROID", "WINDOWS", "LINUX", "OSX"].map((function (t) { return { name: "OS_" + t, newName: t, target: tu.OS, targetName: "sys.OS" } }))), lt(tu, "sys", ["UNKNOWN", "WECHAT", "ANDROID", "IE", "EDGE", "QQ", "MOBILE_QQ", "UC", "UCBS", "BAIDU_APP", "BAIDU", "MAXTHON", "OPERA", "OUPENG", "MIUI", "FIREFOX", "SAFARI", "CHROME", "LIEBAO", "QZONE", "SOUGOU", "HUAWEI"].map((function (t) { return { name: "BROWSER_TYPE_" + t, newName: t, target: tu.BrowserType, targetName: "sys.BrowserType" } }))), lt(tu, "sys", [{ name: "BROWSER_TYPE_360", newName: "BROWSER_360", target: tu.BrowserType, targetName: "sys.BrowserType" }]), lt(tu, "sys", ["UNKNOWN", "EDITOR_PAGE", "EDITOR_CORE", "MOBILE_BROWSER", "DESKTOP_BROWSER", "WIN32", "MACOS", "IOS", "ANDROID", "OHOS", "WECHAT_GAME", "XIAOMI_QUICK_GAME", "ALIPAY_MINI_GAME", "BYTEDANCE_MINI_GAME", "OPPO_MINI_GAME", "VIVO_MINI_GAME", "HUAWEI_QUICK_GAME"].map((function (t) { return { name: t, target: tu.Platform, targetName: "sys.Platform" } }))), lt(tu, "sys", [{ name: "IPHONE", newName: "IOS", target: tu.Platform, targetName: "sys.Platform" }, { name: "IPAD", newName: "IOS", target: tu.Platform, targetName: "sys.Platform" }]), ft(tu, "sys", ["LINUX", "BLACKBERRY", "NACL", "EMSCRIPTEN", "TIZEN", "WINRT", "WP8", "QQ_PLAY", "FB_PLAYABLE_ADS"].map((function (t) { return { name: t } }))), lt(tu, "sys", [{ name: "windowPixelResolution", target: $o, targetName: "screen", newName: "windowSize" }]), dt($o, "screen", [{ name: "autoFullScreen", suggest: "please use screen.requestFullScreen() instead." }, { name: "disableAutoFullScreen" }]); var eu = t("visibleRect", { topLeft: T.v2(0, 0), topRight: T.v2(0, 0), top: T.v2(0, 0), bottomLeft: T.v2(0, 0), bottomRight: T.v2(0, 0), bottom: T.v2(0, 0), center: T.v2(0, 0), left: T.v2(0, 0), right: T.v2(0, 0), width: 0, height: 0, init: function (t) { var e = this.width = t.width, i = this.height = t.height, n = t.x, r = t.y, s = r + i, a = n + e; this.topLeft.x = n, this.topLeft.y = s, this.topRight.x = a, this.topRight.y = s, this.top.x = n + e / 2, this.top.y = s, this.bottomLeft.x = n, this.bottomLeft.y = r, this.bottomRight.x = a, this.bottomRight.y = r, this.bottom.x = n + e / 2, this.bottom.y = r, this.center.x = n + e / 2, this.center.y = r + i / 2, this.left.x = n, this.left.y = r + i / 2, this.right.x = a, this.right.y = r + i / 2 } }); T.visibleRect = eu; var iu = new Kn, nu = new Kn, ru = new Kn, su = new Kn, au = new cr, ou = Math.abs, uu = function (t, e, i) { au.m00 = ou(i.m00), au.m01 = ou(i.m01), au.m02 = ou(i.m02), au.m03 = ou(i.m04), au.m04 = ou(i.m05), au.m05 = ou(i.m06), au.m06 = ou(i.m08), au.m07 = ou(i.m09), au.m08 = ou(i.m10), Kn.transformMat3(t, e, au) }, hu = function () { function t(t, e, i, n, r, s) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 1), void 0 === r && (r = 1), void 0 === s && (s = 1), this.center = void 0, this.halfExtents = void 0, this._type = void 0, this._type = 8, this.center = new Kn(t, e, i), this.halfExtents = new Kn(n, r, s) } t.create = function (e, i, n, r, s, a) { return new t(e, i, n, r, s, a) }, t.clone = function (e) { return new t(e.center.x, e.center.y, e.center.z, e.halfExtents.x, e.halfExtents.y, e.halfExtents.z) }, t.copy = function (t, e) { return Kn.copy(t.center, e.center), Kn.copy(t.halfExtents, e.halfExtents), t }, t.fromPoints = function (t, e, i) { return Kn.add(iu, i, e), Kn.subtract(nu, i, e), Kn.multiplyScalar(t.center, iu, .5), Kn.multiplyScalar(t.halfExtents, nu, .5), t }, t.set = function (t, e, i, n, r, s, a) { return t.center.set(e, i, n), t.halfExtents.set(r, s, a), t }, t.merge = function (e, i, n) { return Kn.subtract(iu, i.center, i.halfExtents), Kn.subtract(nu, n.center, n.halfExtents), Kn.add(ru, i.center, i.halfExtents), Kn.add(su, n.center, n.halfExtents), Kn.max(su, ru, su), Kn.min(ru, iu, nu), t.fromPoints(e, ru, su) }, t.toBoundingSphere = function (t, e) { return t.center.set(e.center), t.radius = e.halfExtents.length(), t }, t.transform = function (t, e, i) { return Kn.transformMat4(t.center, e.center, i), uu(t.halfExtents, e.halfExtents, i), t }; var e = t.prototype; return e.getBoundary = function (t, e) { Kn.subtract(t, this.center, this.halfExtents), Kn.add(e, this.center, this.halfExtents) }, e.transform = function (t, e, i, n, r) { Kn.transformMat4(r.center, this.center, t), uu(r.halfExtents, this.halfExtents, t) }, e.clone = function () { var e = this.center, i = this.halfExtents; return new t(e.x, e.y, e.z, i.x, i.y, i.z) }, e.copy = function (t) { return Kn.copy(this.center, t.center), Kn.copy(this.halfExtents, t.halfExtents), this }, e.mergePoint = function (t) { this.getBoundary(iu, nu), t.x < iu.x && (iu.x = t.x), t.y < iu.y && (iu.y = t.y), t.z < iu.z && (iu.z = t.z), t.x > nu.x && (nu.x = t.x), t.y > nu.y && (nu.y = t.y), t.z > nu.z && (nu.z = t.z), Kn.add(ru, iu, nu), this.center.set(Kn.multiplyScalar(ru, ru, .5)), this.halfExtents.set(nu.x - ru.x, nu.y - ru.y, nu.z - ru.z) }, e.mergePoints = function (t) { if (!(t.length < 1)) for (var e = 0; e < t.length; e++)this.mergePoint(t[e]) }, e.mergeFrustum = function (t) { this.mergePoints(t.vertices) }, n(t, [{ key: "type", get: function () { return this._type } }]), t }(), cu = function () { function t(t, e, i) { void 0 === t && (t = .5), void 0 === e && (e = .5), void 0 === i && (i = 1), this._type = void 0, this.radius = void 0, this.halfHeight = void 0, this.axis = void 0, this.center = void 0, this.rotation = void 0, this.ellipseCenter0 = void 0, this.ellipseCenter1 = void 0, this._type = 512, this.radius = t, this.halfHeight = e, this.axis = i, this.center = new Kn, this.rotation = new Er, this.ellipseCenter0 = new Kn(0, e, 0), this.ellipseCenter1 = new Kn(0, -e, 0), this.updateCache() } var e = t.prototype; return e.transform = function (t, e, i, n, r) { var s = n, a = hn(s); r.radius = this.radius * Math.abs(a); var o = (this.halfHeight + this.radius) * Math.abs(s.y) - r.radius; o < 0 && (o = 0), r.halfHeight = o, Kn.transformMat4(r.center, this.center, t), Er.multiply(r.rotation, this.rotation, i), r.updateCache() }, e.updateCache = function () { this.updateLocalCenter(), Kn.transformQuat(this.ellipseCenter0, this.ellipseCenter0, this.rotation), Kn.transformQuat(this.ellipseCenter1, this.ellipseCenter1, this.rotation), this.ellipseCenter0.add(this.center), this.ellipseCenter1.add(this.center) }, e.updateLocalCenter = function () { var t = this.halfHeight; switch (this.axis) { case 0: this.ellipseCenter0.set(t, 0, 0), this.ellipseCenter1.set(-t, 0, 0); break; case 1: this.ellipseCenter0.set(0, t, 0), this.ellipseCenter1.set(0, -t, 0); break; case 2: this.ellipseCenter0.set(0, 0, t), this.ellipseCenter1.set(0, 0, -t) } }, n(t, [{ key: "type", get: function () { return this._type } }]), t }(), lu = new Array(8); lu[0] = Qn(1, 1, 1), lu[1] = Qn(-1, 1, 1), lu[2] = Qn(-1, -1, 1), lu[3] = Qn(1, -1, 1), lu[4] = Qn(1, 1, -1), lu[5] = Qn(-1, 1, -1), lu[6] = Qn(-1, -1, -1), lu[7] = Qn(1, -1, -1); var fu, du = Qn(), pu = Qn(), _u = Qn(), gu = Ka.fromPoints, mu = Kn.set, vu = Kn.transformMat4, yu = function () { e.createOrthographic = function (t, e, i, n, r, s) { var a = e / 2, o = i / 2; mu(_u, a, o, -n), vu(t.vertices[0], _u, s), mu(_u, -a, o, -n), vu(t.vertices[1], _u, s), mu(_u, -a, -o, -n), vu(t.vertices[2], _u, s), mu(_u, a, -o, -n), vu(t.vertices[3], _u, s), mu(_u, a, o, -r), vu(t.vertices[4], _u, s), mu(_u, -a, o, -r), vu(t.vertices[5], _u, s), mu(_u, -a, -o, -r), vu(t.vertices[6], _u, s), mu(_u, a, -o, -r), vu(t.vertices[7], _u, s), t.updatePlanes() }, e.createOrtho = function (t, i, n, r, s, a) { return e.createOrthographic(t, i, n, r, s, a) }, e.createPerspective = function (t, e, i, n, r, s) { var a = Math.tan(.5 * i), o = a * e; du.set(n * o, n * a, n), pu.set(r * o, r * a, r); var u = t.vertices; _u.set(du.x, du.y, -du.z), vu(u[0], _u, s), _u.set(-du.x, du.y, -du.z), vu(u[1], _u, s), _u.set(-du.x, -du.y, -du.z), vu(u[2], _u, s), _u.set(du.x, -du.y, -du.z), vu(u[3], _u, s), _u.set(pu.x, pu.y, -pu.z), vu(u[4], _u, s), _u.set(-pu.x, pu.y, -pu.z), vu(u[5], _u, s), _u.set(-pu.x, -pu.y, -pu.z), vu(u[6], _u, s), _u.set(pu.x, -pu.y, -pu.z), vu(u[7], _u, s), t.updatePlanes() }, e.createFromAABB = function (t, e) { var i = new Kn, n = new Kn; Kn.subtract(i, e.center, e.halfExtents), Kn.add(n, e.center, e.halfExtents); var r = t.vertices; return r[0].set(n.x, n.y, -i.z), r[1].set(i.x, n.y, -i.z), r[2].set(i.x, i.y, -i.z), r[3].set(n.x, i.y, -i.z), r[4].set(n.x, n.y, -n.z), r[5].set(i.x, n.y, -n.z), r[6].set(i.x, i.y, -n.z), r[7].set(n.x, i.y, -n.z), t.updatePlanes(), t }; var t = e.prototype; function e() { this.planes = void 0, this.vertices = void 0, this._type = void 0, this._type = 128, this.planes = new Array(6); for (var t = 0; t < 6; ++t)this.planes[t] = Ka.create(0, 0, 0, 0); this.vertices = new Array(8); for (var e = 0; e < 8; ++e)this.vertices[e] = new Kn } return t.split = function (t, i, n, r, s) { return e.createPerspective(this, n, r, t, i, s) }, e.create = function () { return new e }, e.clone = function (t) { return e.copy(new e, t) }, e.copy = function (t, e) { t._type = e.type; for (var i = 0; i < 6; ++i)Ka.copy(t.planes[i], e.planes[i]); for (var n = 0; n < 8; ++n)Kn.copy(t.vertices[n], e.vertices[n]); return t }, t.update = function (t, e) { var i = this.planes; mu(i[0].n, t.m03 + t.m00, t.m07 + t.m04, t.m11 + t.m08), i[0].d = -(t.m15 + t.m12), mu(i[1].n, t.m03 - t.m00, t.m07 - t.m04, t.m11 - t.m08), i[1].d = -(t.m15 - t.m12), mu(i[2].n, t.m03 + t.m01, t.m07 + t.m05, t.m11 + t.m09), i[2].d = -(t.m15 + t.m13), mu(i[3].n, t.m03 - t.m01, t.m07 - t.m05, t.m11 - t.m09), i[3].d = -(t.m15 - t.m13), mu(i[4].n, t.m03 + t.m02, t.m07 + t.m06, t.m11 + t.m10), i[4].d = -(t.m15 + t.m14), mu(i[5].n, t.m03 - t.m02, t.m07 - t.m06, t.m11 - t.m10), i[5].d = -(t.m15 - t.m14); for (var n = 0; n < 6; n++) { var r = i[n], s = 1 / r.n.length(); Kn.multiplyScalar(r.n, r.n, s), r.d *= s } for (var a = 0; a < 8; a++)vu(this.vertices[a], lu[a], e) }, t.transform = function (t) { for (var e = 0; e < 8; e++)vu(this.vertices[e], this.vertices[e], t); this.updatePlanes() }, t.zero = function () { for (var t = 0; t < 8; t++)this.vertices[t].set(0, 0, 0); for (var e = 0; e < 6; e++)Ka.set(this.planes[e], 0, 0, 0, 0) }, t.updatePlanes = function () { var t = this.planes, e = this.vertices; gu(t[0], e[1], e[6], e[5]), gu(t[1], e[3], e[4], e[7]), gu(t[2], e[6], e[3], e[7]), gu(t[3], e[0], e[5], e[4]), gu(t[4], e[2], e[0], e[3]), gu(t[5], e[7], e[5], e[6]) }, n(e, [{ key: "accurate", set: function (t) { this._type = t ? 256 : 128 } }, { key: "type", get: function () { return this._type } }]), e }(), bu = new Kn, wu = new Kn, xu = new cr, Su = Math.abs, Tu = function (t, e, i) { xu.m00 = Su(i.m00), xu.m01 = Su(i.m01), xu.m02 = Su(i.m02), xu.m03 = Su(i.m03), xu.m04 = Su(i.m04), xu.m05 = Su(i.m05), xu.m06 = Su(i.m06), xu.m07 = Su(i.m07), xu.m08 = Su(i.m08), Kn.transformMat3(t, e, xu) }, Iu = function () { function t(t, e, i, n, r, s, a, o, u, h, c, l, f, d, p) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 1), void 0 === r && (r = 1), void 0 === s && (s = 1), void 0 === a && (a = 1), void 0 === o && (o = 0), void 0 === u && (u = 0), void 0 === h && (h = 0), void 0 === c && (c = 1), void 0 === l && (l = 0), void 0 === f && (f = 0), void 0 === d && (d = 0), void 0 === p && (p = 1), this.center = void 0, this.halfExtents = void 0, this.orientation = void 0, this._type = void 0, this._type = 16, this.center = new Kn(t, e, i), this.halfExtents = new Kn(n, r, s), this.orientation = new cr(a, o, u, h, c, l, f, d, p) } t.create = function (e, i, n, r, s, a, o, u, h, c, l, f, d, p, _) { return new t(e, i, n, r, s, a, o, u, h, c, l, f, d, p, _) }, t.clone = function (e) { return new t(e.center.x, e.center.y, e.center.z, e.halfExtents.x, e.halfExtents.y, e.halfExtents.z, e.orientation.m00, e.orientation.m01, e.orientation.m02, e.orientation.m03, e.orientation.m04, e.orientation.m05, e.orientation.m06, e.orientation.m07, e.orientation.m08) }, t.copy = function (t, e) { return Kn.copy(t.center, e.center), Kn.copy(t.halfExtents, e.halfExtents), cr.copy(t.orientation, e.orientation), t }, t.fromPoints = function (t, e, i) { return Kn.multiplyScalar(t.center, Kn.add(bu, e, i), .5), Kn.multiplyScalar(t.halfExtents, Kn.subtract(wu, i, e), .5), cr.identity(t.orientation), t }, t.set = function (t, e, i, n, r, s, a, o, u, h, c, l, f, d, p, _) { return Kn.set(t.center, e, i, n), Kn.set(t.halfExtents, r, s, a), cr.set(t.orientation, o, u, h, c, l, f, d, p, _), t }; var e = t.prototype; return e.getBoundary = function (t, e) { Tu(bu, this.halfExtents, this.orientation), Kn.subtract(t, this.center, bu), Kn.add(e, this.center, bu) }, e.transform = function (t, e, i, n, r) { Kn.transformMat4(r.center, this.center, t), cr.fromQuat(r.orientation, i), Kn.multiply(r.halfExtents, this.halfExtents, n) }, e.translateAndRotate = function (t, e, i) { Kn.transformMat4(i.center, this.center, t), cr.fromQuat(i.orientation, e) }, e.setScale = function (t, e) { Kn.multiply(e.halfExtents, this.halfExtents, t) }, n(t, [{ key: "type", get: function () { return this._type } }]), t }(); function Eu(t, e, i) { void 0 === i && (i = 1e-6); for (var n = 0, r = t.length - 1, s = r >>> 1; n <= r; s = n + r >>> 1) { var a = t[s]; if (a > e + i) r = s - 1; else { if (!(a < e - i)) return s; n = s + 1 } } return ~n } fu = Symbol.iterator; var Au = function () { function t() { this._times = [], this._values = [] } var e = t.prototype; return e[fu] = function () { var t = this, e = 0; return { next: function () { if (e >= t._times.length) return { done: !0, value: void 0 }; var i = [t._times[e], t._values[e]]; return ++e, { done: !1, value: i } } } }, e.keyframes = function () { return this }, e.times = function () { return this._times }, e.values = function () { return this._values }, e.getKeyframeTime = function (t) { return this._times[t] }, e.getKeyframeValue = function (t) { return this._values[t] }, e.addKeyFrame = function (t, e) { return this._insertNewKeyframe(t, e) }, e.removeKeyframe = function (t) { this._times.splice(t, 1), this._values.splice(t, 1) }, e.indexOfKeyframe = function (t) { return Eu(this._times, t) }, e.updateTime = function (t, e) { var i = this._values[t]; this.removeKeyframe(t), this._insertNewKeyframe(e, i) }, e.assignSorted = function (t, e) { if (void 0 !== e) this.setKeyframes(t.slice(), e.slice()); else { var i = Array.from(t); this.setKeyframes(i.map((function (t) { return t[0] })), i.map((function (t) { return t[1] }))) } }, e.clear = function () { this._times.length = 0, this._values.length = 0 }, e.searchKeyframe = function (t) { return Eu(this._times, t) }, e.setKeyframes = function (t, e) { t.length, e.length, Cu(t), this._times = t, this._values = e }, e._insertNewKeyframe = function (t, e) { var i = this._times, n = this._values, r = i.length, s = Eu(i, t); if (s >= 0) return s; var a = ~s; return 0 === a ? (i.unshift(t), n.unshift(e)) : a === r ? (i.push(t), n.push(e)) : (i.splice(a - 1, 0, t), n.splice(a - 1, 0, e)), a }, n(t, [{ key: "keyFramesCount", get: function () { return this._times.length } }, { key: "rangeMin", get: function () { return this._times[0] } }, { key: "rangeMax", get: function () { return this._times[this._values.length - 1] } }]), t }(); function Cu(t) { return t.every((function (t, e, i) { return 0 === e || t > i[e - 1] || ji(t, i[e - 1], 1e-6) })) } function Du(t, e, i, n, r) { var s = i / n, a = e / n, o = s * s, u = 1 / 3 * (-1 / 3 * o + a), h = .5 * (2 / 27 * s * o - 1 / 3 * s * a + t / n), c = u * u * u, l = h * h + c, f = 0; if (Pu(l)) { if (Pu(h)) return r[0] = 0, 1; var d = Math.cbrt(-h); return r[0] = 2 * d, r[1] = -d, 2 } if (l < 0) { var p = 1 / 3 * Math.acos(-h / Math.sqrt(-c)), _ = 2 * Math.sqrt(-u); r[0] = _ * Math.cos(p), r[1] = -_ * Math.cos(p + Math.PI / 3), r[2] = -_ * Math.cos(p - Math.PI / 3), f = 3 } else { var g = Math.sqrt(l), m = Math.cbrt(g - h), v = -Math.cbrt(g + h); r[0] = m + v, f = 1 } for (var y = 1 / 3 * s, b = 0; b < f; ++b)r[b] -= y; return f } Pi.fastDefine("cc.KeyframeCurve", Au, { _times: [], _values: [] }), t("RealInterpolationMode", { LINEAR: 0, CONSTANT: 1, CUBIC: 2 }), t("ExtrapolationMode", { LINEAR: 0, CLAMP: 1, LOOP: 2, PING_PONG: 3 }), t("TangentWeightMode", { NONE: 0, LEFT: 1, RIGHT: 2, BOTH: 3 }); var Ru = 1e-9; function Pu(t) { return t > -1e-9 && t < Ru } function Bu(t, e, i, n) { return i.slice().reverse().reduce((function (i, n) { return n(t, e, i) || i }), n) } var Mu = function () { }, Ou = function () { return Mu }, Lu = Fu((function () { })); function Fu(t) { return function (e) { return "function" == typeof e ? t(e) : function (i) { return t(i, e) } } } function ku(t, e, i) { var n = Uu(t); if (n) { var r = Vu(n, "proto"); Vu(r, "editor")[e] = i } } function Nu(t) { return function (e) { return function (i) { ku(i, t, e) } } } var zu = "__ccclassCache__"; function Uu(t) { return Vu(t, zu) } function Vu(t, e) { return t[e] || (t[e] = {}) } var Gu = Fu((function (t, e) { var i = Zt(t); i === Object && (i = null); var n = { name: e, extends: i, ctor: t }, r = t[zu]; if (r) { var s = r.proto; s && Kt(n, s), t[zu] = void 0 } return Pi(n) })), Hu = Nu("requireComponent"), Wu = Nu("executionOrder"), ju = Lu; function Xu(t, e, i) { var n = null; function r(t, e, i) { Ju(Ku(t), Qu(t, e), t.constructor, e, n, i) } return void 0 === t ? Xu({ type: void 0 }) : void 0 === e ? (n = t, r) : void r(t, e, i) } function qu(t) { var e; try { e = t() } catch (e) { return t } return "object" != typeof e || null === e ? e : t } function Yu(t) { var e; try { e = new t } catch (t) { return {} } return e } function Ku(t) { return Uu(t.constructor) } function Qu(t, e) { var i, n, r = Vu(Uu(t.constructor), "proto"), s = Vu(r, "properties"); return null !== (n = s[i = e]) && void 0 !== n ? n : s[i] = {} } function Zu(t, e, i) { var n, r, s = Uu(t.constructor), a = Vu(s, "proto"), o = Vu(a, "properties"), u = null !== (r = o[n = e]) && void 0 !== r ? r : o[n] = {}; return u.__internalFlags |= 1, i && "function" != typeof i && (i.get || i.set) ? (i.get && (u.get = i.get), i.set && (u.set = i.set)) : $u(s, u, t.constructor, e, i), u } function Ju(t, e, i, n, r, s) { var a, o = s && "function" != typeof s && (s.get || s.set); r && (a = pi(r, o)); var u = Kt(e, a || r || {}); o ? (s.get && (u.get = s.get), s.set && (u.set = s.set)) : $u(t, u, i, n, s) } function $u(t, e, i, n, r) { if (void 0 !== r) "function" == typeof r ? e.default = qu(r) : null === r || r.initializer && (e.default = qu(r.initializer)); else { var s = t.default || (t.default = Yu(i)); s.hasOwnProperty(n) && (e.default = s[n]) } } var th = Symbol("cc:SerializationMetadata"), eh = t("serializable", (function (t, e, i) { rh(Zu(t, e, i)) })); function ih(t) { return function (e, i, n) { var r = Zu(e, i, n); r.formerlySerializedAs = t, rh(r) } } var nh = function (t, e, i) { var n = Zu(t, e, i); n.editorOnly = !0, rh(n) }; function rh(t) { t.__internalFlags |= 4 } var sh = Mu, ah = Lu, oh = Ou, uh = Lu, hh = Ou, ch = Ou, lh = Ou, fh = t("editable", Mu), dh = t("visible", Ou), ph = t("displayName", Ou), _h = t("tooltip", Ou), gh = t("range", Ou), mh = t("rangeStep", Ou), vh = t("slide", Mu), yh = t("displayOrder", Ou), bh = t("disallowAnimation", Mu), wh = Ih(ri), xh = Ih(si), Sh = Ih(ai), Th = Ih(oi); function Ih(t) { return Xu({ type: t }) } var Eh, Ah, Ch, Dh, Rh, Ph, Bh, Mh, Oh = t("override", (function (t, e, i) { Zu(t, e, i).override = !0 })), Lh = t("EditorExtendable", (function () { })), Fh = Object.freeze({ __proto__: null, boolean: Sh, ccclass: Gu, disallowAnimation: bh, disallowMultiple: ju, displayName: ph, displayOrder: yh, editable: fh, executeInEditMode: ah, executionOrder: Wu, float: xh, formerlySerializedAs: ih, help: lh, icon: ch, inspector: hh, integer: wh, menu: oh, override: Oh, playOnFocus: uh, property: Xu, range: gh, rangeStep: mh, requireComponent: Hu, serializable: eh, slide: vh, string: Th, tooltip: _h, type: Ih, uniquelyReferenced: sh, visible: dh }); function kh(t, e) { return (e << 3) + t } function Nh(t) { return Uh[t] } function zh(t) { switch (t) { case 0: return Uint8Array; case 1: return Uint16Array; case 2: return Uint32Array; case 3: return Int8Array; case 4: return Int16Array; case 5: return Int32Array; case 6: return Float32Array; case 7: return Float64Array } } t("_decorator", Fh), t("CompactValueTypeArray", Gu("cc.CompactValueTypeArray")((Bh = function () { function t() { this._byteOffset = Ch && Ch(), this._unitCount = Dh && Dh(), this._unitElement = Rh && Rh(), this._length = Ph && Ph() } return t.lengthFor = function (t, e, i) { return Nh(e).requiredUnits * t.length * zh(i).BYTES_PER_ELEMENT }, t.compress = function (e, i, n, r, s, a) { for (var o = Nh(i), u = zh(n), h = o.requiredUnits * e.length, c = new u(r, s, h), l = 0; l < e.length; ++l)o.compress(c, l, e[l]); var f = new t; return f._unitElement = kh(n, i), f._byteOffset = a, f._unitCount = h, f._length = e.length, f }, t.prototype.decompress = function (t) { for (var e, i = { storageUnit: 7 & (e = this._unitElement), elementType: e >> 3 }, n = i.storageUnit, r = Nh(i.elementType), s = new (zh(n))(t, this._byteOffset, this._unitCount), a = new Array(this._length), o = 0; o < this._length; ++o)a[o] = r.decompress(s, o); return a }, t }(), Bh.StorageUnit = { Uint8: 0, Uint16: 1, Uint32: 2, Int8: 3, Int16: 4, Int32: 5, Float32: 6, Float64: 7 }, Bh.ElementType = { Scalar: 0, Vec2: 1, Vec3: 2, Vec4: 3, Quat: 4, Mat4: 5 }, Ch = Bu((Ah = Bh).prototype, "_byteOffset", [eh], (function () { return 0 })), Dh = Bu(Ah.prototype, "_unitCount", [eh], (function () { return 0 })), Rh = Bu(Ah.prototype, "_unitElement", [eh], (function () { return kh(0, 0) })), Ph = Bu(Ah.prototype, "_length", [eh], (function () { return 0 })), Eh = Ah)) || Eh); var Uh = ((Mh = {})[0] = { requiredUnits: 1, compress: function (t, e, i) { t[e] = i }, decompress: function (t, e) { return t[e] } }, Mh[1] = { requiredUnits: 2, compress: function (t, e, i) { t[2 * e] = i.x, t[2 * e + 1] = i.y }, decompress: function (t, e) { return new Kn(t[2 * e], t[2 * e + 1]) } }, Mh[2] = { requiredUnits: 3, compress: function (t, e, i) { t[3 * e] = i.x, t[3 * e + 1] = i.y, t[3 * e + 2] = i.z }, decompress: function (t, e) { return new Kn(t[3 * e], t[3 * e + 1], t[3 * e + 2]) } }, Mh[3] = { requiredUnits: 4, compress: function (t, e, i) { t[4 * e] = i.x, t[4 * e + 1] = i.y, t[4 * e + 2] = i.z, t[4 * e + 3] = i.w }, decompress: function (t, e) { return new Pn(t[4 * e], t[4 * e + 1], t[4 * e + 2], t[4 * e + 3]) } }, Mh[4] = { requiredUnits: 4, compress: function (t, e, i) { t[4 * e] = i.x, t[4 * e + 1] = i.y, t[4 * e + 2] = i.z, t[4 * e + 3] = i.w }, decompress: function (t, e) { return new Er(t[4 * e], t[4 * e + 1], t[4 * e + 2], t[4 * e + 3]) } }, Mh[5] = { requiredUnits: 16, compress: function (t, e, i) { Gr.toArray(t, i, 16 * e) }, decompress: function (t, e) { return Gr.fromArray(new Gr, t, 16 * e) } }, Mh), Vh = t("serializeTag", Symbol("[[Serialize]]")), Gh = t("deserializeTag", Symbol("[[Deserialize]]")); function Hh() { return 0 } function Wh(t) { return t } function jh(t) { return t * t } function Xh(t) { return t * (2 - t) } function qh(t) { return (t *= 2) < 1 ? .5 * t * t : -.5 * (--t * (t - 2) - 1) } function Yh(t) { return t * t * t } function Kh(t) { return --t * t * t + 1 } function Qh(t) { return (t *= 2) < 1 ? .5 * t * t * t : .5 * ((t -= 2) * t * t + 2) } function Zh(t) { return t * t * t * t } function Jh(t) { return 1 - --t * t * t * t } function $h(t) { return (t *= 2) < 1 ? .5 * t * t * t * t : -.5 * ((t -= 2) * t * t * t - 2) } function tc(t) { return t * t * t * t * t } function ec(t) { return --t * t * t * t * t + 1 } function ic(t) { return (t *= 2) < 1 ? .5 * t * t * t * t * t : .5 * ((t -= 2) * t * t * t * t + 2) } function nc(t) { return 1 === t ? 1 : 1 - Math.cos(t * Math.PI / 2) } function rc(t) { return Math.sin(t * Math.PI / 2) } function sc(t) { return .5 * (1 - Math.cos(Math.PI * t)) } function ac(t) { return 0 === t ? 0 : Math.pow(1024, t - 1) } function oc(t) { return 1 === t ? 1 : 1 - Math.pow(2, -10 * t) } function uc(t) { return 0 === t ? 0 : 1 === t ? 1 : (t *= 2) < 1 ? .5 * Math.pow(1024, t - 1) : .5 * (2 - Math.pow(2, -10 * (t - 1))) } function hc(t) { return 1 - Math.sqrt(1 - t * t) } function cc(t) { return Math.sqrt(1 - --t * t) } function lc(t) { return (t *= 2) < 1 ? -.5 * (Math.sqrt(1 - t * t) - 1) : .5 * (Math.sqrt(1 - (t -= 2) * t) + 1) } function fc(t) { var e, i = .1; return 0 === t ? 0 : 1 === t ? 1 : (!i || i < 1 ? (i = 1, e = .1) : e = .4 * Math.asin(1 / i) / (2 * Math.PI), -i * Math.pow(2, 10 * (t -= 1)) * Math.sin(2 * (t - e) * Math.PI / .4)) } function dc(t) { var e, i = .1; return 0 === t ? 0 : 1 === t ? 1 : (!i || i < 1 ? (i = 1, e = .1) : e = .4 * Math.asin(1 / i) / (2 * Math.PI), i * Math.pow(2, -10 * t) * Math.sin(2 * (t - e) * Math.PI / .4) + 1) } function pc(t) { var e, i = .1; return 0 === t ? 0 : 1 === t ? 1 : (!i || i < 1 ? (i = 1, e = .1) : e = .4 * Math.asin(1 / i) / (2 * Math.PI), (t *= 2) < 1 ? i * Math.pow(2, 10 * (t -= 1)) * Math.sin(2 * (t - e) * Math.PI / .4) * -.5 : i * Math.pow(2, -10 * (t -= 1)) * Math.sin(2 * (t - e) * Math.PI / .4) * .5 + 1) } function _c(t) { if (1 === t) return 1; var e = 1.70158; return t * t * ((e + 1) * t - e) } function gc(t) { if (0 === t) return 0; var e = 1.70158; return --t * t * ((e + 1) * t + e) + 1 } function mc(t) { var e = 2.5949095; return (t *= 2) < 1 ? t * t * ((e + 1) * t - e) * .5 : .5 * ((t -= 2) * t * ((e + 1) * t + e) + 2) } function vc(t) { return 1 - yc(1 - t) } function yc(t) { return t < 1 / 2.75 ? 7.5625 * t * t : t < 2 / 2.75 ? 7.5625 * (t -= 1.5 / 2.75) * t + .75 : t < 2.5 / 2.75 ? 7.5625 * (t -= 2.25 / 2.75) * t + .9375 : 7.5625 * (t -= 2.625 / 2.75) * t + .984375 } function bc(t) { return t < .5 ? .5 * vc(2 * t) : .5 * yc(2 * t - 1) + .5 } function wc(t) { return t <= 0 ? 0 : t >= 1 ? 1 : t * t * (3 - 2 * t) } function xc(t) { return t <= 0 ? 0 : t >= 1 ? 1 : t * t * t * (t * (6 * t - 15) + 10) } T._decorator = Fh; var Sc = Mc(jh, Xh), Tc = Mc(Yh, Kh), Ic = Mc(Zh, Jh), Ec = Mc(tc, ec), Ac = Mc(nc, rc), Cc = Mc(ac, oc), Dc = Mc(hc, cc), Rc = Mc(fc, dc), Pc = Mc(_c, gc), Bc = Mc(vc, yc); function Mc(t, e) { return function (i) { return i < .5 ? e(2 * i) / 2 : t(2 * i - 1) / 2 + .5 } } var Oc, Lc = Object.freeze({ __proto__: null, backIn: _c, backInOut: mc, backOut: gc, backOutIn: Pc, bounceIn: vc, bounceInOut: bc, bounceOut: yc, bounceOutIn: Bc, circIn: hc, circInOut: lc, circOut: cc, circOutIn: Dc, constant: Hh, cubicIn: Yh, cubicInOut: Qh, cubicOut: Kh, cubicOutIn: Tc, elasticIn: fc, elasticInOut: pc, elasticOut: dc, elasticOutIn: Rc, expoIn: ac, expoInOut: uc, expoOut: oc, expoOutIn: Cc, fade: xc, linear: Wh, quadIn: jh, quadInOut: qh, quadOut: Xh, quadOutIn: Sc, quartIn: Zh, quartInOut: $h, quartOut: Jh, quartOutIn: Ic, quintIn: tc, quintInOut: ic, quintOut: ec, quintOutIn: Ec, sineIn: nc, sineInOut: sc, sineOut: rc, sineOutIn: Ac, smooth: wc }); t("easing", Lc), t("EasingMethod", { LINEAR: 0, CONSTANT: 1, QUAD_IN: 2, QUAD_OUT: 3, QUAD_IN_OUT: 4, QUAD_OUT_IN: 5, CUBIC_IN: 6, CUBIC_OUT: 7, CUBIC_IN_OUT: 8, CUBIC_OUT_IN: 9, QUART_IN: 10, QUART_OUT: 11, QUART_IN_OUT: 12, QUART_OUT_IN: 13, QUINT_IN: 14, QUINT_OUT: 15, QUINT_IN_OUT: 16, QUINT_OUT_IN: 17, SINE_IN: 18, SINE_OUT: 19, SINE_IN_OUT: 20, SINE_OUT_IN: 21, EXPO_IN: 22, EXPO_OUT: 23, EXPO_IN_OUT: 24, EXPO_OUT_IN: 25, CIRC_IN: 26, CIRC_OUT: 27, CIRC_IN_OUT: 28, CIRC_OUT_IN: 29, ELASTIC_IN: 30, ELASTIC_OUT: 31, ELASTIC_IN_OUT: 32, ELASTIC_OUT_IN: 33, BACK_IN: 34, BACK_OUT: 35, BACK_IN_OUT: 36, BACK_OUT_IN: 37, BOUNCE_IN: 38, BOUNCE_OUT: 39, BOUNCE_IN_OUT: 40, BOUNCE_OUT_IN: 41, SMOOTH: 42, FADE: 43 }); var Fc, kc = ((Oc = {})[1] = Hh, Oc[0] = Wh, Oc[2] = jh, Oc[3] = Xh, Oc[4] = qh, Oc[5] = Sc, Oc[6] = Yh, Oc[7] = Kh, Oc[8] = Qh, Oc[9] = Tc, Oc[10] = Zh, Oc[11] = Jh, Oc[12] = $h, Oc[13] = Ic, Oc[14] = tc, Oc[15] = ec, Oc[16] = ic, Oc[17] = Ec, Oc[18] = nc, Oc[19] = rc, Oc[20] = sc, Oc[21] = Ac, Oc[22] = ac, Oc[23] = oc, Oc[24] = uc, Oc[25] = Cc, Oc[26] = hc, Oc[27] = cc, Oc[28] = lc, Oc[29] = Dc, Oc[30] = fc, Oc[31] = dc, Oc[32] = pc, Oc[33] = Rc, Oc[34] = _c, Oc[35] = gc, Oc[36] = mc, Oc[37] = Pc, Oc[38] = vc, Oc[39] = yc, Oc[40] = bc, Oc[41] = Bc, Oc[42] = wc, Oc[43] = xc, Oc); function Nc(t) { return kc[t] } D(255), D(65280); var zc, Uc, Vc, Gc = function (t) { function e() { var e; return (e = t.call(this) || this).value = 0, e.rightTangent = 0, e.rightTangentWeight = 0, e.leftTangent = 0, e.leftTangentWeight = 0, e._flags = 0, e } return s(e, t), n(e, [{ key: "interpolationMode", get: function () { return 255 & this._flags }, set: function (t) { this._flags &= -256, this._flags |= 0 | t } }, { key: "tangentWeightMode", get: function () { return (65280 & this._flags) >> 8 }, set: function (t) { this._flags &= -65281, this._flags |= t << 8 } }, { key: "easingMethod", get: function () { return (16711680 & this._flags) >> 16 }, set: function (t) { this._flags &= -16711681, this._flags |= t << 16 } }]), e }(Lh); function Hc(t) { var e = new Gc; if ("number" == typeof t) e.value = t; else { var i = t.interpolationMode, n = t.tangentWeightMode, r = t.value, s = t.rightTangent, a = t.rightTangentWeight, o = t.leftTangent, u = t.leftTangentWeight, h = t.easingMethod, c = t[no]; e.value = null != r ? r : e.value, e.rightTangent = null != s ? s : e.rightTangent, e.rightTangentWeight = null != a ? a : e.rightTangentWeight, e.leftTangent = null != o ? o : e.leftTangent, e.leftTangentWeight = null != u ? u : e.leftTangentWeight, e.interpolationMode = null != i ? i : e.interpolationMode, e.tangentWeightMode = null != n ? n : e.tangentWeightMode, e.easingMethod = null != h ? h : e.easingMethod, c && (e[no] = c) } return e } Pi.fastDefine("cc.RealKeyframeValue", Gc, ((Fc = { interpolationMode: 0, tangentWeightMode: 0, value: 0, rightTangent: 0, rightTangentWeight: 0, leftTangent: 0, leftTangentWeight: 0, easingMethod: 0 })[no] = void 0, Fc)), Pi.Attr.setClassAttr(Gc, no, "editorOnly", !0), (zc = Gc, null !== (Vc = (Uc = zc)[th]) && void 0 !== Vc ? Vc : Uc[th] = {}).uniquelyReferenced = !0; var Wc = t("RealCurve", function (t) { function e() { var e; return (e = t.call(this) || this).preExtrapolation = 1, e.postExtrapolation = 1, e } s(e, t); var i = e.prototype; return i.evaluate = function (t) { var e = this._times, i = this._values, n = e.length; if (0 === n) return 0; var r = e[0], s = e[n - 1]; if (t < r) { var a = this.preExtrapolation, o = i[0]; if (1 === a || n < 2) return o.value; switch (a) { case 0: return gl(r, i[0].value, e[1], i[1].value, t); case 2: t = pl(t, r, s); break; case 3: t = _l(t, r, s); break; default: return o.value } } else if (t > s) { var u = this.postExtrapolation, h = i[n - 1]; if (1 === u || n < 2) return h.value; switch (u) { case 0: return gl(s, h.value, e[n - 2], i[n - 2].value, t); case 2: t = pl(t, r, s); break; case 3: t = _l(t, r, s); break; default: return h.value } } var c = Eu(e, t); if (c >= 0) return i[c].value; var l = ~c, f = l - 1, d = e[f], p = i[f], _ = e[l]; return ml(d, p, _, i[l], (t - d) / (_ - d)) }, i.addKeyFrame = function (e, i) { return t.prototype.addKeyFrame.call(this, e, Hc(i)) }, i.assignSorted = function (t, e) { if (void 0 !== e) this.setKeyframes(t.slice(), e.map((function (t) { return Hc(t) }))); else { var i = Array.from(t); this.setKeyframes(i.map((function (t) { return t[0] })), i.map((function (t) { return Hc(t[1]) }))) } }, i.isConstant = function (t) { if (this._values.length <= 1) return !0; var e = this._values[0].value; return this._values.every((function (i) { return ji(i.value, e, t) })) }, i[Vh] = function (t, e) { if (e.toCCON) { var i = this._times, n = this._values, r = i.length, s = new DataView(new ArrayBuffer(0 + qc + qc + Yc + Kc * r + ll * r)), a = 0; s.setUint8(a, this.preExtrapolation), a += qc, s.setUint8(a, this.postExtrapolation), a += qc, s.setUint32(a, r, !0), a += Yc, i.forEach((function (t, e) { return s.setFloat32(a + Kc * e, t, !0) })), a += Kc * r; for (var o, u = p(n); !(o = u()).done;) { var h = o.value; a = fl(s, h, a) } var c = new Uint8Array(s.buffer, 0, a); t.writeProperty("bytes", c); var l = n.map((function (t) { return t[no] })); l.some((function (t) { return void 0 !== t })) && t.writeProperty("keyframeValueEditorExtras", l) } else t.writeThis() }, i[Gh] = function (t, e) { if (e.fromCCON) { var i = t.readProperty("bytes"), n = new DataView(i.buffer, i.byteOffset, i.byteLength), r = 0; this.preExtrapolation = n.getUint8(r), r += qc, this.postExtrapolation = n.getUint8(r), r += qc; var s = n.getUint32(r, !0); r += Yc; var a = Array.from({ length: s }, (function (t, e) { return n.getFloat32(r + Kc * e, !0) })); r += Kc * s; for (var o = new Array(s), u = 0; u < s; ++u) { var h = Hc({}); r = dl(n, h, r), o[u] = h } i.byteLength; var c = t.readProperty("keyframeValueEditorExtras"); c && (c.length, c.forEach((function (t, e) { return o[e][no] = t }))), this._times = a, this._values = o } else t.readThis() }, e }(Au)); Pi.fastDefine("cc.RealCurve", Wc, { _times: [], _values: [], preExtrapolation: 1, postExtrapolation: 1 }); var jc = 8, Xc = 255 << jc, qc = 1, Yc = 4, Kc = 4, Qc = 4, Zc = 4, Jc = 1, $c = 1, tl = 4, el = 4, il = 4, nl = 4, rl = Hc({}), sl = rl.interpolationMode, al = rl.tangentWeightMode, ol = rl.leftTangent, ul = rl.leftTangentWeight, hl = rl.rightTangent, cl = rl.rightTangentWeight, ll = Qc + Zc + Jc + $c + tl + el + il + nl + 0; function fl(t, e, i) { var n = 0, r = i, s = r; r += Qc; var a = e.value, o = e.interpolationMode, u = e.tangentWeightMode, h = e.rightTangent, c = e.rightTangentWeight, l = e.leftTangent, f = e.leftTangentWeight, d = e.easingMethod; return t.setFloat32(r, a, !0), r += Zc, o !== sl && (n |= 2, t.setUint8(r, o), r += Jc), u !== al && (n |= 4, t.setUint8(r, u), r += $c), l !== ol && (n |= 8, t.setFloat32(r, l, !0), r += tl), f !== ul && (n |= 16, t.setFloat32(r, f, !0), r += el), h !== hl && (n |= 32, t.setFloat32(r, h, !0), r += il), c !== cl && (n |= 64, t.setFloat32(r, c, !0), r += nl), n |= d << jc, t.setUint32(s, n, !0), r } function dl(t, e, i) { var n = i, r = t.getUint32(n, !0); n += Qc, e.value = t.getFloat32(n, !0), n += Zc, 2 & r && (e.interpolationMode = t.getUint8(n), n += Jc), 4 & r && (e.tangentWeightMode = t.getUint8(n), n += $c), 8 & r && (e.leftTangent = t.getFloat32(n, !0), n += tl), 16 & r && (e.leftTangentWeight = t.getFloat32(n, !0), n += el), 32 & r && (e.rightTangent = t.getFloat32(n, !0), n += il), 64 & r && (e.rightTangentWeight = t.getFloat32(n, !0), n += nl); var s = (r & Xc) >> jc; return e.easingMethod = s, n } function pl(t, e, i) { return e + an(t - e, i - e) } function _l(t, e, i) { return e + on(t - e, i - e) } function gl(t, e, i, n, r) { return e + (n - e) / (i - t) * (r - t) } function ml(t, e, i, n, r) { var s = i - t; switch (e.interpolationMode) { default: case 1: return e.value; case 0: var a = 0 === e.easingMethod ? r : Nc(e.easingMethod)(r); return Yi(e.value, n.value, a); case 2: var o = 1 / 3, u = e.rightTangent, h = e.rightTangentWeight, c = !!(2 & e.tangentWeightMode), l = n.leftTangent, f = n.leftTangentWeight, d = !!(1 & n.tangentWeightMode); if (c || d) { var p = 0; if (c) p = h; else { var _ = s, g = s * u; p = Math.sqrt(_ * _ + g * g) * o } var m = Math.atan(u), v = Math.cos(m) * p + t, y = Math.sin(m) * p + e.value, b = 0; if (d) b = f; else { var w = s, x = s * l; b = Math.sqrt(w * w + x * x) * o } var S = Math.atan(l), T = (v - t) / s, I = (-Math.cos(S) * b + i - t) / s, E = y, A = -Math.sin(S) * b + n.value, C = [0, 0, 0], D = yl(C, Du(0 - r, 3 * T, 3 * I - 6 * T, 3 * (T - I) + 1, C), r); return vl(e.value, E, A, n.value, D) } var R = e.value + o * u * s, P = n.value - o * l * s; return vl(e.value, R, P, n.value, r) } } function vl(t, e, i, n, r) { var s = 1 - r; return s * s * s * t + 3 * s * s * r * e + 3 * s * r * r * i + r * r * r * n } function yl(t, e, i) { var n = i; if (1 === e) n = t[0]; else { n = -1 / 0; for (var r = 0; r < e; ++r) { var s = t[r]; s >= 0 && s <= 1 && s > n && (n = s) } n === -1 / 0 && (n = 0) } return n } function bl(t, e, i, n, r) { var s = 1 - r; return s * (s * (t + (3 * e - t) * r) + 3 * i * r * r) + n * r * r * r } T.bezier = bl; var wl, xl, Sl, Tl, Il, El, Al, Cl, Dl, Rl = Math.cos, Pl = Math.acos, Bl = Math.max, Ml = 2 * Math.PI, Ol = Math.sqrt; function Ll(t) { return t < 0 ? -Math.pow(-t, 1 / 3) : Math.pow(t, 1 / 3) } function Fl(t, e) { var i, n, r, s, a = e - 0, o = e - t[0], u = 3 * a, h = 3 * o, c = 3 * (e - t[2]), l = 1 / (-a + h - c + (e - 1)), f = 1 / 3, d = (u - 6 * o + c) * l, p = d * f, _ = (-u + h) * l, g = (3 * _ - d * d) * f, m = g * f, v = (2 * d * d * d - 9 * d * _ + a * l * 27) / 27, y = v / 2, b = y * y + m * m * m; if (b < 0) { var w = -g * f, x = Ol(w * w * w), S = -v / (2 * x), T = Pl(S < -1 ? -1 : S > 1 ? 1 : S), I = 2 * Ll(x); return n = I * Rl(T * f) - p, r = I * Rl((T + Ml) * f) - p, s = I * Rl((T + 2 * Ml) * f) - p, n >= 0 && n <= 1 ? r >= 0 && r <= 1 ? s >= 0 && s <= 1 ? Bl(n, r, s) : Bl(n, r) : s >= 0 && s <= 1 ? Bl(n, s) : n : r >= 0 && r <= 1 ? s >= 0 && s <= 1 ? Bl(r, s) : r : s } if (0 === b) return r = -(i = y < 0 ? Ll(-y) : -Ll(y)) - p, (n = 2 * i - p) >= 0 && n <= 1 ? r >= 0 && r <= 1 ? Bl(n, r) : n : r; var E = Ol(b); return (i = Ll(-y + E)) - Ll(y + E) - p } function kl(t, e) { var i = Fl(t, e), n = t[1]; return ((1 - i) * (n + (t[3] - n) * i) * 3 + i * i) * i } T.bezierByTime = kl, t("QuatInterpolationMode", { SLERP: 0, CONSTANT: 1 }); var Nl = Gu("cc.QuatKeyframeValue")(wl = sh((xl = function (t) { var e = void 0 === t ? {} : t, i = e.value, n = e.interpolationMode, r = e.easingMethod; this.interpolationMode = Sl && Sl(), this.value = Tl && Tl(), this.easingMethod = Il && Il(), this.value = i ? Er.clone(i) : this.value, this.interpolationMode = null != n ? n : this.interpolationMode, this.easingMethod = null != r ? r : this.easingMethod }, Sl = Bu(xl.prototype, "interpolationMode", [eh], (function () { return 0 })), Tl = Bu(xl.prototype, "value", [eh], (function () { return Er.clone(Er.IDENTITY) })), Il = Bu(xl.prototype, "easingMethod", [eh], (function () { return 0 })), wl = xl)) || wl) || wl; function zl(t) { return new Nl(t) } t("QuatCurve", Gu("cc.QuatCurve")((Al = function (t) { function e() { var e; return (e = t.call(this) || this).preExtrapolation = Cl && Cl(), e.postExtrapolation = Dl && Dl(), e } s(e, t); var i = e.prototype; return i.evaluate = function (t, e) { var i; null !== (i = e) && void 0 !== i || (e = new Er); var n = this._times, r = this._values, s = this.postExtrapolation, a = this.preExtrapolation, o = n.length; if (0 === o) return e; var u = n[0], h = n[o - 1]; if (t < u) { var c = r[0]; switch (a) { case 2: t = u + an(t - u, h - u); break; case 3: t = u + on(t - u, h - u); break; default: return Er.copy(e, c.value) } } else if (t > h) { var l = r[o - 1]; switch (s) { case 2: t = u + an(t - u, h - u); break; case 3: t = u + on(t - u, h - u); break; default: return Er.copy(e, l.value) } } var f = Eu(n, t); if (f >= 0) return Er.copy(e, r[f].value); var d = ~f, p = d - 1, _ = n[p], g = r[p], m = n[d], v = r[d], y = (t - _) / (m - _); switch (g.interpolationMode) { default: case 1: return Er.copy(e, g.value); case 0: var b = g.easingMethod, w = 0 === b ? y : Array.isArray(b) ? kl(b, y) : Nc(b)(y); return Er.slerp(e, g.value, v.value, w) } }, i.addKeyFrame = function (e, i) { var n = new Nl(i); return t.prototype.addKeyFrame.call(this, e, n) }, i.assignSorted = function (t, e) { if (void 0 !== e) this.setKeyframes(t.slice(), e.map((function (t) { return zl(t) }))); else { var i = Array.from(t); this.setKeyframes(i.map((function (t) { return t[0] })), i.map((function (t) { return zl(t[1]) }))) } }, i[Vh] = function (t, e) { if (e.toCCON) { var i = this._times, n = this._values, r = !0; n.forEach((function (t, e, i) { var n = i[0]; r && t.interpolationMode !== n.interpolationMode && (r = !1) })); var s = i.length, a = jl * (r ? 1 : s), o = n.reduce((function (t, e) { var i = e.easingMethod; return t + (Array.isArray(i) ? Xl + 4 * Yl : Xl) }), 0), u = 0, h = new DataView(new ArrayBuffer(u += Vl + Gl + Hl * s + 4 * Wl * s + o + a + 0)), c = 0, l = 0; r && (l |= 1), h.setUint32(c, l, !0), c += Vl, h.setUint32(c, s, !0), c += Gl, i.forEach((function (t, e) { return h.setFloat32(c + Hl * e, t, !0) })), c += Hl * s, n.forEach((function (t, e) { var i = t.value, n = i.x, r = i.y, s = i.z, a = i.w, o = c + 4 * Wl * e; h.setFloat32(o + 0 * Wl, n, !0), h.setFloat32(o + 1 * Wl, r, !0), h.setFloat32(o + 2 * Wl, s, !0), h.setFloat32(o + 3 * Wl, a, !0) })), c += 4 * Wl * s, n.forEach((function (t) { var e = t.easingMethod; Array.isArray(e) ? (h.setUint8(c, ql), ++c, h.setFloat32(c + 0 * Yl, e[0], !0), h.setFloat32(c + 1 * Yl, e[1], !0), h.setFloat32(c + 2 * Yl, e[2], !0), h.setFloat32(c + 3 * Yl, e[3], !0), c += 4 * Yl) : (h.setUint8(c, e), ++c) })); var f = c; c += a; var d = f; n.forEach((function (t) { var e = t.interpolationMode; h.setUint8(d, e), r || (d += jl) })); var p = new Uint8Array(h.buffer); t.writeProperty("bytes", p) } else t.writeThis() }, i[Gh] = function (t, e) { if (e.fromCCON) { var i = t.readProperty("bytes"), n = new DataView(i.buffer, i.byteOffset, i.byteLength), r = 0, s = n.getUint32(r, !0); r += Vl; var a = 1 & s, o = n.getUint32(r, !0); r += Gl; var u = Array.from({ length: o }, (function (t, e) { return n.getFloat32(r + Hl * e, !0) })), h = r += Hl * o; r += 4 * Wl * o; var c = Array.from({ length: o }, (function (t, e) { var i = h + 4 * Wl * e, s = n.getFloat32(i + 0 * Wl, !0), a = n.getFloat32(i + 1 * Wl, !0), o = n.getFloat32(i + 2 * Wl, !0), u = n.getFloat32(i + 3 * Wl, !0), c = n.getUint8(r); ++r; var l = zl({ value: { x: s, y: a, z: o, w: u } }); return c !== ql ? l.easingMethod = c : (l.easingMethod = [n.getFloat32(r + 0 * Yl, !0), n.getFloat32(r + 1 * Yl, !0), n.getFloat32(r + 2 * Yl, !0), n.getFloat32(r + 3 * Yl, !0)], r += 4 * Yl), l })); if (a) { var l = n.getUint8(r); ++r; for (var f = 0; f < o; ++f)c[f].interpolationMode = l } else { for (var d = 0; d < o; ++d) { var p = n.getUint8(r + d); c[d].interpolationMode = p } r += o } this._times = u, this._values = c } else t.readThis() }, e }(Au), Cl = Bu(Al.prototype, "preExtrapolation", [eh], (function () { return 1 })), Dl = Bu(Al.prototype, "postExtrapolation", [eh], (function () { return 1 })), El = Al)) || El); var Ul, Vl = 1, Gl = 4, Hl = 4, Wl = 4, jl = 1, Xl = 1, ql = 255, Yl = 4, Kl = (t("ObjectCurve", Gu("cc.ObjectCurve")(Ul = function (t) { function e() { return t.apply(this, arguments) || this } return s(e, t), e.prototype.evaluate = function (t) { var e = this.searchKeyframe(t); if (e >= 0) return this._values[e]; var i = Xi(~e - 1, 0, this._values.length - 1); return this._values[i] }, e }(Au)) || Ul), { Blend: 0, Fixed: 1 }); Ee(Kl); var Ql = t("ColorKey", (function () { this.color = rr.WHITE.clone(), this.time = 0 })); Pi.fastDefine("cc.ColorKey", Ql, { color: rr.WHITE.clone(), time: 0 }), Pi.Attr.setClassAttr(Ql, "color", "visible", !0), Pi.Attr.setClassAttr(Ql, "time", "visible", !0); var Zl = t("AlphaKey", (function () { this.alpha = 1, this.time = 0 })); Pi.fastDefine("cc.AlphaKey", Zl, { alpha: 1, time: 0 }), Pi.Attr.setClassAttr(Zl, "alpha", "visible", !0), Pi.Attr.setClassAttr(Zl, "time", "visible", !0); var Jl = t("Gradient", function () { function t() { this.colorKeys = [], this.alphaKeys = [], this.mode = 0 } var e = t.prototype; return e.setKeys = function (t, e) { this.colorKeys = t, this.alphaKeys = e }, e.sortKeys = function () { this.colorKeys.length > 1 && this.colorKeys.sort((function (t, e) { return t.time - e.time })), this.alphaKeys.length > 1 && this.alphaKeys.sort((function (t, e) { return t.time - e.time })) }, e.evaluate = function (t) { return this.evaluateFast(new rr, t) }, e.evaluateFast = function (t, e) { return this.getRGB(t, e), t.a = this.getAlpha(e), t }, e.randomColor = function () { return this.getRandomColor(new rr) }, e.getRandomColor = function (t) { var e = this.colorKeys[Math.trunc(Zi() * this.colorKeys.length)], i = this.alphaKeys[Math.trunc(Zi() * this.alphaKeys.length)]; return t.set(e.color), t.a = i.alpha, t }, e.getRGB = function (t, e) { var i = this.colorKeys, n = i.length; if (n > 1) { e = an(e, 1 + Hi); for (var r = 1; r < n; ++r) { var s = i[r - 1].time, a = i[r].time; if (e >= s && e < a) { if (1 === this.mode) return rr.copy(t, i[r].color), t; var o = (e - s) / (a - s); return rr.lerp(t, i[r - 1].color, i[r].color, o), t } } var u = n - 1; ji(e, i[u].time, Hi) ? rr.copy(t, i[u].color) : e < i[0].time ? rr.lerp(t, rr.BLACK, i[0].color, e / i[0].time) : e > i[u].time && rr.lerp(t, i[u].color, rr.BLACK, (e - i[u].time) / (1 - i[u].time)) } else 1 === n ? rr.copy(t, i[0].color) : rr.copy(t, rr.WHITE); return t }, e.getAlpha = function (t) { var e = this.alphaKeys, i = e.length; if (i > 1) { t = an(t, 1 + Hi); for (var n = 1; n < i; ++n) { var r = e[n - 1].time, s = e[n].time; if (t >= r && t < s) { if (1 === this.mode) return e[n].alpha; var a = (t - r) / (s - r); return Yi(e[n - 1].alpha, e[n].alpha, a) } } var o = i - 1; return ji(t, e[o].time, Hi) ? e[o].alpha : t < e[0].time ? Yi(0, e[0].alpha, t / e[0].time) : t > e[o].time ? Yi(e[o].alpha, 0, (t - e[o].time) / (1 - e[o].time)) : 255 } return 1 === i ? e[0].alpha : 255 }, t }()); Jl.Mode = Kl, Pi.fastDefine("cc.Gradient", Jl, { colorKeys: [], alphaKeys: [], mode: 0 }), Pi.Attr.setClassAttr(Jl, "colorKeys", "visible", !0), Pi.Attr.setClassAttr(Jl, "alphaKeys", "visible", !0), Pi.Attr.setClassAttr(Jl, "mode", "visible", !0); var $l = function () { this.time = 0, this.value = 0, this.inTangent = 0, this.outTangent = 0 }; Pi.fastDefine("cc.Keyframe", $l, { time: 0, value: 0, inTangent: 0, outTangent: 0 }); var tf = function () { function t() { this.index = void 0, this.time = void 0, this.endTime = void 0, this.coefficient = void 0, this.index = -1, this.time = 0, this.endTime = 0, this.coefficient = new Float32Array(4) } return t.prototype.evaluate = function (t) { return ef(t - this.time, this.coefficient) }, t }(); function ef(t, e) { return t * (t * (t * e[0] + e[1]) + e[2]) + e[3] } var nf = function () { function t(t) { if (void 0 === t && (t = null), this._curve = void 0, this.cachedKey = void 0, t instanceof Wc) this._curve = t; else { var e = new Wc; this._curve = e, e.preExtrapolation = 2, e.postExtrapolation = 1, t ? e.assignSorted(t.map((function (t) { return [t.time, { interpolationMode: 2, value: t.value, leftTangent: t.inTangent, rightTangent: t.outTangent }] }))) : e.assignSorted([[0, { interpolationMode: 2, value: 1 }], [1, { interpolationMode: 2, value: 1 }]]) } this.cachedKey = new tf } var e = t.prototype; return e.addKey = function (t) { t ? this._curve.addKeyFrame(t.time, { interpolationMode: 2, value: t.value, leftTangent: t.inTangent, rightTangent: t.outTangent }) : this._curve.clear() }, e.evaluate_slow = function (t) { return this._curve.evaluate(t) }, e.evaluate = function (t) { var e = this.cachedKey, i = this._curve, n = i.keyFramesCount - 1, r = t, s = t < 0 ? i.preExtrapolation : i.postExtrapolation, a = i.getKeyframeTime(0), o = i.getKeyframeTime(n); switch (s) { case 2: r = an(t - a, o - a) + a; break; case 3: r = on(t - a, o - a) + a; break; default: r = Xi(t, a, o) }if (r >= e.time && r < e.endTime) return e.evaluate(r); var u = this.findIndex(e, r), h = Math.min(u + 1, n); return this.calcOptimizedKey(e, u, h), e.evaluate(r) }, e.calcOptimizedKey = function (t, e, i) { var n = this._curve.getKeyframeTime(e), r = this._curve.getKeyframeTime(i), s = this._curve.getKeyframeValue(e), a = s.value, o = s.leftTangent, u = this._curve.getKeyframeValue(i), h = u.value, c = u.rightTangent; t.index = e, t.time = n, t.endTime = r; var l = r - n, f = h - a, d = 1 / (l * l), p = o * l, _ = c * l; t.coefficient[0] = (p + _ - f - f) * d / l, t.coefficient[1] = (f + f + f - p - p - _) * d, t.coefficient[2] = o, t.coefficient[3] = a }, e.findIndex = function (t, e) { var i = this._curve, n = i.keyFramesCount, r = t.index; if (-1 !== r) if (e > i.getKeyframeTime(r)) for (var s = 0; s < 3; s++) { var a = r + s; if (a + 1 < n && i.getKeyframeTime(a + 1) > e) return a } else for (var o = 0; o < 3; o++) { var u = r - o; if (u >= 0 && i.getKeyframeTime(u - 1) <= e) return u - 1 } for (var h, c = 0, l = n; l - c > 1;)h = Math.floor((c + l) / 2), i.getKeyframeTime(h) >= e ? l = h : c = h; return c }, n(t, [{ key: "_internalCurve", get: function () { return this._curve } }, { key: "keyFrames", get: function () { return Array.from(this._curve.keyframes()).map((function (t) { var e = t[0], i = t[1], n = new $l; return n.time = e, n.value = i.value, n.inTangent = i.leftTangent, n.outTangent = i.rightTangent, n })) }, set: function (t) { this._curve.assignSorted(t.map((function (t) { return [t.time, { interpolationMode: 2, value: t.value, leftTangent: t.inTangent, rightTangent: t.outTangent }] }))) } }, { key: "preWrapMode", get: function () { return sf(this._curve.preExtrapolation) }, set: function (t) { this._curve.preExtrapolation = rf(t) } }, { key: "postWrapMode", get: function () { return sf(this._curve.postExtrapolation) }, set: function (t) { this._curve.postExtrapolation = rf(t) } }]), t }(); function rf(t) { switch (t) { default: case 0: case 1: case 8: return 1; case 22: return 3; case 2: return 2 } } function sf(t) { switch (t) { default: case 0: case 1: return 8; case 3: return 22; case 2: return 2 } } nf.defaultKF = [{ time: 0, value: 1, inTangent: 0, outTangent: 0 }, { time: 1, value: 1, inTangent: 0, outTangent: 0 }], Pi.fastDefine("cc.AnimationCurve", nf, { _curve: null }); var af = Kn.multiplyScalar, of = Kn.add, uf = 4294967295, hf = Qn(), cf = Qn(), lf = Qn(), ff = Qn(), df = function () { function t(t, e) { void 0 === t && (t = 2), void 0 === e && (e = []), this._type = void 0, this._knots = [], this._type = 1024, this._mode = t; for (var i = 0; i < e.length; i++)this._knots[i] = Qn(e[i]) } t.create = function (e, i) { return void 0 === i && (i = []), new t(e, i) }, t.clone = function (e) { return new t(e.mode, e.knots) }, t.copy = function (t, e) { t._mode = e.mode, t._knots.length = 0; for (var i = e.knots, n = i.length, r = 0; r < n; r++)t._knots[r] = Qn(i[r]); return t }; var e = t.prototype; return e.setModeAndKnots = function (t, e) { this._mode = t, this._knots.length = 0; for (var i = 0; i < e.length; i++)this._knots[i] = Qn(e[i]) }, e.clearKnots = function () { this._knots.length = 0 }, e.getKnotCount = function () { return this._knots.length }, e.addKnot = function (t) { this._knots.push(Qn(t)) }, e.insertKnot = function (t, e) { var i = Qn(e); t >= this._knots.length ? this._knots.push(i) : this._knots.splice(t, 0, i) }, e.removeKnot = function (t) { Te(this._knots, t), this._knots.splice(t, 1) }, e.setKnot = function (t, e) { Te(this._knots, t), this._knots[t].set(e) }, e.getKnot = function (t) { return Te(this._knots, t), this._knots[t] }, e.getPoint = function (e, i) { void 0 === i && (i = uf), e = Xi(e, 0, 1); var n = this.getSegments(); if (0 === n) return Qn(); if (i === uf) { var r = 1 / n; i = Math.floor(e / r), e = e % r / r } var s = this._knots; if (i >= n) return Qn(s[s.length - 1]); switch (this._mode) { case 0: return t.calcLinear(s[i], s[i + 1], e); case 1: var a = 4 * i; return t.calcBezier(s[a], s[a + 1], s[a + 2], s[a + 3], e); case 2: var o = i > 0 ? s[i - 1] : s[i], u = i + 2 < s.length ? s[i + 2] : s[i + 1]; return t.calcCatmullRom(o, s[i], s[i + 1], u, e); default: return Qn() } }, e.getPoints = function (t, e) { if (void 0 === e && (e = uf), 0 === t) return []; if (1 === t) return [this.getPoint(0, e)]; for (var i = [], n = 1 / (t - 1), r = 0; r < t; r++) { var s = r * n, a = this.getPoint(s, e); i.push(a) } return i }, e.getSegments = function () { var t = this._knots.length; switch (this._mode) { case 0: case 2: return t < 2 ? (it(14300), 0) : t - 1; case 1: return t < 4 || t % 4 != 0 ? (it(14301), 0) : t / 4; default: return at(!1, 16407), 0 } }, t.calcLinear = function (t, e, i) { var n = new Kn; return af(hf, t, 1 - i), af(cf, e, i), of(n, hf, cf), n }, t.calcBezier = function (t, e, i, n, r) { var s = new Kn, a = 1 - r; return af(hf, t, a * a * a), af(cf, e, 3 * r * a * a), af(lf, i, 3 * r * r * a), af(ff, n, r * r * r), of(hf, hf, cf), of(lf, lf, ff), of(s, hf, lf), s }, t.calcCatmullRom = function (t, e, i, n, r) { var s = new Kn, a = r * r, o = a * r; return af(hf, t, -.5 * o + a - .5 * r), af(cf, e, 1.5 * o - 2.5 * a + 1), af(lf, i, -1.5 * o + 2 * a + .5 * r), af(ff, n, .5 * o - .5 * a), of(hf, hf, cf), of(lf, lf, ff), of(s, hf, lf), s }, n(t, [{ key: "type", get: function () { return this._type } }, { key: "mode", get: function () { return this._mode } }, { key: "knots", get: function () { return this._knots } }]), t }(); function pf(t, e) { W(t + " is deprecated, please use " + e + " instead.") } lt(Wa, "intersect", [{ name: "ray_aabb", newName: "rayAABB" }, { name: "ray_plane", newName: "rayPlane" }, { name: "ray_triangle", newName: "rayTriangle" }, { name: "ray_sphere", newName: "raySphere" }, { name: "ray_obb", newName: "rayOBB" }, { name: "ray_capsule", newName: "rayCapsule" }, { name: "ray_subMesh", newName: "raySubMesh" }, { name: "ray_mesh", newName: "rayMesh" }, { name: "ray_model", newName: "rayModel" }, { name: "line_plane", newName: "linePlane" }, { name: "line_triangle", newName: "lineTriangle" }, { name: "line_aabb", newName: "lineAABB" }, { name: "line_obb", newName: "lineOBB" }, { name: "line_sphere", newName: "lineSphere" }, { name: "aabb_aabb", newName: "aabbWithAABB" }, { name: "aabb_obb", newName: "aabbWithOBB" }, { name: "aabb_plane", newName: "aabbPlane" }, { name: "aabb_frustum", newName: "aabbFrustum" }, { name: "aabbFrustum_accurate", newName: "aabbFrustumAccurate" }, { name: "obb_point", newName: "obbPoint" }, { name: "obb_plane", newName: "obbPlane" }, { name: "obb_frustum", newName: "obbFrustum" }, { name: "obbFrustum_accurate", newName: "obbFrustumAccurate" }, { name: "obb_obb", newName: "obbWithOBB" }, { name: "obb_capsule", newName: "obbCapsule" }, { name: "sphere_plane", newName: "spherePlane" }, { name: "sphere_frustum", newName: "sphereFrustum" }, { name: "sphereFrustum_accurate", newName: "sphereFrustumAccurate" }, { name: "sphere_sphere", newName: "sphereWithSphere" }, { name: "sphere_aabb", newName: "sphereAABB" }, { name: "sphere_obb", newName: "sphereOBB" }, { name: "sphere_capsule", newName: "sphereCapsule" }, { name: "capsule_capsule", newName: "capsuleWithCapsule" }]); var _f = function (t) { function e() { var e; return e = t.call(this) || this, pf("line", "Line"), e } return s(e, t), e }(Ds), gf = function (t) { function e() { var e; return e = t.call(this) || this, pf("plane", "Plane"), e } return s(e, t), e }(Ka), mf = function (t) { function e() { var e; return e = t.call(this) || this, pf("ray", "Ray"), e } return s(e, t), e }(Rs), vf = function (t) { function e() { var e; return e = t.call(this) || this, pf("triangle", "Triangle"), e } return s(e, t), e }(Qa), yf = function (t) { function e() { var e; return e = t.call(this) || this, pf("sphere", "Sphere"), e } return s(e, t), e }(Vs), bf = function (t) { function e() { var e; return e = t.call(this) || this, pf("aabb", "AABB"), e } return s(e, t), e }(hu), wf = function (t) { function e() { var e; return e = t.call(this) || this, pf("obb", "OBB"), e } return s(e, t), e }(Iu), xf = function (t) { function e() { var e; return e = t.call(this) || this, pf("capsule", "Capsule"), e } return s(e, t), e }(cu), Sf = function (t) { function e() { var e; return e = t.call(this) || this, pf("frustum", "Frustum"), e } return s(e, t), e }(yu), Tf = Object.freeze({ __proto__: null, AABB: hu, AnimationCurve: nf, Capsule: cu, ERaycastMode: { ALL: 0, CLOSEST: 1, ANY: 2 }, Frustum: yu, Keyframe: $l, Line: Ds, OBB: Iu, OptimizedKey: tf, Plane: Ka, Ray: Rs, Sphere: Vs, Spline: df, SplineMode: { LINEAR: 0, BEZIER: 1, CATMULL_ROM: 2 }, Triangle: Qa, WrapModeMask: { Default: 0, Normal: 1, Loop: 2, ShouldWrap: 4, Clamp: 8, PingPong: 22, Reverse: 36 }, aabb: bf, capsule: xf, constructLegacyCurveAndConvert: function () { var t = new Wc; return t.assignSorted([[0, { interpolationMode: 2, value: 1 }], [1, { interpolationMode: 2, value: 1 }]]), t }, distance: Cs, enums: { SHAPE_RAY: 1, SHAPE_LINE: 2, SHAPE_SPHERE: 4, SHAPE_AABB: 8, SHAPE_OBB: 16, SHAPE_PLANE: 32, SHAPE_TRIANGLE: 64, SHAPE_FRUSTUM: 128, SHAPE_FRUSTUM_ACCURATE: 256, SHAPE_CAPSULE: 512, SHAPE_SPLINE: 1024 }, evalOptCurve: ef, frustum: Sf, intersect: Wa, line: _f, obb: wf, plane: gf, ray: mf, sphere: yf, triangle: vf }); t("geometry", Tf), t("SystemPriority", { LOW: 0, MEDIUM: 100, HIGH: 200, SCHEDULER: 2147483648 }); var If = t("System", function () { function t() { this._id = "", this._priority = 0, this._executeInEditMode = !1 } t.sortByPriority = function (t, e) { return t._priority < e._priority ? 1 : t._priority > e.priority ? -1 : 0 }; var e = t.prototype; return e.init = function () { }, e.update = function () { }, e.postUpdate = function () { }, e.destroy = function () { }, n(t, [{ key: "priority", get: function () { return this._priority }, set: function (t) { this._priority = t } }, { key: "id", get: function () { return this._id }, set: function (t) { this._id = t } }]), t }()); If.Priority = Ee({ LOW: 0, MEDIUM: 100, HIGH: 200, SCHEDULER: 2147483648 }); var Ef = new It("Scheduler"), Af = function () { function t(t, e, i, n) { this.target = void 0, this.priority = void 0, this.paused = void 0, this.markedForDeletion = void 0, this.target = t, this.priority = e, this.paused = i, this.markedForDeletion = n } return t.get = function (e, i, n, r) { var s = t._listEntries.pop(); return s ? (s.target = e, s.priority = i, s.paused = n, s.markedForDeletion = r) : s = new t(e, i, n, r), s }, t.put = function (e) { t._listEntries.length < 20 && (e.target = null, t._listEntries.push(e)) }, t }(); Af._listEntries = []; var Cf = function () { function t(t, e, i, n) { this.list = void 0, this.entry = void 0, this.target = void 0, this.callback = void 0, this.list = t, this.entry = e, this.target = i, this.callback = n } return t.get = function (e, i, n, r) { var s = t._hashUpdateEntries.pop(); return s ? (s.list = e, s.entry = i, s.target = n, s.callback = r) : s = new t(e, i, n, r), s }, t.put = function (e) { t._hashUpdateEntries.length < 20 && (e.list = e.entry = e.target = e.callback = null, t._hashUpdateEntries.push(e)) }, t }(); Cf._hashUpdateEntries = []; var Df = function () { function t(t, e, i, n, r, s) { this.timers = void 0, this.target = void 0, this.timerIndex = void 0, this.currentTimer = void 0, this.currentTimerSalvaged = void 0, this.paused = void 0, this.timers = t, this.target = e, this.timerIndex = i, this.currentTimer = n, this.currentTimerSalvaged = r, this.paused = s } return t.get = function (e, i, n, r, s, a) { var o = t._hashTimerEntries.pop(); return o ? (o.timers = e, o.target = i, o.timerIndex = n, o.currentTimer = r, o.currentTimerSalvaged = s, o.paused = a) : o = new t(e, i, n, r, s, a), o }, t.put = function (e) { t._hashTimerEntries.length < 20 && (e.timers = e.target = e.currentTimer = null, t._hashTimerEntries.push(e)) }, t }(); Df._hashTimerEntries = []; var Rf = function () { function t() { this._lock = void 0, this._scheduler = void 0, this._elapsed = void 0, this._runForever = void 0, this._useDelay = void 0, this._timesExecuted = void 0, this._repeat = void 0, this._delay = void 0, this._interval = void 0, this._target = void 0, this._callback = void 0, this._lock = !1, this._scheduler = null, this._elapsed = -1, this._runForever = !1, this._useDelay = !1, this._timesExecuted = 0, this._repeat = 0, this._delay = 0, this._interval = 0, this._target = null } t.get = function () { return t._timers.pop() || new t }, t.put = function (e) { t._timers.length < 20 && !e._lock && (e._scheduler = e._target = e._callback = null, t._timers.push(e)) }; var e = t.prototype; return e.initWithCallback = function (t, e, i, n, r, s) { return this._lock = !1, this._scheduler = t, this._target = i, this._callback = e, this._timesExecuted = 0, this._elapsed = -1, this._interval = n, this._delay = s, this._useDelay = this._delay > 0, this._repeat = r, this._runForever = this._repeat === T.macro.REPEAT_FOREVER, !0 }, e.getInterval = function () { return this._interval }, e.setInterval = function (t) { this._interval = t }, e.update = function (t) { -1 === this._elapsed ? (this._elapsed = 0, this._timesExecuted = 0) : (this._elapsed += t, this._runForever && !this._useDelay ? this._elapsed >= this._interval && (this.trigger(), this._elapsed = 0) : (this._useDelay ? this._elapsed >= this._delay && (this.trigger(), this._elapsed -= this._delay, this._timesExecuted += 1, this._useDelay = !1) : this._elapsed >= this._interval && (this.trigger(), this._elapsed = 0, this._timesExecuted += 1), this._callback && !this._runForever && this._timesExecuted > this._repeat && this.cancel())) }, e.getCallback = function () { return this._callback }, e.trigger = function () { this._target && this._callback && (this._lock = !0, this._callback.call(this._target, this._elapsed), this._lock = !1) }, e.cancel = function () { this._scheduler && this._callback && this._target && this._scheduler.unscheduleForTimer(this, this._target) }, t }(); Rf._timers = []; var Pf = t("Scheduler", function (t) { function e() { var e; return (e = t.call(this) || this)._timeScale = void 0, e._updatesNegList = void 0, e._updates0List = void 0, e._updatesPosList = void 0, e._hashForUpdates = void 0, e._hashForTimers = void 0, e._currentTarget = void 0, e._currentTargetSalvaged = void 0, e._updateHashLocked = void 0, e._arrayForTimers = void 0, e._timeScale = 1, e._updatesNegList = [], e._updates0List = [], e._updatesPosList = [], e._hashForUpdates = Nt(!0), e._hashForTimers = Nt(!0), e._currentTarget = null, e._currentTargetSalvaged = !1, e._updateHashLocked = !1, e._arrayForTimers = [], e } s(e, t), e.enableForTarget = function (t) { var e = !1; (t.uuid || t.id) && (e = !0), e || (t.id = Ef.getNewId()) }; var i = e.prototype; return i.setTimeScale = function (t) { this._timeScale = t }, i.getTimeScale = function () { return this._timeScale }, i.update = function (t) { var e, i, n, r, s; for (this._updateHashLocked = !0, 1 !== this._timeScale && (t *= this._timeScale), e = 0, n = (i = this._updatesNegList).length; e < n; e++)(r = i[e]).paused || r.markedForDeletion || !r.target || null == r.target.update || r.target.update(t); for (e = 0, n = (i = this._updates0List).length; e < n; e++)(r = i[e]).paused || r.markedForDeletion || !r.target || null == r.target.update || r.target.update(t); for (e = 0, n = (i = this._updatesPosList).length; e < n; e++)(r = i[e]).paused || r.markedForDeletion || !r.target || null == r.target.update || r.target.update(t); var a = this._arrayForTimers; for (e = 0; e < a.length; e++) { var o; if (s = a[e], this._currentTarget = s, this._currentTargetSalvaged = !1, !s.paused && s.timers) for (s.timerIndex = 0; s.timerIndex < s.timers.length; ++s.timerIndex)s.currentTimer = s.timers[s.timerIndex], s.currentTimerSalvaged = !1, s.currentTimer.update(t), s.currentTimer = null; this._currentTargetSalvaged && 0 === (null == (o = this._currentTarget.timers) ? void 0 : o.length) && (this._removeHashElement(this._currentTarget), --e) } for (e = 0, i = this._updatesNegList; e < i.length;)(r = i[e]).markedForDeletion ? this._removeUpdateFromHash(r) : e++; for (e = 0, i = this._updates0List; e < i.length;)(r = i[e]).markedForDeletion ? this._removeUpdateFromHash(r) : e++; for (e = 0, i = this._updatesPosList; e < i.length;)(r = i[e]).markedForDeletion ? this._removeUpdateFromHash(r) : e++; this._updateHashLocked = !1, this._currentTarget = null }, i.schedule = function (t, e, i, n, r, s) { var a, o, u, h; "function" != typeof t ? (it(1514), u = e, h = t) : (u = t, h = e), 3 !== arguments.length && 4 !== arguments.length && 5 !== arguments.length || (s = !!n, n = T.macro.REPEAT_FOREVER, r = 0), at(Boolean(h), 1502); var c = h.uuid || h.id; if (c) { var l, f, d = this._hashForTimers[c]; if (d ? d.paused !== s && it(1511) : (d = Df.get(null, h, 0, null, !1, Boolean(s)), this._arrayForTimers.push(d), this._hashForTimers[c] = d), null == d.timers) d.timers = []; else for (f = 0; f < d.timers.length; ++f)if ((l = d.timers[f]) && u === l.getCallback()) return J(1507, l.getInterval(), i), void l.setInterval(i); (l = Rf.get()).initWithCallback(this, u, h, i, null !== (a = n) && void 0 !== a ? a : 0, null !== (o = r) && void 0 !== o ? o : 0), d.timers.push(l), this._currentTarget === d && this._currentTargetSalvaged && (this._currentTargetSalvaged = !1) } else rt(1510) }, i.scheduleUpdate = function (t, e, i) { var n = t.uuid || t.id; if (n) { var r = this._hashForUpdates[n]; if (r && r.entry) { if (r.entry.priority === e) return r.entry.markedForDeletion = !1, void (r.entry.paused = i); if (this._updateHashLocked) return J(1506), r.entry.markedForDeletion = !1, void (r.entry.paused = i); this.unscheduleUpdate(t) } var s, a = Af.get(t, e, i, !1); 0 === e ? (s = this._updates0List, this._appendIn(s, a)) : (s = e < 0 ? this._updatesNegList : this._updatesPosList, this._priorityIn(s, a, e)), this._hashForUpdates[n] = Cf.get(s, a, t, null) } else rt(1510) }, i.unschedule = function (t, e) { if (e && t) { var i = e.uuid || e.id; if (i) { var n = this._hashForTimers[i]; if (n) { var r = n.timers; if (!r) return; for (var s = 0, a = r.length; s < a; s++) { var o = r[s]; if (t === o.getCallback()) return o !== n.currentTimer || n.currentTimerSalvaged || (n.currentTimerSalvaged = !0), r.splice(s, 1), Rf.put(o), n.timerIndex >= s && n.timerIndex--, void (0 === r.length && (this._currentTarget === n ? this._currentTargetSalvaged = !0 : this._removeHashElement(n))) } } } else rt(1510) } }, i.unscheduleForTimer = function (t, e) { var i = e.uuid || e.id, n = this._hashForTimers[i], r = n.timers; if (r && 0 !== r.length) for (var s = r.length - 1; s >= 0; s--) { var a = r[s]; if (a === t) return r.splice(s, 1), Rf.put(a), n.timerIndex >= s && n.timerIndex--, void (0 === r.length && (this._currentTargetSalvaged = !0)) } }, i.unscheduleUpdate = function (t) { if (t) { var e = t.uuid || t.id; if (e) { var i = this._hashForUpdates[e]; null != i && i.entry && (this._updateHashLocked ? i.entry.markedForDeletion = !0 : this._removeUpdateFromHash(i.entry)) } else rt(1510) } }, i.unscheduleAllForTarget = function (t) { if (t) { var e = t.uuid || t.id; if (e) { var i = this._hashForTimers[e]; if (null != i && i.timers) { var n = i.timers; i.currentTimer && n.indexOf(i.currentTimer) > -1 && !i.currentTimerSalvaged && (i.currentTimerSalvaged = !0); for (var r = 0, s = n.length; r < s; r++)Rf.put(n[r]); n.length = 0, this._currentTarget === i ? this._currentTargetSalvaged = !0 : this._removeHashElement(i) } this.unscheduleUpdate(t) } else rt(1510) } }, i.unscheduleAll = function () { this.unscheduleAllWithMinPriority(2147483648) }, i.unscheduleAllWithMinPriority = function (t) { var e, i, n, r = this._arrayForTimers; for (e = r.length - 1; e >= 0; e--)(i = r[e]).target && this.unscheduleAllForTarget(i.target); var s = 0; if (t < 0) for (e = 0; e < this._updatesNegList.length;) { var a; s = this._updatesNegList.length, null != (a = n = this._updatesNegList[e]) && a.target && n.priority >= t && this.unscheduleUpdate(n.target), s === this._updatesNegList.length && e++ } if (t <= 0) for (e = 0; e < this._updates0List.length;) { var o; s = this._updates0List.length, null != (o = n = this._updates0List[e]) && o.target && this.unscheduleUpdate(n.target), s === this._updates0List.length && e++ } for (e = 0; e < this._updatesPosList.length;) { var u; s = this._updatesPosList.length, null != (u = n = this._updatesPosList[e]) && u.target && n.priority >= t && this.unscheduleUpdate(n.target), s === this._updatesPosList.length && e++ } }, i.isScheduled = function (t, e) { at(Boolean(t), 1508), at(Boolean(e), 1509); var i = e.uuid || e.id; if (!i) return rt(1510), !1; var n = this._hashForTimers[i]; if (!n) return !1; if (null == n.timers) return !1; for (var r = n.timers, s = 0; s < r.length; ++s)if (t === r[s].getCallback()) return !0; return !1 }, i.pauseAllTargets = function () { return this.pauseAllTargetsWithMinPriority(2147483648) }, i.pauseAllTargetsWithMinPriority = function (t) { var e, i, n, r, s = [], a = this._arrayForTimers; for (i = 0, n = a.length; i < n; i++) { var o; null != (o = e = a[i]) && o.target && (e.paused = !0, s.push(e.target)) } if (t < 0) for (i = 0; i < this._updatesNegList.length; i++) { var u; null != (u = r = this._updatesNegList[i]) && u.target && r.priority >= t && (r.paused = !0, s.push(r.target)) } if (t <= 0) for (i = 0; i < this._updates0List.length; i++) { var h; null != (h = r = this._updates0List[i]) && h.target && (r.paused = !0, s.push(r.target)) } for (i = 0; i < this._updatesPosList.length; i++) { var c; null != (c = r = this._updatesPosList[i]) && c.target && r.priority >= t && (r.paused = !0, s.push(r.target)) } return s }, i.resumeTargets = function (t) { if (t) for (var e = 0; e < t.length; e++)this.resumeTarget(t[e]) }, i.pauseTarget = function (t) { at(Boolean(t), 1503); var e = t.uuid || t.id; if (e) { var i = this._hashForTimers[e]; i && (i.paused = !0); var n = this._hashForUpdates[e]; null != n && n.entry && (n.entry.paused = !0) } else rt(1510) }, i.resumeTarget = function (t) { at(Boolean(t), 1504); var e = t.uuid || t.id; if (e) { var i = this._hashForTimers[e]; i && (i.paused = !1); var n = this._hashForUpdates[e]; null != n && n.entry && (n.entry.paused = !1) } else rt(1510) }, i.isTargetPaused = function (t) { at(Boolean(t), 1505); var e = t.uuid || t.id; if (!e) return rt(1510), !1; var i = this._hashForTimers[e]; if (i) return i.paused; var n = this._hashForUpdates[e]; return !(null == n || !n.entry) && n.entry.paused }, i._removeHashElement = function (t) { if (t.target) { var e = t.target.uuid || t.target.id; if (void 0 !== e) { delete this._hashForTimers[e]; for (var i = this._arrayForTimers, n = 0, r = i.length; n < r; n++)if (i[n] === t) { i.splice(n, 1); break } Df.put(t) } } }, i._removeUpdateFromHash = function (t) { if (t.target) { var e = t.target.uuid || t.target.id; if (void 0 !== e) { var i = this._hashForUpdates[e]; if (i) { var n = i.list, r = i.entry; if (n) for (var s = 0, a = n.length; s < a; s++)if (n[s] === r) { n.splice(s, 1); break } delete this._hashForUpdates[e], r && Af.put(r), Cf.put(i) } } } }, i._priorityIn = function (t, e, i) { for (var n = 0; n < t.length; n++)if (i < t[n].priority) return void t.splice(n, 0, e); t.push(e) }, i._appendIn = function (t, e) { t.push(e) }, e }(If)); Pf.ID = "scheduler", T.Scheduler = Pf; var Bf = {}; lt(Bf, "vmath", [{ name: "vec2", newName: "Vec2", target: gs, targetName: "math" }, { name: "vec3", newName: "Vec3", target: gs, targetName: "math" }, { name: "vec4", newName: "Vec4", target: gs, targetName: "math" }, { name: "quat", newName: "Quat", target: gs, targetName: "math" }, { name: "mat3", newName: "Mat3", target: gs, targetName: "math" }, { name: "mat4", newName: "Mat4", target: gs, targetName: "math" }, { name: "color4", newName: "Color", target: gs, targetName: "math" }, { name: "rect", newName: "Rect", target: gs, targetName: "math" }, { name: "approx", newName: "approx", target: gs, targetName: "math" }, { name: "EPSILON", newName: "EPSILON", target: gs, targetName: "math" }, { name: "equals", newName: "equals", target: gs, targetName: "math" }, { name: "clamp", newName: "clamp", target: gs, targetName: "math" }, { name: "clamp01", newName: "clamp01", target: gs, targetName: "math" }, { name: "lerp", newName: "lerp", target: gs, targetName: "math" }, { name: "toRadian", newName: "toRadian", target: gs, targetName: "math" }, { name: "toDegree", newName: "toDegree", target: gs, targetName: "math" }, { name: "random", newName: "random", target: gs, targetName: "math" }, { name: "randomRange", newName: "randomRange", target: gs, targetName: "math" }, { name: "randomRangeInt", newName: "randomRangeInt", target: gs, targetName: "math" }, { name: "pseudoRandom", newName: "pseudoRandom", target: gs, targetName: "math" }, { name: "pseudoRandomRangeInt", newName: "pseudoRandomRangeInt", target: gs, targetName: "math" }, { name: "nextPow2", newName: "nextPow2", target: gs, targetName: "math" }, { name: "repeat", newName: "repeat", target: gs, targetName: "math" }, { name: "pingPong", newName: "pingPong", target: gs, targetName: "math" }, { name: "inverseLerp", newName: "inverseLerp", target: gs, targetName: "math" }]), T.vmath = Bf, lt(Pf.prototype, "Scheduler.prototype", [{ name: "enableForTarget", newName: "enableForTarget", target: Pf, targetName: "Scheduler" }]), lt(Pf, "Scheduler", [{ name: "PRIORITY_SYSTEM", newName: "System.Priority.SCHEDULER", customGetter: function () { return 2147483648 } }]), ft(Pf, "Scheduler", [{ name: "PRIORITY_NON_SYSTEM", suggest: "Use enum` System.Priority` instead" }]), dt(xe, "js", [{ name: "js", suggest: "'js.js' is deprecated since v3.7.0, please access 'js' directly instead." }]); var Mf = String.prototype.charCodeAt; function Of(t) { return this[t] } function Lf(t, e) { for (var i = t.length, n = e ^ i, r = 0, s = "string" == typeof t ? Mf : Of; i >= 4;) { var a = 255 & s.call(t, r) | (255 & s.call(t, ++r)) << 8 | (255 & s.call(t, ++r)) << 16 | (255 & s.call(t, ++r)) << 24; a = 1540483477 * (65535 & a) + ((1540483477 * (a >>> 16) & 65535) << 16), n = 1540483477 * (65535 & n) + ((1540483477 * (n >>> 16) & 65535) << 16) ^ (a = 1540483477 * (65535 & (a ^= a >>> 24)) + ((1540483477 * (a >>> 16) & 65535) << 16)), i -= 4, ++r } switch (i) { case 3: n ^= (255 & s.call(t, r + 2)) << 16; case 2: n ^= (255 & s.call(t, r + 1)) << 8; case 1: n = 1540483477 * (65535 & (n ^= 255 & s.call(t, r))) + ((1540483477 * (n >>> 16) & 65535) << 16) }return n = 1540483477 * (65535 & (n ^= n >>> 13)) + ((1540483477 * (n >>> 16) & 65535) << 16), (n ^= n >>> 15) >>> 0 } T.easing = Lc; var Ff = function () { function t() { this._finalizationRegistry = null, this._gcObjects = new WeakMap } var e = t.prototype; return e.registerGCObject = function (t) { return t }, e.init = function () { }, e.finalizationRegistryCallback = function () { }, e.destroy = function () { }, t }(), kf = t("garbageCollectionManager", new Ff), Nf = t("GCObject", function () { function t() { return kf.registerGCObject(this) } return t.prototype.destroy = function () { }, t }()); function zf(t, e) { for (var i, n = p(e); !(i = n()).done;) { var r = i.value; Array.isArray(r) ? zf(t, r) : t.push(r) } } function Uf(t) { var e = []; return zf(e, t), e.join("") } T.math = gs, T.geometry = Tf; var Vf = function (t, e, i) { for (var n = 0; n < e.length; ++n)t.length <= n && t.push(new i), t[n].copy(e[n]); t.length = e.length }, Gf = { UNKNOWN: 0, SWAPCHAIN: 1, BUFFER: 2, TEXTURE: 3, RENDER_PASS: 4, FRAMEBUFFER: 5, SAMPLER: 6, SHADER: 7, DESCRIPTOR_SET_LAYOUT: 8, PIPELINE_LAYOUT: 9, PIPELINE_STATE: 10, DESCRIPTOR_SET: 11, INPUT_ASSEMBLER: 12, COMMAND_BUFFER: 13, QUEUE: 14, QUERY_POOL: 15, GLOBAL_BARRIER: 16, TEXTURE_BARRIER: 17, BUFFER_BARRIER: 18, COUNT: 19 }, Hf = { UNREADY: 0, FAILED: 1, SUCCESS: 2 }, Wf = { UNKNOWN: 0, GLES2: 1, GLES3: 2, METAL: 3, VULKAN: 4, NVN: 5, WEBGL: 6, WEBGL2: 7, WEBGPU: 8 }, jf = { IDENTITY: 0, ROTATE_90: 1, ROTATE_180: 2, ROTATE_270: 3 }, Xf = { ELEMENT_INDEX_UINT: 0, INSTANCED_ARRAYS: 1, MULTIPLE_RENDER_TARGETS: 2, BLEND_MINMAX: 3, COMPUTE_SHADER: 4, INPUT_ATTACHMENT_BENEFIT: 5, SUBPASS_COLOR_INPUT: 6, SUBPASS_DEPTH_STENCIL_INPUT: 7, RASTERIZATION_ORDER_NOCOHERENT: 8, MULTI_SAMPLE_RESOLVE_DEPTH_STENCIL: 9, COUNT: 10 }, qf = { UNKNOWN: 0, A8: 1, L8: 2, LA8: 3, R8: 4, R8SN: 5, R8UI: 6, R8I: 7, R16F: 8, R16UI: 9, R16I: 10, R32F: 11, R32UI: 12, R32I: 13, RG8: 14, RG8SN: 15, RG8UI: 16, RG8I: 17, RG16F: 18, RG16UI: 19, RG16I: 20, RG32F: 21, RG32UI: 22, RG32I: 23, RGB8: 24, SRGB8: 25, RGB8SN: 26, RGB8UI: 27, RGB8I: 28, RGB16F: 29, RGB16UI: 30, RGB16I: 31, RGB32F: 32, RGB32UI: 33, RGB32I: 34, RGBA8: 35, BGRA8: 36, SRGB8_A8: 37, RGBA8SN: 38, RGBA8UI: 39, RGBA8I: 40, RGBA16F: 41, RGBA16UI: 42, RGBA16I: 43, RGBA32F: 44, RGBA32UI: 45, RGBA32I: 46, R5G6B5: 47, R11G11B10F: 48, RGB5A1: 49, RGBA4: 50, RGB10A2: 51, RGB10A2UI: 52, RGB9E5: 53, DEPTH: 54, DEPTH_STENCIL: 55, BC1: 56, BC1_ALPHA: 57, BC1_SRGB: 58, BC1_SRGB_ALPHA: 59, BC2: 60, BC2_SRGB: 61, BC3: 62, BC3_SRGB: 63, BC4: 64, BC4_SNORM: 65, BC5: 66, BC5_SNORM: 67, BC6H_UF16: 68, BC6H_SF16: 69, BC7: 70, BC7_SRGB: 71, ETC_RGB8: 72, ETC2_RGB8: 73, ETC2_SRGB8: 74, ETC2_RGB8_A1: 75, ETC2_SRGB8_A1: 76, ETC2_RGBA8: 77, ETC2_SRGB8_A8: 78, EAC_R11: 79, EAC_R11SN: 80, EAC_RG11: 81, EAC_RG11SN: 82, PVRTC_RGB2: 83, PVRTC_RGBA2: 84, PVRTC_RGB4: 85, PVRTC_RGBA4: 86, PVRTC2_2BPP: 87, PVRTC2_4BPP: 88, ASTC_RGBA_4X4: 89, ASTC_RGBA_5X4: 90, ASTC_RGBA_5X5: 91, ASTC_RGBA_6X5: 92, ASTC_RGBA_6X6: 93, ASTC_RGBA_8X5: 94, ASTC_RGBA_8X6: 95, ASTC_RGBA_8X8: 96, ASTC_RGBA_10X5: 97, ASTC_RGBA_10X6: 98, ASTC_RGBA_10X8: 99, ASTC_RGBA_10X10: 100, ASTC_RGBA_12X10: 101, ASTC_RGBA_12X12: 102, ASTC_SRGBA_4X4: 103, ASTC_SRGBA_5X4: 104, ASTC_SRGBA_5X5: 105, ASTC_SRGBA_6X5: 106, ASTC_SRGBA_6X6: 107, ASTC_SRGBA_8X5: 108, ASTC_SRGBA_8X6: 109, ASTC_SRGBA_8X8: 110, ASTC_SRGBA_10X5: 111, ASTC_SRGBA_10X6: 112, ASTC_SRGBA_10X8: 113, ASTC_SRGBA_10X10: 114, ASTC_SRGBA_12X10: 115, ASTC_SRGBA_12X12: 116, COUNT: 117 }, Yf = { NONE: 0, UNORM: 1, SNORM: 2, UINT: 3, INT: 4, UFLOAT: 5, FLOAT: 6 }, Kf = { FLOAT: 0, UNFILTERABLE_FLOAT: 1, SINT: 2, UINT: 3 }, Qf = { UNKNOWN: 0, BOOL: 1, BOOL2: 2, BOOL3: 3, BOOL4: 4, INT: 5, INT2: 6, INT3: 7, INT4: 8, UINT: 9, UINT2: 10, UINT3: 11, UINT4: 12, FLOAT: 13, FLOAT2: 14, FLOAT3: 15, FLOAT4: 16, MAT2: 17, MAT2X3: 18, MAT2X4: 19, MAT3X2: 20, MAT3: 21, MAT3X4: 22, MAT4X2: 23, MAT4X3: 24, MAT4: 25, SAMPLER1D: 26, SAMPLER1D_ARRAY: 27, SAMPLER2D: 28, SAMPLER2D_ARRAY: 29, SAMPLER3D: 30, SAMPLER_CUBE: 31, SAMPLER: 32, TEXTURE1D: 33, TEXTURE1D_ARRAY: 34, TEXTURE2D: 35, TEXTURE2D_ARRAY: 36, TEXTURE3D: 37, TEXTURE_CUBE: 38, IMAGE1D: 39, IMAGE1D_ARRAY: 40, IMAGE2D: 41, IMAGE2D_ARRAY: 42, IMAGE3D: 43, IMAGE_CUBE: 44, SUBPASS_INPUT: 45, COUNT: 46 }, Zf = { NONE: 0, TRANSFER_SRC: 1, TRANSFER_DST: 2, INDEX: 4, VERTEX: 8, UNIFORM: 16, STORAGE: 32, INDIRECT: 64 }, Jf = { NONE: 0, ENABLE_STAGING_WRITE: 1 }, $f = { NONE: 0, READ_ONLY: 1, WRITE_ONLY: 2, READ_WRITE: 3 }, td = { NONE: 0, DEVICE: 1, HOST: 2 }, ed = { TEX1D: 0, TEX2D: 1, TEX3D: 2, CUBE: 3, TEX1D_ARRAY: 4, TEX2D_ARRAY: 5 }, id = { UNKNOWN: 0, BUFFER: 1, TEX1D: 2, TEX1D_ARRAY: 3, TEX2D: 4, TEX2D_ARRAY: 5, TEX2DMS: 6, TEX2DMS_ARRAY: 7, TEX3D: 8, TEXCUBE: 9, TEXCUBE_ARRAY: 10, RAYTRACING_ACCELERATION_STRUCTURE: 11 }, nd = { NONE: 0, TRANSFER_SRC: 1, TRANSFER_DST: 2, SAMPLED: 4, STORAGE: 8, COLOR_ATTACHMENT: 16, DEPTH_STENCIL_ATTACHMENT: 32, INPUT_ATTACHMENT: 64, SHADING_RATE: 128 }, rd = { NONE: 0, GEN_MIPMAP: 1, GENERAL_LAYOUT: 2, EXTERNAL_OES: 4, EXTERNAL_NORMAL: 8, LAZILY_ALLOCATED: 16, MUTABLE_VIEW_FORMAT: 64, MUTABLE_STORAGE: 128 }, sd = { NONE: 0, RENDER_TARGET: 1, SAMPLED_TEXTURE: 2, LINEAR_FILTER: 4, STORAGE_TEXTURE: 8, VERTEX_ATTRIBUTE: 16, SHADING_RATE: 32 }, ad = { X1: 1, X2: 2, X4: 4, X8: 8, X16: 16, X32: 32, X64: 64 }, od = { OFF: 0, ON: 1, RELAXED: 2, MAILBOX: 3, HALF: 4 }, ud = { NONE: 0, POINT: 1, LINEAR: 2, ANISOTROPIC: 3 }, hd = { WRAP: 0, MIRROR: 1, CLAMP: 2, BORDER: 3 }, cd = { NEVER: 0, LESS: 1, EQUAL: 2, LESS_EQUAL: 3, GREATER: 4, NOT_EQUAL: 5, GREATER_EQUAL: 6, ALWAYS: 7 }, ld = { ZERO: 0, KEEP: 1, REPLACE: 2, INCR: 3, DECR: 4, INVERT: 5, INCR_WRAP: 6, DECR_WRAP: 7 }, fd = { ZERO: 0, ONE: 1, SRC_ALPHA: 2, DST_ALPHA: 3, ONE_MINUS_SRC_ALPHA: 4, ONE_MINUS_DST_ALPHA: 5, SRC_COLOR: 6, DST_COLOR: 7, ONE_MINUS_SRC_COLOR: 8, ONE_MINUS_DST_COLOR: 9, SRC_ALPHA_SATURATE: 10, CONSTANT_COLOR: 11, ONE_MINUS_CONSTANT_COLOR: 12, CONSTANT_ALPHA: 13, ONE_MINUS_CONSTANT_ALPHA: 14 }, dd = { ADD: 0, SUB: 1, REV_SUB: 2, MIN: 3, MAX: 4 }, pd = { NONE: 0, R: 1, G: 2, B: 4, A: 8, ALL: 15 }, _d = { NONE: 0, VERTEX: 1, CONTROL: 2, EVALUATION: 4, GEOMETRY: 8, FRAGMENT: 16, COMPUTE: 32, ALL: 63 }, gd = { LOAD: 0, CLEAR: 1, DISCARD: 2 }, md = { STORE: 0, DISCARD: 1 }, vd = { NONE: 0, INDIRECT_BUFFER: 1, INDEX_BUFFER: 2, VERTEX_BUFFER: 4, VERTEX_SHADER_READ_UNIFORM_BUFFER: 8, VERTEX_SHADER_READ_TEXTURE: 16, VERTEX_SHADER_READ_OTHER: 32, FRAGMENT_SHADER_READ_UNIFORM_BUFFER: 64, FRAGMENT_SHADER_READ_TEXTURE: 128, FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT: 256, FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT: 512, FRAGMENT_SHADER_READ_OTHER: 1024, COLOR_ATTACHMENT_READ: 2048, DEPTH_STENCIL_ATTACHMENT_READ: 4096, COMPUTE_SHADER_READ_UNIFORM_BUFFER: 8192, COMPUTE_SHADER_READ_TEXTURE: 16384, COMPUTE_SHADER_READ_OTHER: 32768, TRANSFER_READ: 65536, HOST_READ: 131072, PRESENT: 262144, VERTEX_SHADER_WRITE: 524288, FRAGMENT_SHADER_WRITE: 1048576, COLOR_ATTACHMENT_WRITE: 2097152, DEPTH_STENCIL_ATTACHMENT_WRITE: 4194304, COMPUTE_SHADER_WRITE: 8388608, TRANSFER_WRITE: 16777216, HOST_PREINITIALIZED: 33554432, HOST_WRITE: 67108864, SHADING_RATE: 134217728 }, yd = { NONE: 0, SAMPLE_ZERO: 1, AVERAGE: 2, MIN: 3, MAX: 4 }, bd = { GRAPHICS: 0, COMPUTE: 1, RAY_TRACING: 2 }, wd = { POINT_LIST: 0, LINE_LIST: 1, LINE_STRIP: 2, LINE_LOOP: 3, LINE_LIST_ADJACENCY: 4, LINE_STRIP_ADJACENCY: 5, ISO_LINE_LIST: 6, TRIANGLE_LIST: 7, TRIANGLE_STRIP: 8, TRIANGLE_FAN: 9, TRIANGLE_LIST_ADJACENCY: 10, TRIANGLE_STRIP_ADJACENCY: 11, TRIANGLE_PATCH_ADJACENCY: 12, QUAD_PATCH_LIST: 13 }, xd = { FILL: 0, POINT: 1, LINE: 2 }, Sd = { GOURAND: 0, FLAT: 1 }, Td = { NONE: 0, FRONT: 1, BACK: 2 }, Id = { NONE: 0, LINE_WIDTH: 1, DEPTH_BIAS: 2, BLEND_CONSTANTS: 4, DEPTH_BOUNDS: 8, STENCIL_WRITE_MASK: 16, STENCIL_COMPARE_MASK: 32 }, Ed = { FRONT: 1, BACK: 2, ALL: 3 }, Ad = { UNKNOWN: 0, UNIFORM_BUFFER: 1, DYNAMIC_UNIFORM_BUFFER: 2, STORAGE_BUFFER: 4, DYNAMIC_STORAGE_BUFFER: 8, SAMPLER_TEXTURE: 16, SAMPLER: 32, TEXTURE: 64, STORAGE_IMAGE: 128, INPUT_ATTACHMENT: 256 }, Cd = { GRAPHICS: 0, COMPUTE: 1, TRANSFER: 2 }, Dd = { OCCLUSION: 0, PIPELINE_STATISTICS: 1, TIMESTAMP: 2 }, Rd = { PRIMARY: 0, SECONDARY: 1 }, Pd = { NONE: 0, COLOR: 1, DEPTH: 2, STENCIL: 4, DEPTH_STENCIL: 6, ALL: 7 }, Bd = { FULL: 0, SPLIT_BEGIN: 1, SPLIT_END: 2 }, Md = { RASTER: 0, COMPUTE: 1, COPY: 2, MOVE: 3, RAYTRACE: 4, PRESENT: 5 }, Od = function () { function t(t, e, i) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 0), this.x = t, this.y = e, this.z = i } return t.prototype.copy = function (t) { return this.x = t.x, this.y = t.y, this.z = t.z, this }, t }(), Ld = function () { function t(t, e, i, n, r, s, a, o, u, h, c, l, f, d, p, _, g, m, v, y, b, w, x, S, T, I) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 0), void 0 === r && (r = 0), void 0 === s && (s = 0), void 0 === a && (a = 0), void 0 === o && (o = 0), void 0 === u && (u = 0), void 0 === h && (h = 0), void 0 === c && (c = 0), void 0 === l && (l = 0), void 0 === f && (f = 0), void 0 === d && (d = 0), void 0 === p && (p = 0), void 0 === _ && (_ = 1), void 0 === g && (g = 0), void 0 === m && (m = 0), void 0 === v && (v = new Od), void 0 === y && (y = new Od), void 0 === b && (b = !1), void 0 === w && (w = !1), void 0 === x && (x = !1), void 0 === S && (S = -1), void 0 === T && (T = 1), void 0 === I && (I = 1), this.maxVertexAttributes = t, this.maxVertexUniformVectors = e, this.maxFragmentUniformVectors = i, this.maxTextureUnits = n, this.maxImageUnits = r, this.maxVertexTextureUnits = s, this.maxColorRenderTargets = a, this.maxShaderStorageBufferBindings = o, this.maxShaderStorageBlockSize = u, this.maxUniformBufferBindings = h, this.maxUniformBlockSize = c, this.maxTextureSize = l, this.maxCubeMapTextureSize = f, this.maxArrayTextureLayers = d, this.max3DTextureSize = p, this.uboOffsetAlignment = _, this.maxComputeSharedMemorySize = g, this.maxComputeWorkGroupInvocations = m, this.maxComputeWorkGroupSize = v, this.maxComputeWorkGroupCount = y, this.supportQuery = b, this.supportVariableRateShading = w, this.supportSubPassShading = x, this.clipSpaceMinZ = S, this.screenSpaceSignY = T, this.clipSpaceSignY = I } return t.prototype.copy = function (t) { return this.maxVertexAttributes = t.maxVertexAttributes, this.maxVertexUniformVectors = t.maxVertexUniformVectors, this.maxFragmentUniformVectors = t.maxFragmentUniformVectors, this.maxTextureUnits = t.maxTextureUnits, this.maxImageUnits = t.maxImageUnits, this.maxVertexTextureUnits = t.maxVertexTextureUnits, this.maxColorRenderTargets = t.maxColorRenderTargets, this.maxShaderStorageBufferBindings = t.maxShaderStorageBufferBindings, this.maxShaderStorageBlockSize = t.maxShaderStorageBlockSize, this.maxUniformBufferBindings = t.maxUniformBufferBindings, this.maxUniformBlockSize = t.maxUniformBlockSize, this.maxTextureSize = t.maxTextureSize, this.maxCubeMapTextureSize = t.maxCubeMapTextureSize, this.maxArrayTextureLayers = t.maxArrayTextureLayers, this.max3DTextureSize = t.max3DTextureSize, this.uboOffsetAlignment = t.uboOffsetAlignment, this.maxComputeSharedMemorySize = t.maxComputeSharedMemorySize, this.maxComputeWorkGroupInvocations = t.maxComputeWorkGroupInvocations, this.maxComputeWorkGroupSize.copy(t.maxComputeWorkGroupSize), this.maxComputeWorkGroupCount.copy(t.maxComputeWorkGroupCount), this.supportQuery = t.supportQuery, this.supportVariableRateShading = t.supportVariableRateShading, this.supportSubPassShading = t.supportSubPassShading, this.clipSpaceMinZ = t.clipSpaceMinZ, this.screenSpaceSignY = t.screenSpaceSignY, this.clipSpaceSignY = t.clipSpaceSignY, this }, t }(), Fd = function () { function t(t) { void 0 === t && (t = !0), this.enableBarrierDeduce = t } return t.prototype.copy = function (t) { return this.enableBarrierDeduce = t.enableBarrierDeduce, this }, t }(), kd = function () { function t(t, e, i) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 0), this.x = t, this.y = e, this.z = i } return t.prototype.copy = function (t) { return this.x = t.x, this.y = t.y, this.z = t.z, this }, t }(), Nd = function () { function t(t, e, i, n) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 0), this.x = t, this.y = e, this.width = i, this.height = n } return t.prototype.copy = function (t) { return this.x = t.x, this.y = t.y, this.width = t.width, this.height = t.height, this }, t }(), zd = function () { function t(t, e, i) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 1), this.width = t, this.height = e, this.depth = i } return t.prototype.copy = function (t) { return this.width = t.width, this.height = t.height, this.depth = t.depth, this }, t }(), Ud = function () { function t(t, e, i) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 1), this.mipLevel = t, this.baseArrayLayer = e, this.layerCount = i } return t.prototype.copy = function (t) { return this.mipLevel = t.mipLevel, this.baseArrayLayer = t.baseArrayLayer, this.layerCount = t.layerCount, this }, t }(), Vd = function () { function t(t, e, i, n) { void 0 === t && (t = 0), void 0 === e && (e = 1), void 0 === i && (i = 0), void 0 === n && (n = 1), this.baseMipLevel = t, this.levelCount = e, this.baseArrayLayer = i, this.layerCount = n } return t.prototype.copy = function (t) { return this.baseMipLevel = t.baseMipLevel, this.levelCount = t.levelCount, this.baseArrayLayer = t.baseArrayLayer, this.layerCount = t.layerCount, this }, t }(), Gd = function () { function t(t, e, i, n, r) { void 0 === t && (t = new Ud), void 0 === e && (e = new kd), void 0 === i && (i = new Ud), void 0 === n && (n = new kd), void 0 === r && (r = new zd), this.srcSubres = t, this.srcOffset = e, this.dstSubres = i, this.dstOffset = n, this.extent = r } return t.prototype.copy = function (t) { return this.srcSubres.copy(t.srcSubres), this.srcOffset.copy(t.srcOffset), this.dstSubres.copy(t.dstSubres), this.dstOffset.copy(t.dstOffset), this.extent.copy(t.extent), this }, t }(), Hd = function () { function t(t, e, i, n, r, s) { void 0 === t && (t = new Ud), void 0 === e && (e = new kd), void 0 === i && (i = new zd), void 0 === n && (n = new Ud), void 0 === r && (r = new kd), void 0 === s && (s = new zd), this.srcSubres = t, this.srcOffset = e, this.srcExtent = i, this.dstSubres = n, this.dstOffset = r, this.dstExtent = s } return t.prototype.copy = function (t) { return this.srcSubres.copy(t.srcSubres), this.srcOffset.copy(t.srcOffset), this.srcExtent.copy(t.srcExtent), this.dstSubres.copy(t.dstSubres), this.dstOffset.copy(t.dstOffset), this.dstExtent.copy(t.dstExtent), this }, t }(), Wd = function () { function t(t, e, i, n, r, s) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = new kd), void 0 === r && (r = new zd), void 0 === s && (s = new Ud), this.buffOffset = t, this.buffStride = e, this.buffTexHeight = i, this.texOffset = n, this.texExtent = r, this.texSubres = s } return t.prototype.copy = function (t) { return this.buffOffset = t.buffOffset, this.buffStride = t.buffStride, this.buffTexHeight = t.buffTexHeight, this.texOffset.copy(t.texOffset), this.texExtent.copy(t.texExtent), this.texSubres.copy(t.texSubres), this }, t }(), jd = function () { function t(t, e, i, n, r, s) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 0), void 0 === r && (r = 0), void 0 === s && (s = 1), this.left = t, this.top = e, this.width = i, this.height = n, this.minDepth = r, this.maxDepth = s } var e = t.prototype; return e.copy = function (t) { return this.left = t.left, this.top = t.top, this.width = t.width, this.height = t.height, this.minDepth = t.minDepth, this.maxDepth = t.maxDepth, this }, e.reset = function () { this.left = 0, this.top = 0, this.width = 0, this.height = 0, this.minDepth = 0, this.maxDepth = 1 }, t }(), Xd = function () { function t(t, e, i, n) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 0), this.x = t, this.y = e, this.z = i, this.w = n } var e = t.prototype; return e.copy = function (t) { return this.x = t.x, this.y = t.y, this.z = t.z, this.w = t.w, this }, e.set = function (t, e, i, n) { return this.x = t, this.y = e, this.z = i, this.w = n, this }, e.reset = function () { this.x = 0, this.y = 0, this.z = 0, this.w = 0 }, t }(), qd = function () { function t(t, e) { void 0 === t && (t = ""), void 0 === e && (e = new Xd), this.name = t, this.color = e } return t.prototype.copy = function (t) { return this.name = t.name, this.color.copy(t.color), this }, t }(), Yd = function () { function t(t, e, i, n, r, s, a, o) { void 0 === t && (t = [0]), void 0 === e && (e = [0]), void 0 === i && (i = [0]), void 0 === n && (n = [0]), void 0 === r && (r = [0]), void 0 === s && (s = [0]), void 0 === a && (a = [0]), void 0 === o && (o = [0]), this.maxBlockCounts = t, this.maxSamplerTextureCounts = e, this.maxSamplerCounts = i, this.maxTextureCounts = n, this.maxBufferCounts = r, this.maxImageCounts = s, this.maxSubpassInputCounts = a, this.setIndices = o } return t.prototype.copy = function (t) { return this.maxBlockCounts = t.maxBlockCounts.slice(), this.maxSamplerTextureCounts = t.maxSamplerTextureCounts.slice(), this.maxSamplerCounts = t.maxSamplerCounts.slice(), this.maxTextureCounts = t.maxTextureCounts.slice(), this.maxBufferCounts = t.maxBufferCounts.slice(), this.maxImageCounts = t.maxImageCounts.slice(), this.maxSubpassInputCounts = t.maxSubpassInputCounts.slice(), this.setIndices = t.setIndices.slice(), this }, t }(), Kd = function () { function t(t, e, i, n, r) { void 0 === t && (t = 0), void 0 === e && (e = null), void 0 === i && (i = 1), void 0 === n && (n = 0), void 0 === r && (r = 0), this.windowId = t, this.windowHandle = e, this.vsyncMode = i, this.width = n, this.height = r } return t.prototype.copy = function (t) { return this.windowId = t.windowId, this.windowHandle = t.windowHandle, this.vsyncMode = t.vsyncMode, this.width = t.width, this.height = t.height, this }, t }(), Qd = function () { function t(t) { void 0 === t && (t = new Yd), this.bindingMappingInfo = t } return t.prototype.copy = function (t) { return this.bindingMappingInfo.copy(t.bindingMappingInfo), this }, t }(), Zd = function () { function t(t, e, i, n, r) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 1), void 0 === r && (r = 0), this.usage = t, this.memUsage = e, this.size = i, this.stride = n, this.flags = r } return t.prototype.copy = function (t) { return this.usage = t.usage, this.memUsage = t.memUsage, this.size = t.size, this.stride = t.stride, this.flags = t.flags, this }, t }(), Jd = function () { function t(t, e, i) { void 0 === t && (t = null), void 0 === e && (e = 0), void 0 === i && (i = 0), this.buffer = t, this.offset = e, this.range = i } return t.prototype.copy = function (t) { return this.buffer = t.buffer, this.offset = t.offset, this.range = t.range, this }, t }(), $d = function () { function t(t, e, i, n, r, s, a) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 0), void 0 === r && (r = 0), void 0 === s && (s = 0), void 0 === a && (a = 0), this.vertexCount = t, this.firstVertex = e, this.indexCount = i, this.firstIndex = n, this.vertexOffset = r, this.instanceCount = s, this.firstInstance = a } return t.prototype.copy = function (t) { return this.vertexCount = t.vertexCount, this.firstVertex = t.firstVertex, this.indexCount = t.indexCount, this.firstIndex = t.firstIndex, this.vertexOffset = t.vertexOffset, this.instanceCount = t.instanceCount, this.firstInstance = t.firstInstance, this }, t }(), tp = function () { function t(t, e, i, n, r) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = null), void 0 === r && (r = 0), this.groupCountX = t, this.groupCountY = e, this.groupCountZ = i, this.indirectBuffer = n, this.indirectOffset = r } return t.prototype.copy = function (t) { return this.groupCountX = t.groupCountX, this.groupCountY = t.groupCountY, this.groupCountZ = t.groupCountZ, this.indirectBuffer = t.indirectBuffer, this.indirectOffset = t.indirectOffset, this }, t }(), ep = function () { function t(t) { void 0 === t && (t = []), this.drawInfos = t } return t.prototype.copy = function (t) { return Vf(this.drawInfos, t.drawInfos, $d), this }, t }(), ip = function () { function t(t, e, i, n, r, s, a, o, u, h, c) { void 0 === t && (t = 1), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 0), void 0 === r && (r = 0), void 0 === s && (s = 0), void 0 === a && (a = 1), void 0 === o && (o = 1), void 0 === u && (u = 1), void 0 === h && (h = 1), void 0 === c && (c = 0), this.type = t, this.usage = e, this.format = i, this.width = n, this.height = r, this.flags = s, this.layerCount = a, this.levelCount = o, this.samples = u, this.depth = h, this.externalRes = c } return t.prototype.copy = function (t) { return this.type = t.type, this.usage = t.usage, this.format = t.format, this.width = t.width, this.height = t.height, this.flags = t.flags, this.layerCount = t.layerCount, this.levelCount = t.levelCount, this.samples = t.samples, this.depth = t.depth, this.externalRes = t.externalRes, this }, t }(), np = function () { function t(t, e, i, n, r, s, a, o, u) { void 0 === t && (t = null), void 0 === e && (e = 1), void 0 === i && (i = 0), void 0 === n && (n = 0), void 0 === r && (r = 1), void 0 === s && (s = 0), void 0 === a && (a = 1), void 0 === o && (o = 0), void 0 === u && (u = 1), this.texture = t, this.type = e, this.format = i, this.baseLevel = n, this.levelCount = r, this.baseLayer = s, this.layerCount = a, this.basePlane = o, this.planeCount = u } return t.prototype.copy = function (t) { return this.texture = t.texture, this.type = t.type, this.format = t.format, this.baseLevel = t.baseLevel, this.levelCount = t.levelCount, this.baseLayer = t.baseLayer, this.layerCount = t.layerCount, this.basePlane = t.basePlane, this.planeCount = t.planeCount, this }, t }(), rp = function () { function t(t, e, i, n, r, s, a, o) { void 0 === t && (t = 2), void 0 === e && (e = 2), void 0 === i && (i = 0), void 0 === n && (n = 0), void 0 === r && (r = 0), void 0 === s && (s = 0), void 0 === a && (a = 0), void 0 === o && (o = 7), this.minFilter = t, this.magFilter = e, this.mipFilter = i, this.addressU = n, this.addressV = r, this.addressW = s, this.maxAnisotropy = a, this.cmpFunc = o } return t.prototype.copy = function (t) { return this.minFilter = t.minFilter, this.magFilter = t.magFilter, this.mipFilter = t.mipFilter, this.addressU = t.addressU, this.addressV = t.addressV, this.addressW = t.addressW, this.maxAnisotropy = t.maxAnisotropy, this.cmpFunc = t.cmpFunc, this }, t }(), sp = function () { function t(t, e, i) { void 0 === t && (t = ""), void 0 === e && (e = 0), void 0 === i && (i = 0), this.name = t, this.type = e, this.count = i } return t.prototype.copy = function (t) { return this.name = t.name, this.type = t.type, this.count = t.count, this }, t }(), ap = function () { function t(t, e, i, n, r, s) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = ""), void 0 === n && (n = []), void 0 === r && (r = 0), void 0 === s && (s = 0), this.set = t, this.binding = e, this.name = i, this.members = n, this.count = r, this.flattened = s } return t.prototype.copy = function (t) { return this.set = t.set, this.binding = t.binding, this.name = t.name, Vf(this.members, t.members, sp), this.count = t.count, this.flattened = t.flattened, this }, t }(), op = function () { function t(t, e, i, n, r, s) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = ""), void 0 === n && (n = 0), void 0 === r && (r = 0), void 0 === s && (s = 0), this.set = t, this.binding = e, this.name = i, this.type = n, this.count = r, this.flattened = s } return t.prototype.copy = function (t) { return this.set = t.set, this.binding = t.binding, this.name = t.name, this.type = t.type, this.count = t.count, this.flattened = t.flattened, this }, t }(), up = function () { function t(t, e, i, n, r) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = ""), void 0 === n && (n = 0), void 0 === r && (r = 0), this.set = t, this.binding = e, this.name = i, this.count = n, this.flattened = r } return t.prototype.copy = function (t) { return this.set = t.set, this.binding = t.binding, this.name = t.name, this.count = t.count, this.flattened = t.flattened, this }, t }(), hp = function () { function t(t, e, i, n, r, s) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = ""), void 0 === n && (n = 0), void 0 === r && (r = 0), void 0 === s && (s = 0), this.set = t, this.binding = e, this.name = i, this.type = n, this.count = r, this.flattened = s } return t.prototype.copy = function (t) { return this.set = t.set, this.binding = t.binding, this.name = t.name, this.type = t.type, this.count = t.count, this.flattened = t.flattened, this }, t }(), cp = function () { function t(t, e, i, n, r, s, a) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = ""), void 0 === n && (n = 0), void 0 === r && (r = 0), void 0 === s && (s = 3), void 0 === a && (a = 0), this.set = t, this.binding = e, this.name = i, this.type = n, this.count = r, this.memoryAccess = s, this.flattened = a } return t.prototype.copy = function (t) { return this.set = t.set, this.binding = t.binding, this.name = t.name, this.type = t.type, this.count = t.count, this.memoryAccess = t.memoryAccess, this.flattened = t.flattened, this }, t }(), lp = function () { function t(t, e, i, n, r, s) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = ""), void 0 === n && (n = 0), void 0 === r && (r = 3), void 0 === s && (s = 0), this.set = t, this.binding = e, this.name = i, this.count = n, this.memoryAccess = r, this.flattened = s } return t.prototype.copy = function (t) { return this.set = t.set, this.binding = t.binding, this.name = t.name, this.count = t.count, this.memoryAccess = t.memoryAccess, this.flattened = t.flattened, this }, t }(), fp = function () { function t(t, e, i, n, r) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = ""), void 0 === n && (n = 0), void 0 === r && (r = 0), this.set = t, this.binding = e, this.name = i, this.count = n, this.flattened = r } return t.prototype.copy = function (t) { return this.set = t.set, this.binding = t.binding, this.name = t.name, this.count = t.count, this.flattened = t.flattened, this }, t }(), dp = function () { function t(t, e) { void 0 === t && (t = 0), void 0 === e && (e = ""), this.stage = t, this.source = e } return t.prototype.copy = function (t) { return this.stage = t.stage, this.source = t.source, this }, t }(), pp = function () { function t(t, e, i, n, r, s) { void 0 === t && (t = ""), void 0 === e && (e = 0), void 0 === i && (i = !1), void 0 === n && (n = 0), void 0 === r && (r = !1), void 0 === s && (s = 0), this.name = t, this.format = e, this.isNormalized = i, this.stream = n, this.isInstanced = r, this.location = s } return t.prototype.copy = function (t) { return this.name = t.name, this.format = t.format, this.isNormalized = t.isNormalized, this.stream = t.stream, this.isInstanced = t.isInstanced, this.location = t.location, this }, t }(), _p = function () { function t(t, e, i, n, r, s, a, o, u, h, c) { void 0 === t && (t = ""), void 0 === e && (e = []), void 0 === i && (i = []), void 0 === n && (n = []), void 0 === r && (r = []), void 0 === s && (s = []), void 0 === a && (a = []), void 0 === o && (o = []), void 0 === u && (u = []), void 0 === h && (h = []), void 0 === c && (c = 4294967295), this.name = t, this.stages = e, this.attributes = i, this.blocks = n, this.buffers = r, this.samplerTextures = s, this.samplers = a, this.textures = o, this.images = u, this.subpassInputs = h, this.hash = c } return t.prototype.copy = function (t) { return this.name = t.name, Vf(this.stages, t.stages, dp), Vf(this.attributes, t.attributes, pp), Vf(this.blocks, t.blocks, ap), Vf(this.buffers, t.buffers, lp), Vf(this.samplerTextures, t.samplerTextures, op), Vf(this.samplers, t.samplers, up), Vf(this.textures, t.textures, hp), Vf(this.images, t.images, cp), Vf(this.subpassInputs, t.subpassInputs, fp), this.hash = t.hash, this }, t }(), gp = function () { function t(t, e, i, n) { void 0 === t && (t = []), void 0 === e && (e = []), void 0 === i && (i = null), void 0 === n && (n = null), this.attributes = t, this.vertexBuffers = e, this.indexBuffer = i, this.indirectBuffer = n } return t.prototype.copy = function (t) { return Vf(this.attributes, t.attributes, pp), this.vertexBuffers = t.vertexBuffers.slice(), this.indexBuffer = t.indexBuffer, this.indirectBuffer = t.indirectBuffer, this }, t }(), mp = function () { function t(t, e, i, n, r) { void 0 === t && (t = 0), void 0 === e && (e = 1), void 0 === i && (i = 1), void 0 === n && (n = 0), void 0 === r && (r = null), this.format = t, this.sampleCount = e, this.loadOp = i, this.storeOp = n, this.barrier = r } return t.prototype.copy = function (t) { return this.format = t.format, this.sampleCount = t.sampleCount, this.loadOp = t.loadOp, this.storeOp = t.storeOp, this.barrier = t.barrier, this }, t }(), vp = function () { function t(t, e, i, n, r, s, a) { void 0 === t && (t = 0), void 0 === e && (e = 1), void 0 === i && (i = 1), void 0 === n && (n = 0), void 0 === r && (r = 1), void 0 === s && (s = 0), void 0 === a && (a = null), this.format = t, this.sampleCount = e, this.depthLoadOp = i, this.depthStoreOp = n, this.stencilLoadOp = r, this.stencilStoreOp = s, this.barrier = a } return t.prototype.copy = function (t) { return this.format = t.format, this.sampleCount = t.sampleCount, this.depthLoadOp = t.depthLoadOp, this.depthStoreOp = t.depthStoreOp, this.stencilLoadOp = t.stencilLoadOp, this.stencilStoreOp = t.stencilStoreOp, this.barrier = t.barrier, this }, t }(), yp = function () { function t(t, e, i, n, r, s, a, o, u) { void 0 === t && (t = []), void 0 === e && (e = []), void 0 === i && (i = []), void 0 === n && (n = []), void 0 === r && (r = -1), void 0 === s && (s = -1), void 0 === a && (a = -1), void 0 === o && (o = 0), void 0 === u && (u = 0), this.inputs = t, this.colors = e, this.resolves = i, this.preserves = n, this.depthStencil = r, this.depthStencilResolve = s, this.shadingRate = a, this.depthResolveMode = o, this.stencilResolveMode = u } return t.prototype.copy = function (t) { return this.inputs = t.inputs.slice(), this.colors = t.colors.slice(), this.resolves = t.resolves.slice(), this.preserves = t.preserves.slice(), this.depthStencil = t.depthStencil, this.depthStencilResolve = t.depthStencilResolve, this.shadingRate = t.shadingRate, this.depthResolveMode = t.depthResolveMode, this.stencilResolveMode = t.stencilResolveMode, this }, t }(), bp = function () { function t(t, e, i, n, r) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = null), void 0 === n && (n = 0), void 0 === r && (r = 0), this.srcSubpass = t, this.dstSubpass = e, this.generalBarrier = i, this.prevAccesses = n, this.nextAccesses = r } return t.prototype.copy = function (t) { return this.srcSubpass = t.srcSubpass, this.dstSubpass = t.dstSubpass, this.generalBarrier = t.generalBarrier, this.prevAccesses = t.prevAccesses, this.nextAccesses = t.nextAccesses, this }, t }(), wp = function () { function t(t, e, i, n, r) { void 0 === t && (t = []), void 0 === e && (e = new vp), void 0 === i && (i = new vp), void 0 === n && (n = []), void 0 === r && (r = []), this.colorAttachments = t, this.depthStencilAttachment = e, this.depthStencilResolveAttachment = i, this.subpasses = n, this.dependencies = r } return t.prototype.copy = function (t) { return Vf(this.colorAttachments, t.colorAttachments, mp), this.depthStencilAttachment.copy(t.depthStencilAttachment), this.depthStencilResolveAttachment.copy(t.depthStencilResolveAttachment), Vf(this.subpasses, t.subpasses, yp), Vf(this.dependencies, t.dependencies, bp), this }, t }(), xp = function () { function t(t, e, i, n, r, s, a, o, u) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 0), void 0 === r && (r = 0), void 0 === s && (s = 0), void 0 === a && (a = 0), void 0 === o && (o = 0), void 0 === u && (u = 0), this.width = t, this.height = e, this.depthOrArraySize = i, this.firstSlice = n, this.numSlices = r, this.mipLevel = s, this.levelCount = a, this.basePlane = o, this.planeCount = u } return t.prototype.copy = function (t) { return this.width = t.width, this.height = t.height, this.depthOrArraySize = t.depthOrArraySize, this.firstSlice = t.firstSlice, this.numSlices = t.numSlices, this.mipLevel = t.mipLevel, this.levelCount = t.levelCount, this.basePlane = t.basePlane, this.planeCount = t.planeCount, this }, t }(), Sp = function () { function t(t, e, i) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 0), this.prevAccesses = t, this.nextAccesses = e, this.type = i } return t.prototype.copy = function (t) { return this.prevAccesses = t.prevAccesses, this.nextAccesses = t.nextAccesses, this.type = t.type, this }, t }(), Tp = function () { function t(t, e, i, n, r, s, a) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = new xp), void 0 === r && (r = !1), void 0 === s && (s = null), void 0 === a && (a = null), this.prevAccesses = t, this.nextAccesses = e, this.type = i, this.range = n, this.discardContents = r, this.srcQueue = s, this.dstQueue = a } return t.prototype.copy = function (t) { return this.prevAccesses = t.prevAccesses, this.nextAccesses = t.nextAccesses, this.type = t.type, this.range.copy(t.range), this.discardContents = t.discardContents, this.srcQueue = t.srcQueue, this.dstQueue = t.dstQueue, this }, t }(), Ip = function () { function t(t, e, i, n, r, s, a, o) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 0), void 0 === r && (r = 0), void 0 === s && (s = !1), void 0 === a && (a = null), void 0 === o && (o = null), this.prevAccesses = t, this.nextAccesses = e, this.type = i, this.offset = n, this.size = r, this.discardContents = s, this.srcQueue = a, this.dstQueue = o } return t.prototype.copy = function (t) { return this.prevAccesses = t.prevAccesses, this.nextAccesses = t.nextAccesses, this.type = t.type, this.offset = t.offset, this.size = t.size, this.discardContents = t.discardContents, this.srcQueue = t.srcQueue, this.dstQueue = t.dstQueue, this }, t }(), Ep = function () { function t(t, e, i, n) { void 0 === t && (t = null), void 0 === e && (e = []), void 0 === i && (i = null), void 0 === n && (n = null), this.renderPass = t, this.colorTextures = e, this.depthStencilTexture = i, this.depthStencilResolveTexture = n } return t.prototype.copy = function (t) { return this.renderPass = t.renderPass, this.colorTextures = t.colorTextures.slice(), this.depthStencilTexture = t.depthStencilTexture, this.depthStencilResolveTexture = t.depthStencilResolveTexture, this }, t }(), Ap = function () { function t(t, e, i, n, r, s, a, o, u) { void 0 === t && (t = -1), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 0), void 0 === r && (r = 1), void 0 === s && (s = 0), void 0 === a && (a = 0), void 0 === o && (o = 0), void 0 === u && (u = []), this.binding = t, this.descriptorType = e, this.count = i, this.stageFlags = n, this.access = r, this.viewDimension = s, this.sampleType = a, this.format = o, this.immutableSamplers = u } return t.prototype.copy = function (t) { return this.binding = t.binding, this.descriptorType = t.descriptorType, this.count = t.count, this.stageFlags = t.stageFlags, this.access = t.access, this.viewDimension = t.viewDimension, this.sampleType = t.sampleType, this.format = t.format, this.immutableSamplers = t.immutableSamplers.slice(), this }, t }(), Cp = function () { function t(t) { void 0 === t && (t = []), this.bindings = t } return t.prototype.copy = function (t) { return Vf(this.bindings, t.bindings, Ap), this }, t }(), Dp = function () { function t(t) { void 0 === t && (t = null), this.layout = t } return t.prototype.copy = function (t) { return this.layout = t.layout, this }, t }(), Rp = function () { function t(t) { void 0 === t && (t = []), this.setLayouts = t } return t.prototype.copy = function (t) { return this.setLayouts = t.setLayouts.slice(), this }, t }(), Pp = function () { function t(t) { void 0 === t && (t = []), this.attributes = t } return t.prototype.copy = function (t) { return Vf(this.attributes, t.attributes, pp), this }, t }(), Bp = function () { function t(t, e) { void 0 === t && (t = null), void 0 === e && (e = 0), this.queue = t, this.type = e } return t.prototype.copy = function (t) { return this.queue = t.queue, this.type = t.type, this }, t }(), Mp = function () { function t(t) { void 0 === t && (t = 0), this.type = t } return t.prototype.copy = function (t) { return this.type = t.type, this }, t }(), Op = function () { function t(t, e, i) { void 0 === t && (t = 0), void 0 === e && (e = 32767), void 0 === i && (i = !0), this.type = t, this.maxQueryObjects = e, this.forceWait = i } return t.prototype.copy = function (t) { return this.type = t.type, this.maxQueryObjects = t.maxQueryObjects, this.forceWait = t.forceWait, this }, t }(), Lp = function () { function t(t, e, i, n, r, s, a, o) { void 0 === t && (t = ""), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 0), void 0 === r && (r = !1), void 0 === s && (s = !1), void 0 === a && (a = !1), void 0 === o && (o = !1), this.name = t, this.size = e, this.count = i, this.type = n, this.hasAlpha = r, this.hasDepth = s, this.hasStencil = a, this.isCompressed = o } return t.prototype.copy = function (t) { return this.name = t.name, this.size = t.size, this.count = t.count, this.type = t.type, this.hasAlpha = t.hasAlpha, this.hasDepth = t.hasDepth, this.hasStencil = t.hasStencil, this.isCompressed = t.isCompressed, this }, t }(), Fp = function () { function t(t, e) { void 0 === t && (t = 0), void 0 === e && (e = 0), this.bufferSize = t, this.textureSize = e } return t.prototype.copy = function (t) { return this.bufferSize = t.bufferSize, this.textureSize = t.textureSize, this }, t }(), kp = function () { function t(t, e, i) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 0), this.writeMask = t, this.compareMask = e, this.reference = i } return t.prototype.copy = function (t) { return this.writeMask = t.writeMask, this.compareMask = t.compareMask, this.reference = t.reference, this }, t }(), Np = function () { function t(t, e, i, n, r, s, a, o, u, h, c) { void 0 === t && (t = new jd), void 0 === e && (e = new Nd), void 0 === i && (i = new Xd), void 0 === n && (n = 1), void 0 === r && (r = 0), void 0 === s && (s = 0), void 0 === a && (a = 0), void 0 === o && (o = 0), void 0 === u && (u = 0), void 0 === h && (h = new kp), void 0 === c && (c = new kp), this.viewport = t, this.scissor = e, this.blendConstant = i, this.lineWidth = n, this.depthBiasConstant = r, this.depthBiasClamp = s, this.depthBiasSlope = a, this.depthMinBounds = o, this.depthMaxBounds = u, this.stencilStatesFront = h, this.stencilStatesBack = c } return t.prototype.copy = function (t) { return this.viewport.copy(t.viewport), this.scissor.copy(t.scissor), this.blendConstant.copy(t.blendConstant), this.lineWidth = t.lineWidth, this.depthBiasConstant = t.depthBiasConstant, this.depthBiasClamp = t.depthBiasClamp, this.depthBiasSlope = t.depthBiasSlope, this.depthMinBounds = t.depthMinBounds, this.depthMaxBounds = t.depthMaxBounds, this.stencilStatesFront.copy(t.stencilStatesFront), this.stencilStatesBack.copy(t.stencilStatesBack), this }, t }(), zp = function (t) { function e(i) { var n; return (n = t.call(this) || this)._objectType = 0, n._objectID = 0, n._typedID = 0, n._objectType = i, n._objectID = e._idTable[0]++, n._typedID = e._idTable[i]++, n } return s(e, t), n(e, [{ key: "objectType", get: function () { return this._objectType } }, { key: "objectID", get: function () { return this._objectID } }, { key: "typedID", get: function () { return this._typedID } }]), e }(Nf); zp._idTable = Array(19).fill(65536); var Up = { ATTR_POSITION: "a_position", ATTR_NORMAL: "a_normal", ATTR_TANGENT: "a_tangent", ATTR_BITANGENT: "a_bitangent", ATTR_WEIGHTS: "a_weights", ATTR_JOINTS: "a_joints", ATTR_COLOR: "a_color", ATTR_COLOR1: "a_color1", ATTR_COLOR2: "a_color2", ATTR_TEX_COORD: "a_texCoord", ATTR_TEX_COORD1: "a_texCoord1", ATTR_TEX_COORD2: "a_texCoord2", ATTR_TEX_COORD3: "a_texCoord3", ATTR_TEX_COORD4: "a_texCoord4", ATTR_TEX_COORD5: "a_texCoord5", ATTR_TEX_COORD6: "a_texCoord6", ATTR_TEX_COORD7: "a_texCoord7", ATTR_TEX_COORD8: "a_texCoord8", ATTR_BATCH_ID: "a_batch_id", ATTR_BATCH_UV: "a_batch_uv" }; function Vp(t, e, i, n, r, s, a, o) { return new Lp(t, e, i, n, r, s, a, o) } function Gp(t) { return new Lp("ASTC_SRGBA_" + t, 1, 4, 1, !0, !1, !1, !0) } function Hp(t) { return new Lp("ASTC_RGBA_" + t, 1, 4, 1, !0, !1, !1, !0) } var Wp = Object.freeze([Vp("UNKNOWN"), Vp("A8", 1, 1, 1, !0), Vp("L8", 1, 1, 1), Vp("LA8", 1, 2, 1, !0), Vp("R8", 1, 1, 1), Vp("R8SN", 1, 1, 2), Vp("R8UI", 1, 1, 3), Vp("R8I", 1, 1, 4), Vp("R16F", 2, 1, 6), Vp("R16UI", 2, 1, 3), Vp("R16I", 2, 1, 4), Vp("R32F", 4, 1, 6), Vp("R32UI", 4, 1, 3), Vp("R32I", 4, 1, 4), Vp("RG8", 2, 2, 1), Vp("RG8SN", 2, 2, 2), Vp("RG8UI", 2, 2, 3), Vp("RG8I", 2, 2, 4), Vp("RG16F", 4, 2, 6), Vp("RG16UI", 4, 2, 3), Vp("RG16I", 4, 2, 4), Vp("RG32F", 8, 2, 6), Vp("RG32UI", 8, 2, 3), Vp("RG32I", 8, 2, 4), Vp("RGB8", 3, 3, 1), Vp("SRGB8", 3, 3, 1), Vp("RGB8SN", 3, 3, 2), Vp("RGB8UI", 3, 3, 3), Vp("RGB8I", 3, 3, 4), Vp("RGB16F", 6, 3, 6), Vp("RGB16UI", 6, 3, 3), Vp("RGB16I", 6, 3, 4), Vp("RGB32F", 12, 3, 6), Vp("RGB32UI", 12, 3, 3), Vp("RGB32I", 12, 3, 4), Vp("RGBA8", 4, 4, 1, !0), Vp("BGRA8", 4, 4, 1, !0), Vp("SRGB8_A8", 4, 4, 1, !0), Vp("RGBA8SN", 4, 4, 2, !0), Vp("RGBA8UI", 4, 4, 3, !0), Vp("RGBA8I", 4, 4, 4, !0), Vp("RGBA16F", 8, 4, 6, !0), Vp("RGBA16UI", 8, 4, 3, !0), Vp("RGBA16I", 8, 4, 4, !0), Vp("RGBA32F", 16, 4, 6, !0), Vp("RGBA32UI", 16, 4, 3, !0), Vp("RGBA32I", 16, 4, 4, !0), Vp("R5G6B5", 2, 3, 1), Vp("R11G11B10F", 4, 3, 6), Vp("RGB5A1", 2, 4, 1, !0), Vp("RGBA4", 2, 4, 1, !0), Vp("RGB10A2", 2, 4, 1, !0), Vp("RGB10A2UI", 2, 4, 3, !0), Vp("RGB9E5", 2, 4, 6, !0), Vp("DEPTH", 4, 1, 6, !1, !0), Vp("DEPTH_STENCIL", 5, 2, 6, !1, !0, !0), Vp("BC1", 1, 3, 1, !1, !1, !1, !0), Vp("BC1_ALPHA", 1, 4, 1, !0, !1, !1, !0), Vp("BC1_SRGB", 1, 3, 1, !1, !1, !1, !0), Vp("BC1_SRGB_ALPHA", 1, 4, 1, !0, !1, !1, !0), Vp("BC2", 1, 4, 1, !0, !1, !1, !0), Vp("BC2_SRGB", 1, 4, 1, !0, !1, !1, !0), Vp("BC3", 1, 4, 1, !0, !1, !1, !0), Vp("BC3_SRGB", 1, 4, 1, !0, !1, !1, !0), Vp("BC4", 1, 1, 1, !1, !1, !1, !0), Vp("BC4_SNORM", 1, 1, 2, !1, !1, !1, !0), Vp("BC5", 1, 2, 1, !1, !1, !1, !0), Vp("BC5_SNORM", 1, 2, 2, !1, !1, !1, !0), Vp("BC6H_UF16", 1, 3, 5, !1, !1, !1, !0), Vp("BC6H_SF16", 1, 3, 6, !1, !1, !1, !0), Vp("BC7", 1, 4, 1, !0, !1, !1, !0), Vp("BC7_SRGB", 1, 4, 1, !0, !1, !1, !0), Vp("ETC_RGB8", 1, 3, 1, !1, !1, !1, !0), Vp("ETC2_RGB8", 1, 3, 1, !1, !1, !1, !0), Vp("ETC2_SRGB8", 1, 3, 1, !1, !1, !1, !0), Vp("ETC2_RGB8_A1", 1, 4, 1, !0, !1, !1, !0), Vp("ETC2_SRGB8_A1", 1, 4, 1, !0, !1, !1, !0), Vp("ETC2_RGBA8", 2, 4, 1, !0, !1, !1, !0), Vp("ETC2_SRGB8_A8", 2, 4, 1, !0, !1, !1, !0), Vp("EAC_R11", 1, 1, 1, !1, !1, !1, !0), Vp("EAC_R11SN", 1, 1, 2, !1, !1, !1, !0), Vp("EAC_RG11", 2, 2, 1, !1, !1, !1, !0), Vp("EAC_RG11SN", 2, 2, 2, !1, !1, !1, !0), Vp("PVRTC_RGB2", 2, 3, 1, !1, !1, !1, !0), Vp("PVRTC_RGBA2", 2, 4, 1, !0, !1, !1, !0), Vp("PVRTC_RGB4", 2, 3, 1, !1, !1, !1, !0), Vp("PVRTC_RGBA4", 2, 4, 1, !0, !1, !1, !0), Vp("PVRTC2_2BPP", 2, 4, 1, !0, !1, !1, !0), Vp("PVRTC2_4BPP", 2, 4, 1, !0, !1, !1, !0), Hp("4x4"), Hp("5x4"), Hp("5x5"), Hp("6x5"), Hp("6x6"), Hp("8x5"), Hp("8x6"), Hp("8x8"), Hp("10x5"), Hp("10x6"), Hp("10x8"), Hp("10x10"), Hp("12x10"), Hp("12x12"), Gp("4x4"), Gp("5x4"), Gp("5x5"), Gp("6x5"), Gp("6x6"), Gp("8x5"), Gp("8x6"), Gp("8x8"), Gp("10x5"), Gp("10x6"), Gp("10x8"), Gp("10x10"), Gp("12x10"), Gp("12x12")]), jp = 15, Xp = 496; function qp(t) { return t > 0 && !(t & t - 1) } var Yp = Math.ceil; function Kp(t, e, i, n) { if (!Wp[t].isCompressed) return e * i * n * Wp[t].size; switch (t) { case 56: case 57: case 58: case 59: case 72: case 73: case 74: case 75: case 79: case 80: case 85: case 86: case 88: return Yp(e / 4) * Yp(i / 4) * 8 * n; case 60: case 61: case 62: case 63: case 64: case 65: case 69: case 68: case 70: case 71: case 77: case 76: case 81: case 82: case 89: case 103: return Yp(e / 4) * Yp(i / 4) * 16 * n; case 66: case 67: return Yp(e / 4) * Yp(i / 4) * 32 * n; case 83: case 84: case 87: return Yp(e / 8) * Yp(i / 4) * 8 * n; case 90: case 104: return Yp(e / 5) * Yp(i / 4) * 16 * n; case 91: case 105: return Yp(e / 5) * Yp(i / 5) * 16 * n; case 92: case 106: return Yp(e / 6) * Yp(i / 5) * 16 * n; case 93: case 107: return Yp(e / 6) * Yp(i / 6) * 16 * n; case 94: case 108: return Yp(e / 8) * Yp(i / 5) * 16 * n; case 95: case 109: return Yp(e / 8) * Yp(i / 6) * 16 * n; case 96: case 110: return Yp(e / 8) * Yp(i / 8) * 16 * n; case 97: case 111: return Yp(e / 10) * Yp(i / 5) * 16 * n; case 98: case 112: return Yp(e / 10) * Yp(i / 6) * 16 * n; case 99: case 113: return Yp(e / 10) * Yp(i / 8) * 16 * n; case 100: case 114: return Yp(e / 10) * Yp(i / 10) * 16 * n; case 101: case 115: return Yp(e / 12) * Yp(i / 10) * 16 * n; case 102: case 116: return Yp(e / 12) * Yp(i / 12) * 16 * n; default: return 0 } } function Qp(t, e, i, n, r) { for (var s = 0, a = 0; a < r; ++a)s += Kp(t, e, i, n), e = Math.max(e >> 1, 1), i = Math.max(i >> 1, 1); return s } var Zp = [0, 4, 8, 12, 16, 4, 8, 12, 16, 4, 8, 12, 16, 4, 8, 12, 16, 16, 24, 32, 24, 36, 48, 32, 48, 64, 4, 4, 4, 4, 4, 4]; function Jp(t) { return Zp[t] || 0 } function $p(t) { if (t.isCompressed) return Uint8Array; var e = t.size / t.count; switch (t.type) { case 1: case 3: switch (e) { case 1: default: return Uint8Array; case 2: return Uint16Array; case 4: return Uint32Array }case 2: case 4: switch (e) { case 1: default: return Int8Array; case 2: return Int16Array; case 4: return Int32Array }case 6: return 2 === e ? Uint16Array : Float32Array }return Float32Array } function t_(t) { switch (t) { case 56: case 57: case 58: case 59: case 60: case 61: case 62: case 63: case 64: case 65: case 69: case 68: case 70: case 71: case 66: case 67: case 72: case 73: case 74: case 75: case 79: case 80: case 77: case 76: case 81: case 82: case 85: case 86: case 88: case 89: case 103: return { width: 4, height: 4 }; case 83: case 84: case 87: return { width: 8, height: 4 }; case 90: case 104: return { width: 5, height: 4 }; case 91: case 105: return { width: 5, height: 5 }; case 92: case 106: return { width: 6, height: 5 }; case 93: case 107: return { width: 6, height: 6 }; case 94: case 108: return { width: 8, height: 5 }; case 95: case 109: return { width: 8, height: 6 }; case 96: case 110: return { width: 8, height: 8 }; case 97: case 111: return { width: 10, height: 5 }; case 98: case 112: return { width: 10, height: 6 }; case 99: case 113: return { width: 10, height: 8 }; case 100: case 114: return { width: 10, height: 10 }; case 101: case 115: return { width: 12, height: 10 }; case 102: case 116: return { width: 12, height: 12 }; default: return { width: 1, height: 1 } } } function e_(t, e) { return Yp(t / e) * e } var i_ = Object.freeze({ __proto__: null, API: Wf, AccessFlagBit: vd, Address: hd, Attribute: pp, AttributeName: Up, BarrierType: Bd, BindingMappingInfo: Yd, BlendFactor: fd, BlendOp: dd, BufferBarrierInfo: Ip, BufferFlagBit: Jf, BufferInfo: Zd, BufferTextureCopy: Wd, BufferUsageBit: Zf, BufferViewInfo: Jd, ClearFlagBit: Pd, Color: Xd, ColorAttachment: mp, ColorMask: pd, CommandBufferInfo: Bp, CommandBufferType: Rd, ComparisonFunc: cd, CullMode: Td, DESCRIPTOR_BUFFER_TYPE: jp, DESCRIPTOR_DYNAMIC_TYPE: 10, DESCRIPTOR_SAMPLER_TYPE: Xp, DESCRIPTOR_STORAGE_BUFFER_TYPE: 12, DRAW_INFO_SIZE: 28, DepthStencilAttachment: vp, DescriptorSetInfo: Dp, DescriptorSetLayoutBinding: Ap, DescriptorSetLayoutInfo: Cp, DescriptorType: Ad, DeviceCaps: Ld, DeviceInfo: Qd, DeviceOptions: Fd, DispatchInfo: tp, DrawInfo: $d, DynamicStateFlagBit: Id, DynamicStates: Np, DynamicStencilStates: kp, Extent: zd, Feature: Xf, Filter: ud, Format: qf, FormatFeatureBit: sd, FormatInfo: Lp, FormatInfos: Wp, FormatSize: Kp, FormatSurfaceSize: Qp, FormatType: Yf, FramebufferInfo: Ep, GFXObject: zp, GeneralBarrierInfo: Sp, GetTypeSize: Jp, IndirectBuffer: ep, InputAssemblerInfo: gp, InputState: Pp, IsPowerOf2: qp, LoadOp: gd, MarkerInfo: qd, MemoryAccessBit: $f, MemoryStatus: Fp, MemoryUsageBit: td, ObjectType: Gf, Offset: kd, PassType: Md, PipelineBindPoint: bd, PipelineLayoutInfo: Rp, PolygonMode: xd, PrimitiveMode: wd, QueryPoolInfo: Op, QueryType: Dd, QueueInfo: Mp, QueueType: Cd, Rect: Nd, RenderPassInfo: wp, ResolveMode: yd, ResourceRange: xp, SampleCount: ad, SampleType: Kf, SamplerInfo: rp, ShadeModel: Sd, ShaderInfo: _p, ShaderStage: dp, ShaderStageFlagBit: _d, Size: Od, Status: Hf, StencilFace: Ed, StencilOp: ld, StoreOp: md, SubpassDependency: bp, SubpassInfo: yp, SurfaceTransform: jf, SwapchainInfo: Kd, TextureBarrierInfo: Tp, TextureBlit: Hd, TextureCopy: Gd, TextureFlagBit: rd, TextureInfo: ip, TextureSubresLayers: Ud, TextureSubresRange: Vd, TextureType: ed, TextureUsageBit: nd, TextureViewInfo: np, Type: Qf, Uniform: sp, UniformBlock: ap, UniformInputAttachment: fp, UniformSampler: up, UniformSamplerTexture: op, UniformStorageBuffer: lp, UniformStorageImage: cp, UniformTexture: hp, ViewDimension: id, Viewport: jd, VsyncMode: od, alignTo: e_, formatAlignment: t_, getTypedArrayConstructor: $p }), n_ = function (t) { function e() { var e; return (e = t.call(this, 2) || this)._usage = 0, e._memUsage = 0, e._size = 0, e._stride = 1, e._count = 0, e._flags = 0, e._isBufferView = !1, e } return s(e, t), n(e, [{ key: "usage", get: function () { return this._usage } }, { key: "memUsage", get: function () { return this._memUsage } }, { key: "size", get: function () { return this._size } }, { key: "stride", get: function () { return this._stride } }, { key: "count", get: function () { return this._count } }, { key: "flags", get: function () { return this._flags } }]), e }(zp), r_ = function (t) { function e() { var e; return (e = t.call(this, 13) || this)._queue = null, e._type = 0, e._numDrawCalls = 0, e._numInstances = 0, e._numTris = 0, e } return s(e, t), n(e, [{ key: "type", get: function () { return this._type } }, { key: "queue", get: function () { return this._queue } }, { key: "numDrawCalls", get: function () { return this._numDrawCalls } }, { key: "numInstances", get: function () { return this._numInstances } }, { key: "numTris", get: function () { return this._numTris } }]), e }(zp), s_ = function () { function t() { this._gfxAPI = 0, this._renderer = "", this._vendor = "", this._features = new Array(10), this._formatFeatures = new Array(117), this._queue = null, this._cmdBuff = null, this._numDrawCalls = 0, this._numInstances = 0, this._numTris = 0, this._memoryStatus = new Fp, this._caps = new Ld, this._bindingMappingInfo = new Yd, this._samplers = new Map, this._generalBarrierss = new Map, this._textureBarriers = new Map, this._bufferBarriers = new Map, this._swapchainFormat = 35 } var e = t.prototype; return e.hasFeature = function (t) { return this._features[t] }, e.getFormatFeatures = function (t) { return this._formatFeatures[t] }, e.enableAutoBarrier = function () { }, e.getMaxSampleCount = function () { return 1 }, n(t, [{ key: "gfxAPI", get: function () { return this._gfxAPI } }, { key: "queue", get: function () { return this._queue } }, { key: "commandBuffer", get: function () { return this._cmdBuff } }, { key: "swapchainFormat", get: function () { return this._swapchainFormat } }, { key: "renderer", get: function () { return this._renderer } }, { key: "vendor", get: function () { return this._vendor } }, { key: "numDrawCalls", get: function () { return this._numDrawCalls } }, { key: "numInstances", get: function () { return this._numInstances } }, { key: "numTris", get: function () { return this._numTris } }, { key: "memoryStatus", get: function () { return this._memoryStatus } }, { key: "capabilities", get: function () { return this._caps } }, { key: "bindingMappingInfo", get: function () { return this._bindingMappingInfo } }]), t }(); s_.canvas = void 0; var a_ = function () { function t(t) { this._texture2D = null, this._texture3D = null, this._textureCube = null, this._texture2DArray = null; var e = t.capabilities, i = new Uint8Array(64); if (i.fill(255), e.maxTextureSize >= 2) { this._texture2D = t.createTexture(new ip(1, 12, 35, 2, 2, 0)); var n = new Wd(0, 0, 0, new kd(0, 0, 0), new zd(2, 2, 1)); t.copyBuffersToTexture([i], this._texture2D, [n]) } if (e.maxTextureSize >= 2) { this._textureCube = t.createTexture(new ip(3, 12, 35, 2, 2, 0, 6)); var r = new Wd(0, 0, 0, new kd(0, 0, 0), new zd(2, 2, 1)); t.copyBuffersToTexture([i], this._textureCube, [r]), r.texSubres.baseArrayLayer = 1, t.copyBuffersToTexture([i], this._textureCube, [r]), r.texSubres.baseArrayLayer = 2, t.copyBuffersToTexture([i], this._textureCube, [r]), r.texSubres.baseArrayLayer = 3, t.copyBuffersToTexture([i], this._textureCube, [r]), r.texSubres.baseArrayLayer = 4, t.copyBuffersToTexture([i], this._textureCube, [r]), r.texSubres.baseArrayLayer = 5, t.copyBuffersToTexture([i], this._textureCube, [r]) } if (e.max3DTextureSize >= 2) { this._texture3D = t.createTexture(new ip(2, 12, 35, 2, 2, 0, 1, 1, 1, 2)); var s = new Wd(0, 0, 0, new kd(0, 0, 0), new zd(2, 2, 2), new Ud(0, 0, 1)); t.copyBuffersToTexture([i], this._texture3D, [s]) } if (e.maxArrayTextureLayers >= 2) { this._texture2DArray = t.createTexture(new ip(5, 12, 35, 2, 2, 0, 2)); var a = new Wd(0, 0, 0, new kd(0, 0, 0), new zd(2, 2, 1), new Ud(0, 0, 1)); t.copyBuffersToTexture([i], this._texture2DArray, [a]), a.texSubres.baseArrayLayer = 1, t.copyBuffersToTexture([i], this._texture2DArray, [a]) } } return t.prototype.getTexture = function (t) { switch (t) { case 1: return this._texture2D; case 2: return this._texture3D; case 3: return this._textureCube; case 5: return this._texture2DArray; default: return null } }, t }(), o_ = function (t) { function e() { var e; return (e = t.call(this, 1) || this)._transform = 0, e._colorTexture = null, e._depthStencilTexture = null, e } return s(e, t), n(e, [{ key: "colorTexture", get: function () { return this._colorTexture } }, { key: "depthStencilTexture", get: function () { return this._depthStencilTexture } }, { key: "surfaceTransform", get: function () { return this._transform } }, { key: "width", get: function () { return this._colorTexture.width } }, { key: "height", get: function () { return this._colorTexture.height } }]), e }(zp), u_ = function (t) { function e() { var e; return (e = t.call(this, 5) || this)._renderPass = null, e._colorTextures = [], e._depthStencilTexture = null, e._width = 0, e._height = 0, e } return s(e, t), n(e, [{ key: "renderPass", get: function () { return this._renderPass } }, { key: "colorTextures", get: function () { return this._colorTextures } }, { key: "depthStencilTexture", get: function () { return this._depthStencilTexture } }, { key: "width", get: function () { var t, e; return this.colorTextures.length > 0 ? null !== (t = null == (e = this.colorTextures[0]) ? void 0 : e.width) && void 0 !== t ? t : this._width : this.depthStencilTexture ? this.depthStencilTexture.width : this._width } }, { key: "height", get: function () { var t, e; return this.colorTextures.length > 0 ? null !== (t = null == (e = this.colorTextures[0]) ? void 0 : e.height) && void 0 !== t ? t : this._height : this.depthStencilTexture ? this.depthStencilTexture.height : this._height } }, { key: "needRebuild", get: function () { return !1 } }]), e }(zp), h_ = function (t) { function e() { var e; return (e = t.call(this, 12) || this)._attributes = [], e._attributesHash = 0, e._vertexBuffers = [], e._indexBuffer = null, e._indirectBuffer = null, e._drawInfo = new $d, e } s(e, t); var i = e.prototype; return i.getVertexBuffer = function (t) { return void 0 === t && (t = 0), t < this._vertexBuffers.length ? this._vertexBuffers[t] : null }, i.computeAttributesHash = function () { for (var t = "attrs", e = 0; e < this.attributes.length; ++e) { var i = this.attributes[e]; t += "," + i.name + "," + i.format + "," + i.isNormalized + "," + i.stream + "," + i.isInstanced + "," + i.location } return Lf(t, 666) }, n(e, [{ key: "attributes", get: function () { return this._attributes } }, { key: "vertexBuffers", get: function () { return this._vertexBuffers } }, { key: "indexBuffer", get: function () { return this._indexBuffer } }, { key: "indirectBuffer", get: function () { return this._indirectBuffer } }, { key: "attributesHash", get: function () { return this._attributesHash } }, { key: "vertexCount", get: function () { return this._drawInfo.vertexCount }, set: function (t) { this._drawInfo.vertexCount = t } }, { key: "firstVertex", get: function () { return this._drawInfo.firstVertex }, set: function (t) { this._drawInfo.firstVertex = t } }, { key: "indexCount", get: function () { return this._drawInfo.indexCount }, set: function (t) { this._drawInfo.indexCount = t } }, { key: "firstIndex", get: function () { return this._drawInfo.firstIndex }, set: function (t) { this._drawInfo.firstIndex = t } }, { key: "vertexOffset", get: function () { return this._drawInfo.vertexOffset }, set: function (t) { this._drawInfo.vertexOffset = t } }, { key: "instanceCount", get: function () { return this._drawInfo.instanceCount }, set: function (t) { this._drawInfo.instanceCount = t } }, { key: "firstInstance", get: function () { return this._drawInfo.firstInstance }, set: function (t) { this._drawInfo.firstInstance = t } }, { key: "drawInfo", get: function () { return this._drawInfo }, set: function (t) { this._drawInfo = t } }]), e }(zp), c_ = function (t) { function e() { var e; return (e = t.call(this, 11) || this)._layout = null, e._buffers = [], e._textures = [], e._samplers = [], e._isDirty = !1, e } s(e, t); var i = e.prototype; return i.bindBuffer = function (t, e, i) { void 0 === i && (i = 0); var n = this._layout.bindingIndices[t], r = this._layout.bindings[n]; if (r && r.descriptorType & jp) { var s = this._layout.descriptorIndices[t]; this._buffers[s + i] !== e && (this._buffers[s + i] = e, this._isDirty = !0) } }, i.bindSampler = function (t, e, i) { void 0 === i && (i = 0); var n = this._layout.bindingIndices[t], r = this._layout.bindings[n]; if (r && r.descriptorType & Xp) { var s = this._layout.descriptorIndices[t]; this._samplers[s + i] !== e && (this._samplers[s + i] = e, this._isDirty = !0) } }, i.bindTexture = function (t, e, i) { void 0 === i && (i = 0); var n = this._layout.bindingIndices[t], r = this._layout.bindings[n]; if (r && r.descriptorType & Xp) { var s = this._layout.descriptorIndices[t]; this._textures[s + i] !== e && (this._textures[s + i] = e, this._isDirty = !0) } }, i.getBuffer = function (t, e) { void 0 === e && (e = 0); var i = this._layout.descriptorIndices[t]; return this._buffers[i + e] }, i.getSampler = function (t, e) { void 0 === e && (e = 0); var i = this._layout.descriptorIndices[t]; return this._samplers[i + e] }, i.getTexture = function (t, e) { void 0 === e && (e = 0); var i = this._layout.descriptorIndices[t]; return this._textures[i + e] }, n(e, [{ key: "layout", get: function () { return this._layout } }]), e }(zp), l_ = function (t) { function e() { var e; return (e = t.call(this, 8) || this)._bindings = [], e._bindingIndices = [], e._descriptorIndices = [], e } return s(e, t), n(e, [{ key: "bindings", get: function () { return this._bindings } }, { key: "bindingIndices", get: function () { return this._bindingIndices } }, { key: "descriptorIndices", get: function () { return this._descriptorIndices } }]), e }(zp), f_ = function (t) { function e() { var e; return (e = t.call(this, 9) || this)._setLayouts = [], e } return s(e, t), n(e, [{ key: "setLayouts", get: function () { return this._setLayouts } }]), e }(zp), d_ = function () { function t(t, e, i, n, r, s, a, o, u, h, c, l) { void 0 === t && (t = !1), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 2), void 0 === r && (r = !0), void 0 === s && (s = !1), void 0 === a && (a = 0), void 0 === o && (o = 0), void 0 === u && (u = 0), void 0 === h && (h = !0), void 0 === c && (c = !1), void 0 === l && (l = 1), this.isDiscard = t, this.polygonMode = e, this.shadeModel = i, this.cullMode = n, this.isFrontFaceCCW = r, this.depthBiasEnabled = s, this.depthBias = a, this.depthBiasClamp = o, this.depthBiasSlop = u, this.isDepthClip = h, this.isMultisample = c, this.lineWidth = l } var e = t.prototype; return e.reset = function () { this.isDiscard = !1, this.polygonMode = 0, this.shadeModel = 0, this.cullMode = 2, this.isFrontFaceCCW = !0, this.depthBiasEnabled = !1, this.depthBias = 0, this.depthBiasClamp = 0, this.depthBiasSlop = 0, this.isDepthClip = !0, this.isMultisample = !1, this.lineWidth = 1 }, e.assign = function (t) { Object.assign(this, t) }, e.destroy = function () { }, n(t, [{ key: "native", get: function () { return this } }]), t }(), p_ = function () { function t(t, e, i, n, r, s, a, o, u, h, c, l, f, d, p, _, g, m, v) { void 0 === t && (t = !0), void 0 === e && (e = !0), void 0 === i && (i = 1), void 0 === n && (n = !1), void 0 === r && (r = 7), void 0 === s && (s = 65535), void 0 === a && (a = 65535), void 0 === o && (o = 1), void 0 === u && (u = 1), void 0 === h && (h = 1), void 0 === c && (c = 1), void 0 === l && (l = !1), void 0 === f && (f = 7), void 0 === d && (d = 65535), void 0 === p && (p = 65535), void 0 === _ && (_ = 1), void 0 === g && (g = 1), void 0 === m && (m = 1), void 0 === v && (v = 1), this.depthTest = t, this.depthWrite = e, this.depthFunc = i, this.stencilTestFront = n, this.stencilFuncFront = r, this.stencilReadMaskFront = s, this.stencilWriteMaskFront = a, this.stencilFailOpFront = o, this.stencilZFailOpFront = u, this.stencilPassOpFront = h, this.stencilRefFront = c, this.stencilTestBack = l, this.stencilFuncBack = f, this.stencilReadMaskBack = d, this.stencilWriteMaskBack = p, this.stencilFailOpBack = _, this.stencilZFailOpBack = g, this.stencilPassOpBack = m, this.stencilRefBack = v } var e = t.prototype; return e.reset = function () { this.depthTest = !0, this.depthWrite = !0, this.depthFunc = 1, this.stencilTestFront = !1, this.stencilFuncFront = 7, this.stencilReadMaskFront = 65535, this.stencilWriteMaskFront = 65535, this.stencilFailOpFront = 1, this.stencilZFailOpFront = 1, this.stencilPassOpFront = 1, this.stencilRefFront = 1, this.stencilTestBack = !1, this.stencilFuncBack = 7, this.stencilReadMaskBack = 65535, this.stencilWriteMaskBack = 65535, this.stencilFailOpBack = 1, this.stencilZFailOpBack = 1, this.stencilPassOpBack = 1, this.stencilRefBack = 1 }, e.assign = function (t) { Object.assign(this, t) }, e.destroy = function () { }, n(t, [{ key: "native", get: function () { return this } }]), t }(), __ = function () { function t(t, e, i, n, r, s, a, o) { void 0 === t && (t = !1), void 0 === e && (e = 1), void 0 === i && (i = 0), void 0 === n && (n = 0), void 0 === r && (r = 1), void 0 === s && (s = 0), void 0 === a && (a = 0), void 0 === o && (o = 15), this.blend = t, this.blendSrc = e, this.blendDst = i, this.blendEq = n, this.blendSrcAlpha = r, this.blendDstAlpha = s, this.blendAlphaEq = a, this.blendColorMask = o } var e = t.prototype; return e.reset = function () { this.blend = !1, this.blendSrc = 1, this.blendDst = 0, this.blendEq = 0, this.blendSrcAlpha = 1, this.blendDstAlpha = 0, this.blendAlphaEq = 0, this.blendColorMask = 15 }, e.assign = function (t) { Object.assign(this, t) }, e.destroy = function () { }, t }(), g_ = function () { function t(t, e, i, n) { void 0 === t && (t = !1), void 0 === e && (e = !1), void 0 === i && (i = new Xd), void 0 === n && (n = [new __]), this.isA2C = t, this.isIndepend = e, this.blendColor = i, this.targets = n } var e = t.prototype; return e.setTarget = function (t, e) { var i = this.targets[t]; i || (i = this.targets[t] = new __), Object.assign(i, e) }, e.reset = function () { this.isA2C = !1, this.isIndepend = !1, this.blendColor.x = 0, this.blendColor.y = 0, this.blendColor.z = 0, this.blendColor.w = 0, this.targets.length = 1, this.targets[0].reset() }, e.destroy = function () { }, n(t, [{ key: "native", get: function () { return this } }]), t }(), m_ = function (t, e, i, n, r, s, a, o, u, h) { void 0 === t && (t = null), void 0 === e && (e = null), void 0 === i && (i = null), void 0 === n && (n = new Pp), void 0 === r && (r = new d_), void 0 === s && (s = new p_), void 0 === a && (a = new g_), void 0 === o && (o = 7), void 0 === u && (u = 0), void 0 === h && (h = 0), this.shader = t, this.pipelineLayout = e, this.renderPass = i, this.inputState = n, this.rasterizerState = r, this.depthStencilState = s, this.blendState = a, this.primitive = o, this.dynamicStates = u, this.bindPoint = h }, v_ = function (t) { function e() { var e; return (e = t.call(this, 10) || this)._shader = null, e._pipelineLayout = null, e._primitive = 7, e._is = null, e._rs = new d_, e._dss = new p_, e._bs = new g_, e._dynamicStates = 0, e._renderPass = null, e } return s(e, t), n(e, [{ key: "shader", get: function () { return this._shader } }, { key: "pipelineLayout", get: function () { return this._pipelineLayout } }, { key: "primitive", get: function () { return this._primitive } }, { key: "rasterizerState", get: function () { return this._rs } }, { key: "depthStencilState", get: function () { return this._dss } }, { key: "blendState", get: function () { return this._bs } }, { key: "inputState", get: function () { return this._is } }, { key: "dynamicStates", get: function () { return this._dynamicStates } }, { key: "renderPass", get: function () { return this._renderPass } }]), e }(zp), y_ = function (t) { function e() { var e; return (e = t.call(this, 14) || this)._type = 0, e } return s(e, t), n(e, [{ key: "type", get: function () { return this._type } }]), e }(zp), b_ = function (t) { function e() { var e; return (e = t.call(this, 4) || this)._colorInfos = [], e._depthStencilInfo = null, e._subpasses = [], e._hash = 0, e } return s(e, t), e.prototype.computeHash = function () { var t = ""; if (this._subpasses.length) for (var e = 0; e < this._subpasses.length; ++e) { var i = this._subpasses[e]; if (i.inputs.length) { t += "ia"; for (var n = 0; n < i.inputs.length; ++n) { var r = this._colorInfos[i.inputs[n]]; t += "," + r.format + "," + r.sampleCount } } if (i.colors.length) { t += "ca"; for (var s = 0; s < i.colors.length; ++s) { var a = this._colorInfos[i.colors[s]]; t += "," + a.format + "," + a.sampleCount } } if (i.depthStencil >= 0) { var o = this._colorInfos[i.depthStencil]; t += "ds," + o.format + "," + o.sampleCount } } else { t += "ca"; for (var u = 0; u < this._colorInfos.length; ++u) { var h = this._colorInfos[u]; t += "," + h.format + "," + h.sampleCount } var c = this._depthStencilInfo; c && (t += "ds," + c.format + "," + c.sampleCount) } return Lf(t, 666) }, n(e, [{ key: "colorAttachments", get: function () { return this._colorInfos } }, { key: "depthStencilAttachment", get: function () { return this._depthStencilInfo } }, { key: "subPasses", get: function () { return this._subpasses } }, { key: "hash", get: function () { return this._hash } }]), e }(zp), w_ = function (t) { function e(e, i) { var n; return (n = t.call(this, 6) || this)._info = new rp, n._hash = 0, n._info.copy(e), n._hash = i, n } return s(e, t), e.computeHash = function (t) { var e = t.minFilter; return e |= t.magFilter << 2, e |= t.mipFilter << 4, e |= t.addressU << 6, e |= t.addressV << 8, e |= t.addressW << 10, (e |= Math.min(t.maxAnisotropy, 16) << 12) | t.cmpFunc << 17 }, e.unpackFromHash = function (t) { var e = new rp; return e.minFilter = 3 & t, e.magFilter = t >> 2 & 3, e.mipFilter = t >> 4 & 3, e.addressU = t >> 6 & 3, e.addressV = t >> 8 & 3, e.addressW = t >> 10 & 3, e.maxAnisotropy = t >> 12 & 31, e.cmpFunc = t >> 17 & 7, e }, n(e, [{ key: "info", get: function () { return this._info } }, { key: "hash", get: function () { return this._hash } }]), e }(zp), x_ = function (t) { function e() { var e; return (e = t.call(this, 7) || this)._name = "", e._stages = [], e._attributes = [], e._blocks = [], e._samplers = [], e } return s(e, t), n(e, [{ key: "name", get: function () { return this._name } }, { key: "attributes", get: function () { return this._attributes } }, { key: "blocks", get: function () { return this._blocks } }, { key: "samplers", get: function () { return this._samplers } }, { key: "stages", get: function () { return this._stages } }]), e }(zp), S_ = function (t) { function e() { var e; return (e = t.call(this, 3) || this)._info = new ip, e._viewInfo = new np, e._isPowerOf2 = !1, e._isTextureView = !1, e._size = 0, e } return s(e, t), e.getLevelCount = function (t, e) { return Math.floor(Math.log2(Math.max(t, e))) }, n(e, [{ key: "type", get: function () { return this._info.type } }, { key: "usage", get: function () { return this._info.usage } }, { key: "format", get: function () { return this._info.format } }, { key: "width", get: function () { return this._info.width } }, { key: "height", get: function () { return this._info.height } }, { key: "depth", get: function () { return this._info.depth } }, { key: "layerCount", get: function () { return this._info.layerCount } }, { key: "levelCount", get: function () { return this._info.levelCount } }, { key: "samples", get: function () { return this._info.samples } }, { key: "flags", get: function () { return this._info.flags } }, { key: "size", get: function () { return this._size } }, { key: "info", get: function () { return this._info } }, { key: "viewInfo", get: function () { return this._viewInfo } }, { key: "isTextureView", get: function () { return this._isTextureView } }]), e }(zp), T_ = function (t) { function e(e, i) { var n; return (n = t.call(this, 16) || this)._info = new Sp, n._hash = 0, n._info.copy(e), n._hash = i, n } return s(e, t), e.computeHash = function (t) { return Lf(t.prevAccesses + " " + t.nextAccesses + " " + t.type, 666) }, n(e, [{ key: "info", get: function () { return this._info } }, { key: "hash", get: function () { return this._hash } }]), e }(zp), I_ = function (t) { function e(e, i) { var n; return (n = t.call(this, 17) || this)._info = new Tp, n._hash = 0, n._info.copy(e), n._hash = i, n } return s(e, t), e.computeHash = function (t) { var e = t.prevAccesses + " " + t.nextAccesses; return e += t.type, e += t.range.mipLevel, e += t.range.levelCount, e += t.range.firstSlice, e += t.range.numSlices, e += t.range.basePlane, e += t.range.planeCount, e += t.discardContents, e += t.srcQueue ? t.srcQueue.type : 0, Lf(e += t.dstQueue ? t.dstQueue.type : 0, 666) }, n(e, [{ key: "info", get: function () { return this._info } }, { key: "hash", get: function () { return this._hash } }]), e }(zp), E_ = function (t) { function e(e, i) { var n; return (n = t.call(this, 18) || this)._info = new Ip, n._hash = 0, n._info.copy(e), n._hash = i, n } return s(e, t), e.computeHash = function (t) { var e = t.prevAccesses + " " + t.nextAccesses; return e += t.type, e += t.offset, e += t.size, e += t.discardContents, e += t.srcQueue ? t.srcQueue.type : 0, Lf(e += t.dstQueue ? t.dstQueue.type : 0, 666) }, n(e, [{ key: "info", get: function () { return this._info } }, { key: "hash", get: function () { return this._hash } }]), e }(zp), A_ = { Device: s_, Swapchain: o_, Buffer: n_, Texture: S_, Sampler: w_, Shader: x_, InputAssembler: h_, RenderPass: b_, Framebuffer: u_, DescriptorSet: c_, DescriptorSetLayout: l_, PipelineLayout: f_, PipelineState: v_, CommandBuffer: r_, Queue: y_, GeneralBarrier: T_, TextureBarrier: I_, BufferBarrier: E_, RasterizerState: d_, BlendState: g_, BlendTarget: __, DepthStencilState: p_, PipelineStateInfo: m_ }; Object.assign(A_, i_), S.gfx = A_; var C_ = { GFXDevice: !0, GFXBuffer: !0, GFXTexture: !0, GFXSampler: !0, GFXShader: !0, GFXInputAssembler: !0, GFXRenderPass: !0, GFXFramebuffer: !0, GFXPipelineState: !0, GFXCommandBuffer: !0, GFXQueue: !0, GFXObjectType: !0, GFXObject: !1, GFXAttributeName: !0, GFXType: !0, GFXFormat: !0, GFXBufferUsageBit: !0, GFXMemoryUsageBit: !0, GFXBufferFlagBit: !0, GFXBufferAccessBit: "MemoryAccessBit", GFXPrimitiveMode: !0, GFXPolygonMode: !0, GFXShadeModel: !0, GFXCullMode: !0, GFXComparisonFunc: !0, GFXStencilOp: !0, GFXBlendOp: !0, GFXBlendFactor: !0, GFXColorMask: !0, GFXFilter: !0, GFXAddress: !0, GFXTextureType: !0, GFXTextureUsageBit: !0, GFXSampleCount: !0, GFXTextureFlagBit: !0, GFXShaderStageFlagBit: !0, GFXDescriptorType: !0, GFXCommandBufferType: !0, GFXLoadOp: !0, GFXStoreOp: !0, GFXPipelineBindPoint: !0, GFXDynamicStateFlagBit: !0, GFXStencilFace: !0, GFXQueueType: !0, GFXRect: !0, GFXViewport: !0, GFXColor: !0, GFXClearFlag: !0, GFXOffset: !0, GFXExtent: !0, GFXTextureSubres: "TextureSubresLayers", GFXTextureCopy: !0, GFXBufferTextureCopy: !0, GFXFormatType: !0, GFXFormatInfo: !0, GFXMemoryStatus: !0, GFXFormatInfos: !0, GFXFormatSize: !0, GFXFormatSurfaceSize: !0, GFXGetTypeSize: !0, getTypedArrayConstructor: !1 }; for (var D_ in C_) { var R_ = C_[D_]; !0 === R_ ? R_ = D_.slice(3) : !1 === R_ && (R_ = D_), lt(S, "cc", [{ name: D_, newName: R_, target: S.gfx, targetName: "cc.gfx" }]) } ft(S, "cc", [{ name: "GFX_MAX_VERTEX_ATTRIBUTES" }, { name: "GFX_MAX_TEXTURE_UNITS" }, { name: "GFX_MAX_ATTACHMENTS" }, { name: "GFX_MAX_BUFFER_BINDINGS" }, { name: "GFXTextureLayout" }]), ft(Xf, "Feature", [{ name: "COLOR_FLOAT", suggest: "Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.R32F) & FormatFeatureBit.RENDER_TARGET;" }, { name: "COLOR_HALF_FLOAT", suggest: "Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.R16F) & FormatFeatureBit.RENDER_TARGET;" }, { name: "TEXTURE_FLOAT", suggest: "Please use device.getFormatFeatures() instead, like: \nlet isSupported = (device.getFormatFeatures(Format.R32F) & (FormatFeatureBit.RENDER_TARGET | FormatFeatureBit.SAMPLED_TEXTURE)) === (FormatFeatureBit.RENDER_TARGET | FormatFeatureBit.SAMPLED_TEXTURE);" }, { name: "TEXTURE_HALF_FLOAT", suggest: "Please use device.getFormatFeatures() instead, like: \nlet isSupported = (device.getFormatFeatures(Format.R16F) & (FormatFeatureBit.RENDER_TARGET | FormatFeatureBit.SAMPLED_TEXTURE)) === (FormatFeatureBit.RENDER_TARGET | FormatFeatureBit.SAMPLED_TEXTURE);" }, { name: "TEXTURE_FLOAT_LINEAR", suggest: "Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.R32F) & FormatFeatureBit.LINEAR_FILTER;" }, { name: "TEXTURE_HALF_FLOAT_LINEAR", suggest: "Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.R16F) & FormatFeatureBit.LINEAR_FILTER;" }, { name: "FORMAT_R11G11B10F", suggest: "Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.R11G11B10F) !== FormatFeatureBit.NONE;" }, { name: "FORMAT_SRGB", suggest: "Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.SRGB8) !== FormatFeatureBit.NONE;" }, { name: "FORMAT_ETC1", suggest: "Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.ETC_RGB8) !== FormatFeatureBit.NONE;" }, { name: "FORMAT_ETC2", suggest: "Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.ETC2_RGB8) !== FormatFeatureBit.NONE;" }, { name: "FORMAT_DXT", suggest: "Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.BC1) !== FormatFeatureBit.NONE;" }, { name: "FORMAT_PVRTC", suggest: "Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.PVRTC_RGB2) !== FormatFeatureBit.NONE;" }, { name: "FORMAT_ASTC", suggest: "Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.ASTC_RGBA_4x4) !== FormatFeatureBit.NONE;" }, { name: "FORMAT_RGB8", suggest: "Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.RGB8) !== FormatFeatureBit.NONE;" }]), ft(mp.prototype, "ColorAttachment", [{ name: "beginAccesses", suggest: "Please assign to ColorAttachment.barrier instead" }, { name: "endAccesses", suggest: "Please assign to ColorAttachment.barrier instead" }]), ft(vp.prototype, "DepthStencilAttachment", [{ name: "beginAccesses", suggest: "Please assign to DepthStencilAttachment.barrier instead" }, { name: "endAccesses", suggest: "Please assign to DepthStencilAttachment.barrier instead" }]), lt(s_.prototype, "Device", [{ name: "getGlobalBarrier", newName: "getGeneralBarrier" }]); var P_ = function () { function t() { this.initialized = !1, this._gfxDevice = void 0, this._canvas = null, this._swapchain = void 0, this._renderType = -1, this._deviceInitialized = !1 } var e = t.prototype; return e._tryInitializeWebGPUDevice = function (t, e) { var i = this; return this._deviceInitialized ? Promise.resolve(!0) : t ? (this._gfxDevice = new t, new Promise((function (t, n) { i._gfxDevice.initialize(e).then((function (e) { i._deviceInitialized = e, t(e) })).catch((function (t) { n(t) })) }))) : Promise.resolve(!1) }, e._tryInitializeDeviceSync = function (t, e) { return !!this._deviceInitialized || (t && (this._gfxDevice = new t, this._deviceInitialized = this._gfxDevice.initialize(e)), this._deviceInitialized) }, e.init = function (t, e) { var i = this; if (this.initialized) return !0; var n = Oe.querySettings(Be.Category.RENDERING, "renderMode"); this._canvas = t, this._canvas && (this._canvas.oncontextmenu = function () { return !1 }), this._renderType = this._determineRenderType(n), this._deviceInitialized = !1; var r = new Qd(e); if (1 === this._renderType || 2 === this._renderType) { var s = !!globalThis.WebGL2RenderingContext; if (globalThis.navigator.userAgent.toLowerCase(), tu.browserType === xo.UC && (s = !1), s_.canvas = t, 2 === this._renderType && S.WebGPUDevice) return new Promise((function (t, e) { i._tryInitializeWebGPUDevice(S.WebGPUDevice, r).then((function (e) { i._initSwapchain(), t(e) })).catch((function (t) { e(t) })) })); s && S.WebGL2Device && this._tryInitializeDeviceSync(S.WebGL2Device, r), S.WebGLDevice && this._tryInitializeDeviceSync(S.WebGLDevice, r), S.EmptyDevice && this._tryInitializeDeviceSync(S.EmptyDevice, r), this._initSwapchain() } else 4 === this._renderType && S.EmptyDevice && (this._tryInitializeDeviceSync(S.EmptyDevice, r), this._initSwapchain()); return !!this._gfxDevice || (rt(16337), this._renderType = -1, !1) }, e._initSwapchain = function () { var t = new Kd(1, this._canvas), e = $o.windowSize; t.width = e.width, t.height = e.height, this._swapchain = this._gfxDevice.createSwapchain(t) }, e._supportWebGPU = function () { return "gpu" in globalThis.navigator }, e._determineRenderType = function (t) { ("number" != typeof t || t > 4 || t < 0) && (t = 0); var e = 0, i = !1; if (1 === t ? (e = 0, i = !0) : 0 === t || 4 === t ? (e = this._supportWebGPU() ? 2 : 1, i = !0) : 2 === t ? (e = 1, i = !0) : 3 === t && (e = 4, i = !0), !i) throw new Error(ut(3820, t)); return e }, n(t, [{ key: "gfxDevice", get: function () { return this._gfxDevice } }, { key: "swapchain", get: function () { return this._swapchain } }]), t }(), B_ = new P_; t("gfx", Object.freeze({ __proto__: null, API: Wf, AccessFlagBit: vd, Address: hd, Attribute: pp, AttributeName: Up, BarrierType: Bd, BindingMappingInfo: Yd, BlendFactor: fd, BlendOp: dd, BlendState: g_, BlendTarget: __, Buffer: n_, BufferBarrierInfo: Ip, BufferFlagBit: Jf, BufferInfo: Zd, BufferTextureCopy: Wd, BufferUsageBit: Zf, BufferViewInfo: Jd, ClearFlagBit: Pd, Color: Xd, ColorAttachment: mp, ColorMask: pd, CommandBuffer: r_, CommandBufferInfo: Bp, CommandBufferType: Rd, ComparisonFunc: cd, CullMode: Td, DESCRIPTOR_BUFFER_TYPE: jp, DESCRIPTOR_DYNAMIC_TYPE: 10, DESCRIPTOR_SAMPLER_TYPE: Xp, DESCRIPTOR_STORAGE_BUFFER_TYPE: 12, DRAW_INFO_SIZE: 28, DefaultResource: a_, DepthStencilAttachment: vp, DepthStencilState: p_, DescriptorSet: c_, DescriptorSetInfo: Dp, DescriptorSetLayout: l_, DescriptorSetLayoutBinding: Ap, DescriptorSetLayoutInfo: Cp, DescriptorType: Ad, Device: s_, DeviceCaps: Ld, DeviceInfo: Qd, DeviceManager: P_, DeviceOptions: Fd, DispatchInfo: tp, DrawInfo: $d, DynamicStateFlagBit: Id, DynamicStates: Np, DynamicStencilStates: kp, Extent: zd, Feature: Xf, Filter: ud, Format: qf, FormatFeatureBit: sd, FormatInfo: Lp, FormatInfos: Wp, FormatSize: Kp, FormatSurfaceSize: Qp, FormatType: Yf, Framebuffer: u_, FramebufferInfo: Ep, GFXObject: zp, GeneralBarrier: T_, GeneralBarrierInfo: Sp, GetTypeSize: Jp, IndirectBuffer: ep, InputAssembler: h_, InputAssemblerInfo: gp, InputState: Pp, IsPowerOf2: qp, LegacyRenderMode: { AUTO: 0, CANVAS: 1, WEBGL: 2, HEADLESS: 3, WEBGPU: 4 }, LoadOp: gd, MarkerInfo: qd, MemoryAccessBit: $f, MemoryStatus: Fp, MemoryUsageBit: td, ObjectType: Gf, Offset: kd, PassType: Md, PipelineBindPoint: bd, PipelineLayout: f_, PipelineLayoutInfo: Rp, PipelineState: v_, PipelineStateInfo: m_, PolygonMode: xd, PrimitiveMode: wd, QueryPoolInfo: Op, QueryType: Dd, Queue: y_, QueueInfo: Mp, QueueType: Cd, RasterizerState: d_, Rect: Nd, RenderPass: b_, RenderPassInfo: wp, RenderType: { UNKNOWN: -1, CANVAS: 0, WEBGL: 1, WEBGPU: 2, OPENGL: 3, HEADLESS: 4 }, ResolveMode: yd, ResourceRange: xp, SampleCount: ad, SampleType: Kf, Sampler: w_, SamplerInfo: rp, ShadeModel: Sd, Shader: x_, ShaderInfo: _p, ShaderStage: dp, ShaderStageFlagBit: _d, Size: Od, Status: Hf, StencilFace: Ed, StencilOp: ld, StoreOp: md, SubpassDependency: bp, SubpassInfo: yp, SurfaceTransform: jf, Swapchain: o_, SwapchainInfo: Kd, Texture: S_, TextureBarrier: I_, TextureBarrierInfo: Tp, TextureBlit: Hd, TextureCopy: Gd, TextureFlagBit: rd, TextureInfo: ip, TextureSubresLayers: Ud, TextureSubresRange: Vd, TextureType: ed, TextureUsageBit: nd, TextureViewInfo: np, Type: Qf, Uniform: sp, UniformBlock: ap, UniformInputAttachment: fp, UniformSampler: up, UniformSamplerTexture: op, UniformStorageBuffer: lp, UniformStorageImage: cp, UniformTexture: hp, ViewDimension: id, Viewport: jd, VsyncMode: od, alignTo: e_, deviceManager: B_, formatAlignment: t_, getTypedArrayConstructor: $p })); var M_ = new Pn; function O_(t, e, i, n) { var r = i.chunk, s = i.data, a = r.vb, o = i.vertexCount, u = t.worldMatrix, h = u.m00, c = u.m01, l = u.m02, f = u.m03, d = u.m04, p = u.m05, _ = u.m06, g = u.m07, m = u.m12, v = u.m13, y = u.m14, b = u.m15; M_.set(n.r / 255, n.g / 255, n.b / 255, n.a / 255); for (var w = 0, x = 0; x < o; ++x) { var S = s[x], T = S.x, I = S.y, E = f * T + g * I + b; E = E ? 1 / E : 1, a[w + 0] = (h * T + d * I + m) * E, a[w + 1] = (c * T + p * I + v) * E, a[w + 2] = (l * T + _ * I + y) * E, Pn.toArray(a, M_, w + 5), w += i.floatStride } r.bufferId; for (var A = r.vertexOffset, C = r.meshBuffer, D = r.meshBuffer.iData, R = C.indexOffset, P = 0, B = o / 4; P < B; P++) { var M = A + 4 * P; D[R++] = M, D[R++] = M + 1, D[R++] = M + 2, D[R++] = M + 1, D[R++] = M + 3, D[R++] = M + 2 } C.indexOffset += i.indexCount, C.setDirty() } function L_(t, e) { for (var i, n, r, s = t.vertexFormat, a = t.chunk.vb, o = 0, u = 0; u < s.length; ++u) { if (i = s[u], (n = Wp[i.format]).hasAlpha) if (r = t.floatStride, n.size / n.count == 1) for (var h = ~~Xi(Math.round(255 * e), 0, 255), c = o; c < a.length; c += r)a[c] = (4294967040 & a[c] | h) >>> 0; else if (n.size / n.count == 4) for (var l = o + 3; l < a.length; l += r)a[l] = e; o += n.size >> 2 } } var F_ = function () { function t(t) { this._map = null, this._count = 0, t ? (this._map = t, this._count = Object.keys(t).length) : (this._map = Nt(!0), this._count = 0) } var e = t.prototype; return e.add = function (t, e) { return t in this._map || this._count++, this._map[t] = e }, e.get = function (t) { return this._map[t] }, e.has = function (t) { return t in this._map }, e.remove = function (t) { var e = this._map[t]; return t in this._map && (delete this._map[t], this._count--), e }, e.clear = function () { 0 !== this._count && (this._map = Nt(!0), this._count = 0) }, e.forEach = function (t) { for (var e in this._map) t(this._map[e], e) }, e.find = function (t) { for (var e in this._map) if (t(this._map[e], e)) return this._map[e]; return null }, e.destroy = function () { this._map = null }, n(t, [{ key: "map", get: function () { return this._map } }, { key: "count", get: function () { return this._count } }]), t }(), k_ = function () { function t(e, i) { this.id = t._pipelineId++, this.name = "", this.pipes = [], this.name = e; for (var n = 0, r = i.length; n < r; n++)this.pipes.push(i[n]) } var e = t.prototype; return e.insert = function (t, e) { return e > this.pipes.length ? (it(4921), this) : (this.pipes.splice(e, 0, t), this) }, e.append = function (t) { return this.pipes.push(t), this }, e.remove = function (t) { return this.pipes.splice(t, 1), this }, e.sync = function (t) { var e = this.pipes; if (0 === e.length) return null; t.isFinished = !1; for (var i = 0, n = e.length; i < n;) { var r = (0, e[i])(t); if (r) return t.isFinished = !0, r; ++i !== n && (t.input = t.output, t.output = null) } return t.isFinished = !0, t.output }, e.async = function (t) { 0 !== this.pipes.length && (t.isFinished = !1, this._flow(0, t)) }, e._flow = function (t, e) { var i = this; (0, this.pipes[t])(e, (function (n) { n ? (e.isFinished = !0, e.dispatch("complete", n)) : ++t < i.pipes.length ? (e.input = e.output, e.output = null, i._flow(t, e)) : (e.isFinished = !0, e.dispatch("complete", n, e.output)) })) }, t }(); k_._pipelineId = 0; var N_ = new F_, z_ = new F_, U_ = new F_, V_ = new F_, G_ = new k_("normal load", []), H_ = new k_("fetch", []), W_ = new k_("transform url", []), j_ = new Map, X_ = { default: { priority: 0 }, preload: { maxConcurrency: 6, maxRequestsPerFrame: 2, priority: -1 }, scene: { maxConcurrency: 20, maxRequestsPerFrame: 20, priority: 1 }, bundle: { maxConcurrency: 20, maxRequestsPerFrame: 20, priority: 2 }, remote: { maxRetryCount: 4 } }, q_ = function () { function t(e) { this.id = t._taskId++, this.onComplete = null, this.onProgress = null, this.onError = null, this.source = null, this.output = null, this.input = null, this.progress = null, this.options = null, this.isFinished = !0, this.set(e) } t.create = function (e) { var i; return 0 !== t._deadPool.length ? (i = t._deadPool.pop()).set(e) : i = new t(e), i }; var e = t.prototype; return e.set = function (t) { void 0 === t && (t = Object.create(null)), this.onComplete = t.onComplete || null, this.onProgress = t.onProgress || null, this.onError = t.onError || null, this.source = this.input = t.input, this.output = null, this.progress = t.progress, this.options = t.options || Object.create(null) }, e.dispatch = function (t, e, i, n, r) { switch (t) { case "complete": this.onComplete && this.onComplete(e, i); break; case "progress": this.onProgress && this.onProgress(e, i, n, r); break; case "error": this.onError && this.onError(e, i, n, r); break; default: var s = "on" + t[0].toUpperCase() + t.substring(1); "function" == typeof this[s] && this[s](e, i, n, r) } }, e.recycle = function () { t._deadPool.length !== t.MAX_DEAD_NUM && (this.onComplete = null, this.onProgress = null, this.onError = null, this.source = this.output = this.input = null, this.progress = null, this.options = null, t._deadPool.push(this)) }, n(t, [{ key: "isFinish", get: function () { return this.isFinished }, set: function (t) { this.isFinished = t } }]), t }(); q_.MAX_DEAD_NUM = 500, q_._taskId = 0, q_._deadPool = []; var Y_ = "0123456789abcdef".split(""), K_ = ["", "", "", ""], Q_ = K_.concat(K_, "-", K_, "-", K_, "-", K_, "-", K_, K_, K_), Z_ = Q_.map((function (t, e) { return "-" === t ? NaN : e })).filter(Number.isFinite); function J_(t) { var e = t.split("@")[0]; if (22 !== e.length) return t; Q_[0] = t[0], Q_[1] = t[1]; for (var i = 2, n = 2; i < 22; i += 2) { var r = Ve[t.charCodeAt(i)], s = Ve[t.charCodeAt(i + 1)]; Q_[Z_[n++]] = Y_[r >> 2], Q_[Z_[n++]] = Y_[(3 & r) << 2 | s >> 4], Q_[Z_[n++]] = Y_[15 & s] } return t.replace(e, Q_.join("")) } var $_ = /.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/; function tg(t) { var e = $_.exec(t); return e ? e[1] : "" } function eg(t, e) { (e = e || Object.create(null)).__isNative__ = e.isNative, e.nativeExt && (e.ext = e.nativeExt); var i = V_.find((function (e) { return !!e.getAssetInfo(t) })); return i && (e.bundle = i.name), rg(t, e) } function ig(t) { return !!t && (t instanceof S.SceneAsset || t instanceof S.Scene) } function ng(t) { return t && (46 === t.charCodeAt(0) && 47 === t.charCodeAt(1) ? t = t.slice(2) : 47 === t.charCodeAt(0) && (t = t.slice(1))), t } function rg(t, e) { var i = q_.create({ input: t, options: e }), n = []; try { for (var r, s = p(W_.sync(i)); !(r = s()).done;) { var a = r.value, o = a.url; a.recycle(), n.push(o) } } catch (t) { for (var u, h = p(i.output); !(u = h()).done;)u.value.recycle(); j(t.message, t.stack) } return i.recycle(), n.length > 1 ? n : n[0] } var sg, ag, og, ug, hg, cg, lg = Object.freeze({ __proto__: null, decodeUuid: J_, getUrlWithUuid: eg, getUuidFromURL: tg, isScene: ig, normalize: ng, transform: rg }), fg = eh, dg = Xu, pg = t("Asset", Gu("cc.Asset")((ag = function (t) { function e(e) { var i; return (i = t.call(this, e) || this).loaded = !0, i._native = og && og(), i._nativeUrl = "", i._file = null, i._ref = 0, Object.defineProperty(l(i), "_uuid", { value: "", writable: !0 }), i } s(e, t), e.deserialize = function (t) { return S.deserialize(t) }; var i = e.prototype; return i.toString = function () { return this.nativeUrl }, i.serialize = function () { }, i._setRawAsset = function (t, e) { void 0 === e && (e = !0), this._native = !1 !== e ? t || "" : "/" + t }, i.addRef = function () { return this._ref++, this }, i.decRef = function (t) { return void 0 === t && (t = !0), this._ref > 0 && this._ref--, t && S.assetManager.getReleaseManager().tryRelease(this), this }, i.onLoaded = function () { }, i.initDefault = function (t) { t && (this._uuid = t), this.isDefault = !0 }, i.validate = function () { return !0 }, i.destroy = function () { return q(ut(12101, this._uuid)), t.prototype.destroy.call(this) }, n(e, [{ key: "nativeUrl", get: function () { if (!this._nativeUrl) { if (!this._native) return ""; var t = this._native; if (47 === t.charCodeAt(0)) return t.slice(1); 46 === t.charCodeAt(0) ? this._nativeUrl = eg(this._uuid, { nativeExt: t, isNative: !0 }) : this._nativeUrl = eg(this._uuid, { __nativeName__: t, nativeExt: Lo(t), isNative: !0 }) } return this._nativeUrl } }, { key: "uuid", get: function () { return this._uuid } }, { key: "_nativeAsset", get: function () { return this._file }, set: function (t) { this._file = t } }, { key: "nativeAsset", get: function () { return this._file } }, { key: "_nativeDep", get: function () { if (this._native) return { __isNative__: !0, uuid: this._uuid, ext: this._native } } }, { key: "refCount", get: function () { return this._ref } }]), e }(bo(oo)), og = Bu(ag.prototype, "_native", [fg], (function () { return "" })), m(ag.prototype, "_nativeAsset", [dg], Object.getOwnPropertyDescriptor(ag.prototype, "_nativeAsset"), ag.prototype), sg = ag)) || sg); pg.prototype.createNode = null, S.Asset = pg; var _g = 1346981187, gg = Ee({ PVR: 0, PKM: 1, ASTC: 2 }); function mg(t, e) { return 4 === t ? 89 : 5 === t ? 4 === e ? 90 : 91 : 6 === t ? 5 === e ? 92 : 93 : 8 === t ? 5 === e ? 94 : 6 === e ? 95 : 96 : 10 === t ? 5 === e ? 97 : 6 === e ? 98 : 8 === e ? 99 : 100 : 10 === e ? 101 : 102 } function vg(t, e) { return t[e] << 8 | t[e + 1] } function yg(t) { return !!(tu.hasFeature(tu.Feature.IMAGE_BITMAP) && t instanceof ImageBitmap) } var bg, wg, xg, Sg, Tg, Ig, Eg, Ag, Cg, Dg, Rg, Pg = t("ImageAsset", Gu("cc.ImageAsset")((cg = function (t) { s(i, t), i.mergeCompressedTextureMips = function (t) { var e = new Uint8Array(0); try { for (var i, n = 8 + 4 * t.length, r = 0, s = p(t); !(i = s()).done;)r += i.value.byteLength; r += n, e = new Uint8Array(r); var a = new DataView(e.buffer, e.byteOffset, e.byteLength); a.setUint32(0, _g, !0), a.setUint32(4, t.length, !0); for (var o = n, u = 0; u < t.length; u++) { var h = t[u]; if (a.setUint32(8 + 4 * u, h.byteLength, !0), h instanceof ArrayBuffer) { var c = new Uint8Array(h); e.set(c, o) } else { var l = new Uint8Array(h.buffer, h.byteOffset, h.byteLength); e.set(l, o) } o += h.byteLength } } catch (t) { W(t) } return e }, i.parseCompressedTextures = function (t, e) { var n = { _data: new Uint8Array(0), _compressed: !0, width: 0, height: 0, format: 0, mipmapLevelDataSize: [] }, r = t instanceof ArrayBuffer ? t : t.buffer, s = new DataView(r); if (s.getUint32(0, !0) === _g) { var a = s.getUint32(4, !0), o = s.getUint32(8, !0), u = 8 + 4 * a; i.parseCompressedTexture(t, 0, u, o, e, n); for (var h = u + o, c = 1; c < a; c++) { var l = s.getUint32(8 + 4 * c, !0); i.parseCompressedTexture(t, c, h, l, e, n), h += l } } else i.parseCompressedTexture(t, 0, 0, 0, e, n); return n }, i.parseCompressedTexture = function (t, e, n, r, s, a) { switch (s) { case gg.PVR: i.parsePVRTexture(t, e, n, r, a); break; case gg.PKM: i.parsePKMTexture(t, e, n, r, a); break; case gg.ASTC: i.parseASTCTexture(t, e, n, r, a) } }, i.parsePVRTexture = function (t, e, i, n, r) { var s = t instanceof ArrayBuffer ? t : t.buffer, a = new Int32Array(s, i, 13); if (55727696 === a[0]) { var o = i + a[12] + 52, u = n - a.byteLength; if (n > 0) { var h = new Uint8Array(s, o, u), c = new Uint8Array(r._data.byteLength + h.byteLength); c.set(r._data), c.set(h, r._data.byteLength), r._data = c, r.mipmapLevelDataSize[e] = u } else r._data = new Uint8Array(s, o); r.width = e > 0 ? r.width : a[7], r.height = e > 0 ? r.height : a[6] } else { if (559044176 !== a[11]) throw new Error("Invalid magic number in PVR header"); var l = i + a[0], f = n - a.byteLength; if (n > 0) { var d = new Uint8Array(s, l, f), p = new Uint8Array(r._data.byteLength + d.byteLength); p.set(r._data), p.set(d, r._data.byteLength), r._data = p, r.mipmapLevelDataSize[e] = f } else r._data = new Uint8Array(s, l); r.width = e > 0 ? r.width : a[1], r.height = e > 0 ? r.height : a[2] } }, i.parsePKMTexture = function (t, e, i, n, r) { var s = t instanceof ArrayBuffer ? t : t.buffer, a = new Uint8Array(s, i, 16), o = vg(a, 6); if (0 !== o && 1 !== o && 3 !== o) throw new Error("Invalid magic number in ETC header"); var u = i + 16, h = n - 16; if (n > 0) { var c = new Uint8Array(s, u, h), l = new Uint8Array(r._data.byteLength + c.byteLength); l.set(r._data), l.set(c, r._data.byteLength), r._data = l, r.mipmapLevelDataSize[e] = h } else r._data = new Uint8Array(s, u); r.width = e > 0 ? r.width : vg(a, 12), r.height = e > 0 ? r.height : vg(a, 14) }, i.parseASTCTexture = function (t, e, i, n, r) { var s = t instanceof ArrayBuffer ? t : t.buffer, a = new Uint8Array(s, i, 16); if (1554098963 !== a[0] + (a[1] << 8) + (a[2] << 16) + (a[3] << 24)) throw new Error("Invalid magic number in ASTC header"); var o = a[4], u = a[5], h = a[6]; if ((o < 3 || o > 6 || u < 3 || u > 6 || h < 3 || h > 6) && (o < 4 || 7 === o || 9 === o || 11 === o || o > 12 || u < 4 || 7 === u || 9 === u || 11 === u || u > 12 || 1 !== h)) throw new Error("Invalid block number in ASTC header"); var c = mg(o, u), l = i + 16, f = n - 16; if (n > 0) { var d = new Uint8Array(s, l, f), p = new Uint8Array(r._data.byteLength + d.byteLength); p.set(r._data), p.set(d, r._data.byteLength), r._data = p, r.mipmapLevelDataSize[e] = f } else r._data = new Uint8Array(s, l); r.width = e > 0 ? r.width : a[7] + (a[8] << 8) + (a[9] << 16), r.height = e > 0 ? r.height : a[10] + (a[11] << 8) + (a[12] << 16), r.format = c }; var e = i.prototype; function i(e) { var i; return (i = t.call(this) || this)._nativeData = void 0, i._exportedExts = void 0, i._format = 35, i._width = 0, i._height = 0, i._nativeData = { _data: null, width: 0, height: 0, format: 0, _compressed: !1, mipmapLevelDataSize: [] }, void 0 !== e && i.reset(e), i } return e.extractMipmap0 = function () { if (this.mipmapLevelDataSize && this.mipmapLevelDataSize.length > 0) { var t = this.mipmapLevelDataSize[0], e = this.data, n = new i({ _data: new Uint8Array(e.buffer, 0, t), _compressed: !0, width: this.width, height: this.height, format: this.format, mipmapLevelDataSize: [] }); return n._uuid = "" + this._uuid, n } return this }, e.extractMipmaps = function () { var t = []; if (this.mipmapLevelDataSize && this.mipmapLevelDataSize.length > 0) for (var e, n = this.mipmapLevelDataSize, r = this.data, s = 0, a = this.height, o = this.width, u = p(n); !(e = u()).done;) { var h = e.value, c = new i({ _data: new Uint8Array(r.buffer, s, h), _compressed: !0, width: o, height: a, format: this.format, mipmapLevelDataSize: [] }); s += h, c._uuid = "" + this._uuid, o = Math.max(o >> 1, 1), a = Math.max(a >> 1, 1), t.push(c) } else t.push(this); return t }, e.reset = function (t) { yg(t) || t instanceof HTMLElement ? this._nativeData = t : (this._nativeData = t, this._format = t.format) }, e.destroy = function () { if (this.data && this.data instanceof HTMLImageElement) this.data.src = "", this._setRawAsset(""); else if (yg(this.data)) { var e; null == (e = this.data) || e.close() } return t.prototype.destroy.call(this) }, e._serialize = function () { }, e._deserialize = function (t) { var e = ""; "string" == typeof t ? e = t : (this._width = t.w, this._height = t.h, e = t.fmt); for (var n, r = B_.gfxDevice, s = e.split("_"), a = Number.MAX_VALUE, o = this._format, u = "", h = Le.SUPPORT_TEXTURE_FORMATS, c = p(s); !(n = c()).done;) { var l = n.value.split("@"), f = parseInt(l[0], void 0), d = i.extnames[f] || l[0], _ = h.indexOf(d); if (-1 !== _ && _ < a) { var g = l[1] ? parseInt(l[1]) : this._format; if (!(".astc" !== d || r && 2 & r.getFormatFeatures(89))) continue; if (!(".pvr" !== d || r && 2 & r.getFormatFeatures(86))) continue; if (!(72 !== g && 1026 !== g || r && 2 & r.getFormatFeatures(72))) continue; if (!(73 !== g && 77 !== g || r && 2 & r.getFormatFeatures(73))) continue; if (".webp" === d && !tu.hasFeature(tu.Feature.WEBP)) continue; a = _, u = d, o = g } } u ? (this._setRawAsset(u), this._format = o) : it(3121) }, e.initDefault = function (e) { if (t.prototype.initDefault.call(this, e), i._sharedPlaceHolderCanvas) this.reset(i._sharedPlaceHolderCanvas); else { var n = E.document.createElement("canvas"), r = n.getContext("2d"), s = n.width = n.height = 2; r.fillStyle = "#ff00ff", r.fillRect(0, 0, s, s), this.reset(n), i._sharedPlaceHolderCanvas = n } }, e.validate = function () { return !!this.data }, n(i, [{ key: "_nativeAsset", get: function () { return this._nativeData }, set: function (t) { t instanceof HTMLElement || yg(t) || (t.format = t.format || this._format), this.reset(t) } }, { key: "data", get: function () { return (t = this._nativeData) instanceof HTMLImageElement || t instanceof HTMLCanvasElement || yg(t) ? this._nativeData : this._nativeData && this._nativeData._data; var t } }, { key: "width", get: function () { return this._nativeData.width || this._width } }, { key: "height", get: function () { return this._nativeData.height || this._height } }, { key: "format", get: function () { return this._format } }, { key: "isCompressed", get: function () { return this._format >= 72 && this._format <= 102 || this._format >= 1024 && this._format <= 1026 } }, { key: "mipmapLevelDataSize", get: function () { return this._nativeData.mipmapLevelDataSize } }, { key: "url", get: function () { return this.nativeUrl } }]), i }(pg), cg.extnames = [".png", ".jpg", ".jpeg", ".bmp", ".webp", ".pvr", ".pkm", ".astc"], cg._sharedPlaceHolderCanvas = null, m((hg = cg).prototype, "_nativeAsset", [Oh], Object.getOwnPropertyDescriptor(hg.prototype, "_nativeAsset"), hg.prototype), ug = hg)) || ug); S.ImageAsset = Pg, De(qf); var Bg, Mg, Og, Lg = new It("Tex"), Fg = Gu("cc.TextureBase")((Rg = function (t) { function e(e) { var i; return (i = t.call(this, e) || this)._format = xg && xg(), i._minFilter = Sg && Sg(), i._magFilter = Tg && Tg(), i._mipFilter = Ig && Ig(), i._wrapS = Eg && Eg(), i._wrapT = Ag && Ag(), i._wrapR = Cg && Cg(), i._anisotropy = Dg && Dg(), i._width = 1, i._height = 1, i._samplerInfo = new rp, i._gfxSampler = null, i._gfxDevice = null, i._textureHash = 0, i._id = Lg.getNewId(), i._gfxDevice = i._getGFXDevice(), i._textureHash = Lf(i._id, 666), i } s(e, t); var i = e.prototype; return i.getId = function () { return this._id }, i.getPixelFormat = function () { return this._format }, i.getAnisotropy = function () { return this._anisotropy }, i.setWrapMode = function (t, e, i) { void 0 === i && (i = t), this._wrapS = t, this._samplerInfo.addressU = t, this._wrapT = e, this._samplerInfo.addressV = e, this._wrapR = i, this._samplerInfo.addressW = i, this._gfxDevice && (this._gfxSampler = this._gfxDevice.getSampler(this._samplerInfo)) }, i.setFilters = function (t, e) { this._minFilter = t, this._samplerInfo.minFilter = t, this._magFilter = e, this._samplerInfo.magFilter = e, this._gfxDevice && (this._gfxSampler = this._gfxDevice.getSampler(this._samplerInfo)) }, i.setMipFilter = function (t) { this._mipFilter = t, this._samplerInfo.mipFilter = t, this._gfxDevice && (this._gfxSampler = this._gfxDevice.getSampler(this._samplerInfo)) }, i.setAnisotropy = function (t) { t = Math.min(t, 16), this._anisotropy = t, this._samplerInfo.maxAnisotropy = t, this._gfxDevice && (this._gfxSampler = this._gfxDevice.getSampler(this._samplerInfo)) }, i.destroy = function () { var e, i = t.prototype.destroy.call(this); return i && null != (e = S.director.root) && e.batcher2D && S.director.root.batcher2D._releaseDescriptorSetCache(this._textureHash), i }, i.getHash = function () { return this._textureHash }, i.getGFXTexture = function () { return null }, i.getSamplerInfo = function () { return this._samplerInfo }, i.getGFXSampler = function () { return this._gfxSampler || (this._gfxDevice ? this._gfxSampler = this._gfxDevice.getSampler(this._samplerInfo) : rt(9302)), this._gfxSampler }, i._serialize = function () { return "" }, i._deserialize = function (t) { var e = t.split(","); e.unshift(""), e.length >= 5 && (this.setFilters(parseInt(e[1]), parseInt(e[2])), this.setWrapMode(parseInt(e[3]), parseInt(e[4]))), e.length >= 7 && (this.setMipFilter(parseInt(e[5])), this.setAnisotropy(parseInt(e[6]))) }, i._getGFXDevice = function () { return B_.gfxDevice }, i._getGFXFormat = function () { return this._getGFXPixelFormat(this._format) }, i._setGFXFormat = function (t) { this._format = void 0 === t ? 35 : t }, i._getGFXPixelFormat = function (t) { return 1026 === t ? t = 72 : 1025 === t ? t = 85 : 1024 === t && (t = 83), t }, n(e, [{ key: "isCompressed", get: function () { return this._format >= 72 && this._format <= 102 || this._format >= 1024 && this._format <= 1026 } }, { key: "width", get: function () { return this._width } }, { key: "height", get: function () { return this._height } }]), e }(pg), Rg.PixelFormat = { RGB565: 47, RGB5A1: 49, RGBA4444: 50, RGB888: 24, RGB32F: 32, RGBA8888: 35, BGRA8888: 36, RGBA32F: 44, A8: 1, I8: 2, AI8: 3, RGB_PVRTC_2BPPV1: 83, RGBA_PVRTC_2BPPV1: 84, RGB_A_PVRTC_2BPPV1: 1024, RGB_PVRTC_4BPPV1: 85, RGBA_PVRTC_4BPPV1: 86, RGB_A_PVRTC_4BPPV1: 1025, RGB_ETC1: 72, RGBA_ETC1: 1026, RGB_ETC2: 73, RGBA_ETC2: 77, RGBA_ASTC_4x4: 89, RGBA_ASTC_5x4: 90, RGBA_ASTC_5x5: 91, RGBA_ASTC_6x5: 92, RGBA_ASTC_6x6: 93, RGBA_ASTC_8x5: 94, RGBA_ASTC_8x6: 95, RGBA_ASTC_8x8: 96, RGBA_ASTC_10x5: 97, RGBA_ASTC_10x6: 98, RGBA_ASTC_10x8: 99, RGBA_ASTC_10x10: 100, RGBA_ASTC_12x10: 101, RGBA_ASTC_12x12: 102 }, Rg.WrapMode = { REPEAT: 0, CLAMP_TO_EDGE: 2, MIRRORED_REPEAT: 1, CLAMP_TO_BORDER: 3 }, Rg.Filter = { NONE: 0, LINEAR: 2, NEAREST: 1 }, xg = Bu((wg = Rg).prototype, "_format", [eh], (function () { return 35 })), Sg = Bu(wg.prototype, "_minFilter", [eh], (function () { return 2 })), Tg = Bu(wg.prototype, "_magFilter", [eh], (function () { return 2 })), Ig = Bu(wg.prototype, "_mipFilter", [eh], (function () { return 0 })), Eg = Bu(wg.prototype, "_wrapS", [eh], (function () { return 0 })), Ag = Bu(wg.prototype, "_wrapT", [eh], (function () { return 0 })), Cg = Bu(wg.prototype, "_wrapR", [eh], (function () { return 0 })), Dg = Bu(wg.prototype, "_anisotropy", [eh], (function () { return 0 })), bg = wg)) || bg; S.TextureBase = Fg; var kg = t("Script", Gu("cc.Script")(Bg = function (t) { function e(e) { return t.call(this, e) || this } return s(e, t), e }(pg)) || Bg); S._Script = kg; var Ng = t("JavaScript", Gu("cc.JavaScript")(Mg = function (t) { function e(e) { return t.call(this, e) || this } return s(e, t), e }(kg)) || Mg); S._JavaScript = Ng; var zg, Ug, Vg, Gg, Hg, Wg, jg, Xg = t("TypeScript", Gu("cc.TypeScript")(Og = function (t) { function e(e) { return t.call(this, e) || this } return s(e, t), e }(kg)) || Og); S._TypeScript = Xg; var qg, Yg, Kg, Qg, Zg, Jg, $g, tm, em, im, nm, rm = t("EventHandler", Gu("cc.ClickEvent")((Ug = function () { function t() { this.target = Vg && Vg(), this.component = Gg && Gg(), this._componentId = Hg && Hg(), this.handler = Wg && Wg(), this.customEventData = jg && jg() } t.emitEvents = function (e) { for (var i = arguments.length, n = new Array(i > 1 ? i - 1 : 0), r = 1; r < i; r++)n[r - 1] = arguments[r]; for (var s = 0, a = e.length; s < a; s++) { var o = e[s]; o instanceof t && o.emit(n) } }; var e = t.prototype; return e.emit = function (t) { var e = this.target; if (T.isValid(e)) { this._genCompIdIfNeeded(); var i = T.js.getClassById(this._componentId), n = e.getComponent(i); if (T.isValid(n)) { var r = n[this.handler]; "function" == typeof r && (null != this.customEventData && "" !== this.customEventData && (t = t.slice()).push(this.customEventData), r.apply(n, t)) } } }, e._compName2Id = function (t) { var e = T.js.getClassByName(t); return T.js.getClassId(e) }, e._compId2Name = function (t) { var e = T.js.getClassById(t); return T.js.getClassName(e) }, e._genCompIdIfNeeded = function () { this._componentId || (this._componentName = this.component, this.component = "") }, n(t, [{ key: "_componentName", get: function () { return this._genCompIdIfNeeded(), this._compId2Name(this._componentId) }, set: function (t) { this._componentId = this._compName2Id(t) } }]), t }(), Vg = Bu(Ug.prototype, "target", [eh], (function () { return null })), Gg = Bu(Ug.prototype, "component", [eh], (function () { return "" })), Hg = Bu(Ug.prototype, "_componentId", [eh], (function () { return "" })), Wg = Bu(Ug.prototype, "handler", [eh], (function () { return "" })), jg = Bu(Ug.prototype, "customEventData", [eh], (function () { return "" })), zg = Ug)) || zg), sm = new It("Comp"), am = t("Component", (qg = Gu("cc.Component"), Yg = Ih(kg), qg((tm = function (t) { function e() { var e; return (e = t.call(this) || this).node = Zg && Zg(), e._enabled = Jg && Jg(), e.__prefab = $g && $g(), e._sceneGetter = null, e._id = sm.getNewId(), e } s(e, t); var i = e.prototype; return i._getRenderScene = function () { return this._sceneGetter ? this._sceneGetter() : this.node.scene.renderScene }, i.addComponent = function (t) { return this.node.addComponent(t) }, i.getComponent = function (t) { return this.node.getComponent(t) }, i.getComponents = function (t) { return this.node.getComponents(t) }, i.getComponentInChildren = function (t) { return this.node.getComponentInChildren(t) }, i.getComponentsInChildren = function (t) { return this.node.getComponentsInChildren(t) }, i.destroy = function () { return !!t.prototype.destroy.call(this) && (this._enabled && this.node.activeInHierarchy && T.director._compScheduler.disableComp(this), !0) }, i._onPreDestroy = function () { this.unscheduleAllCallbacks(), T.director._nodeActivator.destroyComp(this), this.node._removeComponent(this) }, i._instantiate = function (t) { return t || (t = T.instantiate._clone(this, this)), t && (t.node = null), t }, i.schedule = function (t, e, i, n) { void 0 === e && (e = 0), void 0 === i && (i = T.macro.REPEAT_FOREVER), void 0 === n && (n = 0), at(Boolean(t), 1619), at((e = e || 0) >= 0, 1620), i = Number.isNaN(i) ? T.macro.REPEAT_FOREVER : i, n = n || 0; var r = T.director.getScheduler(), s = r.isTargetPaused(this); r.schedule(t, this, e, i, n, s) }, i.scheduleOnce = function (t, e) { void 0 === e && (e = 0), this.schedule(t, 0, 0, e) }, i.unschedule = function (t) { t && T.director.getScheduler().unschedule(t, this) }, i.unscheduleAllCallbacks = function () { T.director.getScheduler().unscheduleAllForTarget(this) }, n(e, [{ key: "name", get: function () { if (this._name) return this._name; var t = zt(this), e = t.lastIndexOf("."); return e >= 0 && (t = t.slice(e + 1)), this.node ? this.node.name + "<" + t + ">" : t }, set: function (t) { this._name = t } }, { key: "uuid", get: function () { return this._id } }, { key: "__scriptAsset", get: function () { return null } }, { key: "enabled", get: function () { return this._enabled }, set: function (t) { if (this._enabled !== t && (this._enabled = t, this.node.activeInHierarchy)) { var e = T.director._compScheduler; t ? e.enableComp(this) : e.disableComp(this) } } }, { key: "enabledInHierarchy", get: function () { return this._enabled && this.node && this.node.activeInHierarchy } }, { key: "_isOnLoadCalled", get: function () { return 16384 & this._objFlags } }, { key: "internalUpdate", get: function () { return this.update } }, { key: "internalLateUpdate", get: function () { return this.lateUpdate } }, { key: "internalPreload", get: function () { return this.__preload } }, { key: "internalOnLoad", get: function () { return this.onLoad } }, { key: "internalStart", get: function () { return this.start } }, { key: "internalOnEnable", get: function () { return this.onEnable } }, { key: "internalOnDisable", get: function () { return this.onDisable } }, { key: "internalOnDestroy", get: function () { return this.onDestroy } }]), e }(oo), tm.EventHandler = rm, tm._executionOrder = 0, tm._requireComponent = null, tm.system = null, m((Qg = tm).prototype, "__scriptAsset", [Yg], Object.getOwnPropertyDescriptor(Qg.prototype, "__scriptAsset"), Qg.prototype), Zg = Bu(Qg.prototype, "node", [eh], (function () { return null })), Jg = Bu(Qg.prototype, "_enabled", [eh], (function () { return !0 })), $g = Bu(Qg.prototype, "__prefab", [eh], (function () { return null })), Kg = Qg)) || Kg)); Ot(am, "_registerEditorProps", (function (t, e) { var i = e.requireComponent; i && (Array.isArray(i) && (i = i.filter(Boolean)), t._requireComponent = i); var n = e.executionOrder; n && "number" == typeof n && (t._executionOrder = n) })), T.Component = am; var om = t("MissingScript", Gu("cc.MissingScript")((im = function (t) { function e() { var e; return (e = t.call(this) || this)._$erialized = nm && nm(), e } return s(e, t), e.safeFindClass = function (t) { var e = he(t); if (e) return e; S.deserialize.reportMissingClass(t) }, e.prototype.onLoad = function () { it(4600, this.node.name) }, e }(am), nm = Bu(im.prototype, "_$erialized", [eh, nh], (function () { return null })), em = im)) || em); S._MissingScript = om; try { var um = om.__values__; 0 !== um.length && "_$erialized" === um[um.length - 1] || (rt(16338), rt(16339, um.join(", "))) } catch (Ts) { rt(16340, "" + Ts) } var hm = function () { function t(t, e) { this._document = t, this._chunks = e } return n(t, [{ key: "document", get: function () { return this._document } }, { key: "chunks", get: function () { return this._chunks } }]), t }(); function cm(t) { var e = t; return { chunks: e.chunks, document: e.document } } function lm(t) { if (t.length < 16) throw new dm(ut(13102)); var e = new DataView(t.buffer, t.byteOffset, t.byteLength); if (1313817411 !== e.getUint32(0, !0)) throw new dm(ut(13100)); var i = e.getUint32(4, !0); if (1 !== i) throw new dm(ut(13101, i)); if (e.getUint32(8, !0) !== e.byteLength) throw new dm(ut(13102)); var n = 12, r = e.getUint32(n, !0); n += 4; var s = new Uint8Array(e.buffer, n + e.byteOffset, r); n += r; var a, o = fm(s); try { a = JSON.parse(o) } catch (t) { throw new dm(t) } for (var u = []; n < e.byteLength;) { n % 8 != 0 && (n += 8 - n % 8); var h = e.getUint32(n, !0); n += 4, u.push(new Uint8Array(e.buffer, n + e.byteOffset, h)), n += h } if (n !== e.byteLength) throw new dm(ut(13102)); return new hm(a, u) } function fm(t) { if ("undefined" != typeof TextDecoder) return (new TextDecoder).decode(t); if ("Buffer" in globalThis) return globalThis.Buffer.from(t.buffer, t.byteOffset, t.byteLength).toString(); throw new Error(ut(13104)) } var dm = function (t) { function e() { return t.apply(this, arguments) || this } return s(e, t), e }(c(Error)); function pm(t, e, i, n, r) { if (e instanceof S.ValueType) { r || t.push("if(prop){"); var s = zt(e); t.push("s._deserializeFastDefinedObject(o" + i + ",prop," + s + ");"), r || t.push("}else o" + i + "=null;") } else t.push("\nif (prop) {\n    s._deserializeAndAssignField(o, prop, " + n + ");\n} else {\n    o" + i + "=null;\n}\n") } !function () { function t() { this._viewOrPaddings = [], this._length = 0 } var e = t.prototype; e.alignAs = function (t) { if (0 !== t) { var e = this._length % t; if (0 !== e) { var i = t - e; return this._viewOrPaddings.push(i), this._length += i, i } } return 0 }, e.append = function (t) { var e = this._length; return this._viewOrPaddings.push(t), this._length += t.byteLength, e }, e.get = function () { var t = new Uint8Array(this._length), e = 0; return this._viewOrPaddings.forEach((function (i) { "number" == typeof i ? e += i : (t.set(new Uint8Array(i.buffer, i.byteOffset, i.byteLength), e), e += i.byteLength) })), t }, n(t, [{ key: "byteLength", get: function () { return this._length } }]) }(), S.internal.parseCCONJson = cm, S.internal.decodeCCONBinary = lm, S.internal.CCON = hm; var _m = function (t, e) { for (var i = Pi.Attr.getClassAttrs(e), n = e.__values__, r = ["var prop;"], s = bm(e), a = 0; a < n.length; a++) { var o = n[a], u = void 0, h = void 0; Pi.IDENTIFIER_RE.test(o) ? (h = '"' + o + '"', u = "." + o) : u = "[" + (h = Pi.escapeForJS(o)) + "]"; var c = u; if (i[o + ym]) { var l = i[o + ym]; c = Pi.IDENTIFIER_RE.test(l) ? "." + l : "[" + Pi.escapeForJS(l) + "]" } r.push("prop=d" + c + ";"), r.push('if(typeof prop!=="undefined"){'); var f = Pi.getDefault(i[o + vm]), d = i[o + mm]; s && (void 0 !== f || d) ? wm(f, d) ? r.push("o" + u + "=prop;") : pm(r, f, u, h, !0) : (r.push('if(typeof prop!=="object"){o' + u + "=prop;}else{"), pm(r, f, u, h, !1), r.push("}")), r.push("}") } return (Jt(e, S.Node) || Jt(e, S.Component)) && r.push("d._id&&(o._id=d._id);"), "_$erialized" === n[n.length - 1] && (r.push("o._$erialized=JSON.parse(JSON.stringify(d));"), r.push("s._fillPlainObject(o._$erialized,d);")), Function("s", "o", "d", "k", r.join("")) }, gm = Pi.Attr.DELIMETER, mm = gm + "type", vm = gm + "default", ym = gm + "formerlySerializedAs"; function bm(t) { return ke.test(fe(t)) } function wm(t, e) { if (void 0 === t) return e instanceof Pi.Attr.PrimitiveType || e === wi || e === xi; var i = typeof t; return "string" === i || "number" === i || "boolean" === i } var xm = function (t) { function e() { return t.call(this, (function (t) { t.clear() }), 1) || this } return s(e, t), e }(de); xm.prototype.get = function (t, e, i, n, r) { var s = this._get(); return s ? (s.reset(t, e, i, n, r), s) : new Sm(t, e, i, n, r) }; var Sm = function () { function t(t, e, i, n) { this.deserializedList = [], this.deserializedData = null, this.result = t, this.customEnv = n, this._classFinder = e, this._reportMissingClass = i, this._onDereferenced = null == e ? void 0 : e.onDereferenced } var e = t.prototype; return e.reset = function (t, e, i, n) { this.result = t, this.customEnv = n, this._classFinder = e, this._reportMissingClass = i, this._onDereferenced = null == e ? void 0 : e.onDereferenced }, e.clear = function () { this.result = null, this.customEnv = null, this.deserializedList.length = 0, this.deserializedData = null, this._classFinder = null, this._reportMissingClass = null, this._onDereferenced = null }, e.deserialize = function (t) { var e, i = !1; t instanceof hm ? (i = !0, e = t.document, t.chunks.length > 0 && (t.chunks.length, this._mainBinChunk = t.chunks[0])) : e = t, this._serializedData = e, this._context = { fromCCON: i }; var n = Array.isArray(e) ? e[0] : e; return this.deserializedData = this._deserializeObject(n, 0), this._serializedData = void 0, this._mainBinChunk = void 0, this._context = void 0, this.deserializedData }, e._deserializeObject = function (t, e, i, n) { switch (t.__type__) { case "TypedArray": return this._deserializeTypedArrayView(t); case "TypedArrayRef": return this._deserializeTypedArrayViewRef(t); default: return t.__type__ ? this._deserializeTypeTaggedObject(t, e, i, n) : Array.isArray(t) ? this._deserializeArray(t) : this._deserializePlainObject(t) } }, e._deserializeTypedArrayView = function (t) { return globalThis[t.ctor].from(t.array) }, e._deserializeTypedArrayViewRef = function (t) { var e = t.offset, i = t.length, n = t.ctor; return new globalThis[n](this._mainBinChunk.buffer, this._mainBinChunk.byteOffset + e, i) }, e._deserializeArray = function (t) { for (var e, i = new Array(t.length), n = 0; n < t.length; n++)"object" == typeof (e = t[n]) && e ? this._deserializeAndAssignField(i, e, "" + n) && (i[n] = null) : i[n] = e; return i }, e._deserializePlainObject = function (t) { var e = {}; return this._fillPlainObject(e, t), e }, e._deserializeTypeTaggedObject = function (t, e, i, n) { var r = this, s = t.__type__, a = this._classFinder(s, t, i, n); if (!a) return this._classFinder === he && this._reportMissingClass(s), null; var o = function (t) { var i = new t; return e >= 0 && (r.deserializedList[e] = i), i }(a); return this._deserializeInto(t, o, a), o }, e._deserializeInto = function (t, e, i, n) { void 0 === n && (n = !1), n || !e[Gh] ? e._deserialize ? e._deserialize(t.content, this) : S.Class._isCCClass(i) ? this._deserializeFireClass(e, t, i) : this._deserializeFastDefinedObject(e, t, i) : this._runCustomizedDeserialize(t, e, i) }, e._runCustomizedDeserialize = function (t, e, i) { var n = this, r = { readProperty: function (e) { var i = t[e]; return "object" == typeof i && i ? n._deserializeObjectField(i) : i }, readThis: function () { n._deserializeInto(t, e, i, !0) }, readSuper: function () { var r = Zt(i); r && n._deserializeInto(t, e, r) } }; e[Gh](r, this._context) }, e._deserializeFireClass = function (t, e, i) { var n; if (i.hasOwnProperty("__deserialize__")) n = i.__deserialize__; else { n = _m(0, i); try { if (i === om) { var r = i.__values__; 0 !== r.length && "_$erialized" === r[r.length - 1] || (rt(16341), rt(16342, r.join(", "))); var s = n; n = function (t, e, i, n) { s(t, e, i, n), e._$erialized || rt(16343, JSON.stringify(i)) } } } catch (t) { rt(16344, "" + t) } Ot(i, "__deserialize__", n, !0) } n(this, t, e, i) }, e._deserializeAndAssignField = function (t, e, i) { var n = e.__id__; if ("number" == typeof n) { var r = this.deserializedList[n]; if (r) t[i] = r; else { var s, a = this._serializedData[n]; t[i] = this._deserializeObject(a, n, void 0, i), null == (s = this._onDereferenced) || s.call(this, this.deserializedList, n, t, i) } } else { var o = e.__uuid__; if (o) { var u = e.__expectedType__; this.result.push(t, i, o, u) } else t[i] = this._deserializeObject(e, -1) } return !1 }, e._deserializeObjectField = function (t) { var e = t.__id__; if ("number" == typeof e) { var i = this.deserializedList[e]; if (i) return i; var n = this._serializedData[e]; return this._deserializeObject(n, e, void 0, void 0) } if (t.__uuid__) throw t.__expectedType__, new Error("Asset reference field serialization is currently not supported in custom serialization."); return this._deserializeObject(t, -1) }, e._fillPlainObject = function (t, e) { for (var i in e) if (e.hasOwnProperty(i)) { var n = e[i]; "object" != typeof n ? "__type__" !== i && (t[i] = n) : n ? this._deserializeAndAssignField(t, n, i) && (t[i] = null) : t[i] = null } }, e._deserializeFastDefinedObject = function (t, e, i) { if (i === S.Vec2) return t.x = e.x || 0, void (t.y = e.y || 0); if (i === S.Vec3) return t.x = e.x || 0, t.y = e.y || 0, void (t.z = e.z || 0); if (i !== S.Color) { if (i === S.Size) return t.width = e.width || 0, void (t.height = e.height || 0); for (var n = Pi.Attr.getClassAttrs(i), r = i.__values__, s = 0; s < r.length; s++) { var a = r[s], o = e[a]; void 0 !== o || e.hasOwnProperty(a) || (o = Pi.getDefault(n[a + vm])), "object" != typeof o ? t[a] = o : o ? this._deserializeAndAssignField(t, o, a) : t[a] = null } } else { t.r = e.r || 0, t.g = e.g || 0, t.b = e.b || 0; var u = e.a; t.a = void 0 === u ? 255 : u } }, n(t, [{ key: "ignoreEditorOnly", get: function () { return this._ignoreEditorOnly } }]), t }(); function Tm(t, e, i) { var n, r = (i = i || {}).classFinder || he, s = i.createAssetRefs || tu.platform === Eo.EDITOR_CORE, a = i.customEnv, o = i.ignoreEditorOnly, u = null !== (n = i.reportMissingClass) && void 0 !== n ? n : S.deserialize.reportMissingClass; e.init(); var h = Sm.pool.get(e, r, u, a, o); S.game._isCloning = !0; var c = h.deserialize(t); return S.game._isCloning = !1, Sm.pool.put(h), s && e.assignAssetsBy((function (t, e) { return EditorExtends.serialize.asAsset(t, e.type) })), c } Sm.pool = new xm; var Im = [as, Kn, Pn, Er, rr, us, fs, Gr]; function Em(t, e) { t.x = e[1], t.y = e[2], t.z = e[3], t.w = e[4] } var Am = [function (t, e) { t.x = e[1], t.y = e[2] }, function (t, e) { t.x = e[1], t.y = e[2], t.z = e[3] }, Em, Em, function (t, e) { rr.fromUint32(t, e[1]) }, function (t, e) { t.width = e[1], t.height = e[2] }, function (t, e) { t.x = e[1], t.y = e[2], t.width = e[3], t.height = e[4] }, function (t, e) { Gr.fromArray(t, e, 1) }], Cm = 1, Dm = 0, Rm = 0, Pm = 1, Bm = 2, Mm = 0, Om = 0, Lm = t("Details", function () { function t() { this.uuidObjList = null, this.uuidPropList = null, this.uuidList = null, this.uuidTypeList = [] } var e = t.prototype; return e.init = function (t) { t ? (this.uuidObjList = t[8], this.uuidPropList = t[9], this.uuidList = t[10]) : this.uuidList || (this.uuidList = [], this.uuidObjList = [], this.uuidPropList = [], this.uuidTypeList = []) }, e.reset = function () { this.uuidList && (this.uuidList.length = 0, this.uuidObjList.length = 0, this.uuidPropList.length = 0, this.uuidTypeList.length = 0) }, e.push = function (t, e, i, n) { this.uuidObjList.push(t), this.uuidPropList.push(e), this.uuidList.push(i), this.uuidTypeList.push(n || "") }, t }()); function Fm(t, e, i) { for (var n = t.length - 1, r = 0, s = 3 * t[n]; r < s; r += 3) { var a = t[r], o = e[t[r + 2]], u = t[r + 1]; u >= 0 ? a[i[u]] = o : a[~u] = o } for (; r < n; r += 3) { var h = e[t[r]], c = e[t[r + 2]], l = t[r + 1]; l >= 0 ? h[i[l]] = c : h[~l] = c } } function km(t, e) { for (var i = t[4][e[Om]], n = i[Mm], r = new (0, n[Rm]), s = n[Pm], a = n[Bm], o = i[i.length - 1], u = Mm + 1; u < o; ++u)r[s[i[u]]] = e[u]; for (; u < e.length; ++u) { var h = s[i[u]], c = n[i[u] + a]; (0, Hm[c])(t, r, h, e[u]) } return r } function Nm(t, e, i) { var n = new e; return n._deserialize ? n._deserialize(i, t[0]) : rt(5303, zt(e)), n } function zm(t, e, i, n) { n >= 0 ? e[i] = t[5][n] : t[7][3 * ~n] = e } function Um(t) { return function (e, i, n, r) { for (var s = 0; s < r.length; ++s)t(e, r, s, r[s]); i[n] = r } } function Vm(t, e, i, n) { e[i] = null, t[8][n] = e } function Gm(t, e, i, n) { e[i] = km(t, n) } Lm.pool = new de((function (t) { t.reset() }), 5), Lm.pool.get = function () { return this._get() || new Lm }; var Hm = new Array(13); function Wm(t) { var e = t[5], i = t[6], n = i === Dm ? 0 : i.length, r = e[e.length - 1], s = e.length - n; "number" != typeof r ? r = 0 : (r < 0 && (r = ~r), --s); for (var a = 0; a < s; ++a)e[a] = km(t, e[a]); for (var o = t[3], u = 0; u < n; ++u, ++a) { var h = i[u], c = e[a]; if (h >= 0) { var l = o[h]; e[a] = Nm(t, l, c) } else (0, Hm[h = ~h])(t, e, a, c) } return r } function jm(t, e, i) { return t || i(e), Object } function Xm(t, e, i, n, r, s, a) { var o = t(e); if (!o) { if (r) return void (i[n] = function (e, i, n) { return function () { var r = t(n) || jm(s, n, a); return e[i] = r, new r } }(i, n, e)); o = jm(s, e, a) } i[n] = o } function qm(t, e, i, n) { for (var r = i || he, s = t[3], a = 0; a < s.length; ++a) { var o = s[a]; "string" != typeof o ? Xm(r, o[Rm], o, Rm, e, i, n) : Xm(r, o, s, a, e, i, n) } } function Ym(t) { var e = t[4]; if (e) for (var i = t[3], n = 0; n < e.length; ++n) { var r = e[n]; r[Mm] = i[r[Mm]] } } function Km(t) { for (var e = t[5], i = t[2], n = t[1], r = t[8], s = t[9], a = t[10], o = 0; o < r.length; ++o) { var u = r[o]; "number" == typeof u && (r[o] = e[u]); var h = s[o]; "number" == typeof h && (h = h >= 0 ? i[h] : ~h, s[o] = h); var c = a[o]; "number" == typeof c && (a[o] = n[c]) } } function Qm(t) { if (Array.isArray(t)) { var e = t[0]; return "number" == typeof e || e instanceof $m } return !1 } function Zm(t, e, i) { var n; e.init(t), null !== (n = i) && void 0 !== n || (i = {}); var r = t[0], s = !1; if ("object" == typeof r && (s = r.preprocessed, r = r.version), r < Cm) throw new Error(ut(5304, r)); var a, o = i; o._version = r, o.result = e, t[0] = o, s || (qm(t, !1, i.classFinder, null !== (a = i.reportMissingClass) && void 0 !== a ? a : Jm.reportMissingClass), Ym(t)) } function Jm(t, e, i) { "string" == typeof t && (t = JSON.parse(t)); var n, r = !1; if (e || (e = Lm.pool.get(), r = !0), Qm(t)) { Zm(t, e, i); var s = t; S.game._isCloning = !0; var a = s[5], o = Wm(s); S.game._isCloning = !1, s[7] && Fm(s[7], a, s[2]), Km(s), n = a[o] } else n = Tm(t, e, i); return r && Lm.pool.put(e), n } Hm[0] = function (t, e, i, n) { e[i] = n }, Hm[1] = zm, Hm[2] = Um(zm), Hm[3] = Um(Vm), Hm[4] = Gm, Hm[5] = function (t, e, i, n) { var r = n[0], s = e[i]; (0, Am[r])(s, n) }, Hm[6] = Vm, Hm[7] = function (t, e, i, n) { e[i].set(n) }, Hm[8] = function (t, e, i, n) { var r = n[0], s = new Im[r]; (0, Am[r])(s, n), e[i] = s }, Hm[9] = Um(Gm), Hm[10] = function (t, e, i, n) { var r = t[3][n[0]]; e[i] = Nm(t, r, n[1]) }, Hm[11] = function (t, e, i, n) { var r = n[0]; e[i] = r; for (var s = 1; s < n.length; s += 3) { var a = n[s], o = n[s + 1], u = n[s + 2]; (0, Hm[o])(t, r, a, u) } }, Hm[12] = function (t, e, i, n) { for (var r = n[0], s = 0; s < r.length; ++s) { var a = r[s], o = n[s + 1]; 0 !== o && (0, Hm[o])(t, r, s, a) } e[i] = r }, Jm.Details = Lm, Jm.reportMissingClass = function (t) { rt(5302, t) }; var $m = function (t) { this.preprocessed = !0, this.version = t }; function tv(t, e) { if (t[0] < Cm) throw new Error(ut(5304, t[0])); qm(t, !0, e, Jm.reportMissingClass), Ym(t); for (var i = new $m(t[0]), n = t[1], r = t[2], s = t[3], a = t[4], o = t[5], u = 0; u < o.length; ++u)o[u].unshift(i, n, r, s, a); return o } function ev(t, e, i) { return [Cm, Dm, Dm, [t], Dm, i ? [e, -1] : [e], [0], Dm, [], [], []] } function iv(t) { return i = (e = t)[1], e[10].map((function (t) { return i[t] })); var e, i } S.deserialize = Jm; var nv = new WeakMap, rv = new WeakSet, sv = new WeakSet; function av(t, e) { var i; i = om.safeFindClass; var n, r = Lm.pool.get(); try { n = Jm(t, r, { classFinder: i, customEnv: e }) } catch (t) { throw j(t), Lm.pool.put(r), t } n._uuid = e.__uuid__ || ""; for (var s = r.uuidList, a = r.uuidObjList, o = r.uuidPropList, u = r.uuidTypeList || [], h = [], c = 0; c < s.length; c++) { var l = s[c]; h[c] = { uuid: J_(l), owner: a[c], prop: o[c], type: he(u[c]) } } return nv.set(n, h), n._native && rv.add(n), Lm.pool.put(r), n } var ov = function () { function t() { this._depends = new F_ } var e = t.prototype; return e.init = function () { this._depends.clear() }, e.getNativeDep = function (t) { var e = this._depends.get(t); return e && e.nativeDep ? r({}, e.nativeDep) : null }, e.getDeps = function (t) { return this._depends.has(t) ? this._depends.get(t).deps : [] }, e.getDepsRecursively = function (t) { var e = Object.create(null), i = []; return this._descend(t, e, i), i }, e.remove = function (t) { this._depends.remove(t) }, e.parse = function (t, e) { var i, n, r = null; if (Array.isArray(e) || e.__type__ || e instanceof hm) { if (this._depends.has(t)) return this._depends.get(t); if (!Array.isArray(e) || "number" == typeof (n = (i = e[5])[i.length - 1]) && n < 0) try { var s = av(e, { __uuid__: t }); (r = this._parseDepsFromAsset(s)).nativeDep && (r.nativeDep.uuid = t), U_.add(t + "@import", s) } catch (e) { z_.remove(t + "@import"), r = { deps: [] } } else r = { deps: this._parseDepsFromJson(e) } } else { if (this._depends.has(t) && (r = this._depends.get(t)).parsedFromExistAsset) return r; r = this._parseDepsFromAsset(e) } return this._depends.add(t, r), r }, e._parseDepsFromAsset = function (t) { for (var e = { deps: [], parsedFromExistAsset: !0 }, i = nv.get(t), n = 0, r = i.length; n < r; n++)e.deps.push(i[n].uuid); return rv.has(t) && (e.nativeDep = t._nativeDep), e }, e._parseDepsFromJson = function (t) { var e = iv(t); return e.forEach((function (t, i) { return e[i] = J_(t) })), e }, e._descend = function (t, e, i) { for (var n = this.getDeps(t), r = 0; r < n.length; r++) { var s = n[r]; e[s] || (e[s] = !0, i.push(s), this._descend(s, e, i)) } }, n(t, null, [{ key: "instance", get: function () { return this._instance || (this._instance = new t), this._instance } }]), t }(); ov._instance = void 0; var uv, hv = ov.instance, cv = [new Wd]; function lv(t, e) { for (var i = Math.max(t, e), n = 0; i;)i >>= 1, n++; return n } function fv(t) { return t && !(t & t - 1) } function dv(t, e, i) { return !(6 === t.gfxAPI) || fv(e) && fv(i) } var pv, _v, gv, mv, vv, yv = Gu("cc.SimpleTexture")(uv = function (t) { function e(e) { var i; return (i = t.call(this, e) || this)._gfxTexture = null, i._gfxTextureView = null, i._mipmapLevel = 1, i._textureWidth = 0, i._textureHeight = 0, i._baseLevel = 0, i._maxLevel = 1e3, i } s(e, t); var i = e.prototype; return i.getGFXTexture = function () { return this._gfxTextureView }, i.destroy = function () { return this._tryDestroyTextureView(), this._tryDestroyTexture(), t.prototype.destroy.call(this) }, i.updateImage = function () { this.updateMipmaps(0) }, i.updateMipmaps = function () { }, i.uploadData = function (t, e, i) { if (void 0 === e && (e = 0), void 0 === i && (i = 0), this._gfxTexture && !(this._mipmapLevel <= e)) { var n = this._getGFXDevice(); if (n) { var r = cv[0]; r.texExtent.width = this._textureWidth >> e, r.texExtent.height = this._textureHeight >> e, r.texSubres.mipLevel = e, r.texSubres.baseArrayLayer = i, ArrayBuffer.isView(t) ? n.copyBuffersToTexture([t], this._gfxTexture, cv) : n.copyTexImagesToTexture([t], this._gfxTexture, cv) } } }, i._assignImage = function (t, e, i) { var n = t.data; if (n && (this.uploadData(n, e, i), this._checkTextureLoaded(), Le.CLEANUP_IMAGE_CACHE)) { var r = hv.getDeps(this._uuid), s = r.indexOf(t._uuid); -1 !== s && (ge(r, s), t.decRef()) } }, i._checkTextureLoaded = function () { this._textureReady() }, i._textureReady = function () { this.loaded = !0, this.emit("load") }, i._setMipmapLevel = function (t) { this._mipmapLevel = t < 1 ? 1 : t }, i._setMipRange = function (t, e) { this._baseLevel = t < 1 ? 0 : t, this._maxLevel = e < 1 ? 0 : e }, i.setMipRange = function (t, e) { at(t <= e, 3124), this._setMipRange(t, e); var i = this._getGFXDevice(); if (i) { var n = this._createTextureView(i); this._tryDestroyTextureView(), this._gfxTextureView = n } }, i._getGfxTextureCreateInfo = function () { return null }, i._getGfxTextureViewCreateInfo = function () { return null }, i._tryReset = function () { if (this._tryDestroyTextureView(), this._tryDestroyTexture(), 0 !== this._mipmapLevel) { var t = this._getGFXDevice(); t && (this._createTexture(t), this._gfxTextureView = this._createTextureView(t)) } }, i.isUsingOfflineMipmaps = function () { return !1 }, i._createTexture = function (t) { if (0 !== this._width && 0 !== this._height) { var e = 0; 0 !== this._mipFilter && dv(t, this._width, this._height) && (this._mipmapLevel = lv(this._width, this._height), this.isUsingOfflineMipmaps() || this.isCompressed || (e = 1)); var i = this._getGfxTextureCreateInfo({ usage: 22, format: this._getGFXFormat(), levelCount: this._mipmapLevel, flags: e }); if (i) { var n = t.createTexture(i); this._textureWidth = i.width, this._textureHeight = i.height, this._gfxTexture = n } } }, i._createTextureView = function (t) { if (!this._gfxTexture) return null; var e = this._maxLevel < this._mipmapLevel ? this._maxLevel : this._mipmapLevel - 1, i = this._getGfxTextureViewCreateInfo({ texture: this._gfxTexture, format: this._getGFXFormat(), baseLevel: this._baseLevel, levelCount: e - this._baseLevel + 1 }); return i ? t.createTexture(i) : null }, i._tryDestroyTexture = function () { this._gfxTexture && (this._gfxTexture.destroy(), this._gfxTexture = null) }, i._tryDestroyTextureView = function () { this._gfxTextureView && (this._gfxTextureView.destroy(), this._gfxTextureView = null) }, n(e, [{ key: "mipmapLevel", get: function () { return this._mipmapLevel } }]), e }(Fg)) || uv; S.SimpleTexture = yv; var bv = t("Texture2D", (pv = Gu("cc.Texture2D"), _v = Ih([Pg]), pv((mv = function (t) { function e(e) { var i; return (i = t.call(this, e) || this)._mipmaps = vv && vv(), i._generatedMipmaps = [], i } s(e, t); var i = e.prototype; return i._setMipmapParams = function (t) { var e = this; if (this._generatedMipmaps = t, this._setMipmapLevel(this._generatedMipmaps.length), this._generatedMipmaps.length > 0) { var i = this._generatedMipmaps[0]; this.reset({ width: i.width, height: i.height, format: i.format, mipmapLevel: this._generatedMipmaps.length, baseLevel: this._baseLevel, maxLevel: this._maxLevel }), this._generatedMipmaps.forEach((function (t, i) { e._assignImage(t, i) })) } else this.reset({ width: 0, height: 0, mipmapLevel: this._generatedMipmaps.length, baseLevel: this._baseLevel, maxLevel: this._maxLevel }) }, i.initialize = function () { this.mipmaps = this._mipmaps }, i.onLoaded = function () { this.initialize() }, i.reset = function (t) { this._width = t.width, this._height = t.height, this._setGFXFormat(t.format); var e = void 0 === t.mipmapLevel ? 1 : t.mipmapLevel; this._setMipmapLevel(e); var i = void 0 === t.baseLevel ? 0 : t.baseLevel, n = void 0 === t.maxLevel ? 1e3 : t.maxLevel; this._setMipRange(i, n), this._tryReset() }, i.create = function (t, e, i, n, r, s) { void 0 === i && (i = 35), void 0 === n && (n = 1), void 0 === r && (r = 0), void 0 === s && (s = 1e3), this.reset({ width: t, height: e, format: i, mipmapLevel: n, baseLevel: r, maxLevel: s }) }, i.toString = function () { return 0 !== this._mipmaps.length ? this._mipmaps[0].url : "" }, i.updateMipmaps = function (t, e) { if (void 0 === t && (t = 0), void 0 === e && (e = void 0), !(t >= this._generatedMipmaps.length)) for (var i = Math.min(void 0 === e ? this._generatedMipmaps.length : e, this._generatedMipmaps.length - t), n = 0; n < i; ++n) { var r = t + n; this._assignImage(this._generatedMipmaps[r], r) } }, i.getHtmlElementObj = function () { return this._mipmaps[0] && this._mipmaps[0].data instanceof HTMLElement ? this._mipmaps[0].data : null }, i.destroy = function () { return this._mipmaps = [], this._generatedMipmaps = [], t.prototype.destroy.call(this) }, i.description = function () { return "<cc.Texture2D | Name = " + (this._mipmaps[0] ? this._mipmaps[0].url : "") + " | Dimension = " + this.width + " x " + this.height + ">" }, i.releaseTexture = function () { this.destroy() }, i._serialize = function () { return null }, i._deserialize = function (e, i) { var n = e; t.prototype._deserialize.call(this, n.base, i), this._mipmaps = new Array(n.mipmaps.length); for (var r = 0; r < n.mipmaps.length; ++r)if (this._mipmaps[r] = new Pg, n.mipmaps[r]) { var s = n.mipmaps[r]; i.result.push(this._mipmaps, "" + r, s, fe(Pg)) } }, i._getGfxTextureCreateInfo = function (t) { var e = new ip(1); return e.width = this._width, e.height = this._height, Object.assign(e, t), e }, i._getGfxTextureViewCreateInfo = function (t) { var e = new np; return e.type = 1, Object.assign(e, t), e }, i.initDefault = function (e) { t.prototype.initDefault.call(this, e); var i = new Pg; i.initDefault(), this.image = i }, i.validate = function () { return this.mipmaps && 0 !== this.mipmaps.length }, n(e, [{ key: "mipmaps", get: function () { return this._mipmaps }, set: function (t) { this._mipmaps = t; var e = []; if (1 === t.length) { var i = t[0]; e.push.apply(e, i.extractMipmaps()) } else if (t.length > 1) for (var n = 0; n < t.length; ++n) { var r = t[n]; e.push(r.extractMipmap0()) } this._setMipmapParams(e) } }, { key: "image", get: function () { return 0 === this._mipmaps.length ? null : this._mipmaps[0] }, set: function (t) { this.mipmaps = t ? [t] : [] } }]), e }(yv), vv = Bu(mv.prototype, "_mipmaps", [_v], (function () { return [] })), gv = mv)) || gv)); function wv(t, e, i, n) { t.drawTextureAt(e, i, n) } S.Texture2D = bv; var xv = t("Atlas", function () { function t(t, e) { this._innerTextureInfos = {}, this._innerSpriteFrames = [], this._count = 0; var i = new Sv; i.initWithSize(t, e), this._texture = i, this._width = t, this._height = e, this._x = 2, this._y = 2, this._nextY = 2 } var e = t.prototype; return e.insertSpriteFrame = function (t) { var e = t.rect, i = t.texture, n = this._innerTextureInfos[i.getId()], r = e.x, s = e.y; if (n) r += n.x, s += n.y; else { var a = i.width, o = i.height; if (this._x + a + 2 > this._width && (this._x = 2, this._y = this._nextY), this._y + o + 2 > this._nextY && (this._nextY = this._y + o + 2), this._nextY > this._height) return null; var u = this._texture, h = i.image; S.internal.dynamicAtlasManager.textureBleeding && ((a <= 8 || o <= 8) && (wv(u, h, this._x - 1, this._y - 1), wv(u, h, this._x - 1, this._y + 1), wv(u, h, this._x + 1, this._y - 1), wv(u, h, this._x + 1, this._y + 1)), wv(u, h, this._x - 1, this._y), wv(u, h, this._x + 1, this._y), wv(u, h, this._x, this._y - 1), wv(u, h, this._x, this._y + 1)), wv(u, h, this._x, this._y), this._innerTextureInfos[i.getId()] = { x: this._x, y: this._y, texture: i }, this._count++, r += this._x, s += this._y, this._x += a + 2 } var c = { x: r, y: s, texture: this._texture }; return this._innerSpriteFrames.push(t), c }, e.removeSpriteFrame = function (t) { ve(this._innerSpriteFrames, t) }, e.deleteInnerTexture = function (t) { t && this._innerTextureInfos[t.getId()] && (delete this._innerTextureInfos[t.getId()], this._count--) }, e.isEmpty = function () { return this._count <= 0 }, e.reset = function () { this._x = 2, this._y = 2, this._nextY = 2; for (var t = this._innerSpriteFrames, e = 0, i = t.length; e < i; e++) { var n = t[e]; n.isValid && n._resetDynamicAtlasFrame() } this._innerSpriteFrames.length = 0, this._innerTextureInfos = {} }, e.destroy = function () { this.reset(), this._texture.destroy() }, t }()), Sv = function (t) { function e() { return t.apply(this, arguments) || this } s(e, t); var i = e.prototype; return i.initWithSize = function (t, e, i) { void 0 === i && (i = 35), this.reset({ width: t, height: e, format: i }) }, i.drawTextureAt = function (t, e, i) { var n = this.getGFXTexture(); if (t && n) { var r = this._getGFXDevice(); if (r) { var s = new Wd; s.texOffset.x = e, s.texOffset.y = i, s.texExtent.width = t.width, s.texExtent.height = t.height, r.copyTexImagesToTexture([t.data], n, [s]) } else it(16363) } }, e }(bv), Tv = { NONE: 0, IGNORE_RAYCAST: 1 << 20, GIZMOS: 1 << 21, EDITOR: 1 << 22, UI_3D: 1 << 23, SCENE_GIZMO: 1 << 24, UI_2D: 1 << 25, PROFILER: 1 << 28, DEFAULT: 1 << 30, ALL: 4294967295 }, Iv = t("Layers", function () { function t() { } return t.init = function () { var e = Oe.querySettings("engine", "customLayers"); if (e) for (var i = 0; i < e.length; i++) { var n = e[i]; t.addLayer(n.name, n.bit) } }, t.makeMaskInclude = function (t) { return t.reduce((function (t, e) { return t | e }), 0) }, t.makeMaskExclude = function (e) { return ~t.makeMaskInclude(e) }, t.addLayer = function (e, i) { if (void 0 !== i) if (i > 19 || i < 0) it(16365); else { var n = 1 << i; t.Enum[e], ut(2104, e), t.Enum[e] = n, Ot(t.Enum, String(n), e), t.BitMask[e] = n, Ot(t.BitMask, String(n), e), Se.update(t.BitMask), Ee.update(t.Enum) } else it(16364) }, t.deleteLayer = function (e) { if (e > 19 || e < 0) it(16366); else { var i = 1 << e; delete t.Enum[t.Enum[i]], delete t.Enum[i], delete t.BitMask[t.BitMask[i]], delete t.BitMask[i], Se.update(t.BitMask), Ee.update(t.Enum) } }, t.nameToLayer = function (e) { return void 0 === e ? (it(16367), -1) : C(t.Enum[e]) }, t.layerToName = function (e) { return e > 31 || e < 0 ? (it(16368), "") : t.Enum[1 << e] }, t }()); Iv.Enum = Ee(Tv), Iv.BitMask = Se(r({}, Tv)), T.Layers = Iv; var Ev = function () { var t = e.prototype; function e(t) { this._uiComp = null, this._opacity = 1, this._localOpacity = 1, this.colorDirty = !0, this._uiTransformComp = null, this._uiSkewComp = null, this._node = t } return t.setOpacity = function (t) { this._opacity = t }, t.applyOpacity = function (t) { this._opacity = this._localOpacity * t }, e.markOpacityTree = function () { }, n(e, [{ key: "uiTransformComp", get: function () { return this._uiTransformComp || (this._uiTransformComp = this._node.getComponent("cc.UITransform")), this._uiTransformComp }, set: function (t) { this._uiTransformComp = t } }, { key: "uiComp", get: function () { return this._uiComp }, set: function (t) { this._uiComp && t ? it(12002) : this._uiComp = t } }, { key: "opacity", get: function () { return this._opacity } }, { key: "localOpacity", get: function () { return this._localOpacity }, set: function (t) { this._localOpacity = t, this.colorDirty = !0 } }]), e }(); T.GAME_VIEW; var Av = t("NodeSpace", { LOCAL: 0, WORLD: 1 }), Cv = t("TransformBit", { NONE: 0, POSITION: 1, ROTATION: 2, SCALE: 4, SKEW: 8, RS: 6, RSS: 14, TRS: 7, TRS_MASK: -8 }); T.internal.TransformBit = Cv; var Dv = t("MobilityMode", Ee({ Static: 0, Stationary: 1, Movable: 2 })), Rv = t("NodeEventType", { TOUCH_START: "touch-start", TOUCH_MOVE: "touch-move", TOUCH_END: "touch-end", TOUCH_CANCEL: "touch-cancel", MOUSE_DOWN: "mouse-down", MOUSE_MOVE: "mouse-move", MOUSE_UP: "mouse-up", MOUSE_WHEEL: "mouse-wheel", MOUSE_ENTER: "mouse-enter", MOUSE_LEAVE: "mouse-leave", KEY_DOWN: "keydown", KEY_UP: "keyup", DEVICEMOTION: "devicemotion", TRANSFORM_CHANGED: "transform-changed", MOBILITY_CHANGED: "mobility-changed", SCENE_CHANGED_FOR_PERSISTS: "scene-changed-for-persists", SIZE_CHANGED: "size-changed", ANCHOR_CHANGED: "anchor-changed", COLOR_CHANGED: "color-changed", CHILD_ADDED: "child-added", CHILD_REMOVED: "child-removed", PARENT_CHANGED: "parent-changed", NODE_DESTROYED: "node-destroyed", LAYER_CHANGED: "layer-changed", SIBLING_ORDER_CHANGED: "sibling-order-changed", CHILDREN_ORDER_CHANGED: "sibling-order-changed", ACTIVE_IN_HIERARCHY_CHANGED: "active-in-hierarchy-changed", COMPONENT_ADDED: "component-added", COMPONENT_REMOVED: "component-removed", LIGHT_PROBE_CHANGED: "light-probe-changed", LIGHT_PROBE_BAKING_CHANGED: "light-probe-baking-changed", ACTIVE_CHANGED: "active-changed" }), Pv = t("Event", function () { function t(t, e) { this.target = null, this.currentTarget = null, this.eventPhase = 0, this.propagationStopped = !1, this.propagationImmediateStopped = !1, this.type = t, this.bubbles = !!e } var e = t.prototype; return e.unuse = function () { this.type = t.NO_TYPE, this.target = null, this.currentTarget = null, this.eventPhase = t.NONE, this.propagationStopped = !1, this.propagationImmediateStopped = !1 }, e.reuse = function (t, e) { this.type = t, this.bubbles = e || !1 }, e.isStopped = function () { return this.propagationStopped || this.propagationImmediateStopped }, e.getCurrentTarget = function () { return this.currentTarget }, e.getType = function () { return this.type }, t }()); Pv.NO_TYPE = "no_type", Pv.TOUCH = "touch", Pv.MOUSE = "mouse", Pv.KEYBOARD = "keyboard", Pv.ACCELERATION = "acceleration", Pv.NONE = 0, Pv.CAPTURING_PHASE = 1, Pv.AT_TARGET = 2, Pv.BUBBLING_PHASE = 3, S.Event = Pv; var Bv = t("EventAcceleration", function (t) { function e(e, i) { var n; return (n = t.call(this, "devicemotion", i) || this).acc = e, n } return s(e, t), e }(Pv)); Pv.EventAcceleration = Bv; var Mv = t("EventKeyboard", function (t) { function e(e, i, n) { var r; return "boolean" == typeof i && (i = i ? "keydown" : "keyup"), (r = t.call(this, i, n) || this).rawEvent = void 0, r._isPressed = "keyup" !== i, "number" == typeof e ? r.keyCode = e : (r.keyCode = e.keyCode, r.rawEvent = e), r.windowId = 0, r } return s(e, t), n(e, [{ key: "isPressed", get: function () { return this._isPressed } }]), e }(Pv)); Pv.EventKeyboard = Mv; var Ov = t("EventMouse", function (t) { function e(i, n, r, s) { var a; return (a = t.call(this, i, n) || this).movementX = 0, a.movementY = 0, a.windowId = 0, a.preventSwallow = !1, a._button = e.BUTTON_MISSING, a._x = 0, a._y = 0, a._prevX = 0, a._prevY = 0, a._scrollX = 0, a._scrollY = 0, a._eventType = i, r && (a._prevX = r.x, a._prevY = r.y), a.windowId = null != s ? s : a.windowId, a } s(e, t); var i = e.prototype; return i.setScrollData = function (t, e) { this._scrollX = t, this._scrollY = e }, i.getScrollX = function () { return this._scrollX }, i.getScrollY = function () { return this._scrollY }, i.setLocation = function (t, e) { this._x = t, this._y = e }, i.getLocation = function (t) { return t || (t = new as), as.set(t, this._x, this._y), t }, i.getLocationInView = function (t) { return t || (t = new as), as.set(t, this._x, S.view._designResolutionSize.height - this._y), t }, i.getUILocation = function (t) { return t || (t = new as), as.set(t, this._x, this._y), S.view._convertToUISpace(t), t }, i.getPreviousLocation = function (t) { return t || (t = new as), as.set(t, this._prevX, this._prevY), t }, i.getUIPreviousLocation = function (t) { return t || (t = new as), as.set(t, this._prevX, this._prevY), S.view._convertToUISpace(t), t }, i.getDelta = function (t) { return t || (t = new as), as.set(t, this._x - this._prevX, this._y - this._prevY), t }, i.getDeltaX = function () { return this._x - this._prevX }, i.getDeltaY = function () { return this._y - this._prevY }, i.getUIDelta = function (t) { t || (t = new as); var e = S.view; return as.set(t, (this._x - this._prevX) / e.getScaleX(), (this._y - this._prevY) / e.getScaleY()), t }, i.getUIDeltaX = function () { return (this._x - this._prevX) / S.view.getScaleX() }, i.getUIDeltaY = function () { return (this._y - this._prevY) / S.view.getScaleY() }, i.setButton = function (t) { this._button = t }, i.getButton = function () { return this._button }, i.getLocationX = function () { return this._x }, i.getLocationY = function () { return this._y }, i.getUILocationX = function () { var t = S.view, e = t.getViewportRect(); return (this._x - e.x) / t.getScaleX() }, i.getUILocationY = function () { var t = S.view, e = t.getViewportRect(); return (this._y - e.y) / t.getScaleY() }, n(e, [{ key: "eventType", get: function () { return this._eventType } }]), e }(Pv)); Ov.BUTTON_MISSING = -1, Ov.BUTTON_LEFT = 0, Ov.BUTTON_RIGHT = 2, Ov.BUTTON_MIDDLE = 1, Ov.BUTTON_4 = 3, Ov.BUTTON_5 = 4, Ov.BUTTON_6 = 5, Ov.BUTTON_7 = 6, Ov.BUTTON_8 = 7, Pv.EventMouse = Ov; var Lv = new as, Fv = t("EventTouch", function (t) { function e(e, i, n, r) { var s; return void 0 === r && (r = []), (s = t.call(this, n, i) || this).touch = null, s.simulate = !1, s.windowId = 0, s.preventSwallow = !1, s._eventCode = n, s._touches = e || [], s._allTouches = r, s } s(e, t); var i = e.prototype; return i.getEventCode = function () { return this._eventCode }, i.getTouches = function () { return this._touches }, i.getAllTouches = function () { return this._allTouches }, i.setLocation = function (t, e) { this.touch && this.touch.setTouchInfo(this.touch.getID(), t, e) }, i.getLocation = function (t) { return this.touch ? this.touch.getLocation(t) : new as }, i.getUILocation = function (t) { return this.touch ? this.touch.getUILocation(t) : new as }, i.getLocationInView = function (t) { return this.touch ? this.touch.getLocationInView(t) : new as }, i.getPreviousLocation = function (t) { return this.touch ? this.touch.getPreviousLocation(t) : new as }, i.getStartLocation = function (t) { return this.touch ? this.touch.getStartLocation(t) : new as }, i.getUIStartLocation = function (t) { return this.touch ? this.touch.getUIStartLocation(t) : new as }, i.getID = function () { return this.touch ? this.touch.getID() : null }, i.getDelta = function (t) { return this.touch ? this.touch.getDelta(t) : new as }, i.getUIDelta = function (t) { return this.touch ? this.touch.getUIDelta(t) : new as }, i.getDeltaX = function () { return this.touch ? this.touch.getDelta(Lv).x : 0 }, i.getDeltaY = function () { return this.touch ? this.touch.getDelta(Lv).y : 0 }, i.getLocationX = function () { return this.touch ? this.touch.getLocationX() : 0 }, i.getLocationY = function () { return this.touch ? this.touch.getLocationY() : 0 }, e }(Pv)); Fv.MAX_TOUCHES = 5, Pv.EventTouch = Fv; var kv = t("EventGamepad", function (t) { function e(e, i) { var n; return (n = t.call(this, e, !1) || this).gamepad = i, n } return s(e, t), e }(Pv)), Nv = t("EventHandle", function (t) { function e(e, i) { var n; return (n = t.call(this, e, !1) || this).handleInputDevice = i, n } return s(e, t), e }(Pv)), zv = t("EventHMD", function (t) { function e(e, i) { var n; return (n = t.call(this, e, !1) || this).hmdInputDevice = i, n } return s(e, t), e }(Pv)), Uv = (t("EventHandheld", function (t) { function e(e, i) { var n; return (n = t.call(this, e, !1) || this).handheldInputDevice = i, n } return s(e, t), e }(Pv)), t("Acceleration", (function (t, e, i, n) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 0), this.x = t, this.y = e, this.z = i, this.timestamp = n }))), Vv = t("SystemEventType", { TOUCH_START: "touch-start", TOUCH_MOVE: "touch-move", TOUCH_END: "touch-end", TOUCH_CANCEL: "touch-cancel", MOUSE_DOWN: "mouse-down", MOUSE_MOVE: "mouse-move", MOUSE_UP: "mouse-up", MOUSE_WHEEL: "mouse-wheel", MOUSE_ENTER: "mouse-enter", MOUSE_LEAVE: "mouse-leave", KEY_DOWN: "keydown", KEY_UP: "keyup", DEVICEMOTION: "devicemotion", TRANSFORM_CHANGED: "transform-changed", SCENE_CHANGED_FOR_PERSISTS: "scene-changed-for-persists", SIZE_CHANGED: "size-changed", ANCHOR_CHANGED: "anchor-changed", COLOR_CHANGED: "color-changed", CHILD_ADDED: "child-added", CHILD_REMOVED: "child-removed", PARENT_CHANGED: "parent-changed", NODE_DESTROYED: "node-destroyed", LAYER_CHANGED: "layer-changed", SIBLING_ORDER_CHANGED: "sibling-order-changed" }); S.SystemEventType = Vv, t("KeyCode", { NONE: 0, MOBILE_BACK: 6, BACKSPACE: 8, TAB: 9, ENTER: 13, SHIFT_LEFT: 16, CTRL_LEFT: 17, ALT_LEFT: 18, PAUSE: 19, CAPS_LOCK: 20, ESCAPE: 27, SPACE: 32, PAGE_UP: 33, PAGE_DOWN: 34, END: 35, HOME: 36, ARROW_LEFT: 37, ARROW_UP: 38, ARROW_RIGHT: 39, ARROW_DOWN: 40, INSERT: 45, DELETE: 46, DIGIT_0: 48, DIGIT_1: 49, DIGIT_2: 50, DIGIT_3: 51, DIGIT_4: 52, DIGIT_5: 53, DIGIT_6: 54, DIGIT_7: 55, DIGIT_8: 56, DIGIT_9: 57, KEY_A: 65, KEY_B: 66, KEY_C: 67, KEY_D: 68, KEY_E: 69, KEY_F: 70, KEY_G: 71, KEY_H: 72, KEY_I: 73, KEY_J: 74, KEY_K: 75, KEY_L: 76, KEY_M: 77, KEY_N: 78, KEY_O: 79, KEY_P: 80, KEY_Q: 81, KEY_R: 82, KEY_S: 83, KEY_T: 84, KEY_U: 85, KEY_V: 86, KEY_W: 87, KEY_X: 88, KEY_Y: 89, KEY_Z: 90, NUM_0: 96, NUM_1: 97, NUM_2: 98, NUM_3: 99, NUM_4: 100, NUM_5: 101, NUM_6: 102, NUM_7: 103, NUM_8: 104, NUM_9: 105, NUM_MULTIPLY: 106, NUM_PLUS: 107, NUM_SUBTRACT: 109, NUM_DECIMAL: 110, NUM_DIVIDE: 111, F1: 112, F2: 113, F3: 114, F4: 115, F5: 116, F6: 117, F7: 118, F8: 119, F9: 120, F10: 121, F11: 122, F12: 123, NUM_LOCK: 144, SCROLL_LOCK: 145, SEMICOLON: 186, EQUAL: 187, COMMA: 188, DASH: 189, PERIOD: 190, SLASH: 191, BACK_QUOTE: 192, BRACKET_LEFT: 219, BACKSLASH: 220, BRACKET_RIGHT: 221, QUOTE: 222, SHIFT_RIGHT: 2e3, CTRL_RIGHT: 2001, ALT_RIGHT: 2002, NUM_ENTER: 2003 }); var Gv = new as, Hv = t("Touch", function () { function t(t, e, i) { void 0 === i && (i = 0), this._point = new as, this._prevPoint = new as, this._lastModified = 0, this._id = 0, this._startPoint = new as, this._startPointCaptured = !1, this.setTouchInfo(i, t, e) } var e = t.prototype; return e.getLocation = function (t) { return t || (t = new as), t.set(this._point.x, this._point.y), t }, e.getLocationX = function () { return this._point.x }, e.getLocationY = function () { return this._point.y }, e.getUILocation = function (t) { return t || (t = new as), t.set(this._point.x, this._point.y), S.view._convertToUISpace(t), t }, e.getUILocationX = function () { var t = S.view, e = t.getViewportRect(); return (this._point.x - e.x) / t.getScaleX() }, e.getUILocationY = function () { var t = S.view, e = t.getViewportRect(); return (this._point.y - e.y) / t.getScaleY() }, e.getPreviousLocation = function (t) { return t || (t = new as), t.set(this._prevPoint.x, this._prevPoint.y), t }, e.getUIPreviousLocation = function (t) { return t || (t = new as), t.set(this._prevPoint.x, this._prevPoint.y), S.view._convertToUISpace(t), t }, e.getStartLocation = function (t) { return t || (t = new as), t.set(this._startPoint.x, this._startPoint.y), t }, e.getUIStartLocation = function (t) { return t || (t = new as), t.set(this._startPoint.x, this._startPoint.y), S.view._convertToUISpace(t), t }, e.getDelta = function (t) { return t || (t = new as), t.set(this._point), t.subtract(this._prevPoint), t }, e.getUIDelta = function (t) { t || (t = new as), Gv.set(this._point), Gv.subtract(this._prevPoint); var e = S.view; return t.set(e.getScaleX(), e.getScaleY()), as.divide(t, Gv, t), t }, e.getLocationInView = function (t) { return t || (t = new as), t.set(this._point.x, S.view._designResolutionSize.height - this._point.y), t }, e.getPreviousLocationInView = function (t) { return t || (t = new as), t.set(this._prevPoint.x, S.view._designResolutionSize.height - this._prevPoint.y), t }, e.getStartLocationInView = function (t) { return t || (t = new as), t.set(this._startPoint.x, S.view._designResolutionSize.height - this._startPoint.y), t }, e.getID = function () { return this._id }, e.setTouchInfo = function (t, e, i) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 0), this._prevPoint = this._point, this._point = new as(e || 0, i || 0), this._id = t, this._startPointCaptured || (this._startPoint = new as(this._point), this._startPointCaptured = !0) }, e.setPoint = function (t, e) { "object" == typeof t ? (this._point.x = t.x, this._point.y = t.y) : (this._point.x = t || 0, this._point.y = e || 0), this._lastModified = S.game.frameStartTime }, e.setPrevPoint = function (t, e) { this._prevPoint = "object" == typeof t ? new as(t.x, t.y) : new as(t || 0, e || 0), this._lastModified = S.game.frameStartTime }, e.clone = function () { var e = this.getID(); this.getStartLocation(Gv); var i = new t(Gv.x, Gv.y, e); return this.getLocation(Gv), i.setPoint(Gv.x, Gv.y), this.getPreviousLocation(Gv), i.setPrevPoint(Gv), i }, n(t, [{ key: "lastModified", get: function () { return this._lastModified } }]), t }()); S.Touch = Hv; var Wv, jv, Xv, qv, Yv, Kv, Qv, Zv, Jv, $v, ty, ey, iy, ny, ry, sy, ay, oy = new to((function () { return new Array(16) }), 3), uy = null, hy = new as, cy = ["touch-start", "touch-move", "touch-end", "touch-cancel"], ly = ["mouse-down", "mouse-enter", "mouse-move", "mouse-leave", "mouse-up", "mouse-wheel"], fy = new yo, dy = function () { function t(t) { this.claimedTouchIdList = [], this.maskList = null, this.cachedCameraPriority = 0, this.previousMouseIn = !1, this.bubblingTarget = null, this.capturingTarget = null, this.shouldHandleEventMouse = !1, this.shouldHandleEventTouch = !1, this._dispatchingTouch = null, this._isEnabled = !1, this._isMouseLeaveWindow = !1, this._node = t } var e = t.prototype; return e.setEnabled = function (t, e) { if (void 0 === e && (e = !1), this._isEnabled !== t) { this._isEnabled = t; var i = this.node.children; if (t && this._attachMask(), fy.emit(2), e && i.length > 0) for (var n = 0; n < i.length; ++n)i[n].eventProcessor.setEnabled(t, !0) } }, e.reattach = function () { this.node.walk((function (e) { var i = e.eventProcessor, n = i._searchComponentsInParent(t._maskComp); i.maskList = n })) }, e.destroy = function () { if (uy === this._node && (uy = null), this.capturingTarget && this.capturingTarget.clear(), this.bubblingTarget && this.bubblingTarget.clear(), fy.emit(1, this), this._dispatchingTouch) { var t = new Fv([this._dispatchingTouch], !0, "touch-cancel"); t.touch = this._dispatchingTouch, this.dispatchEvent(t), this._dispatchingTouch = null } }, e.on = function (t, e, i, n) { var r, s; return this._tryEmittingAddEvent(t), ((n = !!n) ? null !== (r = this.capturingTarget) && void 0 !== r ? r : this.capturingTarget = this._newCallbacksInvoker() : null !== (s = this.bubblingTarget) && void 0 !== s ? s : this.bubblingTarget = this._newCallbacksInvoker()).on(t, e, i), e }, e.once = function (t, e, i, n) { var r, s; return this._tryEmittingAddEvent(t), ((n = !!n) ? null !== (r = this.capturingTarget) && void 0 !== r ? r : this.capturingTarget = this._newCallbacksInvoker() : null !== (s = this.bubblingTarget) && void 0 !== s ? s : this.bubblingTarget = this._newCallbacksInvoker()).on(t, e, i, !0), e }, e.off = function (t, e, i, n) { var r; null == (r = (n = !!n) ? this.capturingTarget : this.bubblingTarget) || r.off(t, e, i) }, e.targetOff = function (t) { var e, i; null == (e = this.capturingTarget) || e.removeAll(t), null == (i = this.bubblingTarget) || i.removeAll(t), this.shouldHandleEventTouch && !this._hasTouchListeners() && (this.shouldHandleEventTouch = !1), this.shouldHandleEventMouse && !this._hasMouseListeners() && (this.shouldHandleEventMouse = !1), this._hasPointerListeners() || fy.emit(1, this) }, e.emit = function (t, e, i, n, r, s) { var a; null == (a = this.bubblingTarget) || a.emit(t, e, i, n, r, s) }, e.dispatchEvent = function (t) { var e, i = this.node, n = 0; t.target = i; var r = oy.alloc(); for (r.length = 0, this.getCapturingTargets(t.type, r), t.eventPhase = 1, n = r.length - 1; n >= 0; --n)if ((e = r[n]).eventProcessor.capturingTarget && (t.currentTarget = e, e.eventProcessor.capturingTarget.emit(t.type, t, r), t.propagationStopped)) return void oy.free(r); if (t.eventPhase = 2, t.currentTarget = i, this.capturingTarget && this.capturingTarget.emit(t.type, t), !t.propagationImmediateStopped && this.bubblingTarget && this.bubblingTarget.emit(t.type, t), !t.propagationStopped && t.bubbles) for (r.length = 0, this.getBubblingTargets(t.type, r), t.eventPhase = 3, n = 0; n < r.length; ++n)if ((e = r[n]).eventProcessor.bubblingTarget && (t.currentTarget = e, e.eventProcessor.bubblingTarget.emit(t.type, t), t.propagationStopped)) return void oy.free(r); oy.free(r) }, e.hasEventListener = function (t, e, i) { var n = !1; return this.bubblingTarget && (n = this.bubblingTarget.hasEventListener(t, e, i)), !n && this.capturingTarget && (n = this.capturingTarget.hasEventListener(t, e, i)), n }, e.getCapturingTargets = function (t, e) { for (var i = this._node.parent; i;) { var n; null != (n = i.eventProcessor.capturingTarget) && n.hasEventListener(t) && e.push(i), i = i.parent } }, e.getBubblingTargets = function (t, e) { for (var i = this._node.parent; i;) { var n; null != (n = i.eventProcessor.bubblingTarget) && n.hasEventListener(t) && e.push(i), i = i.parent } }, e.onUpdatingSiblingIndex = function () { fy.emit(2) }, e._searchComponentsInParent = function (t) { var e = this.node; if (t) { for (var i = 0, n = [], r = e; r && S.Node.isNode(r); r = r.parent, ++i) { var s = r.getComponent(t); if (s) { var a = { index: i, comp: s }; n ? n.push(a) : n = [a] } } return n.length > 0 ? n : null } return null }, e._attachMask = function () { this.maskList = this._searchComponentsInParent(t._maskComp) }, e._isTouchEvent = function (t) { return -1 !== cy.indexOf(t) }, e._isMouseEvent = function (t) { return -1 !== ly.indexOf(t) }, e._hasTouchListeners = function () { for (var t = 0; t < cy.length; ++t) { var e = cy[t]; if (this.hasEventListener(e)) return !0 } return !1 }, e._hasMouseListeners = function () { for (var t = 0; t < ly.length; ++t) { var e = ly[t]; if (this.hasEventListener(e)) return !0 } return !1 }, e._hasPointerListeners = function () { return !!this._hasTouchListeners() || this._hasMouseListeners() }, e._tryEmittingAddEvent = function (t) { var e = this._isTouchEvent(t), i = this._isMouseEvent(t); e ? this.shouldHandleEventTouch = !0 : i && (this.shouldHandleEventMouse = !0), !e && !i || this._hasPointerListeners() || fy.emit(0, this) }, e._newCallbacksInvoker = function () { var t = this, e = new yo; return e._registerOffCallback((function () { t.shouldHandleEventTouch && !t._hasTouchListeners() && (t.shouldHandleEventTouch = !1), t.shouldHandleEventMouse && !t._hasMouseListeners() && (t.shouldHandleEventMouse = !1), t._hasPointerListeners() || fy.emit(1, t) })), e }, e._handleEventMouse = function (t) { switch (t.type) { case "mouse-down": return this._handleMouseDown(t); case "mouse-move": return this._handleMouseMove(t); case "mouse-up": return this._handleMouseUp(t); case "mouse-wheel": return this._handleMouseWheel(t); case "mouse-leave-window": return this._handleMouseLeave(t); case "mouse-enter-window": return this._handleMouseEnter(t); default: return !1 } }, e._handleMouseDown = function (t) { var e = this._node, i = e._getUITransformComp(); return !(!e || !i || (t.getLocation(hy), !i.hitTest(hy, t.windowId) || (t.type = "mouse-down", t.bubbles = !0, e.dispatchEvent(t), t.propagationStopped = !0, 0))) }, e._handleMouseMove = function (t) { var e = this._node, i = e._getUITransformComp(); return !(!e || !i || this._isMouseLeaveWindow || (t.getLocation(hy), i.hitTest(hy, t.windowId) ? (this.previousMouseIn || (uy && uy !== e && (t.type = "mouse-leave", uy.dispatchEvent(t), uy.eventProcessor.previousMouseIn = !1), uy = e, t.type = "mouse-enter", e.dispatchEvent(t), this.previousMouseIn = !0), t.type = "mouse-move", t.bubbles = !0, e.dispatchEvent(t), t.propagationStopped = !0, 0) : (this.previousMouseIn && (t.type = "mouse-leave", e.dispatchEvent(t), this.previousMouseIn = !1, uy = null), 1))) }, e._handleMouseUp = function (t) { var e = this._node, i = e._getUITransformComp(); return !(!e || !i || (t.getLocation(hy), !i.hitTest(hy, t.windowId) || (t.type = "mouse-up", t.bubbles = !0, e.dispatchEvent(t), t.propagationStopped = !0, 0))) }, e._handleMouseWheel = function (t) { var e = this._node, i = e._getUITransformComp(); return !(!e || !i || (t.getLocation(hy), !i.hitTest(hy, t.windowId) || (t.type = "mouse-wheel", t.bubbles = !0, e.dispatchEvent(t), t.propagationStopped = !0, 0))) }, e._handleMouseLeave = function (t) { return this._isMouseLeaveWindow = !0, this.previousMouseIn && (t.type = "mouse-leave", this._node.dispatchEvent(t), this.previousMouseIn = !1, uy = null), !1 }, e._handleMouseEnter = function () { return this._isMouseLeaveWindow = !1, !1 }, e._handleEventTouch = function (t) { try { switch (t.type) { case "touch-start": return this._handleTouchStart(t); case "touch-move": return this._handleTouchMove(t); case "touch-end": return this._handleTouchEnd(t); case "touch-cancel": return this._handleTouchCancel(t); default: return !1 } } catch (t) { throw this.claimedTouchIdList.length = 0, t } }, e._handleTouchStart = function (t) { var e = this.node, i = e._getUITransformComp(); return !(!e || !i || (t.getLocation(hy), !i.hitTest(hy, t.windowId) || (t.type = "touch-start", t.bubbles = !0, this._dispatchingTouch = t.touch, e.dispatchEvent(t), 0))) }, e._handleTouchMove = function (t) { var e = this.node; return !(!e || !e._getUITransformComp() || (t.type = "touch-move", t.bubbles = !0, this._dispatchingTouch = t.touch, e.dispatchEvent(t), 0)) }, e._handleTouchEnd = function (t) { var e = this.node, i = e._getUITransformComp(); e && i && (t.getLocation(hy), i.hitTest(hy, t.windowId) ? t.type = "touch-end" : t.type = "touch-cancel", t.bubbles = !0, e.dispatchEvent(t), this._dispatchingTouch = null) }, e._handleTouchCancel = function (t) { var e = this.node; e && e._getUITransformComp() && (t.type = "touch-cancel", t.bubbles = !0, e.dispatchEvent(t), this._dispatchingTouch = null) }, n(t, [{ key: "isEnabled", get: function () { return this._isEnabled } }, { key: "node", get: function () { return this._node } }]), t }(); dy._maskComp = null, dy.callbacksInvoker = fy, S.NodeEventProcessor = dy; var py = 128, _y = "transform-changed", gy = "active-changed", my = new It("Node"); function vy(t) { return t ? "string" == typeof t ? ce(t) : t : (rt(3804), null) } var yy, by, wy, xy, Sy, Ty, Iy, Ey = Qn(), Ay = Qn(), Cy = Mr(), Dy = Mr(), Ry = Mr(), Py = new cr, By = jr(), My = jr(), Oy = [], Ly = Symbol("ReserveContentsForAllSyncablePrefab"), Fy = 0, ky = (Wv = Gu("cc.Node"), jv = Ih(Kn), Xv = Ih(Dv), Wv((ay = function (t) { s(i, t); var e = i.prototype; function i(e) { var i; return void 0 === e && (e = "New Node"), (i = t.call(this, e) || this)._parent = Kv && Kv(), i._children = Qv && Qv(), i._active = Zv && Zv(), i._components = Jv && Jv(), i._prefab = $v && $v(), i._scene = null, i._activeInHierarchy = !1, i._id = my.getNewId(), i._eventProcessor = new dy(l(i)), i._eventMask = 0, i._siblingIndex = 0, i._originalSceneId = "", i._uiProps = new Ev(l(i)), i._static = !1, i._lpos = ty && ty(), i._lrot = ey && ey(), i._lscale = iy && iy(), i._mobility = ny && ny(), i._layer = ry && ry(), i._euler = sy && sy(), i._transformFlags = 15, i._eulerDirty = !1, i._flagChangeVersion = 0, i._hasChangedFlags = 0, i._pos = new Kn, i._rot = new Er, i._scale = new Kn(1, 1, 1), i._mat = new Gr, i } return e._setActiveInHierarchy = function (t) { this._activeInHierarchy = t }, i._setScene = function (t) { t._updateScene() }, i._incSkewCompCount = function () { }, i._decSkewCompCount = function () { }, i._findComponent = function (t, e) { var i = e, n = t._components; if (i._sealed) for (var r = 0; r < n.length; ++r) { var s = n[r]; if (s.constructor === e) return s } else for (var a = 0; a < n.length; ++a) { var o = n[a]; if (o instanceof e) return o } return null }, i._findComponents = function (t, e, i) { var n = e, r = t._components; if (n._sealed) for (var s = 0; s < r.length; ++s) { var a = r[s]; a.constructor === e && i.push(a) } else for (var o = 0; o < r.length; ++o) { var u = r[o]; u instanceof e && i.push(u) } }, i._findChildComponent = function (t, e) { for (var n = 0; n < t.length; ++n) { var r = t[n], s = i._findComponent(r, e); if (s) return s; if (r._children.length > 0 && (s = i._findChildComponent(r._children, e))) return s } return null }, i._findChildComponents = function (t, e, n) { for (var r = 0; r < t.length; ++r) { var s = t[r]; i._findComponents(s, e, n), s._children.length > 0 && i._findChildComponents(s._children, e, n) } }, e.getWritableComponents = function () { return this._components }, e._updateScene = function () { null == this._parent ? rt(1640, this.name, this.uuid) : this._scene = this._parent._scene }, e.attr = function (t) { Kt(this, t) }, e.getParent = function () { return this._parent }, e.modifyParent = function (t) { this._parent = t }, e.setParent = function (t, e) { if (void 0 === e && (e = !1), e && this.updateWorldTransform(), this._parent !== t) { var i = this._parent, n = t; if (this._parent = n, this._siblingIndex = 0, this._onSetParent(i, e), this.emit && this.emit("parent-changed", i), i && !(i._objFlags & py)) { var r = i._children.indexOf(this); i._children.splice(r, 1), i._updateSiblingIndex(), i.emit && i.emit("child-removed", this) } n && (n._children.push(this), this._siblingIndex = n._children.length - 1, n.emit && n.emit("child-added", this)), this._onHierarchyChanged(i) } }, e.getChildByUuid = function (t) { if (!t) return H("Invalid uuid"), null; for (var e = this._children, i = 0, n = e.length; i < n; i++)if (e[i]._id === t) return e[i]; return null }, e.getChildByName = function (t) { if (!t) return H("Invalid name"), null; for (var e = this._children, i = 0, n = e.length; i < n; i++)if (e[i]._name === t) return e[i]; return null }, e.getChildByPath = function (t) { for (var e, i = t.split("/"), n = this, r = function () { var t = i[s]; if (0 === t.length) return 0; var e = n.children.find((function (e) { return e.name === t })); if (!e) return { v: null }; n = e }, s = 0; s < i.length; ++s)if (0 !== (e = r()) && e) return e.v; return n }, e.addChild = function (t) { t.setParent(this) }, e.insertChild = function (t, e) { t.setParent(this), t.setSiblingIndex(e) }, e.getSiblingIndex = function () { return this._siblingIndex }, e.setSiblingIndex = function (t) { if (this._parent) if (256 & this._parent._objFlags) rt(3821); else { var e = this._parent._children; t = t >= 0 ? t : e.length + t; var i = e.indexOf(this); t !== i && (e.splice(i, 1), t < e.length ? e.splice(t, 0, this) : e.push(this), this._parent._updateSiblingIndex(), this._onSiblingIndexChanged && this._onSiblingIndexChanged(t), this._eventProcessor.onUpdatingSiblingIndex()) } }, e.walk = function (t, e) { var n = 1, r = null, s = null, a = 0, o = i._stacks[i._stackId]; o || (o = [], i._stacks.push(o)), i._stackId++, o.length = 0, o[0] = this; for (var u = null, h = !1; n;)if (s = o[--n]) if (!h && t ? t(s) : h && e && e(s), o[n] = null, h) { if (u === this._parent) break; if (h = !1, r) if (r[++a]) o[n] = r[a], n++; else if (u && (o[n] = u, n++, h = !0, u._parent ? (a = (r = u._parent._children).indexOf(u), u = u._parent) : (u = null, r = null), a < 0)) break } else s._children.length > 0 ? (u = s, r = s._children, a = 0, o[n] = r[a], n++) : (o[n] = s, n++, h = !0); o.length = 0, i._stackId-- }, e.removeFromParent = function () { this._parent && this._parent.removeChild(this) }, e.removeChild = function (t) { this._children.indexOf(t) > -1 && (t.parent = null) }, e.removeAllChildren = function () { for (var t = this._children, e = t.length - 1; e >= 0; e--) { var i = t[e]; i && (i.parent = null) } this._children.length = 0 }, e.isChildOf = function (t) { var e = this; do { if (e === t) return !0; e = e._parent } while (e); return !1 }, e.getComponent = function (t) { var e = vy(t); return e ? i._findComponent(this, e) : null }, e.getComponents = function (t) { var e = vy(t), n = []; return e && i._findComponents(this, e, n), n }, e.getComponentInChildren = function (t) { var e = vy(t); return e ? i._findChildComponent(this._children, e) : null }, e.getComponentsInChildren = function (t) { var e = vy(t), n = []; return e && (i._findComponents(this, e, n), i._findChildComponents(this._children, e, n)), n }, e.addComponent = function (t) { var e; if ("string" == typeof t) { if (!(e = ce(t))) throw S._RF.peek() && rt(3808, t), TypeError(ut(3807, t)) } else { if (!t) throw TypeError(ut(3804)); e = t } if ("function" != typeof e) throw TypeError(ut(3809)); if (!Jt(e, S.Component)) throw TypeError(ut(3810)); var i = e._requireComponent; if (i) if (Array.isArray(i)) for (var n = 0; n < i.length; n++) { var r = i[n]; this.getComponent(r) || this.addComponent(r) } else { var s = i; this.getComponent(s) || this.addComponent(s) } var a = new e; return a.node = this, this._components.push(a), this.emit("component-added", a), this._activeInHierarchy && S.director._nodeActivator.activateComp(a), a }, e.removeComponent = function (t) { if (t) { var e = null; (e = t instanceof am ? t : this.getComponent(t)) && e.destroy() } else rt(3813) }, e.on = function (t, e, i, n) { switch (void 0 === n && (n = !1), t) { case _y: this._eventMask |= 1; break; case gy: this._eventMask |= 2 }this._eventProcessor.on(t, e, i, n) }, e.off = function (t, e, i, n) { if (void 0 === n && (n = !1), this._eventProcessor.off(t, e, i, n), !this._eventProcessor.hasEventListener(t)) switch (t) { case _y: this._eventMask &= -2; break; case gy: this._eventMask &= -3 } }, e.once = function (t, e, i, n) { this._eventProcessor.once(t, e, i, n) }, e.emit = function (t, e, i, n, r, s) { this._eventProcessor.emit(t, e, i, n, r, s) }, e.dispatchEvent = function (t) { this._eventProcessor.dispatchEvent(t) }, e.hasEventListener = function (t, e, i) { return this._eventProcessor.hasEventListener(t, e, i) }, e.targetOff = function (t) { this._eventProcessor.targetOff(t), 1 & this._eventMask && !this._eventProcessor.hasEventListener(_y) && (this._eventMask &= -2), 2 & this._eventMask && !this._eventProcessor.hasEventListener(gy) && (this._eventMask &= -3) }, e.destroy = function () { return !!t.prototype.destroy.call(this) && (this.active = !1, !0) }, e.destroyAllChildren = function () { for (var t = this._children, e = 0; e < t.length; ++e)t[e].destroy() }, e._removeComponent = function (t) { if (t) { if (!(this._objFlags & py)) { var e = this._components.indexOf(t); -1 !== e ? (this._components.splice(e, 1), this.emit("component-removed", t)) : t.node !== this && rt(3815) } } else rt(3814) }, e._updateSiblingIndex = function () { for (var t = 0; t < this._children.length; ++t)this._children[t]._siblingIndex = t; this.emit("sibling-order-changed") }, e._instantiate = function (t, e) { return void 0 === e && (e = !1), t || (t = S.instantiate._clone(this, this)), t._prefab, t._parent = null, t._onBatchCreated(e), t }, e._onHierarchyChangedBase = function () { var t = this._parent; !this._persistNode || t instanceof S.Scene || S.game.removePersistRootNode(this); var e = this._active && !(!t || !t._activeInHierarchy); this._activeInHierarchy !== e && S.director._nodeActivator.activateNode(this, e) }, e._onPreDestroyBase = function () { this._objFlags |= py; var t = this._parent, e = !!t && !!(t._objFlags & py); if (this._persistNode && S.game.removePersistRootNode(this), !e && t) { this.emit("parent-changed", this); var i = t._children.indexOf(this); t._children.splice(i, 1), this._siblingIndex = 0, t._updateSiblingIndex(), t.emit && t.emit("child-removed", this) } this.emit("node-destroyed", this), this._eventProcessor.destroy(); for (var n = this._children, r = 0; r < n.length; ++r)n[r]._destroyImmediate(); for (var s = this._components, a = 0; a < s.length; ++a)s[a]._destroyImmediate(); return e }, i.isNode = function (t) { return t instanceof i && (t.constructor === i || !(t instanceof S.Scene)) }, e._onPreDestroy = function () { return this._onPreDestroyBase() }, e[Vh] = function (t) { t.writeThis() }, e._onSetParent = function (t, e) { void 0 === e && (e = !1); var n = this, r = n._parent; if (r && (null != t && t._scene === r._scene || null == r._scene || n.walk(i._setScene)), e) { if (r) if (r.updateWorldTransform(), ji(Gr.determinant(r._mat), 0, Hi)) it(14300), n._transformFlags |= 7, n.updateWorldTransform(); else { var s = r._mat; Gr.multiply(By, Gr.invert(By, s), n._mat), Gr.toSRT(By, n._lrot, n._lpos, n._lscale) } else Kn.copy(n._lpos, n._pos), Er.copy(n._lrot, n._rot), Kn.copy(n._lscale, n._scale); n._eulerDirty = !0 } n.invalidateChildren(7) }, e._onHierarchyChanged = function (t) { this.eventProcessor.reattach(), this._onHierarchyChangedBase(t) }, e._onBatchCreated = function (t) { 2 & this._eventMask && (this._activeInHierarchy || this.emit(gy, this, !1)), this.hasChangedFlags = 7, this._children.forEach((function (e, i) { e._siblingIndex = i, e._onBatchCreated(t) })) }, e._onBeforeSerialize = function () { this.eulerAngles }, e._onPostActivated = function (t) { var e = this; 2 & e._eventMask && e.emit(gy, e, t); var i = this._eventProcessor; if (i.isEnabled === t && dy.callbacksInvoker.emit(2), i.setEnabled(t), t) { e.invalidateChildren(7); var n = e._uiProps && e._uiProps.uiComp; n && (n.setNodeDirty(), n.setTextureDirty(), n._markForUpdateRenderData()) } }, e.translate = function (t, e) { var i = e || 0; if (0 === i) Kn.transformQuat(Ey, t, this._lrot), this._lpos.x += Ey.x, this._lpos.y += Ey.y, this._lpos.z += Ey.z; else if (1 === i) if (this._parent) { Er.invert(Cy, this._parent.worldRotation), Kn.transformQuat(Ey, t, Cy); var n = this.worldScale; this._lpos.x += Ey.x / n.x, this._lpos.y += Ey.y / n.y, this._lpos.z += Ey.z / n.z } else this._lpos.x += t.x, this._lpos.y += t.y, this._lpos.z += t.z; this.invalidateChildren(1), 1 & this._eventMask && this.emit(_y, 1) }, e.rotate = function (t, e) { var i = e || 0; if (Er.normalize(Cy, t), 0 === i) Er.multiply(this._lrot, this._lrot, Cy); else if (1 === i) { var n = this.worldRotation; Er.multiply(Dy, Cy, n), Er.invert(Cy, n), Er.multiply(Dy, Cy, Dy), Er.multiply(this._lrot, this._lrot, Dy) } this._eulerDirty = !0, this.invalidateChildren(2), 1 & this._eventMask && this.emit(_y, 2) }, e.lookAt = function (t, e) { this.getWorldPosition(Ey), Kn.subtract(Ey, Ey, t), Kn.normalize(Ey, Ey), Er.fromViewUp(Cy, Ey, e), this.setWorldRotation(Cy) }, e.invalidateChildren = function (t) { var e, i, n = 0, r = 0, s = 0, a = 0, o = 1 | t; for (Oy[0] = this; n >= 0;) { if (a = (e = Oy[n--]).hasChangedFlags, e.isValid && (e._transformFlags & a & t) !== t) for (e._transformFlags |= t, e.hasChangedFlags = a | t, s = (i = e._children).length, r = 0; r < s; r++)Oy[++n] = i[r]; t = o } }, e.updateWorldTransform = function () { if (this._transformFlags) { for (var t, e, i, n = this, r = 0; n && n._transformFlags;)Oy[r++] = n, n = n._parent; for (var s = 0, a = 0, o = 0; r;) { if (e = (t = Oy[--r])._mat, i = t._pos, a = 1 & (s |= t._transformFlags), o = 14 & s, n) { if (a && !o && (Kn.transformMat4(i, t._lpos, n._mat), e.m12 = i.x, e.m13 = i.y, e.m14 = i.z), o) { var u = e; Gr.fromSRT(By, t._lrot, t._lpos, t._lscale), Gr.multiply(e, n._mat, By); var h = 2 & s ? t._rot : null; Gr.toSRT(u, h, i, t._scale) } } else a && (Kn.copy(i, t._lpos), e.m12 = i.x, e.m13 = i.y, e.m14 = i.z), o && (2 & s && Er.copy(t._rot, t._lrot), 4 & s && Kn.copy(t._scale, t._lscale), Gr.fromSRT(e, t._rot, t._pos, t._scale)); t._transformFlags = 0, n = t } } }, e.setPosition = function (t, e, i) { var n = this._lpos; void 0 === e ? Kn.copy(n, t) : (void 0 === i && (i = n.z), Kn.set(n, t, e, i)), this.invalidateChildren(1), 1 & this._eventMask && this.emit(_y, 1) }, e.getPosition = function (t) { return t ? Kn.set(t, this._lpos.x, this._lpos.y, this._lpos.z) : Kn.copy(new Kn, this._lpos) }, e.setRotation = function (t, e, i, n) { void 0 === e ? Er.copy(this._lrot, t) : Er.set(this._lrot, t, e, i, n), this._eulerDirty = !0, this.invalidateChildren(2), 1 & this._eventMask && this.emit(_y, 2) }, e.setRotationFromEuler = function (t, e, i) { if (void 0 === e) Kn.copy(this._euler, t), Er.fromEuler(this._lrot, t.x, t.y, t.z); else { var n = void 0 === i ? this._euler.z : i; Kn.set(this._euler, t, e, n), Er.fromEuler(this._lrot, t, e, n) } this._eulerDirty = !1, this.invalidateChildren(2), 1 & this._eventMask && this.emit(_y, 2) }, e.getRotation = function (t) { return t ? Er.set(t, this._lrot.x, this._lrot.y, this._lrot.z, this._lrot.w) : Er.copy(new Er, this._lrot) }, e.setScale = function (t, e, i) { var n = this._lscale; void 0 === e ? Kn.copy(n, t) : (void 0 === i && (i = n.z), Kn.set(n, t, e, i)), this.invalidateChildren(4), 1 & this._eventMask && this.emit(_y, 4) }, e.getScale = function (t) { return t ? Kn.set(t, this._lscale.x, this._lscale.y, this._lscale.z) : Kn.copy(new Kn, this._lscale) }, e.inverseTransformPoint = function (t, e) { Kn.copy(t, e); for (var i = this, n = 0; i._parent;)Oy[n++] = i, i = i._parent; for (; n >= 0;)Kn.transformInverseRTS(t, t, i._lrot, i._lpos, i._lscale), i = Oy[--n]; return t }, e.setWorldPosition = function (t, e, i) { var n = this._pos; void 0 === e ? Kn.copy(n, t) : Kn.set(n, t, e, i); var r = this._parent, s = this._lpos; r ? (r.updateWorldTransform(), Kn.transformMat4(s, n, Gr.invert(By, r._mat))) : Kn.copy(s, n), this.invalidateChildren(1), 1 & this._eventMask && this.emit(_y, 1) }, e.getWorldPosition = function (t) { return this.updateWorldTransform(), t ? Kn.copy(t, this._pos) : Kn.copy(new Kn, this._pos) }, e.setWorldRotation = function (t, e, i, n) { var r = this._rot; void 0 === e ? Er.copy(r, t) : Er.set(r, t, e, i, n), this._parent ? (this._parent.updateWorldTransform(), Er.multiply(this._lrot, Er.conjugate(this._lrot, this._parent._rot), r)) : Er.copy(this._lrot, r), this._eulerDirty = !0, this.invalidateChildren(2), 1 & this._eventMask && this.emit(_y, 2) }, e.setWorldRotationFromEuler = function (t, e, i) { Er.fromEuler(Cy, t, e, i), this.setWorldRotation(Cy) }, e.getWorldRotation = function (t) { return this.updateWorldTransform(), t ? Er.copy(t, this._rot) : Er.copy(new Er, this._rot) }, e.setWorldScale = function (t, e, i) { var n = this, r = n._parent; r && n.updateWorldTransform(); var s = n._scale; void 0 === e ? Kn.copy(s, t) : Kn.set(s, t, e, i); var a = 0; if (r) { var o = n._mat; n._uiProps._uiSkewComp && (Gr.fromSRT(By, n._lrot, n._lpos, n._lscale), Gr.multiply(o, r._mat, By)); var u = Kn.set(Ay, o.m00, o.m01, o.m02).length(), h = Kn.set(Ay, o.m04, o.m05, o.m06).length(), c = Kn.set(Ay, o.m08, o.m09, o.m10).length(); 0 === u ? (Ey.x = s.x, o.m00 = 1, a = 2) : Ey.x = s.x / u, 0 === h ? (Ey.y = s.y, o.m05 = 1, a = 2) : Ey.y = s.y / h, 0 === c ? (Ey.z = s.z, o.m10 = 1, a = 2) : Ey.z = s.z / c, Gr.scale(By, o, Ey), Gr.multiply(My, Gr.invert(My, r._mat), By), cr.fromQuat(Py, Er.conjugate(Ry, n._lrot)), cr.multiplyMat4(Py, Py, My); var l = n._lscale; l.x = Kn.set(Ey, Py.m00, Py.m01, Py.m02).length(), l.y = Kn.set(Ey, Py.m03, Py.m04, Py.m05).length(), l.z = Kn.set(Ey, Py.m06, Py.m07, Py.m08).length(), 0 !== l.x && 0 !== l.y && 0 !== l.z || (a = 2) } else Kn.copy(n._lscale, s); n.invalidateChildren(4 | a), 1 & n._eventMask && n.emit(_y, 4 | a) }, e.getWorldScale = function (t) { return this.updateWorldTransform(), t ? Kn.copy(t, this._scale) : Kn.copy(new Kn, this._scale) }, e.getWorldMatrix = function (t) { this.updateWorldTransform(); var e = t || new Gr; return Gr.copy(e, this._mat) }, e.getWorldRS = function (t) { this.updateWorldTransform(); var e = t || new Gr; return Gr.copy(e, this._mat), e.m12 = 0, e.m13 = 0, e.m14 = 0, e }, e.getWorldRT = function (t) { this.updateWorldTransform(); var e = t || new Gr; return Gr.fromRT(e, this._rot, this._pos) }, e.setRTS = function (t, e, i) { var n = 0; t && (n |= 2, void 0 !== t.w ? (Er.copy(this._lrot, t), this._eulerDirty = !0) : (Kn.copy(this._euler, t), Er.fromEuler(this._lrot, t.x, t.y, t.z), this._eulerDirty = !1)), e && (Kn.copy(this._lpos, e), n |= 1), i && (Kn.copy(this._lscale, i), n |= 4), n && (this.invalidateChildren(n), 1 & this._eventMask && this.emit(_y, n)) }, e.isTransformDirty = function () { return 0 !== this._transformFlags }, e.pauseSystemEvents = function (t) { this._eventProcessor.setEnabled(!1, t) }, e.resumeSystemEvents = function (t) { this._eventProcessor.setEnabled(!0, t) }, i.resetHasChangedFlags = function () { Fy += 1 }, i.clearNodeArray = function () { i.ClearFrame < i.ClearRound ? i.ClearFrame++ : (i.ClearFrame = 0, Oy.length = 0) }, e.getPathInHierarchy = function () { for (var t = this.name, e = this.parent; e && !(e instanceof S.Scene);)t = e.name + "/" + t, e = e.parent; return t }, e._getUITransformComp = function () { return this._uiProps.uiTransformComp }, n(i, [{ key: "components", get: function () { return this._components } }, { key: "_persistNode", get: function () { return (64 & this._objFlags) > 0 }, set: function (t) { t ? this._objFlags |= 64 : this._objFlags &= -65 } }, { key: "name", get: function () { return this._name }, set: function (t) { this._name = t } }, { key: "uuid", get: function () { return this._id } }, { key: "children", get: function () { return this._children } }, { key: "active", get: function () { return this._active }, set: function (t) { if (t = !!t, this._active !== t) { this._active = t; var e = this._parent; e && e._activeInHierarchy && S.director._nodeActivator.activateNode(this, t) } } }, { key: "activeInHierarchy", get: function () { return this._activeInHierarchy } }, { key: "parent", get: function () { return this._parent }, set: function (t) { this.setParent(t) } }, { key: "scene", get: function () { return this._scene } }, { key: "eventProcessor", get: function () { return this._eventProcessor } }, { key: "prefab", get: function () { return this._prefab } }, { key: "id", set: function (t) { this._id = t } }, { key: "siblingIndex", get: function () { return this._siblingIndex }, set: function (t) { this._siblingIndex = t } }, { key: "position", get: function () { return this._lpos }, set: function (t) { this.setPosition(t) } }, { key: "x", get: function () { return this._lpos.x }, set: function (t) { this.setPosition(t, this._lpos.y, this._lpos.z) } }, { key: "y", get: function () { return this._lpos.y }, set: function (t) { this.setPosition(this._lpos.x, t, this._lpos.z) } }, { key: "z", get: function () { return this._lpos.z }, set: function (t) { this.setPosition(this._lpos.x, this._lpos.y, t) } }, { key: "worldPosition", get: function () { return this.updateWorldTransform(), this._pos }, set: function (t) { this.setWorldPosition(t) } }, { key: "worldPositionX", get: function () { return this.updateWorldTransform(), this._pos.x }, set: function (t) { this.setWorldPosition(t, this._pos.y, this._pos.z) } }, { key: "worldPositionY", get: function () { return this.updateWorldTransform(), this._pos.y }, set: function (t) { this.setWorldPosition(this._pos.x, t, this._pos.z) } }, { key: "worldPositionZ", get: function () { return this.updateWorldTransform(), this._pos.z }, set: function (t) { this.setWorldPosition(this._pos.x, this._pos.y, t) } }, { key: "rotation", get: function () { return this._lrot }, set: function (t) { this.setRotation(t) } }, { key: "eulerAngles", get: function () { return this._eulerDirty && (Er.toEuler(this._euler, this._lrot), this._eulerDirty = !1), this._euler }, set: function (t) { this.setRotationFromEuler(t.x, t.y, t.z) } }, { key: "angle", get: function () { return this.eulerAngles.z }, set: function (t) { Kn.set(this._euler, 0, 0, t), Er.fromAngleZ(this._lrot, t), this._eulerDirty = !1, this.invalidateChildren(2), 1 & this._eventMask && this.emit(_y, 2) } }, { key: "worldRotation", get: function () { return this.updateWorldTransform(), this._rot }, set: function (t) { this.setWorldRotation(t) } }, { key: "scale", get: function () { return this._lscale }, set: function (t) { this.setScale(t) } }, { key: "worldScale", get: function () { return this.updateWorldTransform(), this._scale }, set: function (t) { this.setWorldScale(t) } }, { key: "matrix", set: function (t) { Gr.toSRT(t, this._lrot, this._lpos, this._lscale), this.invalidateChildren(7), this._eulerDirty = !0, 1 & this._eventMask && this.emit(_y, 7) } }, { key: "worldMatrix", get: function () { return this.updateWorldTransform(), this._mat } }, { key: "forward", get: function () { return Kn.transformQuat(new Kn, Kn.FORWARD, this.worldRotation) }, set: function (t) { var e = t.length(); Kn.multiplyScalar(Ey, t, -1 / e), Er.fromViewUp(Cy, Ey), this.setWorldRotation(Cy) } }, { key: "up", get: function () { return Kn.transformQuat(new Kn, Kn.UP, this.worldRotation) } }, { key: "right", get: function () { return Kn.transformQuat(new Kn, Kn.RIGHT, this.worldRotation) } }, { key: "mobility", get: function () { return this._mobility }, set: function (t) { this._mobility !== t && (this._mobility = t, this.emit("mobility-changed")) } }, { key: "layer", get: function () { return this._layer }, set: function (t) { var e = this; if (e._layer !== t) { e._layer = t; var i = e._uiProps && e._uiProps.uiComp; i && (i.setNodeDirty(), i._markForUpdateRenderData()), e.emit("layer-changed", e._layer) } } }, { key: "flagChangedVersion", get: function () { return this._flagChangeVersion } }, { key: "hasChangedFlags", get: function () { return this._flagChangeVersion === Fy ? this._hasChangedFlags : 0 }, set: function (t) { this._flagChangeVersion = Fy, this._hasChangedFlags = t } }]), i }(oo), ay.idGenerator = my, ay._stacks = [[]], ay._stackId = 0, ay.EventType = Rv, ay.NodeSpace = Av, ay.TransformDirtyBit = Cv, ay.TransformBit = Cv, ay.reserveContentsForAllSyncablePrefabTag = Ly, ay.ClearFrame = 0, ay.ClearRound = 1e3, m((Yv = ay).prototype, "_persistNode", [Xu], Object.getOwnPropertyDescriptor(Yv.prototype, "_persistNode"), Yv.prototype), Kv = Bu(Yv.prototype, "_parent", [eh], (function () { return null })), Qv = Bu(Yv.prototype, "_children", [eh], (function () { return [] })), Zv = Bu(Yv.prototype, "_active", [eh], (function () { return !0 })), Jv = Bu(Yv.prototype, "_components", [eh], (function () { return [] })), $v = Bu(Yv.prototype, "_prefab", [eh], (function () { return null })), ty = Bu(Yv.prototype, "_lpos", [eh], (function () { return new Kn })), ey = Bu(Yv.prototype, "_lrot", [eh], (function () { return new Er })), iy = Bu(Yv.prototype, "_lscale", [eh], (function () { return new Kn(1, 1, 1) })), ny = Bu(Yv.prototype, "_mobility", [eh], (function () { return Dv.Static })), ry = Bu(Yv.prototype, "_layer", [eh], (function () { return Iv.Enum.DEFAULT })), sy = Bu(Yv.prototype, "_euler", [eh], (function () { return new Kn })), m(Yv.prototype, "eulerAngles", [jv], Object.getOwnPropertyDescriptor(Yv.prototype, "eulerAngles"), Yv.prototype), m(Yv.prototype, "mobility", [Xv], Object.getOwnPropertyDescriptor(Yv.prototype, "mobility"), Yv.prototype), qv = Yv)) || qv); t({ Node: ky, BaseNode: ky }), S.Node = ky; var Ny = t("TextureCube", Gu("cc.TextureCube")((Iy = function (t) { function e(e) { var i; return (i = t.call(this, e) || this).isRGBE = wy && wy(), i._mipmapAtlas = xy && xy(), i._mipmapMode = Sy && Sy(), i._mipmaps = Ty && Ty(), i._generatedMipmaps = [], i } s(e, t); var i = e.prototype; return i._setMipmapParams = function (t) { var e = this; if (this._generatedMipmaps = t, this._setMipmapLevel(this._generatedMipmaps.length), this._generatedMipmaps.length > 0) { var i = this._generatedMipmaps[0].front; this.reset({ width: i.width, height: i.height, format: i.format, mipmapLevel: this._generatedMipmaps.length, baseLevel: this._baseLevel, maxLevel: this._maxLevel }), this._generatedMipmaps.forEach((function (t, i) { zy(t, (function (t, n) { e._assignImage(t, i, n) })) })) } else this.reset({ width: 0, height: 0, mipmapLevel: this._generatedMipmaps.length, baseLevel: this._baseLevel, maxLevel: this._maxLevel }) }, i.isUsingOfflineMipmaps = function () { return 2 === this._mipmapMode }, e.fromTexture2DArray = function (t, i) { for (var n = [], r = t.length / 6, s = 0; s < r; s++) { var a = 6 * s; n.push({ front: t[a + 4].image, back: t[a + 5].image, left: t[a + 1].image, right: t[a + 0].image, top: t[a + 2].image, bottom: t[a + 3].image }) } return (i = i || new e).mipmaps = n, i }, i.onLoaded = function () { 2 === this._mipmapMode ? this.mipmapAtlas = this._mipmapAtlas : this.mipmaps = this._mipmaps }, i.reset = function (t) { this._width = t.width, this._height = t.height, this._setGFXFormat(t.format); var e = void 0 === t.mipmapLevel ? 1 : t.mipmapLevel; this._setMipmapLevel(e); var i = void 0 === t.baseLevel ? 0 : t.baseLevel, n = void 0 === t.maxLevel ? 1e3 : t.maxLevel; this._setMipRange(i, n), this._tryReset() }, i.updateMipmaps = function (t, e) { var i = this; if (void 0 === t && (t = 0), void 0 === e && (e = void 0), !(t >= this._generatedMipmaps.length)) for (var n = Math.min(void 0 === e ? this._generatedMipmaps.length : e, this._generatedMipmaps.length - t), r = function () { var e = t + s; zy(i._generatedMipmaps[e], (function (t, n) { i._assignImage(t, e, n) })) }, s = 0; s < n; ++s)r() }, i.destroy = function () { return this._mipmaps = [], this._generatedMipmaps = [], this._mipmapAtlas = null, t.prototype.destroy.call(this) }, i.releaseTexture = function () { this.destroy() }, i._serialize = function () { return null }, i._deserialize = function (e, i) { var n = e; if (t.prototype._deserialize.call(this, n.base, i), this.isRGBE = n.rgbe, this._mipmapMode = n.mipmapMode, 2 === this._mipmapMode) { var r = n.mipmapAtlas, s = n.mipmapLayout; this._mipmapAtlas = { atlas: {}, layout: s }, this._mipmapAtlas.atlas = { front: new Pg, back: new Pg, left: new Pg, right: new Pg, top: new Pg, bottom: new Pg }; var a = fe(Pg); i.result.push(this._mipmapAtlas.atlas, "front", r.front, a), i.result.push(this._mipmapAtlas.atlas, "back", r.back, a), i.result.push(this._mipmapAtlas.atlas, "left", r.left, a), i.result.push(this._mipmapAtlas.atlas, "right", r.right, a), i.result.push(this._mipmapAtlas.atlas, "top", r.top, a), i.result.push(this._mipmapAtlas.atlas, "bottom", r.bottom, a) } else { this._mipmaps = new Array(n.mipmaps.length); for (var o = 0; o < n.mipmaps.length; ++o) { this._mipmaps[o] = { front: new Pg, back: new Pg, left: new Pg, right: new Pg, top: new Pg, bottom: new Pg }; var u = n.mipmaps[o], h = fe(Pg); i.result.push(this._mipmaps[o], "front", u.front, h), i.result.push(this._mipmaps[o], "back", u.back, h), i.result.push(this._mipmaps[o], "left", u.left, h), i.result.push(this._mipmaps[o], "right", u.right, h), i.result.push(this._mipmaps[o], "top", u.top, h), i.result.push(this._mipmaps[o], "bottom", u.bottom, h) } } }, i._getGfxTextureCreateInfo = function (t) { var e = new ip(3); return e.width = this._width, e.height = this._height, e.layerCount = 6, Object.assign(e, t), e }, i._getGfxTextureViewCreateInfo = function (t) { var e = new np; return e.type = 3, e.baseLayer = 0, e.layerCount = 6, Object.assign(e, t), e }, i._uploadAtlas = function () { var t = this, e = this._mipmapAtlas.layout, i = e[0]; this.reset({ width: i.width, height: i.height, format: this._mipmapAtlas.atlas.front.format, mipmapLevel: e.length }), zy(this._mipmapAtlas.atlas, (function (i, n) { var r = new bv; r.image = i, r.reset({ width: i.width, height: i.height, format: i.format }), r.uploadData(i.data); for (var s = 0; s < e.length; s++) { var a = e[s], o = r.getGFXTexture().size, u = new Uint8Array(o), h = new Wd; h.texOffset.x = a.left, h.texOffset.y = a.top, h.texExtent.width = a.width, h.texExtent.height = a.height, t._getGFXDevice().copyTextureToBuffers(r.getGFXTexture(), [u], [h]); var c = new Pg({ _data: u, _compressed: i.isCompressed, width: a.width, height: a.height, format: i.format }); t._assignImage(c, a.level, n) } })) }, i.initDefault = function (e) { t.prototype.initDefault.call(this, e); var i = new Pg; i.initDefault(), this.mipmaps = [{ front: i, back: i, top: i, bottom: i, left: i, right: i }] }, i.validate = function () { if (2 === this._mipmapMode) { if (null === this.mipmapAtlas || 0 === this.mipmapAtlas.layout.length) return !1; var t = this.mipmapAtlas.atlas; return !!(t.top && t.bottom && t.front && t.back && t.left && t.right) } return 0 !== this._mipmaps.length && !this._mipmaps.find((function (t) { return !(t.top && t.bottom && t.front && t.back && t.left && t.right) })) }, n(e, [{ key: "mipmaps", get: function () { return this._mipmaps }, set: function (t) { this._mipmaps = t; var e = []; if (1 === t.length) { var i = t[0], n = i.front.extractMipmaps(), r = i.back.extractMipmaps(), s = i.left.extractMipmaps(), a = i.right.extractMipmaps(), o = i.top.extractMipmaps(), u = i.bottom.extractMipmaps(); if (n.length !== r.length || n.length !== s.length || n.length !== a.length || n.length !== o.length || n.length !== u.length) return rt(16347), void this._setMipmapParams([]); for (var h = n.length, c = 0; c < h; ++c) { var l = { front: n[c], back: r[c], left: s[c], right: a[c], top: o[c], bottom: u[c] }; e.push(l) } } else t.length > 1 && t.forEach((function (t) { var i = { front: t.front.extractMipmap0(), back: t.back.extractMipmap0(), left: t.left.extractMipmap0(), right: t.right.extractMipmap0(), top: t.top.extractMipmap0(), bottom: t.bottom.extractMipmap0() }; e.push(i) })); this._setMipmapParams(e) } }, { key: "mipmapAtlas", get: function () { return this._mipmapAtlas }, set: function (t) { var e = this; if (this._mipmapAtlas = t, this._mipmapAtlas) { var i = this._mipmapAtlas.atlas.front; if (i.data) { var n = this._mipmapAtlas.atlas, r = this._mipmapAtlas.layout, s = r[0], a = Object.assign(E.document.createElement("canvas"), { width: i.width, height: i.height }).getContext("2d"); this.reset({ width: s.width, height: s.height, format: i.format, mipmapLevel: r.length }); for (var o = function () { var t = r[u]; zy(n, (function (n, r) { a.clearRect(0, 0, i.width, i.height); var s = n.data; a.drawImage(s, 0, 0); var o = a.getImageData(t.left, t.top, t.width, t.height), u = new Pg({ _data: o.data, _compressed: n.isCompressed, width: o.width, height: o.height, format: n.format }); e._assignImage(u, t.level, r) })) }, u = 0; u < r.length; u++)o() } } else this.reset({ width: 0, height: 0, mipmapLevel: 0 }) } }, { key: "image", get: function () { return 0 === this._mipmaps.length ? null : this._mipmaps[0] }, set: function (t) { this.mipmaps = t ? [t] : [] } }]), e }(yv), Iy.FaceIndex = { right: 0, left: 1, top: 2, bottom: 3, front: 4, back: 5 }, wy = Bu((by = Iy).prototype, "isRGBE", [eh], (function () { return !1 })), xy = Bu(by.prototype, "_mipmapAtlas", [eh], (function () { return null })), Sy = Bu(by.prototype, "_mipmapMode", [eh], (function () { return 0 })), Ty = Bu(by.prototype, "_mipmaps", [eh], (function () { return [] })), yy = by)) || yy); function zy(t, e) { e(t.front, 4), e(t.back, 5), e(t.left, 1), e(t.right, 0), e(t.top, 2), e(t.bottom, 3) } function Uy() { return S.director.root.pipeline.pipelineSceneData } T.TextureCube = Ny; var Vy, Gy, Hy, Wy, jy, Xy, qy, Yy, Ky, Qy, Zy, Jy, $y, tb, eb = function () { function t() { this._groundAlbedoHDR = new Pn(.2, .2, .2, 1), this._skyColorHDR = new Pn(.2, .5, .8, 1), this._skyIllumHDR = 0, this._groundAlbedoLDR = new Pn(.2, .2, .2, 1), this._skyColorLDR = new Pn(.2, .5, .8, 1), this._skyIllumLDR = 0, this._mipmapCount = 1, this._enabled = !1 } return t.prototype.initialize = function (t) { this._skyColorHDR = t.skyColorHDR, this._groundAlbedoHDR.set(t.groundAlbedoHDR), this._skyIllumHDR = t.skyIllumHDR, this._skyColorLDR = t.skyColorLDR, this._groundAlbedoLDR.set(t.groundAlbedoLDR), this._skyIllumLDR = t.skyIllumLDR }, n(t, [{ key: "enabled", get: function () { return this._enabled }, set: function (t) { this._enabled = t } }, { key: "skyColor", get: function () { return Uy().isHDR ? this._skyColorHDR : this._skyColorLDR }, set: function (t) { Uy().isHDR ? this._skyColorHDR.set(t) : this._skyColorLDR.set(t) } }, { key: "skyIllum", get: function () { return Uy().isHDR ? this._skyIllumHDR : this._skyIllumLDR }, set: function (t) { Uy().isHDR ? this._skyIllumHDR = t : this._skyIllumLDR = t } }, { key: "groundAlbedo", get: function () { return Uy().isHDR ? this._groundAlbedoHDR : this._groundAlbedoLDR }, set: function (t) { Uy().isHDR ? this._groundAlbedoHDR.set(t) : this._groundAlbedoLDR.set(t) } }]), t }(); eb.SUN_ILLUM = 65e3, eb.SKY_ILLUM = 2e4, S.Ambient = eb; var ib = { DEFAULT: 100, UI: 200 }; S.RenderPassStage = ib; var nb = { bindings: [], layouts: {} }, rb = { bindings: [], layouts: {} }, sb = new Yd([4, 0, 7, 0], [4, 0, 9, 0], [0, 0, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0], [0, 2, 1, 3]), ab = function () { }; Vy = ab, ab.TIME_OFFSET = 0, ab.SCREEN_SIZE_OFFSET = 4, ab.NATIVE_SIZE_OFFSET = 8, ab.PROBE_INFO_OFFSET = 12, ab.DEBUG_VIEW_MODE_OFFSET = 16, ab.COUNT = 20, ab.SIZE = 80, ab.NAME = "CCGlobal", ab.BINDING = 0, ab.DESCRIPTOR = new Ap(Vy.BINDING, 1, 1, 63), ab.LAYOUT = new ap(0, Vy.BINDING, Vy.NAME, [new sp("cc_time", 16, 1), new sp("cc_screenSize", 16, 1), new sp("cc_nativeSize", 16, 1), new sp("cc_probeInfo", 16, 1), new sp("cc_debug_view_mode", 16, 1)], 1), nb.layouts[ab.NAME] = ab.LAYOUT, nb.bindings[ab.BINDING] = ab.DESCRIPTOR; var ob = function () { }; Gy = ob, ob.MAT_VIEW_OFFSET = 0, ob.MAT_VIEW_INV_OFFSET = 16, ob.MAT_PROJ_OFFSET = 32, ob.MAT_PROJ_INV_OFFSET = 48, ob.MAT_VIEW_PROJ_OFFSET = 64, ob.MAT_VIEW_PROJ_INV_OFFSET = 80, ob.CAMERA_POS_OFFSET = 96, ob.SURFACE_TRANSFORM_OFFSET = 100, ob.SCREEN_SCALE_OFFSET = 104, ob.EXPOSURE_OFFSET = 108, ob.MAIN_LIT_DIR_OFFSET = 112, ob.MAIN_LIT_COLOR_OFFSET = 116, ob.AMBIENT_SKY_OFFSET = 120, ob.AMBIENT_GROUND_OFFSET = 124, ob.GLOBAL_FOG_COLOR_OFFSET = 128, ob.GLOBAL_FOG_BASE_OFFSET = 132, ob.GLOBAL_FOG_ADD_OFFSET = 136, ob.NEAR_FAR_OFFSET = 140, ob.VIEW_PORT_OFFSET = 144, ob.COUNT = 148, ob.SIZE = 592, ob.NAME = "CCCamera", ob.BINDING = 1, ob.DESCRIPTOR = new Ap(Gy.BINDING, 1, 1, 63), ob.LAYOUT = new ap(0, Gy.BINDING, Gy.NAME, [new sp("cc_matView", 25, 1), new sp("cc_matViewInv", 25, 1), new sp("cc_matProj", 25, 1), new sp("cc_matProjInv", 25, 1), new sp("cc_matViewProj", 25, 1), new sp("cc_matViewProjInv", 25, 1), new sp("cc_cameraPos", 16, 1), new sp("cc_surfaceTransform", 16, 1), new sp("cc_screenScale", 16, 1), new sp("cc_exposure", 16, 1), new sp("cc_mainLitDir", 16, 1), new sp("cc_mainLitColor", 16, 1), new sp("cc_ambientSky", 16, 1), new sp("cc_ambientGround", 16, 1), new sp("cc_fogColor", 16, 1), new sp("cc_fogBase", 16, 1), new sp("cc_fogAdd", 16, 1), new sp("cc_nearFar", 16, 1), new sp("cc_viewPort", 16, 1)], 1), nb.layouts[ob.NAME] = ob.LAYOUT, nb.bindings[ob.BINDING] = ob.DESCRIPTOR; var ub = function () { }; Hy = ub, ub.MAT_LIGHT_VIEW_OFFSET = 0, ub.MAT_LIGHT_VIEW_PROJ_OFFSET = 16, ub.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET = 32, ub.SHADOW_PROJ_DEPTH_INFO_OFFSET = 36, ub.SHADOW_PROJ_INFO_OFFSET = 40, ub.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET = 44, ub.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET = 48, ub.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET = 52, ub.SHADOW_COLOR_OFFSET = 56, ub.PLANAR_NORMAL_DISTANCE_INFO_OFFSET = 60, ub.COUNT = 64, ub.SIZE = 256, ub.NAME = "CCShadow", ub.BINDING = 2, ub.DESCRIPTOR = new Ap(Hy.BINDING, 1, 1, 63), ub.LAYOUT = new ap(0, Hy.BINDING, Hy.NAME, [new sp("cc_matLightView", 25, 1), new sp("cc_matLightViewProj", 25, 1), new sp("cc_shadowInvProjDepthInfo", 16, 1), new sp("cc_shadowProjDepthInfo", 16, 1), new sp("cc_shadowProjInfo", 16, 1), new sp("cc_shadowNFLSInfo", 16, 1), new sp("cc_shadowWHPBInfo", 16, 1), new sp("cc_shadowLPNNInfo", 16, 1), new sp("cc_shadowColor", 16, 1), new sp("cc_planarNDInfo", 16, 1)], 1), nb.layouts[ub.NAME] = ub.LAYOUT, nb.bindings[ub.BINDING] = ub.DESCRIPTOR; var hb = function () { }; Wy = hb, hb.CSM_LEVEL_COUNT = 4, hb.CSM_VIEW_DIR_0_OFFSET = 0, hb.CSM_VIEW_DIR_1_OFFSET = 16, hb.CSM_VIEW_DIR_2_OFFSET = 32, hb.CSM_ATLAS_OFFSET = 48, hb.MAT_CSM_VIEW_PROJ_OFFSET = 64, hb.CSM_PROJ_DEPTH_INFO_OFFSET = 128, hb.CSM_PROJ_INFO_OFFSET = 144, hb.CSM_SPLITS_INFO_OFFSET = 160, hb.COUNT = 164, hb.SIZE = 656, hb.NAME = "CCCSM", hb.BINDING = 3, hb.DESCRIPTOR = new Ap(Wy.BINDING, 1, 1, 16), hb.LAYOUT = new ap(0, Wy.BINDING, Wy.NAME, [new sp("cc_csmViewDir0", 16, Wy.CSM_LEVEL_COUNT), new sp("cc_csmViewDir1", 16, Wy.CSM_LEVEL_COUNT), new sp("cc_csmViewDir2", 16, Wy.CSM_LEVEL_COUNT), new sp("cc_csmAtlas", 16, Wy.CSM_LEVEL_COUNT), new sp("cc_matCSMViewProj", 25, Wy.CSM_LEVEL_COUNT), new sp("cc_csmProjDepthInfo", 16, Wy.CSM_LEVEL_COUNT), new sp("cc_csmProjInfo", 16, Wy.CSM_LEVEL_COUNT), new sp("cc_csmSplitsInfo", 16, 1)], 1), nb.layouts[hb.NAME] = hb.LAYOUT, nb.bindings[hb.BINDING] = hb.DESCRIPTOR; var cb = "cc_shadowMap", lb = new Ap(4, 16, 1, 16), fb = new op(0, 4, cb, 28, 1); nb.layouts[cb] = fb, nb.bindings[4] = lb; var db = "cc_environment", pb = new Ap(5, 16, 1, 16), _b = new op(0, 5, db, 31, 1); nb.layouts[db] = _b, nb.bindings[5] = pb; var gb = "cc_diffuseMap", mb = new Ap(7, 16, 1, 16), vb = new op(0, 7, gb, 31, 1); nb.layouts[gb] = vb, nb.bindings[7] = mb; var yb = "cc_spotShadowMap", bb = new Ap(6, 16, 1, 16), wb = new op(0, 6, yb, 28, 1); nb.layouts[yb] = wb, nb.bindings[6] = bb; var xb = function () { }; jy = xb, xb.MAT_WORLD_OFFSET = 0, xb.MAT_WORLD_IT_OFFSET = 16, xb.LIGHTINGMAP_UVPARAM = 32, xb.LOCAL_SHADOW_BIAS = 36, xb.REFLECTION_PROBE_DATA1 = 40, xb.REFLECTION_PROBE_DATA2 = 44, xb.REFLECTION_PROBE_BLEND_DATA1 = 48, xb.REFLECTION_PROBE_BLEND_DATA2 = 52, xb.COUNT = 56, xb.SIZE = 224, xb.NAME = "CCLocal", xb.BINDING = 0, xb.DESCRIPTOR = new Ap(0, 1, 1, 49, 1, 1), xb.LAYOUT = new ap(2, 0, jy.NAME, [new sp("cc_matWorld", 25, 1), new sp("cc_matWorldIT", 25, 1), new sp("cc_lightingMapUVParam", 16, 1), new sp("cc_localShadowBias", 16, 1), new sp("cc_reflectionProbeData1", 16, 1), new sp("cc_reflectionProbeData2", 16, 1), new sp("cc_reflectionProbeBlendData1", 16, 1), new sp("cc_reflectionProbeBlendData2", 16, 1)], 1), rb.layouts[xb.NAME] = xb.LAYOUT, rb.bindings[0] = xb.DESCRIPTOR; var Sb = function () { }; Xy = Sb, Sb.WORLD_BOUND_CENTER = 0, Sb.WORLD_BOUND_HALF_EXTENTS = Xy.WORLD_BOUND_CENTER + 4, Sb.COUNT = Xy.WORLD_BOUND_HALF_EXTENTS + 4, Sb.SIZE = 4 * Xy.COUNT, Sb.NAME = "CCWorldBound", Sb.BINDING = 0, Sb.DESCRIPTOR = new Ap(Xy.BINDING, 1, 1, 33, 1, 1), Sb.LAYOUT = new ap(2, Xy.BINDING, Xy.NAME, [new sp("cc_worldBoundCenter", 16, 1), new sp("cc_worldBoundHalfExtents", 16, 1)], 1), rb.layouts[Sb.NAME] = Sb.LAYOUT, rb.bindings[Sb.BINDING] = Sb.DESCRIPTOR; var Tb = "a_matWorld0", Ib = "a_sh_linear_const_r", Eb = function () { }; qy = Eb, Eb.BATCHING_COUNT = 10, Eb.MAT_WORLDS_OFFSET = 0, Eb.COUNT = 16 * qy.BATCHING_COUNT, Eb.SIZE = 4 * qy.COUNT, Eb.NAME = "CCLocalBatched", Eb.BINDING = 0, Eb.DESCRIPTOR = new Ap(qy.BINDING, 1, 1, 33, 1, 1), Eb.LAYOUT = new ap(2, qy.BINDING, qy.NAME, [new sp("cc_matWorlds", 25, qy.BATCHING_COUNT)], 1), rb.layouts[Eb.NAME] = Eb.LAYOUT, rb.bindings[Eb.BINDING] = Eb.DESCRIPTOR; var Ab = function () { }; Yy = Ab, Ab.LIGHTS_PER_PASS = 1, Ab.LIGHT_POS_OFFSET = 0, Ab.LIGHT_COLOR_OFFSET = 4, Ab.LIGHT_SIZE_RANGE_ANGLE_OFFSET = 8, Ab.LIGHT_DIR_OFFSET = 12, Ab.LIGHT_BOUNDING_SIZE_VS_OFFSET = 16, Ab.COUNT = 20, Ab.SIZE = 80, Ab.NAME = "CCForwardLight", Ab.BINDING = 1, Ab.DESCRIPTOR = new Ap(Yy.BINDING, 2, 1, 16, 1, 1), Ab.LAYOUT = new ap(2, Yy.BINDING, Yy.NAME, [new sp("cc_lightPos", 16, 1), new sp("cc_lightColor", 16, 1), new sp("cc_lightSizeRangeAngle", 16, 1), new sp("cc_lightDir", 16, 1), new sp("cc_lightBoundingSizeVS", 16, 1)], 1), rb.layouts[Ab.NAME] = Ab.LAYOUT, rb.bindings[Ab.BINDING] = Ab.DESCRIPTOR; var Cb = function () { }; Cb.LIGHTS_PER_PASS = 10; var Db = function () { }; Ky = Db, Db.JOINTS_TEXTURE_INFO_OFFSET = 0, Db.COUNT = Ky.JOINTS_TEXTURE_INFO_OFFSET + 4, Db.SIZE = 4 * Ky.COUNT, Db.NAME = "CCSkinningTexture", Db.BINDING = 3, Db.DESCRIPTOR = new Ap(Ky.BINDING, 1, 1, 1, 1, 1), Db.LAYOUT = new ap(2, Ky.BINDING, Ky.NAME, [new sp("cc_jointTextureInfo", 16, 1)], 1), rb.layouts[Db.NAME] = Db.LAYOUT, rb.bindings[Db.BINDING] = Db.DESCRIPTOR; var Rb = function () { }; Qy = Rb, Rb.JOINTS_ANIM_INFO_OFFSET = 0, Rb.COUNT = Qy.JOINTS_ANIM_INFO_OFFSET + 4, Rb.SIZE = 4 * Qy.COUNT, Rb.NAME = "CCSkinningAnimation", Rb.BINDING = 2, Rb.DESCRIPTOR = new Ap(Qy.BINDING, 1, 1, 1, 1, 1), Rb.LAYOUT = new ap(2, Qy.BINDING, Qy.NAME, [new sp("cc_jointAnimInfo", 16, 1)], 1), rb.layouts[Rb.NAME] = Rb.LAYOUT, rb.bindings[Rb.BINDING] = Rb.DESCRIPTOR; var Pb = function () { function t() { } return t.initLayout = function (e) { t._jointUniformCapacity = e, t._count = 12 * e, t._size = 4 * t._count, t.LAYOUT.members[0].count = 3 * e }, n(t, null, [{ key: "JOINT_UNIFORM_CAPACITY", get: function () { return t._jointUniformCapacity } }, { key: "COUNT", get: function () { return t._count } }, { key: "SIZE", get: function () { return t._size } }]), t }(); function Bb(t) { Pb.initLayout(t), rb.layouts[Pb.NAME] = Pb.LAYOUT, rb.bindings[Pb.BINDING] = Pb.DESCRIPTOR } Zy = Pb, Pb._jointUniformCapacity = 0, Pb._count = 0, Pb._size = 0, Pb.NAME = "CCSkinning", Pb.BINDING = 3, Pb.DESCRIPTOR = new Ap(Zy.BINDING, 1, 1, 1, 1, 1), Pb.LAYOUT = new ap(2, Zy.BINDING, Zy.NAME, [new sp("cc_joints", 16, 1)], 1); var Mb = function () { }; Jy = Mb, Mb.MAX_MORPH_TARGET_COUNT = 60, Mb.OFFSET_OF_WEIGHTS = 0, Mb.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH = 240, Mb.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT = 244, Mb.OFFSET_OF_VERTICES_COUNT = 248, Mb.COUNT_BASE_4_BYTES = 64, Mb.SIZE = 256, Mb.NAME = "CCMorph", Mb.BINDING = 4, Mb.DESCRIPTOR = new Ap(Jy.BINDING, 1, 1, 1, 1, 1), Mb.LAYOUT = new ap(2, Jy.BINDING, Jy.NAME, [new sp("cc_displacementWeights", 16, 15), new sp("cc_displacementTextureInfo", 16, 1)], 1), rb.layouts[Mb.NAME] = Mb.LAYOUT, rb.bindings[Mb.BINDING] = Mb.DESCRIPTOR; var Ob = function () { }; $y = Ob, Ob.NAME = "CCUILocal", Ob.BINDING = 5, Ob.DESCRIPTOR = new Ap($y.BINDING, 2, 1, 1, 1, 1), Ob.LAYOUT = new ap(2, $y.BINDING, $y.NAME, [new sp("cc_local_data", 16, 1)], 1), rb.layouts[Ob.NAME] = Ob.LAYOUT, rb.bindings[Ob.BINDING] = Ob.DESCRIPTOR; var Lb = function () { }; tb = Lb, Lb.SH_LINEAR_CONST_R_OFFSET = 0, Lb.SH_LINEAR_CONST_G_OFFSET = 4, Lb.SH_LINEAR_CONST_B_OFFSET = 8, Lb.SH_QUADRATIC_R_OFFSET = 12, Lb.SH_QUADRATIC_G_OFFSET = 16, Lb.SH_QUADRATIC_B_OFFSET = 20, Lb.SH_QUADRATIC_A_OFFSET = 24, Lb.COUNT = 28, Lb.SIZE = 112, Lb.NAME = "CCSH", Lb.BINDING = 6, Lb.DESCRIPTOR = new Ap(6, 1, 1, 16, 1, 1), Lb.LAYOUT = new ap(2, 6, tb.NAME, [new sp("cc_sh_linear_const_r", 16, 1), new sp("cc_sh_linear_const_g", 16, 1), new sp("cc_sh_linear_const_b", 16, 1), new sp("cc_sh_quadratic_r", 16, 1), new sp("cc_sh_quadratic_g", 16, 1), new sp("cc_sh_quadratic_b", 16, 1), new sp("cc_sh_quadratic_a", 16, 1)], 1), rb.layouts[Lb.NAME] = Lb.LAYOUT, rb.bindings[6] = Lb.DESCRIPTOR; var Fb = "cc_jointTexture", kb = new Ap(7, 16, 1, 1, 1, 4), Nb = new op(2, 7, Fb, 28, 1); rb.layouts[Fb] = Nb, rb.bindings[7] = kb; var zb = "cc_realtimeJoint", Ub = new Ap(7, 16, 1, 1, 1, 4), Vb = new op(2, 7, zb, 28, 1); rb.layouts[zb] = Vb, rb.bindings[7] = Ub; var Gb = "cc_PositionDisplacements", Hb = new Ap(8, 16, 1, 1, 1, 4), Wb = new op(2, 8, Gb, 28, 1); rb.layouts[Gb] = Wb, rb.bindings[8] = Hb; var jb = "cc_NormalDisplacements", Xb = new Ap(9, 16, 1, 1, 1, 4), qb = new op(2, 9, jb, 28, 1); rb.layouts[jb] = qb, rb.bindings[9] = Xb; var Yb = "cc_TangentDisplacements", Kb = new Ap(10, 16, 1, 1, 1, 4), Qb = new op(2, 10, Yb, 28, 1); rb.layouts[Yb] = Qb, rb.bindings[10] = Kb; var Zb = "cc_lightingMap", Jb = 11, $b = new Ap(Jb, 16, 1, 16, 1, 4), tw = new op(2, Jb, Zb, 28, 1); rb.layouts[Zb] = tw, rb.bindings[11] = $b; var ew = "cc_spriteTexture", iw = new Ap(12, 16, 1, 16, 1, 4), nw = new op(2, 12, ew, 28, 1); rb.layouts[ew] = nw, rb.bindings[12] = iw; var rw = "cc_reflectionProbeCubemap", sw = 13, aw = new Ap(sw, 16, 1, 16, 1, 9), ow = new op(2, sw, rw, 31, 1); rb.layouts[rw] = ow, rb.bindings[13] = aw; var uw = "cc_reflectionProbePlanarMap", hw = 14, cw = new Ap(hw, 16, 1, 16, 1, 4), lw = new op(2, hw, uw, 28, 1); rb.layouts[uw] = lw, rb.bindings[14] = cw; var fw = "cc_reflectionProbeDataMap", dw = new Ap(15, 16, 1, 16, 1, 4), pw = new op(2, 15, fw, 28, 1); rb.layouts[fw] = pw, rb.bindings[15] = dw, new Ap(16, 16, 1, 16, 1, 9), new op(2, 16, "cc_reflectionProbeBlendCubemap", 31, 1); var _w, gw, mw, vw, yw = Iv.makeMaskExclude([Iv.BitMask.UI_2D, Iv.BitMask.GIZMOS, Iv.BitMask.EDITOR, Iv.BitMask.SCENE_GIZMO, Iv.BitMask.PROFILER]), bw = Iv.makeMaskExclude([Iv.BitMask.UI_2D, Iv.BitMask.PROFILER]), ww = Iv.Enum.ALL; function xw(t) { if (_w) return _w; var e = new ip(1, 0, Sw(t) ? 11 : 35, 16, 16, 0, 1, 1, 1, 1); return _w = t.createTexture(e) } function Sw(t) { return !(3 & ~t.getFormatFeatures(11) || 6 === t.gfxAPI) } function Tw(t) { return !(3 & ~t.getFormatFeatures(41)) } t("pipeline", Object.freeze({ __proto__: null, CAMERA_DEFAULT_MASK: yw, CAMERA_EDITOR_MASK: bw, ENABLE_PROBE_BLEND: !1, INST_JOINT_ANIM_INFO: "a_jointAnimInfo", INST_MAT_WORLD: Tb, INST_SH: Ib, JOINT_UNIFORM_CAPACITY: 30, MODEL_ALWAYS_MASK: ww, ModelLocalBindings: { UBO_LOCAL: 0, UBO_FORWARD_LIGHTS: 1, UBO_SKINNING_ANIMATION: 2, UBO_SKINNING_TEXTURE: 3, UBO_MORPH: 4, UBO_UI_LOCAL: 5, UBO_SH: 6, SAMPLER_JOINTS: 7, SAMPLER_MORPH_POSITION: 8, SAMPLER_MORPH_NORMAL: 9, SAMPLER_MORPH_TANGENT: 10, SAMPLER_LIGHTMAP: 11, SAMPLER_SPRITE: 12, SAMPLER_REFLECTION_PROBE_CUBE: 13, SAMPLER_REFLECTION_PROBE_PLANAR: 14, SAMPLER_REFLECTION_PROBE_DATA_MAP: 15, COUNT: 16 }, PIPELINE_FLOW_FORWARD: "ForwardFlow", PIPELINE_FLOW_MAIN: "MainFlow", PIPELINE_FLOW_SHADOW: "ShadowFlow", PIPELINE_FLOW_SMAA: "SMAAFlow", PIPELINE_FLOW_TONEMAP: "ToneMapFlow", PipelineGlobalBindings: { UBO_GLOBAL: 0, UBO_CAMERA: 1, UBO_SHADOW: 2, UBO_CSM: 3, SAMPLER_SHADOWMAP: 4, SAMPLER_ENVIRONMENT: 5, SAMPLER_SPOT_SHADOW_MAP: 6, SAMPLER_DIFFUSEMAP: 7, COUNT: 8 }, RenderPassStage: ib, RenderPriority: { MIN: 0, MAX: 255, DEFAULT: 128 }, SetIndex: { GLOBAL: 0, MATERIAL: 1, LOCAL: 2, COUNT: 3 }, UBOCSM: hb, UBOCSMEnum: { CSM_LEVEL_COUNT: 4, CSM_VIEW_DIR_0_OFFSET: 0, CSM_VIEW_DIR_1_OFFSET: 16, CSM_VIEW_DIR_2_OFFSET: 32, CSM_ATLAS_OFFSET: 48, MAT_CSM_VIEW_PROJ_OFFSET: 64, CSM_PROJ_DEPTH_INFO_OFFSET: 128, CSM_PROJ_INFO_OFFSET: 144, CSM_SPLITS_INFO_OFFSET: 160, COUNT: 164, SIZE: 656 }, UBOCamera: ob, UBOCameraEnum: { MAT_VIEW_OFFSET: 0, MAT_VIEW_INV_OFFSET: 16, MAT_PROJ_OFFSET: 32, MAT_PROJ_INV_OFFSET: 48, MAT_VIEW_PROJ_OFFSET: 64, MAT_VIEW_PROJ_INV_OFFSET: 80, CAMERA_POS_OFFSET: 96, SURFACE_TRANSFORM_OFFSET: 100, SCREEN_SCALE_OFFSET: 104, EXPOSURE_OFFSET: 108, MAIN_LIT_DIR_OFFSET: 112, MAIN_LIT_COLOR_OFFSET: 116, AMBIENT_SKY_OFFSET: 120, AMBIENT_GROUND_OFFSET: 124, GLOBAL_FOG_COLOR_OFFSET: 128, GLOBAL_FOG_BASE_OFFSET: 132, GLOBAL_FOG_ADD_OFFSET: 136, NEAR_FAR_OFFSET: 140, VIEW_PORT_OFFSET: 144, COUNT: 148, SIZE: 592 }, UBODeferredLight: Cb, UBOForwardLight: Ab, UBOForwardLightEnum: { LIGHTS_PER_PASS: 1, LIGHT_POS_OFFSET: 0, LIGHT_COLOR_OFFSET: 4, LIGHT_SIZE_RANGE_ANGLE_OFFSET: 8, LIGHT_DIR_OFFSET: 12, LIGHT_BOUNDING_SIZE_VS_OFFSET: 16, COUNT: 20, SIZE: 80 }, UBOGlobal: ab, UBOGlobalEnum: { TIME_OFFSET: 0, SCREEN_SIZE_OFFSET: 4, NATIVE_SIZE_OFFSET: 8, PROBE_INFO_OFFSET: 12, DEBUG_VIEW_MODE_OFFSET: 16, COUNT: 20, SIZE: 80 }, UBOLocal: xb, UBOLocalBatched: Eb, UBOLocalEnum: { MAT_WORLD_OFFSET: 0, MAT_WORLD_IT_OFFSET: 16, LIGHTINGMAP_UVPARAM: 32, LOCAL_SHADOW_BIAS: 36, REFLECTION_PROBE_DATA1: 40, REFLECTION_PROBE_DATA2: 44, REFLECTION_PROBE_BLEND_DATA1: 48, REFLECTION_PROBE_BLEND_DATA2: 52, COUNT: 56, SIZE: 224, BINDING: 0 }, UBOMorph: Mb, UBOMorphEnum: { MAX_MORPH_TARGET_COUNT: 60, OFFSET_OF_WEIGHTS: 0, OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH: 240, OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT: 244, OFFSET_OF_VERTICES_COUNT: 248, COUNT_BASE_4_BYTES: 64, SIZE: 256 }, UBOSH: Lb, UBOSHEnum: { SH_LINEAR_CONST_R_OFFSET: 0, SH_LINEAR_CONST_G_OFFSET: 4, SH_LINEAR_CONST_B_OFFSET: 8, SH_QUADRATIC_R_OFFSET: 12, SH_QUADRATIC_G_OFFSET: 16, SH_QUADRATIC_B_OFFSET: 20, SH_QUADRATIC_A_OFFSET: 24, COUNT: 28, SIZE: 112, BINDING: 6 }, UBOShadow: ub, UBOShadowEnum: { MAT_LIGHT_VIEW_OFFSET: 0, MAT_LIGHT_VIEW_PROJ_OFFSET: 16, SHADOW_INV_PROJ_DEPTH_INFO_OFFSET: 32, SHADOW_PROJ_DEPTH_INFO_OFFSET: 36, SHADOW_PROJ_INFO_OFFSET: 40, SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET: 44, SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET: 48, SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET: 52, SHADOW_COLOR_OFFSET: 56, PLANAR_NORMAL_DISTANCE_INFO_OFFSET: 60, COUNT: 64, SIZE: 256 }, UBOSkinning: Pb, UBOSkinningAnimation: Rb, UBOSkinningTexture: Db, UBOUILocal: Ob, UBOWorldBound: Sb, UNIFORM_DIFFUSEMAP_BINDING: 7, UNIFORM_ENVIRONMENT_BINDING: 5, UNIFORM_JOINT_TEXTURE_BINDING: 7, UNIFORM_LIGHTMAP_TEXTURE_BINDING: Jb, UNIFORM_NORMAL_MORPH_TEXTURE_BINDING: 9, UNIFORM_POSITION_MORPH_TEXTURE_BINDING: 8, UNIFORM_REALTIME_JOINT_TEXTURE_BINDING: 7, UNIFORM_REFLECTION_PROBE_BLEND_CUBEMAP_BINDING: 16, UNIFORM_REFLECTION_PROBE_CUBEMAP_BINDING: sw, UNIFORM_REFLECTION_PROBE_DATA_MAP_BINDING: 15, UNIFORM_REFLECTION_PROBE_TEXTURE_BINDING: hw, UNIFORM_SHADOWMAP_BINDING: 4, UNIFORM_SPOT_SHADOW_MAP_TEXTURE_BINDING: 6, UNIFORM_SPRITE_TEXTURE_BINDING: 12, UNIFORM_TANGENT_MORPH_TEXTURE_BINDING: 10, bindingMappingInfo: sb, getDefaultShadowTexture: xw, globalDescriptorSetLayout: nb, isEnableEffect: function () { return !(!S.rendering || !S.rendering.enableEffectImport) }, localDescriptorSetLayout: rb, localDescriptorSetLayout_ResizeMaxJoints: Bb, supportsR16HalfFloatTexture: function (t) { return !(3 & ~t.getFormatFeatures(8)) }, supportsR32FloatTexture: Sw, supportsRGBA16HalfFloatTexture: Tw, supportsRGBA32FloatTexture: function (t) { return !(3 & ~t.getFormatFeatures(44)) } })); var Iw = 4227858432, Ew = 66060288, Aw = 1044480, Cw = function (t, e, i, n) { return void 0 === n && (n = 0), e << 26 & Iw | t << 20 & Ew | i << 12 & Aw | 4095 & n }, Dw = function (t) { return (t & Iw) >>> 26 }, Rw = function (t) { return (t & Ew) >>> 20 }, Pw = function (t) { return (t & Aw) >>> 12 }, Bw = function (t) { return 4095 & t }, Mw = function (t, e) { return 67108863 & t | e << 26 & Iw }, Ow = ((gw = {})[0] = function (t, e, i) { return void 0 === i && (i = 0), it(12010, i) }, gw[5] = function (t, e, i) { return void 0 === i && (i = 0), t[i] }, gw[6] = function (t, e, i) { return void 0 === i && (i = 0), as.fromArray(e, t, i) }, gw[7] = function (t, e, i) { return void 0 === i && (i = 0), Kn.fromArray(e, t, i) }, gw[8] = function (t, e, i) { return void 0 === i && (i = 0), Pn.fromArray(e, t, i) }, gw[13] = function (t, e, i) { return void 0 === i && (i = 0), t[i] }, gw[14] = function (t, e, i) { return void 0 === i && (i = 0), as.fromArray(e, t, i) }, gw[15] = function (t, e, i) { return void 0 === i && (i = 0), Kn.fromArray(e, t, i) }, gw[16] = function (t, e, i) { return void 0 === i && (i = 0), Pn.fromArray(e, t, i) }, gw[21] = function (t, e, i) { return void 0 === i && (i = 0), cr.fromArray(e, t, i) }, gw[25] = function (t, e, i) { return void 0 === i && (i = 0), Gr.fromArray(e, t, i) }, gw), Lw = ((mw = {})[0] = function (t, e, i) { return void 0 === i && (i = 0), it(12010, i) }, mw[5] = function (t, e, i) { return void 0 === i && (i = 0), t[i] = e }, mw[6] = function (t, e, i) { return void 0 === i && (i = 0), as.toArray(t, e, i) }, mw[7] = function (t, e, i) { return void 0 === i && (i = 0), Kn.toArray(t, e, i) }, mw[8] = function (t, e, i) { return void 0 === i && (i = 0), Pn.toArray(t, e, i) }, mw[13] = function (t, e, i) { return void 0 === i && (i = 0), t[i] = e }, mw[14] = function (t, e, i) { return void 0 === i && (i = 0), as.toArray(t, e, i) }, mw[15] = function (t, e, i) { return void 0 === i && (i = 0), Kn.toArray(t, e, i) }, mw[16] = function (t, e, i) { return void 0 === i && (i = 0), Pn.toArray(t, e, i) }, mw[21] = function (t, e, i) { return void 0 === i && (i = 0), cr.toArray(t, e, i) }, mw[25] = function (t, e, i) { return void 0 === i && (i = 0), Gr.toArray(t, e, i) }, mw), Fw = ((vw = {})[5] = function (t) { return "number" == typeof t }, vw[13] = function (t) { return "number" == typeof t }, vw[6] = function (t) { return !!(t instanceof as) }, vw[14] = function (t) { return !!(t instanceof as) }, vw[7] = function (t) { return !!(t instanceof Kn) }, vw[15] = function (t) { return !!(t instanceof Kn) }, vw[8] = function (t) { return !!(t instanceof Pn) }, vw[16] = function (t) { return !!(t instanceof Pn || t instanceof rr || t instanceof Er) }, vw[21] = function (t) { return !!(t instanceof cr) }, vw[25] = function (t) { return !!(t instanceof Gr) }, vw), kw = [Object.freeze([0]), Object.freeze([0, 0]), Object.freeze([0, 0, 0, 0]), Object.freeze([1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1])]; function Nw(t) { switch (t) { case 1: case 5: case 9: case 13: return kw[0]; case 2: case 6: case 10: case 14: return kw[1]; case 4: case 8: case 12: case 16: return kw[2]; case 25: return kw[3]; case 28: return "default-texture"; case 31: return "default-cube-texture"; case 29: return "default-array-texture"; case 30: return "default-3d-texture" }return kw[0] } function zw(t) { switch (t) { case 28: return "-texture"; case 31: return "-cube-texture"; case 29: return "-array-texture"; case 30: return "-3d-texture"; default: return "-unknown" } } function Uw(t, e) { for (var i = Object.entries(e), n = !1, r = 0; r < i.length; r++)t[i[r][0]] !== i[r][1] && (t[i[r][0]] = i[r][1], n = !0); return n } function Vw(t, e) { switch (t.type) { case "boolean": return "number" == typeof e ? e.toString() : e ? "1" : "0"; case "string": return void 0 !== e ? e : t.options[0]; case "number": return void 0 !== e ? e.toString() : t.range[0].toString(); default: return it(16369), "-1" } } function Gw(t, e) { for (var i = [], n = 0; n < e.length; n++) { var r = e[n], s = r.name, a = t[s], o = Vw(r, a), u = !a || "0" === a; i.push({ name: s, value: o, isDefault: u }) } return i } function Hw(t, e) { return t + e.reduce((function (t, e) { return e.isDefault ? t : t + "|" + e.name + e.value }), "") } function Ww(t, e) { for (var i = 0; i < t.length; i++) { var n = t[i]; if ("!" === n[0]) { if (e[n.slice(1)]) return !1 } else if (!e[n]) return !1 } return !0 } function jw(t, e, i) { for (var n = [], r = t.attributes, s = 0; s < r.length; s++)Ww(r[s].defines, i) && n.push(e[s]); return n } function Xw(t, e) { var i = t.defines; if (t.uber) { for (var n = "", r = 0; r < i.length; r++) { var s = i[r], a = e[s.name]; if (a && s._map) { var o = s._map(a); n += "" + s._offset + o + "|" } } return "" + n + t.hash } for (var u = 0, h = 0; h < i.length; h++) { var c = i[h], l = e[c.name]; l && c._map && (u |= c._map(l) << c._offset) } return u.toString(16) + "|" + t.hash } var qw = new Map; function Yw(t, e) { if (e.count) return t + Jp(e.type) * e.count; var i = qw.get(e.name); return void 0 !== i ? t + Jp(e.type) * i : (rt(16345, e.name), t) } function Kw(t) { return t.reduce(Yw, 0) } function Qw(t) { for (var e = {}, i = 0; i < t.blocks.length; i++)for (var n = t.blocks[i], r = n.members, s = 0, a = 0; a < r.length; a++) { var o = r[a]; e[o.name] = Cw(n.binding, o.type, o.count, s), s += (Jp(o.type) >> 2) * o.count } for (var u = 0; u < t.samplerTextures.length; u++) { var h = t.samplerTextures[u]; e[h.name] = Cw(h.binding, h.type, h.count) } return e } function Zw(t) { return Math.ceil(Math.log2(Math.max(t, 2))) } function Jw(t) { for (var e = 0, i = function () { var i = t.defines[n], r = 1; if ("number" === i.type) { var s = i.range; r = Zw(s[1] - s[0] + 1), i._map = function (t) { return t - s[0] } } else "string" === i.type ? (r = Zw(i.options.length), i._map = function (t) { return Math.max(0, i.options.findIndex((function (e) { return e === t }))) }) : "boolean" === i.type && (i._map = function (t) { return t ? 1 : 0 }); i._offset = e, e += r }, n = 0; n < t.defines.length; n++)i(); for (var r in e > 31 && (t.uber = !0), t.constantMacros = "", t.builtins.statistics) t.constantMacros += "#define " + r + " " + t.builtins.statistics[r] + "\n" } function $w(t) { var e = Object.keys(t).reduce((function (e, i) { return e.reduce((function (e, n) { for (var s = t[i], a = 0; a < s.length; ++a) { var o = r({}, n); o[i] = s[a], e.push(o) } return e }), []) }), [{}]); return e } function tx(t) { for (var e = 0; e < t.techniques.length; e++)for (var i = t.techniques[e], n = 0; n < i.passes.length; n++) { var r = i.passes[n]; void 0 !== r.propertyIndex && void 0 === r.properties && (r.properties = i.passes[r.propertyIndex].properties) } } qw.set("cc_joints", Pb.LAYOUT.members[0].count), qw.set("cc_lightPos", 1), qw.set("cc_lightColor", 1), qw.set("cc_lightSizeRangeAngle", 1), qw.set("cc_lightDir", 1), qw.set("cc_lightBoundingSizeVS", 1); var ex = new Cp; function ix(t, e, i, n) { for (var r = t.builtins[n], s = [], a = function () { var t = r.blocks[o], e = i.layouts[t.name], n = e && i.bindings.find((function (t) { return t.binding === e.binding })); if (!(e && n && n.descriptorType & jp)) return it(16348, t.name), 1; s.push(e) }, o = 0; o < r.blocks.length; o++)a(); Array.prototype.unshift.apply(e.shaderInfo.blocks, s); for (var u = [], h = function () { var t = r.samplerTextures[c], e = i.layouts[t.name], n = e && i.bindings.find((function (t) { return t.binding === e.binding })); if (!(e && n && n.descriptorType & Xp)) return it(16349, t.name), 1; u.push(e) }, c = 0; c < r.samplerTextures.length; c++)h(); Array.prototype.unshift.apply(e.shaderInfo.samplerTextures, u) } var nx = function () { function t() { this._templates = {}, this._cache = {}, this._templateInfos = {} } var e = t.prototype; return e.register = function (t) { for (var e = 0; e < t.shaders.length; e++)this.define(t.shaders[e]).effectName = t.name; for (var i = 0; i < t.techniques.length; i++)for (var n = t.techniques[i], r = 0; r < n.passes.length; r++) { var s = n.passes[r]; void 0 !== s.propertyIndex && void 0 === s.properties && (s.properties = n.passes[s.propertyIndex].properties) } }, e.define = function (t) { var e = this._templates[t.name]; if (e && e.hash === t.hash) return e; var i = r({}, t); if (Jw(i), this._templates[t.name] = i, !this._templateInfos[i.hash]) { var n = {}; n.samplerStartBinding = i.blocks.length, n.shaderInfo = new _p, n.blockSizes = [], n.bindings = []; for (var s = 0; s < i.blocks.length; s++) { var a = i.blocks[s]; n.blockSizes.push(Kw(a.members)), n.bindings.push(new Ap(a.binding, 1, 1, a.stageFlags)), n.shaderInfo.blocks.push(new ap(1, a.binding, a.name, a.members.map((function (t) { return new sp(t.name, t.type, t.count) })), 1)) } for (var o = 0; o < i.samplerTextures.length; o++) { var u = i.samplerTextures[o]; n.bindings.push(new Ap(u.binding, 16, u.count, u.stageFlags)), n.shaderInfo.samplerTextures.push(new op(1, u.binding, u.name, u.type, u.count)) } for (var h = 0; h < i.samplers.length; h++) { var c = i.samplers[h]; n.bindings.push(new Ap(c.binding, 32, c.count, c.stageFlags)), n.shaderInfo.samplers.push(new up(1, c.binding, c.name, c.count)) } for (var l = 0; l < i.textures.length; l++) { var f = i.textures[l]; n.bindings.push(new Ap(f.binding, 64, f.count, f.stageFlags)), n.shaderInfo.textures.push(new hp(1, f.binding, f.name, f.type, f.count)) } for (var d = 0; d < i.buffers.length; d++) { var p = i.buffers[d]; n.bindings.push(new Ap(p.binding, 4, 1, p.stageFlags)), n.shaderInfo.buffers.push(new lp(1, p.binding, p.name, 1, p.memoryAccess)) } for (var _ = 0; _ < i.images.length; _++) { var g = i.images[_]; n.bindings.push(new Ap(g.binding, 128, g.count, g.stageFlags)), n.shaderInfo.images.push(new cp(1, g.binding, g.name, g.type, g.count, g.memoryAccess)) } for (var m = 0; m < i.subpassInputs.length; m++) { var v = i.subpassInputs[m]; n.bindings.push(new Ap(v.binding, 256, v.count, v.stageFlags)), n.shaderInfo.subpassInputs.push(new fp(1, v.binding, v.name, v.count)) } n.gfxAttributes = []; for (var y = 0; y < i.attributes.length; y++) { var b = i.attributes[y]; n.gfxAttributes.push(new pp(b.name, b.format, b.isNormalized, 0, b.isInstanced, b.location)) } ix(i, n, rb, "locals"), n.shaderInfo.stages.push(new dp(1, "")), n.shaderInfo.stages.push(new dp(16, "")), n.handleMap = Qw(i), n.setLayouts = [], this._templateInfos[i.hash] = n } return i }, e.getTemplate = function (t) { return this._templates[t] }, e.getTemplateInfo = function (t) { var e = this._templates[t].hash; return this._templateInfos[e] }, e.getDescriptorSetLayout = function (t, e, i) { void 0 === i && (i = !1); var n = this._templates[e], r = this._templateInfos[n.hash]; return r.setLayouts.length || (ex.bindings = r.bindings, r.setLayouts[1] = t.createDescriptorSetLayout(ex), ex.bindings = rb.bindings, r.setLayouts[2] = t.createDescriptorSetLayout(ex)), r.setLayouts[i ? 2 : 1] }, e.hasProgram = function (t) { return void 0 !== this._templates[t] }, e.getKey = function (t, e) { return Xw(this._templates[t], e) }, e.destroyShaderByDefines = function (t) { var e = this, i = Object.keys(t); if (i.length) for (var n = i.map((function (e) { var i = t[e]; return "boolean" == typeof i && (i = i ? "1" : "0"), new RegExp("" + e + i) })), r = Object.keys(this._cache).filter((function (t) { return n.every((function (i) { return i.test(e._cache[t].name) })) })), s = 0; s < r.length; s++) { var a = r[s], o = this._cache[a]; q("destroyed shader " + o.name), o.destroy(), delete this._cache[a] } }, e.getGFXShader = function (t, e, i, n, r) { Object.assign(i, n.macros), r || (r = this.getKey(e, i)); var s = this._cache[r]; if (s) return s; var a = this._templates[e], o = this._templateInfos[a.hash]; o.pipelineLayout || (this.getDescriptorSetLayout(t, e), ix(a, o, nb, "globals"), o.setLayouts[0] = n.descriptorSetLayout, o.pipelineLayout = t.createPipelineLayout(new Rp(o.setLayouts))); var u = Gw(i, a.defines), h = n.constantMacros + a.constantMacros + u.reduce((function (t, e) { return t + "#define " + e.name + " " + e.value + "\n" }), ""), c = a.glsl3, l = rx(t); l ? c = a[l] : rt(16346), o.shaderInfo.stages[0].source = h + c.vert, o.shaderInfo.stages[1].source = h + c.frag, o.shaderInfo.attributes = jw(a, o.gfxAttributes, i), o.shaderInfo.name = Hw(e, u); var f = o.shaderInfo; return this._cache[r] = t.createShader(f) }, t }(); function rx(t) { switch (t.gfxAPI) { case 1: case 6: return "glsl1"; case 2: case 7: return "glsl3"; default: return "glsl4" } } var sx, ax, ox, ux, hx, cx, lx, fx = new nx; S.programLib = fx; var dx = ["planar-shadow", "skybox", "deferred-lighting", "bloom", "hbao", "copy-pass", "post-process", "profiler", "splash-screen", "unlit", "sprite", "particle", "particle-gpu", "particle-trail", "billboard", "terrain", "graphics", "clear-stencil", "spine", "occlusion-query", "geometry-renderer", "debug-renderer", "ssss-blur", "float-output-process"], px = t("EffectAsset", Gu("cc.EffectAsset")((lx = function (t) { function e(e) { var i; return (i = t.call(this, e) || this).techniques = ox && ox(), i.shaders = ux && ux(), i.combinations = hx && hx(), i.hideInEditor = cx && cx(), i } s(e, t), e.register = function (t) { e._effects[t.name] = t, e._layoutValid = !1 }, e.remove = function (t) { if ("string" != typeof t) e._effects[t.name] && e._effects[t.name] === t && delete e._effects[t.name]; else { if (e._effects[t]) return void delete e._effects[t]; for (var i in e._effects) if (e._effects[i]._uuid === t) return void delete e._effects[i] } }, e.get = function (t) { if (e._effects[t]) return e._effects[t]; for (var i in e._effects) if (e._effects[i]._uuid === t) return e._effects[i]; return dx.includes(t) && it(16101, t), null }, e.getAll = function () { return e._effects }, e.isLayoutValid = function () { return e._layoutValid }, e.setLayoutValid = function () { e._layoutValid = !0 }; var i = e.prototype; return i.onLoaded = function () { if (S.rendering && S.rendering.enableEffectImport) { tx(this); var t = S.rendering.programLib; t.addEffect(this), t.init(B_.gfxDevice) } else fx.register(this); e.register(this), S.game.once(S.Game.EVENT_RENDERER_INITED, this._precompile, this) }, i._precompile = function () { var t = this; if (S.rendering && S.rendering.enableEffectImport) S.rendering.programLib.precompileEffect(B_.gfxDevice, this); else for (var e = S.director.root, i = function () { var i = t.shaders[n], r = t.combinations[n]; if (!r) return 1; $w(r).forEach((function (t) { return fx.getGFXShader(B_.gfxDevice, i.name, t, e.pipeline) })) }, n = 0; n < this.shaders.length; n++)i() }, i.destroy = function () { return e.remove(this), t.prototype.destroy.call(this) }, i.initDefault = function (i) { t.prototype.initDefault.call(this, i); var n = e.get("builtin-unlit"); this.name = "builtin-unlit", this.shaders = n.shaders, this.combinations = n.combinations, this.techniques = n.techniques }, i.validate = function () { return this.techniques.length > 0 && this.shaders.length > 0 }, e }(pg), lx._effects = {}, lx._layoutValid = !0, ox = Bu((ax = lx).prototype, "techniques", [eh], (function () { return [] })), ux = Bu(ax.prototype, "shaders", [eh], (function () { return [] })), hx = Bu(ax.prototype, "combinations", [eh], (function () { return [] })), cx = Bu(ax.prototype, "hideInEditor", [eh, nh], (function () { return !1 })), sx = ax)) || sx); S.EffectAsset = px; var _x = function (t, e) { return !(t.length > e.length) || 47 === t.charCodeAt(e.length) }, gx = function (t) { var e = t.uuids, i = t.paths, n = t.types, r = t.deps, s = t.paths = Object.create(null); if (!1 === t.debug) { for (var a = 0, o = e.length; a < o; a++)e[a] = J_(e[a]); for (var u in i) { var h = i[u], c = h[1]; h[1] = n[c] } } else { for (var l = Object.create(null), f = 0, d = e.length; f < d; f++) { var p = e[f]; e[f] = l[p] = J_(p) } e = l } for (var _ in i) { var g = i[_]; s[e[_]] = g } var m = t.scenes; for (var v in m) { var y = m[v]; m[v] = e[y] } var b = t.packs; for (var w in b) for (var x = b[w], S = 0; S < x.length; ++S)x[S] = e[x[S]]; var T = t.versions; if (T) for (var I in T) for (var E = T[I], A = 0; A < E.length; A += 2) { var C = E[A]; E[A] = e[C] || C } var D = t.redirect; if (D) for (var R = 0; R < D.length; R += 2)D[R] = e[D[R]], D[R + 1] = r[D[R + 1]]; if (t.extensionMap) { var P = function (i) { if (!Object.prototype.hasOwnProperty.call(t.extensionMap, i)) return 1; t.extensionMap[i].forEach((function (n, r) { t.extensionMap[i][r] = e[n] || n })) }; for (var B in t.extensionMap) P(B) } }, mx = function () { function t() { this.name = "", this.base = "", this.importBase = "", this.nativeBase = "", this.deps = null, this.assetInfos = new F_, this.scenes = new F_, this.paths = new F_ } var e = t.prototype; return e.init = function (t) { var e = this; gx(t), this.importBase = t.importBase || "", this.nativeBase = t.nativeBase || "", this.base = t.base || "", this.name = t.name || "", this.deps = t.deps || [], this._initUuid(t.uuids), this._initPath(t.paths), this._initScene(t.scenes), this._initPackage(t.packs), this._initVersion(t.versions), this._initRedirect(t.redirect); var i = function (i) { if (!Object.prototype.hasOwnProperty.call(t.extensionMap, i)) return 1; t.extensionMap[i].forEach((function (t) { var n = e.assetInfos.get(t); n && (n.extension = i) })) }; for (var n in t.extensionMap) i(n) }, e.getInfoWithPath = function (t, e) { if (!t) return null; t = ng(t); var i = this.paths.get(t); if (i) { if (!e) return i[0]; for (var n = 0, r = i.length; n < r; n++) { var s = i[n]; if (Jt(s.ctor, e)) return s } } return null }, e.getDirWithPath = function (t, e, i) { "/" === (t = ng(t))[t.length - 1] && (t = t.slice(0, -1)); var n = i || []; return this.paths.forEach((function (i, r) { if (r.startsWith(t) && _x(r, t) || !t) for (var s = 0, a = i.length; s < a; s++) { var o = i[s]; e && !Jt(o.ctor, e) || n.push(o) } })), n }, e.getAssetInfo = function (t) { return this.assetInfos.get(t) || null }, e.getSceneInfo = function (t) { t.endsWith(".scene") || (t += ".scene"), "/" === t[0] || t.startsWith("db://") || (t = "/" + t); var e = this.scenes.find((function (e, i) { return i.endsWith(t) })); return e }, e.destroy = function () { this.paths.destroy(), this.scenes.destroy(), this.assetInfos.destroy() }, e._initUuid = function (t) { if (t) { this.assetInfos.clear(); for (var e = 0, i = t.length; e < i; e++) { var n = t[e]; this.assetInfos.add(n, { uuid: n }) } } }, e._initPath = function (t) { if (t) { var e = this.paths; for (var i in e.clear(), t) { var n = t[i], r = n[0], s = n[1], a = 3 === n.length, o = this.assetInfos.get(i); o.path = r, o.ctor = he(s), e.has(r) ? a ? e.get(r).push(o) : e.get(r).unshift(o) : e.add(r, [o]) } } }, e._initScene = function (t) { if (t) { var e = this.scenes; e.clear(); var i = this.assetInfos; for (var n in t) { var r = t[n], s = i.get(r); s.url = n, e.add(n, s) } } }, e._initPackage = function (t) { if (t) { var e = this.assetInfos; for (var i in t) { var n = t[i], r = { uuid: i, packedUuids: n, ext: ".json" }; e.add(i, r); for (var s = 0, a = n.length; s < a; s++) { var o = n[s], u = e.get(o), h = u.packs; h ? 1 === a ? h.unshift(r) : h.push(r) : u.packs = [r] } } } }, e._initVersion = function (t) { if (t) { var e = this.assetInfos, i = t.import; if (i) for (var n = 0, r = i.length; n < r; n += 2) { var s = i[n]; e.get(s).ver = i[n + 1] } if (i = t.native) for (var a = 0, o = i.length; a < o; a += 2) { var u = i[a]; e.get(u).nativeVer = i[a + 1] } } }, e._initRedirect = function (t) { if (t) for (var e = this.assetInfos, i = 0, n = t.length; i < n; i += 2) { var r = t[i]; e.get(r).redirect = t[i + 1] } }, t }(); function vx(t, e) { t._uuid && e.push(t._uuid) } function yx(t, e) { for (var i = Object.getOwnPropertyNames(t), n = 0; n < i.length; n++) { var r = i[n]; if ("node" !== r && "__eventTargets" !== r) { var s = t[r]; if ("object" == typeof s && s) if (Array.isArray(s)) for (var a = 0; a < s.length; a++) { var o = s[a]; o instanceof pg && vx(o, e) } else if (s.constructor && s.constructor !== Object) s instanceof pg && vx(s, e); else for (var u = Object.getOwnPropertyNames(s), h = 0; h < u.length; h++) { var c = s[u[h]]; c instanceof pg && vx(c, e) } } } } function bx(t, e) { for (var i = 0; i < t._components.length; i++)yx(t._components[i], e); for (var n = 0; n < t._children.length; n++)bx(t._children[n], e) } function wx(t, e, i, n) { i.push(t._uuid); for (var r = hv.getDeps(t._uuid), s = 0, a = r.length; s < a; s++) { var o = N_.get(r[s]); if (o) { var u = o._uuid; u in e ? e[u] += n : e[u] = o.refCount + n, i.includes(u) || wx(o, e, i, n) } } } var xx = []; function Sx(t) { var e = Object.create(null); if (e[t._uuid] = t.refCount, wx(t, e, xx, -1), xx.length = 0, 0 !== e[t._uuid]) return e[t._uuid]; for (var i in e) 0 !== e[i] && wx(N_.get(i), e, xx, 1); return xx.length = 0, e[t._uuid] } var Tx = function () { function t() { this._persistNodeDeps = new F_, this._toDelete = new F_, this._eventListener = !1, this._dontDestroyAssets = [] } var e = t.prototype; return e.addIgnoredAsset = function (t) { this._dontDestroyAssets.push(t._uuid) }, e.init = function () { this._persistNodeDeps.clear(), this._toDelete.clear() }, e._addPersistNodeRef = function (t) { var e = []; bx(t, e); for (var i = 0, n = e.length; i < n; i++) { var r = N_.get(e[i]); r && r.addRef() } this._persistNodeDeps.add(t.uuid, e) }, e._removePersistNodeRef = function (t) { if (this._persistNodeDeps.has(t.uuid)) { for (var e = this._persistNodeDeps.get(t.uuid), i = 0, n = e.length; i < n; i++) { var r = N_.get(e[i]); r && r.decRef() } this._persistNodeDeps.remove(t.uuid) } }, e._autoRelease = function (t, e, i) { if (t) { for (var n = hv.getDeps(t.uuid), r = 0, s = n.length; r < s; r++) { var a = N_.get(n[r]); a && a.decRef(t.autoReleaseAssets) } var o = hv._depends.get(t.uuid); if (o && o.persistDeps) for (var u = o.persistDeps, h = 0, c = u.length; h < c; h++) { var l = N_.get(u[h]); l && l.decRef(t.autoReleaseAssets) } t.uuid !== e.uuid && hv.remove(t.uuid) } var f = hv._depends.get(e.uuid); for (var d in f && (f.persistDeps = []), i) { for (var _, g, m = i[d], v = this._persistNodeDeps.get(m.uuid), y = p(v); !(g = y()).done;) { var b = g.value, w = N_.get(b); w && w.addRef() } f && (_ = f.persistDeps).push.apply(_, v) } }, e.tryRelease = function (t, e) { void 0 === e && (e = !1), t instanceof pg && (e ? this._free(t, e) : (this._toDelete.add(t._uuid, t), this._eventListener || (this._eventListener = !0, Xe(this._freeAssets.bind(this))))) }, e._freeAssets = function () { var t = this; this._eventListener = !1, this._toDelete.forEach((function (e) { t._free(e) })), this._toDelete.clear() }, e._free = function (t, e) { void 0 === e && (e = !1); var i = t._uuid; if (this._toDelete.remove(i), lo(t, !0) && -1 === this._dontDestroyAssets.indexOf(i) && !(!e && t.refCount > 0 && Sx(t) > 0)) { N_.remove(i); for (var n = hv.getDeps(i), r = 0, s = n.length; r < s; r++) { var a = N_.get(n[r]); a && (a.decRef(!1), this._free(a, !1)) } t.destroy(), hv.remove(i) } }, t }(), Ix = new Tx, Ex = null; function Ax(t) { for (var e = 0, i = t.input.length; e < i; e++) { var n = t.input[e]; !n.isNative && n.content instanceof pg && n.content.decRef(!1), n.recycle() } t.input = null } function Cx(t, e) { return e ? /\?/.test(t) ? t + "&_t=" + Date.now() : t + "?_t=" + Date.now() : t } function Dx(t, e, i, n, r) { void 0 === r && (r = 0), t(r, (function (s, a) { r++, !s || r > e ? n && n(s, a) : setTimeout((function () { Dx(t, e, i, n, r) }), i) })) } function Rx(t, e, i, n, s) { try { for (var a = hv.parse(t, e), o = 0, u = a.deps.length; o < u; o++) { var h = a.deps[o]; h in i || (i[h] = !0, n.push({ uuid: h, bundle: s && s.name })) } a.nativeDep && (s && (a.nativeDep.bundle = s.name), n.push(r({}, a.nativeDep))) } catch (t) { j(t.message, t.stack) } } function Px(t, e, i) { e && (i = void 0 !== i ? i : S.assetManager.cacheAsset, ig(e) || !i || e.isDefault || N_.add(t, e)) } function Bx(t, e, i) { var n = !1, r = nv.get(e); if (r) { for (var s = 0, a = r.length; s < a; s++) { var o = r[s], u = i[o.uuid + "@import"]; if (u) o.owner[o.prop] = u.addRef(); else { if (rt(16350, o.uuid), S.assetManager.dispatchAssetMissing(e, o.owner, o.prop, o.uuid), o.type && o.type !== pg) { var h = new o.type; h.initDefault(o.uuid), o.owner[o.prop] = h } n = !0 } } nv.delete(e) } return rv.has(e) && (i[t + "@native"] ? e._nativeAsset = i[t + "@native"] : (n = !0, rt(16351, t)), rv.delete(e)), n } function Mx(t) { var e = t.source; if (t.options.__outputAsArray__ || 1 !== e.length) for (var i = t.output = [], n = 0, r = e.length; n < r; n++)i.push(e[n].content); else t.output = e[0].content } function Ox(t, e, i) { var n = 0, r = [], s = t.length; 0 === s && i && i(r); for (var a = function (t) { t && r.push(t), ++n === s && i && i(r) }, o = 0; o < s; o++)e(t[o], a) } function Lx(t, e, i) { var n = t, r = e, s = i; if (void 0 === i) { var a = "function" == typeof t; e ? (s = e, a || (r = null)) : void 0 === e && a && (s = t, n = null, r = null), void 0 !== e && a && (r = t, n = null) } return { options: n || Object.create(null), onProgress: r, onComplete: s } } function Fx(t, e, i) { var n = t, r = e, s = i; if (void 0 === i) { var a = Jt(t, pg); e ? (s = e, a && (r = null)) : void 0 !== e || a || (s = t, r = null, n = null), void 0 === e || a || (r = t, n = null) } return { type: n, onProgress: r || Ex, onComplete: s } } function kx(t, e, i, n) { if (void 0 === n && (n = {}), !i[e] || n[e]) return !1; n[e] = !0; var r = !1, s = hv.getDeps(e); if (s) for (var a = 0, o = s.length; a < o; a++) { var u = s[a]; if (u === t || kx(t, u, i, n)) { r = !0; break } } return r } function Nx(t) { return function (e, i) { if (t) { var n = []; Array.isArray(i) ? i.forEach((function (t) { return t instanceof pg && n.push(t.addRef()) })) : i instanceof pg && n.push(i.addRef()), Xe((function () { n.forEach((function (t) { return t.decRef(!1) })), t(e, i) })) } } } var zx = function () { function t() { this._config = new mx } var e = t.prototype; return e.getInfoWithPath = function (t, e) { return this._config.getInfoWithPath(t, e) }, e.getDirWithPath = function (t, e, i) { return this._config.getDirWithPath(t, e, i) }, e.getAssetInfo = function (t) { return this._config.getAssetInfo(t) }, e.getSceneInfo = function (t) { return this._config.getSceneInfo(t) }, e.init = function (t) { this._config.init(t), V_.add(t.name, this) }, e.load = function (t, e, i, n) { var r = Fx(e, i, n), s = r.type, a = r.onProgress, o = r.onComplete, u = { __requestType__: "path", type: s, bundle: this.name, __outputAsArray__: Array.isArray(t) }; S.assetManager.loadAny(t, u, a, o) }, e.preload = function (t, e, i, n) { var r = Fx(e, i, n), s = r.type, a = r.onProgress, o = r.onComplete; S.assetManager.preloadAny(t, { __requestType__: "path", type: s, bundle: this.name }, a, o) }, e.loadDir = function (t, e, i, n) { var r = Fx(e, i, n), s = r.type, a = r.onProgress, o = r.onComplete; S.assetManager.loadAny(t, { __requestType__: "dir", type: s, bundle: this.name, __outputAsArray__: !0 }, a, o) }, e.preloadDir = function (t, e, i, n) { var r = Fx(e, i, n), s = r.type, a = r.onProgress, o = r.onComplete; S.assetManager.preloadAny(t, { __requestType__: "dir", type: s, bundle: this.name }, a, o) }, e.loadScene = function (t, e, i, n) { var r = Lx(e, i, n), s = r.options, a = r.onProgress, o = r.onComplete; s.preset = s.preset || "scene", s.bundle = this.name, S.assetManager.loadAny({ scene: t }, s, a, (function (t, e) { if (t) j(t.message, t.stack); else if (e.scene) { var i = e.scene; i.id = e._uuid, i.name = e.name } else t = new Error("The asset " + e._uuid + " is not a scene"); o && o(t, e) })) }, e.preloadScene = function (t, e, i, n) { var r = Lx(e, i, n), s = r.options, a = r.onProgress, o = r.onComplete; s.bundle = this.name, S.assetManager.preloadAny({ scene: t }, s, a, (function (e) { e && rt(1210, t, e.message), o && o(e) })) }, e.get = function (t, e) { var i = this.getInfoWithPath(t, e); return i && N_.get(i.uuid) || null }, e.release = function (t, e) { var i = this.get(t, e); i && Ix.tryRelease(i, !0) }, e.releaseUnusedAssets = function () { var t = this; N_.forEach((function (e) { var i = t.getAssetInfo(e._uuid); i && !i.redirect && Ix.tryRelease(e) })) }, e.releaseAll = function () { var t = this; N_.forEach((function (e) { var i = t.getAssetInfo(e._uuid); i && !i.redirect && Ix.tryRelease(e, !0) })) }, e._destroy = function () { this._config.destroy() }, n(t, [{ key: "config", get: function () { return this._config } }, { key: "name", get: function () { return this._config.name } }, { key: "deps", get: function () { return this._config.deps } }, { key: "base", get: function () { return this._config.base } }]), t }(), Ux = t("resources", new zx); function Vx(t, e, i) { var n = new E.Image; function r() { n.removeEventListener("load", r), n.removeEventListener("error", s), i && i(null, n) } function s() { n.removeEventListener("load", r), n.removeEventListener("error", s), i && i(new Error(ut(4930, t))) } return "file:" !== E.location.protocol && (n.crossOrigin = "anonymous"), n.addEventListener("load", r), n.addEventListener("error", s), n.src = t, n } function Gx(t, e, i, n) { var r = new XMLHttpRequest, s = "download failed: " + t + ", status: "; if (r.open("GET", t, !0), void 0 !== e.xhrResponseType && (r.responseType = e.xhrResponseType), void 0 !== e.xhrWithCredentials && (r.withCredentials = e.xhrWithCredentials), void 0 !== e.xhrMimeType && r.overrideMimeType && r.overrideMimeType(e.xhrMimeType), void 0 !== e.xhrTimeout && (r.timeout = e.xhrTimeout), e.xhrHeader) for (var a in e.xhrHeader) r.setRequestHeader(a, e.xhrHeader[a]); return r.onload = function () { 200 === r.status || 0 === r.status ? n && n(null, r.response) : n && n(new Error("" + s + r.status + "(no response)")) }, i && (r.onprogress = function (t) { t.lengthComputable && i(t.loaded, t.total) }), r.onerror = function () { n && n(new Error("" + s + r.status + "(error)")) }, r.ontimeout = function () { n && n(new Error("" + s + r.status + "(time out)")) }, r.onabort = function () { n && n(new Error("" + s + r.status + "(abort)")) }, r.send(null), r } S.resources = Ux; var Hx = E.document, Wx = {}; function jx(t, e, i) { if (Wx[t]) return i && i(null), null; var n = Hx.createElement("script"); function r() { n.parentNode.removeChild(n), n.removeEventListener("load", r, !1), n.removeEventListener("error", s, !1), Wx[t] = !0, i && i(null) } function s() { n.parentNode.removeChild(n), n.removeEventListener("load", r, !1), n.removeEventListener("error", s, !1), i && i(new Error(ut(4928, t))) } return "file:" !== E.location.protocol && (n.crossOrigin = "anonymous"), n.async = e.scriptAsyncLoading || !1, n.src = t, n.addEventListener("load", r, !1), n.addEventListener("error", s, !1), Hx.body.appendChild(n), n } var Xx = /^(?:\w+:\/\/|\.+\/).+/, qx = function (t, e, i) { (tu.hasFeature(tu.Feature.IMAGE_BITMAP) && S.assetManager.allowImageBitmap ? Yx : Vx)(t, e, i) }, Yx = function (t, e, i) { e.xhrResponseType = "blob", Gx(t, e, e.onFileProgress, i) }, Kx = function (t, e, i) { e.xhrResponseType = "json", Gx(t, e, e.onFileProgress, i) }, Qx = function (t, e, i) { e.xhrResponseType = "arraybuffer", Gx(t, e, e.onFileProgress, i) }, Zx = function (t, e, i) { uS._downloadJson(t, e, (function (e, n) { if (e) i(e); else { var r = cm(n); Promise.all(r.chunks.map((function (i) { return new Promise((function (n, r) { uS._downloadArrayBuffer("" + Fo(t) + i, {}, (function (t, i) { e ? r(e) : n(new Uint8Array(i)) })) })) }))).then((function (t) { var e = new hm(r.document, t); i(null, e) })).catch((function (t) { i(t) })) } })) }, Jx = function (t, e, i) { uS._downloadArrayBuffer(t, e, (function (t, e) { if (t) i(t); else try { var n = lm(new Uint8Array(e)); i(null, n) } catch (t) { i(t) } })) }, $x = function (t, e, i) { e.xhrResponseType = "text", Gx(t, e, e.onFileProgress, i) }, tS = function (t, e, i) { var n = ko(t), r = t; Xx.test(r) || (r = -1 !== uS.remoteBundles.indexOf(n) ? uS.remoteServerAddress + "remote/" + n : "assets/" + n); var s = e.version || uS.bundleVers[n], a = 0, o = null, u = null; Kx(r + "/config." + (s ? s + "." : "") + "json", e, (function (t, e) { u = t || u, (o = e) && (o.base = r + "/"), 2 == ++a && i(u, o) })), jx(r + "/index." + (s ? s + "." : "") + "js", e, (function (t) { u = t || u, 2 == ++a && i(u, o) })) }, eS = function () { var t = e.prototype; function e() { this.maxConcurrency = 15, this.maxRequestsPerFrame = 15, this.maxRetryCount = 3, this.appendTimeStamp = !1, this.limited = !0, this.retryInterval = 2e3, this.bundleVers = {}, this.remoteBundles = [], this.downloadDomImage = Vx, this.downloadDomAudio = null, this.downloadFile = Gx, this.downloadScript = jx, this._downloadArrayBuffer = Qx, this._downloadJson = Kx, this._downloaders = { ".png": qx, ".jpg": qx, ".bmp": qx, ".jpeg": qx, ".gif": qx, ".ico": qx, ".tiff": qx, ".webp": qx, ".image": qx, ".pvr": Qx, ".pkm": Qx, ".astc": Qx, ".txt": $x, ".xml": $x, ".vsh": $x, ".fsh": $x, ".atlas": $x, ".tmx": $x, ".tsx": $x, ".json": Kx, ".ExportJson": Kx, ".plist": $x, ".ccon": Zx, ".cconb": Jx, ".fnt": $x, ".binary": Qx, ".bin": Qx, ".dbbin": Qx, ".skel": Qx, ".js": jx, bundle: tS, default: $x }, this._downloading = new F_, this._queue = [], this._queueDirty = !1, this._totalNum = 0, this._totalNumThisPeriod = 0, this._lastDate = -1, this._checkNextPeriod = !1, this._remoteServerAddress = "", this._maxInterval = 1 / 30 } return t.init = function (t, e, i) { void 0 === t && (t = ""), void 0 === e && (e = {}), void 0 === i && (i = []), this._downloading.clear(), this._queue.length = 0, this._remoteServerAddress = t, this.bundleVers = e, this.remoteBundles = i }, t.register = function (t, e) { "object" == typeof t ? Kt(this._downloaders, t) : this._downloaders[t] = e }, t.download = function (t, e, i, n, r) { var s = this, a = z_.get(t); if (a) r(null, a); else { var o = this._downloading.get(t); if (o) { o.push(r); var u = this._queue.find((function (e) { return e.id === t })); if (!u) return; var h = n.priority || 0; u.priority < h && (u.priority = h, this._queueDirty = !0) } else { var c = void 0 !== n.maxRetryCount ? n.maxRetryCount : this.maxRetryCount, l = void 0 !== n.maxConcurrency ? n.maxConcurrency : this.maxConcurrency, f = void 0 !== n.maxRequestsPerFrame ? n.maxRequestsPerFrame : this.maxRequestsPerFrame, d = this._downloaders[i] || this._downloaders.default; Dx((function (i, a) { if (0 === i && s._downloading.add(t, [r]), s.limited) { s._updateTime(); var o = function (t, e) { s._totalNum--, s._handleQueueInNextFrame(l, f), a(t, e) }; s._totalNum < l && s._totalNumThisPeriod < f ? (d(Cx(e, s.appendTimeStamp), n, o), s._totalNum++, s._totalNumThisPeriod++) : (s._queue.push({ id: t, priority: n.priority || 0, url: e, options: n, done: o, handler: d }), s._queueDirty = !0, s._totalNum < l && s._handleQueueInNextFrame(l, f)) } else d(Cx(e, s.appendTimeStamp), n, a) }), c, this.retryInterval, (function (e, i) { e || z_.add(t, i); for (var n = s._downloading.remove(t), r = 0, a = n.length; r < a; r++)n[r](e, i) })) } } }, t.loadSubpackage = function (t, e) { S.assetManager.loadBundle(t, null, e) }, t._updateTime = function () { var t = performance.now(), e = S.game.deltaTime, i = e > this._maxInterval ? this._maxInterval : e; t - this._lastDate > 1e3 * i && (this._totalNumThisPeriod = 0, this._lastDate = t) }, t._handleQueue = function (t, e) { for (this._checkNextPeriod = !1, this._updateTime(); this._queue.length > 0 && this._totalNum < t && this._totalNumThisPeriod < e;) { this._queueDirty && (this._queue.sort((function (t, e) { return t.priority - e.priority })), this._queueDirty = !1); var i = this._queue.pop(); if (!i) break; this._totalNum++, this._totalNumThisPeriod++, i.handler(Cx(i.url, this.appendTimeStamp), i.options, i.done) } this._handleQueueInNextFrame(t, e) }, t._handleQueueInNextFrame = function (t, e) { !this._checkNextPeriod && this._queue.length > 0 && (Xe(this._handleQueue.bind(this), t, e), this._checkNextPeriod = !0) }, n(e, [{ key: "remoteServerAddress", get: function () { return this._remoteServerAddress } }, { key: "handlers", get: function () { return this._downloaders } }], [{ key: "instance", get: function () { return e._instance || (e._instance = new e), e._instance } }]), e }(); eS._instance = void 0; var iS, nS, rS, sS, aS, oS, uS = eS.instance, hS = eS.instance, cS = t("JsonAsset", Gu("cc.JsonAsset")((nS = function (t) { function e(e) { var i; return (i = t.call(this, e) || this).json = rS && rS(), i } return s(e, t), e }(pg), rS = Bu(nS.prototype, "json", [eh], (function () { return null })), iS = nS)) || iS); S.JsonAsset = cS; var lS, fS, dS = t("TextAsset", Gu("cc.TextAsset")((aS = function (t) { function e(e) { var i; return (i = t.call(this, e) || this).text = oS && oS(), i } return s(e, t), e.prototype.toString = function () { return this.text }, e }(pg), oS = Bu(aS.prototype, "text", [eh], (function () { return "" })), sS = aS)) || sS); S.TextAsset = dS; var pS = t("BufferAsset", Gu("cc.BufferAsset")((fS = function (t) { function e(e) { var i; return (i = t.call(this, e) || this)._buffer = null, i } s(e, t); var i = e.prototype; return i.buffer = function () { return this._buffer, this._buffer }, i.validate = function () { return !!this._buffer }, n(e, [{ key: "_nativeAsset", get: function () { return this._buffer }, set: function (t) { t instanceof ArrayBuffer ? this._buffer = t : this._buffer = t.buffer } }]), e }(pg), m(fS.prototype, "_nativeAsset", [Oh], Object.getOwnPropertyDescriptor(fS.prototype, "_nativeAsset"), fS.prototype), lS = fS)) || lS); function _S(t, e, i, n) { var r = null, s = null; try { (r = new Pg)._nativeUrl = t, r._nativeAsset = e } catch (t) { s = t } n(s, r) } function gS(t, e, i, n) { var r = new cS; r.json = e, n(null, r) } function mS(t, e, i, n) { var r = new dS; r.text = e, n(null, r) } function vS(t, e, i, n) { var r = new pS; r._nativeUrl = t, r._nativeAsset = e, n(null, r) } function yS(t, e, i, n) { var r = new pg; r._nativeUrl = t, r._nativeAsset = e, n(null, r) } function bS(t, i, n, r) { var s = V_.get(i.name); s || (s = "resources" === i.name ? Ux : new zx, i.base = i.base || t + "/", s.init(i)), e.import("virtual:///prerequisite-imports/" + s.name).then((function () { r(null, s) })).catch(r) } S.BufferAsset = pS; var wS = function () { function t() { this._creating = new F_, this._producers = { ".png": _S, ".jpg": _S, ".bmp": _S, ".jpeg": _S, ".gif": _S, ".ico": _S, ".tiff": _S, ".webp": _S, ".image": _S, ".pvr": _S, ".pkm": _S, ".astc": _S, ".txt": mS, ".xml": mS, ".vsh": mS, ".fsh": mS, ".atlas": mS, ".tmx": mS, ".tsx": mS, ".fnt": mS, ".json": gS, ".ExportJson": gS, ".binary": vS, ".bin": vS, ".dbbin": vS, ".skel": vS, bundle: bS, default: yS } } var e = t.prototype; return e.register = function (t, e) { "object" == typeof t ? Kt(this._producers, t) : this._producers[t] = e }, e.create = function (t, e, i, n, r) { var s = this, a = this._producers[i] || this._producers.default, o = N_.get(t); if (n.reloadAsset || !o) { var u = this._creating.get(t); u ? u.push(r) : (this._creating.add(t, [r]), a(t, e, n, (function (e, i) { !e && i instanceof pg && (i._uuid = t, Px(t, i, n.cacheAsset)); for (var r = s._creating.remove(t), a = 0, o = r.length; a < o; a++)r[a](e, i) }))) } else r(null, o) }, t }(), xS = new wS, SS = function () { function t() { this._loading = new F_, this._unpackers = { ".json": this.unpackJson } } var e = t.prototype; return e.unpackJson = function (t, e, i, n) { var r = Nt(!0), s = null; if (Array.isArray(e)) { (e = tv(e)).length !== t.length && rt(4915); for (var a = 0; a < t.length; a++)r[t[a] + "@import"] = e[a] } else { var o = fe(bv), u = fe(Pg); if (e.type === o && e.data) { var h = e.data; h.length !== t.length && rt(4915); for (var c = 0; c < t.length; c++)r[t[c] + "@import"] = ev(o, { base: h[c][0], mipmaps: h[c][1] }) } else { if (e.type !== u || !e.data) return void n(s = new Error("unmatched type pack!"), null); var l = e.data; l.length !== t.length && rt(4915); for (var f = 0; f < t.length; f++)r[t[f] + "@import"] = l[f] } } n(s, r) }, e.init = function () { this._loading.clear() }, e.register = function (t, e) { "object" == typeof t ? Kt(this._unpackers, t) : this._unpackers[t] = e }, e.unpack = function (t, e, i, n, r) { e ? (0, this._unpackers[i])(t, e, n, r) : r(new Error("package data is wrong!")) }, e.load = function (t, e, i) { var n = this; if (!t.isNative && t.info && t.info.packs) if (z_.has(t.id)) i(null, z_.get(t.id)); else { var r = t.info.packs, s = r.find((function (t) { return n._loading.has(t.uuid) })); if (s) this._loading.get(s.uuid).push({ onComplete: i, id: t.id }); else { var a = r[0]; this._loading.add(a.uuid, [{ onComplete: i, id: t.id }]), t.config; var o = rg(a.uuid, { ext: a.ext, bundle: t.config.name }); hS.download(a.uuid, o, a.ext, t.options, (function (e, i) { z_.remove(a.uuid), e && j(e.message, e.stack), n.unpack(a.packedUuids, i, a.ext, t.options, (function (t, i) { if (!t) for (var r in i) z_.add(r, i[r]); for (var s = n._loading.remove(a.uuid), o = 0, u = s.length; o < u; o++) { var h = s[o]; if (e || t) h.onComplete(e || t); else { var c = i[h.id]; c ? h.onComplete(null, c) : h.onComplete(new Error("can not retrieve data from package")) } } })) })) } } else hS.download(t.id, t.url, t.ext, t.options, i) }, t }(), TS = new SS; function IS(t, e) { var i = !1; t.progress || (t.progress = { finish: 0, total: t.input.length, canInvoke: !0 }, i = !0); var n = t.options, r = t.progress, s = [], a = r.total, o = n.__exclude__ = n.__exclude__ || Object.create(null); t.output = [], Ox(t.input, (function (n, u) { if (!n.isNative && N_.has(n.uuid)) { var h = N_.get(n.uuid); return n.content = h.addRef(), t.output.push(n), r.canInvoke && t.dispatch("progress", ++r.finish, r.total, n), void u() } TS.load(n, t.options, (function (h, c) { h ? t.isFinished || (!S.assetManager.force || i ? (j(h.message, h.stack), r.canInvoke = !1, e(h)) : (t.output.push(n), r.canInvoke && t.dispatch("progress", ++r.finish, r.total, n))) : t.isFinished || (n.file = c, t.output.push(n), n.isNative || (o[n.uuid] = !0, Rx(n.uuid, c, o, s, n.config), r.total = a + s.length), r.canInvoke && t.dispatch("progress", ++r.finish, r.total, n)), u() })) }), (function () { if (t.isFinished) return Ax(t), void t.dispatch("error"); if (s.length > 0) { var a = q_.create({ input: s, progress: r, options: n, onProgress: t.onProgress, onError: q_.prototype.recycle, onComplete: function (n) { var r; n || ((r = t.output).push.apply(r, a.output), a.recycle()), i && ES(t), e(n) } }); H_.async(a) } else i && ES(t), e() })) } function ES(t) { for (var e = t.output, i = 0, n = e.length; i < n; i++)e[i].content && e[i].content.decRef(!1) } var AS = function (t) { function e() { return t.apply(this, arguments) || this } s(e, t); var i = e.prototype; return i.parse = function (t) { var e = this._parseXML(t).documentElement; if ("plist" !== e.tagName) return it(5100), {}; for (var i = null, n = 0, r = e.childNodes.length; n < r && 1 !== (i = e.childNodes[n]).nodeType; n++); return this._parseNode(i) }, i._parseNode = function (t) { var e = null, i = t.tagName; if ("dict" === i) e = this._parseDict(t); else if ("array" === i) e = this._parseArray(t); else if ("string" === i) if (1 === t.childNodes.length) e = t.firstChild.nodeValue; else { e = ""; for (var n = 0; n < t.childNodes.length; n++)e += t.childNodes[n].nodeValue } else "false" === i ? e = !1 : "true" === i ? e = !0 : "real" === i ? e = parseFloat(t.firstChild.nodeValue) : "integer" === i && (e = parseInt(t.firstChild.nodeValue, 10)); return e }, i._parseArray = function (t) { for (var e = [], i = 0, n = t.childNodes.length; i < n; i++) { var r = t.childNodes[i]; 1 === r.nodeType && e.push(this._parseNode(r)) } return e }, i._parseDict = function (t) { for (var e = {}, i = "", n = 0, r = t.childNodes.length; n < r; n++) { var s = t.childNodes[n]; 1 === s.nodeType && ("key" === s.tagName ? i = s.firstChild.nodeValue : e[i] = this._parseNode(s)) } return e }, e }(function () { function t() { this._parser = null, globalThis.DOMParser && (this._parser = new DOMParser) } var e = t.prototype; return e.parse = function (t) { return this._parseXML(t) }, e._parseXML = function (t) { if (this._parser) return this._parser.parseFromString(t, "text/xml"); throw new Error("Dom parser is not supported in this platform!") }, t }()), CS = new AS, DS = function () { function t() { this._parsing = new F_, this._parsers = { ".png": this.parseImage, ".jpg": this.parseImage, ".bmp": this.parseImage, ".jpeg": this.parseImage, ".gif": this.parseImage, ".ico": this.parseImage, ".tiff": this.parseImage, ".webp": this.parseImage, ".image": this.parseImage, ".pvr": this.parsePVRTex, ".pkm": this.parsePKMTex, ".astc": this.parseASTCTex, ".plist": this.parsePlist, import: this.parseImport, ".ccon": this.parseImport, ".cconb": this.parseImport } } var e = t.prototype; return e.parseImage = function (t, e, i) { t instanceof HTMLImageElement ? i(null, t) : createImageBitmap(t, { premultiplyAlpha: "none" }).then((function (t) { i(null, t) }), (function (t) { i(t, null) })) }, e.parsePVRTex = function (t, e, i) { var n = null, r = null; try { r = Pg.parseCompressedTextures(t, 0) } catch (t) { W(n = t) } i(n, r) }, e.parsePKMTex = function (t, e, i) { var n = null, r = null; try { r = Pg.parseCompressedTextures(t, 1) } catch (t) { W(n = t) } i(n, r) }, e.parseASTCTex = function (t, e, i) { var n = null, r = null; try { r = Pg.parseCompressedTextures(t, 2) } catch (t) { W(n = t) } i(n, r) }, e.parsePlist = function (t, e, i) { var n = null, r = CS.parse(t); r || (n = new Error("parse failed")), i(n, r) }, e.parseImport = function (t, e, i) { if (t) { var n = null, r = null; try { n = av(t, e) } catch (t) { r = t } i(r, n) } else i(new Error(ut(3702, e.__uuid__))) }, e.init = function () { this._parsing.clear() }, e.register = function (t, e) { "object" == typeof t ? Kt(this._parsers, t) : this._parsers[t] = e }, e.parse = function (t, e, i, n, r) { var s = this, a = U_.get(t); if (a) r(null, a); else { var o = this._parsing.get(t); if (o) o.push(r); else { var u = this._parsers[i]; u ? (this._parsing.add(t, [r]), u(e, n, (function (e, i) { e ? z_.remove(t) : ig(i) || U_.add(t, i); for (var n = s._parsing.remove(t), r = 0, a = n.length; r < a; r++)n[r](e, i) }))) : r(null, e) } } }, n(t, null, [{ key: "instance", get: function () { return this._instance || (this._instance = new t), this._instance } }]), t }(); DS._instance = void 0; var RS = DS.instance; function PS(t, e) { var i = !1; t.progress || (t.progress = { finish: 0, total: t.input.length, canInvoke: !0 }, i = !0); var n = t.options, r = t.progress; n.__exclude__ = n.__exclude__ || Object.create(null), t.output = [], Ox(t.input, (function (s, a) { var o = q_.create({ input: s, onProgress: t.onProgress, options: n, progress: r, onComplete: function (n, u) { n && !t.isFinished && (!S.assetManager.force || i ? (j(n.message, n.stack), r.canInvoke = !1, e(n)) : r.canInvoke && t.dispatch("progress", ++r.finish, r.total, s)), t.output.push(u), o.recycle(), a(null) } }); BS.async(o) }), (function () { if (n.__exclude__ = null, t.isFinished) return Ax(t), void t.dispatch("error"); Mx(t), Ax(t), e() })) } var BS = new k_("loadOneAsset", [function (t, e) { var i = t.output = t.input, n = i.options, r = i.isNative, s = i.uuid, a = i.file, o = n.reloadAsset; a || !o && !r && N_.has(s) ? e() : TS.load(i, t.options, (function (t, n) { i.file = n, e(t) })) }, function (t, e) { var i = t.output = t.input, n = t.progress, r = t.options.__exclude__, s = i.id, a = i.file, o = i.options; if (i.isNative) RS.parse(s, a, i.ext, o, (function (r, a) { r ? e(r) : (i.content = a, n.canInvoke && t.dispatch("progress", ++n.finish, n.total, i), z_.remove(s), U_.remove(s), e()) })); else { var u = i.uuid; if (u in r) { var h = r[u], c = h.finish, l = h.content, f = h.err, d = h.callbacks; n.canInvoke && t.dispatch("progress", ++n.finish, n.total, i), c || kx(u, u, r) ? (l && l.addRef(), i.content = l, e(f)) : d.push({ done: e, item: i }) } else if (!o.reloadAsset && N_.has(u)) { var p = N_.get(u); i.content = p.addRef(), n.canInvoke && t.dispatch("progress", ++n.finish, n.total, i), e() } else o.__uuid__ = u, RS.parse(s, a, "import", o, (function (i, n) { i ? e(i) : MS(t, n, e) })) } }]); function MS(t, e, i) { var n = t.input, r = t.progress, s = n, a = s.uuid, o = s.id, u = s.options, h = s.config, c = u.cacheAsset, l = []; e.addRef && e.addRef(), Rx(a, e, Object.create(null), l, h), r.canInvoke && t.dispatch("progress", ++r.finish, r.total += l.length, n); var f = t.options.__exclude__[a] = { content: e, finish: !1, callbacks: [{ done: i, item: n }] }, d = q_.create({ input: l, options: t.options, onProgress: t.onProgress, onError: q_.prototype.recycle, progress: r, onComplete: function (t) { if (e.decRef && e.decRef(!1), f.finish = !0, f.err = t, !t) { for (var i, n = Array.isArray(d.output) ? d.output : [d.output], r = Object.create(null), s = p(n); !(i = s()).done;) { var u = i.value; u && (r[u instanceof pg ? u._uuid + "@import" : a + "@native"] = u) } Bx(a, e, r); try { "function" != typeof e.onLoaded || sv.has(e) || rv.has(e) || (e.onLoaded(), sv.add(e)) } catch (t) { rt(16352, a, t.message, t.stack) } z_.remove(o), U_.remove(o), Px(a, e, c), d.recycle() } for (var h = f.callbacks, l = 0, _ = h.length; l < _; l++) { var g = h[l]; e.addRef && e.addRef(), g.item.content = e, g.done(t) } h.length = 0 } }); G_.async(d) } function OS(t, e) { var i = t.options, n = Object.create(null), r = Object.create(null); for (var s in i) switch (s) { case "path": case "uuid": case "dir": case "scene": case "url": break; case "__requestType__": case "__isNative__": case "ext": case "type": case "__nativeName__": case "audioLoadMode": case "bundle": n[s] = i[s]; break; case "__exclude__": case "__outputAsArray__": r[s] = i[s]; break; default: n[s] = i[s], r[s] = i[s] }t.options = r; var a = q_.create({ input: t.input, options: n }), o = null; try { t.output = t.source = W_.sync(a) } catch (t) { o = t; for (var u = 0, h = a.output.length; u < h; u++)a.output[u].recycle() } a.recycle(), e(o) } var LS = function () { function t() { this.uuid = "", this.overrideUuid = "", this.url = "", this.ext = ".json", this.content = null, this.file = null, this.info = null, this.config = null, this.isNative = !1, this.options = Object.create(null), this._id = "" } return t.create = function () { return 0 !== t._deadPool.length ? t._deadPool.pop() : new t }, t.prototype.recycle = function () { t._deadPool.length !== t.MAX_DEAD_NUM && (this._id = "", this.uuid = "", this.overrideUuid = "", this.url = "", this.ext = ".json", this.content = null, this.file = null, this.info = null, this.config = null, this.isNative = !1, this.options = Object.create(null), t._deadPool.push(this)) }, n(t, [{ key: "id", get: function () { return this._id || (this._id = (this.overrideUuid || this.uuid) + "@" + (this.isNative ? "native" : "import")), this._id } }]), t }(); LS.MAX_DEAD_NUM = 500, LS._deadPool = []; var FS = []; function kS(t) { var e = t.options, i = Array.isArray(t.input) ? t.input : [t.input]; t.output = []; for (var n = function () { var n = i[r], s = LS.create(), a = null, o = null; if ("string" == typeof n && ((n = Object.create(null))[e.__requestType__ || "uuid"] = i[r]), "object" == typeof n) { Yt(n, e), n.preset && Yt(n, X_[n.preset]); var u = function () { var t; switch (h) { case "uuid": var e, r = s.uuid = J_(n.uuid); if (!n.bundle) { var u = V_.find((function (t) { return !!t.getAssetInfo(r) })); n.bundle = u && u.name } if (V_.has(n.bundle)) { if (a = V_.get(n.bundle).config, (o = a.getAssetInfo(r)) && o.redirect) { if (!V_.has(o.redirect)) throw new Error("Please load bundle " + o.redirect + " first"); a = V_.get(o.redirect).config, o = a.getAssetInfo(r) } s.config = a, s.info = o } s.ext = n.ext || (null == (e = o) ? void 0 : e.extension) || ".json"; break; case "__requestType__": case "ext": case "bundle": case "preset": case "type": break; case "dir": if (V_.has(n.bundle)) { V_.get(n.bundle).config.getDirWithPath(n.dir, n.type, FS); for (var c, l = p(FS); !(c = l()).done;) { var f = c.value; i.push({ uuid: f.uuid, __isNative__: !1, ext: f.extension || ".json", bundle: n.bundle }) } FS.length = 0 } s.recycle(), s = null; break; case "path": if (V_.has(n.bundle)) { if (a = V_.get(n.bundle).config, (o = a.getInfoWithPath(n.path, n.type)) && o.redirect) { if (!V_.has(o.redirect)) throw new Error("you need to load bundle " + o.redirect + " first"); a = V_.get(o.redirect).config, o = a.getAssetInfo(o.uuid) } if (!o) throw s.recycle(), new Error("Bundle " + n.bundle + " doesn't contain " + n.path); s.config = a, s.uuid = o.uuid, s.info = o } s.ext = n.ext || (null == (t = o) ? void 0 : t.extension) || ".json"; break; case "scene": if (!n.bundle) { var d = V_.find((function (t) { return !!t.getSceneInfo(n.scene) })); n.bundle = d && d.name } if (V_.has(n.bundle)) { if (a = V_.get(n.bundle).config, (o = a.getSceneInfo(n.scene)) && o.redirect) { if (!V_.has(o.redirect)) throw new Error("you need to load bundle " + o.redirect + " first"); a = V_.get(o.redirect).config, o = a.getAssetInfo(o.uuid) } if (!o) throw s.recycle(), new Error("Bundle " + a.name + " doesn't contain scene " + n.scene); s.config = a, s.uuid = o.uuid, s.info = o } break; case "__isNative__": s.isNative = n.__isNative__; break; case "url": s.url = n.url, s.uuid = n.uuid || n.url, s.ext = n.ext || Lo(n.url), s.isNative = void 0 === n.__isNative__ || n.__isNative__; break; default: s.options[h] = n[h] }if (!s) return 1 }; for (var h in n) if (u()) break } if (!s) return 1; if (t.output.push(s), !s.uuid && !s.url) throw new Error("Can not parse this input:" + JSON.stringify(n)) }, r = 0; r < i.length; r++)n(); return null } function NS(t) { for (var e = t.output = t.input, i = function () { var t = e[n]; if (j_.has(t.uuid)) { var i = j_.get(t.uuid), r = V_.find((function (t) { return !!t.getAssetInfo(i) })); if (r) { var s; t.overrideUuid = i; var a = r.config, o = a.getAssetInfo(i); if (o && o.redirect) { if (!V_.has(o.redirect)) throw new Error("Please load bundle " + o.redirect + " first"); o = (a = V_.get(o.redirect).config).getAssetInfo(i) } t.config = a, t.info = o, t.ext = t.isNative ? t.ext : (null == (s = o) ? void 0 : s.extension) || ".json" } else it(16201, i, t.uuid) } }, n = 0; n < e.length; n++)i() } function zS(t) { for (var e = t.output = t.input, i = 0; i < e.length; i++) { var n = e[i]; if (!n.url) { var r, s, a = n.config; s = n.isNative ? a && a.nativeBase ? a.base + a.nativeBase : S.assetManager.generalNativeBase : a && a.importBase ? a.base + a.importBase : S.assetManager.generalImportBase; var o = n.overrideUuid || n.uuid, u = ""; n.info && (u = n.isNative ? n.info.nativeVer ? "." + n.info.nativeVer : "" : n.info.ver ? "." + n.info.ver : ""), r = ".ttf" === n.ext ? s + "/" + o.slice(0, 2) + "/" + o + u + "/" + n.options.__nativeName__ : s + "/" + o.slice(0, 2) + "/" + o + u + n.ext, n.url = r } } return null } var US = Oe.querySettings.bind(Oe), VS = "assets", GS = "asset-missing", HS = t("AssetManager", function () { function t() { this.pipeline = G_.append(OS).append(PS), this.fetchPipeline = H_.append(OS).append(IS), this.transformPipeline = W_.append(kS).append(NS).append(zS), this.bundles = V_, this.assets = N_, this.assetsOverrideMap = j_, this.generalImportBase = "", this.generalNativeBase = "", this.dependUtil = hv, this.force = b, this.allowImageBitmap = !1, this.utils = lg, this.downloader = hS, this.parser = RS, this.packManager = TS, this.cacheAsset = !0, this.cacheManager = null, this.presets = X_, this.factory = xS, this.preprocessPipe = OS, this.fetchPipe = IS, this.loadPipe = PS, this.references = null, this._releaseManager = Ix, this._files = z_, this._parsed = U_, this._parsePipeline = null, this._projectBundles = [], this._eventTarget = new wo } var e = t.prototype; return e.getReleaseManager = function () { return this._releaseManager }, e.onAssetMissing = function (t, e) { this._eventTarget.on(GS, t, e) }, e.offAssetMissing = function (t, e) { this._eventTarget.off(GS, t, e) }, e.dispatchAssetMissing = function (t, e, i, n) { this._eventTarget.emit(GS, t, e, i, n) }, e.init = function (t) { void 0 === t && (t = {}); var e = t.server || US(VS, "server") || "", i = t.bundleVers || US(VS, "bundleVers") || {}, n = t.remoteBundles || US(VS, "remoteBundles") || [], r = t.downloadMaxConcurrency || US(VS, "downloadMaxConcurrency"); r && r > 0 && (this.downloader.maxConcurrency = r), this._files.clear(), this._parsed.clear(), this._releaseManager.init(), this.assets.clear(), this.bundles.clear(), this.packManager.init(), this.downloader.init(e, i, n), this.parser.init(), this.dependUtil.init(); var s = t.importBase || US(VS, "importBase") || ""; s && s.endsWith("/") && (s = s.substring(0, s.length - 1)); var a = t.nativeBase || US(VS, "nativeBase") || ""; a && a.endsWith("/") && (a = a.substring(0, a.length - 1)), this.generalImportBase = s, this.generalNativeBase = a, this._projectBundles = US(VS, "projectBundles") || []; var o = US(VS, "assetsOverrides") || {}; for (var u in o) this.assetsOverrideMap.set(u, o[u]) }, e.getBundle = function (t) { return V_.get(t) || null }, e.removeBundle = function (t) { t._destroy(), V_.remove(t.name) }, e.loadAny = function (t, e, i, n) { var r = Lx(e, i, n), s = r.options, a = r.onProgress, o = r.onComplete; s.preset = s.preset || "default", t = Array.isArray(t) ? t.slice() : t; var u = q_.create({ input: t, onProgress: a, onComplete: Nx(o), options: s }); G_.async(u) }, e.preloadAny = function (t, e, i, n) { var r = Lx(e, i, n), s = r.options, a = r.onProgress, o = r.onComplete; s.preset = s.preset || "preload", t = Array.isArray(t) ? t.slice() : t; var u = q_.create({ input: t, onProgress: a, onComplete: Nx(o), options: s }); H_.async(u) }, e.loadRemote = function (t, e, i) { var n = Lx(e, void 0, i), r = n.options, s = n.onComplete; r.reloadAsset || !this.assets.has(t) ? (r.__isNative__ = !0, r.preset = r.preset || "remote", this.loadAny({ url: t }, r, null, (function (e, i) { e ? (j(e.message, e.stack), s && s(e, i)) : xS.create(t, i, r.ext || Lo(t), r, (function (t, e) { s && s(t, e) })) }))) : Nx(s)(null, this.assets.get(t)) }, e.loadBundle = function (t, e, i) { var n = Lx(e, void 0, i), r = n.options, s = n.onComplete, a = ko(t); this.bundles.has(a) ? Nx(s)(null, this.getBundle(a)) : (r.preset = r.preset || "bundle", r.ext = "bundle", r.__isNative__ = !0, this.loadAny({ url: t }, r, null, (function (e, i) { e ? (j(e.message, e.stack), s && s(e, i)) : xS.create(t, i, "bundle", r, (function (t, e) { s && s(t, e) })) }))) }, e.releaseAsset = function (t) { Ix.tryRelease(t, !0) }, e.releaseUnusedAssets = function () { N_.forEach((function (t) { Ix.tryRelease(t) })) }, e.releaseAll = function () { N_.forEach((function (t) { Ix.tryRelease(t, !0) })) }, e.loadWithJson = function () { throw new Error("Only valid in Editor") }, n(t, [{ key: "files", get: function () { return this._files } }, { key: "main", get: function () { return V_.get("main") || null } }, { key: "resources", get: function () { return V_.get("resources") || null } }], [{ key: "instance", get: function () { return this._instance || (this._instance = new t), this._instance } }]), t }()); HS._instance = void 0, HS.Pipeline = k_, HS.Task = q_, HS.Cache = F_, HS.RequestItem = LS, HS.Bundle = zx, HS.BuiltinBundleName = { INTERNAL: "internal", RESOURCES: "resources", MAIN: "main", START_SCENE: "start-scene" }, HS.CacheManager = function () { this.cacheDir = void 0, this.cacheEnabled = void 0, this.autoClear = void 0, this.cacheInterval = void 0, this.deleteInterval = void 0, this.cachedFiles = void 0 }, HS.Downloader = eS, HS.Parser = DS, HS.DependUtil = ov; var WS = t("assetManager", S.assetManager = HS.instance); S.AssetManager = HS; var jS, XS, qS = t("BuiltinResMgr", function () { function t() { this._resources = {}, this._materialsToBeCompiled = [] } var e = t.prototype; return e.init = function () { for (var t = this._resources, e = new Uint8Array(16), i = new Uint8Array(16), n = new Uint8Array(16), r = new Uint8Array(16), s = new Uint8Array(16), a = 0, o = 0; o < 4; o++)e[a] = 0, e[a + 1] = 0, e[a + 2] = 0, e[a + 3] = 255, i[a] = 0, i[a + 1] = 0, i[a + 2] = 0, i[a + 3] = 0, n[a] = 119, n[a + 1] = 119, n[a + 2] = 119, n[a + 3] = 255, r[a] = 255, r[a + 1] = 255, r[a + 2] = 255, r[a + 3] = 255, s[a] = 127, s[a + 1] = 127, s[a + 2] = 255, s[a + 3] = 255, a += 4; var u = new Uint8Array(1024); a = 0; for (var h = 0; h < 256; h++)u[a] = 221, u[a + 1] = 221, u[a + 2] = 221, u[a + 3] = 255, a += 4; a = 0; for (var c = 0; c < 8; c++) { for (var l = 0; l < 8; l++)u[a] = 85, u[a + 1] = 85, u[a + 2] = 85, u[a + 3] = 255, a += 4; a += 32 } a += 32; for (var f = 0; f < 8; f++) { for (var d = 0; d < 8; d++)u[a] = 85, u[a + 1] = 85, u[a + 2] = 85, u[a + 3] = 255, a += 4; a += 32 } var p = { width: 2, height: 2, _data: e, _compressed: !1, format: 35 }, _ = { width: 2, height: 2, _data: i, _compressed: !1, format: 35 }, g = { width: 2, height: 2, _data: n, _compressed: !1, format: 35 }, m = { width: 2, height: 2, _data: r, _compressed: !1, format: 35 }, v = { width: 2, height: 2, _data: s, _compressed: !1, format: 35 }, y = { width: 16, height: 16, _data: u, _compressed: !1, format: 35 }, b = new Pg(p), w = new bv; w._uuid = "black-texture", w.image = b, t[w._uuid] = w; var x = new Pg(_), T = new bv; T._uuid = "empty-texture", T.image = x, t[T._uuid] = T; var I = new Ny; I._uuid = "black-cube-texture", I.setMipFilter(1), I.image = { front: new Pg(p), back: new Pg(p), left: new Pg(p), right: new Pg(p), top: new Pg(p), bottom: new Pg(p) }, t[I._uuid] = I; var E = new Pg(g), A = new bv; A._uuid = "grey-texture", A.image = E, t[A._uuid] = A; var C = new Ny; C._uuid = "grey-cube-texture", C.setMipFilter(1), C.image = { front: new Pg(g), back: new Pg(g), left: new Pg(g), right: new Pg(g), top: new Pg(g), bottom: new Pg(g) }, t[C._uuid] = C; var D = new Pg(m), R = new bv; R._uuid = "white-texture", R.image = D, t[R._uuid] = R; var P = new Ny; P._uuid = "white-cube-texture", P.setMipFilter(1), P.image = { front: new Pg(m), back: new Pg(m), left: new Pg(m), right: new Pg(m), top: new Pg(m), bottom: new Pg(m) }, t[P._uuid] = P; var B = new Pg(v), M = new bv; M._uuid = "normal-texture", M.image = B, t[M._uuid] = M; var O = new Pg(y), L = new bv; L._uuid = "default-texture", L.image = O, t[L._uuid] = L; var F = new Ny; if (F.setMipFilter(1), F._uuid = "default-cube-texture", F.image = { front: new Pg(y), back: new Pg(y), left: new Pg(y), right: new Pg(y), top: new Pg(y), bottom: new Pg(y) }, t[F._uuid] = F, S.SpriteFrame) { var k = new S.SpriteFrame, N = b, z = new bv; z.image = N, k.texture = z, k._uuid = "default-spriteframe", t[k._uuid] = k } }, e.addAsset = function (t, e) { this._resources[t] = e }, e.get = function (t) { return this._resources[t] }, e.loadBuiltinAssets = function () { var t = this, e = Oe.querySettings("engine", "builtinAssets"); if (!e) return Promise.resolve(); var i = this._resources; return new Promise((function (n, r) { WS.loadBundle("internal", (function (s) { s ? r(s) : WS.loadAny(e, (function (e, s) { e ? r(e) : (s.forEach((function (e) { i[e.name] = e, Ix.addIgnoredAsset(e), e instanceof S.Material && t._materialsToBeCompiled.push(e) })), n()) })) })) })) }, e.compileBuiltinMaterial = function () { for (var t = 0; t < this._materialsToBeCompiled.length; ++t)for (var e = this._materialsToBeCompiled[t], i = 0; i < e.passes.length; ++i)e.passes[i].tryCompile(); this._materialsToBeCompiled.length = 0 }, t }()), YS = t("builtinResMgr", S.builtinResMgr = new qS), KS = t("getPhaseID", (jS = new Map, XS = 0, function (t) { return "number" == typeof t ? t : (jS.has(t) || (jS.set(t, 1 << XS), XS++), jS.get(t)) })), QS = t("InstancedBuffer", function () { function t(t) { this.instances = [], this.hasPendingModels = !1, this.dynamicOffsets = [], this._device = t.device, this.pass = t } var e = t.prototype; return e.destroy = function () { this.instances.forEach((function (t) { t.vb.destroy(), t.ia.destroy() })), this.instances.length = 0 }, e.merge = function (t, e, i) { void 0 === i && (i = null); var n = t.instancedAttributeBlock, r = n.buffer.length; if (r) { var s = t.inputAssembler, a = t.descriptorSet, o = a.getTexture(Jb), u = a.getTexture(sw), h = a.getTexture(hw), c = t.useReflectionProbeType, l = i; l || (l = t.shaders[e]); for (var f = t.descriptorSet, d = 0; d < this.instances.length; ++d) { var p, _, g = this.instances[d]; if (!((null == (p = g.ia.indexBuffer) ? void 0 : p.objectID) !== (null == (_ = s.indexBuffer) ? void 0 : _.objectID) || g.count >= 1024) && g.lightingMap.objectID === o.objectID && g.useReflectionProbeType === c && g.reflectionProbeCubemap.objectID === u.objectID && g.reflectionProbePlanarMap.objectID === h.objectID && g.stride === r) { if (g.count >= g.capacity) { g.capacity <<= 1; var m = g.stride * g.capacity, v = g.data; g.data = new Uint8Array(m), g.data.set(v), g.vb.resize(m) } return g.shader = l, g.descriptorSet = f, g.data.set(n.buffer, g.stride * g.count++), void (this.hasPendingModels = !0) } } for (var y = this._device.createBuffer(new Zd(10, 3, 32 * r, r)), b = new Uint8Array(32 * r), w = s.vertexBuffers.slice(), x = s.attributes.slice(), S = s.indexBuffer, T = 0; T < n.attributes.length; T++) { var I = n.attributes[T], E = new pp(I.name, I.format, I.isNormalized, w.length, !0); x.push(E) } b.set(n.buffer), w.push(y); var A = new gp(x, w, S), C = this._device.createInputAssembler(A); this.instances.push({ count: 1, capacity: 32, vb: y, data: b, ia: C, stride: r, shader: l, descriptorSet: f, lightingMap: o, reflectionProbeCubemap: u, reflectionProbePlanarMap: h, useReflectionProbeType: c, reflectionProbeBlendCubemap: null }), this.hasPendingModels = !0 } }, e.uploadBuffers = function (t) { for (var e = 0; e < this.instances.length; ++e) { var i = this.instances[e]; i.count && (i.ia.instanceCount = i.count, t.updateBuffer(i.vb, i.data)) } }, e.clear = function () { this.instances.forEach((function (t) { t.count = 0 })), this.hasPendingModels = !1 }, t }()), ZS = new Zd(18, 1), JS = new Jd(null), $S = new Dp(null), tT = function () { function t(t) { this._rootBuffer = null, this._buffers = [], this._descriptorSet = null, this._pipelineLayout = null, this._passIndex = 0, this._propertyIndex = 0, this._programName = "", this._dynamics = {}, this._propertyHandleMap = {}, this._rootBlock = null, this._blocksInt = [], this._blocks = [], this._shaderInfo = null, this._defines = {}, this._properties = {}, this._shader = null, this._bs = new g_, this._dss = new p_, this._rs = new d_, this._priority = 128, this._stage = 100, this._phase = KS("default"), this._passID = 4294967295, this._subpassID = 4294967295, this._phaseID = 4294967295, this._primitive = 7, this._batchingScheme = 0, this._dynamicStates = 0, this._instancedBuffers = {}, this._hash = 0, this._rootBufferDirty = !1, this._root = t, this._device = B_.gfxDevice } t.fillPipelineInfo = function (t, e) { void 0 !== e.priority && (t._priority = e.priority), void 0 !== e.primitive && (t._primitive = e.primitive), void 0 !== e.stage && (t._stage = e.stage), void 0 !== e.dynamicStates && (t._dynamicStates = e.dynamicStates), void 0 !== e.phase && (t._phase = KS(e.phase)); var i = t._bs; if (e.blendState) { var n = e.blendState, r = n.targets; r && r.forEach((function (t, e) { i.setTarget(e, t) })), void 0 !== n.isA2C && (i.isA2C = n.isA2C), void 0 !== n.isIndepend && (i.isIndepend = n.isIndepend), void 0 !== n.blendColor && (i.blendColor = n.blendColor) } t._rs.assign(e.rasterizerState), t._dss.assign(e.depthStencilState) }, t.getPassHash = function (t) { var e = ""; if (S.rendering && S.rendering.enableEffectImport) { var i = S.rendering.programLib.getKey(t._phaseID, t.program, t.defines); e = t._phaseID.toString() + "," + i } else e = fx.getKey(t.program, t.defines); var n, r = e + "," + t._primitive + "," + t._dynamicStates; return r += eT(t._bs), r += iT(t._dss), Lf(r += ",rs," + (n = t._rs).cullMode + "," + n.depthBias + "," + n.isFrontFaceCCW, 666) }; var e = t.prototype; return e.initialize = function (t) { this._doInit(t), this.resetUBOs(), this.resetTextures(), this.tryCompile() }, e.getHandle = function (t, e, i) { void 0 === e && (e = 0), void 0 === i && (i = 0); var n = this._propertyHandleMap[t]; return n ? (i ? n = Mw(n, i) : e && (n = Mw(n, Dw(n) - e)), n + e) : 0 }, e.getBinding = function (t) { var e = this.getHandle(t); return e ? Rw(e) : -1 }, e.setUniform = function (t, e) { var i = Rw(t), n = Dw(t), r = Bw(t), s = this._getBlockView(n, i); Lw[n](s, e, r), this._rootBufferDirty = !0 }, e.getUniform = function (t, e) { var i = Rw(t), n = Dw(t), r = Bw(t), s = this._getBlockView(n, i); return Ow[n](s, e, r) }, e.setUniformArray = function (t, e) { for (var i = Rw(t), n = Dw(t), r = Jp(n) >> 2, s = this._getBlockView(n, i), a = Bw(t), o = 0; o < e.length; o++, a += r)null !== e[o] && Lw[n](s, e[o], a); this._rootBufferDirty = !0 }, e.bindTexture = function (t, e, i) { this._descriptorSet.bindTexture(t, e, i || 0) }, e.bindSampler = function (t, e, i) { this._descriptorSet.bindSampler(t, e, i || 0) }, e.setDynamicState = function (t, e) { var i = this._dynamics[t]; i && i.value === e || (i.value = e, i.dirty = !0) }, e.overridePipelineStates = function () { it(12102) }, e.update = function () { this._descriptorSet ? (this._rootBuffer && this._rootBufferDirty && (this._rootBuffer.update(this._rootBlock), this._rootBufferDirty = !1), this._descriptorSet.update()) : rt(12006) }, e.getInstancedBuffer = function (t) { return void 0 === t && (t = 0), this._instancedBuffers[t] || (this._instancedBuffers[t] = new QS(this)) }, e.destroy = function () { for (var t = 0; t < this._shaderInfo.blocks.length; t++) { var e = this._shaderInfo.blocks[t]; this._buffers[e.binding].destroy() } for (var i in this._buffers = [], this._rootBuffer && (this._rootBuffer.destroy(), this._rootBuffer = null), this._instancedBuffers) this._instancedBuffers[i].destroy(); this._descriptorSet.destroy(), this._rs.destroy(), this._dss.destroy(), this._bs.destroy() }, e.resetUniform = function (t) { var e = this.getHandle(t); if (e) { for (var i = Dw(e), n = Rw(e), r = Bw(e), s = Pw(e), a = this._getBlockView(i, n), o = this._properties[t], u = o && o.value || Nw(i), h = (Jp(i) >> 2) * s, c = 0; c + u.length <= h; c += u.length)a.set(u, r + c); this._rootBufferDirty = !0 } }, e.resetTexture = function (t, e) { var i = this.getHandle(t); if (i) { var n, r = Dw(i), s = Rw(i), a = this._properties[t], o = a && a.value, u = (n = "string" == typeof o ? YS.get("" + o + zw(r)) : o || YS.get(Nw(r))) && n.getGFXTexture(), h = a && void 0 !== a.samplerHash ? w_.unpackFromHash(a.samplerHash) : n && n.getSamplerInfo(), c = this._device.getSampler(h); this._descriptorSet.bindSampler(s, c, e || 0), this._descriptorSet.bindTexture(s, u, e || 0) } }, e.resetUBOs = function () { for (var t = 0; t < this._shaderInfo.blocks.length; t++)for (var e = this._shaderInfo.blocks[t], i = 0, n = 0; n < e.members.length; n++) { for (var r = e.members[n], s = this._getBlockView(r.type, e.binding), a = this._properties[r.name], o = a && a.value || Nw(r.type), u = (Jp(r.type) >> 2) * r.count, h = 0; h + o.length <= u; h += o.length)s.set(o, i + h); i += u } this._rootBufferDirty = !0 }, e.resetTextures = function () { var t = this; if (S.rendering) this._shaderInfo.descriptors[1].samplerTextures.forEach((function (e) { for (var i = 0; i < e.count; ++i)t.resetTexture(e.name, i) })); else for (var e = 0; e < this._shaderInfo.samplerTextures.length; e++)for (var i = this._shaderInfo.samplerTextures[e], n = 0; n < i.count; n++)this.resetTexture(i.name, n) }, e.tryCompile = function () { var e = this._root.pipeline; if (!e) return !1; if (this._syncBatchingScheme(), S.rendering && S.rendering.enableEffectImport) { var i = S.rendering.programLib, n = i.getProgramVariant(this._device, this._phaseID, this._programName, this._defines); if (!n) return it(12103, this._programName), !1; this._shader = n.shader, this._pipelineLayout = i.getPipelineLayout(this.device, this._phaseID, this._programName) } else { var r = fx.getGFXShader(this._device, this._programName, this._defines, e); if (!r) return it(12104, this._programName), !1; this._shader = r, this._pipelineLayout = fx.getTemplateInfo(this._programName).pipelineLayout } return this._hash = t.getPassHash(this), !0 }, e.getShaderVariant = function (t) { if (void 0 === t && (t = null), !this._shader && !this.tryCompile()) return it(12105), null; if (!t) return this._shader; for (var e = this._root.pipeline, i = 0; i < t.length; i++) { var n = t[i]; this._defines[n.name] = n.value } this._isBlend && (this._defines.CC_IS_TRANSPARENCY_PASS = 1); var r = null; if (S.rendering && S.rendering.enableEffectImport) { var s = S.rendering.programLib.getProgramVariant(this._device, this._phaseID, this._programName, this._defines); s && (r = s.shader) } else r = fx.getGFXShader(this._device, this._programName, this._defines, e); for (var a = 0; a < t.length; a++) { var o = t[a]; delete this._defines[o.name] } return r }, e.beginChangeStatesSilently = function () { }, e.endChangeStatesSilently = function () { }, e._doInit = function (e, i) { var n; void 0 === i && (i = !1), this._priority = 128, this._stage = 100; var s = null == (n = S.rendering) ? void 0 : n.enableEffectImport; if (s) { var a = S.rendering; if ("number" == typeof e.phase ? (this._passID = e._passID, this._subpassID = e._subpassID, this._phaseID = e._phaseID) : (this._passID = a.getPassID(e.pass), this._passID !== a.INVALID_ID && (e.subpass ? (this._subpassID = a.getSubpassID(this._passID, e.subpass), this._phaseID = a.getPhaseID(this._subpassID, e.phase)) : this._phaseID = a.getPhaseID(this._passID, e.phase))), this._passID === a.INVALID_ID) return void rt(12107, e.program); if (this._phaseID === a.INVALID_ID) return void rt(12108, e.program) } else "number" == typeof e.phase ? this._passID = e._passID : e.pass && "default" !== e.pass && (at(4294967295 === this._passID, 12110), this._passID = 0); this._phase = KS("default"), this._primitive = 7, this._passIndex = e.passIndex, this._propertyIndex = void 0 !== e.propertyIndex ? e.propertyIndex : e.passIndex, this._programName = e.program, this._defines = i ? r({}, e.defines) : e.defines, this._shaderInfo = s ? S.rendering.programLib.getProgramInfo(this._phaseID, this._programName) : fx.getTemplate(e.program), this._properties = e.properties || this._properties; var o = this._device; t.fillPipelineInfo(this, e), e.stateOverrides && t.fillPipelineInfo(this, e.stateOverrides), $S.layout = s ? S.rendering.programLib.getMaterialDescriptorSetLayout(this._device, this._phaseID, e.program) : fx.getDescriptorSetLayout(this._device, e.program), this._descriptorSet = this._device.createDescriptorSet($S); var u, h, c = this._shaderInfo.blocks; if (s) { var l = S.rendering.programLib; u = l.getBlockSizes(this._phaseID, this._programName), h = l.getHandleMap(this._phaseID, this._programName) } else { var f = fx.getTemplateInfo(e.program); u = f.blockSizes, h = f.handleMap } if (s) { var d = S.rendering.programLib.getShaderInfo(this._phaseID, this.program); this._buildMaterialUniformBlocks(o, d.blocks, u) } else this._buildUniformBlocks(o, c, u); var p = this._propertyHandleMap = h, _ = {}; for (var g in this._properties) { var m = this._properties[g]; m.handleInfo && (_[g] = this.getHandle.apply(this, m.handleInfo)) } Object.assign(p, _) }, e._buildUniformBlocks = function (t, e, i) { for (var n = t.capabilities.uboOffsetAlignment, r = [], s = 0, a = 0, o = 0; o < e.length; o++) { var u = i[o]; r.push(a), a += Math.ceil(u / n) * n, s = u } var h = r[r.length - 1] + 16 * Math.ceil(s / 16); h && (ZS.size = 16 * Math.ceil(h / 16), this._rootBuffer = t.createBuffer(ZS), this._rootBlock = new ArrayBuffer(h)); for (var c = 0, l = 0; c < e.length; c++) { var f = e[c].binding, d = i[c]; JS.buffer = this._rootBuffer, JS.offset = r[l++], JS.range = 16 * Math.ceil(d / 16); var p = this._buffers[f] = t.createBuffer(JS); this._blocks[f] = new Float32Array(this._rootBlock, JS.offset, d / 4), this._blocksInt[f] = new Int32Array(this._blocks[f].buffer, this._blocks[f].byteOffset, this._blocks[f].length), this._descriptorSet.bindBuffer(f, p) } }, e._buildMaterialUniformBlocks = function (t, e, i) { for (var n = t.capabilities.uboOffsetAlignment, r = [], s = 0, a = 0, o = 0; o < e.length; o++)if (1 === e[o].set) { var u = i[o]; r.push(a), a += Math.ceil(u / n) * n, s = u } if (0 !== s) { var h = r[r.length - 1] + s; h && (ZS.size = 16 * Math.ceil(h / 16), this._rootBuffer = t.createBuffer(ZS), this._rootBlock = new ArrayBuffer(h)) } for (var c = 0, l = 0; c < e.length; c++)if (1 === e[c].set) { var f = e[c].binding, d = i[c]; JS.buffer = this._rootBuffer, JS.offset = r[l++], JS.range = 16 * Math.ceil(d / 16); var p = this._buffers[f] = t.createBuffer(JS); this._blocks[f] = new Float32Array(this._rootBlock, JS.offset, d / 4), this._blocksInt[f] = new Int32Array(this._blocks[f].buffer, this._blocks[f].byteOffset, this._blocks[f].length), this._descriptorSet.bindBuffer(f, p) } }, e._syncBatchingScheme = function () { this._defines.USE_INSTANCING ? this._device.hasFeature(1) ? this._batchingScheme = 1 : (this._defines.USE_INSTANCING = !1, this._batchingScheme = 0) : this._batchingScheme = 0 }, e._getBlockView = function (t, e) { return t < 13 ? this._blocksInt[e] : this._blocks[e] }, e._initPassFromTarget = function (t, e, i) { this._priority = t.priority, this._stage = t.stage, this._phase = t.phase, this._phaseID = t._phaseID, this._passID = t._passID, this._batchingScheme = t.batchingScheme, this._primitive = t.primitive, this._dynamicStates = t.dynamicStates, this._bs = t.blendState, this._dss = e, this._descriptorSet = t.descriptorSet, this._rs = t.rasterizerState, this._passIndex = t.passIndex, this._propertyIndex = t.propertyIndex, this._programName = t.program, this._defines = t.defines, this._shaderInfo = t._shaderInfo, this._properties = t._properties, this._blocks = t._blocks, this._blocksInt = t._blocksInt, this._dynamics = t._dynamics, this._shader = t._shader, S.rendering && S.rendering.enableEffectImport ? this._pipelineLayout = S.rendering.programLib.getPipelineLayout(this.device, this._phaseID, this._programName) : this._pipelineLayout = fx.getTemplateInfo(this._programName).pipelineLayout, this._hash = t._hash ^ i }, e._updatePassHash = function () { this._hash = t.getPassHash(this) }, e.setRootBufferDirty = function (t) { this._rootBufferDirty = t }, e.setPriority = function (t) { this._priority = t }, n(t, [{ key: "_isBlend", get: function () { return this.blendState.targets.some((function (t) { return t.blend })) } }, { key: "root", get: function () { return this._root } }, { key: "device", get: function () { return this._device } }, { key: "shaderInfo", get: function () { return this._shaderInfo } }, { key: "localSetLayout", get: function () { return S.rendering && S.rendering.enableEffectImport ? S.rendering.programLib.getLocalDescriptorSetLayout(this._device, this._phaseID, this._programName) : fx.getDescriptorSetLayout(this._device, this._programName, !0) } }, { key: "program", get: function () { return this._programName } }, { key: "properties", get: function () { return this._properties } }, { key: "defines", get: function () { return this._defines } }, { key: "passIndex", get: function () { return this._passIndex } }, { key: "propertyIndex", get: function () { return this._propertyIndex } }, { key: "dynamics", get: function () { return this._dynamics } }, { key: "blocks", get: function () { return this._blocks } }, { key: "blocksInt", get: function () { return this._blocksInt } }, { key: "rootBufferDirty", get: function () { return this._rootBufferDirty } }, { key: "priority", get: function () { return this._priority } }, { key: "primitive", get: function () { return this._primitive } }, { key: "stage", get: function () { return this._stage } }, { key: "phase", get: function () { return this._phase } }, { key: "passID", get: function () { return this._passID } }, { key: "phaseID", get: function () { return this._phaseID } }, { key: "rasterizerState", get: function () { return this._rs } }, { key: "depthStencilState", get: function () { return this._dss } }, { key: "blendState", get: function () { return this._bs } }, { key: "dynamicStates", get: function () { return this._dynamicStates } }, { key: "batchingScheme", get: function () { return this._batchingScheme } }, { key: "descriptorSet", get: function () { return this._descriptorSet } }, { key: "hash", get: function () { return this._hash } }, { key: "pipelineLayout", get: function () { return this._pipelineLayout } }]), t }(); function eT(t) { var e = ",bs," + t.isA2C; return t.targets.forEach((function (t) { e += ",bt," + t.blend + "," + t.blendEq + "," + t.blendAlphaEq + "," + t.blendColorMask, e += "," + t.blendSrc + "," + t.blendDst + "," + t.blendSrcAlpha + "," + t.blendDstAlpha })), e } function iT(t) { var e = ",dss," + t.depthTest + "," + t.depthWrite + "," + t.depthFunc; return e += "," + t.stencilTestFront + "," + t.stencilFuncFront + "," + t.stencilRefFront + "," + t.stencilReadMaskFront, e += "," + t.stencilFailOpFront + "," + t.stencilZFailOpFront + "," + t.stencilPassOpFront + "," + t.stencilWriteMaskFront, (e += "," + t.stencilTestBack + "," + t.stencilFuncBack + "," + t.stencilRefBack + "," + t.stencilReadMaskBack) + "," + t.stencilFailOpBack + "," + t.stencilZFailOpBack + "," + t.stencilPassOpBack + "," + t.stencilWriteMaskBack } tT.getTypeFromHandle = Dw, tT.getBindingFromHandle = Rw, tT.getCountFromHandle = Pw, tT.getOffsetFromHandle = Bw; var nT, rT, sT, aT, oT, uT, hT, cT, lT, fT = t("PipelineStateManager", function () { function t() { } return t.getOrCreatePipelineState = function (t, e, i, n, r) { var s = e.hash ^ n.hash ^ r.attributesHash ^ i.typedID, a = this._PSOHashMap.get(s); if (!a) { var o = e.pipelineLayout, u = new Pp(r.attributes), h = new m_(i, o, n, u, e.rasterizerState, e.depthStencilState, e.blendState, e.primitive, e.dynamicStates); a = t.createPipelineState(h), this._PSOHashMap.set(s, a) } return a }, t }()); function dT(t, e) { t.x = e.x * e.x, t.y = e.y * e.y, t.z = e.z * e.z } function pT(t) { for (var e = t.length - 1; e >= 0; --e)if (t[e].window.swapchain) return } fT._PSOHashMap = new Map, new jd, new Nd; var _T = new Pn, gT = t("Material", (nT = Gu("cc.Material"), rT = Ih(px), nT((aT = function (t) { function e(e) { var i; return (i = t.call(this, e) || this)._effectAsset = oT && oT(), i._techIdx = uT && uT(), i._defines = hT && hT(), i._states = cT && cT(), i._props = lT && lT(), i._passes = [], i._hash = 0, i } s(e, t), e.getHash = function (t) { for (var e, i = 0, n = p(t.passes); !(e = n()).done;)i ^= e.value.hash; return i }; var i = e.prototype; return i.initialize = function (t) { this._passes.length ? it(12005) : (this._defines || (this._defines = []), this._states || (this._states = []), this._props || (this._props = []), this._fillInfo(t), this._update()) }, i.reset = function (t) { this.initialize(t) }, i.destroy = function () { return this._doDestroy(), t.prototype.destroy.call(this) }, i.recompileShaders = function () { it(16370, this.name) }, i.overridePipelineStates = function () { it(16371, this.name) }, i.onLoaded = function () { this._update() }, i.resetUniforms = function (t) { void 0 === t && (t = !0), this._props.length = this._passes.length; for (var e = 0; e < this._props.length; e++)this._props[e] = {}; if (t) for (var i, n = p(this._passes); !(i = n()).done;) { var r = i.value; r.resetUBOs(), r.resetTextures() } }, i.setProperty = function (t, e, i) { var n = !1; if (void 0 === i) for (var r = this._passes, s = r.length, a = 0; a < s; a++) { var o = r[a]; this._uploadProperty(o, t, e) && (this._props[o.propertyIndex][t] = e, n = !0) } else { i >= this._passes.length && it(16372, i); var u = this._passes[i]; this._uploadProperty(u, t, e) && (this._props[u.propertyIndex][t] = e, n = !0) } n || it(16373, t) }, i.getProperty = function (t, e) { if (void 0 === e) for (var i = this._props, n = i.length, r = 0; r < n; r++) { var s = i[r]; if (t in s) return s[t] } else { if (e >= this._passes.length) return it(16372, e), null; var a = this._props[this._passes[e].propertyIndex]; if (t in a) return a[t] } return null }, i.copy = function (t, e) { this._techIdx = t._techIdx, this._props.length = t._props.length; for (var i = 0; i < t._props.length; i++)this._props[i] = r({}, t._props[i]); this._defines.length = t._defines.length; for (var n = 0; n < t._defines.length; n++)this._defines[n] = r({}, t._defines[n]); this._states.length = t._states.length; for (var s = 0; s < t._states.length; s++)this._states[s] = r({}, t._states[s]); this._effectAsset = t._effectAsset, e && this._fillInfo(e), this._update() }, i._fillInfo = function (t) { void 0 !== t.technique && (this._techIdx = t.technique), t.effectAsset ? this._effectAsset = t.effectAsset : t.effectName && (this._effectAsset = px.get(t.effectName)), t.defines && this._prepareInfo(t.defines, this._defines), t.states && this._prepareInfo(t.states, this._states) }, i._prepareInfo = function (t, e) { var i = t; if (!Array.isArray(i)) { var n = this._effectAsset ? this._effectAsset.techniques[this._techIdx].passes.length : 1; i = Array(n).fill(i) } for (var r = 0; r < i.length; ++r)Object.assign(e[r] || (e[r] = {}), i[r]) }, i._createPasses = function () { var t = this._effectAsset.techniques[this._techIdx || 0]; if (!t) return []; for (var e = t.passes.length, i = [], n = 0; n < e; ++n) { var r = t.passes[n], s = r.passIndex = n, a = r.defines = this._defines[s] || (this._defines[s] = {}); if (r.stateOverrides = this._states[s] || (this._states[s] = {}), void 0 !== r.propertyIndex && Object.assign(a, this._defines[r.propertyIndex]), void 0 !== r.embeddedMacros && Object.assign(a, r.embeddedMacros), !r.switch || a[r.switch]) { var o = new tT(S.director.root); o.initialize(r), i.push(o) } } return i }, i._update = function (t) { var i = this; if (void 0 === t && (t = !0), this._effectAsset) { this._passes = this._createPasses(); var n = this._effectAsset.techniques[this._techIdx].passes.length; if (this._props.length = n, t) this._passes.forEach((function (t, e) { var n = i._props[e]; for (var r in n || (n = i._props[e] = {}), void 0 !== t.propertyIndex && Object.assign(n, i._props[t.propertyIndex]), n) i._uploadProperty(t, r, n[r]) })); else for (var r = 0; r < this._props.length; r++)this._props[r] = {} } this._hash = e.getHash(this) }, i._uploadProperty = function (t, e, i) { var n = this, r = t.getHandle(e); if (!r) return !1; if (Dw(r) < 26) if (Array.isArray(i)) t.setUniformArray(r, i); else if (null !== i) { var s; if (null != (s = t.properties[e]) && s.linear) { var a = i; dT(_T, a), _T.w = a.w, i = _T } t.setUniform(r, i) } else t.resetUniform(e); else Array.isArray(i) ? i.forEach((function (e, i) { n._bindTexture(t, r, e, i) })) : i ? this._bindTexture(t, r, i) : t.resetTexture(e); return !0 }, i._bindTexture = function (t, e, i, n) { var r = tT.getBindingFromHandle(e); if (i instanceof S_) t.bindTexture(r, i, n); else if (i instanceof Fg) { var s = i.getGFXTexture(); if (!s || !s.width || !s.height) return; t.bindTexture(r, s, n), t.bindSampler(r, i.getGFXSampler(), n) } }, i._doDestroy = function () { if (this._passes && this._passes.length) for (var t, e = p(this._passes); !(t = e()).done;)t.value.destroy(); this._passes.length = 0 }, i.initDefault = function (e) { t.prototype.initDefault.call(this, e), this.initialize({ effectName: "builtin-unlit", defines: { USE_COLOR: !0 }, technique: 0 }), this.setProperty("mainColor", new rr("#ff00ff")) }, i.validate = function () { return !!this._effectAsset && !this._effectAsset.isDefault && this.passes.length > 0 }, n(e, [{ key: "effectAsset", get: function () { return this._effectAsset } }, { key: "effectName", get: function () { return this._effectAsset ? this._effectAsset.name : "" } }, { key: "technique", get: function () { return this._techIdx } }, { key: "passes", get: function () { return this._passes } }, { key: "hash", get: function () { return this._hash } }, { key: "parent", get: function () { return null } }, { key: "owner", get: function () { return null } }]), e }(pg), oT = Bu(aT.prototype, "_effectAsset", [rT], (function () { return null })), uT = Bu(aT.prototype, "_techIdx", [eh], (function () { return 0 })), hT = Bu(aT.prototype, "_defines", [eh], (function () { return [] })), cT = Bu(aT.prototype, "_states", [eh], (function () { return [] })), lT = Bu(aT.prototype, "_props", [eh], (function () { return [] })), sT = aT)) || sT)); S.Material = gT; var mT = Ee({ Low_256x256: 256, Medium_512x512: 512, High_1024x1024: 1024, Ultra_2048x2048: 2048 }), vT = Ee({ Planar: 0, ShadowMap: 1 }), yT = Ee({ HARD: 0, SOFT: 1, SOFT_2X: 2, SOFT_4X: 3 }), bT = Ee({ LEVEL_1: 1, LEVEL_2: 2, LEVEL_3: 3, LEVEL_4: 4 }), wT = Ee({ NONE: 1, RemoveDuplicates: 2, DisableRotationFix: 3 }), xT = vT.ShadowMap + 1, ST = function () { function t() { this.fixedSphere = new Vs(0, 0, 0, .01), this.maxReceived = 4, this._matLight = new Gr, this._material = null, this._instancingMaterial = null, this._enabled = !1, this._type = xT, this._distance = 0, this._planeBias = 1, this._normal = new Kn(0, 1, 0), this._shadowColor = new rr(0, 0, 0, 76), this._size = new as(1024, 1024), this._shadowMapDirty = !1 } var e = t.prototype; return e.getPlanarShader = function (t) { this._material || (this._material = new gT, this._material.initialize({ effectName: "pipeline/planar-shadow" })); var e = this._material.passes; return e.length > 0 ? e[0].getShaderVariant(t) : null }, e.initialize = function (t) { this._enabled = t.enabled, this._type = this.enabled ? t.type : xT, this.normal = t.planeDirection, this.distance = t.planeHeight, this.planeBias = t.planeBias, this.shadowColor = t.shadowColor, this.maxReceived = t.maxReceived, t.shadowMapSize !== this._size.x && (this.size.set(t.shadowMapSize, t.shadowMapSize), this._shadowMapDirty = !0) }, e.activate = function () { if (this._enabled) if (this.type === vT.Planar) this._updatePlanarInfo(); else { var t = S.director.root; t.pipeline.macros.CC_SHADOW_TYPE = 2, t.onGlobalPipelineStateChanged() } else { var e = S.director.root; e.pipeline.macros.CC_SHADOW_TYPE = 0, e.onGlobalPipelineStateChanged() } }, e._updatePlanarInfo = function () { this._material || (this._material = new gT, this._material.initialize({ effectName: "pipeline/planar-shadow" })); var t = S.director.root; t.pipeline.macros.CC_SHADOW_TYPE = 1, t.onGlobalPipelineStateChanged() }, e.destroy = function () { this._material && this._material.destroy(), this._instancingMaterial && this._instancingMaterial.destroy(), this.fixedSphere.destroy() }, n(t, [{ key: "enabled", get: function () { return this._enabled }, set: function (t) { this._enabled = t, this.activate() } }, { key: "type", get: function () { return this._type }, set: function (t) { this._type = this.enabled ? t : xT, this.activate() } }, { key: "normal", get: function () { return this._normal }, set: function (t) { Kn.copy(this._normal, t) } }, { key: "distance", get: function () { return this._distance }, set: function (t) { this._distance = t } }, { key: "planeBias", get: function () { return this._planeBias }, set: function (t) { this._planeBias = t } }, { key: "shadowColor", get: function () { return this._shadowColor }, set: function (t) { this._shadowColor = t } }, { key: "size", get: function () { return this._size }, set: function (t) { this._size.set(t) } }, { key: "shadowMapDirty", get: function () { return this._shadowMapDirty }, set: function (t) { this._shadowMapDirty = t } }, { key: "matLight", get: function () { return this._matLight } }, { key: "material", get: function () { return this._material } }, { key: "instancingMaterial", get: function () { return this._instancingMaterial } }]), t }(); ST.MAX_FAR = 2e3, ST.COEFFICIENT_OF_EXPANSION = 2 * Math.sqrt(3), S.Shadows = ST; var TT = function (t) { function e(e, i) { var n; (n = t.call(this, e.root) || this)._dontNotify = !1, n._parent = e, n._owner = i, n._doInit(n._parent, !0), n._shaderInfo.blocks.forEach((function (t) { var e = n._blocks[t.binding], i = n._parent.blocks[t.binding]; e.set(i) })), n._rootBufferDirty = !0; var r = n._parent, s = n._descriptorSet; return n._shaderInfo.samplerTextures.forEach((function (t) { for (var e = 0; e < t.count; e++) { var i = r._descriptorSet, n = t.binding, a = i.getSampler(n, e), o = i.getTexture(n, e); s.bindSampler(n, a, e), s.bindTexture(n, o, e) } })), t.prototype.tryCompile.call(l(n)), n } s(e, t); var i = e.prototype; return i.overridePipelineStates = function (t, e) { this._bs.reset(), this._rs.reset(), this._dss.reset(), tT.fillPipelineInfo(this, t), tT.fillPipelineInfo(this, e), this._onStateChange() }, i.tryCompile = function (e) { if (e && !Uw(this._defines, e)) return !1; var i = t.prototype.tryCompile.call(this); return this._onStateChange(), i }, i.beginChangeStatesSilently = function () { this._dontNotify = !0 }, i.endChangeStatesSilently = function () { this._dontNotify = !1 }, i._syncBatchingScheme = function () { this._defines.USE_INSTANCING = !1, this._batchingScheme = 0 }, i._onStateChange = function () { this._hash = tT.getPassHash(this), this._owner.onPassStateChange(this._dontNotify) }, n(e, [{ key: "parent", get: function () { return this._parent } }]), e }(tT), IT = function (t) { function e(e) { var i; return (i = t.call(this) || this)._passes = [], i._subModelIdx = 0, i._parent = e.parent, i._owner = e.owner || null, i._subModelIdx = e.subModelIdx || 0, i.copy(i._parent), i } s(e, t); var i = e.prototype; return i.recompileShaders = function (t, e) { this._passes && this.effectAsset && (void 0 === e ? this._passes.forEach((function (e) { e.tryCompile(t) })) : this._passes[e].tryCompile(t)) }, i.overridePipelineStates = function (t, e) { if (this._passes && this.effectAsset) { var i = this.effectAsset.techniques[this.technique].passes; if (void 0 === e) for (var n = 0; n < this._passes.length; n++) { var r = this._passes[n], s = this._states[n] || (this._states[n] = {}); for (var a in t) s[a] = t[a]; r.overridePipelineStates(i[r.passIndex], s) } else { var o = this._states[e] || (this._states[e] = {}); for (var u in t) o[u] = t[u]; this._passes[e].overridePipelineStates(i[e], o) } } }, i.destroy = function () { return this._doDestroy(), !0 }, i.onPassStateChange = function (t) { this._hash = gT.getHash(this), !t && this._owner && this._owner._onRebuildPSO(this._subModelIdx, this) }, i._createPasses = function () { var t = [], e = this._parent.passes; if (!e) return t; for (var i = 0; i < e.length; ++i)t.push(new TT(e[i], this)); return t }, n(e, [{ key: "parent", get: function () { return this._parent } }, { key: "owner", get: function () { return this._owner } }]), e }(gT), ET = null, AT = null, CT = { HEMISPHERE_DIFFUSE: 0, AUTOGEN_HEMISPHERE_DIFFUSE_WITH_REFLECTION: 1, DIFFUSEMAP_WITH_REFLECTION: 2 }; Ee(CT); var DT = function () { function t() { this._envmapLDR = null, this._envmapHDR = null, this._diffuseMapLDR = null, this._diffuseMapHDR = null, this._globalDSManager = null, this._model = null, this._default = null, this._enabled = !1, this._useIBL = !1, this._useHDR = !0, this._useDiffuseMap = !1, this._editableMaterial = null, this._activated = !1, this._reflectionHDR = null, this._reflectionLDR = null, this._rotationAngle = 0 } var e = t.prototype; return e.initialize = function (t) { this._activated = !1, this._enabled = t.enabled, this._useIBL = t.useIBL, this._useDiffuseMap = t.applyDiffuseMap, this._useHDR = t.useHDR }, e.setEnvMaps = function (t, e) { this._envmapHDR = t, this._envmapLDR = e, this._updateGlobalBinding(), this._updatePipeline() }, e.setDiffuseMaps = function (t, e) { this._diffuseMapHDR = t, this._diffuseMapLDR = e, this._updateGlobalBinding(), this._updatePipeline() }, e.setSkyboxMaterial = function (t) { t ? (this._editableMaterial = new IT({ parent: t }), this._editableMaterial.recompileShaders({ USE_RGBE_CUBEMAP: this.isRGBE })) : this._editableMaterial = null, this._updatePipeline() }, e.setReflectionMaps = function (t, e) { this._reflectionHDR = t, this._reflectionLDR = e, this._updateGlobalBinding(), this._updatePipeline() }, e.setRotationAngle = function (t) { this._rotationAngle = t }, e.getRotationAngle = function () { return this._rotationAngle }, e.updateMaterialRenderInfo = function () { this._updateGlobalBinding(), this._updatePipeline() }, e.activate = function () { var t = S.director.root.pipeline; this._globalDSManager = t.globalDSManager, this._default = YS.get("default-cube-texture"), this._model || (this._model = S.director.root.createModel(S.renderer.scene.Model)); var e = this._default.isRGBE; if (this._default.isUsingOfflineMipmaps(), this.envmap && (e = this.envmap.isRGBE, this.envmap.isUsingOfflineMipmaps()), !AT) { var i = new gT; i.initialize({ effectName: "pipeline/skybox", defines: { USE_RGBE_CUBEMAP: e } }), AT = new IT({ parent: i }) } this.enabled && (ET || (ET = S.utils.createMesh(S.primitives.box({ width: 2, height: 2, length: 2 }))), this._editableMaterial ? this._model.initSubModel(0, ET.renderingSubMeshes[0], this._editableMaterial) : this._model.initSubModel(0, ET.renderingSubMeshes[0], AT)), this.envmap || (this.envmap = this._default), this.diffuseMap || (this.diffuseMap = this._default), this._updateGlobalBinding(), this._updatePipeline(), this._activated = !0 }, e._updatePipeline = function () { var t = S.director.root, e = t.pipeline, i = this.useIBL ? this.isRGBE ? 2 : 1 : 0, n = this.useIBL && this.useDiffuseMap && this.diffuseMap && this.diffuseMap !== this._default ? this.isRGBE ? 2 : 1 : 0, r = this.useHDR, s = this.useConvolutionMap; if (e.macros.CC_USE_IBL === i && e.macros.CC_USE_DIFFUSEMAP === n && e.macros.CC_USE_HDR === r && e.macros.CC_IBL_CONVOLUTED === s || (e.macros.CC_USE_IBL = i, e.macros.CC_USE_DIFFUSEMAP = n, e.macros.CC_USE_HDR = r, e.macros.CC_IBL_CONVOLUTED = s, this._activated && t.onGlobalPipelineStateChanged()), this.enabled) { var a = this.envmap ? this.envmap : this._default, o = this._editableMaterial ? this._editableMaterial : AT; o && (o.setProperty("environmentMap", a), o.recompileShaders({ USE_RGBE_CUBEMAP: this.isRGBE })), this._model && (this._model.setSubModelMaterial(0, o), this._updateSubModes()) } }, e._updateGlobalBinding = function () { if (!S.rendering && this._globalDSManager) { var t = B_.gfxDevice; if (this.reflectionMap) { var e = this.reflectionMap.getGFXTexture(), i = t.getSampler(this.reflectionMap.getSamplerInfo()); this._globalDSManager.bindSampler(5, i), this._globalDSManager.bindTexture(5, e) } else { var n = this.envmap ? this.envmap : this._default; if (n) { var r = n.getGFXTexture(), s = t.getSampler(n.getSamplerInfo()); this._globalDSManager.bindSampler(5, s), this._globalDSManager.bindTexture(5, r) } } var a = this.diffuseMap ? this.diffuseMap : this._default; if (a) { var o = a.getGFXTexture(), u = t.getSampler(a.getSamplerInfo()); this._globalDSManager.bindSampler(7, u), this._globalDSManager.bindTexture(7, o) } this._globalDSManager.update() } }, e._updateSubModes = function () { if (this._model) for (var t = this._model.subModels, e = 0; e < t.length; e++)t[e].update() }, n(t, [{ key: "model", get: function () { return this._model } }, { key: "enabled", get: function () { return this._enabled }, set: function (t) { this._enabled = t, t ? this.activate() : this._updatePipeline() } }, { key: "useHDR", get: function () { return this._useHDR }, set: function (t) { this._useHDR = t, this.setEnvMaps(this._envmapHDR, this._envmapLDR) } }, { key: "useIBL", get: function () { return this._useIBL }, set: function (t) { this._useIBL = t, this._updatePipeline() } }, { key: "useDiffuseMap", get: function () { return this._useDiffuseMap }, set: function (t) { this._useDiffuseMap = t, this._updatePipeline() } }, { key: "isRGBE", get: function () { return !!this.envmap && this.envmap.isRGBE } }, { key: "useConvolutionMap", get: function () { return this.reflectionMap ? this.reflectionMap.isUsingOfflineMipmaps() : !!this.envmap && this.envmap.isUsingOfflineMipmaps() } }, { key: "envmap", get: function () { return Uy().isHDR ? this._envmapHDR : this._envmapLDR }, set: function (t) { Uy().isHDR ? this.setEnvMaps(t, this._envmapLDR) : this.setEnvMaps(this._envmapHDR, t) } }, { key: "diffuseMap", get: function () { return Uy().isHDR ? this._diffuseMapHDR : this._diffuseMapLDR }, set: function (t) { Uy().isHDR ? this.setDiffuseMaps(t, this._diffuseMapLDR) : this.setDiffuseMaps(this._diffuseMapHDR, t) } }, { key: "reflectionMap", get: function () { return Uy().isHDR ? this._reflectionHDR : this._reflectionLDR } }, { key: "editableMaterial", get: function () { return this._editableMaterial } }]), t }(); S.Skybox = DT; var RT = new Pn, PT = Ee({ LINEAR: 0, EXP: 1, EXP_SQUARED: 2, LAYERED: 3 }), BT = PT.LAYERED + 1, MT = function () { function t() { this._fogColor = new rr("#C8C8C8"), this._colorArray = new Pn(.2, .2, .2, 1), this._enabled = !1, this._accurate = !1, this._type = 0, this._fogDensity = .3, this._fogStart = .5, this._fogEnd = 300, this._fogAtten = 5, this._fogTop = 1.5, this._fogRange = 1.2, this._activated = !1 } var e = t.prototype; return e.initialize = function (t) { this._activated = !1, this.fogColor = t.fogColor, this._enabled = t.enabled, this._type = this.enabled ? t.type : BT, this._accurate = t.accurate, this.fogDensity = t.fogDensity, this.fogStart = t.fogStart, this.fogEnd = t.fogEnd, this.fogAtten = t.fogAtten, this.fogTop = t.fogTop, this.fogRange = t.fogRange }, e.activate = function () { this._updatePipeline(), this._activated = !0 }, e._updatePipeline = function () { var t = S.director.root, e = this.enabled ? this.type : BT, i = this.accurate ? 1 : 0, n = t.pipeline; n.macros.CC_USE_FOG === e && n.macros.CC_USE_ACCURATE_FOG === i || (n.macros.CC_USE_FOG = e, n.macros.CC_USE_ACCURATE_FOG = i, this._activated && t.onGlobalPipelineStateChanged()) }, n(t, [{ key: "enabled", get: function () { return this._enabled }, set: function (t) { this._enabled = t, t ? this.activate() : (this._type = BT, this._updatePipeline()) } }, { key: "accurate", get: function () { return this._accurate }, set: function (t) { this._accurate = t, this._updatePipeline() } }, { key: "fogColor", get: function () { return this._fogColor }, set: function (t) { this._fogColor.set(t), RT.set(t.x, t.y, t.z, t.w), dT(this._colorArray, RT) } }, { key: "type", get: function () { return this._type }, set: function (t) { this._type = this.enabled ? t : BT, this.enabled && this._updatePipeline() } }, { key: "fogDensity", get: function () { return this._fogDensity }, set: function (t) { this._fogDensity = t } }, { key: "fogStart", get: function () { return this._fogStart }, set: function (t) { this._fogStart = t } }, { key: "fogEnd", get: function () { return this._fogEnd }, set: function (t) { this._fogEnd = t } }, { key: "fogAtten", get: function () { return this._fogAtten }, set: function (t) { this._fogAtten = t } }, { key: "fogTop", get: function () { return this._fogTop }, set: function (t) { this._fogTop = t } }, { key: "fogRange", get: function () { return this._fogRange }, set: function (t) { this._fogRange = t } }, { key: "colorArray", get: function () { return this._colorArray } }]), t }(); S.Fog = MT; var OT, LT, FT, kT, NT, zT, UT, VT, GT, HT, WT, jT, XT, qT, YT, KT, QT, ZT, JT, $T, tI, eI, iI, nI, rI, sI, aI, oI, uI, hI, cI, lI, fI, dI, pI, _I, gI, mI, vI, yI, bI, wI, xI, SI, TI, II, EI, AI, CI, DI, RI, PI, BI, MI, OI, LI, FI, kI, NI, zI, UI, VI, GI, HI, WI, jI, XI, qI, YI, KI, QI, ZI, JI, $I, tE, eE, iE, nE, rE, sE, aE, oE, uE, hE, cE, lE, fE, dE, pE, _E, gE, mE, vE, yE, bE, wE, xE, SE, TE, IE, EE, AE, CE, DE, RE, PE, BE, ME, OE, LE, FE, kE, NE, zE, UE, VE, GE, HE, WE, jE, XE, qE, YE, KE, QE, ZE, JE, $E, tA, eA, iA = Ee({ DEFAULT: 0, LINEAR: 1 }), nA = function () { function t() { this._toneMappingType = iA.DEFAULT, this._activated = !1 } var e = t.prototype; return e.initialize = function (t) { this._toneMappingType = t.toneMappingType }, e.activate = function () { this._updatePipeline(), this._activated = !0 }, e._updatePipeline = function () { var t = S.director.root; t.pipeline.macros.CC_TONE_MAPPING_TYPE = this._toneMappingType, this._activated && t.onGlobalPipelineStateChanged() }, n(t, [{ key: "toneMappingType", get: function () { return this._toneMappingType }, set: function (t) { this._toneMappingType = t, this._updatePipeline() } }]), t }(), rA = new Kn(0, 1, 0), sA = new Kn, aA = new Pn, oA = new rr, uA = new Er, hA = function (t) { var e = 1 / Math.max(Math.max(Math.max(t.x, t.y), t.z), 1e-4); e < 1 && (t.x *= e, t.y *= e, t.z *= e) }, cA = t("AmbientInfo", (OT = Gu("cc.AmbientInfo"), LT = Ih(si), FT = ih("_skyColor"), kT = ih("_skyIllum"), NT = ih("_groundAlbedo"), OT((UT = function () { function t() { this._skyColorHDR = VT && VT(), this._skyIllumHDR = GT && GT(), this._groundAlbedoHDR = HT && HT(), this._skyColorLDR = WT && WT(), this._skyIllumLDR = jT && jT(), this._groundAlbedoLDR = XT && XT(), this._resource = null } return t.prototype.activate = function (t) { this._resource = t, t.initialize(this) }, n(t, [{ key: "skyColorHDR", get: function () { return this._skyColorHDR } }, { key: "groundAlbedoHDR", get: function () { return this._groundAlbedoHDR } }, { key: "skyIllumHDR", get: function () { return this._skyIllumHDR } }, { key: "skyColorLDR", get: function () { return this._skyColorLDR } }, { key: "groundAlbedoLDR", get: function () { return this._groundAlbedoLDR } }, { key: "skyIllumLDR", get: function () { return this._skyIllumLDR } }, { key: "skyLightingColor", get: function () { var t = Uy().isHDR; return aA.set(t ? this._skyColorHDR : this._skyColorLDR), hA(aA), oA.set(255 * aA.x, 255 * aA.y, 255 * aA.z, 255) }, set: function (t) { aA.set(t.x, t.y, t.z, t.w), Uy().isHDR ? this._skyColorHDR.set(aA) : this._skyColorLDR.set(aA), this._resource && this._resource.skyColor.set(aA) } }, { key: "skyColor", set: function (t) { Uy().isHDR ? this._skyColorHDR.set(t) : this._skyColorLDR.set(t), this._resource && this._resource.skyColor.set(t) } }, { key: "skyIllum", get: function () { return Uy().isHDR ? this._skyIllumHDR : this._skyIllumLDR }, set: function (t) { Uy().isHDR ? this._skyIllumHDR = t : this._skyIllumLDR = t, this._resource && (this._resource.skyIllum = t) } }, { key: "groundLightingColor", get: function () { var t = Uy().isHDR; return aA.set(t ? this._groundAlbedoHDR : this._groundAlbedoLDR), hA(aA), oA.set(255 * aA.x, 255 * aA.y, 255 * aA.z, 255) }, set: function (t) { aA.set(t.x, t.y, t.z, t.w), Uy().isHDR ? this._groundAlbedoHDR.set(aA) : this._groundAlbedoLDR.set(aA), this._resource && this._resource.groundAlbedo.set(aA) } }, { key: "groundAlbedo", set: function (t) { Uy().isHDR ? this._groundAlbedoHDR.set(t) : this._groundAlbedoLDR.set(t), this._resource && this._resource.groundAlbedo.set(t) } }]), t }(), m(UT.prototype, "skyIllum", [LT], Object.getOwnPropertyDescriptor(UT.prototype, "skyIllum"), UT.prototype), VT = Bu(UT.prototype, "_skyColorHDR", [eh, FT], (function () { return new Pn(.2, .5, .8, 1) })), GT = Bu(UT.prototype, "_skyIllumHDR", [eh, kT], (function () { return eb.SKY_ILLUM })), HT = Bu(UT.prototype, "_groundAlbedoHDR", [eh, NT], (function () { return new Pn(.2, .2, .2, 1) })), WT = Bu(UT.prototype, "_skyColorLDR", [eh], (function () { return new Pn(.2, .5, .8, 1) })), jT = Bu(UT.prototype, "_skyIllumLDR", [eh], (function () { return eb.SKY_ILLUM })), XT = Bu(UT.prototype, "_groundAlbedoLDR", [eh], (function () { return new Pn(.2, .2, .2, 1) })), zT = UT)) || zT)); T.AmbientInfo = cA; var lA = t("SkyboxInfo", (qT = Gu("cc.SkyboxInfo"), YT = Ih(CT), KT = Ih(Ny), QT = Ih(si), ZT = Ih(Ny), JT = Ih(Ny), $T = Ih(gT), tI = Ih(Ny), eI = ih("_envmap"), iI = Ih(Ny), nI = Ih(Ny), rI = Ih(Ny), sI = Ih(gT), aI = Ih(Ny), oI = Ih(Ny), qT((hI = function () { function t() { this._envLightingType = cI && cI(), this._envmapHDR = lI && lI(), this._envmapLDR = fI && fI(), this._diffuseMapHDR = dI && dI(), this._diffuseMapLDR = pI && pI(), this._enabled = _I && _I(), this._useHDR = gI && gI(), this._editableMaterial = mI && mI(), this._reflectionHDR = vI && vI(), this._reflectionLDR = yI && yI(), this._rotationAngle = bI && bI(), this._resource = null } var e = t.prototype; return e.activate = function (t) { this.envLightingType = this._envLightingType, this._resource = t, t.initialize(this), t.setEnvMaps(this._envmapHDR, this._envmapLDR), t.setDiffuseMaps(this._diffuseMapHDR, this._diffuseMapLDR), t.setSkyboxMaterial(this._editableMaterial), t.setReflectionMaps(this._reflectionHDR, this._reflectionLDR), t.setRotationAngle(this._rotationAngle), t.activate() }, e.updateEnvMap = function (t) { t || (this.applyDiffuseMap = !1, this.useIBL = !1, this.envLightingType = 0, it(15001)); var e = this._resource; e && (e.setEnvMaps(this._envmapHDR, this._envmapLDR), e.setDiffuseMaps(this._diffuseMapHDR, this._diffuseMapLDR), e.setReflectionMaps(this._reflectionHDR, this._reflectionLDR), e.useDiffuseMap = this.applyDiffuseMap, e.envmap = t) }, e.setMaterialProperty = function (t, e, i) { var n = this._resource; if (n) { var r = n.editableMaterial; n.enabled && r && (r.setProperty(t, e, i), r.passes.forEach((function (t) { t.update() }))) } }, n(t, [{ key: "applyDiffuseMap", get: function () { return 2 === this._envLightingType }, set: function (t) { this._resource && (this._resource.useDiffuseMap = t) } }, { key: "enabled", get: function () { return this._enabled }, set: function (t) { this._enabled !== t && (this._enabled = t, this._resource && (this._resource.enabled = this._enabled)) } }, { key: "envLightingType", get: function () { return this._envLightingType }, set: function (t) { this.envmap || 0 === t ? (0 === t ? (this.useIBL = !1, this.applyDiffuseMap = !1) : 1 === t ? (this.useIBL = !0, this.applyDiffuseMap = !1) : 2 === t && (this.useIBL = !0, this.applyDiffuseMap = !0), this._envLightingType = t) : (this.useIBL = !1, this.applyDiffuseMap = !1, this._envLightingType = 0, it(15001)) } }, { key: "useIBL", get: function () { return 0 !== this._envLightingType }, set: function (t) { this._resource && (this._resource.useIBL = t) } }, { key: "useHDR", get: function () { return Uy().isHDR = this._useHDR, this._useHDR }, set: function (t) { Uy().isHDR = t, this._useHDR = t; var e = this._resource; e && 2 === this.envLightingType && (null === this.diffuseMap ? (this.envLightingType = 1, it(15e3)) : this.diffuseMap.isDefault && it(15002)), e && (e.useHDR = this._useHDR, e.updateMaterialRenderInfo()) } }, { key: "envmap", get: function () { return Uy().isHDR ? this._envmapHDR : this._envmapLDR }, set: function (t) { var e = Uy().isHDR; e ? (this._envmapHDR = t, this._reflectionHDR = null) : (this._envmapLDR = t, this._reflectionLDR = null), t || (e ? this._diffuseMapHDR = null : this._diffuseMapLDR = null, this.applyDiffuseMap = !1, this.useIBL = !1, this.envLightingType = 0, it(15001)); var i = this._resource; i && (i.setEnvMaps(this._envmapHDR, this._envmapLDR), i.setDiffuseMaps(this._diffuseMapHDR, this._diffuseMapLDR), i.setReflectionMaps(this._reflectionHDR, this._reflectionLDR), i.useDiffuseMap = this.applyDiffuseMap, i.envmap = t) } }, { key: "rotationAngle", get: function () { return this._rotationAngle }, set: function (t) { this._rotationAngle = t, this._resource && this._resource.setRotationAngle(this._rotationAngle) } }, { key: "diffuseMap", get: function () { return Uy().isHDR ? this._diffuseMapHDR : this._diffuseMapLDR }, set: function (t) { Uy().isHDR ? this._diffuseMapHDR = t : this._diffuseMapLDR = t, this._resource && this._resource.setDiffuseMaps(this._diffuseMapHDR, this._diffuseMapLDR) } }, { key: "reflectionMap", get: function () { return Uy().isHDR ? this._reflectionHDR : this._reflectionLDR }, set: function (t) { Uy().isHDR ? this._reflectionHDR = t : this._reflectionLDR = t, this._resource && this._resource.setReflectionMaps(this._reflectionHDR, this._reflectionLDR) } }, { key: "skyboxMaterial", get: function () { return this._editableMaterial }, set: function (t) { this._editableMaterial = t, this._resource && this._resource.setSkyboxMaterial(this._editableMaterial) } }]), t }(), m(hI.prototype, "envLightingType", [YT], Object.getOwnPropertyDescriptor(hI.prototype, "envLightingType"), hI.prototype), m(hI.prototype, "envmap", [KT], Object.getOwnPropertyDescriptor(hI.prototype, "envmap"), hI.prototype), m(hI.prototype, "rotationAngle", [QT], Object.getOwnPropertyDescriptor(hI.prototype, "rotationAngle"), hI.prototype), m(hI.prototype, "diffuseMap", [ZT], Object.getOwnPropertyDescriptor(hI.prototype, "diffuseMap"), hI.prototype), m(hI.prototype, "reflectionMap", [JT], Object.getOwnPropertyDescriptor(hI.prototype, "reflectionMap"), hI.prototype), m(hI.prototype, "skyboxMaterial", [$T], Object.getOwnPropertyDescriptor(hI.prototype, "skyboxMaterial"), hI.prototype), cI = Bu(hI.prototype, "_envLightingType", [eh], (function () { return 0 })), lI = Bu(hI.prototype, "_envmapHDR", [eh, tI, eI], (function () { return null })), fI = Bu(hI.prototype, "_envmapLDR", [eh, iI], (function () { return null })), dI = Bu(hI.prototype, "_diffuseMapHDR", [eh, nI], (function () { return null })), pI = Bu(hI.prototype, "_diffuseMapLDR", [eh, rI], (function () { return null })), _I = Bu(hI.prototype, "_enabled", [eh], (function () { return !1 })), gI = Bu(hI.prototype, "_useHDR", [eh], (function () { return !0 })), mI = Bu(hI.prototype, "_editableMaterial", [eh, sI], (function () { return null })), vI = Bu(hI.prototype, "_reflectionHDR", [eh, aI], (function () { return null })), yI = Bu(hI.prototype, "_reflectionLDR", [eh, oI], (function () { return null })), bI = Bu(hI.prototype, "_rotationAngle", [eh], (function () { return 0 })), uI = hI)) || uI)); T.SkyboxInfo = lA; var fA = t("FogInfo", (wI = Gu("cc.FogInfo"), xI = Ih(PT), SI = Ih(si), TI = Ih(si), II = Ih(si), EI = Ih(si), AI = Ih(si), CI = Ih(si), wI((VI = function () { function t() { this._type = PI && PI(), this._fogColor = BI && BI(), this._enabled = MI && MI(), this._fogDensity = OI && OI(), this._fogStart = LI && LI(), this._fogEnd = FI && FI(), this._fogAtten = kI && kI(), this._fogTop = NI && NI(), this._fogRange = zI && zI(), this._accurate = UI && UI(), this._resource = null } return t.prototype.activate = function (t) { this._resource = t, t.initialize(this), t.activate() }, n(t, [{ key: "enabled", get: function () { return this._enabled }, set: function (t) { if (this._enabled !== t) { this._enabled = t; var e = this._resource; e && (e.enabled = t, t && (e.type = this._type)) } } }, { key: "accurate", get: function () { return this._accurate }, set: function (t) { if (this._accurate !== t) { this._accurate = t; var e = this._resource; e && (e.accurate = t, t && (e.type = this._type)) } } }, { key: "fogColor", get: function () { return this._fogColor }, set: function (t) { this._fogColor.set(t), this._resource && (this._resource.fogColor = this._fogColor) } }, { key: "type", get: function () { return this._type }, set: function (t) { this._type = t, this._resource && (this._resource.type = t) } }, { key: "fogDensity", get: function () { return this._fogDensity }, set: function (t) { this._fogDensity = t, this._resource && (this._resource.fogDensity = t) } }, { key: "fogStart", get: function () { return this._fogStart }, set: function (t) { this._fogStart = t, this._resource && (this._resource.fogStart = t) } }, { key: "fogEnd", get: function () { return this._fogEnd }, set: function (t) { this._fogEnd = t, this._resource && (this._resource.fogEnd = t) } }, { key: "fogAtten", get: function () { return this._fogAtten }, set: function (t) { this._fogAtten = t, this._resource && (this._resource.fogAtten = t) } }, { key: "fogTop", get: function () { return this._fogTop }, set: function (t) { this._fogTop = t, this._resource && (this._resource.fogTop = t) } }, { key: "fogRange", get: function () { return this._fogRange }, set: function (t) { this._fogRange = t, this._resource && (this._resource.fogRange = t) } }]), t }(), VI.FogType = PT, m((RI = VI).prototype, "type", [xI], Object.getOwnPropertyDescriptor(RI.prototype, "type"), RI.prototype), m(RI.prototype, "fogDensity", [SI], Object.getOwnPropertyDescriptor(RI.prototype, "fogDensity"), RI.prototype), m(RI.prototype, "fogStart", [TI], Object.getOwnPropertyDescriptor(RI.prototype, "fogStart"), RI.prototype), m(RI.prototype, "fogEnd", [II], Object.getOwnPropertyDescriptor(RI.prototype, "fogEnd"), RI.prototype), m(RI.prototype, "fogAtten", [EI], Object.getOwnPropertyDescriptor(RI.prototype, "fogAtten"), RI.prototype), m(RI.prototype, "fogTop", [AI], Object.getOwnPropertyDescriptor(RI.prototype, "fogTop"), RI.prototype), m(RI.prototype, "fogRange", [CI], Object.getOwnPropertyDescriptor(RI.prototype, "fogRange"), RI.prototype), PI = Bu(RI.prototype, "_type", [eh], (function () { return PT.LINEAR })), BI = Bu(RI.prototype, "_fogColor", [eh], (function () { return new rr("#C8C8C8") })), MI = Bu(RI.prototype, "_enabled", [eh], (function () { return !1 })), OI = Bu(RI.prototype, "_fogDensity", [eh], (function () { return .3 })), LI = Bu(RI.prototype, "_fogStart", [eh], (function () { return .5 })), FI = Bu(RI.prototype, "_fogEnd", [eh], (function () { return 300 })), kI = Bu(RI.prototype, "_fogAtten", [eh], (function () { return 5 })), NI = Bu(RI.prototype, "_fogTop", [eh], (function () { return 1.5 })), zI = Bu(RI.prototype, "_fogRange", [eh], (function () { return 1.2 })), UI = Bu(RI.prototype, "_accurate", [eh], (function () { return !1 })), DI = RI)) || DI)), dA = t("ShadowsInfo", (GI = Gu("cc.ShadowsInfo"), HI = Ih(vT), WI = Ih(si), jI = Ih(si), XI = Ih(ri), qI = Ih(mT), GI((KI = function () { function t() { this._enabled = QI && QI(), this._type = ZI && ZI(), this._normal = JI && JI(), this._distance = $I && $I(), this._planeBias = tE && tE(), this._shadowColor = eE && eE(), this._maxReceived = iE && iE(), this._size = nE && nE(), this._resource = null } var e = t.prototype; return e.setPlaneFromNode = function (t) { t.getWorldRotation(uA), this.planeDirection = Kn.transformQuat(sA, rA, uA), t.getWorldPosition(sA), this.planeHeight = Kn.dot(this._normal, sA) }, e.activate = function (t) { this._resource = t, t.initialize(this), t.activate() }, n(t, [{ key: "enabled", get: function () { return this._enabled }, set: function (t) { if (this._enabled !== t) { this._enabled = t; var e = this._resource; e && (e.enabled = t, t && (e.type = this._type)) } } }, { key: "type", get: function () { return this._type }, set: function (t) { this._type = t, this._resource && (this._resource.type = t) } }, { key: "shadowColor", get: function () { return this._shadowColor }, set: function (t) { this._shadowColor.set(t), this._resource && (this._resource.shadowColor = t) } }, { key: "planeDirection", get: function () { return this._normal }, set: function (t) { Kn.copy(this._normal, t), this._resource && (this._resource.normal = t) } }, { key: "planeHeight", get: function () { return this._distance }, set: function (t) { this._distance = t, this._resource && (this._resource.distance = t) } }, { key: "planeBias", get: function () { return this._planeBias }, set: function (t) { this._planeBias = t, this._resource && (this._resource.planeBias = t) } }, { key: "maxReceived", get: function () { return this._maxReceived }, set: function (t) { this._maxReceived = t, this._resource && (this._resource.maxReceived = t) } }, { key: "shadowMapSize", get: function () { return this._size.x }, set: function (t) { var e = this._resource; this._size.set(t, t), e && (e.size.set(t, t), e.shadowMapDirty = !0) } }]), t }(), m(KI.prototype, "type", [HI], Object.getOwnPropertyDescriptor(KI.prototype, "type"), KI.prototype), m(KI.prototype, "planeHeight", [WI], Object.getOwnPropertyDescriptor(KI.prototype, "planeHeight"), KI.prototype), m(KI.prototype, "planeBias", [jI], Object.getOwnPropertyDescriptor(KI.prototype, "planeBias"), KI.prototype), m(KI.prototype, "maxReceived", [XI], Object.getOwnPropertyDescriptor(KI.prototype, "maxReceived"), KI.prototype), m(KI.prototype, "shadowMapSize", [qI], Object.getOwnPropertyDescriptor(KI.prototype, "shadowMapSize"), KI.prototype), QI = Bu(KI.prototype, "_enabled", [eh], (function () { return !1 })), ZI = Bu(KI.prototype, "_type", [eh], (function () { return vT.Planar })), JI = Bu(KI.prototype, "_normal", [eh], (function () { return new Kn(0, 1, 0) })), $I = Bu(KI.prototype, "_distance", [eh], (function () { return 0 })), tE = Bu(KI.prototype, "_planeBias", [eh], (function () { return 1 })), eE = Bu(KI.prototype, "_shadowColor", [eh], (function () { return new rr(0, 0, 0, 76) })), iE = Bu(KI.prototype, "_maxReceived", [eh], (function () { return 4 })), nE = Bu(KI.prototype, "_size", [eh], (function () { return new as(1024, 1024) })), YI = KI)) || YI)); T.ShadowsInfo = dA; var pA = t("DEFAULT_WORLD_MIN_POS", new Kn(-1024, -1024, -1024)), _A = t("DEFAULT_WORLD_MAX_POS", new Kn(1024, 1024, 1024)), gA = t("DEFAULT_OCTREE_DEPTH", 8), mA = t("OctreeInfo", (rE = Gu("cc.OctreeInfo"), sE = Ih(ri), rE((oE = function () { function t() { this._enabled = uE && uE(), this._minPos = hE && hE(), this._maxPos = cE && cE(), this._depth = lE && lE(), this._resource = null } return t.prototype.activate = function (t) { this._resource = t, t.initialize(this) }, n(t, [{ key: "enabled", get: function () { return this._enabled }, set: function (t) { this._enabled !== t && (this._enabled = t, this._resource && (this._resource.enabled = t)) } }, { key: "minPos", get: function () { return this._minPos }, set: function (t) { this._minPos = t, this._resource && (this._resource.minPos = t) } }, { key: "maxPos", get: function () { return this._maxPos }, set: function (t) { this._maxPos = t, this._resource && (this._resource.maxPos = t) } }, { key: "depth", get: function () { return this._depth }, set: function (t) { this._depth = t, this._resource && (this._resource.depth = t) } }]), t }(), m(oE.prototype, "depth", [sE], Object.getOwnPropertyDescriptor(oE.prototype, "depth"), oE.prototype), uE = Bu(oE.prototype, "_enabled", [eh], (function () { return !1 })), hE = Bu(oE.prototype, "_minPos", [eh], (function () { return new Kn(pA) })), cE = Bu(oE.prototype, "_maxPos", [eh], (function () { return new Kn(_A) })), lE = Bu(oE.prototype, "_depth", [eh], (function () { return gA })), aE = oE)) || aE)); T.OctreeInfo = mA; var vA = t("SkinInfo", (fE = Gu("cc.SkinInfo"), dE = Ih(si), pE = Ih(si), fE((gE = function () { function t() { this._enabled = mE && mE(), this._blurRadius = vE && vE(), this._sssIntensity = yE && yE(), this._resource = null } return t.prototype.activate = function (t) { this._resource = t, t.initialize(this) }, n(t, [{ key: "enabled", get: function () { return this._enabled }, set: function (t) { this._enabled !== t && (this._enabled = t, this._resource && (this._resource.enabled = t)) } }, { key: "blurRadius", get: function () { return this._blurRadius }, set: function (t) { this._blurRadius = t, this._resource && (this._resource.blurRadius = t) } }, { key: "sssIntensity", get: function () { return this._sssIntensity }, set: function (t) { this._sssIntensity = t, this._resource && (this._resource.sssIntensity = t) } }]), t }(), m(gE.prototype, "blurRadius", [dE], Object.getOwnPropertyDescriptor(gE.prototype, "blurRadius"), gE.prototype), m(gE.prototype, "sssIntensity", [pE], Object.getOwnPropertyDescriptor(gE.prototype, "sssIntensity"), gE.prototype), mE = Bu(gE.prototype, "_enabled", [eh], (function () { return !0 })), vE = Bu(gE.prototype, "_blurRadius", [eh], (function () { return .01 })), yE = Bu(gE.prototype, "_sssIntensity", [eh], (function () { return 3 })), _E = gE)) || _E)); T.SkinInfo = vA; var yA = t("PostSettingsInfo", (bE = Gu("cc.PostSettingsInfo"), wE = Ih(iA), bE((SE = function () { function t() { this._toneMappingType = TE && TE(), this._resource = null } return t.prototype.activate = function (t) { this._resource = t, t.initialize(this), t.activate() }, n(t, [{ key: "toneMappingType", get: function () { return this._toneMappingType }, set: function (t) { this._toneMappingType = t, this._resource && (this._resource.toneMappingType = t) } }]), t }(), m(SE.prototype, "toneMappingType", [wE], Object.getOwnPropertyDescriptor(SE.prototype, "toneMappingType"), SE.prototype), TE = Bu(SE.prototype, "_toneMappingType", [eh], (function () { return iA.DEFAULT })), xE = SE)) || xE)); T.PostSettingsInfo = yA; var bA, wA, xA, SA, TA, IA, EA, AA, CA, DA, RA, PA, BA, MA, OA, LA, FA, kA, NA, zA, UA, VA, GA, HA, WA, jA, XA, qA, YA, KA, QA, ZA, JA, $A, tC, eC, iC, nC, rC, sC, aC, oC, uC, hC, cC, lC, fC, dC, pC, _C, gC, mC, vC, yC, bC, wC, xC, SC, TC, IC, EC, AC, CC, DC, RC, PC, BC, MC, OC, LC = t("LightProbeInfo", (IE = Gu("cc.LightProbeInfo"), EE = Ih(si), AE = Ih(ri), CE = Ih(ri), DE = Ih(si), RE = Ih(si), IE((BE = function () { function t() { this._giScale = ME && ME(), this._giSamples = OE && OE(), this._bounces = LE && LE(), this._reduceRinging = FE && FE(), this._showProbe = kE && kE(), this._showWireframe = NE && NE(), this._showConvex = zE && zE(), this._data = UE && UE(), this._lightProbeSphereVolume = VE && VE(), this._nodes = [], this._scene = null, this._resource = null } var e = t.prototype; return e.activate = function (t, e) { this._scene = t, this._resource = e, e.initialize(this) }, e.onProbeBakeFinished = function () { this.onProbeBakingChanged(this._scene) }, e.onProbeBakeCleared = function () { this.clearSHCoefficients(), this.onProbeBakingChanged(this._scene) }, e.onProbeBakingChanged = function (t) { var e = this; t && (t.emit("light-probe-baking-changed"), t.children.forEach((function (t) { e.onProbeBakingChanged(t) }))) }, e.clearSHCoefficients = function () { this._data && (this._data.probes.forEach((function (t) { t.coefficients.length = 0 })), this.clearAllSHUBOs()) }, e.isUniqueNode = function () { return 1 === this._nodes.length }, e.addNode = function (t) { if (!t) return !1; for (var e = 0; e < this._nodes.length; e++)if (this._nodes[e].node === t) return !1; return this._nodes.push({ node: t, probes: null }), !0 }, e.removeNode = function (t) { if (!t) return !1; var e = this._nodes.findIndex((function (e) { return e.node === t })); return -1 !== e && (this._nodes.splice(e, 1), !0) }, e.syncData = function (t, e) { for (var i = 0; i < this._nodes.length; i++)if (this._nodes[i].node === t) return void (this._nodes[i].probes = e) }, e.update = function (t) { if (void 0 === t && (t = !0), S.internal.LightProbesData) { this._data || (this._data = new S.internal.LightProbesData, this._resource && (this._resource.data = this._data)); for (var e = [], i = 0; i < this._nodes.length; i++) { var n = this._nodes[i], r = n.node, s = n.probes, a = r.worldPosition; if (s) for (var o = 0; o < s.length; o++) { var u = Qn(); Kn.add(u, s[o], a), e.push(u) } } if (e.length < 4) return this.resetAllTetraIndices(), void this._data.reset(); this._data.updateProbes(e), t && (this.resetAllTetraIndices(), this._data.updateTetrahedrons()) } }, e.clearAllSHUBOs = function () { if (this._scene) { var t = this._scene.renderScene; t && t.models.forEach((function (t) { t.clearSHUBOs() })) } }, e.resetAllTetraIndices = function () { if (this._scene) { var t = this._scene.renderScene; t && t.models.forEach((function (t) { t.tetrahedronIndex = -1 })) } }, n(t, [{ key: "giScale", get: function () { return this._giScale }, set: function (t) { this._giScale !== t && (this._giScale = t, this._resource && (this._resource.giScale = t)) } }, { key: "giSamples", get: function () { return this._giSamples }, set: function (t) { this._giSamples !== t && (this._giSamples = t, this._resource && (this._resource.giSamples = t)) } }, { key: "bounces", get: function () { return this._bounces }, set: function (t) { this._bounces !== t && (this._bounces = t, this._resource && (this._resource.bounces = t)) } }, { key: "reduceRinging", get: function () { return this._reduceRinging }, set: function (t) { this._reduceRinging !== t && (this._reduceRinging = t, this._resource && (this._resource.reduceRinging = t)) } }, { key: "showProbe", get: function () { return this._showProbe }, set: function (t) { this._showProbe !== t && (this._showProbe = t, this._resource && (this._resource.showProbe = t)) } }, { key: "showWireframe", get: function () { return this._showWireframe }, set: function (t) { this._showWireframe !== t && (this._showWireframe = t, this._resource && (this._resource.showWireframe = t)) } }, { key: "showConvex", get: function () { return this._showConvex }, set: function (t) { this._showConvex !== t && (this._showConvex = t, this._resource && (this._resource.showConvex = t)) } }, { key: "data", get: function () { return this._data }, set: function (t) { this._data !== t && (this._data = t, this._resource && (this._resource.data = t)) } }, { key: "lightProbeSphereVolume", get: function () { return this._lightProbeSphereVolume }, set: function (t) { this._lightProbeSphereVolume !== t && (this._lightProbeSphereVolume = t, this._resource && (this._resource.lightProbeSphereVolume = t)) } }]), t }(), m(BE.prototype, "giScale", [EE], Object.getOwnPropertyDescriptor(BE.prototype, "giScale"), BE.prototype), m(BE.prototype, "giSamples", [AE], Object.getOwnPropertyDescriptor(BE.prototype, "giSamples"), BE.prototype), m(BE.prototype, "bounces", [CE], Object.getOwnPropertyDescriptor(BE.prototype, "bounces"), BE.prototype), m(BE.prototype, "reduceRinging", [DE], Object.getOwnPropertyDescriptor(BE.prototype, "reduceRinging"), BE.prototype), m(BE.prototype, "lightProbeSphereVolume", [RE], Object.getOwnPropertyDescriptor(BE.prototype, "lightProbeSphereVolume"), BE.prototype), ME = Bu(BE.prototype, "_giScale", [eh], (function () { return 1 })), OE = Bu(BE.prototype, "_giSamples", [eh], (function () { return 1024 })), LE = Bu(BE.prototype, "_bounces", [eh], (function () { return 2 })), FE = Bu(BE.prototype, "_reduceRinging", [eh], (function () { return 0 })), kE = Bu(BE.prototype, "_showProbe", [eh], (function () { return !0 })), NE = Bu(BE.prototype, "_showWireframe", [eh], (function () { return !0 })), zE = Bu(BE.prototype, "_showConvex", [eh], (function () { return !1 })), UE = Bu(BE.prototype, "_data", [eh], (function () { return null })), VE = Bu(BE.prototype, "_lightProbeSphereVolume", [eh], (function () { return 1 })), PE = BE)) || PE)), FC = t("SceneGlobals", (GE = Gu("cc.SceneGlobals"), HE = Ih(lA), GE((jE = function () { function t() { this.ambient = XE && XE(), this.shadows = qE && qE(), this._skybox = YE && YE(), this.fog = KE && KE(), this.octree = QE && QE(), this.skin = ZE && ZE(), this.lightProbeInfo = JE && JE(), this.postSettings = $E && $E(), this.bakedWithStationaryMainLight = tA && tA(), this.bakedWithHighpLightmap = eA && eA(), this.disableLightmap = !1 } return t.prototype.activate = function (t) { var e = T.director.root.pipeline.pipelineSceneData; this.skybox.activate(e.skybox), this.ambient.activate(e.ambient), this.shadows.activate(e.shadows), this.fog.activate(e.fog), this.octree.activate(e.octree), this.skin.activate(e.skin), this.postSettings.activate(e.postSettings), this.lightProbeInfo && e.lightProbes && this.lightProbeInfo.activate(t, e.lightProbes), T.director.root.onGlobalPipelineStateChanged() }, n(t, [{ key: "skybox", get: function () { return this._skybox }, set: function (t) { this._skybox = t } }]), t }(), XE = Bu(jE.prototype, "ambient", [eh], (function () { return new cA })), qE = Bu(jE.prototype, "shadows", [eh], (function () { return new dA })), YE = Bu(jE.prototype, "_skybox", [eh], (function () { return new lA })), KE = Bu(jE.prototype, "fog", [eh], (function () { return new fA })), m(jE.prototype, "skybox", [HE], Object.getOwnPropertyDescriptor(jE.prototype, "skybox"), jE.prototype), QE = Bu(jE.prototype, "octree", [eh], (function () { return new mA })), ZE = Bu(jE.prototype, "skin", [eh], (function () { return new vA })), JE = Bu(jE.prototype, "lightProbeInfo", [eh], (function () { return new LC })), $E = Bu(jE.prototype, "postSettings", [eh], (function () { return new yA })), tA = Bu(jE.prototype, "bakedWithStationaryMainLight", [eh], (function () { return !1 })), eA = Bu(jE.prototype, "bakedWithHighpLightmap", [eh], (function () { return !1 })), WE = jE)) || WE)); T.SceneGlobals = FC; var kC = (bA = Gu("cc.TargetInfo"), wA = Ih([oi]), bA((SA = function () { this.localID = TA && TA() }, TA = Bu(SA.prototype, "localID", [eh, wA], (function () { return [] })), xA = SA)) || xA), NC = (IA = Gu("cc.TargetOverrideInfo"), EA = Ih(oo), AA = Ih(kC), CA = Ih([oi]), DA = Ih(ky), RA = Ih(kC), IA((BA = function () { this.source = MA && MA(), this.sourceInfo = OA && OA(), this.propertyPath = LA && LA(), this.target = FA && FA(), this.targetInfo = kA && kA() }, MA = Bu(BA.prototype, "source", [eh, EA], (function () { return null })), OA = Bu(BA.prototype, "sourceInfo", [eh, AA], (function () { return null })), LA = Bu(BA.prototype, "propertyPath", [eh, CA], (function () { return [] })), FA = Bu(BA.prototype, "target", [eh, DA], (function () { return null })), kA = Bu(BA.prototype, "targetInfo", [eh, RA], (function () { return null })), PA = BA)) || PA), zC = Gu("cc.CompPrefabInfo")((zA = function () { this.fileId = UA && UA() }, UA = Bu(zA.prototype, "fileId", [eh], (function () { return "" })), NA = zA)) || NA, UC = (VA = Gu("CCPropertyOverrideInfo"), GA = Ih(kC), HA = Ih([oi]), VA((jA = function () { function t() { this.targetInfo = XA && XA(), this.propertyPath = qA && qA(), this.value = YA && YA() } return t.prototype.isTarget = function () { }, t }(), XA = Bu(jA.prototype, "targetInfo", [eh, GA], (function () { return null })), qA = Bu(jA.prototype, "propertyPath", [eh, HA], (function () { return [] })), YA = Bu(jA.prototype, "value", [eh], null), WA = jA)) || WA), VC = (KA = Gu("cc.MountedChildrenInfo"), QA = Ih(kC), ZA = Ih([ky]), KA(($A = function () { function t() { this.targetInfo = tC && tC(), this.nodes = eC && eC() } return t.prototype.isTarget = function () { }, t }(), tC = Bu($A.prototype, "targetInfo", [eh, QA], (function () { return null })), eC = Bu($A.prototype, "nodes", [eh, ZA], (function () { return [] })), JA = $A)) || JA), GC = (iC = Gu("cc.MountedComponentsInfo"), nC = Ih(kC), rC = Ih([am]), iC((aC = function () { function t() { this.targetInfo = oC && oC(), this.components = uC && uC() } return t.prototype.isTarget = function () { }, t }(), oC = Bu(aC.prototype, "targetInfo", [eh, nC], (function () { return null })), uC = Bu(aC.prototype, "components", [eh, rC], (function () { return [] })), sC = aC)) || sC), HC = (hC = Gu("cc.PrefabInstance"), cC = Ih(ky), lC = Ih([VC]), fC = Ih([GC]), dC = Ih([UC]), pC = Ih([kC]), hC((gC = function () { function t() { this.fileId = mC && mC(), this.prefabRootNode = vC && vC(), this.mountedChildren = yC && yC(), this.mountedComponents = bC && bC(), this.propertyOverrides = wC && wC(), this.removedComponents = xC && xC(), this.targetMap = {}, this.expanded = !1 } var e = t.prototype; return e.findPropertyOverride = function () { }, e.removePropertyOverride = function () { }, t }(), mC = Bu(gC.prototype, "fileId", [eh], (function () { return "" })), vC = Bu(gC.prototype, "prefabRootNode", [eh, cC], null), yC = Bu(gC.prototype, "mountedChildren", [eh, lC], (function () { return [] })), bC = Bu(gC.prototype, "mountedComponents", [eh, fC], (function () { return [] })), wC = Bu(gC.prototype, "propertyOverrides", [eh, dC], (function () { return [] })), xC = Bu(gC.prototype, "removedComponents", [eh, pC], (function () { return [] })), _C = gC)) || _C), WC = (SC = Gu("cc.PrefabInfo"), TC = Ih(ky), IC = Ih(HC), EC = Ih([NC]), SC((CC = function () { this.root = DC && DC(), this.asset = RC && RC(), this.fileId = PC && PC(), this.instance = BC && BC(), this.targetOverrides = MC && MC(), this.nestedPrefabInstanceRoots = OC && OC() }, DC = Bu(CC.prototype, "root", [eh, TC], null), RC = Bu(CC.prototype, "asset", [eh], null), PC = Bu(CC.prototype, "fileId", [eh], (function () { return "" })), BC = Bu(CC.prototype, "instance", [eh, IC], null), MC = Bu(CC.prototype, "targetOverrides", [eh, EC], null), OC = Bu(CC.prototype, "nestedPrefabInstanceRoots", [eh], null), AC = CC)) || AC); function jC(t) { var e = null == t ? void 0 : t.prefab; if (e && e.instance) { if (!e.asset) return rt(3701, t.name), void (e.instance = void 0); var i = t._objFlags, n = t.getParent(), r = t.uuid; t[no], S.game._isCloning = !0, e.asset._doInstantiate(t), S.game._isCloning = !1, t._objFlags = i, t.modifyParent(n), t.id = r, t.prefab && (t.prefab.instance = e.instance) } } function XC(t, e, i) { var n; if (e && t) { var r = e, s = null == (n = t.prefab) ? void 0 : n.instance; !i && s && (e[s.fileId] = {}, r = e[s.fileId]); var a = t.prefab; a && (r[a.fileId] = t), t.components.forEach((function (t) { t.__prefab && (r[t.__prefab.fileId] = t) })), t.children.forEach((function (t) { XC(t, r, !1) })) } } function qC(t, e) { if (!t) return null; for (var i = e, n = 0; n < t.length; n++) { if (!i) return null; i = i[t[n]] } return i } function YC(t, e, i) { if (e) for (var n = 0; n < e.length; n++) { var r = e[n]; if (r && r.targetInfo) { var s = qC(r.targetInfo.localID, i); if (!s) continue; var a = i, o = r.targetInfo.localID; if (o.length > 0) for (var u = 0; u < o.length - 1; u++)a = a[o[u]]; if (r.nodes) for (var h = 0; h < r.nodes.length; h++) { var c = r.nodes[h]; c && !s.children.includes(c) && (s.children.push(c), c.modifyParent(s), XC(c, a, !1), c.siblingIndex = s.children.length - 1, $C(c, !0)) } } } } function KC(t, e, i) { if (e) for (var n = 0; n < e.length; n++) { var r = e[n]; if (r && r.targetInfo) { var s = qC(r.targetInfo.localID, i); if (!s) continue; if (r.components) for (var a = 0; a < r.components.length; a++) { var o = r.components[a]; o && (o.node = s, s.getWritableComponents().push(o)) } } } } function QC(t, e, i) { if (e) for (var n = 0; n < e.length; n++) { var r = e[n]; if (r) { var s = qC(r.localID, i); if (!s || !s.node) continue; var a = s.node.components.indexOf(s); a >= 0 && s.node.getWritableComponents().splice(a, 1) } } } function ZC(t, e, i) { if (!(e.length <= 0)) for (var n = null, r = 0; r < e.length; r++) { var s = e[r]; if (s && s.targetInfo) { if (!(n = qC(s.targetInfo.localID, i))) continue; var a = n, o = s.propertyPath.slice(); if (o.length > 0) { var u = o.pop(); if (!u) continue; for (var h = 0; h < o.length && (a = a[o[h]]); h++); if (!a) continue; if (Array.isArray(a)) if ("length" === u) a[u] = s.value; else { var c = Number.parseInt(u); Number.isInteger(c) && c < a.length && (a[u] = s.value) } else a[u] instanceof Re ? a[u].set(s.value) : a[u] = s.value } } } } function JC(t) { var e, i = null == (e = t.prefab) ? void 0 : e.targetOverrides; if (i) for (var n = 0; n < i.length; n++) { var r, s = i[n], a = s.source, o = s.sourceInfo; if (o) { var u, h = s.source, c = null == h || null == (u = h.prefab) ? void 0 : u.instance; c && c.targetMap && (a = qC(o.localID, c.targetMap)) } if (a) { var l, f = s.targetInfo; if (f) { var d = s.target, p = null == d || null == (r = d.prefab) ? void 0 : r.instance; if (p && p.targetMap && (l = qC(f.localID, p.targetMap))) { var _ = s.propertyPath.slice(), g = a; if (_.length > 0) { var m = _.pop(); if (!m) return; for (var v = 0; v < _.length && (g = g[_[v]]); v++); if (!g) continue; g[m] = l } } } } } } function $C(t, e) { var i; void 0 === e && (e = !1); var n = null == t || null == (i = t.prefab) ? void 0 : i.instance; if (n && !n.expanded) { jC(t), e && t && t.children && t.children.forEach((function (t) { $C(t, !0) })); var r = {}; n.targetMap = r, XC(t, r, !0), YC(0, n.mountedChildren, r), QC(0, n.removedComponents, r), KC(0, n.mountedComponents, r), ZC(0, n.propertyOverrides, r), n.expanded = !0 } else e && t && t.children && t.children.forEach((function (t) { $C(t, !0) })) } function tD(t) { var e = t.prefab; e && e.nestedPrefabInstanceRoots && e.nestedPrefabInstanceRoots.forEach((function (t) { $C(t) })) } S._PrefabInfo = WC; var eD, iD, nD, rD, sD, aD, oD, uD = Object.freeze({ __proto__: null, CompPrefabInfo: zC, MountedChildrenInfo: VC, MountedComponentsInfo: GC, PrefabInfo: WC, PrefabInstance: HC, PropertyOverrideInfo: UC, TargetInfo: kC, TargetOverrideInfo: NC, applyMountedChildren: YC, applyMountedComponents: KC, applyNodeAndComponentId: function t(e, i) { for (var n = e.components, r = e.children, s = 0; s < n.length; s++) { var a, o, u = n[s], h = null !== (a = null == (o = u.__prefab) ? void 0 : o.fileId) && void 0 !== a ? a : ""; u._id = "" + i + h } for (var c = 0; c < r.length; c++) { var l = r[c], f = l.prefab, d = null != f && f.instance ? f.instance.fileId : null == f ? void 0 : f.fileId; d && (l.id = "" + i + d, null != f && f.instance || t(l, i)) } }, applyPropertyOverrides: ZC, applyRemovedComponents: QC, applyTargetOverrides: JC, createNodeWithPrefab: jC, expandNestedPrefabInstanceNode: tD, expandPrefabInstanceNode: $C, generateTargetMap: XC, getTarget: qC }), hD = t("Scene", Gu("cc.Scene")((iD = function (t) { s(i, t); var e = i.prototype; function i(e) { var i; return (i = t.call(this, e) || this).autoReleaseAssets = nD && nD(), i._globals = rD && rD(), i.dependAssets = null, i._renderScene = null, i._prefabSyncedInLiveReload = !1, i._activeInHierarchy = !1, T.director && T.director.root && (i._renderScene = T.director.root.createScene({})), i._inited = !T.game || !T.game._isCloning, i } return e._updateScene = function () { this._scene = this }, e.destroy = function () { var t = oo.prototype.destroy.call(this); if (t) for (var e = this._children, i = 0; i < e.length; ++i)e[i].active = !1; return this._renderScene && T.director.root.destroyScene(this._renderScene), this._active = !1, this._activeInHierarchy = !1, t }, e.addComponent = function () { throw new Error(ut(3822)) }, e._onHierarchyChanged = function () { }, e._onPostActivated = function () { }, e._onBatchCreated = function (t) { for (var e = this._children.length, i = 0; i < e; ++i)this._children[i]._siblingIndex = i, this._children[i]._onBatchCreated(t) }, e.updateWorldTransform = function () { }, e._instantiate = function () { return null }, e._load = function () { this._inited || (tD(this), JC(this), this._onBatchCreated(y), this._inited = !0), this.walk(ky._setScene) }, e._activate = function (t) { void 0 === t && (t = !0), T.director._nodeActivator.activateNode(this, t), this._globals.activate(this) }, n(i, [{ key: "renderScene", get: function () { return this._renderScene } }, { key: "globals", get: function () { return this._globals } }]), i }(ky), nD = Bu(iD.prototype, "autoReleaseAssets", [eh], (function () { return !1 })), rD = Bu(iD.prototype, "_globals", [eh], (function () { return new FC })), eD = iD)) || eD); T.Scene = hD; var cD = t("SceneAsset", Gu("cc.SceneAsset")((aD = function (t) { function e(e) { var i; return (i = t.call(this, e) || this).scene = oD && oD(), i } s(e, t); var i = e.prototype; return i.initDefault = function (e) { t.prototype.initDefault.call(this, e), this.scene = new hD("New Scene") }, i.validate = function () { return !!this.scene }, e }(pg), oD = Bu(aD.prototype, "scene", [eh], (function () { return null })), sD = aD)) || sD); S.SceneAsset = cD, St({ SystemEventType: { newName: "Input.EventType", since: "3.3.0", removed: !1 } }), St({ SystemEvent: { newName: "Input", since: "3.4.0", removed: !1 }, systemEvent: { newName: "input", since: "3.4.0", removed: !1 } }); var lD = function () { function t() { this._intervalInMileSeconds = 200, this._accelTimer = 0, this._eventTarget = new wo, this._globalEventClass = window.DeviceMotionEvent || window.DeviceOrientationEvent, Ro.browserType === xo.MOBILE_QQ && (this._globalEventClass = window.DeviceOrientationEvent), this._deviceEventName = this._globalEventClass === window.DeviceMotionEvent ? "devicemotion" : "deviceorientation", this._didAccelerateFunc = this._didAccelerate.bind(this) } var e = t.prototype; return e._registerEvent = function () { this._accelTimer = performance.now(), window.addEventListener(this._deviceEventName, this._didAccelerateFunc, !1) }, e._unregisterEvent = function () { this._accelTimer = 0, window.removeEventListener(this._deviceEventName, this._didAccelerateFunc, !1) }, e._didAccelerate = function (t) { var e = performance.now(); if (!(e - this._accelTimer < this._intervalInMileSeconds)) { this._accelTimer = e; var i = 0, n = 0, r = 0; if (this._globalEventClass === window.DeviceMotionEvent) { var s = t.accelerationIncludingGravity; i = .1 * ((null == s ? void 0 : s.x) || 0), n = .1 * ((null == s ? void 0 : s.y) || 0), r = .1 * ((null == s ? void 0 : s.z) || 0) } else { var a = t; i = (a.gamma || 0) / 90 * .981, n = -(a.beta || 0) / 90 * .981, r = (a.alpha || 0) / 90 * .981 } if (Zo.isFrameRotated) { var o = i; i = -n, n = o } var u = i; 90 === window.orientation ? (i = -n, n = u) : -90 === window.orientation ? (i = n, n = -u) : 180 === window.orientation && (i = -i, n = -n), Ro.os === Io.ANDROID && Ro.browserType !== xo.MOBILE_QQ && (i = -i, n = -n); var h = performance.now(), c = new Uv(i, n, r, h), l = new Bv(c); this._eventTarget.emit("devicemotion", l) } }, e.start = function () { var t = this; window.DeviceMotionEvent && "function" == typeof DeviceMotionEvent.requestPermission ? DeviceMotionEvent.requestPermission().then((function (e) { "granted" === e && t._registerEvent() })).catch((function (t) { W(t) })) : this._registerEvent() }, e.stop = function () { this._unregisterEvent() }, e.setInterval = function (t) { this._intervalInMileSeconds = t }, e.on = function (t, e, i) { this._eventTarget.on(t, e, i) }, t }(), fD = function () { }, dD = function (t) { function e() { return t.apply(this, arguments) || this } return s(e, t), e.prototype.getValue = function () { throw new Error("Method not implemented.") }, e }(fD), pD = function (t) { function e() { return t.apply(this, arguments) || this } return s(e, t), e.prototype.getValue = function () { throw new Error("Method not implemented.") }, e }(fD), _D = function (t) { function e() { return t.apply(this, arguments) || this } return s(e, t), e.prototype.getValue = function () { throw new Error("Method not implemented.") }, e }(fD), gD = function (t) { function e() { return t.apply(this, arguments) || this } return s(e, t), e.prototype.getValue = function () { throw new Error("Method not implemented.") }, e }(fD), mD = function (t) { function e(e) { var i; return (i = t.call(this) || this).positive = e.positive, i.negative = e.negative, i } return s(e, t), e.prototype.getValue = function () { var t = this.positive.getValue(), e = this.negative.getValue(); return Math.abs(t) > Math.abs(e) ? t : -e }, e }(dD), vD = function (t) { function e(e) { var i; return (i = t.call(this) || this).up = e.up, i.down = e.down, i.left = e.left, i.right = e.right, i.xAxis = new mD({ positive: i.right, negative: i.left }), i.yAxis = new mD({ positive: i.up, negative: i.down }), i } return s(e, t), e.prototype.getValue = function () { return new as(this.xAxis.getValue(), this.yAxis.getValue()) }, e }(pD); !function (t) { function e(e) { var i; return (i = t.call(this) || this).up = e.up, i.down = e.down, i.left = e.left, i.right = e.right, i.forward = e.forward, i.backward = e.backward, i.xAxis = new mD({ positive: i.right, negative: i.left }), i.yAxis = new mD({ positive: i.up, negative: i.down }), i.zAxis = new mD({ positive: i.forward, negative: i.backward }), i } s(e, t), e.prototype.getValue = function () { return new Kn(this.xAxis.getValue(), this.yAxis.getValue(), this.zAxis.getValue()) } }(_D); var yD, bD = function (t) { function e() { return t.apply(this, arguments) || this } return s(e, t), e.prototype.getValue = function () { return t.prototype.getValue.call(this) }, e }(dD), wD = function (t) { function e() { return t.apply(this, arguments) || this } return s(e, t), e }(vD), xD = function (t) { function e() { return t.apply(this, arguments) || this } return s(e, t), e }(vD), SD = function (t) { function e() { return t.apply(this, arguments) || this } return s(e, t), e.prototype.getValue = function () { return t.prototype.getValue.call(this) }, e }(gD), TD = function (t) { function e() { return t.apply(this, arguments) || this } return s(e, t), e.prototype.getValue = function () { return t.prototype.getValue.call(this) }, e }(_D), ID = function (t) { function e() { return t.apply(this, arguments) || this } return s(e, t), e.prototype.getValue = function () { return t.prototype.getValue.call(this) }, e }(dD), ED = "left", AD = "right", CD = []; !function (t) { t[t.HAND_LEFT = 1] = "HAND_LEFT", t[t.HAND_RIGHT = 4] = "HAND_RIGHT", t[t.AIM_LEFT = 2] = "AIM_LEFT", t[t.AIM_RIGHT = 5] = "AIM_RIGHT" }(yD || (yD = {})); var DD, RD, PD, BD, MD, OD = function () { function t(t) { var e; this._deviceId = -1, this._connected = !1, this._webPoseState = ((e = {})[yD.HAND_LEFT] = { position: Kn.ZERO, orientation: Er.IDENTITY }, e[yD.HAND_RIGHT] = { position: Kn.ZERO, orientation: Er.IDENTITY }, e[yD.AIM_LEFT] = { position: Kn.ZERO, orientation: Er.IDENTITY }, e[yD.AIM_RIGHT] = { position: Kn.ZERO, orientation: Er.IDENTITY }, e), this._deviceId = t, this._initInputSource() } t._init = function () { Ro.hasFeature(Ao.EVENT_GAMEPAD) && t._registerEvent() }, t._on = function (e, i, n) { t._eventTarget.on(e, i, n) }, t._removeInputDevice = function (e) { var i = t.all.findIndex((function (t) { return t.deviceId === e })); -1 !== i && ge(t.all, i) }, t._getOrCreateInputDevice = function (e, i) { var n = t.all.find((function (t) { return t.deviceId === e })); return n || (n = new t(e), t.all.push(n)), n._connected = i, n }, t._ensureDirectorDefined = function (e) { t._intervalId = setInterval((function () { T.director && T.Director && (clearInterval(t._intervalId), t._intervalId = -1, e()) }), 50) }, t._updateGamepadCnt = function () { for (var e = 0, i = 0, n = t._cachedWebGamepads.length; i < n; i++)t._cachedWebGamepads[i] && e++; t._totalGamepadCnt = e }, t._registerEvent = function () { t._ensureDirectorDefined((function () { t._cachedWebGamepads = t._getWebGamePads(), t._updateGamepadCnt(), T.director.on(T.Director.EVENT_BEGIN_FRAME, t._scanGamepads) })), window.addEventListener("gamepadconnected", (function (e) { t._cachedWebGamepads[e.gamepad.index] = e.gamepad, t._updateGamepadCnt(); var i = t._getOrCreateInputDevice(e.gamepad.index, !0); t._eventTarget.emit("gamepad-change", new kv("gamepad-change", i)) })), window.addEventListener("gamepaddisconnected", (function (e) { t._cachedWebGamepads[e.gamepad.index] = null, t._updateGamepadCnt(); var i = t._getOrCreateInputDevice(e.gamepad.index, !1); t._removeInputDevice(e.gamepad.index), t._eventTarget.emit("gamepad-change", new kv("gamepad-change", i)) })) }, t._scanWebGamepads = function (e) { if (0 !== t._totalGamepadCnt) { var i = t._getWebGamePads(); if (i) { for (var n = 0; n < i.length; ++n) { var r = i[n]; if (r) { var s = t._cachedWebGamepads[r.index]; if (s) { for (var a = void 0, o = s.buttons, u = 0; u < o.length; ++u) { var h = o[u], c = r.buttons[u]; if (Math.abs(h.value - c.value) > .01) { a = t._getOrCreateInputDevice(r.index, !0); break } } if (a) { e.push(a); continue } for (var l = s.axes, f = 0; f < l.length; ++f) { var d = l[f], p = r.axes[f]; if (Math.abs(d - p) > .01) { a = t._getOrCreateInputDevice(r.index, !0); break } } if (a) { e.push(a); continue } } } } t._cachedWebGamepads = i } } }, t._scanGamepads = function () { CD.length = 0, t._scanWebGamepads(CD), t._scanWebXRGamepads(CD); for (var e = 0; e < CD.length; ++e) { var i = CD[e]; t._eventTarget.emit("gamepad-input", new kv("gamepad-input", i)) } t._scanWebXRGamepadsPose() }, t._scanWebXRGamepads = function () { }, t.checkGamepadChanged = function (t, e) { if (!t && !e) return !1; if (!t || !e) return !0; for (var i = e.buttons, n = 0; n < i.length; ++n) { var r = i[n]; if (0 !== t.buttons[n].value || 0 !== r) return !0 } for (var s = e.axes, a = 0; a < s.length; ++a) { var o = s[a]; if (0 !== t.axes[a] || 0 !== o) return !0 } return !1 }, t._copyCacheGamepadValue = function (t) { if (t) { for (var e = { buttons: new Array(t.buttons.length), axes: new Array(t.axes.length) }, i = 0; i < t.buttons.length; ++i)e.buttons[i] = t.buttons[i].value; for (var n = 0; n < t.axes.length; ++n)e.axes[n] = t.axes[n]; return e } }, t._scanWebXRGamepadsPose = function () { }, t._getWebXRGamepadMap = function () { var t; return null == (t = globalThis.__globalXR) ? void 0 : t.webxrGamepadMap }, t._getWebGamePads = function () { return "function" == typeof navigator.getGamepads ? navigator.getGamepads() : "function" == typeof navigator.webkitGetGamepads ? navigator.webkitGetGamepads() : [] }, t._getWebGamepad = function (e) { for (var i = t._getWebGamePads(), n = 0; n < i.length; ++n) { var r = i[n]; if (r && r.index === e) return r } }; var e = t.prototype; return e._axisToButtons = function (t) { var e = Math.abs(t); return t > 0 ? { negative: 0, positive: e } : t < 0 ? { negative: e, positive: 0 } : { negative: 0, positive: 0 } }, e._updateWebPoseState = function (t) { t.code !== yD.HAND_LEFT && t.code !== yD.AIM_LEFT && t.code !== yD.HAND_RIGHT && t.code !== yD.AIM_RIGHT || (this._webPoseState[t.code] = { position: new Kn(t.position.x, t.position.y, t.position.z), orientation: new Er(t.orientation.x, t.orientation.y, t.orientation.z, t.orientation.w) }) }, e._initInputSource = function () { var e = this; this._buttonNorth = new bD, this._buttonNorth.getValue = function () { if (-1 === e.deviceId) { var i, n = null == (i = t._getWebXRGamepadMap()) ? void 0 : i.get(ED); return n && n.buttons.length > 5 ? n.buttons[5].value : 0 } var r = t._getWebGamepad(e.deviceId); return r ? r.buttons[3].value : 0 }, this._buttonEast = new bD, this._buttonEast.getValue = function () { if (-1 === e.deviceId) { var i, n = null == (i = t._getWebXRGamepadMap()) ? void 0 : i.get(AD); return n && n.buttons.length > 5 ? n.buttons[5].value : 0 } var r = t._getWebGamepad(e.deviceId); return r ? r.buttons[1].value : 0 }, this._buttonWest = new bD, this._buttonWest.getValue = function () { if (-1 === e.deviceId) { var i, n = null == (i = t._getWebXRGamepadMap()) ? void 0 : i.get(ED); return n && n.buttons.length > 4 ? n.buttons[4].value : 0 } var r = t._getWebGamepad(e.deviceId); return r ? r.buttons[2].value : 0 }, this._buttonSouth = new bD, this._buttonSouth.getValue = function () { if (-1 === e.deviceId) { var i, n = null == (i = t._getWebXRGamepadMap()) ? void 0 : i.get(AD); return n && n.buttons.length > 4 ? n.buttons[4].value : 0 } var r = t._getWebGamepad(e.deviceId); return r ? r.buttons[0].value : 0 }, this._buttonL1 = new bD, this._buttonL1.getValue = function () { var i = t._getWebGamepad(e.deviceId); return i ? i.buttons[4].value : 0 }, this._buttonL2 = new bD, this._buttonL2.getValue = function () { if (-1 === e.deviceId) { var i, n = null == (i = t._getWebXRGamepadMap()) ? void 0 : i.get(ED); return n && n.buttons.length > 0 ? n.buttons[0].value : 0 } var r = t._getWebGamepad(e.deviceId); return r ? r.buttons[6].value : 0 }, this._buttonL3 = new bD, this._buttonL3.getValue = function () { if (-1 === e.deviceId) { var i, n = null == (i = t._getWebXRGamepadMap()) ? void 0 : i.get(ED); if (n) { if (n.buttons.length > 3 && 0 !== n.buttons[3].value) return n.buttons[3].value; if (n.buttons.length > 2 && 0 !== n.buttons[2].value) return n.buttons[2].value } return 0 } var r = t._getWebGamepad(e.deviceId); return r ? r.buttons[10].value : 0 }, this._buttonR1 = new bD, this._buttonR1.getValue = function () { var i = t._getWebGamepad(e.deviceId); return i ? i.buttons[5].value : 0 }, this._buttonR2 = new bD, this._buttonR2.getValue = function () { if (-1 === e.deviceId) { var i, n = null == (i = t._getWebXRGamepadMap()) ? void 0 : i.get(AD); return n && n.buttons.length > 0 ? n.buttons[0].value : 0 } var r = t._getWebGamepad(e.deviceId); return r ? r.buttons[7].value : 0 }, this._buttonR3 = new bD, this._buttonR3.getValue = function () { if (-1 === e.deviceId) { var i, n = null == (i = t._getWebXRGamepadMap()) ? void 0 : i.get(AD); if (n) { if (n.buttons.length > 3 && 0 !== n.buttons[3].value) return n.buttons[3].value; if (n.buttons.length > 2 && 0 !== n.buttons[2].value) return n.buttons[2].value } return 0 } var r = t._getWebGamepad(e.deviceId); return r ? r.buttons[11].value : 0 }, this._buttonShare = new bD, this._buttonShare.getValue = function () { var i = t._getWebGamepad(e.deviceId); return i ? i.buttons[8].value : 0 }, this._buttonOptions = new bD, this._buttonOptions.getValue = function () { var i = t._getWebGamepad(e.deviceId); return i ? i.buttons[9].value : 0 }; var i = new bD; i.getValue = function () { var i = t._getWebGamepad(e.deviceId); return i ? i.buttons[12].value : 0 }; var n = new bD; n.getValue = function () { var i = t._getWebGamepad(e.deviceId); return i ? i.buttons[13].value : 0 }; var r = new bD; r.getValue = function () { var i = t._getWebGamepad(e.deviceId); return i ? i.buttons[14].value : 0 }; var s = new bD; s.getValue = function () { var i = t._getWebGamepad(e.deviceId); return i ? i.buttons[15].value : 0 }, this._dpad = new wD({ up: i, down: n, left: r, right: s }); var a = new bD; a.getValue = function () { if (-1 === e.deviceId) return 0; var i = t._getWebGamepad(e.deviceId); return i ? e._axisToButtons(i.axes[1]).negative : 0 }; var o = new bD; o.getValue = function () { if (-1 === e.deviceId) return 0; var i = t._getWebGamepad(e.deviceId); return i ? e._axisToButtons(i.axes[1]).positive : 0 }; var u = new bD; u.getValue = function () { if (-1 === e.deviceId) return 0; var i = t._getWebGamepad(e.deviceId); return i ? e._axisToButtons(i.axes[0]).negative : 0 }; var h = new bD; h.getValue = function () { if (-1 === e.deviceId) return 0; var i = t._getWebGamepad(e.deviceId); return i ? e._axisToButtons(i.axes[0]).positive : 0 }, this._leftStick = new xD({ up: a, down: o, left: u, right: h }); var c = new bD; c.getValue = function () { if (-1 === e.deviceId) return 0; var i = t._getWebGamepad(e.deviceId); return i ? e._axisToButtons(i.axes[3]).negative : 0 }; var l = new bD; l.getValue = function () { if (-1 === e.deviceId) return 0; var i = t._getWebGamepad(e.deviceId); return i ? e._axisToButtons(i.axes[3]).positive : 0 }; var f = new bD; f.getValue = function () { if (-1 === e.deviceId) return 0; var i = t._getWebGamepad(e.deviceId); return i ? e._axisToButtons(i.axes[2]).negative : 0 }; var d = new bD; d.getValue = function () { if (-1 === e.deviceId) return 0; var i = t._getWebGamepad(e.deviceId); return i ? e._axisToButtons(i.axes[2]).positive : 0 }, this._rightStick = new xD({ up: c, down: l, left: f, right: d }), this._buttonStart = new bD, this._buttonStart.getValue = function () { return 0 }, this._gripLeft = new bD, this._gripLeft.getValue = function () { return e.deviceId, 0 }, this._gripRight = new bD, this._gripRight.getValue = function () { if (-1 === e.deviceId) { var i, n = null == (i = t._getWebXRGamepadMap()) ? void 0 : i.get(AD); if (n && n.buttons.length > 1) return n.buttons[1].value } return 0 }, this._handLeftPosition = new TD, this._handLeftPosition.getValue = function () { return e._webPoseState[yD.HAND_LEFT].position }, this._handLeftOrientation = new SD, this._handLeftOrientation.getValue = function () { return e._webPoseState[yD.HAND_LEFT].orientation }, this._handRightPosition = new TD, this._handRightPosition.getValue = function () { return e._webPoseState[yD.HAND_RIGHT].position }, this._handRightOrientation = new SD, this._handRightOrientation.getValue = function () { return e._webPoseState[yD.HAND_RIGHT].orientation }, this._aimLeftPosition = new TD, this._aimLeftPosition.getValue = function () { return e._webPoseState[yD.AIM_LEFT].position }, this._aimLeftOrientation = new SD, this._aimLeftOrientation.getValue = function () { return e._webPoseState[yD.AIM_LEFT].orientation }, this._aimRightPosition = new TD, this._aimRightPosition.getValue = function () { return e._webPoseState[yD.AIM_RIGHT].position }, this._aimRightOrientation = new SD, this._aimRightOrientation.getValue = function () { return e._webPoseState[yD.AIM_RIGHT].orientation } }, n(t, [{ key: "buttonNorth", get: function () { return this._buttonNorth } }, { key: "buttonEast", get: function () { return this._buttonEast } }, { key: "buttonWest", get: function () { return this._buttonWest } }, { key: "buttonSouth", get: function () { return this._buttonSouth } }, { key: "buttonL1", get: function () { return this._buttonL1 } }, { key: "buttonL2", get: function () { return this._buttonL2 } }, { key: "buttonL3", get: function () { return this._buttonL3 } }, { key: "buttonR1", get: function () { return this._buttonR1 } }, { key: "buttonR2", get: function () { return this._buttonR2 } }, { key: "buttonR3", get: function () { return this._buttonR3 } }, { key: "buttonShare", get: function () { return this._buttonShare } }, { key: "buttonOptions", get: function () { return this._buttonOptions } }, { key: "dpad", get: function () { return this._dpad } }, { key: "leftStick", get: function () { return this._leftStick } }, { key: "rightStick", get: function () { return this._rightStick } }, { key: "buttonStart", get: function () { return this._buttonStart } }, { key: "gripLeft", get: function () { return this._gripLeft } }, { key: "gripRight", get: function () { return this._gripRight } }, { key: "handLeftPosition", get: function () { return this._handLeftPosition } }, { key: "handLeftOrientation", get: function () { return this._handLeftOrientation } }, { key: "handRightPosition", get: function () { return this._handRightPosition } }, { key: "handRightOrientation", get: function () { return this._handRightOrientation } }, { key: "aimLeftPosition", get: function () { return this._aimLeftPosition } }, { key: "aimLeftOrientation", get: function () { return this._aimLeftOrientation } }, { key: "aimRightPosition", get: function () { return this._aimRightPosition } }, { key: "aimRightOrientation", get: function () { return this._aimRightOrientation } }, { key: "deviceId", get: function () { return this._deviceId } }, { key: "connected", get: function () { return this._connected } }]), t }(); OD.all = [], OD.xr = null, OD._eventTarget = new wo, OD._cachedWebGamepads = [], OD._cachedWebXRGamepadMap = null, OD._intervalId = -1, OD._totalGamepadCnt = 0, function (t) { t[t.BUTTON_EAST = 0] = "BUTTON_EAST", t[t.BUTTON_SOUTH = 1] = "BUTTON_SOUTH", t[t.BUTTON_WEST = 2] = "BUTTON_WEST", t[t.BUTTON_NORTH = 3] = "BUTTON_NORTH", t[t.BUTTON_TRIGGER_LEFT = 4] = "BUTTON_TRIGGER_LEFT", t[t.BUTTON_TRIGGER_RIGHT = 5] = "BUTTON_TRIGGER_RIGHT", t[t.TRIGGER_LEFT = 6] = "TRIGGER_LEFT", t[t.TRIGGER_RIGHT = 7] = "TRIGGER_RIGHT", t[t.GRIP_LEFT = 8] = "GRIP_LEFT", t[t.GRIP_RIGHT = 9] = "GRIP_RIGHT", t[t.BUTTON_LEFT_STICK = 10] = "BUTTON_LEFT_STICK", t[t.LEFT_STICK_UP = 11] = "LEFT_STICK_UP", t[t.LEFT_STICK_DOWN = 12] = "LEFT_STICK_DOWN", t[t.LEFT_STICK_LEFT = 13] = "LEFT_STICK_LEFT", t[t.LEFT_STICK_RIGHT = 14] = "LEFT_STICK_RIGHT", t[t.BUTTON_RIGHT_STICK = 15] = "BUTTON_RIGHT_STICK", t[t.RIGHT_STICK_UP = 16] = "RIGHT_STICK_UP", t[t.RIGHT_STICK_DOWN = 17] = "RIGHT_STICK_DOWN", t[t.RIGHT_STICK_LEFT = 18] = "RIGHT_STICK_LEFT", t[t.RIGHT_STICK_RIGHT = 19] = "RIGHT_STICK_RIGHT", t[t.ROKID_MENU = 20] = "ROKID_MENU", t[t.ROKID_START = 21] = "ROKID_START" }(DD || (DD = {})), function (t) { t[t.KET_CLICK = 0] = "KET_CLICK", t[t.KET_STICK = 1] = "KET_STICK", t[t.KET_GRAB = 2] = "KET_GRAB", t[t.KET_TOUCH = 3] = "KET_TOUCH" }(RD || (RD = {})), function (t) { t[t.UNDEFINE = 0] = "UNDEFINE", t[t.A = 1] = "A", t[t.B = 2] = "B", t[t.X = 3] = "X", t[t.Y = 4] = "Y", t[t.L1 = 5] = "L1", t[t.R1 = 6] = "R1", t[t.MINUS = 7] = "MINUS", t[t.PLUS = 8] = "PLUS", t[t.L3 = 9] = "L3", t[t.R3 = 10] = "R3", t[t.MENU = 11] = "MENU", t[t.START = 12] = "START", t[t.TRIGGER_LEFT = 13] = "TRIGGER_LEFT", t[t.TRIGGER_RIGHT = 14] = "TRIGGER_RIGHT" }(PD || (PD = {})), function (t) { t[t.UNDEFINE = 0] = "UNDEFINE", t[t.X = 1] = "X", t[t.Y = 2] = "Y", t[t.LEFT_STICK_X = 3] = "LEFT_STICK_X", t[t.LEFT_STICK_Y = 4] = "LEFT_STICK_Y", t[t.RIGHT_STICK_X = 5] = "RIGHT_STICK_X", t[t.RIGHT_STICK_Y = 6] = "RIGHT_STICK_Y", t[t.L2 = 7] = "L2", t[t.R2 = 8] = "R2", t[t.LEFT_GRIP = 9] = "LEFT_GRIP", t[t.RIGHT_GRIP = 10] = "RIGHT_GRIP" }(BD || (BD = {})), function (t) { t[t.UNDEFINE = 0] = "UNDEFINE", t[t.A = 1] = "A", t[t.B = 2] = "B", t[t.X = 3] = "X", t[t.Y = 4] = "Y", t[t.LEFT_TRIGGER = 5] = "LEFT_TRIGGER", t[t.RIGHT_TRIGGER = 6] = "RIGHT_TRIGGER", t[t.LEFT_THUMBSTICK = 7] = "LEFT_THUMBSTICK", t[t.RIGHT_THUMBSTICK = 8] = "RIGHT_THUMBSTICK" }(MD || (MD = {})); var LD, FD = { 1: DD.BUTTON_EAST, 2: DD.BUTTON_SOUTH, 3: DD.BUTTON_NORTH, 4: DD.BUTTON_WEST, 9: DD.BUTTON_LEFT_STICK, 10: DD.BUTTON_RIGHT_STICK, 11: DD.ROKID_MENU, 12: DD.ROKID_START, 13: DD.BUTTON_TRIGGER_LEFT, 14: DD.BUTTON_TRIGGER_RIGHT }, kD = function () { function t() { var t, e, i = this; this._eventTarget = new wo, this._nativeButtonState = ((t = {})[DD.BUTTON_SOUTH] = 0, t[DD.BUTTON_EAST] = 0, t[DD.BUTTON_WEST] = 0, t[DD.BUTTON_NORTH] = 0, t[DD.BUTTON_TRIGGER_LEFT] = 0, t[DD.BUTTON_TRIGGER_RIGHT] = 0, t[DD.TRIGGER_LEFT] = 0, t[DD.TRIGGER_RIGHT] = 0, t[DD.GRIP_LEFT] = 0, t[DD.GRIP_RIGHT] = 0, t[DD.LEFT_STICK_UP] = 0, t[DD.LEFT_STICK_DOWN] = 0, t[DD.LEFT_STICK_LEFT] = 0, t[DD.LEFT_STICK_RIGHT] = 0, t[DD.RIGHT_STICK_UP] = 0, t[DD.RIGHT_STICK_DOWN] = 0, t[DD.RIGHT_STICK_LEFT] = 0, t[DD.RIGHT_STICK_RIGHT] = 0, t[DD.BUTTON_LEFT_STICK] = 0, t[DD.BUTTON_RIGHT_STICK] = 0, t[DD.ROKID_MENU] = 0, t[DD.ROKID_START] = 0, t), this._nativeTouchState = ((e = {})[MD.UNDEFINE] = 0, e[MD.A] = 0, e[MD.B] = 0, e[MD.X] = 0, e[MD.Y] = 0, e[MD.LEFT_TRIGGER] = 0, e[MD.RIGHT_TRIGGER] = 0, e[MD.LEFT_THUMBSTICK] = 0, e[MD.RIGHT_THUMBSTICK] = 0, e), this._initInputSource(), window.addEventListener("xr-remote-input", (function (t) { var e = t, n = e.detail.keyEventType, r = e.detail.stickAxisCode, s = e.detail.stickAxisValue, a = e.detail.stickKeyCode, o = e.detail.isButtonPressed, u = e.detail.touchCode, h = e.detail.touchValue; if (n === RD.KET_CLICK) { var c = FD[a]; i._nativeButtonState[c] = o ? 1 : 0 } else if (n === RD.KET_STICK || n === RD.KET_GRAB) { var l, f, d; switch (r) { case BD.LEFT_STICK_X: l = DD.LEFT_STICK_LEFT, f = DD.LEFT_STICK_RIGHT, d = i._axisToButtons(s); break; case BD.LEFT_STICK_Y: l = DD.LEFT_STICK_DOWN, f = DD.LEFT_STICK_UP, d = i._axisToButtons(s); break; case BD.RIGHT_STICK_X: l = DD.RIGHT_STICK_LEFT, f = DD.RIGHT_STICK_RIGHT, d = i._axisToButtons(s); break; case BD.RIGHT_STICK_Y: l = DD.RIGHT_STICK_DOWN, f = DD.RIGHT_STICK_UP, d = i._axisToButtons(s); break; case BD.L2: i._nativeButtonState[DD.TRIGGER_LEFT] = s; break; case BD.R2: i._nativeButtonState[DD.TRIGGER_RIGHT] = s; break; case BD.LEFT_GRIP: i._nativeButtonState[DD.GRIP_LEFT] = s; break; case BD.RIGHT_GRIP: i._nativeButtonState[DD.GRIP_RIGHT] = s }l && f && d && (i._nativeButtonState[l] = d.negative, i._nativeButtonState[f] = d.positive) } else if (n === RD.KET_TOUCH) switch (u) { case MD.A: case MD.B: case MD.X: case MD.Y: case MD.LEFT_TRIGGER: case MD.RIGHT_TRIGGER: case MD.LEFT_THUMBSTICK: case MD.RIGHT_THUMBSTICK: i._nativeTouchState[u] = h }i._eventTarget.emit("handle-input", new Nv("handle-input", i)) })) } var e = t.prototype; return e._axisToButtons = function (t) { var e = Math.abs(t); return t > 0 ? { negative: 0, positive: e } : t < 0 ? { negative: e, positive: 0 } : { negative: 0, positive: 0 } }, e._on = function (t, e, i) { this._eventTarget.on(t, e, i) }, e._initInputSource = function () { var t = this; this._buttonNorth = new bD, this._buttonNorth.getValue = function () { return t._nativeButtonState[DD.BUTTON_NORTH] }, this._buttonEast = new bD, this._buttonEast.getValue = function () { return t._nativeButtonState[DD.BUTTON_EAST] }, this._buttonWest = new bD, this._buttonWest.getValue = function () { return t._nativeButtonState[DD.BUTTON_WEST] }, this._buttonSouth = new bD, this._buttonSouth.getValue = function () { return t._nativeButtonState[DD.BUTTON_SOUTH] }, this._buttonTriggerLeft = new bD, this._buttonTriggerLeft.getValue = function () { return t._nativeButtonState[DD.BUTTON_TRIGGER_LEFT] }, this._buttonTriggerRight = new bD, this._buttonTriggerRight.getValue = function () { return t._nativeButtonState[DD.BUTTON_TRIGGER_RIGHT] }, this._triggerLeft = new bD, this._triggerLeft.getValue = function () { return t._nativeButtonState[DD.TRIGGER_LEFT] }, this._triggerRight = new bD, this._triggerRight.getValue = function () { return t._nativeButtonState[DD.TRIGGER_RIGHT] }, this._gripLeft = new bD, this._gripLeft.getValue = function () { return t._nativeButtonState[DD.GRIP_LEFT] }, this._gripRight = new bD, this._gripRight.getValue = function () { return t._nativeButtonState[DD.GRIP_RIGHT] }, this._buttonLeftStick = new bD, this._buttonLeftStick.getValue = function () { return t._nativeButtonState[DD.BUTTON_LEFT_STICK] }; var e = new bD; e.getValue = function () { return t._nativeButtonState[DD.LEFT_STICK_UP] }; var i = new bD; i.getValue = function () { return t._nativeButtonState[DD.LEFT_STICK_DOWN] }; var n = new bD; n.getValue = function () { return t._nativeButtonState[DD.LEFT_STICK_LEFT] }; var r = new bD; r.getValue = function () { return t._nativeButtonState[DD.LEFT_STICK_RIGHT] }, this._leftStick = new xD({ up: e, down: i, left: n, right: r }), this._buttonRightStick = new bD, this._buttonRightStick.getValue = function () { return t._nativeButtonState[DD.BUTTON_RIGHT_STICK] }; var s = new bD; s.getValue = function () { return t._nativeButtonState[DD.RIGHT_STICK_UP] }; var a = new bD; a.getValue = function () { return t._nativeButtonState[DD.RIGHT_STICK_DOWN] }; var o = new bD; o.getValue = function () { return t._nativeButtonState[DD.RIGHT_STICK_LEFT] }; var u = new bD; u.getValue = function () { return t._nativeButtonState[DD.RIGHT_STICK_RIGHT] }, this._rightStick = new xD({ up: s, down: a, left: o, right: u }), this._buttonOptions = new bD, this._buttonOptions.getValue = function () { return t._nativeButtonState[DD.ROKID_MENU] }, this._buttonStart = new bD, this._buttonStart.getValue = function () { return t._nativeButtonState[DD.ROKID_START] }, this._handLeftPosition = new TD, this._handLeftPosition.getValue = function () { return Kn.ZERO }, this._handLeftOrientation = new SD, this._handLeftOrientation.getValue = function () { return Er.IDENTITY }, this._handRightPosition = new TD, this._handRightPosition.getValue = function () { return Kn.ZERO }, this._handRightOrientation = new SD, this._handRightOrientation.getValue = function () { return Er.IDENTITY }, this._aimLeftPosition = new TD, this._aimLeftPosition.getValue = function () { return Kn.ZERO }, this._aimLeftOrientation = new SD, this._aimLeftOrientation.getValue = function () { return Er.IDENTITY }, this._aimRightPosition = new TD, this._aimRightPosition.getValue = function () { return Kn.ZERO }, this._aimRightOrientation = new SD, this._aimRightOrientation.getValue = function () { return Er.IDENTITY }, this._touchButtonA = new ID, this._touchButtonA.getValue = function () { return t._nativeTouchState[MD.A] }, this._touchButtonB = new ID, this._touchButtonB.getValue = function () { return t._nativeTouchState[MD.B] }, this._touchButtonX = new ID, this._touchButtonX.getValue = function () { return t._nativeTouchState[MD.X] }, this._touchButtonY = new ID, this._touchButtonY.getValue = function () { return t._nativeTouchState[MD.Y] }, this._touchButtonTriggerLeft = new ID, this._touchButtonTriggerLeft.getValue = function () { return t._nativeTouchState[MD.LEFT_TRIGGER] }, this._touchButtonTriggerRight = new ID, this._touchButtonTriggerRight.getValue = function () { return t._nativeTouchState[MD.RIGHT_TRIGGER] }, this._touchButtonThumbStickLeft = new ID, this._touchButtonThumbStickLeft.getValue = function () { return t._nativeTouchState[MD.LEFT_THUMBSTICK] }, this._touchButtonThumbStickRight = new ID, this._touchButtonThumbStickRight.getValue = function () { return t._nativeTouchState[MD.RIGHT_THUMBSTICK] } }, n(t, [{ key: "buttonNorth", get: function () { return this._buttonNorth } }, { key: "buttonEast", get: function () { return this._buttonEast } }, { key: "buttonWest", get: function () { return this._buttonWest } }, { key: "buttonSouth", get: function () { return this._buttonSouth } }, { key: "buttonTriggerLeft", get: function () { return this._buttonTriggerLeft } }, { key: "buttonTriggerRight", get: function () { return this._buttonTriggerRight } }, { key: "triggerLeft", get: function () { return this._triggerLeft } }, { key: "triggerRight", get: function () { return this._triggerRight } }, { key: "gripLeft", get: function () { return this._gripLeft } }, { key: "gripRight", get: function () { return this._gripRight } }, { key: "leftStick", get: function () { return this._leftStick } }, { key: "rightStick", get: function () { return this._rightStick } }, { key: "buttonLeftStick", get: function () { return this._buttonLeftStick } }, { key: "buttonRightStick", get: function () { return this._buttonRightStick } }, { key: "buttonOptions", get: function () { return this._buttonOptions } }, { key: "buttonStart", get: function () { return this._buttonStart } }, { key: "handLeftPosition", get: function () { return this._handLeftPosition } }, { key: "handLeftOrientation", get: function () { return this._handLeftOrientation } }, { key: "handRightPosition", get: function () { return this._handRightPosition } }, { key: "handRightOrientation", get: function () { return this._handRightOrientation } }, { key: "aimLeftPosition", get: function () { return this._aimLeftPosition } }, { key: "aimLeftOrientation", get: function () { return this._aimLeftOrientation } }, { key: "aimRightPosition", get: function () { return this._aimRightPosition } }, { key: "aimRightOrientation", get: function () { return this._aimRightOrientation } }, { key: "touchButtonA", get: function () { return this._touchButtonA } }, { key: "touchButtonB", get: function () { return this._touchButtonB } }, { key: "touchButtonX", get: function () { return this._touchButtonX } }, { key: "touchButtonY", get: function () { return this._touchButtonY } }, { key: "touchButtonTriggerLeft", get: function () { return this._touchButtonTriggerLeft } }, { key: "touchButtonTriggerRight", get: function () { return this._touchButtonTriggerRight } }, { key: "touchButtonThumbStickLeft", get: function () { return this._touchButtonThumbStickLeft } }, { key: "touchButtonThumbStickRight", get: function () { return this._touchButtonThumbStickRight } }]), t }(); !function (t) { t[t.VIEW_LEFT = 0] = "VIEW_LEFT", t[t.VIEW_RIGHT = 3] = "VIEW_RIGHT", t[t.HEAD_MIDDLE = 6] = "HEAD_MIDDLE" }(LD || (LD = {})); var ND, zD = function () { function t() { var t; this._eventTarget = new wo, this._intervalId = -1, this._webPoseState = ((t = {})[LD.VIEW_LEFT] = { position: Kn.ZERO, orientation: Er.IDENTITY }, t[LD.VIEW_RIGHT] = { position: Kn.ZERO, orientation: Er.IDENTITY }, t[LD.HEAD_MIDDLE] = { position: Kn.ZERO, orientation: Er.IDENTITY }, t), this._initInputSource(), this._registerEvent() } var e = t.prototype; return e._ensureDirectorDefined = function () { var t = this; return new Promise((function (e) { t._intervalId = setInterval((function () { T.director && T.Director && (clearInterval(t._intervalId), t._intervalId = -1, e()) }), 50) })) }, e._registerEvent = function () { var t = this; this._ensureDirectorDefined().then((function () { T.director.on(T.Director.EVENT_BEGIN_FRAME, t._scanHmd, t) })).catch((function () { })) }, e._scanHmd = function () { var t, e = null == (t = globalThis.__globalXR) ? void 0 : t.webxrHmdPoseInfos; if (e) { for (var i = 0; i < e.length; ++i) { var n = e[i]; this._updateWebPoseState(n) } this._eventTarget.emit("hmd-pose-input", new zv("hmd-pose-input", this)) } }, e._on = function (t, e, i) { this._eventTarget.on(t, e, i) }, e._updateWebPoseState = function (t) { t.code !== LD.VIEW_LEFT && t.code !== LD.VIEW_RIGHT && t.code !== LD.HEAD_MIDDLE || (this._webPoseState[t.code] = { position: new Kn(t.position.x, t.position.y, t.position.z), orientation: new Er(t.orientation.x, t.orientation.y, t.orientation.z, t.orientation.w) }) }, e._initInputSource = function () { var t = this; this._viewLeftPosition = new TD, this._viewLeftPosition.getValue = function () { return t._webPoseState[LD.VIEW_LEFT].position }, this._viewLeftOrientation = new SD, this._viewLeftOrientation.getValue = function () { return t._webPoseState[LD.VIEW_LEFT].orientation }, this._viewRightPosition = new TD, this._viewRightPosition.getValue = function () { return t._webPoseState[LD.VIEW_RIGHT].position }, this._viewRightOrientation = new SD, this._viewRightOrientation.getValue = function () { return t._webPoseState[LD.VIEW_RIGHT].orientation }, this._headMiddlePosition = new TD, this._headMiddlePosition.getValue = function () { return t._webPoseState[LD.HEAD_MIDDLE].position }, this._headMiddleOrientation = new SD, this._headMiddleOrientation.getValue = function () { return t._webPoseState[LD.HEAD_MIDDLE].orientation } }, n(t, [{ key: "viewLeftPosition", get: function () { return this._viewLeftPosition } }, { key: "viewLeftOrientation", get: function () { return this._viewLeftOrientation } }, { key: "viewRightPosition", get: function () { return this._viewRightPosition } }, { key: "viewRightOrientation", get: function () { return this._viewRightOrientation } }, { key: "headMiddlePosition", get: function () { return this._headMiddlePosition } }, { key: "headMiddleOrientation", get: function () { return this._headMiddleOrientation } }]), t }(), UD = function () { function t() { this._eventTarget = new wo, this._initInputSource() } var e = t.prototype; return e._on = function (t, e, i) { this._eventTarget.on(t, e, i) }, e._initInputSource = function () { this._handheldPosition = new TD, this._handheldPosition.getValue = function () { return Kn.ZERO }, this._handheldOrientation = new SD, this._handheldOrientation.getValue = function () { return Er.IDENTITY } }, n(t, [{ key: "handheldPosition", get: function () { return this._handheldPosition } }, { key: "handheldOrientation", get: function () { return this._handheldOrientation } }]), t }(), VD = { Backspace: 8, Tab: 9, Enter: 13, ShiftLeft: 16, ControlLeft: 17, AltLeft: 18, ShiftRight: 2e3, ControlRight: 2001, AltRight: 2002, Pause: 19, CapsLock: 20, Escape: 27, Space: 32, PageUp: 33, PageDown: 34, End: 35, Home: 36, ArrowLeft: 37, ArrowUp: 38, ArrowRight: 39, ArrowDown: 40, Insert: 45, Delete: 46, Digit0: 48, Digit1: 49, Digit2: 50, Digit3: 51, Digit4: 52, Digit5: 53, Digit6: 54, Digit7: 55, Digit8: 56, Digit9: 57, KeyA: 65, KeyB: 66, KeyC: 67, KeyD: 68, KeyE: 69, KeyF: 70, KeyG: 71, KeyH: 72, KeyI: 73, KeyJ: 74, KeyK: 75, KeyL: 76, KeyM: 77, KeyN: 78, KeyO: 79, KeyP: 80, KeyQ: 81, KeyR: 82, KeyS: 83, KeyT: 84, KeyU: 85, KeyV: 86, KeyW: 87, KeyX: 88, KeyY: 89, KeyZ: 90, Numpad0: 96, Numpad1: 97, Numpad2: 98, Numpad3: 99, Numpad4: 100, Numpad5: 101, Numpad6: 102, Numpad7: 103, Numpad8: 104, Numpad9: 105, NumpadMultiply: 106, NumpadAdd: 107, NumpadSubtract: 109, NumpadDecimal: 110, NumpadDivide: 111, NumpadEnter: 2003, F1: 112, F2: 113, F3: 114, F4: 115, F5: 116, F6: 117, F7: 118, F8: 119, F9: 120, F10: 121, F11: 122, F12: 123, NumLock: 144, ScrollLock: 145, Semicolon: 186, Equal: 187, Comma: 188, Minus: 189, Period: 190, Slash: 191, Backquote: 192, BracketLeft: 219, Backslash: 220, BracketRight: 221, Quote: 222 }, GD = function () { function t() { this._eventTarget = new wo, this._registerEvent() } var e = t.prototype; return e.dispatchKeyboardDownEvent = function (t) { this._handleKeyboardDown(t) }, e.dispatchKeyboardUpEvent = function (t) { this._handleKeyboardUp(t) }, e.on = function (t, e, i) { this._eventTarget.on(t, e, i) }, e._registerEvent = function () { var t = document.getElementById("GameCanvas"); null == t || t.addEventListener("keydown", this._handleKeyboardDown.bind(this)), null == t || t.addEventListener("keyup", this._handleKeyboardUp.bind(this)) }, e._getInputEvent = function (t, e) { var i, n = (i = t.code, VD[i] || 0); return new Mv(n, e) }, e._handleKeyboardDown = function (t) { if (t.stopPropagation(), t.preventDefault(), t.repeat) { var e = this._getInputEvent(t, "key-pressing"); this._eventTarget.emit("key-pressing", e) } else { var i = this._getInputEvent(t, "keydown"); this._eventTarget.emit("keydown", i) } }, e._handleKeyboardUp = function (t) { var e = this._getInputEvent(t, "keyup"); t.stopPropagation(), t.preventDefault(), this._eventTarget.emit("keyup", e) }, t }(), HD = function () { function t() { this._canvas = void 0, this._eventTarget = new wo, this._pointLocked = !1, this._isPressed = !1, this._preMousePos = new as, this._handleMouseDown = void 0, this._handleMouseMove = void 0, this._handleMouseUp = void 0, Ro.hasFeature(Ao.EVENT_MOUSE) && (this._canvas = document.getElementById("GameCanvas"), this._canvas || W("failed to access canvas"), this._handleMouseDown = this._createCallback("mouse-down"), this._handleMouseMove = this._createCallback("mouse-move"), this._handleMouseUp = this._createCallback("mouse-up"), this._registerEvent()) } var e = t.prototype; return e.dispatchMouseDownEvent = function (t) { this._handleMouseDown(t) }, e.dispatchMouseMoveEvent = function (t) { this._handleMouseMove(t) }, e.dispatchMouseUpEvent = function (t) { this._handleMouseUp(t) }, e.dispatchScrollEvent = function (t) { this._handleMouseWheel(t) }, e.on = function (t, e, i) { this._eventTarget.on(t, e, i) }, e._getCanvasRect = function () { var t = this._canvas, e = null == t ? void 0 : t.getBoundingClientRect(); return e ? new fs(e.x, e.y, e.width, e.height) : new fs(0, 0, 0, 0) }, e._getLocation = function (t) { var e = this._getCanvasRect(), i = Zo.devicePixelRatio, n = this._pointLocked ? this._preMousePos.x / i + t.movementX : t.clientX - e.x, r = this._pointLocked ? this._preMousePos.y / i - t.movementY : e.y + e.height - t.clientY; return new as(n *= i, r *= i) }, e._registerEvent = function () { var t, e, i, n, r, s, a = this; window.addEventListener("mousedown", (function () { a._isPressed = !0 })), null == (t = this._canvas) || t.addEventListener("mousedown", this._handleMouseDown), null == (e = this._canvas) || e.addEventListener("mousemove", this._handleMouseMove), window.addEventListener("mouseup", this._handleMouseUp), null == (i = this._canvas) || i.addEventListener("mouseup", this._handleMouseUp),/*nam.lee null==(n=this._canvas)||n.addEventListener("wheel",this._handleMouseWheel.bind(this)),*/this._registerPointerLockEvent(), null == (r = this._canvas) || r.addEventListener("mouseleave", this._handleMouseLeave.bind(this)), null == (s = this._canvas) || s.addEventListener("mouseenter", this._handleMouseEnter.bind(this)) }, e._registerPointerLockEvent = function () { var t = this, e = function () { var e = t._canvas; document.pointerLockElement === e || document.mozPointerLockElement === e ? t._pointLocked = !0 : t._pointLocked = !1 }; "onpointerlockchange" in document ? document.addEventListener("pointerlockchange", e, !1) : "onmozpointerlockchange" in document && document.addEventListener("mozpointerlockchange", e, !1) }, e._createCallback = function (t) { var e = this; return function (i) { var n, r = e._getLocation(i), s = i.button, a = i.buttons, o = s; switch (t) { case "mouse-down":/*nam.lee null==(n=e._canvas)||n.focus(),*/ e._isPressed = !0; break; case "mouse-up": e._isPressed = !1; break; case "mouse-move": o = 1 & a ? Ov.BUTTON_LEFT : 2 & a ? Ov.BUTTON_RIGHT : 4 & a ? Ov.BUTTON_MIDDLE : Ov.BUTTON_MISSING }var u = new Ov(t, !1, e._preMousePos); u.setLocation(r.x, r.y), u.setButton(o), u.movementX = i.movementX, u.movementY = i.movementY, e._preMousePos.set(r.x, r.y), i.stopPropagation(), i.target === e._canvas && i.preventDefault(), e._eventTarget.emit(t, u) } }, e._handleMouseWheel = function (t) { var e = "mouse-wheel", i = this._getLocation(t), n = t.button, r = new Ov(e, !1, this._preMousePos); r.setLocation(i.x, i.y), r.setButton(n), r.movementX = t.movementX, r.movementY = t.movementY, r.setScrollData(5 * t.deltaX, 5 * -t.deltaY), this._preMousePos.set(i.x, i.y), t.stopPropagation(), t.target === this._canvas && t.preventDefault(), this._eventTarget.emit(e, r) }, e._handleMouseLeave = function () { var t = "mouse-leave-window", e = new Ov(t, !1); this._eventTarget.emit(t, e) }, e._handleMouseEnter = function () { var t = "mouse-enter-window", e = new Ov(t, !1); this._eventTarget.emit(t, e) }, e.dispatchEventsInCache = function () { }, t }(), WD = new as, jD = new (function () { function t() { this._touchMap = new Map, this._maxTouches = 8 } var e = t.prototype; return e._createTouch = function (t, e, i) { if (this._touchMap.has(t)) J(2301); else { if (!this._checkTouchMapSizeMoreThanMax(t)) { var n = new Hv(e, i, t); return this._touchMap.set(t, n), this._updateTouch(n, e, i), n } J(2300) } }, e.releaseTouch = function (t) { this._touchMap.has(t) && this._touchMap.delete(t) }, e.getTouch = function (t) { return this._touchMap.get(t) }, e.getOrCreateTouch = function (t, e, i) { var n = this.getTouch(t); return n ? this._updateTouch(n, e, i) : n = this._createTouch(t, e, i), n }, e.getAllTouches = function () { var t = []; return this._touchMap.forEach((function (e) { e && t.push(e) })), t }, e.getTouchCount = function () { return this._touchMap.size }, e._updateTouch = function (t, e, i) { t.getLocation(WD), t.setPrevPoint(WD), t.setPoint(e, i) }, e._checkTouchMapSizeMoreThanMax = function (t) { var e = this; if (this._touchMap.has(t)) return !1; var i = Le.ENABLE_MULTI_TOUCH ? this._maxTouches : 1; if (this._touchMap.size < i) return !1; var n = performance.now(); return this._touchMap.forEach((function (t) { n - t.lastModified > Le.TOUCH_TIMEOUT && (J(2302, t.getID()), e.releaseTouch(t.getID())) })), i >= this._touchMap.size }, t }()), XD = function () { function t() { this._canvas = void 0, this._eventTarget = new wo, Ro.hasFeature(Ao.INPUT_TOUCH) && (this._canvas = document.getElementById("GameCanvas"), this._canvas || W("failed to access canvas"), this._registerEvent()) } var e = t.prototype; return e._registerEvent = function () { var t, e, i, n; null == (t = this._canvas) || t.addEventListener("touchstart", this._createCallback("touch-start")), null == (e = this._canvas) || e.addEventListener("touchmove", this._createCallback("touch-move")), null == (i = this._canvas) || i.addEventListener("touchend", this._createCallback("touch-end")), null == (n = this._canvas) || n.addEventListener("touchcancel", this._createCallback("touch-cancel")) }, e._createCallback = function (t) { var e = this; return function (i) { for (var n, r = e._getCanvasRect(), s = [], a = i.changedTouches.length, o = 0; o < a; ++o) { var u = i.changedTouches[o], h = u.identifier; if (null !== h) { var c = e._getLocation(u, r), l = jD.getOrCreateTouch(h, c.x, c.y); l && ("touch-end" !== t && "touch-cancel" !== t || jD.releaseTouch(h), s.push(l)) } } if (/*nam.lee i.stopPropagation(),i.target===e._canvas&&i.preventDefault(),"touch-start"===t&&(null==(n=e._canvas)||n.focus()),*/s.length > 0) { var f = new Fv(s, !1, t, jD.getAllTouches()); e._eventTarget.emit(t, f) } } }, e._getCanvasRect = function () { var t = this._canvas, e = null == t ? void 0 : t.getBoundingClientRect(); return e ? new fs(e.x, e.y, e.width, e.height) : new fs(0, 0, 0, 0) }, e._getLocation = function (t, e) { var i = t.clientX - e.x, n = e.y + e.height - t.clientY; if (Zo.isFrameRotated) { var r = i; i = e.height - n, n = r } var s = Zo.devicePixelRatio; return new as(i *= s, n *= s) }, e.on = function (t, e, i) { this._eventTarget.on(t, e, i) }, e.dispatchEventsInCache = function () { }, t }(), qD = function () { function t(t) { this.priority = 0, this._inputEventTarget = t } var e = t.prototype; return e.onThrowException = function () { }, e.dispatchEvent = function (t) { return this._inputEventTarget.emit(t.type, t), !0 }, t }(), YD = ((ND = {})["mouse-down"] = "touch-start", ND["mouse-move"] = "touch-move", ND["mouse-up"] = "touch-end", ND), KD = t("Input", function () { function t() { this._eventTarget = new wo, this._touchInput = new XD, this._mouseInput = new HD, this._keyboardInput = new GD, this._accelerometerInput = new lD, this._eventKeyboardList = [], this._eventAccelerationList = [], this._eventGamepadList = [], this._eventHandleList = [], this._eventHMDList = [], this._eventHandheldList = [], this._needSimulateTouchMoveEvent = !1, this._eventDispatcherList = [], this._handleInput = new kD, this._hmdInput = new zD, this._handheldInput = new UD, this._registerEvent(), this._inputEventDispatcher = new qD(this._eventTarget), this._registerEventDispatcher(this._inputEventDispatcher), OD._init() } var e = t.prototype; return e._dispatchMouseDownEvent = function (t) { var e, i; null == (e = (i = this._mouseInput).dispatchMouseDownEvent) || e.call(i, t) }, e._dispatchMouseMoveEvent = function (t) { var e, i; null == (e = (i = this._mouseInput).dispatchMouseMoveEvent) || e.call(i, t) }, e._dispatchMouseUpEvent = function (t) { var e, i; null == (e = (i = this._mouseInput).dispatchMouseUpEvent) || e.call(i, t) }, e._dispatchMouseScrollEvent = function (t) { var e, i; null == (e = (i = this._mouseInput).dispatchScrollEvent) || e.call(i, t) }, e._dispatchKeyboardDownEvent = function (t) { var e, i; null == (e = (i = this._keyboardInput).dispatchKeyboardDownEvent) || e.call(i, t) }, e._dispatchKeyboardUpEvent = function (t) { var e, i; null == (e = (i = this._keyboardInput).dispatchKeyboardUpEvent) || e.call(i, t) }, e.on = function (t, e, i) { return this._eventTarget.on(t, e, i), e }, e.once = function (t, e, i) { return this._eventTarget.once(t, e, i), e }, e.off = function (t, e, i) { this._eventTarget.off(t, e, i) }, e.getTouch = function (t) { return jD.getTouch(t) }, e.getAllTouches = function () { return jD.getAllTouches() }, e.getTouchCount = function () { return jD.getTouchCount() }, e.setAccelerometerEnabled = function (t) { t ? this._accelerometerInput.start() : this._accelerometerInput.stop() }, e.setAccelerometerInterval = function (t) { this._accelerometerInput.setInterval(t) }, e._simulateEventTouch = function (t) { var e = YD[t.type], i = jD.getOrCreateTouch(0, t.getLocationX(), t.getLocationY()); if (i) { var n = [i], r = new Fv(n, !1, e, "touch-end" === e ? [] : n); r.windowId = t.windowId, "touch-end" === e && jD.releaseTouch(0), this._dispatchEventTouch(r) } }, e._registerEventDispatcher = function (t) { this._eventDispatcherList.push(t), this._eventDispatcherList.sort((function (t, e) { return e.priority - t.priority })) }, e._emitEvent = function (t) { for (var e = this._eventDispatcherList.length, i = 0; i < e; ++i) { var n = this._eventDispatcherList[i]; try { if (!n.dispatchEvent(t)) break } catch (t) { throw this._clearEvents(), n.onThrowException(), t } } }, e._registerEvent = function () { var t = this, e = t._touchInput, i = t._mouseInput, n = t._keyboardInput, r = t._handleInput; if (tu.hasFeature(tu.Feature.INPUT_TOUCH) && (e.on("touch-start", (function (e) { t._dispatchEventTouch(e) })), e.on("touch-move", (function (e) { t._dispatchEventTouch(e) })), e.on("touch-end", (function (e) { t._dispatchEventTouch(e) })), e.on("touch-cancel", (function (e) { t._dispatchEventTouch(e) }))), tu.hasFeature(tu.Feature.EVENT_MOUSE) && (i.on("mouse-down", (function (e) { t._needSimulateTouchMoveEvent = !0, t._simulateEventTouch(e), t._dispatchEventMouse(e) })), i.on("mouse-move", (function (e) { t._needSimulateTouchMoveEvent && t._simulateEventTouch(e), t._dispatchEventMouse(e) })), i.on("mouse-up", (function (e) { t._needSimulateTouchMoveEvent = !1, t._simulateEventTouch(e), t._dispatchEventMouse(e) })), i.on("mouse-wheel", (function (e) { t._dispatchEventMouse(e) })), i.on("mouse-leave-window", (function (e) { t._dispatchEventMouse(e) })), i.on("mouse-enter-window", (function (e) { t._dispatchEventMouse(e) }))), tu.hasFeature(tu.Feature.EVENT_KEYBOARD)) { var s = t._eventKeyboardList; n.on("keydown", (function (e) { t._dispatchOrPushEvent(e, s) })), n.on("key-pressing", (function (e) { t._dispatchOrPushEvent(e, s) })), n.on("keyup", (function (e) { t._dispatchOrPushEvent(e, s) })) } if (tu.hasFeature(tu.Feature.EVENT_ACCELEROMETER)) { var a = t._eventAccelerationList; t._accelerometerInput.on("devicemotion", (function (e) { t._dispatchOrPushEvent(e, a) })) } if (tu.hasFeature(tu.Feature.EVENT_GAMEPAD)) { var o = t._eventGamepadList; OD._on("gamepad-change", (function (e) { t._dispatchOrPushEvent(e, o) })), OD._on("gamepad-input", (function (e) { t._dispatchOrPushEvent(e, o) })), OD._on("handle-pose-input", (function (e) { t._dispatchOrPushEvent(e, o) })) } if (tu.hasFeature(tu.Feature.EVENT_HANDLE)) { var u = t._eventHandleList; r._on("handle-input", (function (e) { t._dispatchOrPushEvent(e, u) })), r._on("handle-pose-input", (function (e) { t._dispatchOrPushEvent(e, u) })) } if (tu.hasFeature(tu.Feature.EVENT_HMD)) { var h = t._eventHMDList; t._hmdInput._on("hmd-pose-input", (function (e) { t._dispatchOrPushEvent(e, h) })) } if (tu.hasFeature(tu.Feature.EVENT_HANDHELD)) { var c = t._eventHandheldList; t._handheldInput._on("handheld-pose-input", (function (e) { t._dispatchOrPushEvent(e, c) })) } }, e._clearEvents = function () { this._eventKeyboardList.length = 0, this._eventAccelerationList.length = 0, this._eventGamepadList.length = 0, this._eventHandleList.length = 0, this._eventHMDList.length = 0 }, e._dispatchOrPushEvent = function (t) { this._emitEvent(t) }, e._dispatchEventMouse = function (t) { this._emitEvent(t) }, e._dispatchEventTouch = function (t) { for (var e = t.getTouches(), i = e.length, n = 0; n < i; ++n)t.touch = e[n], t.propagationStopped = t.propagationImmediateStopped = !1, this._emitEvent(t) }, e._frameDispatchEvents = function () { }, t }()); KD.EventType = { TOUCH_START: "touch-start", TOUCH_MOVE: "touch-move", TOUCH_END: "touch-end", TOUCH_CANCEL: "touch-cancel", MOUSE_DOWN: "mouse-down", MOUSE_MOVE: "mouse-move", MOUSE_UP: "mouse-up", MOUSE_LEAVE: "mouse-leave-window", MOUSE_ENTER: "mouse-enter-window", MOUSE_WHEEL: "mouse-wheel", KEY_DOWN: "keydown", KEY_PRESSING: "key-pressing", KEY_UP: "keyup", DEVICEMOTION: "devicemotion", GAMEPAD_INPUT: "gamepad-input", GAMEPAD_CHANGE: "gamepad-change", HANDLE_INPUT: "handle-input", HANDLE_POSE_INPUT: "handle-pose-input", HMD_POSE_INPUT: "hmd-pose-input", HANDHELD_POSE_INPUT: "handheld-pose-input" }; var QD = t("input", new KD), ZD = t("SystemEvent", function (t) { function e() { var e; return e = t.call(this) || this, QD.on("mouse-down", (function (t) { e.emit("mouse-down", t) })), QD.on("mouse-move", (function (t) { e.emit("mouse-move", t) })), QD.on("mouse-up", (function (t) { e.emit("mouse-up", t) })), QD.on("mouse-wheel", (function (t) { e.emit("mouse-wheel", t) })), QD.on("touch-start", (function (t) { e.emit("touch-start", t.touch, t) })), QD.on("touch-move", (function (t) { e.emit("touch-move", t.touch, t) })), QD.on("touch-end", (function (t) { e.emit("touch-end", t.touch, t) })), QD.on("touch-cancel", (function (t) { e.emit("touch-cancel", t.touch, t) })), QD.on("keydown", (function (t) { e.emit("keydown", t) })), QD.on("key-pressing", (function (t) { e.emit("keydown", t) })), QD.on("keyup", (function (t) { e.emit("keyup", t) })), QD.on("devicemotion", (function (t) { e.emit("devicemotion", t) })), e } s(e, t); var i = e.prototype; return i.setAccelerometerEnabled = function (t) { QD.setAccelerometerEnabled(t) }, i.setAccelerometerInterval = function (t) { QD.setAccelerometerInterval(t) }, i.on = function (e, i, n, r) { return t.prototype.on.call(this, e, i, n, r), i }, i.off = function (e, i, n) { t.prototype.off.call(this, e, i, n) }, e }(wo)); ZD.EventType = Vv, S.SystemEvent = ZD; var JD = t("systemEvent", new ZD); S.systemEvent = JD, lt(Vv, "Node.EventType", [{ name: "POSITION_PART", newName: "TRANSFORM_CHANGED" }, { name: "ROTATION_PART", newName: "TRANSFORM_CHANGED" }, { name: "SCALE_PART", newName: "TRANSFORM_CHANGED" }]), lt(Pv, "Event", [{ name: "ACCELERATION", newName: "DEVICEMOTION", target: ZD.EventType, targetName: "SystemEvent.EventType" }]), dt(Pv, "Event", [{ name: "TOUCH", suggest: "please use SystemEvent.EventType.TOUCH_START, SystemEvent.EventType.TOUCH_MOVE, SystemEvent.EventType.TOUCH_END and SystemEvent.EventType.TOUCH_CANCEL instead" }, { name: "MOUSE", suggest: "please use SystemEvent.EventType.MOUSE_DOWN, SystemEvent.EventType.MOUSE_MOVE, SystemEvent.EventType.MOUSE_UP, SystemEvent.EventType.MOUSE_WHEEL, Node.EventType.MOUSE_ENTER and Node.EventType.MOUSE_LEAVE instead" }, { name: "KEYBOARD", suggest: "please use SystemEvent.EventType.KEY_DOWN and SystemEvent.EventType.KEY_UP instead" }]), lt(Ov, "EventMouse", ["DOWN", "UP", "MOVE"].map((function (t) { return { name: t, newName: "MOUSE_" + t, target: ZD.EventType, targetName: "SystemEvent.EventType" } }))), lt(Ov, "EventMouse", [{ name: "SCROLL", newName: "MOUSE_WHEEL", target: ZD.EventType, targetName: "SystemEvent.EventType" }]), dt(Ov.prototype, "EventMouse.prototype", [{ name: "eventType", suggest: "please use EventMouse.prototype.type instead" }]), lt(Fv, "EventTouch", [{ name: "BEGAN", newName: "TOUCH_START", target: ZD.EventType, targetName: "SystemEvent.EventType" }]), lt(Fv, "EventTouch", [{ name: "MOVED", newName: "TOUCH_MOVE", target: ZD.EventType, targetName: "SystemEvent.EventType" }]), lt(Fv, "EventTouch", [{ name: "ENDED", newName: "TOUCH_END", target: ZD.EventType, targetName: "SystemEvent.EventType" }]), lt(Fv, "EventTouch", [{ name: "CANCELLED", newName: "TOUCH_CANCEL", target: ZD.EventType, targetName: "SystemEvent.EventType" }]), dt(Fv.prototype, "EventTouch.prototype", [{ name: "getEventCode", suggest: "please use EventTouch.prototype.type instead" }]), lt(Fv.prototype, "EventTouch.prototype", [{ name: "getUILocationInView", newName: "getLocationInView", target: Fv, targetName: "EventTouch" }]), dt(Le.KEY, "macro.KEY", ["back", "menu", "0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "0", "*", "+", "-", "/", ";", "=", ",", ".", "[", "]", "dpadLeft", "dpadRight", "dpadUp", "dpadDown", "dpadCenter"].map((function (t) { return { name: t } }))), dt(Le.KEY, "macro.KEY", [{ name: "shift", suggest: "please use KeyCode.SHIFT_LEFT instead" }]), dt(Le.KEY, "macro.KEY", [{ name: "ctrl", suggest: "please use KeyCode.CTRL_LEFT instead" }]), dt(Le.KEY, "macro.KEY", [{ name: "alt", suggest: "please use KeyCode.ALT_LEFT instead" }]), dt(Le, "macro", [{ name: "KEY", suggest: "please use KeyCode instead" }]); var $D = t("DebugView", function () { function t() { this._singleMode = 0, this._compositeModeValue = 0, this._lightingWithAlbedo = !0, this._csmLayerColoration = !1, this._activate() } var e = t.prototype; return e.isCompositeModeEnabled = function (t) { return !!(this._compositeModeValue & 1 << t) }, e.enableCompositeMode = function (t, e) { this._enableCompositeMode(t, e), this._updatePipeline() }, e.enableAllCompositeMode = function (t) { this._enableAllCompositeMode(t), this._updatePipeline() }, e.isEnabled = function () { return 0 !== this._getType() }, e.reset = function () { this._activate(), this._updatePipeline() }, e._activate = function () { this._singleMode = 0, this._enableAllCompositeMode(!0), this._lightingWithAlbedo = !0, this._csmLayerColoration = !1 }, e._updatePipeline = function () { var t = S.director.root, e = t.pipeline, i = this._getType(); e.macros.CC_USE_DEBUG_VIEW !== i && (e.macros.CC_USE_DEBUG_VIEW = i, t.onGlobalPipelineStateChanged()) }, e._enableCompositeMode = function (t, e) { e ? this._compositeModeValue |= 1 << t : this._compositeModeValue &= ~(1 << t) }, e._enableAllCompositeMode = function (t) { for (var e = 0; e < 17; e++)t ? this._compositeModeValue |= 1 << e : this._compositeModeValue &= ~(1 << e) }, e._getType = function () { if (0 !== this._singleMode) return 1; if (!0 !== this._lightingWithAlbedo || !1 !== this._csmLayerColoration) return 2; for (var t = 0; t < 17; t++)if (!this.isCompositeModeEnabled(t)) return 2; return 0 }, n(t, [{ key: "singleMode", get: function () { return this._singleMode }, set: function (t) { this._singleMode = t, this._updatePipeline() } }, { key: "lightingWithAlbedo", get: function () { return this._lightingWithAlbedo }, set: function (t) { this._lightingWithAlbedo = t, this._updatePipeline() } }, { key: "csmLayerColoration", get: function () { return this._csmLayerColoration }, set: function (t) { this._csmLayerColoration = t, this._updatePipeline() } }, { key: "debugViewType", get: function () { return this._getType() } }]), t }()), tR = { VERTICAL: 0, HORIZONTAL: 1 }, eR = { ORTHO: 0, PERSPECTIVE: 1 }, iR = { F1_8: 0, F2_0: 1, F2_2: 2, F2_5: 3, F2_8: 4, F3_2: 5, F3_5: 6, F4_0: 7, F4_5: 8, F5_0: 9, F5_6: 10, F6_3: 11, F7_1: 12, F8_0: 13, F9_0: 14, F10_0: 15, F11_0: 16, F13_0: 17, F14_0: 18, F16_0: 19, F18_0: 20, F20_0: 21, F22_0: 22 }, nR = { ISO100: 0, ISO200: 1, ISO400: 2, ISO800: 3 }, rR = { D1: 0, D2: 1, D4: 2, D8: 3, D15: 4, D30: 5, D60: 6, D125: 7, D250: 8, D500: 9, D1000: 10, D2000: 11, D4000: 12 }, sR = [1.8, 2, 2.2, 2.5, 2.8, 3.2, 3.5, 4, 4.5, 5, 5.6, 6.3, 7.1, 8, 9, 10, 11, 13, 14, 16, 18, 20, 22], aR = [1, .5, 1 / 4, 1 / 8, 1 / 15, 1 / 30, 1 / 60, .008, .004, .002, .001, 5e-4, 1 / 4e3], oR = [100, 200, 400, 800], uR = Qn(), hR = Qn(), cR = jr(), lR = [], fR = 0, dR = function () { function t(t) { if (this.isWindowSize = !0, this.screenScale = 1, this.postProcess = null, this.usePostProcess = !1, this.pipeline = "", this.pipelineSettings = null, this._scene = null, this._node = null, this._name = null, this._enabled = !1, this._proj = -1, this._aspect = 1, this._orthoHeight = 10, this._fovAxis = 0, this._fov = Ki(45), this._nearClip = 1, this._farClip = 1e3, this._clearColor = new Xd(.2, .2, .2, 1), this._viewport = ds(0, 0, 1, 1), this._orientedViewport = ds(0, 0, 1, 1), this._curTransform = 0, this._isProjDirty = !0, this._matView = jr(), this._matProj = jr(), this._matProjInv = jr(), this._matViewProj = jr(), this._matViewProjInv = jr(), this._frustum = new yu, this._forward = Qn(), this._position = Qn(), this._priority = 0, this._aperture = 19, this._shutter = 7, this._shutterValue = 0, this._iso = 0, this._isoValue = 0, this._window = null, this._width = 1, this._height = 1, this._clearFlag = 0, this._clearDepth = 1, this._visibility = yw, this._exposure = 0, this._clearStencil = 0, this._geometryRenderer = null, this._windowId = 0, this._cameraType = -1, this._trackingType = 0, this._usage = 100, this._cameraId = fR++, this._device = t, this._apertureValue = sR[this._aperture], this._shutterValue = aR[this._shutter], this._isoValue = oR[this._iso], this._frustum.accurate = !0, !lR.length) { var e = t.capabilities.clipSpaceSignY; lR[0] = new Gr(1, 0, 0, 0, 0, e), lR[1] = new Gr(0, 1, 0, 0, -e, 0), lR[2] = new Gr(-1, 0, 0, 0, 0, -e), lR[3] = new Gr(0, -1, 0, 0, e, 0) } } var e = t.prototype; return e._updateAspect = function (t) { if (void 0 === t && (t = !0), this._aspect = this.window.width * this._viewport.width / (this.window.height * this._viewport.height), t) { var e = this.window.swapchain; (e && e.surfaceTransform || 0) % 2 && (this._aspect = 1 / this._aspect) } this._isProjDirty = !0 }, e.initialize = function (t) { void 0 !== t.usage ? this._usage = t.usage : this.setDefaultUsage(), void 0 !== t.trackingType && (this._trackingType = t.trackingType), void 0 !== t.cameraType && (this._cameraType = t.cameraType), this.node = t.node, this._width = 1, this._height = 1, this.clearFlag = 0, this.clearDepth = 1, this.visibility = yw, this._name = t.name, this._proj = t.projection, this._priority = t.priority || 0, this._aspect = this.screenScale = 1, this.updateExposure(), this.changeTargetWindow(t.window) }, e.destroy = function () { var t; this._node = null, this.detachFromScene(), this._window && (this._window.detachCamera(this), this.window = null), this._name = null, null == (t = this._geometryRenderer) || t.destroy() }, e.attachToScene = function (t) { this._enabled = !0, this._scene = t }, e.detachFromScene = function () { this._enabled = !1, this._scene = null }, e.resize = function (t, e) { this._window && (this._width = t, this._height = e, this._aspect = t * this._viewport.width / (e * this._viewport.height), this._isProjDirty = !0) }, e.setFixedSize = function (t, e) { this._width = t, this._height = e, this._updateAspect(), this.isWindowSize = !1 }, e.syncCameraEditor = function () { }, e.update = function (t) { var e; if (void 0 === t && (t = !1), this._node) { var i = !1, n = this._forward, r = this._matView, s = this._matProj; (this._node.hasChangedFlags || t) && (Gr.invert(r, this._node.worldMatrix), n.x = -r.m02, n.y = -r.m06, n.z = -r.m10, Gr.multiply(r, (new Gr).scale(this._node.worldScale), r), this._node.getWorldPosition(this._position), i = !0); var a = null == (e = this.window) ? void 0 : e.swapchain, o = a && a.surfaceTransform || 0; if (this._isProjDirty || this._curTransform !== o) { this._curTransform = o; var u = this._device.capabilities.clipSpaceSignY; if (1 === this._proj) Gr.perspective(s, this._fov, this._aspect, this._nearClip, this._farClip, 0 === this._fovAxis, this._device.capabilities.clipSpaceMinZ, u, o); else { var h = this._orthoHeight * this._aspect, c = this._orthoHeight; Gr.ortho(s, -h, h, -c, c, this._nearClip, this._farClip, this._device.capabilities.clipSpaceMinZ, u, o) } Gr.invert(this._matProjInv, s), i = !0, this._isProjDirty = !1 } i && (Gr.multiply(this._matViewProj, s, r), Gr.invert(this._matViewProjInv, this._matViewProj), this._frustum.update(this._matViewProj, this._matViewProjInv)) } }, e.setViewportInOrientedSpace = function (t) { var e, i = t.x, n = t.width, r = t.height, s = this._device.capabilities.screenSpaceSignY < 0 ? 1 - t.y - r : t.y, a = null == (e = this.window) ? void 0 : e.swapchain; switch (a && a.surfaceTransform || 0) { case 1: this._viewport.x = 1 - s - r, this._viewport.y = i, this._viewport.width = r, this._viewport.height = n; break; case 2: this._viewport.x = 1 - i - n, this._viewport.y = 1 - s - r, this._viewport.width = n, this._viewport.height = r; break; case 3: this._viewport.x = s, this._viewport.y = 1 - i - n, this._viewport.width = r, this._viewport.height = n; break; case 0: this._viewport.x = i, this._viewport.y = s, this._viewport.width = n, this._viewport.height = r }this._orientedViewport.x = i, this._orientedViewport.y = s, this._orientedViewport.width = n, this._orientedViewport.height = r, this.resize(this.width, this.height) }, e.initGeometryRenderer = function () { if (!this._geometryRenderer) { var t, e = S.internal.GeometryRenderer; this._geometryRenderer = e ? new e : null, null == (t = this._geometryRenderer) || t.activate(this._device) } }, e.changeTargetWindow = function (t) { void 0 === t && (t = null), this._window && this._window.detachCamera(this); var e = t || S.director.root.mainWindow; if (e) { e.attachCamera(this), this.window = e; var i = e.swapchain; (i && i.surfaceTransform || 0) % 2 ? this.resize(e.height, e.width) : this.resize(e.width, e.height) } }, e.detachCamera = function () { this._window && this._window.detachCamera(this) }, e.screenPointToRay = function (t, e, i) { if (!this._node) return null; var n = this.width, r = this.height, s = this._orientedViewport.x * n, a = this._orientedViewport.y * r, o = this._orientedViewport.width * n, u = this._orientedViewport.height * r, h = 1 === this._proj, c = this._device.capabilities.clipSpaceSignY, l = Lr[this._curTransform]; Kn.set(uR, (e - s) / o * 2 - 1, (i - a) / u * 2 - 1, h ? 1 : -1); var f = uR.x, d = uR.y; return uR.x = f * l[0] + d * l[2] * c, uR.y = f * l[1] + d * l[3] * c, Kn.transformMat4(h ? uR : t.o, uR, this._matViewProjInv), h ? (this._node.getWorldPosition(hR), Rs.fromPoints(t, hR, uR)) : Kn.transformQuat(t.d, Kn.FORWARD, this._node.worldRotation), t }, e.screenToWorld = function (t, e) { var i = this.width, n = this.height, r = this._orientedViewport.x * i, s = this._orientedViewport.y * n, a = this._orientedViewport.width * i, o = this._orientedViewport.height * n, u = this._device.capabilities.clipSpaceSignY, h = Lr[this._curTransform]; if (1 === this._proj) { Kn.set(t, (e.x - r) / a * 2 - 1, (e.y - s) / o * 2 - 1, 1); var c = t.x, l = t.y; t.x = c * h[0] + l * h[2] * u, t.y = c * h[1] + l * h[3] * u, Kn.transformMat4(t, t, this._matViewProjInv), this._node && this._node.getWorldPosition(uR), Kn.lerp(t, uR, t, Yi(this._nearClip / this._farClip, 1, e.z)) } else { Kn.set(t, (e.x - r) / a * 2 - 1, (e.y - s) / o * 2 - 1, 2 * e.z - 1); var f = t.x, d = t.y; t.x = f * h[0] + d * h[2] * u, t.y = f * h[1] + d * h[3] * u, Kn.transformMat4(t, t, this._matViewProjInv) } return t }, e.worldToScreen = function (t, e) { var i = this._device.capabilities.clipSpaceSignY, n = Lr[this._curTransform]; Kn.transformMat4(t, e, this._matViewProj); var r = t.x, s = t.y; t.x = r * n[0] + s * n[2] * i, t.y = r * n[1] + s * n[3] * i; var a = this.width, o = this.height, u = this._orientedViewport.x * a, h = this._orientedViewport.y * o, c = this._orientedViewport.width * a, l = this._orientedViewport.height * o; return t.x = u + .5 * (t.x + 1) * c, t.y = h + .5 * (t.y + 1) * l, t.z = .5 * t.z + .5, t }, e.worldMatrixToScreen = function (t, e, i, n) { Gr.multiply(t, this._matViewProj, e), Gr.multiply(t, lR[this._curTransform], t); var r = i / 2, s = n / 2; return Gr.identity(cR), Gr.transform(cR, cR, Kn.set(uR, r, s, 0)), Gr.scale(cR, cR, Kn.set(uR, r, s, 1)), Gr.multiply(t, cR, t), t }, e.calculateObliqueMat = function (t) { var e = new Pn(Math.sign(t.x), Math.sign(t.y), 1, 1).transformMat4(this._matProjInv), i = new Pn(this._matProj.m03, this._matProj.m07, this._matProj.m11, this._matProj.m15), n = 2 / Pn.dot(t, e), r = t.multiplyScalar(n).subtract(i); this._matProj.m02 = r.x, this._matProj.m06 = r.y, this._matProj.m10 = r.z, this._matProj.m14 = r.w }, e.getClipSpaceMinz = function () { return this._device.capabilities.clipSpaceMinZ }, e.setExposure = function (t) { this._exposure = .833333 / Math.pow(2, t) }, e.updateExposure = function () { var t = Math.log2(this._apertureValue * this._apertureValue / this._shutterValue * 100 / this._isoValue); this.setExposure(t) }, e.setDefaultUsage = function () { this._usage = 100 }, n(t, [{ key: "name", get: function () { return this._name } }, { key: "scene", get: function () { return this._scene } }, { key: "node", get: function () { return this._node }, set: function (t) { this._node = t } }, { key: "systemWindowId", get: function () { return this._windowId } }, { key: "window", get: function () { return this._window }, set: function (t) { this._window = t } }, { key: "enabled", get: function () { return this._enabled }, set: function (t) { this._enabled = t } }, { key: "visibility", get: function () { return this._visibility }, set: function (t) { this._visibility = t } }, { key: "priority", get: function () { return this._priority }, set: function (t) { this._priority = t } }, { key: "width", get: function () { return this._width } }, { key: "height", get: function () { return this._height } }, { key: "position", get: function () { return this._position }, set: function (t) { this._position = t } }, { key: "forward", get: function () { return this._forward }, set: function (t) { this._forward = t } }, { key: "aperture", get: function () { return this._aperture }, set: function (t) { this._aperture = t, this._apertureValue = sR[this._aperture], this.updateExposure() } }, { key: "apertureValue", get: function () { return this._apertureValue } }, { key: "shutter", get: function () { return this._shutter }, set: function (t) { this._shutter = t, this._shutterValue = aR[this._shutter], this.updateExposure() } }, { key: "shutterValue", get: function () { return this._shutterValue } }, { key: "iso", get: function () { return this._iso }, set: function (t) { this._iso = t, this._isoValue = oR[this._iso], this.updateExposure() } }, { key: "isoValue", get: function () { return this._isoValue } }, { key: "exposure", get: function () { return this._exposure } }, { key: "clearFlag", get: function () { return this._clearFlag }, set: function (t) { this._clearFlag = t } }, { key: "clearColor", get: function () { return this._clearColor }, set: function (t) { this._clearColor.x = t.x, this._clearColor.y = t.y, this._clearColor.z = t.z, this._clearColor.w = t.w } }, { key: "clearDepth", get: function () { return this._clearDepth }, set: function (t) { this._clearDepth = t } }, { key: "clearStencil", get: function () { return this._clearStencil }, set: function (t) { this._clearStencil = t } }, { key: "projectionType", get: function () { return this._proj }, set: function (t) { this._proj = t, this._isProjDirty = !0 } }, { key: "aspect", get: function () { return this._aspect } }, { key: "orthoHeight", get: function () { return this._orthoHeight }, set: function (t) { this._orthoHeight = t, this._isProjDirty = !0 } }, { key: "fovAxis", get: function () { return this._fovAxis }, set: function (t) { this._fovAxis = t, this._isProjDirty = !0 } }, { key: "fov", get: function () { return this._fov }, set: function (t) { this._fov = t, this._isProjDirty = !0 } }, { key: "nearClip", get: function () { return this._nearClip }, set: function (t) { this._nearClip = t, this._isProjDirty = !0 } }, { key: "farClip", get: function () { return this._farClip }, set: function (t) { this._farClip = t, this._isProjDirty = !0 } }, { key: "viewport", get: function () { return this._viewport }, set: function (t) { it(8302), this.setViewportInOrientedSpace(t) } }, { key: "frustum", get: function () { return this._frustum }, set: function (t) { this._frustum = t } }, { key: "matView", get: function () { return this._matView } }, { key: "matProj", get: function () { return this._matProj } }, { key: "matProjInv", get: function () { return this._matProjInv } }, { key: "matViewProj", get: function () { return this._matViewProj } }, { key: "matViewProjInv", get: function () { return this._matViewProjInv } }, { key: "cameraId", get: function () { return this._cameraId } }, { key: "surfaceTransform", get: function () { return this._curTransform } }, { key: "geometryRenderer", get: function () { return this._geometryRenderer } }, { key: "cameraType", get: function () { return this._cameraType }, set: function (t) { this._cameraType = t } }, { key: "trackingType", get: function () { return this._trackingType }, set: function (t) { this._trackingType = t } }, { key: "cameraUsage", get: function () { return this._usage }, set: function (t) { this._usage = t } }], [{ key: "standardExposureValue", get: function () { return 1 / 38400 } }, { key: "standardLightMeterScale", get: function () { return 1e4 } }]), t }(), pR = new Dp(null), _R = function () { function t() { this._device = null, this._passes = null, this._shaders = null, this._subMesh = null, this._patches = null, this._priority = 128, this._inputAssembler = null, this._descriptorSet = null, this._worldBoundDescriptorSet = null, this._instancedAttributeBlock = { buffer: null, views: [], attributes: [] }, this._instancedWorldMatrixIndex = -1, this._instancedSHIndex = -1, this._useReflectionProbeType = 0 } var e = t.prototype; return e.initialize = function (t, e, i) { void 0 === i && (i = null), S.director.root, this._device = B_.gfxDevice, pR.layout = e[0].localSetLayout, this._inputAssembler = this._device.createInputAssembler(t.iaInfo), this._descriptorSet = this._device.createDescriptorSet(pR); var n = S.director.root.pipeline.pipelineSceneData.getOcclusionQueryPass(); if (n) { var r = new Dp(null); r.layout = n.localSetLayout, this._worldBoundDescriptorSet = this._device.createDescriptorSet(r) } this._subMesh = t, this._patches = i ? i.sort() : null, this._passes = e, this._flushPassInfo(), this.priority = 128 }, e.destroy = function () { this._descriptorSet.destroy(), this._descriptorSet = null, this._inputAssembler.destroy(), this._inputAssembler = null, this._worldBoundDescriptorSet && this._worldBoundDescriptorSet.destroy(), this._worldBoundDescriptorSet = null, this.priority = 128, this._patches = null, this._subMesh = null, this._passes = null, this._shaders = null }, e.update = function () { for (var t = 0; t < this._passes.length; ++t)this._passes[t].update(); this._descriptorSet.update(), this._worldBoundDescriptorSet && this._worldBoundDescriptorSet.update() }, e._updatePasses = function () { var t = this._passes; t && (t.forEach((function (t) { t.beginChangeStatesSilently(), t.tryCompile(), t.endChangeStatesSilently() })), this._flushPassInfo()) }, e.onPipelineStateChanged = function () { this._updatePasses() }, e.onMacroPatchesStateChanged = function (t) { (t || this._patches) && (t && (t = t.sort(), this._patches && t.length === this._patches.length && JSON.stringify(t) === JSON.stringify(this._patches)) || (this._patches = t, this._updatePasses())) }, e.onGeometryChanged = function () { if (this._subMesh) { var t = this._subMesh.drawInfo; if (this._inputAssembler && t) { var e = this._inputAssembler.drawInfo; Object.keys(t).forEach((function (i) { e[i] = t[i] })), this._inputAssembler.drawInfo = e } } }, e.getInstancedAttributeIndex = function (t) { for (var e = this.instancedAttributeBlock.attributes, i = 0; i < e.length; i++)if (e[i].name === t) return i; return -1 }, e.updateInstancedWorldMatrix = function (t, e) { var i = this.instancedAttributeBlock.views, n = i[e], r = i[e + 1], s = i[e + 2]; n[0] = t.m00, n[1] = t.m01, n[2] = t.m02, n[3] = t.m12, r[0] = t.m04, r[1] = t.m05, r[2] = t.m06, r[3] = t.m13, s[0] = t.m08, s[1] = t.m09, s[2] = t.m10, s[3] = t.m14 }, e.updateInstancedSH = function (t, e) { for (var i = this.instancedAttributeBlock.views, n = 0, r = e; r < e + 3; r++)for (var s = 0; s < 4; s++)i[r][s] = t[n++] }, e.UpdateInstancedAttributes = function (t) { this.instancedWorldMatrixIndex = -1, this.instancedSHIndex = -1; var e = this.passes[0]; if (e.device.hasFeature(1)) { for (var i = 0, n = 0; n < t.length; n++) { var r = t[n]; r.isInstanced && (i += Wp[r.format].size) } var s = this.instancedAttributeBlock; s.buffer = new Uint8Array(i), s.views.length = s.attributes.length = 0; for (var a = 0, o = 0; o < t.length; o++) { var u = t[o]; if (u.isInstanced) { var h = new pp; h.format = u.format, h.name = u.name, h.isNormalized = u.isNormalized, h.location = u.location, s.attributes.push(h); var c = Wp[u.format], l = new ($p(c))(s.buffer.buffer, a, c.count); s.views.push(l), a += c.size } } 1 === e.batchingScheme && e.getInstancedBuffer().destroy(), this.instancedWorldMatrixIndex = this.getInstancedAttributeIndex(Tb), this.instancedSHIndex = this.getInstancedAttributeIndex(Ib) } }, e._flushPassInfo = function () { var t = this._passes; if (t) { this._shaders || (this._shaders = []), this._shaders.length = t.length; for (var e = 0, i = t.length; e < i; e++)this._shaders[e] = t[e].getShaderVariant(this.patches) } }, n(t, [{ key: "passes", get: function () { return this._passes }, set: function (t) { t.length > 8 ? rt(12004, 8) : (this._passes = t, this._flushPassInfo(), this._descriptorSet && (this._descriptorSet.destroy(), pR.layout = t[0].localSetLayout, this._descriptorSet = this._device.createDescriptorSet(pR))) } }, { key: "shaders", get: function () { return this._shaders } }, { key: "subMesh", get: function () { return this._subMesh }, set: function (t) { this._inputAssembler.destroy(), this._inputAssembler = this._device.createInputAssembler(t.iaInfo), this._subMesh = t } }, { key: "priority", get: function () { return this._priority }, set: function (t) { this._priority = t } }, { key: "inputAssembler", get: function () { return this._inputAssembler } }, { key: "descriptorSet", get: function () { return this._descriptorSet } }, { key: "worldBoundDescriptorSet", get: function () { return this._worldBoundDescriptorSet } }, { key: "patches", get: function () { return this._patches } }, { key: "instancedAttributeBlock", get: function () { return this._instancedAttributeBlock } }, { key: "instancedWorldMatrixIndex", get: function () { return this._instancedWorldMatrixIndex }, set: function (t) { this._instancedWorldMatrixIndex = t } }, { key: "instancedSHIndex", get: function () { return this._instancedSHIndex }, set: function (t) { this._instancedSHIndex = t } }, { key: "useReflectionProbeType", get: function () { return this._useReflectionProbeType }, set: function (t) { this._useReflectionProbeType = t } }]), t }(), gR = new Gr, mR = [{ name: "CC_RECEIVE_SHADOW", value: !0 }], vR = [{ name: "CC_USE_LIGHTMAP", value: 1 }], yR = [{ name: "CC_USE_LIGHTMAP", value: 2 }], bR = [{ name: "CC_LIGHT_MAP_VERSION", value: 2 }], wR = [{ name: "CC_USE_LIGHT_PROBE", value: !0 }], xR = new rp(2, 2, 0, 2, 2, 2), SR = new rp(2, 2, 2, 2, 2, 2), TR = function () { function t() { this.type = 0, this.scene = null, this.isDynamicBatching = !1, this._worldBounds = null, this._modelBounds = null, this._subModels = [], this._node = null, this._transform = null, this._inited = !1, this._descriptorSetCount = 1, this._updateStamp = -1, this._localDataUpdated = !0, this._localData = new Float32Array(56), this._localBuffer = null, this._localSHData = null, this._localSHBuffer = null, this._lightmap = null, this._lightmapUVParam = Bn(), this._tetrahedronIndex = -1, this._lastWorldBoundCenter = Qn(1 / 0, 1 / 0, 1 / 0), this._useLightProbe = !1, this._worldBoundBuffer = null, this._receiveShadow = !1, this._castShadow = !1, this._receiveDirLight = !0, this._shadowBias = 0, this._shadowNormalBias = 0, this._reflectionProbeId = -1, this._reflectionProbeBlendId = -1, this._reflectionProbeBlendWeight = 0, this._enabled = !0, this._visFlags = Iv.Enum.NONE, this._priority = 0, this._bakeToReflectionProbe = !0, this._reflectionProbeType = 0, this._device = B_.gfxDevice } var e = t.prototype; return e.initialize = function () { this._inited || (this._receiveShadow = !0, this.castShadow = !1, this.enabled = !0, this.visFlags = Iv.Enum.NONE, this._inited = !0, this._bakeToReflectionProbe = !0, this._reflectionProbeType = 0) }, e.destroy = function () { for (var t = this._subModels, e = 0; e < t.length; e++)this._subModels[e].destroy(); this._localBuffer && (this._localBuffer.destroy(), this._localBuffer = null), this._localSHBuffer && (this._localSHBuffer.destroy(), this._localSHBuffer = null), this._worldBoundBuffer && (this._worldBoundBuffer.destroy(), this._worldBoundBuffer = null), this._worldBounds = null, this._modelBounds = null, this._subModels.length = 0, this._inited = !1, this._localDataUpdated = !0, this._transform = null, this._node = null, this.isDynamicBatching = !1 }, e.attachToScene = function (t) { this.scene = t, this._localDataUpdated = !0 }, e.detachFromScene = function () { this.scene = null }, e.updateTransform = function () { var t = this.transform; if (t.hasChangedFlags || t.isTransformDirty()) { t.updateWorldTransform(), this._localDataUpdated = !0; var e = this._worldBounds; this._modelBounds && e && this._modelBounds.transform(t._mat, t._pos, t._rot, t._scale, e) } }, e.updateWorldBound = function () { var t = this.transform; if (null !== t) { t.updateWorldTransform(), this._localDataUpdated = !0; var e = this._worldBounds; this._modelBounds && e && this._modelBounds.transform(t._mat, t._pos, t._rot, t._scale, e) } }, e.updateUBOs = function (t) { for (var e = this._subModels, i = 0; i < e.length; i++)e[i].update(); this._updateStamp = t, this.updateSHUBOs(); var n = this.node.scene.globals.shadows, r = n.enabled && n.type === vT.Planar; if (this._localDataUpdated) { this._localDataUpdated = !1; for (var s = this.transform._mat, a = !1, o = 0; o < e.length; o++) { var u = e[o], h = u.instancedWorldMatrixIndex; h >= 0 ? u.updateInstancedWorldMatrix(s, h) : a = !0 } (a || r) && this._localBuffer && (Gr.toArray(this._localData, s, 0), Gr.invert(gR, s), Gr.transpose(gR, gR), Gr.toArray(this._localData, gR, 16), this._localBuffer.update(this._localData)) } }, e.invalidateLocalData = function () { this._localDataUpdated = !0 }, e.showTetrahedron = function () { return this.isLightProbeAvailable() }, e.isLightProbeAvailable = function () { if (!this._useLightProbe) return !1; var t = Uy().lightProbes; return !(!t || t.empty() || !this._worldBounds) }, e.updateSHBuffer = function () { if (this._localSHData) { for (var t = this._subModels, e = !1, i = 0; i < t.length; i++) { var n = t[i], r = n.instancedSHIndex; r >= 0 ? n.updateInstancedSH(this._localSHData, r) : e = !0 } e && this._localSHBuffer && this._localSHBuffer.update(this._localSHData) } }, e.clearSHUBOs = function () { if (this._localSHData) { for (var t = 0; t < 28; t++)this._localSHData[t] = 0; this.updateSHBuffer() } }, e.updateSHUBOs = function () { if (this.isLightProbeAvailable()) { var t = this._worldBounds.center; if (!t.equals(this._lastWorldBoundCenter, Hi)) { var e = [], i = new Pn, n = S.director.root.pipeline.pipelineSceneData.lightProbes; if (this._lastWorldBoundCenter.set(t), this._tetrahedronIndex = n.data.getInterpolationWeights(t, this._tetrahedronIndex, i), n.data.getInterpolationSHCoefficients(this._tetrahedronIndex, i, e) && this._localSHData) { var r = S.internal.SH; r.reduceRinging(e, n.reduceRinging), r.updateUBOData(this._localSHData, 0, e), this.updateSHBuffer() } } } }, e.createBoundingShape = function (t, e) { t && e && (this._modelBounds || (this._modelBounds = hu.create()), this._worldBounds || (this._worldBounds = hu.create()), hu.fromPoints(this._modelBounds, t, e), this._worldBounds.copy(this._modelBounds)) }, e._createSubModel = function () { return new _R }, e.initSubModel = function (t, e, i) { this.initialize(), null == this._subModels[t] ? this._subModels[t] = this._createSubModel() : this._subModels[t].destroy(), this._subModels[t].initialize(e, i.passes, this.getMacroPatches(t)), this._updateAttributesAndBinding(t) }, e.setSubModelMesh = function (t, e) { this._subModels[t] && (this._subModels[t].subMesh = e) }, e.setSubModelMaterial = function (t, e) { this._subModels[t] && (this._subModels[t].passes = e.passes, this._updateAttributesAndBinding(t)) }, e.onGlobalPipelineStateChanged = function () { for (var t = this._subModels, e = 0; e < t.length; e++)t[e].onPipelineStateChanged() }, e.onMacroPatchesStateChanged = function () { for (var t = this._subModels, e = 0; e < t.length; e++)t[e].onMacroPatchesStateChanged(this.getMacroPatches(e)) }, e.onGeometryChanged = function () { for (var t = this._subModels, e = 0; e < t.length; e++)t[e].onGeometryChanged() }, e.initLightingmap = function (t, e) { this._lightmap = t, this._lightmapUVParam = e }, e.updateLightingmap = function (t, e) { Pn.toArray(this._localData, e, 32), this._localDataUpdated = !0, this._lightmap = t, this._lightmapUVParam = e, this.onMacroPatchesStateChanged(), t || (t = YS.get("empty-texture")); var i = t.getGFXTexture(); if (i) for (var n = this._device.getSampler(t.mipmaps.length > 1 ? SR : xR), r = this._subModels, s = 0; s < r.length; s++) { var a = r[s].descriptorSet; a.bindTexture(Jb, i), a.bindSampler(Jb, n), a.update() } }, e.updateReflectionProbeCubemap = function (t) { this._localDataUpdated = !0, this.onMacroPatchesStateChanged(), t || (t = YS.get("default-cube-texture")); var e = t.getGFXTexture(); if (e) for (var i = this._device.getSampler(t.getSamplerInfo()), n = this._subModels, r = 0; r < n.length; r++) { var s = n[r].descriptorSet; s && (s.bindSampler(sw, i), s.bindTexture(sw, e), s.update()) } }, e.updateReflectionProbeBlendCubemap = function () { }, e.updateReflectionProbePlanarMap = function (t) { this._localDataUpdated = !0, this.onMacroPatchesStateChanged(); var e = this._device.getSampler(new rp(2, 2, 0, 2, 2, 2)); if (t || (t = YS.get("empty-texture").getGFXTexture()), t) for (var i = this._subModels, n = 0; n < i.length; n++) { var r = i[n].descriptorSet; r && (r.bindTexture(hw, t), r.bindSampler(hw, e), r.update()) } }, e.updateReflectionProbeDataMap = function (t) { this._localDataUpdated = !0, this.onMacroPatchesStateChanged(), t || (t = YS.get("empty-texture")); var e = t.getGFXTexture(); if (e) for (var i = this._subModels, n = 0; n < i.length; n++) { var r = i[n].descriptorSet; r && (r.bindTexture(15, e), r.bindSampler(15, t.getGFXSampler()), r.update()) } }, e.updateLocalShadowBias = function () { var t = this._localData; t[36] = this._shadowBias, t[37] = this._shadowNormalBias, this._localDataUpdated = !0 }, e.updateReflectionProbeId = function () { var t = this._localData; t[38] = this._reflectionProbeId, t[39] = this._reflectionProbeBlendId; var e = null, i = null; if (S.internal.reflectionProbeManager && (e = S.internal.reflectionProbeManager.getProbeById(this._reflectionProbeId), i = S.internal.reflectionProbeManager.getProbeById(this._reflectionProbeBlendId)), e) { if (1 === e.probeType) t[40] = e.node.up.x, t[41] = e.node.up.y, t[42] = e.node.up.z, t[43] = 1, t[44] = 1, t[45] = 0, t[46] = 0, t[47] = 1; else { t[40] = e.node.worldPosition.x, t[41] = e.node.worldPosition.y, t[42] = e.node.worldPosition.z, t[43] = 0, t[44] = e.size.x, t[45] = e.size.y, t[46] = e.size.z; var n = e.isRGBE() ? 1e3 : 0; t[47] = e.cubemap ? e.cubemap.mipmapLevel + n : 1 + n } if (3 === this._reflectionProbeType || 4 === this._reflectionProbeType) if (i) { t[48] = i.node.worldPosition.x, t[49] = i.node.worldPosition.y, t[50] = i.node.worldPosition.z, t[51] = this.reflectionProbeBlendWeight, t[52] = i.size.x, t[53] = i.size.y, t[54] = i.size.z; var r = i.isRGBE() ? 1e3 : 0; t[55] = i.cubemap ? i.cubemap.mipmapLevel + r : 1 + r } else 4 === this._reflectionProbeType && (t[51] = this.reflectionProbeBlendWeight) } this._localDataUpdated = !0 }, e.getMacroPatches = function () { var t = this.receiveShadow ? mR : null; if (null != this._lightmap && this.node && this.node.scene) { var e = this.node.scene.globals; if (!e.disableLightmap) { var i = e.bakedWithStationaryMainLight ? yR : vR; t = t ? t.concat(i) : i, e.bakedWithHighpLightmap && (t = t.concat(bR)) } } this._useLightProbe && (t = t ? t.concat(wR) : wR); var n = [{ name: "CC_USE_REFLECTION_PROBE", value: this._reflectionProbeType }]; t = t ? t.concat(n) : n; var r = [{ name: "CC_DISABLE_DIRECTIONAL_LIGHT", value: !this._receiveDirLight }]; return t ? t.concat(r) : r }, e._updateAttributesAndBinding = function (t) { var e = this._subModels[t]; if (e) { this._initLocalDescriptors(t), this._updateLocalDescriptors(t, e.descriptorSet), this._initLocalSHDescriptors(t), this._updateLocalSHDescriptors(t, e.descriptorSet), this._initWorldBoundDescriptors(t), e.worldBoundDescriptorSet && this._updateWorldBoundDescriptors(t, e.worldBoundDescriptorSet); var i = [], n = new Set; e.passes.forEach((function (t) { t.getShaderVariant(e.patches).attributes.forEach((function (t) { n.has(t.name) || (i.push(t), n.add(t.name)) })) })), this._updateInstancedAttributes(i, e) } }, e._updateInstancedAttributes = function (t, e) { e.UpdateInstancedAttributes(t), this._localDataUpdated = !0 }, e._initLocalDescriptors = function () { this._localBuffer || (this._localBuffer = this._device.createBuffer(new Zd(18, 1, 224, 224))) }, e._initLocalSHDescriptors = function () { this._useLightProbe && (this._localSHData || (this._localSHData = new Float32Array(28)), this._localSHBuffer || (this._localSHBuffer = this._device.createBuffer(new Zd(18, 1, 112, 112)))) }, e._initWorldBoundDescriptors = function () { this._worldBoundBuffer || (this._worldBoundBuffer = this._device.createBuffer(new Zd(18, 1, Sb.SIZE, Sb.SIZE))) }, e._updateLocalDescriptors = function (t, e) { this._localBuffer && e.bindBuffer(0, this._localBuffer) }, e._updateLocalSHDescriptors = function (t, e) { this._localSHBuffer && e.bindBuffer(6, this._localSHBuffer) }, e._updateWorldBoundDescriptors = function (t, e) { this._worldBoundBuffer && e.bindBuffer(Sb.BINDING, this._worldBoundBuffer) }, n(t, [{ key: "subModels", get: function () { return this._subModels } }, { key: "inited", get: function () { return this._inited } }, { key: "worldBounds", get: function () { return this._worldBounds } }, { key: "modelBounds", get: function () { return this._modelBounds } }, { key: "localBuffer", get: function () { return this._localBuffer } }, { key: "localSHBuffer", get: function () { return this._localSHBuffer } }, { key: "worldBoundBuffer", get: function () { return this._worldBoundBuffer } }, { key: "updateStamp", get: function () { return this._updateStamp } }, { key: "useLightProbe", get: function () { return this._useLightProbe }, set: function (t) { this._useLightProbe = t, this.onMacroPatchesStateChanged() } }, { key: "tetrahedronIndex", get: function () { return this._tetrahedronIndex }, set: function (t) { this._tetrahedronIndex = t } }, { key: "shadowBias", get: function () { return this._shadowBias }, set: function (t) { this._shadowBias = t } }, { key: "shadowNormalBias", get: function () { return this._shadowNormalBias }, set: function (t) { this._shadowNormalBias = t } }, { key: "receiveShadow", get: function () { return this._receiveShadow }, set: function (t) { this._receiveShadow = t, this.onMacroPatchesStateChanged() } }, { key: "castShadow", get: function () { return this._castShadow }, set: function (t) { this._castShadow = t } }, { key: "receiveDirLight", get: function () { return this._receiveDirLight }, set: function (t) { this._receiveDirLight = t, this.onMacroPatchesStateChanged() } }, { key: "node", get: function () { return this._node }, set: function (t) { this._node = t } }, { key: "transform", get: function () { return this._transform }, set: function (t) { this._transform = t } }, { key: "visFlags", get: function () { return this._visFlags }, set: function (t) { this._visFlags = t } }, { key: "enabled", get: function () { return this._enabled }, set: function (t) { this._enabled = t } }, { key: "priority", get: function () { return this._priority }, set: function (t) { this._priority = t } }, { key: "bakeToReflectionProbe", get: function () { return this._bakeToReflectionProbe }, set: function (t) { this._bakeToReflectionProbe = t } }, { key: "reflectionProbeType", get: function () { return this._reflectionProbeType }, set: function (t) { this._reflectionProbeType = t; for (var e = this._subModels, i = 0; i < e.length; i++)e[i].useReflectionProbeType = t; this.onMacroPatchesStateChanged() } }, { key: "reflectionProbeId", get: function () { return this._reflectionProbeId }, set: function (t) { this._reflectionProbeId = t } }, { key: "reflectionProbeBlendId", get: function () { return this._reflectionProbeBlendId }, set: function (t) { this._reflectionProbeBlendId = t } }, { key: "reflectionProbeBlendWeight", get: function () { return this._reflectionProbeBlendWeight }, set: function (t) { this._reflectionProbeBlendWeight = t } }]), t }(), IR = function () { function t() { this._enabled = !1, this._minPos = new Kn(0, 0, 0), this._maxPos = new Kn(0, 0, 0), this._depth = 0 } return t.prototype.initialize = function (t) { this._enabled = t.enabled, this._minPos = t.minPos, this._maxPos = t.maxPos, this._depth = t.depth }, n(t, [{ key: "enabled", get: function () { return this._enabled }, set: function (t) { this._enabled = t } }, { key: "minPos", get: function () { return this._minPos }, set: function (t) { this._minPos = t } }, { key: "maxPos", get: function () { return this._maxPos }, set: function (t) { this._maxPos = t } }, { key: "depth", get: function () { return this._depth }, set: function (t) { this._depth = t } }]), t }(), ER = function () { function t() { this._enabled = !0, this._blurRadius = .01, this._sssIntensity = 3 } return t.prototype.initialize = function (t) { this._enabled = t.enabled, this._blurRadius = t.blurRadius, this._sssIntensity = t.sssIntensity }, n(t, [{ key: "enabled", get: function () { return this._enabled }, set: function (t) { this._enabled = t } }, { key: "blurRadius", get: function () { return this._blurRadius }, set: function (t) { this._blurRadius = t } }, { key: "sssIntensity", get: function () { return this._sssIntensity }, set: function (t) { this._sssIntensity = t } }]), t }(); function AR(t, e) { e < 1e3 ? e = 1e3 : e > 15e3 && (e = 15e3); var i = e * e, n = (.860117757 + .000154118254 * e + 1.28641212e-7 * i) / (1 + .000842420235 * e + 7.08145163e-7 * i), r = (.317398726 + 422806245e-13 * e + 4.20481691e-8 * i) / (1 - 289741816e-13 * e + 1.61456053e-7 * i), s = 2 * n - 8 * r + 4, a = 3 * n / s, o = 2 * r / s, u = 1 / o * a, h = 1 / o * (1 - a - o); t.x = 3.2404542 * u - 1.5371385 + -.4985314 * h, t.y = -.969266 * u + 1.8760108 + .041556 * h, t.z = .0556434 * u - .2040259 + 1.0572252 * h } var CR, DR = function (t) { return 4 * Math.PI * Math.PI * t * t }, RR = function () { function t() { this._baked = !1, this._color = Qn(1, 1, 1), this._colorTemp = 6550, this._colorTempRGB = Qn(1, 1, 1), this._finalColor = Qn(1, 1, 1), this._scene = null, this._node = null, this._name = null, this._useColorTemperature = !1, this._type = 5, this._visibility = yw } var e = t.prototype; return e.initialize = function () { this.color = Qn(1, 1, 1), this.colorTemperature = 6550 }, e.attachToScene = function (t) { this._scene = t }, e.detachFromScene = function () { this._scene = null }, e.destroy = function () { this._name = null, this._node = null }, e.update = function () { }, n(t, [{ key: "baked", get: function () { return this._baked }, set: function (t) { this._baked = t } }, { key: "color", get: function () { return this._color }, set: function (t) { this._color.set(t), this._useColorTemperature && Kn.multiply(this._finalColor, this._color, this._colorTempRGB) } }, { key: "useColorTemperature", get: function () { return this._useColorTemperature }, set: function (t) { this._useColorTemperature = t, t && Kn.multiply(this._finalColor, this._color, this._colorTempRGB) } }, { key: "colorTemperature", get: function () { return this._colorTemp }, set: function (t) { this._colorTemp = t, AR(this._colorTempRGB, this._colorTemp), this._useColorTemperature && Kn.multiply(this._finalColor, this._color, this._colorTempRGB) } }, { key: "colorTemperatureRGB", get: function () { return this._colorTempRGB } }, { key: "finalColor", get: function () { return this._finalColor } }, { key: "visibility", get: function () { return this._visibility }, set: function (t) { this._visibility = t } }, { key: "node", get: function () { return this._node }, set: function (t) { this._node = t, this._node && (this._node.hasChangedFlags |= 2) } }, { key: "type", get: function () { return this._type } }, { key: "name", get: function () { return this._name }, set: function (t) { this._name = t } }, { key: "scene", get: function () { return this._scene } }]), t }(), PR = new Kn(0, 0, -1), BR = new Kn, MR = function (t) { function e() { var e; return (e = t.call(this) || this)._dir = new Kn(1, -1, -1), e._illuminanceHDR = eb.SUN_ILLUM, e._illuminanceLDR = 1, e._shadowEnabled = !1, e._shadowPcf = yT.HARD, e._shadowBias = 1e-5, e._shadowNormalBias = 0, e._shadowSaturation = 1, e._shadowDistance = 50, e._shadowInvisibleOcclusionRange = 200, e._csmLevel = bT.LEVEL_4, e._csmNeedUpdate = !1, e._csmLayerLambda = .75, e._csmOptimizationMode = wT.DisableRotationFix, e._csmLayersTransition = !1, e._csmTransitionRange = .05, e._shadowFixedArea = !1, e._shadowNear = .1, e._shadowFar = 10, e._shadowOrthoSize = 5, e._type = 0, e } s(e, t); var i = e.prototype; return i.initialize = function () { t.prototype.initialize.call(this), this.illuminance = eb.SUN_ILLUM, this.direction = new Kn(1, -1, -1) }, i.update = function () { this._node && this._node.hasChangedFlags && (this.direction = Kn.transformQuat(BR, PR, this._node.worldRotation)) }, i.activate = function () { var t = S.director.root, e = t.pipeline; this._shadowEnabled ? (this._shadowFixedArea || !e.pipelineSceneData.csmSupported ? e.macros.CC_DIR_LIGHT_SHADOW_TYPE = 1 : this.csmLevel > 1 && e.pipelineSceneData.csmSupported ? (e.macros.CC_DIR_LIGHT_SHADOW_TYPE = 2, e.macros.CC_CASCADED_LAYERS_TRANSITION = this._csmLayersTransition) : e.macros.CC_DIR_LIGHT_SHADOW_TYPE = 1, e.macros.CC_DIR_SHADOW_PCF_TYPE = this._shadowPcf) : e.macros.CC_DIR_LIGHT_SHADOW_TYPE = 0, t.onGlobalPipelineStateChanged() }, n(e, [{ key: "direction", get: function () { return this._dir }, set: function (t) { Kn.normalize(this._dir, t) } }, { key: "illuminance", get: function () { return Uy().isHDR ? this._illuminanceHDR : this._illuminanceLDR }, set: function (t) { Uy().isHDR ? this.illuminanceHDR = t : this.illuminanceLDR = t } }, { key: "illuminanceHDR", get: function () { return this._illuminanceHDR }, set: function (t) { this._illuminanceHDR = t } }, { key: "illuminanceLDR", get: function () { return this._illuminanceLDR }, set: function (t) { this._illuminanceLDR = t } }, { key: "shadowEnabled", get: function () { return this._shadowEnabled }, set: function (t) { this._shadowEnabled = t, this.activate() } }, { key: "shadowPcf", get: function () { return this._shadowPcf }, set: function (t) { this._shadowPcf = t, this.activate() } }, { key: "shadowBias", get: function () { return this._shadowBias }, set: function (t) { this._shadowBias = t } }, { key: "shadowNormalBias", get: function () { return this._shadowNormalBias }, set: function (t) { this._shadowNormalBias = t } }, { key: "shadowSaturation", get: function () { return this._shadowSaturation }, set: function (t) { this._shadowSaturation = t } }, { key: "shadowDistance", get: function () { return this._shadowDistance }, set: function (t) { this._shadowDistance = Math.min(t, ST.MAX_FAR) } }, { key: "shadowInvisibleOcclusionRange", get: function () { return this._shadowInvisibleOcclusionRange }, set: function (t) { this._shadowInvisibleOcclusionRange = Math.min(t, ST.MAX_FAR) } }, { key: "csmLevel", get: function () { return this._csmLevel }, set: function (t) { this._csmLevel = t, this.activate() } }, { key: "csmNeedUpdate", get: function () { return this._csmNeedUpdate }, set: function (t) { this._csmNeedUpdate = t } }, { key: "csmLayerLambda", get: function () { return this._csmLayerLambda }, set: function (t) { this._csmLayerLambda = t } }, { key: "csmOptimizationMode", get: function () { return this._csmOptimizationMode }, set: function (t) { this._csmOptimizationMode = t } }, { key: "shadowFixedArea", get: function () { return this._shadowFixedArea }, set: function (t) { this._shadowFixedArea = t, this.activate() } }, { key: "shadowNear", get: function () { return this._shadowNear }, set: function (t) { this._shadowNear = t } }, { key: "shadowFar", get: function () { return this._shadowFar }, set: function (t) { this._shadowFar = Math.min(t, ST.MAX_FAR) } }, { key: "shadowOrthoSize", get: function () { return this._shadowOrthoSize }, set: function (t) { this._shadowOrthoSize = t } }, { key: "csmLayersTransition", get: function () { return this._csmLayersTransition }, set: function (t) { this._csmLayersTransition = t, this.activate() } }, { key: "csmTransitionRange", get: function () { return this._csmTransitionRange }, set: function (t) { this._csmTransitionRange = t } }]), e }(RR), OR = function (t) { function e() { var e; return (e = t.call(this) || this)._needUpdate = !1, e._size = .15, e._range = 1, e._luminanceHDR = 0, e._luminanceLDR = 0, e._pos = new Kn, e._aabb = hu.create(), e._type = 1, e } s(e, t); var i = e.prototype; return i.initialize = function () { t.prototype.initialize.call(this), this.size = .15, this.range = 1, this.luminanceHDR = 1700 / DR(.15), this.luminanceLDR = 1 }, i.update = function () { if (this._node && (this._node.hasChangedFlags || this._needUpdate)) { this._node.getWorldPosition(this._pos); var t = this._range; hu.set(this._aabb, this._pos.x, this._pos.y, this._pos.z, t, t, t), this._needUpdate = !1 } }, n(e, [{ key: "position", get: function () { return this._pos } }, { key: "size", get: function () { return this._size }, set: function (t) { this._size = t } }, { key: "range", get: function () { return this._range }, set: function (t) { this._range = t, this._needUpdate = !0 } }, { key: "luminance", get: function () { return Uy().isHDR ? this._luminanceHDR : this._luminanceLDR }, set: function (t) { Uy().isHDR ? this.luminanceHDR = t : this.luminanceLDR = t } }, { key: "luminanceHDR", get: function () { return this._luminanceHDR }, set: function (t) { this._luminanceHDR = t } }, { key: "luminanceLDR", set: function (t) { this._luminanceLDR = t } }, { key: "aabb", get: function () { return this._aabb } }]), e }(RR), LR = new Kn(0, 0, -1), FR = new Er, kR = new Gr, NR = new Gr, zR = new Gr, UR = new Gr, VR = function (t) { function e() { var e; return (e = t.call(this) || this)._dir = new Kn(1, -1, -1), e._range = 5, e._spotAngle = Math.cos(Math.PI / 6), e._angleAttenuationStrength = 0, e._pos = new Kn, e._aabb = hu.create(), e._frustum = yu.create(), e._angle = 0, e._needUpdate = !1, e._size = .15, e._luminanceHDR = 0, e._luminanceLDR = 0, e._shadowEnabled = !1, e._shadowPcf = yT.HARD, e._shadowBias = 1e-5, e._shadowNormalBias = 0, e._type = 2, e } s(e, t); var i = e.prototype; return i.initialize = function () { t.prototype.initialize.call(this), this.size = .15, this.luminanceHDR = 1700 / DR(.15), this.luminanceLDR = 1, this.range = Math.cos(Math.PI / 6), this._dir.set(new Kn(1, -1, -1)) }, i.update = function () { this._node && (this._node.hasChangedFlags || this._needUpdate) && (this._node.getWorldPosition(this._pos), Kn.transformQuat(this._dir, LR, this._node.getWorldRotation(FR)), Kn.normalize(this._dir, this._dir), hu.set(this._aabb, this._pos.x, this._pos.y, this._pos.z, this._range, this._range, this._range), this._node.getWorldRT(kR), Gr.invert(kR, kR), Gr.perspective(NR, this._angle, 1, .001, this._range), Gr.multiply(zR, NR, kR), this._frustum.update(zR, UR), this._needUpdate = !1) }, n(e, [{ key: "position", get: function () { return this._pos } }, { key: "size", get: function () { return this._size }, set: function (t) { this._size = t } }, { key: "range", get: function () { return this._range }, set: function (t) { this._range = t, this._needUpdate = !0 } }, { key: "luminance", get: function () { return Uy().isHDR ? this._luminanceHDR : this._luminanceLDR }, set: function (t) { Uy().isHDR ? this.luminanceHDR = t : this.luminanceLDR = t } }, { key: "luminanceHDR", get: function () { return this._luminanceHDR }, set: function (t) { this._luminanceHDR = t } }, { key: "luminanceLDR", get: function () { return this._luminanceLDR }, set: function (t) { this._luminanceLDR = t } }, { key: "direction", get: function () { return this._dir } }, { key: "spotAngle", get: function () { return this._spotAngle }, set: function (t) { this._angle = t, this._spotAngle = Math.cos(.5 * t), this._needUpdate = !0 } }, { key: "angleAttenuationStrength", get: function () { return this._angleAttenuationStrength }, set: function (t) { this._angleAttenuationStrength = t, this._needUpdate = !0 } }, { key: "angle", get: function () { return this._angle } }, { key: "aabb", get: function () { return this._aabb } }, { key: "frustum", get: function () { return this._frustum } }, { key: "shadowEnabled", get: function () { return this._shadowEnabled }, set: function (t) { this._shadowEnabled = t } }, { key: "shadowPcf", get: function () { return this._shadowPcf }, set: function (t) { this._shadowPcf = t } }, { key: "shadowBias", get: function () { return this._shadowBias }, set: function (t) { this._shadowBias = t } }, { key: "shadowNormalBias", get: function () { return this._shadowNormalBias }, set: function (t) { this._shadowNormalBias = t } }]), e }(RR), GR = function (t) { function e() { var e; return (e = t.call(this) || this)._needUpdate = !1, e._range = 1, e._luminanceHDR = 0, e._luminanceLDR = 0, e._pos = Qn(), e._aabb = hu.create(), e._type = 3, e } s(e, t); var i = e.prototype; return i.initialize = function () { t.prototype.initialize.call(this), this.range = 1, this.luminanceHDR = 1700 / DR(1), this.luminanceLDR = 1 }, i.update = function () { if (this._node && (this._node.hasChangedFlags || this._needUpdate)) { this._node.getWorldPosition(this._pos); var t = this._range; hu.set(this._aabb, this._pos.x, this._pos.y, this._pos.z, t, t, t), this._needUpdate = !1 } }, n(e, [{ key: "position", get: function () { return this._pos } }, { key: "range", get: function () { return this._range }, set: function (t) { this._range = t, this._needUpdate = !0 } }, { key: "luminance", get: function () { return Uy().isHDR ? this._luminanceHDR : this._luminanceLDR }, set: function (t) { Uy().isHDR ? this.luminanceHDR = t : this.luminanceLDR = t } }, { key: "luminanceHDR", get: function () { return this._luminanceHDR }, set: function (t) { this._luminanceHDR = t } }, { key: "luminanceLDR", set: function (t) { this._luminanceLDR = t } }, { key: "aabb", get: function () { return this._aabb } }]), e }(RR), HR = new Kn(0, 0, -1), WR = function (t) { function e() { var e; return (e = t.call(this) || this)._dir = new Kn(0, 0, -1), e._pos = new Kn(0, 0, 0), e._scale = new Kn(1, 1, 1), e._right = new Kn(1, 0, 0), e._illuminanceHDR = eb.SUN_ILLUM, e._illuminanceLDR = 1, e._type = 4, e } s(e, t); var i = e.prototype; return i.initialize = function () { t.prototype.initialize.call(this), this.illuminance = eb.SUN_ILLUM }, i.update = function () { this._node && this._node.hasChangedFlags && (this._node.getWorldPosition(this._pos), this._node.getWorldScale(this._scale), Kn.transformQuat(this._dir, HR, this._node.worldRotation), Kn.transformQuat(this._right, Kn.RIGHT, this._node.worldRotation)) }, n(e, [{ key: "direction", get: function () { return this._dir } }, { key: "right", get: function () { return this._right } }, { key: "position", get: function () { return this._pos } }, { key: "scale", get: function () { return this._scale } }, { key: "illuminance", get: function () { return Uy().isHDR ? this._illuminanceHDR : this._illuminanceLDR }, set: function (t) { Uy().isHDR ? this.illuminanceHDR = t : this.illuminanceLDR = t } }, { key: "illuminanceHDR", get: function () { return this._illuminanceHDR }, set: function (t) { this._illuminanceHDR = t } }, { key: "illuminanceLDR", get: function () { return this._illuminanceLDR }, set: function (t) { this._illuminanceLDR = t } }]), e }(RR), jR = new mp; jR.format = 35; var XR = new vp; XR.format = 55; var qR = new wp([jR], XR), YR = { width: 1, height: 1, renderPassInfo: qR }, KR = t("RenderTexture", Gu("cc.RenderTexture")(CR = function (t) { function e(e) { var i; return (i = t.call(this, e) || this)._window = null, i } s(e, t); var i = e.prototype; return i.initialize = function (t) { this._name = t.name || "", this._width = t.width, this._height = t.height, this._initWindow(t) }, i.reset = function (t) { this.initialize(t) }, i.destroy = function () { if (this._window) { var e = S.director.root; null == e || e.destroyWindow(this._window), this._window = null } return t.prototype.destroy.call(this) }, i.resize = function (t, e) { this._width = Math.floor(Xi(t, 1, 2048)), this._height = Math.floor(Xi(e, 1, 2048)), this._window && this._window.resize(this._width, this._height), this.emit("resize", this._window) }, i._serialize = function () { return {} }, i._deserialize = function (e, i) { var n = e; this._width = n.w, this._height = n.h, this._name = n.n, t.prototype._deserialize.call(this, n.base, i) }, i.getGFXTexture = function () { return this._window && this._window.framebuffer.colorTextures[0] }, i.onLoaded = function () { this._initWindow() }, i._initWindow = function (t) { var e = S.director.root; YR.title = this._name, YR.width = this._width, YR.height = this._height, YR.renderPassInfo = t && t.passInfo ? t.passInfo : qR, YR.externalResLow = t && t.externalResLow ? t.externalResLow : 0, YR.externalResHigh = t && t.externalResHigh ? t.externalResHigh : 0, YR.externalFlag = t && t.externalFlag ? t.externalFlag : 0, YR.renderPassInfo.colorAttachments.forEach((function (t) { t.format = e.device.swapchainFormat })), jR.barrier = B_.gfxDevice.getGeneralBarrier(new Sp(128, 128)), this._window ? (this._window.destroy(), this._window.initialize(B_.gfxDevice, YR)) : this._window = e.createWindow(YR) }, i.initDefault = function (e) { t.prototype.initDefault.call(this, e), this._width = this._height = 1, this._initWindow() }, i.validate = function () { return this.width >= 1 && this.width <= 2048 && this.height >= 1 && this.height <= 2048 }, i.readPixels = function (t, e, i, n, r) { t = t || 0, e = e || 0, i = i || this.width, n = n || this.height; var s = this.getGFXTexture(); if (!s) return rt(7606), null; var a = 4 * i * n; if (void 0 === r) r = new Uint8Array(a); else if (r.length < a) return rt(7607, a), null; var o = this._getGFXDevice(), u = [], h = [], c = new Wd; return c.texOffset.x = t, c.texOffset.y = e, c.texExtent.width = i, c.texExtent.height = n, h.push(c), u.push(r), null == o || o.copyTextureToBuffers(s, u, h), r }, n(e, [{ key: "window", get: function () { return this._window } }]), e }(Fg)) || CR); S.RenderTexture = KR; var QR, ZR, JR = [Qn(0, -90, 0), Qn(0, 90, 0), Qn(90, 0, 0), Qn(-90, 0, 0), Qn(0, 0, 0), Qn(0, 180, 0)], $R = Qn(), tP = function () { function t(t) { this.bakedCubeTextures = [], this.realtimePlanarTexture = null, this._resolution = 256, this._clearFlag = 14, this._backgroundColor = new rr(0, 0, 0, 255), this._visibility = yw, this._probeType = 0, this._cubemap = null, this._size = Qn(1, 1, 1), this._camera = null, this._probeId = 0, this._needRefresh = !1, this._needRender = !1, this._node = null, this._cameraNode = null, this._boundingBox = null, this._cameraWorldPos = Qn(), this._cameraWorldRotation = Mr(), this._forward = Qn(), this._up = Qn(), this._previewSphere = null, this._previewPlane = null, this._probeId = t } var e = t.prototype; return e.initialize = function (t, e) { this._node = t, this._cameraNode = e, this.node.getWorldPosition($R); var i = this._size; this._boundingBox = hu.create($R.x, $R.y, $R.z, i.x, i.y, i.z), this._createCamera(e) }, e.initBakedTextures = function () { if (0 === this.bakedCubeTextures.length) for (var t = 0; t < 6; t++) { var e = this._createTargetTexture(this._resolution, this._resolution); this.bakedCubeTextures.push(e) } }, e.captureCubemap = function () { this.initBakedTextures(), this._resetCameraParams(), this._needRender = !0 }, e.renderPlanarReflection = function (t) { if (t) { if (!this.realtimePlanarTexture) { var e = S.view.getDesignResolutionSize(); this.realtimePlanarTexture = this._createTargetTexture(e.width, e.height), S.internal.reflectionProbeManager.updatePlanarMap(this, this.realtimePlanarTexture.getGFXTexture()) } this._syncCameraParams(t), this._transformReflectionCamera(t), this._needRender = !0 } }, e.switchProbeType = function (t, e) { 0 === t ? this._needRender = !1 : null !== e && this.renderPlanarReflection(e) }, e.getProbeId = function () { return this._probeId }, e.updateProbeId = function (t) { this._probeId = t }, e.renderArea = function () { return 1 === this._probeType ? new as(this.realtimePlanarTexture.width, this.realtimePlanarTexture.height) : new as(this.resolution, this.resolution) }, e.isFinishedRendering = function () { return !0 }, e.validate = function () { return null !== this.cubemap }, e.destroy = function () { this._camera && (this._camera.destroy(), this._camera = null); for (var t = 0; t < this.bakedCubeTextures.length; t++)this.bakedCubeTextures[t].destroy(); this.bakedCubeTextures = [], this.realtimePlanarTexture && (this.realtimePlanarTexture.destroy(), this.realtimePlanarTexture = null) }, e.enable = function () { }, e.disable = function () { }, e.updateCameraDir = function (t) { this.cameraNode.setRotationFromEuler(JR[t]), this.camera.update(!0) }, e.updateBoundingBox = function () { if (this.node) { this.node.getWorldPosition($R); var t = this._size; hu.set(this._boundingBox, $R.x, $R.y, $R.z, t.x, t.y, t.z) } }, e.hasFrameBuffer = function (t) { if (1 === this.probeType) { var e; if (!this.realtimePlanarTexture) return !1; if ((null == (e = this.realtimePlanarTexture.window) ? void 0 : e.framebuffer) === t) return !0 } else { if (0 === this.bakedCubeTextures.length) return !1; for (var i = 0; i < this.bakedCubeTextures.length; i++) { var n; if ((null == (n = this.bakedCubeTextures[i].window) ? void 0 : n.framebuffer) === t) return !0 } } return !1 }, e.isRGBE = function () { return !0 }, e._syncCameraParams = function (t) { this.camera.projectionType = t.projectionType, this.camera.orthoHeight = t.orthoHeight, this.camera.nearClip = t.nearClip, this.camera.farClip = t.farClip, this.camera.fov = t.fov, this.camera.clearFlag = t.clearFlag, this.camera.clearColor = t.clearColor, this.camera.priority = t.priority - 1, this.camera.resize(t.width, t.height) }, e._createCamera = function (t) { var e = S.director.root; if (!this._camera) { if (this._camera = e.createCamera(), !this._camera) return null; this._camera.initialize({ name: t.name, node: t, projection: 1, window: e && e.tempWindow, priority: 0, cameraType: -1, trackingType: 0 }) } return this._camera.setViewportInOrientedSpace(new fs(0, 0, 1, 1)), this._camera.fovAxis = 0, this._camera.fov = Ki(90), this._camera.orthoHeight = 10, this._camera.nearClip = 1, this._camera.farClip = 1e3, this._camera.clearColor = this._backgroundColor, this._camera.clearDepth = 1, this._camera.clearStencil = 0, this._camera.clearFlag = this._clearFlag, this._camera.visibility = this._visibility, this._camera.aperture = 19, this._camera.shutter = 7, this._camera.iso = 0, this._camera }, e._resetCameraParams = function () { this.camera.projectionType = 1, this.camera.orthoHeight = 10, this.camera.nearClip = 1, this.camera.farClip = 1e3, this.camera.fov = Ki(90), this.camera.priority = 0, this.camera.resize(this.resolution, this.resolution), this.camera.visibility = this._visibility, this.camera.clearFlag = this._clearFlag, this.camera.clearColor = this._backgroundColor, this.cameraNode.worldPosition = this.node.worldPosition, this.cameraNode.worldRotation = this.node.worldRotation, this.camera.update(!0) }, e._createTargetTexture = function (t, e) { var i = new KR; return i.reset({ width: t, height: e }), i }, e._transformReflectionCamera = function (t) { var e = Kn.dot(this.node.worldPosition, this.node.up); this._reflect(this._cameraWorldPos, t.node.worldPosition, this.node.up, e), this.cameraNode.worldPosition = this._cameraWorldPos, Kn.transformQuat(this._forward, Kn.FORWARD, t.node.worldRotation), this._reflect(this._forward, this._forward, this.node.up, 0), this._forward.normalize(), this._forward.negative(), Kn.transformQuat(this._up, Kn.UP, t.node.worldRotation), this._reflect(this._up, this._up, this.node.up, 0), this._up.normalize(), Er.fromViewUp(this._cameraWorldRotation, this._forward, this._up), this.cameraNode.worldRotation = this._cameraWorldRotation, this.camera.update(!0); var i = new Pn(this.node.up.x, this.node.up.y, this.node.up.z, -Kn.dot(this.node.up, this.node.worldPosition)); i.transformMat4(this.camera.matView.clone().invert().transpose()), this.camera.calculateObliqueMat(i) }, e._reflect = function (t, e, i, n) { var r = Kn.clone(i); r.normalize(); var s = Kn.dot(r, e) - n; return r.multiplyScalar(2 * s), Kn.subtract(t, e, r), t }, n(t, [{ key: "probeType", get: function () { return this._probeType }, set: function (t) { this._probeType = t } }, { key: "resolution", get: function () { return this._resolution }, set: function (t) { t !== this._resolution && this.bakedCubeTextures.forEach((function (e) { e.resize(t, t) })), this._resolution = t } }, { key: "clearFlag", get: function () { return this._clearFlag }, set: function (t) { this._clearFlag = t, this.camera.clearFlag = this._clearFlag } }, { key: "backgroundColor", get: function () { return this._backgroundColor }, set: function (t) { this._backgroundColor = t, this.camera.clearColor = this._backgroundColor } }, { key: "visibility", get: function () { return this._visibility }, set: function (t) { this._visibility = t, this._camera.visibility = this._visibility } }, { key: "size", get: function () { return this._size }, set: function (t) { this._size.set(t), this.node.getWorldPosition($R), hu.set(this._boundingBox, $R.x, $R.y, $R.z, t.x, t.y, t.z) } }, { key: "cubemap", get: function () { return this._cubemap }, set: function (t) { this._cubemap = t } }, { key: "node", get: function () { return this._node } }, { key: "camera", get: function () { return this._camera } }, { key: "needRefresh", get: function () { return this._needRefresh }, set: function (t) { this._needRefresh = t } }, { key: "needRender", get: function () { return this._needRender }, set: function (t) { this._needRender = t } }, { key: "boundingBox", get: function () { return this._boundingBox } }, { key: "cameraNode", get: function () { return this._cameraNode }, set: function (t) { this._cameraNode = t } }, { key: "previewSphere", get: function () { return this._previewSphere }, set: function (t) { this._previewSphere = t } }, { key: "previewPlane", get: function () { return this._previewPlane }, set: function (t) { this._previewPlane = t } }]), t }(), eP = function () { function t() { this.screenUsagePercentage = 1, this._models = [] } var e = t.prototype; return e.addModel = function (t) { this._models.splice(0, 0, t) }, e.eraseModel = function (t) { var e = this._models.indexOf(t); e >= 0 && this._models.splice(e, 1) }, e.clearModels = function () { this._models.length = 0 }, n(t, [{ key: "models", get: function () { return this._models } }]), t }(), iP = function () { function t() { this.scene = void 0, this.node = null, this.enabled = !0, this._localBoundaryCenter = Qn(0, 0, 0), this._objectSize = 1, this._lodDataArray = [], this._lockedLODLevelVec = [], this._isLockLevelChanged = !1, this._device = B_.gfxDevice } var e = t.prototype; return e.attachToScene = function (t) { this.scene = t }, e.detachFromScene = function () { this.scene = null }, e.lockLODLevels = function (t) { if (t.length !== this._lockedLODLevelVec.length) this._isLockLevelChanged = !0; else for (var e = t.length, i = 0; i < e; i++)if (t[i] !== this._lockedLODLevelVec[i]) { this._isLockLevelChanged = !0; break } this._lockedLODLevelVec = t.slice() }, e.isLockLevelChanged = function () { return this._isLockLevelChanged }, e.resetLockChangeFlag = function () { this._isLockLevelChanged = !1 }, e.getLockedLODLevels = function () { return this._lockedLODLevelVec }, e.clearLODs = function () { this._lodDataArray.length = 0 }, e.insertLOD = function (t, e) { this._lodDataArray.splice(t, 0, e) }, e.updateLOD = function (t, e) { this._lodDataArray[t] = e }, e.eraseLOD = function (t) { this._lodDataArray.splice(t, 1) }, e.getVisibleLODLevel = function (t) { for (var e = this.getScreenUsagePercentage(t), i = -1, n = 0; n < this.lodCount; ++n)if (e >= this.lodDataArray[n].screenUsagePercentage) { i = n; break } return i }, e.getScreenUsagePercentage = function (t) { return this.node ? (1 === t.projectionType && (e = Kn.len(this.localBoundaryCenter.transformMat4(this.node.worldMatrix).subtract(t.node.worldPosition))), this.distanceToScreenUsagePercentage(t, e, this.getWorldSpaceSize())) : 0; var e }, e.distanceToScreenUsagePercentage = function (t, e, i) { return 1 === t.projectionType ? i * t.matProj.m05 / (2 * e) : i * t.matProj.m05 * .5 }, e.getWorldSpaceSize = function () { var t = this.node.scale; return Math.max(Math.abs(t.x), Math.abs(t.y), Math.abs(t.z)) * this.objectSize }, n(t, [{ key: "localBoundaryCenter", get: function () { return this._localBoundaryCenter.clone() }, set: function (t) { this._localBoundaryCenter.set(t) } }, { key: "lodCount", get: function () { return this._lodDataArray.length } }, { key: "objectSize", get: function () { return this._objectSize }, set: function (t) { this._objectSize = t } }, { key: "lodDataArray", get: function () { return this._lodDataArray } }]), t }(), nP = Object.freeze({ __proto__: null, Ambient: eb, CSMLevel: bT, CSMOptimizationMode: wT, Camera: dR, CameraAperture: iR, CameraFOVAxis: tR, CameraISO: nR, CameraProjection: eR, CameraShutter: rR, CameraType: { DEFAULT: -1, LEFT_EYE: 0, RIGHT_EYE: 1, MAIN: 2 }, CameraUsage: { EDITOR: 0, GAME_VIEW: 1, SCENE_VIEW: 2, PREVIEW: 3, GAME: 100 }, ColorTemperatureToRGB: AR, DirectionalLight: MR, EnvironmentLightingType: CT, FOG_TYPE_NONE: BT, Fog: MT, FogType: PT, LODData: eP, LODGroup: iP, Light: RR, LightType: { DIRECTIONAL: 0, SPHERE: 1, SPOT: 2, POINT: 3, RANGED_DIRECTIONAL: 4, UNKNOWN: 5 }, Model: TR, ModelType: { DEFAULT: 0, SKINNING: 1, BAKED_SKINNING: 2, BATCH_2D: 3, PARTICLE_BATCH: 4, LINE: 5 }, Octree: IR, PCFType: yT, PointLight: GR, PostSettings: nA, ProbeClearFlag: { SKYBOX: 14, SOLID_COLOR: 7 }, ProbeType: { CUBE: 0, PLANAR: 1 }, RangedDirectionalLight: WR, ReflectionProbe: tP, SKYBOX_FLAG: 8, ShadowSize: mT, ShadowType: vT, Shadows: ST, Skin: ER, SkyBoxFlagValue: { VALUE: 8 }, Skybox: DT, SphereLight: OR, SpotLight: VR, SubModel: _R, ToneMappingType: iA, TrackingType: { NO_TRACKING: 0, POSITION_AND_ROTATION: 1, POSITION: 2, ROTATION: 3 }, nt2lm: DR }), rP = function () { function t(t) { this._name = "", this._cameras = [], this._models = [], this._lodGroups = [], this._batches = [], this._directionalLights = [], this._sphereLights = [], this._spotLights = [], this._pointLights = [], this._rangedDirLights = [], this._mainLight = null, this._modelId = 0, this._lodStateCache = null, this._root = t } t.registerCreateFunc = function (e) { e._createSceneFun = function (e) { return new t(e) } }; var e = t.prototype; return e.initialize = function (t) { return this._name = t.name, this._lodStateCache = new aP(this), !0 }, e.update = function (t) { var e = this._mainLight; e && e.update(); for (var i = this._sphereLights, n = 0; n < i.length; n++)i[n].update(); for (var r = this._spotLights, s = 0; s < r.length; s++)r[s].update(); for (var a = this._pointLights, o = 0; o < a.length; o++)a[o].update(); for (var u = this._rangedDirLights, h = 0; h < u.length; h++)u[h].update(); for (var c = this._models, l = 0; l < c.length; l++) { var f = c[l]; f.enabled && (f.updateTransform(t), f.updateUBOs(t)) } this._lodStateCache.updateLodState() }, e.destroy = function () { this.removeCameras(), this.removeSphereLights(), this.removeSpotLights(), this.removeRangedDirLights(), this.removeModels(), this.removeLODGroups(), this._lodStateCache.clearCache() }, e.isCulledByLod = function (t, e) { return this._lodStateCache.isLodModelCulled(t, e) }, e.addCamera = function (t) { t.attachToScene(this), this._cameras.push(t), this._lodStateCache.addCamera(t) }, e.removeCamera = function (t) { for (var e = 0; e < this._cameras.length; ++e)if (this._cameras[e] === t) return this._cameras.splice(e, 1), t.detachFromScene(), void this._lodStateCache.removeCamera(t) }, e.removeCameras = function () { var t = this; this._cameras.forEach((function (e) { e.detachFromScene(), t._lodStateCache.removeCamera(e) })), this._cameras.length = 0 }, e.setMainLight = function (t) { this._mainLight = t, this._mainLight && this._mainLight.activate() }, e.unsetMainLight = function (t) { if (this._mainLight === t) { var e = this._directionalLights; if (e.length) return this.setMainLight(e[e.length - 1]), void (this._mainLight.node && (this._mainLight.node.hasChangedFlags |= 2)); this.setMainLight(null) } }, e.addDirectionalLight = function (t) { t.attachToScene(this), this._directionalLights.push(t) }, e.removeDirectionalLight = function (t) { for (var e = 0; e < this._directionalLights.length; ++e)if (this._directionalLights[e] === t) return t.detachFromScene(), void this._directionalLights.splice(e, 1) }, e.addSphereLight = function (t) { t.attachToScene(this), this._sphereLights.push(t) }, e.removeSphereLight = function (t) { for (var e = 0; e < this._sphereLights.length; ++e)if (this._sphereLights[e] === t) return t.detachFromScene(), void this._sphereLights.splice(e, 1) }, e.addSpotLight = function (t) { t.attachToScene(this), this._spotLights.push(t) }, e.removeSpotLight = function (t) { for (var e = 0; e < this._spotLights.length; ++e)if (this._spotLights[e] === t) return t.detachFromScene(), void this._spotLights.splice(e, 1) }, e.removeSphereLights = function () { for (var t = 0; t < this._sphereLights.length; ++t)this._sphereLights[t].detachFromScene(); this._sphereLights.length = 0 }, e.removeSpotLights = function () { for (var t = 0; t < this._spotLights.length; ++t)this._spotLights[t].detachFromScene(); this._spotLights.length = 0 }, e.addPointLight = function (t) { t.attachToScene(this), this._pointLights.push(t) }, e.removePointLight = function (t) { for (var e = 0; e < this._pointLights.length; ++e)if (this._pointLights[e] === t) return t.detachFromScene(), void this._pointLights.splice(e, 1) }, e.removePointLights = function () { for (var t = 0; t < this._pointLights.length; ++t)this._pointLights[t].detachFromScene(); this._pointLights.length = 0 }, e.addRangedDirLight = function (t) { t.attachToScene(this), this._rangedDirLights.push(t) }, e.removeRangedDirLight = function (t) { for (var e = 0; e < this._rangedDirLights.length; ++e)if (this._rangedDirLights[e] === t) return t.detachFromScene(), void this._rangedDirLights.splice(e, 1) }, e.removeRangedDirLights = function () { for (var t = 0; t < this._rangedDirLights.length; ++t)this._rangedDirLights[t].detachFromScene(); this._rangedDirLights.length = 0 }, e.addModel = function (t) { t.attachToScene(this), this._models.push(t) }, e.removeModel = function (t) { for (var e = 0; e < this._models.length; ++e)if (this._models[e] === t) return this._lodStateCache.removeModel(t), t.detachFromScene(), void this._models.splice(e, 1) }, e.removeModels = function () { var t = this; this._models.forEach((function (e) { t._lodStateCache.removeModel(e), e.detachFromScene(), e.destroy() })), this._models.length = 0 }, e.addBatch = function (t) { this._batches.push(t) }, e.removeBatch = function (t) { for (var e = 0; e < this._batches.length; ++e)if (this._batches[e] === t) return void this._batches.splice(e, 1) }, e.removeBatches = function () { this._batches.length = 0 }, e.addLODGroup = function (t) { this._lodGroups.push(t), t.attachToScene(this), this._lodStateCache.addLodGroup(t) }, e.removeLODGroup = function (t) { var e = this._lodGroups.indexOf(t); e >= 0 && (this._lodGroups.splice(e, 1), t.detachFromScene(), this._lodStateCache.removeLodGroup(t)) }, e.removeLODGroups = function () { var t = this; this._lodGroups.forEach((function (e) { t._lodStateCache.removeLodGroup(e) })), this._lodGroups.length = 0 }, e.onGlobalPipelineStateChanged = function () { this._models.forEach((function (t) { t.onGlobalPipelineStateChanged() })) }, e.generateModelId = function () { return this._modelId++ }, n(t, [{ key: "root", get: function () { return this._root } }, { key: "name", get: function () { return this._name } }, { key: "cameras", get: function () { return this._cameras } }, { key: "mainLight", get: function () { return this._mainLight } }, { key: "sphereLights", get: function () { return this._sphereLights } }, { key: "spotLights", get: function () { return this._spotLights } }, { key: "pointLights", get: function () { return this._pointLights } }, { key: "rangedDirLights", get: function () { return this._rangedDirLights } }, { key: "models", get: function () { return this._models } }, { key: "batches", get: function () { return this._batches } }, { key: "lodGroups", get: function () { return this._lodGroups } }]), t }(), sP = function () { this.usedLevel = -1, this.lastUsedLevel = -1, this.transformDirty = !0 }, aP = function () { function t(t) { this._renderScene = null, this._modelsInLODGroup = new Map, this._lodStateInCamera = new Map, this._newAddedLodGroupVec = [], this._levelModels = new Map, this._renderScene = t } var e = t.prototype; return e.addCamera = function (t) { for (var e = this._renderScene.lodGroups, i = 0; i < e.length; i++) { var n = e[i].node.layer; if ((t.visibility & n) === n) { this._lodStateInCamera.has(t) || this._lodStateInCamera.set(t, new Map); break } } }, e.removeCamera = function (t) { this._lodStateInCamera.has(t) && this._lodStateInCamera.delete(t) }, e.addLodGroup = function (t) { this._newAddedLodGroupVec.push(t); for (var e = this._renderScene.cameras, i = 0; i < e.length; i++) { var n = e[i]; if (!this._lodStateInCamera.has(n)) { var r = t.node.layer; (n.visibility & r) === r && this._lodStateInCamera.set(n, new Map) } } }, e.removeLodGroup = function (t) { for (var e = this, i = 0; i < t.lodCount; i++)t.lodDataArray[i].models.forEach((function (t) { e._modelsInLODGroup.delete(t) })); for (var n, r = p(this._lodStateInCamera); !(n = r()).done;)n.value[1].delete(t); this._levelModels.delete(t) }, e.removeModel = function (t) { this._modelsInLODGroup.has(t) && this._modelsInLODGroup.delete(t) }, e.updateLodState = function () { var t = this; this._newAddedLodGroupVec.forEach((function (e) { var i = t._levelModels.get(e); i || (i = new Map, t._levelModels.set(e, i)); for (var n = 0; n < e.lodCount; n++) { var r = i.get(n); r || (r = []); for (var s = e.lodDataArray[n].models, a = 0; a < s.length; a++) { var o = s[a], u = t._modelsInLODGroup.get(o); u || (u = new Map), t._modelsInLODGroup.set(o, u), r.push(o) } i.set(n, r) } })), this._newAddedLodGroupVec.length = 0; for (var e = this._renderScene.lodGroups, i = function () { var i = e[n]; if (i.enabled) { var r = i.getLockedLODLevels(); if (r.length > 0) { if (i.node.hasChangedFlags > 0) for (var s, a = p(t._lodStateInCamera); !(s = a()).done;) { var o = s.value, u = o[1].get(i); u || (u = new sP, o[1].set(i, u)), u.transformDirty = !0 } if (i.isLockLevelChanged()) { i.resetLockChangeFlag(); var h = t._levelModels.get(i); h && (h.forEach((function (e) { e.forEach((function (e) { var i = t._modelsInLODGroup.get(e); i && i.clear() })) })), r.forEach((function (e) { var i = h.get(e); i && i.forEach((function (e) { var i = t._modelsInLODGroup.get(e); if (i && e.node && e.node.active) for (var n, r = p(t._lodStateInCamera); !(n = r()).done;) { var s = n.value; i.set(s[0], !0) } })) }))) } return 0 } for (var c, l = !1, f = p(t._lodStateInCamera); !(c = f()).done;) { var d = c.value, _ = d[1].get(i); _ || (_ = new sP, d[1].set(i, _)); var g = d[0].node.hasChangedFlags, m = i.node.hasChangedFlags; if (g > 0 || m > 0 || _.transformDirty) { _.transformDirty && (_.transformDirty = !1); var v = i.getVisibleLODLevel(d[0]); v !== _.usedLevel && (_.lastUsedLevel = _.usedLevel, _.usedLevel = v, l = !0) } } var y = t._levelModels.get(i); if (!y) return 0; i.isLockLevelChanged() ? (i.resetLockChangeFlag(), y.forEach((function (e) { e.forEach((function (e) { var i = t._modelsInLODGroup.get(e); i && i.clear() })) })), l = !0) : l && t._lodStateInCamera.forEach((function (e) { var n = e.get(i); if (n && n.usedLevel !== n.lastUsedLevel) { var r = y.get(n.lastUsedLevel); r && r.forEach((function (e) { var i = t._modelsInLODGroup.get(e); i && i.clear() })) } })), l && t._lodStateInCamera.forEach((function (e, n) { var r = e.get(i); if (r) { var s = r.usedLevel, a = y.get(s); a && a.forEach((function (e) { var i = t._modelsInLODGroup.get(e); i && e.node && e.node.active && i.set(n, !0) })) } })) } }, n = 0; n < e.length; n++)i() }, e.isLodModelCulled = function (t, e) { var i = this._modelsInLODGroup.get(e); return !!i && !i.has(t) }, e.clearCache = function () { this._levelModels.clear(), this._modelsInLODGroup.clear(), this._lodStateInCamera.clear(), this._newAddedLodGroupVec.length = 0 }, e.isLodGroupVisibleByCamera = function (t, e) { var i = t.node.layer; return (e.visibility & i) === i }, t }(), oP = ((QR = {})[Me.PORTRAIT] = 0, QR[Me.LANDSCAPE_RIGHT] = 1, QR[Me.PORTRAIT_UPSIDE_DOWN] = 2, QR[Me.LANDSCAPE_LEFT] = 3, QR), uP = 0, hP = function () { var t = e.prototype; function e() { this._title = "", this._width = 1, this._height = 1, this._swapchain = null, this._renderPass = null, this._colorTextures = [], this._depthStencilTexture = null, this._cameras = [], this._hasOnScreenAttachments = !1, this._hasOffScreenAttachments = !1, this._framebuffer = null, this._device = null, this._renderWindowId = uP++, this._isResized = !0, this._colorName = "Color" + this._renderWindowId, this._depthStencilName = "DepthStencil" + this._renderWindowId } return t.isRenderWindowResized = function () { return this._isResized }, t.setRenderWindowResizeHandled = function () { this._isResized = !1 }, e.registerCreateFunc = function (t) { t._createWindowFun = function () { return new e } }, t.initialize = function (t, e) { if (void 0 !== e.title && (this._title = e.title), void 0 !== e.swapchain && (this._swapchain = e.swapchain), this._width = e.width, this._height = e.height, this._device = t, this._renderPass = t.createRenderPass(e.renderPassInfo), e.swapchain) this._swapchain = e.swapchain, this._colorTextures.push(e.swapchain.colorTexture), this._depthStencilTexture = e.swapchain.depthStencilTexture; else { for (var i = 0; i < e.renderPassInfo.colorAttachments.length; i++) { var n = new ip(1, 21, e.renderPassInfo.colorAttachments[i].format, this._width, this._height); e.externalFlag && (8 & e.externalFlag || 4 & e.externalFlag) && (n.flags |= e.externalFlag, n.externalRes = e.externalResLow ? e.externalResLow : 0), this._colorTextures.push(t.createTexture(n)) } e.renderPassInfo.depthStencilAttachment && 0 !== e.renderPassInfo.depthStencilAttachment.format && (this._depthStencilTexture = t.createTexture(new ip(1, 36, e.renderPassInfo.depthStencilAttachment.format, this._width, this._height)), this._hasOffScreenAttachments = !0) } return this._framebuffer = t.createFramebuffer(new Ep(this._renderPass, this._colorTextures, this._depthStencilTexture)), !0 }, t.destroy = function () { this.clearCameras(), this._framebuffer && (this._framebuffer.destroy(), this._framebuffer = null), this._depthStencilTexture && (this._depthStencilTexture.destroy(), this._depthStencilTexture = null); for (var t = 0; t < this._colorTextures.length; t++) { var e = this._colorTextures[t]; e && e.destroy() } this._colorTextures.length = 0, this._device = null }, t.resize = function (t, e) { if (this._swapchain) this._swapchain.resize(t, e, oP[Zo.orientation]), this._width = this._swapchain.width, this._height = this._swapchain.height; else { for (var i = 0; i < this._colorTextures.length; i++)this._colorTextures[i].resize(t, e); this._depthStencilTexture && this._depthStencilTexture.resize(t, e), this._width = t, this._height = e } this.framebuffer && (this.framebuffer.destroy(), this._framebuffer = this._device.createFramebuffer(new Ep(this._renderPass, this._colorTextures, this._depthStencilTexture))), this._cameras.forEach((function (i) { i.resize(t, e) })), this._isResized = !0 }, t.extractRenderCameras = function (t) { for (var e = 0; e < this._cameras.length; e++) { var i = this._cameras[e]; i.enabled && (i.update(), t.push(i)) } }, t.attachCamera = function (t) { for (var e = 0; e < this._cameras.length; e++)if (this._cameras[e] === t) return; this._cameras.push(t), this.sortCameras(), this._isResized = !0 }, t.detachCamera = function (t) { for (var e = 0; e < this._cameras.length; ++e)if (this._cameras[e] === t) return void this._cameras.splice(e, 1) }, t.clearCameras = function () { this._cameras.length = 0 }, t.sortCameras = function () { this._cameras.sort((function (t, e) { return t.priority - e.priority })) }, n(e, [{ key: "width", get: function () { return this._width } }, { key: "height", get: function () { return this._height } }, { key: "swapchain", get: function () { return this._swapchain } }, { key: "framebuffer", get: function () { return this._framebuffer } }, { key: "cameras", get: function () { return this._cameras } }, { key: "renderWindowId", get: function () { return this._renderWindowId } }, { key: "colorName", get: function () { return this._colorName } }, { key: "depthStencilName", get: function () { return this._depthStencilName } }]), e }(), cP = (t("PipelineEventType", { RENDER_FRAME_BEGIN: "render-frame-begin", RENDER_FRAME_END: "render-frame-end", RENDER_CAMERA_BEGIN: "render-camera-begin", RENDER_CAMERA_END: "render-camera-end", ATTACHMENT_SCALE_CAHNGED: "attachment-scale-changed" }), t("PipelineEventProcessor", function (t) { function e() { var e; return (e = t.call(this) || this).eventTargetOn = t.prototype.on, e.eventTargetOnce = t.prototype.once, e } s(e, t); var i = e.prototype; return i.on = function (t, e, i, n) { return this.eventTargetOn(t, e, i, n) }, i.once = function (t, e, i) { return this.eventTargetOnce(t, e, i) }, e }(wo))), lP = t("Root", function () { function t(t) { var e = this; this._createSceneFun = null, this._createWindowFun = null, this._windows = [], this._mainWindow = null, this._curWindow = null, this._tempWindow = null, this._usesCustomPipeline = !0, this._pipeline = null, this._pipelineEvent = new cP, this._classicPipeline = null, this._customPipeline = null, this._batcher = null, this._scenes = [], this._modelPools = new Map, this._cameraPool = null, this._lightPools = new Map, this._debugView = new $D, this._fpsTime = 0, this._frameCount = 0, this._fps = 0, this._fixedFPS = 0, this._useDeferredPipeline = !1, this._cumulativeTime = 0, this._frameTime = 0, this._cameraList = [], this._device = t, this._dataPoolMgr = S.internal.DataPoolManager && new S.internal.DataPoolManager(t), rP.registerCreateFunc(this), hP.registerCreateFunc(this), this._cameraPool = new to((function () { return new dR(e._device) }), 4, (function (t) { return t.destroy() })) } var e = t.prototype; return e.initialize = function () { var t, e = B_.swapchain, i = new mp; i.format = e.colorTexture.format; var n = new vp; n.format = e.depthStencilTexture.format, n.depthStoreOp = 1, n.stencilStoreOp = 1; var r = new wp([i], n); this._mainWindow = this.createWindow({ title: "rootMainWindow", width: e.width, height: e.height, renderPassInfo: r, swapchain: e }), this._curWindow = this._mainWindow; var s = Oe.querySettings("animation", "customJointTextureLayouts") || []; null == (t = this._dataPoolMgr) || t.jointTexturePool.registerCustomTextureLayouts(s), this._resizeMaxJointForDS() }, e.destroy = function () { this.destroyScenes(), this._pipeline && (this._pipeline.destroy(), this._pipeline = null, this._pipelineEvent = null), this._batcher && (this._batcher.destroy(), this._batcher = null), this._curWindow = null, this._mainWindow = null, this.dataPoolManager.clear(), S.rendering && S.rendering.destroy() }, e.resize = function (t, e) { this._windows.forEach((function (i) { i.swapchain && i.resize(t, e) })) }, e.setRenderPipeline = function (t) { var e = S.internal, i = S.director, n = S.rendering, r = S.legacy_rendering; if (void 0 === n && void 0 === r) return rt(1223), !1; var s = !1; if (t) this._customPipeline = n.createCustomPipeline(), s = !0, this._pipeline = this._customPipeline, H("Using custom pipeline: " + Le.CUSTOM_PIPELINE_NAME); else { var a = r.createDefaultPipeline(); s = !0, H("Using legacy pipeline"), this._classicPipeline = a, this._pipeline = this._classicPipeline, this._pipelineEvent = this._classicPipeline, this._usesCustomPipeline = !1 } if ((3 !== Oe.querySettings("rendering", "renderMode") || this._classicPipeline) && !this._pipeline.activate(this._mainWindow.swapchain)) return s && this._pipeline.destroy(), this._classicPipeline = null, this._customPipeline = null, this._pipeline = null, this._pipelineEvent = null, !1; var o = i.getScene(); return o && o.globals.activate(), this.onGlobalPipelineStateChanged(), !(!this._batcher && e.Batcher2D && (this._batcher = new e.Batcher2D(this), !this._batcher.initialize()) && (this.destroy(), 1)) }, e.onGlobalPipelineStateChanged = function () { for (var t = 0; t < this._scenes.length; t++)this._scenes[t].onGlobalPipelineStateChanged(); Uy().skybox.enabled && Uy().skybox.model.onGlobalPipelineStateChanged(), this._pipeline.onGlobalPipelineStateChanged() }, e.activeWindow = function (t) { this._curWindow = t }, e.resetCumulativeTime = function () { this._cumulativeTime = 0 }, e.frameMove = function (t) { this._frameTime = t, ++this._frameCount, this._cumulativeTime += t, this._fpsTime += t, this._fpsTime > 1 && (this._fps = this._frameCount, this._frameCount = 0, this._fpsTime = 0), this._frameMoveBegin(), this._frameMoveProcess(), this._frameMoveEnd() }, e.createWindow = function (t) { var e = this._createWindowFun(this); return e.initialize(this.device, t), this._windows.push(e), e }, e.destroyWindow = function (t) { for (var e = 0; e < this._windows.length; ++e)if (this._windows[e] === t) return t.destroy(), void this._windows.splice(e, 1) }, e.destroyWindows = function () { this._windows.forEach((function (t) { t.destroy() })), this._windows.length = 0 }, e.createScene = function (t) { var e = this._createSceneFun(this); return e.initialize(t), this._scenes.push(e), e }, e.destroyScene = function (t) { for (var e = 0; e < this._scenes.length; ++e)if (this._scenes[e] === t) return t.destroy(), void this._scenes.splice(e, 1) }, e.destroyScenes = function () { this._scenes.forEach((function (t) { t.destroy() })), this._scenes.length = 0 }, e.createModel = function (t) { var e = this._modelPools.get(t); e || (this._modelPools.set(t, new to((function () { return new t }), 10, (function (t) { return t.destroy() }))), e = this._modelPools.get(t)); var i = e.alloc(); return i.initialize(), i }, e.destroyModel = function (t) { var e = this._modelPools.get(t.constructor); e ? (e.free(t), t.scene && t.scene.removeModel(t)) : it(1300, t.constructor.name), t.destroy() }, e.createCamera = function () { return this._cameraPool.alloc() }, e.createLight = function (t) { var e = this._lightPools.get(t); e || (this._lightPools.set(t, new to((function () { return new t }), 4, (function (t) { return t.destroy() }))), e = this._lightPools.get(t)); var i = e.alloc(); return i.initialize(), i }, e.destroyLight = function (t) { if (t.scene) switch (t.type) { case 0: t.scene.removeDirectionalLight(t); break; case 1: t.scene.removeSphereLight(t); break; case 2: t.scene.removeSpotLight(t); break; case 3: t.scene.removePointLight(t); break; case 4: t.scene.removeRangedDirLight(t) }t.destroy() }, e.recycleLight = function (t) { var e = this._lightPools.get(t.constructor); if (e && (e.free(t), t.scene)) switch (t.type) { case 0: t.scene.removeDirectionalLight(t); break; case 1: t.scene.removeSphereLight(t); break; case 2: t.scene.removeSpotLight(t); break; case 3: t.scene.removePointLight(t); break; case 4: t.scene.removeRangedDirLight(t) } }, e._doWebXRFrameMove = function () { }, e._frameMoveBegin = function () { for (var t = 0; t < this._scenes.length; ++t)this._scenes[t].removeBatches(); this._cameraList.length = 0 }, e._frameMoveProcess = function () { for (var t = S.director, e = this._windows, i = this._cameraList, n = 0; n < e.length; n++)e[n].extractRenderCameras(i); if (this._pipeline && i.length > 0) { this._device.acquire([B_.swapchain]); var r = this._scenes, s = t.getTotalFrames(); this._batcher && (this._batcher.update(), this._batcher.uploadBuffers()); for (var a = 0; a < r.length; a++)r[a].update(s) } }, e._frameMoveEnd = function () { var t = S.director, e = S.Director, i = this._cameraList; if (this._pipeline && i.length > 0) { t.emit(e.EVENT_BEFORE_COMMIT), i.sort((function (t, e) { return t.priority - e.priority })); for (var n = 0; n < i.length; ++n) { var r; null == (r = i[n].geometryRenderer) || r.update() } t.emit(e.EVENT_BEFORE_RENDER), this._pipeline.render(i), t.emit(e.EVENT_AFTER_RENDER), this._device.present() } this._batcher && this._batcher.reset() }, e._resizeMaxJointForDS = function () { var t = Math.max((288 + Sb.COUNT) / 4, 100), e = Math.floor((B_.gfxDevice.capabilities.maxVertexUniformVectors - t) / 3); Bb(e = e < 256 ? e : 256) }, n(t, [{ key: "device", get: function () { return this._device } }, { key: "mainWindow", get: function () { return this._mainWindow } }, { key: "curWindow", get: function () { return this._curWindow }, set: function (t) { this._curWindow = t } }, { key: "tempWindow", get: function () { return this._tempWindow }, set: function (t) { this._tempWindow = t } }, { key: "windows", get: function () { return this._windows } }, { key: "usesCustomPipeline", get: function () { return this._usesCustomPipeline } }, { key: "pipeline", get: function () { return this._pipeline } }, { key: "customPipeline", get: function () { return this._customPipeline } }, { key: "pipelineEvent", get: function () { return this._pipelineEvent } }, { key: "batcher2D", get: function () { return this._batcher } }, { key: "scenes", get: function () { return this._scenes } }, { key: "debugView", get: function () { return this._debugView } }, { key: "cumulativeTime", get: function () { return this._cumulativeTime } }, { key: "frameTime", get: function () { return this._frameTime } }, { key: "frameCount", get: function () { return this._frameCount } }, { key: "fps", get: function () { return this._fps } }, { key: "fixedFPS", get: function () { return this._fixedFPS }, set: function (t) { t > 0 && (this._fixedFPS = t) } }, { key: "dataPoolManager", get: function () { return this._dataPoolMgr } }, { key: "useDeferredPipeline", get: function () { return this._useDeferredPipeline } }, { key: "cameraList", get: function () { return this._cameraList } }]), t }()); S.Root = lP, Pi.Attr.setClassAttr(rm, "target", "type", "Object"), Pi.Attr.setClassAttr(rm, "target", "ctor", ky), lt(ky.prototype, "Node", [{ name: "childrenCount", newName: "children.length", customGetter: function () { return this.children.length } }]), lt(ky.prototype, "Node", [{ name: "width", targetName: "node.getComponent(UITransform)", customGetter: function () { return this._getUITransformComp().width }, customSetter: function (t) { this._getUITransformComp().width = t } }, { name: "height", targetName: "node.getComponent(UITransform)", customGetter: function () { return this._getUITransformComp().height }, customSetter: function (t) { this._getUITransformComp().height = t } }, { name: "anchorX", targetName: "node.getComponent(UITransform)", customGetter: function () { return this._getUITransformComp().anchorX }, customSetter: function (t) { this._getUITransformComp().anchorX = t } }, { name: "anchorY", targetName: "node.getComponent(UITransform)", customGetter: function () { return this._getUITransformComp().anchorY }, customSetter: function (t) { this._getUITransformComp().anchorY = t } }, { name: "getAnchorPoint", targetName: "node.getComponent(UITransform)", customFunction: function (t) { return t || (t = new as), t.set(this._getUITransformComp().anchorPoint), t } }, { name: "setAnchorPoint", targetName: "node.getComponent(UITransform)", customFunction: function (t, e) { this._getUITransformComp().setAnchorPoint(t, e) } }, { name: "getContentSize", targetName: "node.getComponent(UITransform)", customFunction: function (t) { return t || (t = new us), t.set(this._getUITransformComp().contentSize), t } }, { name: "setContentSize", targetName: "node.getComponent(UITransform)", customFunction: function (t, e) { "number" == typeof t ? this._getUITransformComp().setContentSize(t, e) : this._getUITransformComp().setContentSize(t) } }]), ft(FC.prototype, "SceneGlobals.prototype", [{ name: "aspect" }, { name: "selfShadow" }, { name: "linear" }, { name: "packing" }, { name: "autoAdapt" }, { name: "fixedArea" }, { name: "pcf" }, { name: "bias" }, { name: "normalBias" }, { name: "near" }, { name: "far" }, { name: "shadowDistance" }, { name: "invisibleOcclusionRange" }, { name: "orthoSize" }, { name: "saturation" }]), lt(FC.prototype, "SceneGlobals.prototype", [{ name: "distance", newName: "planeHeight" }, { name: "normal", newName: "planeDirection" }, { name: "size", newName: "shadowMapSize" }]), ft(ky.prototype, "Node.prototype", [{ name: "addLayer" }, { name: "removeLayer" }]), lt(Ev.prototype, "NodeUIProperties", [{ name: "opacityDirty", newName: "colorDirty" }]), ft(Iv, "Layers", [{ name: "All" }, { name: "RaycastMask" }, { name: "check" }]), lt(Iv, "Layers", [{ name: "Default", newName: "DEFAULT", target: Iv.Enum, targetName: "Layers.Enum" }, { name: "Always", newName: "ALWAYS", target: Iv.Enum, targetName: "Layers.Enum" }, { name: "IgnoreRaycast", newName: "IGNORE_RAYCAST", target: Iv.Enum, targetName: "Layers.Enum" }, { name: "Gizmos", newName: "GIZMOS", target: Iv.Enum, targetName: "Layers.Enum" }, { name: "Editor", newName: "EDITOR", target: Iv.Enum, targetName: "Layers.Enum" }, { name: "UI", newName: "UI_3D", target: Iv.Enum, targetName: "Layers.Enum" }, { name: "UI2D", newName: "UI_2D", target: Iv.Enum, targetName: "Layers.Enum" }, { name: "SceneGizmo", newName: "SCENE_GIZMO", target: Iv.Enum, targetName: "Layers.Enum" }, { name: "makeInclusiveMask", newName: "makeMaskInclude", target: Iv, targetName: "Layers" }, { name: "makeExclusiveMask", newName: "makeMaskExclude", target: Iv, targetName: "Layers" }]), ft(Iv.Enum, "Layers.Enum", [{ name: "ALWAYS" }]), ft(Iv.BitMask, "Layers.BitMask", [{ name: "ALWAYS" }]); var fP = t("PrivateNode", Gu("cc.PrivateNode")(ZR = function (t) { function e(e) { var i; return it(12003, (i = t.call(this, e) || this).name), i.hideFlags |= 1032, i } return s(e, t), e }(ky)) || ZR); function dP(t, e) { if (!e) { var i = T.director.getScene(); if (!i) return null; e = i } return e.getChildByPath(t) } lt(Vv, "SystemEventType", ["MOUSE_ENTER", "MOUSE_LEAVE", "TRANSFORM_CHANGED", "SCENE_CHANGED_FOR_PERSISTS", "SIZE_CHANGED", "ANCHOR_CHANGED", "COLOR_CHANGED", "CHILD_ADDED", "CHILD_REMOVED", "PARENT_CHANGED", "NODE_DESTROYED", "LAYER_CHANGED", "SIBLING_ORDER_CHANGED"].map((function (t) { return { name: t, target: ky.EventType, targetName: "Node.EventType" } }))), lt(ky.EventType, "Node.EventType", [{ name: "DEVICEMOTION", target: ZD.EventType, targetName: "SystemEvent.EventType" }, { name: "KEY_DOWN", target: ZD.EventType, targetName: "SystemEvent.EventType" }, { name: "KEY_UP", target: ZD.EventType, targetName: "SystemEvent.EventType" }]), T.PrivateNode = fP, St({ BaseNode: { newName: "Node", since: "3.7.0", removed: !1 } }), T.find = dP; var pP = ge, _P = 65536, gP = 2048; function mP(t, e) { for (var i = e.constructor._executionOrder, n = e._id, r = 0, s = t.length - 1, a = s >>> 1; r <= s; a = r + s >>> 1) { var o = t[a], u = o.constructor._executionOrder; if (u > i) s = a - 1; else if (u < i) r = a + 1; else { var h = o._id; if (h > n) s = a - 1; else { if (!(h < n)) return a; r = a + 1 } } } return ~r } function vP(t, e) { for (var i = t.array, n = t.i + 1; n < i.length;) { var r = i[n]; r.node._activeInHierarchy ? ++n : (t.removeAt(n), e && (r._objFlags &= ~e)) } } var yP = function () { function t(t) { var e = pe; this._zero = new e([]), this._neg = new e([]), this._pos = new e([]), this._invoke = t } return n(t, [{ key: "zero", get: function () { return this._zero } }, { key: "neg", get: function () { return this._neg } }, { key: "pos", get: function () { return this._pos } }]), t }(); function bP(t, e) { return t.constructor._executionOrder - e.constructor._executionOrder } yP.stableRemoveInactive = vP; var wP = function (t) { function e() { return t.apply(this, arguments) || this } s(e, t); var i = e.prototype; return i.add = function (t) { var e = t.constructor._executionOrder; (0 === e ? this._zero : e < 0 ? this._neg : this._pos).array.push(t) }, i.remove = function (t) { var e = t.constructor._executionOrder; (0 === e ? this._zero : e < 0 ? this._neg : this._pos).fastRemove(t) }, i.cancelInactive = function (t) { vP(this._zero, t), vP(this._neg, t), vP(this._pos, t) }, i.invoke = function () { var t = this._neg; t.array.length > 0 && (t.array.sort(bP), this._invoke(t), t.array.length = 0), this._invoke(this._zero), this._zero.array.length = 0; var e = this._pos; e.array.length > 0 && (e.array.sort(bP), this._invoke(e), e.array.length = 0) }, e }(yP), xP = function (t) { function e(e) { return t.call(this, e) || this } s(e, t); var i = e.prototype; return i.add = function (t) { var e = t.constructor._executionOrder; if (0 === e) this._zero.array.push(t); else { var i = e < 0 ? this._neg.array : this._pos.array, n = mP(i, t); n < 0 && i.splice(~n, 0, t) } }, i.remove = function (t) { var e = t.constructor._executionOrder; if (0 === e) this._zero.fastRemove(t); else { var i = e < 0 ? this._neg : this._pos, n = mP(i.array, t); n >= 0 && i.removeAt(n) } }, i.invoke = function (t) { this._neg.array.length > 0 && this._invoke(this._neg, t), this._invoke(this._zero, t), this._pos.array.length > 0 && this._invoke(this._pos, t) }, e }(yP); function SP(t, e, i) { var n = "var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];" + t + "}", r = e ? Function("it", "dt", n) : Function("it", n); return TP(Function("c", "dt", t), r, i) } function TP(t, e, i) { return function (n, r) { try { e(n, r) } catch (e) { T._throw(e); var s = n.array; for (i && (s[n.i]._objFlags |= i), ++n.i; n.i < s.length; ++n.i)try { t(s[n.i], r) } catch (t) { T._throw(t), i && (s[n.i]._objFlags |= i) } } } } var IP = SP("c.start();c._objFlags|=" + _P, !1, _P), EP = SP("c.update(dt)", !0), AP = SP("c.lateUpdate(dt)", !0), CP = function (t) { var e = T.director._compScheduler, i = t.array; for (t.i = 0; t.i < i.length; ++t.i) { var n = i[t.i]; n._enabled && (n.onEnable(), !n.node._activeInHierarchy || e._onEnabled(n)) } }, DP = function () { function t() { this._deferredComps = [], this.unscheduleAll() } var e = t.prototype; return e.unscheduleAll = function () { this.startInvoker = new wP(IP), this.updateInvoker = new xP(EP), this.lateUpdateInvoker = new xP(AP), this._updating = !1 }, e._onEnabled = function (t) { T.director.getScheduler().resumeTarget(t), t._objFlags |= gP, this._updating ? this._deferredComps.push(t) : this._scheduleImmediate(t) }, e._onDisabled = function (t) { T.director.getScheduler().pauseTarget(t), t._objFlags &= -2049; var e = this._deferredComps.indexOf(t); e >= 0 ? pP(this._deferredComps, e) : (!t.internalStart || t._objFlags & _P || this.startInvoker.remove(t), t.internalUpdate && this.updateInvoker.remove(t), t.internalLateUpdate && this.lateUpdateInvoker.remove(t)) }, e.enableComp = function (t, e) { if (!(t._objFlags & gP)) { if (t.internalOnEnable) { if (e) return void e.add(t); if (t.internalOnEnable(), !t.node.activeInHierarchy) return } this._onEnabled(t) } }, e.disableComp = function (t) { t._objFlags & gP && (t.internalOnDisable && t.internalOnDisable(), this._onDisabled(t)) }, e.startPhase = function () { this._updating = !0, this.startInvoker.invoke(), this._startForNewComps() }, e.updatePhase = function (t) { this.updateInvoker.invoke(t) }, e.lateUpdatePhase = function (t) { this.lateUpdateInvoker.invoke(t), this._updating = !1, this._startForNewComps() }, e._startForNewComps = function () { this._deferredComps.length > 0 && (this._deferredSchedule(), this.startInvoker.invoke()) }, e._scheduleImmediate = function (t) { "function" != typeof t.internalStart || t._objFlags & _P || this.startInvoker.add(t), "function" == typeof t.internalUpdate && this.updateInvoker.add(t), "function" == typeof t.internalLateUpdate && this.lateUpdateInvoker.add(t) }, e._deferredSchedule = function () { for (var t = this._deferredComps, e = 0, i = t.length; e < i; e++)this._scheduleImmediate(t[e]); t.length = 0 }, t }(), RP = 8192, PP = 32768, BP = 16384, MP = function (t) { function e(e) { return t.call(this, e) || this } s(e, t); var i = e.prototype; return i.add = function (t) { this._zero.array.push(t) }, i.remove = function (t) { this._zero.fastRemove(t) }, i.cancelInactive = function (t) { yP.stableRemoveInactive(this._zero, t) }, i.invoke = function () { this._invoke(this._zero), this._zero.array.length = 0 }, e }(yP), OP = SP("c.__preload();"), LP = SP("c.onLoad();c._objFlags|=" + BP, !1, BP), FP = new de(4); function kP(t, e, i) { rt(3817, t.name, i), H("Corrupted component value:", e), e ? t._removeComponent(e) : _e(t.getWritableComponents(), i) } FP.get = function () { var t = this._get() || { preload: new MP(OP), onLoad: new wP(LP), onEnable: new wP(CP) }; t.preload.zero.i = -1; var e = t.onLoad; return e.zero.i = -1, e.neg.i = -1, e.pos.i = -1, (e = t.onEnable).zero.i = -1, e.neg.i = -1, e.pos.i = -1, t }; var NP = t("NodeActivator", function () { function t() { this.reset() } var e = t.prototype; return e.reset = function () { this._activatingStack = [] }, e.activateNode = function (t, e) { if (e) { var i = FP.get(); i && (this._activatingStack.push(i), this._activateNodeRecursively(t, i.preload, i.onLoad, i.onEnable), i.preload.invoke(), i.onLoad.invoke(), i.onEnable.invoke(), this._activatingStack.pop(), FP.put(i)) } else { this._deactivateNodeRecursively(t); for (var n, r = p(this._activatingStack); !(n = r()).done;) { var s = n.value; s.preload.cancelInactive(RP), s.onLoad.cancelInactive(PP), s.onEnable.cancelInactive(2048) } } t.emit("active-in-hierarchy-changed", t) }, e.activateComp = function (t, e, i, n) { if (lo(t, !0) && (t._objFlags & RP || (t._objFlags |= RP, t.internalPreload && (e ? e.add(t) : t.internalPreload())), t._objFlags & PP || (t._objFlags |= PP, t.internalOnLoad ? i ? i.add(t) : (t.internalOnLoad(), t._objFlags |= BP) : t._objFlags |= BP), t._enabled)) { if (!t.node.activeInHierarchy) return; T.director._compScheduler.enableComp(t, n) } }, e.destroyComp = function (t) { T.director._compScheduler.disableComp(t), t.internalOnDestroy && t._objFlags & BP && t.internalOnDestroy() }, e._activateNodeRecursively = function (t, e, i, n) { if (256 & t._objFlags) rt(3816, t.name); else { t._setActiveInHierarchy(!0); for (var r = t.components.length, s = 0; s < r; ++s) { var a = t.components[s]; a instanceof T.Component ? this.activateComp(a, e, i, n) : (kP(t, a, s), --s, --r) } for (var o = 0, u = t.children.length; o < u; ++o) { var h = t.children[o]; h.active && this._activateNodeRecursively(h, e, i, n) } t._onPostActivated(!0) } }, e._deactivateNodeRecursively = function (t) { t._objFlags |= 256, t._setActiveInHierarchy(!1); for (var e = t.components.length, i = 0; i < e; ++i) { var n = t.components[i]; if (n._enabled && (T.director._compScheduler.disableComp(n), t.activeInHierarchy)) return void (t._objFlags &= -257) } for (var r = 0, s = t.children.length; r < s; ++r) { var a = t.children[r]; if (a.activeInHierarchy && (this._deactivateNodeRecursively(a), t.activeInHierarchy)) return void (t._objFlags &= -257) } t._onPostActivated(!1), t._objFlags &= -257 }, t }()), zP = Pi.Attr.DELIMETER + "default", UP = Pi.IDENTIFIER_RE, VP = "var ", GP = "o", HP = { "cc.ClickEvent": !1, "cc.PrefabInfo": !1 }, WP = Pi.escapeForJS, jP = function () { function t(t, e) { this.varName = t, this.expression = e } return t.prototype.toString = function () { return VP + this.varName + "=" + this.expression + ";" }, t }(); function XP(t, e) { return e instanceof jP ? new jP(e.varName, t + e.expression) : t + e } function qP(t, e, i) { Array.isArray(i) ? (i[0] = XP(e, i[0]), t.push(i)) : t.push(XP(e, i) + ";") } var YP = function () { function t(t) { this._exps = [], this._targetExp = t } var e = t.prototype; return e.setTargetExp = function (t) { this._targetExp = t }, e.append = function (t, e) { this._exps.push([t, e]) }, e.writeCode = function (t) { var e; if (this._exps.length > 1) t.push("t=" + this._targetExp + ";"), e = "t"; else { if (1 !== this._exps.length) return; e = this._targetExp } for (var i = 0; i < this._exps.length; i++) { var n = this._exps[i]; qP(t, e + KP(n[0]) + "=", n[1]) } }, t }(); function KP(t) { return UP.test(t) ? "." + t : "[" + WP(t) + "]" } YP.pool = new de((function (t) { t._exps.length = 0, t._targetExp = null }), 1), YP.pool.get = function (t) { var e = this._get() || new YP; return e.setTargetExp(t), e }; var QP, ZP, JP, $P, tB, eB, iB = function () { function t(t, e) { var i; this.objsToClear_iN$t = [], this.codeArray = [], this.objs = [], this.funcs = [], this.globalVariables = [], this.globalVariableId = 0, this.localVariableId = 0, this.parent = e, this.funcModuleCache = Nt(), Kt(this.funcModuleCache, HP), this.codeArray.push(VP + GP + ",t;", "if(R){", "o=R;", "}else{", "o=R=new " + this.getFuncModule(t.constructor, !0) + "();", "}"), t._iN$t = { globalVar: "R" }, this.objsToClear_iN$t.push(t), this.enumerateObject(this.codeArray, t), this.globalVariables.length > 0 && (i = VP + this.globalVariables.join(",") + ";"); var n = Uf(["return (function(R){", i || [], this.codeArray, "return o;", "})"]); this.result = Function("O", "F", n)(this.objs, this.funcs); for (var r = 0, s = this.objsToClear_iN$t.length; r < s; ++r)this.objsToClear_iN$t[r]._iN$t = null; this.objsToClear_iN$t.length = 0 } var e = t.prototype; return e.getFuncModule = function (t, e) { var i = zt(t); if (i) { var n = this.funcModuleCache[i]; if (n) return n; if (void 0 === n) { var r = -1 !== i.indexOf("."); if (r) try { if (r = t === Function("return " + i)()) return this.funcModuleCache[i] = i, i } catch (t) { } } } var s = this.funcs.indexOf(t); s < 0 && (s = this.funcs.length, this.funcs.push(t)); var a = "F[" + s + "]"; return e && (a = "(" + a + ")"), this.funcModuleCache[i] = a, a }, e.getObjRef = function (t) { var e = this.objs.indexOf(t); return e < 0 && (e = this.objs.length, this.objs.push(t)), "O[" + e + "]" }, e.setValueType = function (t, e, i, n) { var r = YP.pool.get(n), s = e.constructor.__props__; s || (s = Object.keys(e)); for (var a = 0; a < s.length; a++) { var o = s[a], u = i[o]; if (e[o] !== u) { var h = this.enumerateField(i, o, u); r.append(o, h) } } r.writeCode(t), YP.pool.put(r) }, e.enumerateCCClass = function (t, e, i) { for (var n = i.__values__, r = Pi.Attr.getClassAttrs(i), s = 0; s < n.length; s++) { var a = n[s], o = e[a], u = r[a + zP]; if (!nB(u, o)) if ("object" == typeof o && o instanceof S.ValueType && (u = Pi.getDefault(u)) && u.constructor === o.constructor) { var h = GP + KP(a); this.setValueType(t, u, o, h) } else this.setObjProp(t, e, a, o) } }, e.instantiateArray = function (t) { if (0 === t.length) return "[]"; var e = "a" + ++this.localVariableId, i = [new jP(e, "new Array(" + t.length + ")")]; t._iN$t = { globalVar: "", source: i }, this.objsToClear_iN$t.push(t); for (var n = 0; n < t.length; ++n)qP(i, e + "[" + n + "]=", this.enumerateField(t, n, t[n])); return i }, e.instantiateTypedArray = function (t) { var e = t.constructor.name; if (0 === t.length) return "new " + e; var i = "a" + ++this.localVariableId, n = [new jP(i, "new " + e + "(" + t.length + ")")]; t._iN$t = { globalVar: "", source: n }, this.objsToClear_iN$t.push(t); for (var r = 0; r < t.length; ++r)0 !== t[r] && qP(n, i + "[" + r + "]=", t[r]); return n }, e.enumerateField = function (t, e, i) { if ("object" == typeof i && i) { var n = i._iN$t; if (n) { var r = n.globalVar; if (!r) { r = n.globalVar = "v" + ++this.globalVariableId, this.globalVariables.push(r); var s = n.source[0]; n.source[0] = XP(r + "=", s) } return r } return ArrayBuffer.isView(i) ? this.instantiateTypedArray(i) : Array.isArray(i) ? this.instantiateArray(i) : this.instantiateObj(i) } return "function" == typeof i ? this.getFuncModule(i) : "string" == typeof i ? WP(i) : ("_objFlags" === e && co(t) && (i &= -4192741), i) }, e.setObjProp = function (t, e, i, n) { qP(t, GP + KP(i) + "=", this.enumerateField(e, i, n)) }, e.enumerateObject = function (t, e) { var i = e.constructor; if (Bi(i)) this.enumerateCCClass(t, e, i); else for (var n in e) if (Object.prototype.hasOwnProperty.call(e, n) && (95 !== n.charCodeAt(0) || 95 !== n.charCodeAt(1) || "__type__" === n)) { var r = e[n]; "object" == typeof r && r && r === e._iN$t || this.setObjProp(t, e, n, r) } }, e.instantiateObj = function (t) { if (t instanceof S.ValueType) return Pi.getNewValueTypeCode(t); if (t instanceof S.Asset) return this.getObjRef(t); if (1 & t._objFlags) return null; var e, i = t.constructor; if (Bi(i)) { if (this.parent) if (this.parent instanceof S.Component) { if (t instanceof S.Node || t instanceof S.Component) return this.getObjRef(t) } else if (this.parent instanceof S.Node) if (t instanceof S.Node) { if (!t.isChildOf(this.parent)) return this.getObjRef(t) } else if (t instanceof S.Component) { var n; if (null == (n = t.node) || !n.isChildOf(this.parent)) return this.getObjRef(t) } e = new jP(GP, "new " + this.getFuncModule(i, !0) + "()") } else if (i === Object) e = new jP(GP, "{}"); else { if (i) return this.getObjRef(t); e = new jP(GP, "Object.create(null)") } var r = [e]; return t._iN$t = { globalVar: "", source: r }, this.objsToClear_iN$t.push(t), this.enumerateObject(r, t), ["(function(){", r, "return o;})();"] }, t }(); function nB(t, e) { if ("function" == typeof t) try { t = t() } catch (t) { return !1 } if (t === e) return !0; if (t && e && "object" == typeof t && "object" == typeof e && t.constructor === e.constructor) if (t instanceof S.ValueType) { if (t.equals(e)) return !0 } else { if (Array.isArray(t)) return 0 === t.length && 0 === e.length; if (t.constructor === Object) return Bt(t) && Bt(e) } return !1 } var rB = Ee({ AUTO: 0, SINGLE_INSTANCE: 1, MULTI_INSTANCE: 2 }), sB = t("Prefab", Gu("cc.Prefab")((eB = function (t) { function e() { var e; return (e = t.call(this) || this).data = JP && JP(), e.optimizationPolicy = $P && $P(), e.persistent = tB && tB(), e._createFunction = null, e._instantiatedTimes = 0, e } s(e, t); var i = e.prototype; return i.createNode = function (t) { var e = T.instantiate(this); e.name = this.name, t(null, e) }, i.compileCreateFunction = function () { var t, e; this._createFunction = (e = (t = this.data) instanceof S.Node && t, new iB(t, e).result) }, i._doInstantiate = function (t) { return this.data._prefab || it(3700), this._createFunction || this.compileCreateFunction(), this._createFunction(t) }, i._instantiate = function () { var t; return this.optimizationPolicy !== rB.SINGLE_INSTANCE && (this.optimizationPolicy === rB.MULTI_INSTANCE || this._instantiatedTimes + 1 >= e.OptimizationPolicyThreshold) ? (t = this._doInstantiate(), this.data._instantiate(t)) : t = this.data._instantiate(), ++this._instantiatedTimes, t }, i.initDefault = function (e) { t.prototype.initDefault.call(this, e), this.data = new ky, this.data.name = "(Missing Node)"; var i = new T._PrefabInfo; i.asset = this, i.root = this.data, this.data._prefab = i }, i.validate = function () { return !!this.data }, i.onLoaded = function () { var t = this.data; tD(t), JC(t) }, e }(pg), eB.OptimizationPolicy = rB, eB.OptimizationPolicyThreshold = 3, JP = Bu((ZP = eB).prototype, "data", [eh], (function () { return null })), $P = Bu(ZP.prototype, "optimizationPolicy", [eh], (function () { return rB.AUTO })), tB = Bu(ZP.prototype, "persistent", [eh], (function () { return !1 })), QP = ZP)) || QP); Ot(sB, "_utils", uD), T.Prefab = sB, Ut(T, "cc._Prefab", "Prefab"); var aB = function () { function t() { this._allRenderers = [], this._dirtyRenderers = [], this._dirtyVersion = 0 } var e = t.prototype; return e.addRenderer = function (t) { -1 === t._internalId && (t._internalId = this._allRenderers.length, this._allRenderers.push(t)) }, e.removeRenderer = function (t) { if (-1 !== t._internalId) { var e = t._internalId; this._allRenderers[this._allRenderers.length - 1]._internalId = e, ge(this._allRenderers, e), t._internalId = -1, t._dirtyVersion === this._dirtyVersion && (ve(this._dirtyRenderers, t), t._dirtyVersion = -1) } }, e.markDirtyRenderer = function (t) { t._dirtyVersion !== this._dirtyVersion && -1 !== t._internalId && (this._dirtyRenderers.push(t), t._dirtyVersion = this._dirtyVersion) }, e.updateAllDirtyRenderers = function () { for (var t = this._dirtyRenderers, e = 0; e < this._dirtyRenderers.length; e++)t[e].updateRenderer(); this._dirtyRenderers.length = 0, this._dirtyVersion++ }, t }(), oB = new aB, uB = [".png", ".jpg", ".bmp", ".jpeg", ".gif", ".ico", ".tiff", ".webp", ".image", ".pvr", ".pkm", ".astc"], hB = [".mp3", ".ogg", ".wav", ".m4a"]; function cB() { return !0 } var lB = { transformURL: function (t) { var e = tg(t); if (!e) return t; var i = V_.find((function (t) { return !!t.getAssetInfo(e) })); if (!i) return t; var n, r = i.getAssetInfo(e); if (!(n = t.startsWith(i.base + i.config.nativeBase) ? r.nativeVer || "" : r.ver || "") || -1 !== t.indexOf(n)) return t; var s = !1; if (".ttf" === Lo(t) && (s = !0), s) { var a = No(t), o = ko(t); t = a + "." + n + "/" + o } else t = t.replace(/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,})/, (function (t) { return t + "." + n })); return t } }, fB = t("CCLoader", function () { function t() { this._autoReleaseSetting = Object.create(null), this._parseLoadResArgs = Fx } var e = t.prototype; return e.load = function (t, e, i) { void 0 === i && void 0 !== e && (i = e, e = null); for (var n = Array.isArray(t) ? t : [t], r = 0; r < n.length; r++) { var s = n[r]; "string" == typeof s ? n[r] = { url: s, __isNative__: !0 } : (s.type && (s.ext = "." + s.type, s.type = void 0), s.url && (s.__isNative__ = !0)) } var a = [], o = []; WS.loadAny(n, null, (function (t, i, n) { n.content && (uB.includes(n.ext) ? a.push(n.content) : hB.includes(n.ext) && o.push(n.content)), e && e(t, i, n) }), (function (t, e) { var r = null; if (!t) { e = Array.isArray(e) ? e : [e]; for (var s = function (t) { var i = e[t]; if (!(i instanceof pg)) { var r = i, s = n[t].url; a.includes(r) ? xS.create(s, i, ".png", {}, (function (i, n) { r = e[t] = n })) : o.includes(r) && xS.create(s, i, ".mp3", {}, (function (i, n) { r = e[t] = n })), N_.add(s, r) } }, u = 0; u < e.length; u++)s(u); if (e.length > 1) { var h = Object.create(null); e.forEach((function (t) { h[t._uuid] = t })), r = { isCompleted: cB, _map: h } } else r = e[0] } i && i(t, r) })) }, e.getXMLHttpRequest = function () { return new XMLHttpRequest }, e.getItem = function (t) { return WS.assets.has(t) ? { content: WS.assets.get(t) } : null }, e.loadRes = function (t, e, i, n) { var r = this._parseLoadResArgs(e, i, n), s = r.type, a = r.onProgress, o = r.onComplete, u = Lo(t); u && !Ux.getInfoWithPath(t, s) && (t = t.slice(0, -u.length)), Ux.load(t, s, a, o) }, e.loadResArray = function (t, e, i, n) { var r = this._parseLoadResArgs(e, i, n), s = r.type, a = r.onProgress, o = r.onComplete; t.forEach((function (e, i) { var n = Lo(e); n && !Ux.getInfoWithPath(e, s) && (t[i] = e.slice(0, -n.length)) })), Ux.load(t, s, a, o) }, e.loadResDir = function (t, e, i, n) { var r = this._parseLoadResArgs(e, i, n), s = r.type, a = r.onProgress, o = r.onComplete; Ux.loadDir(t, s, a, (function (e, i) { var n = []; e || (n = Ux.getDirWithPath(t, s).map((function (t) { return t.path }))), o && o(e, i, n) })) }, e.getRes = function (t, e) { return N_.has(t) ? N_.get(t) : Ux.get(t, e) }, e.getResCount = function () { return N_.count }, e.getDependsRecursively = function (t) { if (!t) return []; var e = "string" == typeof t ? t : t._uuid; return hv.getDepsRecursively(e).concat([e]) }, e.addDownloadHandlers = function (t) { var e = Object.create(null), i = function () { var i = t[n]; e["." + n] = function (t, e, n) { i({ url: t }, n) } }; for (var n in t) i(); hS.register(e) }, e.addLoadHandlers = function (t) { var e = Object.create(null), i = function () { var i = t[n]; e["." + n] = function (t, e, n) { i({ content: t }, n) } }; for (var n in t) i(); RS.register(e) }, e.release = function (t) { if (Array.isArray(t)) for (var e = 0; e < t.length; e++) { var i = t[e]; "string" == typeof i && (i = N_.get(i)), WS.releaseAsset(i) } else t && ("string" == typeof t && (t = N_.get(t)), WS.releaseAsset(t)) }, e.releaseAsset = function (t) { WS.releaseAsset(t) }, e.releaseRes = function (t, e) { Ux.release(t, e) }, e.releaseAll = function () { WS.releaseAll(), N_.clear() }, e.removeItem = function (t) { return !!N_.remove(t) }, e.setAutoRelease = function (t, e) { "object" == typeof t && (t = t._uuid), this._autoReleaseSetting[t] = !!e }, e.setAutoReleaseRecursively = function (t, e) { "object" == typeof t && (t = t._uuid), e = !!e, this._autoReleaseSetting[t] = e; for (var i = hv.getDepsRecursively(t), n = 0; n < i.length; n++)this._autoReleaseSetting[i[n]] = e }, e.isAutoRelease = function (t) { return "object" == typeof t && (t = t._uuid), !!this._autoReleaseSetting[t] }, n(t, [{ key: "onProgress", set: function (t) { Ex = t } }, { key: "_cache", get: function () { if (N_ instanceof F_) return N_.map; var t = {}; return N_.forEach((function (e, i) { t[i] = e })), t } }, { key: "md5Pipe", get: function () { return lB } }, { key: "downloader", get: function () { return hS } }, { key: "loader", get: function () { return WS.parser } }]), t }()), dB = t("loader", new fB), pB = t("AssetLibrary", { init: function (t) { t.importBase = t.libraryPath, t.nativeBase = t.rawAssetsBase, WS.init(t), t.rawAssets && Ux.init({ base: "", deps: [], scenes: {}, redirect: [], debug: !0, packs: {}, types: [], versions: { import: [], native: [] }, name: "resources", importBase: t.importBase, nativeBase: t.nativeBase, paths: t.rawAssets.assets, uuids: Object.keys(t.rawAssets.assets), extensionMap: {} }) }, loadAsset: function (t, e) { WS.loadAny(t, e) } }), _B = t("url", {}); lt(_B, "url", [{ name: "normalize", target: WS.utils, targetName: "assetManager.utils", newName: "normalize" }, { name: "raw", targetName: "Asset.prototype", newName: "nativeUrl", customFunction: function (t) { return t.startsWith("resources/") ? rg({ path: zo(t.substring(10)), bundle: "resources", __isNative__: !0, ext: Lo(t) }) : "" } }]), ft(pB, "AssetLibrary", [{ name: "getLibUrlNoExt", suggest: "AssetLibrary.getLibUrlNoExt was removed, if you want to transform url, please use assetManager.utils.getUrlWithUuid instead" }, { name: "queryAssetInfo", suggest: "AssetLibrary.queryAssetInfo was removed" }]), ft(dB, "loader", [{ name: "releaseResDir", suggest: "loader.releaseResDir was removed, please use assetManager.releaseAsset instead" }, { name: "flowInDeps", suggest: "loader.flowInDeps was removed" }, { name: "assetLoader", suggest: "loader.assetLoader was removed, assetLoader and md5Pipe were merged into assetManager.transformPipeline" }]), lt(S, "cc", [{ name: "loader", newName: "assetManager", logTimes: 1, customGetter: function () { return dB } }, { name: "AssetLibrary", newName: "assetManager", logTimes: 1, customGetter: function () { return pB } }, { name: "Pipeline", target: HS, targetName: "AssetManager", newName: "Pipeline", logTimes: 1 }, { name: "url", targetName: "assetManager", newName: "utils", logTimes: 1, customGetter: function () { return _B } }]), ft(S, "cc", [{ name: "LoadingItems", suggest: ut(1400, "LoadingItems", "AssetManager.Task") }]), lt(Le, "macro", [{ name: "DOWNLOAD_MAX_CONCURRENT", target: hS, targetName: "assetManager.downloader", newName: "maxConcurrency" }]); var gB = Ix._autoRelease; Ix._autoRelease = function (t, e, i) { gB.call(Ix, t, e, i); for (var n = dB._autoReleaseSetting, r = Object.keys(n), s = 0; s < r.length; s++) { var a = r[s]; if (!0 === n[a]) { var o = N_.get(a); o && Ix.tryRelease(o) } } }; var mB = t("DirectorEvent", { INIT: "director_init", RESET: "director_reset", BEFORE_SCENE_LOADING: "director_before_scene_loading", BEFORE_SCENE_LAUNCH: "director_before_scene_launch", AFTER_SCENE_LAUNCH: "director_after_scene_launch", BEFORE_UPDATE: "director_before_update", AFTER_UPDATE: "director_after_update", BEFORE_DRAW: "director_before_draw", AFTER_DRAW: "director_after_draw", BEFORE_COMMIT: "director_before_commit", BEFORE_RENDER: "director_before_render", AFTER_RENDER: "director_after_render", BEFORE_PHYSICS: "director_before_physics", AFTER_PHYSICS: "director_after_physics", BEGIN_FRAME: "director_begin_frame", END_FRAME: "director_end_frame" }), vB = t("Director", function (t) { function e() { var e; return (e = t.call(this) || this)._compScheduler = new DP, e._nodeActivator = new NP, e._invalid = !1, e._paused = !1, e._root = null, e._loadingScene = "", e._scene = null, e._totalFrames = 0, e._scheduler = new Pf, e._systems = [], e._persistRootNodes = {}, e } s(e, t); var i = e.prototype; return i.end = function () { var t = this; this.once("director_end_frame", (function () { t.purgeDirector() })) }, i.pause = function () { this._paused = !0 }, i.purgeDirector = function () { this._scheduler.unscheduleAll(), this._compScheduler.unscheduleAll(), this._nodeActivator.reset(), lo(this._scene) && this._scene.destroy(), this._scene = null, this.stopAnimation(), WS.releaseAll() }, i.reset = function () { for (var t in this.purgeDirector(), this._persistRootNodes) this.removePersistRootNode(this._persistRootNodes[t]); var e = this.getScene(); e && e.destroy(), this.emit("director_reset"), this.startAnimation() }, i.runSceneImmediate = function (t, e, i) { var n = this; t instanceof cD && (t = t.scene), at(t instanceof hD, 1216), t._load(); for (var r = Object.keys(this._persistRootNodes).map((function (t) { return n._persistRootNodes[t] })), s = 0; s < r.length; s++) { var a = r[s]; a.emit("scene-changed-for-persists", t.renderScene); var o = t.uuid === a._originalSceneId && t.getChildByUuid(a.uuid); if (o) { var u = o.siblingIndex; a.hideFlags &= -9, a.hideFlags |= 8 & o.hideFlags, o._destroyImmediate(), t.insertChild(a, u) } else a.hideFlags |= 8, a.parent = t } var h = this._scene; lo(h) && h.destroy(), Ix._autoRelease(h, t, this._persistRootNodes), this._scene = null, oo._deferredDestroy(), e && e(), this.emit("director_before_scene_launch", t), this._scene = t, t._activate(), this._root && this._root.resetCumulativeTime(), this.startAnimation(), i && i(null, t), this.emit("director_after_scene_launch", t) }, i.runScene = function (t, e, i) { var n = this; t instanceof cD && (t = t.scene), at(Boolean(t), 1205), at(t instanceof hD, 1216), this.once("director_end_frame", (function () { n.runSceneImmediate(t, e, i) })) }, i.loadScene = function (t, e, i) { var n = this; if (this._loadingScene) return it(1208, t, this._loadingScene), !1; var r = WS.bundles.find((function (e) { return !!e.getSceneInfo(t) })); return r ? (this.emit("director_before_scene_loading", t), this._loadingScene = t, console.time("LoadScene " + t), r.loadScene(t, (function (r, s) { console.timeEnd("LoadScene " + t), n._loadingScene = "", r ? (j(r), e && e(r)) : n.runSceneImmediate(s, i, e) })), !0) : (rt(1209, t), !1) }, i.preloadScene = function (t, e, i) { var n = WS.bundles.find((function (e) { return !!e.getSceneInfo(t) })); if (n) n.preloadScene(t, null, e, i); else { var r = 'Can not preload the scene "' + t + '" because it is not in the build settings.'; i && i(new Error(r)), j("preloadScene: " + r) } }, i.resume = function () { this._paused = !1 }, i.getScene = function () { return this._scene }, i.getDeltaTime = function () { return S.game.deltaTime }, i.getTotalTime = function () { return S.game.totalTime }, i.getCurrentTime = function () { return S.game.frameStartTime }, i.getTotalFrames = function () { return this._totalFrames }, i.isPaused = function () { return this._paused }, i.getScheduler = function () { return this._scheduler }, i.setScheduler = function (t) { this._scheduler !== t && (this.unregisterSystem(this._scheduler), this._scheduler = t, this.registerSystem(Pf.ID, t, 200)) }, i.registerSystem = function (t, e, i) { e.id = t, e.priority = i, this._systems.push(e), this._systems.sort(If.sortByPriority) }, i.unregisterSystem = function (t) { ve(this._systems, t), this._systems.sort(If.sortByPriority) }, i.getSystem = function (t) { return this._systems.find((function (e) { return e.id === t })) }, i.getAnimationManager = function () { return this.getSystem(S.AnimationManager.ID) }, i.startAnimation = function () { this._invalid = !1 }, i.stopAnimation = function () { this._invalid = !0 }, i.mainLoop = function () { var t; t = S.game._calculateDT(!1), this.tick(t) }, i.tick = function (t) { if (!this._invalid) { if (this.emit("director_begin_frame"), QD._frameDispatchEvents(), !this._paused) { this.emit("director_before_update"), this._compScheduler.startPhase(), this._compScheduler.updatePhase(t); for (var e = 0; e < this._systems.length; ++e)this._systems[e].update(t); this._compScheduler.lateUpdatePhase(t), this.emit("director_after_update"), oo._deferredDestroy(); for (var i = 0; i < this._systems.length; ++i)this._systems[i].postUpdate(t) } this.emit("director_before_draw"), oB.updateAllDirtyRenderers(), this._root.frameMove(t), this.emit("director_after_draw"), ky.resetHasChangedFlags(), ky.clearNodeArray(), $a.update(t), this.emit("director_end_frame"), this._totalFrames++ } }, i.buildRenderPipeline = function () { if (this._root) { var t = this._root.customPipeline, e = this._root.cameraList; t.beginSetup(); var i = S.rendering.getCustomPipeline(Le.CUSTOM_PIPELINE_NAME); S.rendering.dispatchResizeEvents(e, i, t), i.setup(e, t), t.endSetup() } }, i.setupRenderPipelineBuilder = function () { "" !== Le.CUSTOM_PIPELINE_NAME && S.rendering && this._root && this._root.usesCustomPipeline && this.on("director_before_scene_launch", S.rendering.forceResizeAllWindows, S.rendering) }, i.init = function () { this._totalFrames = 0, this._paused = !1, this.registerSystem(Pf.ID, this._scheduler, 200), this._root = new lP(B_.gfxDevice), this._root.initialize({}), this.setupRenderPipelineBuilder(); for (var t = 0; t < this._systems.length; t++)this._systems[t].init(); this.emit("director_init") }, i.addPersistRootNode = function (t) { if (ky.isNode(t) && t.uuid) { var e = t.uuid; if (!this._persistRootNodes[e]) { var i = this._scene; if (lo(i)) if (t.parent) { if (!(t.parent instanceof hD)) return void it(3801); if (t.parent !== i) return void it(3802); t._originalSceneId = i.uuid } else t.parent = i, t._originalSceneId = i.uuid; this._persistRootNodes[e] = t, t._persistNode = !0, Ix._addPersistNodeRef(t) } } else it(3800) }, i.removePersistRootNode = function (t) { var e = t.uuid || ""; t === this._persistRootNodes[e] && (delete this._persistRootNodes[e], t._persistNode = !1, t._originalSceneId = "", Ix._removePersistNodeRef(t)) }, i.isPersistRootNode = function (t) { return !!t._persistNode }, n(e, [{ key: "root", get: function () { return this._root } }]), e }(wo)); vB.EVENT_INIT = "director_init", vB.EVENT_RESET = "director_reset", vB.EVENT_BEFORE_SCENE_LOADING = "director_before_scene_loading", vB.EVENT_BEFORE_SCENE_LAUNCH = "director_before_scene_launch", vB.EVENT_AFTER_SCENE_LAUNCH = "director_after_scene_launch", vB.EVENT_BEFORE_UPDATE = "director_before_update", vB.EVENT_AFTER_UPDATE = "director_after_update", vB.EVENT_BEFORE_DRAW = "director_before_draw", vB.EVENT_AFTER_DRAW = "director_after_draw", vB.EVENT_BEFORE_COMMIT = "director_before_commit", vB.EVENT_BEFORE_RENDER = "director_before_render", vB.EVENT_AFTER_RENDER = "director_after_render", vB.EVENT_BEFORE_PHYSICS = "director_before_physics", vB.EVENT_AFTER_PHYSICS = "director_after_physics", vB.EVENT_BEGIN_FRAME = "director_begin_frame", vB.EVENT_END_FRAME = "director_end_frame", vB.instance = void 0, S.Director = vB, S.DirectorEvent = mB; var yB = t("director", vB.instance = S.director = new vB); var bB, wB = function () { function t() { var t = this; this._stHandle = 0, this._onTick = null, this._targetFrameRate = 60, this._frameTime = 0, this._startTime = 0, this._isPlaying = !1, this._frameCount = 0, this._callback = null, this._rAF = void 0, this._cAF = void 0, this._handleRAF = function () { var e = performance.now(), i = e - t._startTime, n = Math.floor(i / t._frameTime); n < 0 && (t._startTime = e, t._frameCount = 0), n < t._frameCount ? t._stHandle = t._rAF.call(window, t._handleRAF) : (t._frameCount = n + 1, t._callback && t._callback()) }, this._frameTime = 1e3 / this._targetFrameRate, this._rAF = window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame, this._cAF = window.cancelAnimationFrame || window.cancelRequestAnimationFrame || window.msCancelRequestAnimationFrame || window.mozCancelRequestAnimationFrame || window.oCancelRequestAnimationFrame || window.webkitCancelRequestAnimationFrame || window.msCancelAnimationFrame || window.mozCancelAnimationFrame || window.webkitCancelAnimationFrame || window.ocancelAnimationFrame } var e = t.prototype; return e.start = function () { var t = this; if (!this._isPlaying) { var e = void 0 === this._rAF || w; this._startTime = performance.now(), this._stHandle = this._stTime((function i() { e && (t._startTime = performance.now()), t._isPlaying && (t._stHandle = t._stTime(i)), t._onTick && t._onTick() })), this._isPlaying = !0, this._frameCount = 0 } }, e.stop = function () { this._isPlaying && (this._ctTime(this._stHandle), this._stHandle = 0, this._isPlaying = !1, this._frameCount = 0) }, e._stTime = function (t) { if (void 0 === this._rAF) { var e = performance.now(), i = Math.max(0, e - this._startTime), n = Math.max(0, this._frameTime - i); return setTimeout(t, n) } return this._callback = t, this._rAF.call(window, this._handleRAF) }, e._ctTime = function (t) { void 0 === this._cAF ? clearTimeout(t) : t && this._cAF.call(window, t) }, n(t, [{ key: "targetFrameRate", get: function () { return this._targetFrameRate }, set: function (t) { this._targetFrameRate !== t && (this._targetFrameRate = t, this._frameTime = 1e3 / this._targetFrameRate, this._isPlaying && (this.stop(), this.start())) } }, { key: "onTick", get: function () { return this._onTick }, set: function (t) { this._onTick = t } }]), t }(), xB = t("PipelineInputAssemblerData", (function () { this.quadIB = null, this.quadVB = null, this.quadIA = null })); ft(Fg.prototype, "TextureBase.prototype", [{ name: "hasPremultipliedAlpha" }, { name: "setPremultiplyAlpha" }, { name: "setFlipY" }]), lt(KR.prototype, "RenderTexture.prototype", [{ name: "getGFXWindow", customFunction: function () { return this.window } }]); var SB = ((bB = {})[1] = "Uint", bB[2] = "Int", bB[3] = "Uint", bB[4] = "Int", bB[5] = "Float", bB[6] = "Float", bB.default = "Uint", bB); function TB(t) { return "" + (SB[t.type] || SB.default) + t.size / t.count * 8 } function IB(t, e, i, n, r) { void 0 === i && (i = 11), void 0 === n && (n = 0), void 0 === r && (r = 0); var s = Wp[i]; r || (r = s.size); for (var a = "set" + TB(s), o = s.size / s.count, u = Math.floor(e.length / s.count), h = tu.isLittleEndian, c = 0; c < u; ++c)for (var l = n + r * c, f = 0; f < s.count; ++f) { var d = l + o * f; t[a](d, e[s.count * c + f], h) } } function EB(t, e, i, n, r, s, a) { void 0 === i && (i = 11), void 0 === n && (n = 0), void 0 === r && (r = t.byteLength - n), void 0 === s && (s = 0), a || (a = new DataView(t.buffer.slice(t.byteOffset, t.byteOffset + t.byteLength))); var o = Wp[i]; s || (s = o.size); for (var u = "set" + TB(o), h = "get" + TB(o), c = o.size / o.count, l = Math.floor(r / s), f = tu.isLittleEndian, d = 0; d < l; ++d)for (var p = n + s * d, _ = 0; _ < o.count; ++_) { var g = p + c * _, m = t[h](g, f); a[u](g, e(m, _, t), f) } return a } var AB, CB = { positions: new Float32Array, indices: new Uint8Array, boundingBox: { min: Kn.ZERO, max: Kn.ZERO } }, DB = t("RenderingSubMesh", function () { function t(t, e, i, n, r, s) { void 0 === n && (n = null), void 0 === r && (r = null), void 0 === s && (s = !0), this.mesh = void 0, this.subMeshIdx = void 0, this._flatBuffers = [], this._jointMappedBuffers = void 0, this._jointMappedBufferIndices = void 0, this._vertexIdChannel = void 0, this._geometricInfo = void 0, this._vertexBuffers = void 0, this._drawInfo = null, this._attributes = e, this._vertexBuffers = t, this._indexBuffer = n, this._indirectBuffer = r, this._primitiveMode = i, this._iaInfo = new gp(e, t, n, r), this._isOwnerOfIndexBuffer = s } var e = t.prototype; return e.invalidateGeometricInfo = function () { this._geometricInfo = void 0 }, e.genFlatBuffers = function () { if (!this._flatBuffers.length && this.mesh && void 0 !== this.subMeshIdx) { var t = this.mesh, e = 0, i = t.struct.primitives[this.subMeshIdx]; i.indexView && (e = i.indexView.count); for (var n = 0; n < i.vertexBundelIndices.length; n++) { var r = i.vertexBundelIndices[n], s = t.struct.vertexBundles[r], a = i.indexView ? i.indexView.count : s.view.count, o = s.view.stride, u = o * a, h = new Uint8Array(t.data.buffer, s.view.offset, s.view.length), c = new Uint8Array(i.indexView ? u : s.view.length); if (i.indexView) { for (var l = t.readIndices(this.subMeshIdx), f = 0; f < e; ++f)for (var d = f * o, p = l[f] * o, _ = 0; _ < o; ++_)c[d + _] = h[p + _]; this._flatBuffers.push({ stride: o, count: a, buffer: c }) } else c.set(t.data.subarray(s.view.offset, s.view.offset + s.view.length)), this._flatBuffers.push({ stride: o, count: a, buffer: c }) } } }, e.destroy = function () { for (var t = 0; t < this.vertexBuffers.length; t++)this.vertexBuffers[t].destroy(); if (this.vertexBuffers.length = 0, this._indexBuffer && (this._isOwnerOfIndexBuffer && this._indexBuffer.destroy(), this._indexBuffer = null), this._jointMappedBuffers && this._jointMappedBufferIndices) { for (var e = 0; e < this._jointMappedBufferIndices.length; e++)this._jointMappedBuffers[this._jointMappedBufferIndices[e]].destroy(); this._jointMappedBuffers = void 0, this._jointMappedBufferIndices = void 0 } this._indirectBuffer && (this._indirectBuffer.destroy(), this._indirectBuffer = null) }, e.enableVertexIdChannel = function (t) { if (!this._vertexIdChannel) { var e = this.vertexBuffers.length, i = this.attributes.length, n = this._allocVertexIdBuffer(t); this._vertexBuffers.push(n), this._attributes.push(new pp("a_vertexId", 11, !1, e)), this._iaInfo.attributes = this._attributes, this._iaInfo.vertexBuffers = this._vertexBuffers, this._vertexIdChannel = { stream: e, index: i } } }, e._allocVertexIdBuffer = function (t) { for (var e = 0 === this.vertexBuffers.length || 0 === this.vertexBuffers[0].stride ? 0 : this.vertexBuffers[0].size / this.vertexBuffers[0].stride, i = new Float32Array(e), n = 0; n < e; ++n)i[n] = n + .5; var r = t.createBuffer(new Zd(10, 1, i.byteLength, i.BYTES_PER_ELEMENT)); return r.update(i), r }, n(t, [{ key: "attributes", get: function () { return this._attributes } }, { key: "vertexBuffers", get: function () { return this._vertexBuffers } }, { key: "indexBuffer", get: function () { return this._indexBuffer } }, { key: "indirectBuffer", get: function () { return this._indirectBuffer } }, { key: "primitiveMode", get: function () { return this._primitiveMode } }, { key: "geometricInfo", get: function () { if (this._geometricInfo) return this._geometricInfo; if (void 0 === this.mesh) return CB; if (void 0 === this.subMeshIdx) return CB; var t, e = this.mesh, i = this.subMeshIdx, n = this.attributes.find((function (t) { return "a_position" === t.name })); if (!n) return CB; switch (n.format) { case 21: case 32: if (!(t = e.readAttribute(i, "a_position"))) return CB; break; case 44: var r = e.readAttribute(i, "a_position"); if (!r) return CB; var s = r.length / 4; t = new Float32Array(3 * s); for (var a = 0; a < s; ++a) { var o = 3 * a, u = 4 * a; t[o] = r[u], t[o + 1] = r[u + 1], t[o + 2] = r[u + 2] } break; case 18: case 29: var h = e.readAttribute(i, "a_position"); if (!h) return CB; t = new Float32Array(h.length); for (var c = 0; c < h.length; ++c)t[c] = mn(h[c]); break; case 41: var l = e.readAttribute(i, "a_position"); if (!l) return CB; var f = l.length / 4; t = new Float32Array(3 * f); for (var d = 0; d < f; ++d) { var p = 3 * d, _ = 4 * d; t[p] = mn(l[_]), t[p + 1] = mn(l[_ + 1]), t[p + 2] = mn(l[_ + 2]) } break; default: return CB }var g = e.readIndices(i) || void 0, m = new Kn, v = new Kn, y = Wp[n.format].count; 2 === y ? (m.set(t[0], t[1], 0), v.set(t[0], t[1], 0)) : (m.set(t[0], t[1], t[2]), v.set(t[0], t[1], t[2])); for (var b = 0; b < t.length; b += y)2 === y ? (m.x = t[b] > m.x ? t[b] : m.x, m.y = t[b + 1] > m.y ? t[b + 1] : m.y, v.x = t[b] < v.x ? t[b] : v.x, v.y = t[b + 1] < v.y ? t[b + 1] : v.y) : (m.x = t[b] > m.x ? t[b] : m.x, m.y = t[b + 1] > m.y ? t[b + 1] : m.y, m.z = t[b + 2] > m.z ? t[b + 2] : m.z, v.x = t[b] < v.x ? t[b] : v.x, v.y = t[b + 1] < v.y ? t[b + 1] : v.y, v.z = t[b + 2] < v.z ? t[b + 2] : v.z); return this._geometricInfo = { positions: t, indices: g, boundingBox: { max: m, min: v } }, this._geometricInfo } }, { key: "drawInfo", get: function () { return this._drawInfo }, set: function (t) { this._drawInfo = t } }, { key: "flatBuffers", get: function () { return this._flatBuffers } }, { key: "jointMappedBuffers", get: function () { var t = this; if (this._jointMappedBuffers) return this._jointMappedBuffers; var e = this._jointMappedBuffers = [], i = this._jointMappedBufferIndices = []; if (!this.mesh || void 0 === this.subMeshIdx) return this._jointMappedBuffers = this.vertexBuffers; var n, r, s = this.mesh.struct, a = s.primitives[this.subMeshIdx]; if (!s.jointMaps || void 0 === a.jointMapIndex || !s.jointMaps[a.jointMapIndex]) return this._jointMappedBuffers = this.vertexBuffers; for (var o = S.director.root.device, u = function () { var u = s.vertexBundles[a.vertexBundelIndices[h]]; r = 0, n = 0; for (var c = 0; c < u.attributes.length; c++) { var l = u.attributes[c]; if ("a_joints" === l.name) { n = l.format; break } r += Wp[l.format].size } if (n) { var f = new Uint8Array(t.mesh.data.buffer, u.view.offset, u.view.length), d = new DataView(f.slice().buffer), p = s.jointMaps[a.jointMapIndex]; EB(d, (function (t) { return p.indexOf(t) }), n, r, u.view.length, u.view.stride, d); var _ = o.createBuffer(new Zd(10, 1, u.view.length, u.view.stride)); _.update(d.buffer), e.push(_), i.push(h) } else e.push(t.vertexBuffers[a.vertexBundelIndices[h]]) }, h = 0; h < a.vertexBundelIndices.length; h++)u(); return this._vertexIdChannel && e.push(this._allocVertexIdBuffer(o)), e } }, { key: "iaInfo", get: function () { return this._iaInfo } }]), t }()), RB = new Gr, PB = new Gr, BB = new Gr, MB = new Gr, OB = new Gr, LB = new Gr, FB = new Gr, kB = new Kn(0, 0, 0), NB = new Kn, zB = new as, UB = new Kn, VB = new Kn, GB = new Kn(1e7, 1e7, 1e7), HB = new Kn(-1e7, -1e7, -1e7), WB = new Kn, jB = 0, XB = 0, qB = function () { function t(t) { this._shadowObjects = [], this._shadowCameraFar = 0, this._matShadowView = new Gr, this._matShadowProj = new Gr, this._matShadowViewProj = new Gr, this._validFrustum = new yu, this._splitFrustum = new yu, this._lightViewFrustum = new yu, this._castLightViewBoundingBox = new hu, this._level = t, this._validFrustum.accurate = !0, this._splitFrustum.accurate = !0, this._lightViewFrustum.accurate = !0 } var e = t.prototype; return e.copyToValidFrustum = function (t) { yu.copy(this._validFrustum, t) }, e.calculateValidFrustumOrtho = function (t, e, i, n, r) { yu.createOrtho(this._validFrustum, t, e, i, n, r) }, e.calculateSplitFrustum = function (t, e, i, n) { this._splitFrustum.split(i, n, t.aspect, t.fov, e) }, e.destroy = function () { this._shadowObjects.length = 0 }, e.createMatrix = function (t, e, i) { var n = S.director.root.device, r = t.shadowInvisibleOcclusionRange; yu.copy(this._lightViewFrustum, this._splitFrustum), Gr.fromRT(PB, t.node.rotation, kB), Gr.invert(BB, PB); var s, a, o = BB.clone(); this._lightViewFrustum.transform(BB), hu.fromPoints(this._castLightViewBoundingBox, GB, HB), this._castLightViewBoundingBox.mergeFrustum(this._lightViewFrustum), t.csmOptimizationMode === wT.DisableRotationFix ? (s = 2 * this._castLightViewBoundingBox.halfExtents.x, a = 2 * this._castLightViewBoundingBox.halfExtents.y) : s = a = Kn.distance(this._lightViewFrustum.vertices[0], this._lightViewFrustum.vertices[6]); var u = S.director.root.pipeline.pipelineSceneData.csmSupported ? t.csmLevel : 1; if (u > 1 && t.csmOptimizationMode === wT.RemoveDuplicates) if (this._level >= u - 1) XB = this._castLightViewBoundingBox.halfExtents.z, jB = this._castLightViewBoundingBox.center.z; else { var h = Math.abs(this._castLightViewBoundingBox.center.z - jB) + XB; this._castLightViewBoundingBox.halfExtents.z = Math.max(this._castLightViewBoundingBox.center.z, h) } var c = this._castLightViewBoundingBox.halfExtents.z; this._shadowCameraFar = 2 * c + r; var l = this._castLightViewBoundingBox.center; if (WB.set(l.x, l.y, l.z + c + r), Kn.transformMat4(WB, WB, PB), Gr.fromRT(PB, t.node.rotation, WB), Gr.invert(BB, PB), !i) { var f = .5 * s, d = .5 * a; Gr.ortho(MB, -f, f, -d, d, .1, this._shadowCameraFar, n.capabilities.clipSpaceMinZ, n.capabilities.clipSpaceSignY), Gr.multiply(LB, MB, o), Kn.transformMat4(NB, WB, LB); var p = 2 / e; zB.set(p, p); var _ = NB.x % zB.x, g = NB.y % zB.y; UB.set(NB.x - _, NB.y - g, NB.z), Gr.invert(FB, LB), Kn.transformMat4(VB, UB, FB), Gr.fromRT(PB, t.node.rotation, VB), Gr.invert(BB, PB), Gr.multiply(OB, MB, BB), Gr.copy(this._matShadowView, BB), Gr.copy(this._matShadowProj, MB), Gr.copy(this._matShadowViewProj, OB) } yu.createOrtho(this._validFrustum, s, a, .1, this._shadowCameraFar, PB) }, n(t, [{ key: "level", get: function () { return this._level } }, { key: "shadowObjects", get: function () { return this._shadowObjects } }, { key: "shadowCameraFar", get: function () { return this._shadowCameraFar }, set: function (t) { this._shadowCameraFar = t } }, { key: "matShadowView", get: function () { return this._matShadowView }, set: function (t) { this._matShadowView = t } }, { key: "matShadowProj", get: function () { return this._matShadowProj }, set: function (t) { this._matShadowProj = t } }, { key: "matShadowViewProj", get: function () { return this._matShadowViewProj }, set: function (t) { this._matShadowViewProj = t } }, { key: "validFrustum", get: function () { return this._validFrustum } }, { key: "splitFrustum", get: function () { return this._splitFrustum } }, { key: "lightViewFrustum", get: function () { return this._lightViewFrustum } }, { key: "castLightViewBoundingBox", get: function () { return this._castLightViewBoundingBox } }]), t }(), YB = function (t) { function e(e) { var i; return (i = t.call(this, e) || this)._splitCameraNear = 0, i._splitCameraFar = 0, i._csmAtlas = new Pn, i._calculateAtlas(e), i } s(e, t); var i = e.prototype; return i.destroy = function () { t.prototype.destroy.call(this) }, i._calculateAtlas = function (t) { var e = S.director.root.device.capabilities.clipSpaceSignY, i = t % 2 - .5, n = (.5 - Math.floor(t / 2)) * e; this._csmAtlas.set(.5, .5, i, n) }, n(e, [{ key: "splitCameraNear", get: function () { return this._splitCameraNear }, set: function (t) { this._splitCameraNear = t } }, { key: "splitCameraFar", get: function () { return this._splitCameraFar }, set: function (t) { this._splitCameraFar = t } }, { key: "csmAtlas", get: function () { return this._csmAtlas }, set: function (t) { this._csmAtlas = t } }]), e }(qB), KB = function () { function t() { this._castShadowObjects = [], this._layerObjects = new io(64), this._layers = [], this._levelCount = 0, this._specialLayer = new qB(1), this._shadowDistance = 0; for (var t = 0; t < bT.LEVEL_4; t++)this._layers[t] = new YB(t) } var e = t.prototype; return e.update = function (t, e) { var i = e.scene.mainLight; if (null !== i) { var n = t.shadows, r = S.director.root.pipeline.pipelineSceneData.csmSupported ? i.csmLevel : 1, s = i.shadowDistance; n.enabled && i.shadowEnabled && (i.shadowFixedArea ? this._updateFixedArea(i) : ((i.csmNeedUpdate || this._levelCount !== r || this._shadowDistance !== s) && (this._splitFrustumLevels(i), this._levelCount = r, this._shadowDistance = s), this._calculateCSM(e, i, n))) } }, e.destroy = function () { this._castShadowObjects.length = 0; for (var t = 0; t < this._layers.length; t++)this._layers[t].destroy(); this._layers.length = 0 }, e._updateFixedArea = function (t) { var e = S.director.root.device, i = t.shadowOrthoSize, n = t.shadowOrthoSize, r = t.shadowNear, s = t.shadowFar; Gr.fromRT(PB, t.node.worldRotation, t.node.worldPosition), Gr.invert(BB, PB), Gr.ortho(MB, -i, i, -n, n, r, s, e.capabilities.clipSpaceMinZ, e.capabilities.clipSpaceSignY), Gr.multiply(OB, MB, BB), this._specialLayer.matShadowView = BB, this._specialLayer.matShadowProj = MB, this._specialLayer.matShadowViewProj = OB, this._specialLayer.calculateValidFrustumOrtho(2 * i, 2 * n, r, s, PB) }, e._splitFrustumLevels = function (t) { var e = .1, i = t.shadowDistance, n = i / e, r = S.director.root.pipeline.pipelineSceneData.csmSupported ? t.csmLevel : 1, s = t.csmLayerLambda; this._layers[0].splitCameraNear = e; for (var a = 1; a < r; a++) { var o = a / r, u = s * e * Math.pow(n, o) + (1 - s) * (e + (i - e) * o), h = 1.005 * u; this._layers[a].splitCameraNear = u, this._layers[a - 1].splitCameraFar = h } this._layers[r - 1].splitCameraFar = i, t.csmNeedUpdate = !1 }, e._calculateCSM = function (t, e, i) { var n = S.director.root.pipeline.pipelineSceneData.csmSupported ? e.csmLevel : 1, r = n > 1 ? .5 * i.size.x : i.size.x; if (!(r < 0)) { this._getCameraWorldMatrix(RB, t); for (var s = n - 1; s >= 0; s--) { var a = this._layers[s], o = a.splitCameraNear, u = a.splitCameraFar; a.calculateSplitFrustum(t, RB, o, u), a.createMatrix(e, r, !1) } n === bT.LEVEL_1 ? (this._specialLayer.shadowCameraFar = this._layers[0].shadowCameraFar, Gr.copy(this._specialLayer.matShadowView, this._layers[0].matShadowView), Gr.copy(this._specialLayer.matShadowProj, this._layers[0].matShadowProj), Gr.copy(this._specialLayer.matShadowViewProj, this._layers[0].matShadowViewProj), this._specialLayer.copyToValidFrustum(this._layers[0].validFrustum)) : (this._specialLayer.calculateSplitFrustum(t, RB, .1, e.shadowDistance), this._specialLayer.createMatrix(e, r, !0)) } }, e._getCameraWorldMatrix = function (t, e) { if (e.node) { var i = e.node, n = i.worldPosition, r = i.worldRotation; Gr.fromRT(t, r, n) } }, n(t, [{ key: "castShadowObjects", get: function () { return this._castShadowObjects } }, { key: "layerObjects", get: function () { return this._layerObjects } }, { key: "layers", get: function () { return this._layers } }, { key: "specialLayer", get: function () { return this._specialLayer } }]), t }(), QB = t("PipelineSceneData", function () { function t() { this.fog = new MT, this.ambient = new eb, this.skybox = new DT, this.shadows = new ST, this.csmLayers = new KB, this.octree = new IR, this.skin = new ER, this.postSettings = new nA, this.lightProbes = S.internal.LightProbes ? new S.internal.LightProbes : null, this.validPunctualLights = [], this.renderObjects = [], this.shadowFrameBufferMap = new Map, this._geometryRendererMaterials = [], this._geometryRendererPasses = [], this._geometryRendererShaders = [], this._occlusionQueryVertexBuffer = null, this._occlusionQueryIndicesBuffer = null, this._occlusionQueryInputAssembler = null, this._occlusionQueryMaterial = null, this._occlusionQueryShader = null, this._isHDR = !0, this._shadingScale = 1, this._csmSupported = !0, this._standardSkinMeshRenderer = null, this._standardSkinModel = null, this._skinMaterialModel = null, this._shadingScale = 1 } var e = t.prototype; return e.activate = function (t) { return this._device = t, this.initGeometryRendererMaterials(), this.initOcclusionQuery(), !0 }, e.initGeometryRendererMaterials = function () { for (var t = 0, e = this._geometryRendererMaterials, i = 0; i < 6; i++) { e[i] = new gT, e[i]._uuid = "geometry-renderer-material-" + i, e[i].initialize({ effectName: "internal/builtin-geometry-renderer", technique: i }); for (var n = e[i].passes, r = 0; r < n.length; ++r)this._geometryRendererPasses[t] = n[r], this._geometryRendererShaders[t] = n[r].getShaderVariant(), t++ } }, e.initOcclusionQuery = function () { if (this._occlusionQueryInputAssembler || (this._occlusionQueryInputAssembler = this._createOcclusionQueryIA()), !this._occlusionQueryMaterial) { var t = new gT; t._uuid = "default-occlusion-query-material", t.initialize({ effectName: "internal/builtin-occlusion-query" }), this._occlusionQueryMaterial = t, t.passes.length > 0 && (this._occlusionQueryShader = t.passes[0].getShaderVariant()) } }, e.getOcclusionQueryPass = function () { return this._occlusionQueryMaterial && this._occlusionQueryMaterial.passes.length > 0 ? this._occlusionQueryMaterial.passes[0] : null }, e.updatePipelineSceneData = function () { }, e.destroy = function () { var t, e, i; this.shadows.destroy(), this.csmLayers.destroy(), this.validPunctualLights.length = 0, null == (t = this._occlusionQueryInputAssembler) || t.destroy(), this._occlusionQueryInputAssembler = null, null == (e = this._occlusionQueryVertexBuffer) || e.destroy(), this._occlusionQueryVertexBuffer = null, null == (i = this._occlusionQueryIndicesBuffer) || i.destroy(), this._occlusionQueryIndicesBuffer = null, this._standardSkinMeshRenderer = null, this._standardSkinModel = null, this._skinMaterialModel = null }, e._createOcclusionQueryIA = function () { var t = this._device, e = new Float32Array([-1, -1, -1, 1, -1, -1, -1, 1, -1, 1, 1, -1, -1, -1, 1, 1, -1, 1, -1, 1, 1, 1, 1, 1]); this._occlusionQueryVertexBuffer = t.createBuffer(new Zd(10, 1, 96, 12)), this._occlusionQueryVertexBuffer.update(e); var i = new Uint16Array([0, 2, 1, 1, 2, 3, 4, 5, 6, 5, 7, 6, 1, 3, 7, 1, 7, 5, 0, 4, 6, 0, 6, 2, 0, 1, 5, 0, 5, 4, 2, 6, 7, 2, 7, 3]); this._occlusionQueryIndicesBuffer = t.createBuffer(new Zd(6, 1, 72, 2)), this._occlusionQueryIndicesBuffer.update(i); var n = [new pp("a_position", 32)], r = new gp(n, [this._occlusionQueryVertexBuffer], this._occlusionQueryIndicesBuffer); return t.createInputAssembler(r) }, n(t, [{ key: "isHDR", get: function () { return this._isHDR }, set: function (t) { this._isHDR = t } }, { key: "shadingScale", get: function () { return this._shadingScale }, set: function (t) { this._shadingScale = t } }, { key: "csmSupported", get: function () { return this._csmSupported }, set: function (t) { this._csmSupported = t } }, { key: "standardSkinModel", get: function () { return this._standardSkinModel }, set: function (t) { this._standardSkinModel = t } }, { key: "standardSkinMeshRenderer", get: function () { return this._standardSkinMeshRenderer }, set: function (t) { this._standardSkinMeshRenderer && this._standardSkinMeshRenderer !== t && this._standardSkinMeshRenderer.clearGlobalStandardSkinObjectFlag(), this._standardSkinMeshRenderer = t, this.standardSkinModel = t ? t.model : null } }, { key: "skinMaterialModel", get: function () { return this._skinMaterialModel }, set: function (t) { this._skinMaterialModel = t } }, { key: "geometryRendererPasses", get: function () { return this._geometryRendererPasses } }, { key: "geometryRendererShaders", get: function () { return this._geometryRendererShaders } }]), t }()), ZB = hs(), JB = ((AB = {})[Le.ORIENTATION_AUTO] = Me.AUTO, AB[Le.ORIENTATION_LANDSCAPE] = Me.LANDSCAPE, AB[Le.ORIENTATION_PORTRAIT] = Me.PORTRAIT, AB), $B = t("View", function (t) { function e() { var e; (e = t.call(this) || this)._designResolutionSize = hs(0, 0), e._scaleX = 1, e._scaleY = 1, e._viewportRect = ds(), e._visibleRect = ds(), e._autoFullScreen = !1, e._retinaEnabled = !1, e._resizeCallback = null; var i = tM, n = eM; return e._rpExactFit = new hM(i.EQUAL_TO_FRAME, n.EXACT_FIT), e._rpShowAll = new hM(i.EQUAL_TO_FRAME, n.SHOW_ALL), e._rpNoBorder = new hM(i.EQUAL_TO_FRAME, n.NO_BORDER), e._rpFixedHeight = new hM(i.EQUAL_TO_FRAME, n.FIXED_HEIGHT), e._rpFixedWidth = new hM(i.EQUAL_TO_FRAME, n.FIXED_WIDTH), e._resolutionPolicy = e._rpShowAll, e } s(e, t); var i = e.prototype; return i.init = function () { var t = $o.windowSize, e = t.width, i = t.height; this._designResolutionSize.width = e, this._designResolutionSize.height = i, this._viewportRect.width = e, this._viewportRect.height = i, this._visibleRect.width = e, this._visibleRect.height = i, ZB.width = this._visibleRect.width, ZB.height = this._visibleRect.height, eu.init(this._visibleRect), this.resizeWithBrowserSize(!0); var n = Oe.querySettings("screen", "designResolution"); n && this.setDesignResolutionSize(Number(n.width), Number(n.height), n.policy || hM.FIXED_HEIGHT), $o.on("window-resize", this._updateAdaptResult, this), $o.on("fullscreen-change", this._updateAdaptResult, this) }, i.resizeWithBrowserSize = function (t) { Zo.handleResizeEvent = t }, i.setResizeCallback = function (t) { "function" != typeof t && null != t || (this._resizeCallback = t) }, i.setOrientation = function (t) { Zo.orientation = JB[t] }, i.adjustViewportMeta = function () { }, i.enableRetina = function (t) { this._retinaEnabled = !!t }, i.isRetinaEnabled = function () { return this._retinaEnabled }, i.enableAutoFullScreen = function (t) { t !== this._autoFullScreen && (this._autoFullScreen = t, t && $o.requestFullScreen().catch((function () { }))) }, i.isAutoFullScreenEnabled = function () { return this._autoFullScreen }, i.setCanvasSize = function (t, e) { Zo.resolutionScale = 1; var i = Zo.devicePixelRatio, n = new us(t * i, e * i); $o.windowSize = n }, i.getCanvasSize = function () { return $o.windowSize }, i.getFrameSize = function () { var t = Zo.devicePixelRatio, e = $o.windowSize; return e.width /= t, e.height /= t, e }, i.setFrameSize = function (t, e) { var i = Zo.devicePixelRatio; $o.windowSize = new us(t * i, e * i) }, i.getVisibleSize = function () { return new us(this._visibleRect.width, this._visibleRect.height) }, i.getVisibleSizeInPixel = function () { return new us(this._visibleRect.width * this._scaleX, this._visibleRect.height * this._scaleY) }, i.getVisibleOrigin = function () { return new as(this._visibleRect.x, this._visibleRect.y) }, i.getVisibleOriginInPixel = function () { return new as(this._visibleRect.x * this._scaleX, this._visibleRect.y * this._scaleY) }, i.getResolutionPolicy = function () { return this._resolutionPolicy }, i._updateResolutionPolicy = function (t) { if (t instanceof hM) this._resolutionPolicy = t; else { var e = hM; t === e.EXACT_FIT && (this._resolutionPolicy = this._rpExactFit), t === e.SHOW_ALL && (this._resolutionPolicy = this._rpShowAll), t === e.NO_BORDER && (this._resolutionPolicy = this._rpNoBorder), t === e.FIXED_HEIGHT && (this._resolutionPolicy = this._rpFixedHeight), t === e.FIXED_WIDTH && (this._resolutionPolicy = this._rpFixedWidth) } }, i.setResolutionPolicy = function (t) { this._updateResolutionPolicy(t); var e = cM.getDesignResolutionSize(); cM.setDesignResolutionSize(e.width, e.height, t) }, i.setDesignResolutionSize = function (t, e, i) { if (t > 0 && e > 0) { this._updateResolutionPolicy(i); var n = this._resolutionPolicy; n && n.preApply(this), this._designResolutionSize.width = t, this._designResolutionSize.height = e; var r = n.apply(this, this._designResolutionSize); if (r.scale && 2 === r.scale.length && (this._scaleX = r.scale[0], this._scaleY = r.scale[1]), r.viewport) { var s = this._viewportRect, a = this._visibleRect, o = r.viewport; s.x = o.x, s.y = o.y, s.width = o.width, s.height = o.height, a.x = 0, a.y = 0, a.width = o.width / this._scaleX, a.height = o.height / this._scaleY } n.postApply(this), ZB.width = this._visibleRect.width, ZB.height = this._visibleRect.height, eu.init(this._visibleRect), this.emit("design-resolution-changed") } else rt(2200) }, i.getDesignResolutionSize = function () { return new us(this._designResolutionSize.width, this._designResolutionSize.height) }, i.setRealPixelResolution = function (t, e, i) { document.documentElement.style.width = t + "px", document.body.style.width = t + "px", document.body.style.left = "0px", document.body.style.top = "0px", this.setDesignResolutionSize(t, e, i) }, i.getViewportRect = function () { return this._viewportRect }, i.getScaleX = function () { return this._scaleX }, i.getScaleY = function () { return this._scaleY }, i.getDevicePixelRatio = function () { return Zo.devicePixelRatio }, i.convertToLocationInView = function (t, e, i, n) { void 0 === n && (n = new as); var r = Zo.devicePixelRatio * (t - i.left), s = Zo.devicePixelRatio * (i.top + i.height - e); return Zo.isFrameRotated ? (n.x = $o.windowSize.width - s, n.y = r) : (n.x = r, n.y = s), n }, i._convertToUISpace = function (t) { var e = this._viewportRect; t.x = (t.x - e.x) / this._scaleX, t.y = (t.y - e.y) / this._scaleY }, i._updateAdaptResult = function (t, e, i) { S.director.root.resize(t, e, void 0 === i || 0 === i ? 1 : i); var n = this._designResolutionSize, r = n.width, s = n.height; t > 0 && e > 0 ? this.setDesignResolutionSize(r, s, this._resolutionPolicy) : X(!1, "_updateAdaptResult Invalid size."), this.emit("canvas-resize"), this._resizeCallback && this._resizeCallback() }, e }(bo(If))); $B.instance = void 0; var tM = function () { function t() { this.name = "ContainerStrategy" } var e = t.prototype; return e.preApply = function () { }, e.apply = function () { }, e.postApply = function () { }, e._setupCanvas = function () { var t = S.game.canvas; if (t) { var e = $o.windowSize; t.width !== e.width && (t.width = e.width), t.height !== e.height && (t.height = e.height) } }, t }(); tM.EQUAL_TO_FRAME = void 0, tM.PROPORTION_TO_FRAME = void 0; var eM = function () { function t() { this.name = "ContentStrategy", this._result = { scale: [1, 1], viewport: null }, this._strategy = hM.UNKNOWN } var e = t.prototype; return e.preApply = function () { }, e.apply = function () { return { scale: [1, 1] } }, e.postApply = function () { }, e._buildResult = function (t, e, i, n, r, s) { Math.abs(t - i) < 2 && (i = t), Math.abs(e - n) < 2 && (n = e); var a = new fs(Math.round((t - i) / 2), Math.round((e - n) / 2), i, n), o = this._result; return o.scale = [r, s], o.viewport = a, o }, n(t, [{ key: "strategy", get: function () { return this._strategy } }]), t }(), iM = function (t) { function e() { var e; return (e = t.call(this) || this).name = "EqualToFrame", e } return s(e, t), e.prototype.apply = function () { Zo.isProportionalToFrame = !1, this._setupCanvas() }, e }(tM), nM = function (t) { function e() { var e; return (e = t.call(this) || this).name = "ProportionalToFrame", e } return s(e, t), e.prototype.apply = function () { Zo.isProportionalToFrame = !0, this._setupCanvas() }, e }(tM); tM.EQUAL_TO_FRAME = new iM, tM.PROPORTION_TO_FRAME = new nM; var rM = function (t) { function e() { var e; return (e = t.call(this) || this).name = "ExactFit", e._strategy = hM.EXACT_FIT, e } return s(e, t), e.prototype.apply = function (t, e) { var i = $o.windowSize, n = i.width, r = i.height, s = n / e.width, a = r / e.height; return this._buildResult(n, r, n, r, s, a) }, e }(eM), sM = function (t) { function e() { var e; return (e = t.call(this) || this).name = "ShowAll", e._strategy = hM.SHOW_ALL, e } return s(e, t), e.prototype.apply = function (t, e) { var i, n, r = $o.windowSize, s = r.width, a = r.height, o = e.width, u = e.height, h = s / o, c = a / u, l = 0; return h < c ? (i = s, n = u * (l = h)) : (i = o * (l = c), n = a), this._buildResult(s, a, i, n, l, l) }, e }(eM), aM = function (t) { function e() { var e; return (e = t.call(this) || this).name = "NoBorder", e._strategy = hM.NO_BORDER, e } return s(e, t), e.prototype.apply = function (t, e) { var i, n, r, s = $o.windowSize, a = s.width, o = s.height, u = e.width, h = e.height, c = a / u, l = o / h; return c < l ? (n = u * (i = l), r = o) : (n = a, r = h * (i = c)), this._buildResult(a, o, n, r, i, i) }, e }(eM), oM = function (t) { function e() { var e; return (e = t.call(this) || this).name = "FixedHeight", e._strategy = hM.FIXED_HEIGHT, e } return s(e, t), e.prototype.apply = function (t, e) { var i = $o.windowSize, n = i.width, r = i.height, s = r / e.height, a = n, o = r; return this._buildResult(n, r, a, o, s, s) }, e }(eM), uM = function (t) { function e() { var e; return (e = t.call(this) || this).name = "FixedWidth", e._strategy = hM.FIXED_WIDTH, e } return s(e, t), e.prototype.apply = function (t, e) { var i = $o.windowSize, n = i.width, r = i.height, s = n / e.width, a = n, o = r; return this._buildResult(n, r, a, o, s, s) }, e }(eM), hM = t("ResolutionPolicy", function () { function t(t, e) { this.name = "ResolutionPolicy", this._containerStrategy = t, this._contentStrategy = e } var e = t.prototype; return e.preApply = function (t) { this._contentStrategy.preApply(t) }, e.apply = function (t, e) { return this._containerStrategy.apply(t, e), this._contentStrategy.apply(t, e) }, e.postApply = function (t) { this._contentStrategy.postApply(t) }, e.setContainerStrategy = function (t) { this._containerStrategy = t }, e.setContentStrategy = function (t) { this._contentStrategy = t }, e.getContentStrategy = function () { return this._contentStrategy }, n(t, [{ key: "canvasSize", get: function () { return $o.windowSize } }]), t }()); hM.EXACT_FIT = 0, hM.NO_BORDER = 1, hM.SHOW_ALL = 2, hM.FIXED_HEIGHT = 3, hM.FIXED_WIDTH = 4, hM.UNKNOWN = 5, hM.ContainerStrategy = tM, hM.ContentStrategy = eM, S.ResolutionPolicy = hM, eM.EXACT_FIT = new rM, eM.SHOW_ALL = new sM, eM.NO_BORDER = new aM, eM.FIXED_HEIGHT = new oM, eM.FIXED_WIDTH = new uM; var cM = t("view", $B.instance = S.view = new $B); yB.registerSystem("view", cM, 0), S.winSize = ZB; var lM = new as; function fM(t, e, i, n) { t.setProperty(e, i, n) } var dM = function () { var t = e.prototype; function e() { this.settings = void 0, this._curTime = 0, this.device = void 0, this.swapchain = void 0, this.shader = void 0, this.sampler = void 0, this.cmdBuff = void 0, this.quadAssmebler = void 0, this.vertexBuffers = void 0, this.indicesBuffers = void 0, this.renderArea = void 0, this.clearColors = void 0, this.projection = void 0, this.isMobile = !1, this.bgMat = void 0, this.bgImage = void 0, this.bgTexture = void 0, this.logoMat = void 0, this.logoImage = void 0, this.logoTexture = void 0, this.watermarkMat = void 0, this.watermarkTexture = void 0, this.bgWidth = 1920, this.bgHeight = 1080, this.logoWidthTemp = 140, this.logoHeightTemp = 200, this.logoWidth = 0, this.logoHeight = 0, this.logoXTrans = .5, this.logoYTrans = 1 / 6 + 2.5 / 6, this.textSize = 24, this.textHeight = 24, this.textXTrans = .5, this.textYExtraTrans = 32, this.textExpandSize = 4, this.scaleSize = 1 } return t.init = function () { var t, e, i, n, r, s, a, o = this, u = hM.SHOW_ALL, h = Oe.querySettings("screen", "designResolution"); if (null !== h && (u = h.policy), this.settings = { policy: null !== (t = u) && void 0 !== t ? t : hM.SHOW_ALL, displayRatio: null !== (e = Oe.querySettings("splashScreen", "displayRatio")) && void 0 !== e ? e : .4, totalTime: null !== (i = Oe.querySettings("splashScreen", "totalTime")) && void 0 !== i ? i : 3e3, watermarkLocation: null !== (n = Oe.querySettings("splashScreen", "watermarkLocation")) && void 0 !== n ? n : "default", autoFit: null === (r = Oe.querySettings("splashScreen", "autoFit")) || void 0 === r || r, logo: null !== (s = Oe.querySettings("splashScreen", "logo")) && void 0 !== s ? s : void 0, background: null !== (a = Oe.querySettings("splashScreen", "background")) && void 0 !== a ? a : void 0 }, this._curTime = 0, !(this.settings.totalTime <= 0 || void 0 === this.settings.logo || void 0 === this.settings.background)) { this.device = S.director.root.device, this.swapchain = S.director.root.mainWindow.swapchain, this.preInit(), this.initLayout(), "default" === this.settings.logo.type && this.initWaterMark(); var c = Promise.resolve(), l = Promise.resolve(); return "custom" === this.settings.background.type && (c = new Promise((function (t, e) { o.bgImage = new E.Image, o.bgImage.onload = function () { o.initBG(), t() }, o.bgImage.onerror = function () { e() }, o.bgImage.src = o.settings.background.base64 }))), "none" !== this.settings.logo.type && (l = new Promise((function (t, e) { o.logoImage = new E.Image, o.logoImage.onload = function () { o.initLogo(), t() }, o.logoImage.onerror = function () { e() }, o.logoImage.src = o.settings.logo.base64 }))), Promise.all([c, l]) } return this.settings.totalTime = 0, Promise.resolve([]) }, t.preInit = function () { var t, e = null == (t = this.settings.background) ? void 0 : t.color; this.clearColors = e ? [new Xd(e.x, e.y, e.z, e.w)] : [new Xd(0, 0, 0, 1)]; var i = this.device, n = this.swapchain, r = i.capabilities; this.renderArea = new Nd(0, 0, n.width, n.height), this.cmdBuff = i.commandBuffer; var s = new Float32Array([.5, .5, 1, 0, -.5, .5, 0, 0, .5, -.5, 1, 1, -.5, -.5, 0, 1]); this.vertexBuffers = i.createBuffer(new Zd(10, 1, 64, 16)), this.vertexBuffers.update(s); var a = new Uint16Array([0, 1, 2, 1, 3, 2]); this.indicesBuffers = i.createBuffer(new Zd(6, 1, 12, 2)), this.indicesBuffers.update(a); var o = [new pp("a_position", 21), new pp("a_texCoord", 21)], u = new gp(o, [this.vertexBuffers], this.indicesBuffers); this.quadAssmebler = i.createInputAssembler(u), this.projection = new Gr, Gr.ortho(this.projection, -1, 1, -1, 1, -1, 1, r.clipSpaceMinZ, r.clipSpaceSignY, n.surfaceTransform), this.isMobile = tu.isMobile }, t.initLayout = function () { this.isMobile ? (this.bgWidth = 812, this.bgHeight = 375, this.logoWidthTemp = 70, this.logoHeightTemp = 100, this.textSize = 12, this.textHeight = this.textSize + this.textExpandSize, this.textXTrans = .5, this.textYExtraTrans = 16) : (this.bgWidth = 1920, this.bgHeight = 1080, this.logoWidthTemp = 140, this.logoHeightTemp = 200, this.textSize = 24, this.textHeight = this.textSize + this.textExpandSize, this.textXTrans = .5, this.textYExtraTrans = 32), this.logoXTrans = .5, this.logoYTrans = 1 / 6 + 2.5 / 6, this.initScale() }, t.initScale = function () { var t = this.swapchain.width, e = this.swapchain.height, i = this.isMobile ? 375 : 1080, n = this.isMobile ? 812 : 1920; if (t > e) { var r = n; n = i, i = r } this.scaleSize = t / e > 16 / 9 ? e / n : t / i }, t.update = function (t) { var e = this.settings, i = this.device, n = this.swapchain, r = i.capabilities; Gr.ortho(this.projection, -1, 1, -1, 1, -1, 1, r.clipSpaceMinZ, r.clipSpaceSignY, n.surfaceTransform); var s = n.width, a = n.height; this.initScale(), this._curTime += 1e3 * t; var o = Kh(qi(this._curTime / e.totalTime)), u = 1, h = 1, c = this.bgImage; if ("custom" === e.background.type) { e.policy === hM.FIXED_WIDTH ? (u = s, h = s / c.width * c.height) : e.policy === hM.FIXED_HEIGHT ? (u = a / c.height * c.width, h = a) : e.policy === hM.SHOW_ALL ? c.width / this.bgHeight > s / a ? (u = s, h = s / c.width * c.height) : (u = a / c.height * c.width, h = a) : e.policy === hM.NO_BORDER ? c.width / c.height > s / a ? (u = a / c.height * c.width, h = a) : (u = s, h = s / c.width * c.height) : (u = s, h = a); var l = this.bgMat; fM(l, "resolution", lM.set(s, a), 0), fM(l, "scale", lM.set(u, h), 0), fM(l, "translate", lM.set(.5 * s, .5 * a), 0), fM(l, "percent", 1), fM(l, "u_projection", this.projection), l.passes[0].update() } var f = a * this.logoYTrans; if ("none" !== this.settings.logo.type) { h = .185 * a * e.displayRatio, u = this.logoWidth * (.185 * a / this.logoHeight) * e.displayRatio; var d = this.logoMat; fM(d, "resolution", lM.set(s, a), 0), fM(d, "scale", lM.set(u, h), 0), fM(d, "translate", lM.set(s * this.logoXTrans, f), 0), fM(d, "percent", o), fM(d, "u_projection", this.projection), d.passes[0].update() } if ("default" === this.settings.logo.type && this.watermarkMat) { var p = this.watermarkTexture.width, _ = this.watermarkTexture.height; u = p, h = _; var g = f - (.5 * this.logoHeight * e.displayRatio + this.textYExtraTrans) * this.scaleSize - .5 * _, m = this.watermarkMat; fM(m, "resolution", lM.set(s, a), 0), fM(m, "scale", lM.set(u, h), 0), fM(m, "translate", lM.set(s * this.textXTrans, g), 0), fM(m, "percent", o), fM(m, "u_projection", this.projection), m.passes[0].update() } this.frame() }, t.initBG = function () { var t = this.device; this.bgMat = new gT, this.bgMat.initialize({ effectName: "util/splash-screen" }); var e = new rp; e.addressU = 2, e.addressV = 2, e.addressW = 2, this.sampler = t.getSampler(e), this.bgTexture = t.createTexture(new ip(1, 6, 35, this.bgImage.width, this.bgImage.height)); var i = this.bgMat.passes[0], n = i.getBinding("mainTexture"); i.bindTexture(n, this.bgTexture), this.shader = i.getShaderVariant(); var r = i.descriptorSet; r.bindSampler(n, this.sampler), r.update(); var s = new Wd, a = s.texExtent; a.width = this.bgImage.width, a.height = this.bgImage.height, a.depth = 1, t.copyTexImagesToTexture([this.bgImage], this.bgTexture, [s]) }, t.initLogo = function () { var t = this.device; this.logoMat = new gT, this.logoMat.initialize({ effectName: "util/splash-screen" }); var e = new rp; e.addressU = 2, e.addressV = 2, e.addressW = 2, this.sampler = t.getSampler(e), this.logoTexture = t.createTexture(new ip(1, 6, 35, this.logoImage.width, this.logoImage.height)); var i = this.logoMat.passes[0], n = i.getBinding("mainTexture"); i.bindTexture(n, this.logoTexture), this.shader = i.getShaderVariant(); var r = i.descriptorSet; r.bindSampler(n, this.sampler), r.update(); var s = new Wd, a = s.texExtent; a.width = this.logoImage.width, a.height = this.logoImage.height, a.depth = 1, t.copyTexImagesToTexture([this.logoImage], this.logoTexture, [s]); var o = this.logoImage.width / this.logoImage.height; o < 1 ? (this.logoWidth = this.logoWidthTemp, this.logoHeight = this.logoWidthTemp / o) : (this.logoWidth = this.logoHeightTemp * o, this.logoHeight = this.logoHeightTemp) }, t.initWaterMark = function () { var t = E.document.createElement("canvas"); t.height = this.textHeight * this.scaleSize, t.style.width = "" + t.width, t.style.height = "" + t.height; var e = "Created with Cocos", i = t.getContext("2d"); i.font = this.textSize * this.scaleSize + "px Arial", i.textBaseline = "top", i.textAlign = "center", i.fillStyle = "#707070"; var n = i.measureText(e).width + 10; t.width = n, i.font = this.textSize * this.scaleSize + "px Arial", i.textBaseline = "top", i.textAlign = "center", i.fillStyle = "#707070", i.fillText(e, t.width / 2, 0); var r = new Wd, s = r.texExtent; s.width = t.width, s.height = t.height, s.depth = 1, this.watermarkTexture = this.device.createTexture(new ip(1, 6, 35, t.width, t.height)), this.device.copyTexImagesToTexture([t], this.watermarkTexture, [r]), this.watermarkMat = new gT, this.watermarkMat.initialize({ effectName: "util/splash-screen" }); var a = this.watermarkMat.passes[0], o = a.getBinding("mainTexture"); a.bindTexture(o, this.watermarkTexture), a.descriptorSet.update() }, t.frame = function () { var t = this.device, e = this.swapchain; this.projection; var i = this.bgMat, n = this.logoMat, r = this.watermarkMat, s = this.settings, a = this.quadAssmebler; if (t.capabilities, !tu.isXR || xr.entry.isRenderAllowable()) for (var o = tu.isXR ? 2 : 1, u = 0; u < o; u++) { t.enableAutoBarrier(!0), t.acquire([e]); var h = this.cmdBuff, c = S.director.root.mainWindow.framebuffer, l = this.renderArea; if (l.width = e.width, l.height = e.height, h.begin(), h.beginRenderPass(c.renderPass, c, l, this.clearColors, 1, 0), S.director.root.pipeline, "custom" === s.background.type) { var f = i.passes[0], d = fT.getOrCreatePipelineState(t, f, this.shader, c.renderPass, a); h.bindPipelineState(d), h.bindDescriptorSet(1, f.descriptorSet), h.bindInputAssembler(a), h.draw(a) } if ("none" !== s.logo.type) { var p = n.passes[0], _ = fT.getOrCreatePipelineState(t, p, this.shader, c.renderPass, a); h.bindPipelineState(_), h.bindDescriptorSet(1, p.descriptorSet), h.bindInputAssembler(a), h.draw(a) } if ("default" === s.logo.type && r) { var g = this.watermarkMat.passes[0], m = fT.getOrCreatePipelineState(t, g, this.shader, c.renderPass, a); h.bindPipelineState(m), h.bindDescriptorSet(1, g.descriptorSet), h.bindInputAssembler(a), h.draw(a) } h.endRenderPass(), h.end(), t.flushCommands([h]), t.queue.submit([h]), t.present(), t.enableAutoBarrier(!T.rendering) } }, t.destroy = function () { this.device = null, this.swapchain = null, this.clearColors = null, this.bgImage && (this.bgImage.destroy && this.bgImage.destroy(), this.bgImage = null), this.bgMat && (this.bgMat.destroy(), this.bgMat = null), this.bgTexture && (this.bgTexture.destroy(), this.bgTexture = null), this.logoImage && (this.logoImage.destroy && this.logoImage.destroy(), this.logoImage = null), this.logoMat && (this.logoMat.destroy(), this.logoMat = null), this.logoTexture && (this.logoTexture.destroy(), this.logoTexture = null), this.renderArea = null, this.cmdBuff = null, this.shader = null, this.quadAssmebler && (this.quadAssmebler.destroy(), this.quadAssmebler = null), this.vertexBuffers && (this.vertexBuffers.destroy(), this.vertexBuffers = null), this.indicesBuffers && (this.indicesBuffers.destroy(), this.indicesBuffers = null), this.sampler = null, this.watermarkMat && (this.watermarkMat.destroy(), this.watermarkMat = null), this.watermarkTexture && (this.watermarkTexture.destroy(), this.watermarkTexture = null), this.settings = null }, e.createInstance = function () { return e._ins = new e, e._ins }, e.releaseInstance = function () { e._ins && (e._ins.destroy(), e._ins = null) }, n(e, [{ key: "isFinished", get: function () { return this._curTime >= this.settings.totalTime } }, { key: "curTime", get: function () { return this._curTime }, set: function (t) { this._curTime = t } }], [{ key: "instance", get: function () { return e._ins } }]), e }(); dM._ins = null, S.internal.SplashScreen = dM; var pM = new (function () { function t() { this._data = null } return t.prototype.init = function (t) { var e = this; return void 0 === t && (t = ""), T.rendering && T.rendering.enableEffectImport && t ? new Promise((function (i, n) { var r = new XMLHttpRequest; r.open("GET", t), r.responseType = "arraybuffer", r.onload = function () { e._data = r.response, i() }, r.onerror = function () { n(new Error("request effect settings failed!")) }, r.send(null) })) : Promise.resolve() }, n(t, [{ key: "data", get: function () { return this._data } }]), t }()); T.effectSettings = pM; var _M = Oe.querySettings.bind(Oe), gM = t("Game", function (t) { function i() { var e; return (e = t.call(this) || this).frame = null, e.container = null, e.canvas = null, e.renderType = -1, e.eventTargetOn = t.prototype.on, e.eventTargetOnce = t.prototype.once, e.config = {}, e.onStart = null, e.frameTime = 1e3 / 60, e._isCloning = !1, e._inited = !1, e._engineInited = !1, e._rendererInitialized = !1, e._paused = !0, e._pausedByEngine = !1, e._frameRate = 60, e._pacer = null, e._initTime = 0, e._startTime = 0, e._deltaTime = 0, e._useFixedDeltaTime = !1, e._shouldLoadLaunchScene = !0, e.onPreBaseInitDelegate = new Co, e.onPostBaseInitDelegate = new Co, e.onPreInfrastructureInitDelegate = new Co, e.onPostInfrastructureInitDelegate = new Co, e.onPreSubsystemInitDelegate = new Co, e.onPostSubsystemInitDelegate = new Co, e.onPreProjectInitDelegate = new Co, e.onPostProjectInitDelegate = new Co, e } s(i, t); var r = i.prototype; return r.setFrameRate = function (t) { this.frameRate = t }, r.getFrameRate = function () { return this.frameRate }, r.step = function () { yB.tick(this._calculateDT(!0)) }, r.pauseByEngine = function () { this._paused || (this._pausedByEngine = !0, this.pause()) }, r.resumeByEngine = function () { this._pausedByEngine && (this.resume(), this._pausedByEngine = !1) }, r.pause = function () { var t; this._paused || (this._paused = !0, null == (t = this._pacer) || t.stop(), this.emit(i.EVENT_PAUSE)) }, r.resume = function () { var t; this._paused && (QD._clearEvents(), this._paused = !1, null == (t = this._pacer) || t.start(), this.emit(i.EVENT_RESUME)) }, r.isPaused = function () { return this._paused }, r.restart = function () { var t = this; return new Promise((function (t) { yB.once("director_end_frame", (function () { return t() })) })).then((function () { yB.reset(), S.Object._deferredDestroy(), t.pause(), t.resume(), t._shouldLoadLaunchScene = !0 })).then((function () { return dM.createInstance().init() })).then((function () { t._safeEmit(i.EVENT_RESTART) })) }, r.end = function () { Ro.close() }, r.on = function (t, e, i, n) { return this.canRegisterEvent(t) && e.call(i), this.eventTargetOn(t, e, i, n) }, r.once = function (t, e, i) { return this.canRegisterEvent(t) ? e.call(i) : this.eventTargetOnce(t, e, i) }, r.canRegisterEvent = function (t) { return this._engineInited && t === i.EVENT_ENGINE_INITED || this._inited && t === i.EVENT_GAME_INITED || this._rendererInitialized && t === i.EVENT_RENDERER_INITED }, r.init = function (t) { var n = this; return this._compatibleWithOldParams(t), Promise.resolve().then((function () { return n.emit(i.EVENT_PRE_BASE_INIT), n.onPreBaseInitDelegate.dispatch() })).then((function () { Y(t.debugMode || 0) })).then((function () { return tu.init() })).then((function () { n._initEvents() })).then((function () { return Oe.init(t.settingsPath, t.overrideSettings) })).then((function () { return n.emit(i.EVENT_POST_BASE_INIT), n.onPostBaseInitDelegate.dispatch() })).then((function () { return n.emit(i.EVENT_PRE_INFRASTRUCTURE_INIT), n.onPreInfrastructureInitDelegate.dispatch() })).then((function () { Le.init(), n._initXR(); var t = { frame: document.querySelector("#GameDiv"), container: document.querySelector("#Cocos3dGameContainer"), canvas: document.querySelector("#GameCanvas") }; return n.canvas = t.canvas, n.frame = t.frame, n.container = t.container, $o.init(), kf.init(), B_.init(n.canvas, sb) })).then((function () { if (_M("rendering", "customPipeline")) { if (!S.rendering) return void rt(12109); Le.CUSTOM_PIPELINE_NAME || (Le.CUSTOM_PIPELINE_NAME = "Builtin") } else S.rendering = void 0; WS.init(), YS.init(), Iv.init(), n.initPacer() })).then((function () { return n.emit(i.EVENT_POST_INFRASTRUCTURE_INIT), n.onPostInfrastructureInitDelegate.dispatch() })).then((function () { return n.emit(i.EVENT_PRE_SUBSYSTEM_INIT), n.onPreSubsystemInitDelegate.dispatch() })).then((function () { return pM.init(_M("rendering", "effectSettingsPath")) })).then((function () { if (S.rendering && S.rendering.enableEffectImport) if (3 !== _M("rendering", "renderMode")) { var t = pM.data; null !== t ? S.rendering.init(B_.gfxDevice, t) : rt(1102) } else S.rendering.init(B_.gfxDevice, null) })).then((function () { var t = _M("scripting", "scriptPackages"); return t ? Promise.all(t.map((function (t) { return e.import(t) }))) : Promise.resolve([]) })).then((function () { return yB.init(), YS.loadBuiltinAssets() })).then((function () { return n.emit(i.EVENT_POST_SUBSYSTEM_INIT), n.onPostSubsystemInitDelegate.dispatch() })).then((function () { H("Cocos Creator v" + I), n.emit(i.EVENT_ENGINE_INITED), n._engineInited = !0 })).then((function () { return n.emit(i.EVENT_PRE_PROJECT_INIT), n.onPreProjectInitDelegate.dispatch() })).then((function () { var t = _M("plugins", "jsList"), e = Promise.resolve(); return t && t.forEach((function (t) { e = e.then((function () { return e = "src/" + t, new Promise((function (t, i) { var n; function r(t) { t.filename === e && (n = t.error) } window.addEventListener("error", r); var s = document.createElement("script"); s.charset = "utf-8", s.async = !0, s.crossOrigin = "anonymous", s.addEventListener("error", (function () { window.removeEventListener("error", r), i(Error("Error loading " + e)) })), s.addEventListener("load", (function () { window.removeEventListener("error", r), document.head.removeChild(s), n ? i(n) : t() })), s.src = e.replace("#", "%23"), document.head.appendChild(s) })); var e })) })), e })).then((function () { return n._loadProjectBundles() })).then((function () { return n._loadCCEScripts() })).then((function () { return n._setupRenderPipeline() })).then((function () { return n._loadPreloadAssets() })).then((function () { return YS.compileBuiltinMaterial(), dM.createInstance().init() })).then((function () { return n.emit(i.EVENT_POST_PROJECT_INIT), n.onPostProjectInitDelegate.dispatch() })).then((function () { n._inited = !0, n._safeEmit(i.EVENT_GAME_INITED) })) }, r._initXR = function () { }, r._compatibleWithOldParams = function (t) { var e = t.overrideSettings = t.overrideSettings || {}; "showFPS" in t && (e.profiling = e.profiling || {}, e.profiling.showFPS = t.showFPS), "frameRate" in t && (e.screen = e.screen || {}, e.screen.frameRate = t.frameRate), "renderMode" in t && (e.rendering = e.rendering || {}, e.rendering.renderMode = t.renderMode), "renderPipeline" in t && (e.rendering = e.rendering || {}, e.rendering.renderPipeline = t.renderPipeline), "assetOptions" in t && (e.assets = e.assets || {}, Object.assign(e.assets, t.assetOptions)), "customJointTextureLayouts" in t && (e.animation = e.animation || {}, e.animation.customJointTextureLayouts = t.customJointTextureLayouts), "physics" in t && (e.physics = e.physics || {}, Object.assign(e.physics, t.physics)), "orientation" in t && (e.screen = e.screen || {}, e.screen.orientation = t.orientation), "exactFitScreen" in t && (e.screen = e.screen || {}, e.screen.exactFitScreen = t.exactFitScreen) }, r._loadPreloadAssets = function () { var t = _M("assets", "preloadAssets"); return t ? Promise.all(t.map((function (t) { return new Promise((function (e, i) { WS.loadAny(t, (function (t) { t ? i(t) : e() })) })) }))) : Promise.resolve([]) }, r._loadCCEScripts = function () { return new Promise((function (t) { t() })) }, r._loadProjectBundles = function () { var t = _M("assets", "preloadBundles"); return t ? Promise.all(t.map((function (t) { var e = t.bundle, i = t.version; return new Promise((function (t, n) { var r = {}; i && (r.version = i), WS.loadBundle(e, r, (function (e) { e ? n(e) : t() })) })) }))) : Promise.resolve([]) }, r.run = function (t) { t && (this.onStart = t), this._inited && this.resume() }, r._calculateDT = function (t) { if (this._useFixedDeltaTime = t, t) return this._startTime = performance.now(), this.frameTime / 1e3; var e = performance.now(); return this._deltaTime = e > this._startTime ? (e - this._startTime) / 1e3 : 0, this._deltaTime > i.DEBUG_DT_THRESHOLD && (this._deltaTime = this.frameTime / 1e3), this._startTime = e, this._deltaTime }, r._updateCallback = function () { var t = this; if (this._inited) if (dM.instance && !dM.instance.isFinished) dM.instance.update(this._calculateDT(!1)); else if (this._shouldLoadLaunchScene) { dM.releaseInstance(), this._shouldLoadLaunchScene = !1; var e, i = _M("launch", "launchScene"); i ? yB.loadScene(i, (function () { J(1103, i), t._initTime = performance.now(), yB.startAnimation(), null == t.onStart || t.onStart() })) : (this._initTime = performance.now(), yB.startAnimation(), null == (e = this.onStart) || e.call(this)) } else yB.tick(this._calculateDT(!1)) }, r.initPacer = function () { var t, e = null !== (t = _M("screen", "frameRate")) && void 0 !== t ? t : 60; X("number" == typeof e), this._pacer = new wB, this._pacer.onTick = this._updateCallback.bind(this), this.frameRate = e }, r._initEvents = function () { Ro.on("show", this._onShow, this), Ro.on("hide", this._onHide, this), Ro.on("close", this._onClose, this) }, r._onHide = function () { this.emit(i.EVENT_HIDE), this.pauseByEngine() }, r._onShow = function () { this.emit(i.EVENT_SHOW), this.resumeByEngine() }, r._onClose = function () { this.emit(i.EVENT_CLOSE), Ro.exit() }, r.addPersistRootNode = function (t) { yB.addPersistRootNode(t) }, r.removePersistRootNode = function (t) { yB.removePersistRootNode(t) }, r.isPersistRootNode = function (t) { return yB.isPersistRootNode(t) }, r._setupRenderPipeline = function () { var t = _M("rendering", "customPipeline"); return this._setRenderPipeline(!!t) }, r._setRenderPipeline = function (t) { yB.root.setRenderPipeline(t) ? (this._rendererInitialized = !0, this._safeEmit(i.EVENT_RENDERER_INITED)) : rt(1222) }, r._safeEmit = function (t) { this.emit(t) }, n(i, [{ key: "inited", get: function () { return this._inited } }, { key: "frameRate", get: function () { return this._frameRate }, set: function (t) { "number" != typeof t && (t = parseInt(t, 10), Number.isNaN(t) && (t = 60)), this._frameRate = t, this.frameTime = 1e3 / t, this._pacer && (this._pacer.targetFrameRate = this._frameRate) } }, { key: "deltaTime", get: function () { return this._useFixedDeltaTime ? this.frameTime / 1e3 : this._deltaTime } }, { key: "totalTime", get: function () { return performance.now() - this._initTime } }, { key: "frameStartTime", get: function () { return this._startTime } }]), i }(wo)); gM.EVENT_HIDE = "game_on_hide", gM.EVENT_SHOW = "game_on_show", gM.EVENT_LOW_MEMORY = "game_on_low_memory", gM.EVENT_GAME_INITED = "game_inited", gM.EVENT_ENGINE_INITED = "engine_inited", gM.EVENT_RENDERER_INITED = "renderer_inited", gM.EVENT_PRE_BASE_INIT = "pre_base_init", gM.EVENT_POST_BASE_INIT = "post_base_init", gM.EVENT_PRE_INFRASTRUCTURE_INIT = "pre_infrastructure_init", gM.EVENT_POST_INFRASTRUCTURE_INIT = "post_infrastructure_init", gM.EVENT_PRE_SUBSYSTEM_INIT = "pre_subsystem_init", gM.EVENT_POST_SUBSYSTEM_INIT = "post_subsystem_init", gM.EVENT_PRE_PROJECT_INIT = "pre_project_init", gM.EVENT_POST_PROJECT_INIT = "post_project_init", gM.EVENT_RESTART = "game_on_restart", gM.EVENT_PAUSE = "game_on_pause", gM.EVENT_RESUME = "game_on_resume", gM.EVENT_CLOSE = "game_on_close", gM.RENDER_TYPE_CANVAS = 0, gM.RENDER_TYPE_WEBGL = 1, gM.RENDER_TYPE_OPENGL = 2, gM.RENDER_TYPE_HEADLESS = 3, gM.DEBUG_DT_THRESHOLD = 1, S.Game = gM; var mM = t("game", S.game = new gM); dt(vB.prototype, "director", [{ name: "calculateDeltaTime" }, { name: "getDeltaTime", suggest: "Use game.deltaTime instead" }, { name: "getTotalTime", suggest: "Use game.totalTime instead" }, { name: "getCurrentTime", suggest: "Use game.frameStartTime instead" }]), ft(vB.prototype, "director", [{ name: "setAnimationInterval", suggest: "please use game.frameRate instead" }, { name: "getAnimationInterval", suggest: "please use game.frameRate instead" }, { name: "getRunningScene", suggest: "please use getScene instead" }, { name: "setDepthTest", suggest: "please use camera API instead" }, { name: "setClearColor", suggest: "please use camera API instead" }, { name: "getWinSize", suggest: "please use view.getVisibleSize instead" }, { name: "getWinSizeInPixels" }, { name: "purgeCachedData", suggest: "please use assetManager.releaseAll instead" }, { name: "convertToGL" }, { name: "convertToUI" }]), lt(yB, "director", [{ name: "_getSceneUuid", targetName: "assetManager.main", newName: "getSceneInfo", customFunction: function (t) { var e; return WS.main ? null == (e = WS.main.getSceneInfo(t)) ? void 0 : e.uuid : "" } }]), dt(mM, "game", [{ name: "collisionMatrix" }, { name: "groupList" }]), lt(mM, "game", [{ name: "_sceneInfos", targetName: "assetManager.main", newName: "getSceneInfo", customGetter: function () { var t = []; return WS.main && WS.main.config.scenes.forEach((function (e) { t.push(e) })), t } }]); var vM = t("DynamicAtlasManager", function (t) { function e() { var e; return (e = t.call(this) || this)._atlases = [], e._atlasIndex = -1, e._maxAtlasCount = 5, e._textureSize = 2048, e._maxFrameSize = 512, e._textureBleeding = !0, e._enabled = !1, e } s(e, t); var i = e.prototype; return i.newAtlas = function () { var t = this._atlases[++this._atlasIndex]; return !t && this._atlasIndex < this.maxAtlasCount && (t = new xv(this._textureSize, this._textureSize), this._atlases.push(t)), t }, i.beforeSceneLoad = function () { this.reset() }, i.init = function () { this.enabled = !Le.CLEANUP_IMAGE_CACHE }, i.insertSpriteFrame = function (t) { if (!this._enabled || this._atlasIndex >= this._maxAtlasCount || !t || t.original) return null; if (!t.packable) return null; var e = t.texture.getSamplerInfo(); if (2 !== e.minFilter || 2 !== e.magFilter || 0 !== e.mipFilter) return null; var i = this._atlases[this._atlasIndex]; i || (i = this.newAtlas()); var n = i ? i.insertSpriteFrame(t) : null; return !n && this._atlasIndex < this._maxAtlasCount ? (i = this.newAtlas()) ? i.insertSpriteFrame(t) : null : n }, i.reset = function () { for (var t = 0, e = this._atlases.length; t < e; t++)this._atlases[t].destroy(); this._atlases.length = 0, this._atlasIndex = -1 }, i.deleteAtlasSpriteFrame = function (t) { if (t.original) { for (var e = this._atlases.length - 1; e >= 0; e--)this._atlases[e].removeSpriteFrame(t); var i = t.original._texture; this.deleteAtlasTexture(i) } }, i.deleteAtlasTexture = function (t) { if (t) for (var e = this._atlases.length - 1; e >= 0; e--)this._atlases[e].deleteInnerTexture(t), this._atlases[e].isEmpty() && (this._atlases[e].destroy(), this._atlases.splice(e, 1), this._atlasIndex--) }, i.packToDynamicAtlas = function (t, e) { if (this._enabled && e && !e.original && e.packable && e.texture && e.texture.width > 0 && e.texture.height > 0) { var i = this.insertSpriteFrame(e); i && e._setDynamicAtlasFrame(i) } }, n(e, [{ key: "enabled", get: function () { return this._enabled }, set: function (t) { this._enabled !== t && (t ? (this.reset(), yB.on("director_before_scene_launch", this.beforeSceneLoad, this)) : (this.reset(), yB.off("director_before_scene_launch", this.beforeSceneLoad, this)), this._enabled = t) } }, { key: "maxAtlasCount", get: function () { return this._maxAtlasCount }, set: function (t) { this._maxAtlasCount = t } }, { key: "atlasCount", get: function () { return this._atlases.length } }, { key: "textureBleeding", get: function () { return this._textureBleeding }, set: function (t) { this._textureBleeding = t } }, { key: "textureSize", get: function () { return this._textureSize }, set: function (t) { this._textureSize = t } }, { key: "maxFrameSize", get: function () { return this._maxFrameSize }, set: function (t) { this._maxFrameSize = t } }]), e }(If)); vM.instance = void 0; var yM = t("dynamicAtlasManager", vM.instance = new vM); yB.registerSystem("dynamicAtlasManager", yM, 0), S.internal.dynamicAtlasManager = yM; var bM = function () { function t() { this._arrayBufferOrPaddings = [], this._length = 0 } var e = t.prototype; return e.setNextAlignment = function (t) { if (0 !== t) { var e = this._length % t; if (0 !== e) { var i = t - e; this._arrayBufferOrPaddings.push(i), this._length += i } } }, e.addBuffer = function (t) { var e = this._length; return this._arrayBufferOrPaddings.push(t), this._length += t.byteLength, e }, e.getLength = function () { return this._length }, e.getCombined = function () { var t = new Uint8Array(this._length), e = 0; return this._arrayBufferOrPaddings.forEach((function (i) { "number" == typeof i ? e += i : (t.set(new Uint8Array(i), e), e += i.byteLength) })), t.buffer }, t }(); function wM(t, e) { return new xM(t, e) } var xM = function () { function t(t, e) { if (this._subMeshRenderings = [], this._mesh = t, this._mesh.struct.morph) { var i = this._mesh.struct.primitives.length; this._subMeshRenderings = new Array(i).fill(null); for (var n = 0; n < i; ++n) { var r = this._mesh.struct.morph.subMeshMorphs[n]; r && (r.targets.length > 60 ? this._subMeshRenderings[n] = new TM(this._mesh, n, this._mesh.struct.morph, e) : this._subMeshRenderings[n] = new SM(this._mesh, n, this._mesh.struct.morph, e)) } } } return t.prototype.createInstance = function () { for (var t = this, e = this._mesh.struct.primitives.length, i = new Array(e), n = 0; n < e; ++n) { var r, s; i[n] = null !== (r = null == (s = this._subMeshRenderings[n]) ? void 0 : s.createInstance()) && void 0 !== r ? r : null } return { setWeights: function (t, e) { var n; null == (n = i[t]) || n.setWeights(e) }, requiredPatches: function (e) { t._mesh.struct.morph; var n = t._mesh.struct.morph.subMeshMorphs[e], r = i[e]; if (null === r) return null; var s = [{ name: "CC_USE_MORPH", value: !0 }, { name: "CC_MORPH_TARGET_COUNT", value: n.targets.length }]; return n.attributes.includes("a_position") && s.push({ name: "CC_MORPH_TARGET_HAS_POSITION", value: !0 }), n.attributes.includes("a_normal") && s.push({ name: "CC_MORPH_TARGET_HAS_NORMAL", value: !0 }), n.attributes.includes("a_tangent") && s.push({ name: "CC_MORPH_TARGET_HAS_TANGENT", value: !0 }), s.push.apply(s, r.requiredPatches()), s }, adaptPipelineState: function (t, e) { var n; null == (n = i[t]) || n.adaptPipelineState(e) }, destroy: function () { i.forEach((function (t) { t && t.destroy() })) } } }, t }(), SM = function () { function t(t, e, i, n) { this._gfxDevice = n; var r = i.subMeshMorphs[e]; this._subMeshMorph = r, CM(t, e, n); var s = t.struct.vertexBundles[t.struct.primitives[e].vertexBundelIndices[0]].view.count; this._verticesCount = s; var a = r.targets.length, o = AM(n, s * a); this._textureInfo = { width: o.width, height: o.height }, this._attributes = r.attributes.map((function (e, i) { var n = o.create(), a = n.valueView; return r.targets.forEach((function (e, n) { for (var r = e.displacements[i], o = new Float32Array(t.data.buffer, t.data.byteOffset + r.offset, r.count), u = s * n * 4, h = 0; h < s; ++h)a[u + 4 * h + 0] = o[3 * h + 0], a[u + 4 * h + 1] = o[3 * h + 1], a[u + 4 * h + 2] = o[3 * h + 2] })), n.updatePixels(), { name: e, morphTexture: n } })) } var e = t.prototype; return e.destroy = function () { this._attributes.forEach((function (t) { t.morphTexture.destroy() })) }, e.createInstance = function () { var t = this, e = new EM(this._gfxDevice, this._subMeshMorph.targets.length); return e.setMorphTextureInfo(this._textureInfo.width, this._textureInfo.height), e.setVerticesCount(this._verticesCount), e.commit(), { setWeights: function (t) { e.setWeights(t), e.commit() }, requiredPatches: function () { return [{ name: "CC_MORPH_TARGET_USE_TEXTURE", value: !0 }] }, adaptPipelineState: function (i) { for (var n = 0; n < t._attributes.length; ++n) { var r = t._attributes[n], s = void 0; switch (r.name) { case "a_position": s = 8; break; case "a_normal": s = 9; break; case "a_tangent": s = 10; break; default: it(16374) }void 0 !== s && (i.bindSampler(s, r.morphTexture.sampler), i.bindTexture(s, r.morphTexture.texture)) } i.bindBuffer(Mb.BINDING, e.buffer), i.update() }, destroy: function () { } } }, t }(), TM = function () { function t(t, e, i, n) { this._attributes = [], this._gfxDevice = n; var r = i.subMeshMorphs[e]; CM(t, e, n), this._attributes = r.attributes.map((function (e, i) { return { name: e, targets: r.targets.map((function (e) { return { displacements: new Float32Array(t.data.buffer, t.data.byteOffset + e.displacements[i].offset, e.displacements[i].count) } })) } })) } return t.prototype.createInstance = function () { return new IM(this, this._attributes[0].targets[0].displacements.length / 3, this._gfxDevice) }, n(t, [{ key: "data", get: function () { return this._attributes } }]), t }(), IM = function () { function t(t, e, i) { this._owner = t, this._morphUniforms = new EM(i, 0); var n = AM(i, e); this._morphUniforms.setMorphTextureInfo(n.width, n.height), this._morphUniforms.commit(), this._attributes = this._owner.data.map((function (t) { var e = n.create(); return { attributeName: t.name, morphTexture: e } })) } var e = t.prototype; return e.setWeights = function (t) { for (var e = 0; e < this._attributes.length; ++e) { var i = this._attributes[e], n = i.morphTexture.valueView, r = this._owner.data[e]; t.length, r.targets.length; for (var s = 0; s < r.targets.length; ++s) { var a = r.targets[s].displacements, o = t[s], u = a.length / 3; if (0 === s) for (var h = 0; h < u; ++h)n[4 * h + 0] = a[3 * h + 0] * o, n[4 * h + 1] = a[3 * h + 1] * o, n[4 * h + 2] = a[3 * h + 2] * o; else if (0 !== o) for (var c = 0; c < u; ++c)n[4 * c + 0] += a[3 * c + 0] * o, n[4 * c + 1] += a[3 * c + 1] * o, n[4 * c + 2] += a[3 * c + 2] * o } i.morphTexture.updatePixels() } }, e.requiredPatches = function () { return [{ name: "CC_MORPH_TARGET_USE_TEXTURE", value: !0 }, { name: "CC_MORPH_PRECOMPUTED", value: !0 }] }, e.adaptPipelineState = function (t) { for (var e = 0; e < this._attributes.length; ++e) { var i = this._attributes[e], n = void 0; switch (i.attributeName) { case "a_position": n = 8; break; case "a_normal": n = 9; break; case "a_tangent": n = 10; break; default: it(16374) }void 0 !== n && (t.bindSampler(n, i.morphTexture.sampler), t.bindTexture(n, i.morphTexture.texture)) } t.bindBuffer(Mb.BINDING, this._morphUniforms.buffer), t.update() }, e.destroy = function () { this._morphUniforms.destroy(); for (var t = 0; t < this._attributes.length; ++t)this._attributes[t].morphTexture.destroy() }, t }(), EM = function () { function t(t, e) { this._targetCount = e, this._localBuffer = new DataView(new ArrayBuffer(256)), this._remoteBuffer = t.createBuffer(new Zd(18, 3, 256, 256)) } var e = t.prototype; return e.destroy = function () { this._remoteBuffer.destroy() }, e.setWeights = function (t) { t.length, this._targetCount; for (var e = S.sys.isLittleEndian, i = 0; i < t.length; ++i)this._localBuffer.setFloat32(0 + 4 * i, t[i], e) }, e.setMorphTextureInfo = function (t, e) { var i = S.sys.isLittleEndian; this._localBuffer.setFloat32(240, t, i), this._localBuffer.setFloat32(244, e, i) }, e.setVerticesCount = function (t) { var e = S.sys.isLittleEndian; this._localBuffer.setFloat32(248, t, e) }, e.commit = function () { this._remoteBuffer.update(this._localBuffer.buffer) }, n(t, [{ key: "buffer", get: function () { return this._remoteBuffer } }]), t }(); function AM(t, e) { var i, n, r, s; 2 & t.getFormatFeatures(44) ? (i = e, r = 16, n = 44, s = Float32Array) : (i = 4 * e, r = 4, n = 35, s = Uint8Array); var a = DM(i), o = a.width, u = a.height; return { width: o, height: u, create: function () { var e = new ArrayBuffer(o * u * r), i = new Float32Array(e), a = s === Float32Array ? i : new s(e), h = new Pg({ width: o, height: u, _data: a, _compressed: !1, format: n }), c = new bv; c.setFilters(1, 1), c.setMipFilter(0), c.setWrapMode(2, 2, 2), c.image = h, c.getGFXTexture() || it(16375); var l = t.getSampler(c.getSamplerInfo()); return { get texture() { return c.getGFXTexture() }, get sampler() { return l }, get valueView() { return i }, destroy: function () { c.destroy() }, updatePixels: function () { c.uploadData(a) } } } } } function CM(t, e, i) { t.renderingSubMeshes[e].enableVertexIdChannel(i) } function DM(t) { t < 5 && (t = 5); var e = C(sn(t)), i = e >> 1; return { width: 1 << (1 & e ? i + 1 : i), height: 1 << i } } var RM = {}, PM = {}; (function () { function t(t) { throw t } var e = void 0, i = this; function n(t, n) { var r, s = t.split("."), a = i; !(s[0] in a) && a.execScript && a.execScript("var " + s[0]); for (; s.length && (r = s.shift());)s.length || n === e ? a = a[r] ? a[r] : a[r] = {} : a[r] = n } var r = "undefined" != typeof Uint8Array && "undefined" != typeof Uint16Array && "undefined" != typeof Uint32Array && "undefined" != typeof DataView; function s(t) { var e, i, n, s, a, o, u, h, c, l, f = t.length, d = 0, p = Number.POSITIVE_INFINITY; for (h = 0; h < f; ++h)t[h] > d && (d = t[h]), t[h] < p && (p = t[h]); for (e = 1 << d, i = new (r ? Uint32Array : Array)(e), n = 1, s = 0, a = 2; n <= d;) { for (h = 0; h < f; ++h)if (t[h] === n) { for (o = 0, u = s, c = 0; c < n; ++c)o = o << 1 | 1 & u, u >>= 1; for (l = n << 16 | h, c = o; c < e; c += a)i[c] = l; ++s } ++n, s <<= 1, a <<= 1 } return [i, d, p] } function a(e, i) { switch (this.g = [], this.h = 32768, this.d = this.f = this.a = this.j = 0, this.input = r ? new Uint8Array(e) : e, this.k = !1, this.e = u, this.o = !1, !i && (i = {}) || (i.index && (this.a = i.index), i.bufferSize && (this.h = i.bufferSize), i.bufferType && (this.e = i.bufferType), i.resize && (this.o = i.resize)), this.e) { case o: this.b = 32768, this.c = new (r ? Uint8Array : Array)(32768 + this.h + 258); break; case u: this.b = 0, this.c = new (r ? Uint8Array : Array)(this.h); break; default: t(Error("invalid inflate mode")) } } var o = 0, u = 1, h = { q: o, p: u }; a.prototype.i = function () { for (; !this.k;) { var i = C(this, 3); switch (1 & i && (this.k = !0), i >>>= 1) { case 0: var n = this.input, a = this.a, h = this.c, c = this.b, l = n.length, f = e, p = h.length, _ = e; switch (this.d = this.f = 0, a + 1 >= l && t(Error("invalid uncompressed block header: LEN")), f = n[a++] | n[a++] << 8, a + 1 >= l && t(Error("invalid uncompressed block header: NLEN")), f === ~(n[a++] | n[a++] << 8) && t(Error("invalid uncompressed block header: length verify")), a + f > n.length && t(Error("input buffer is broken")), this.e) { case o: for (; c + f > h.length;) { if (f -= _ = p - c, r) h.set(n.subarray(a, a + _), c), c += _, a += _; else for (; _--;)h[c++] = n[a++]; this.b = c, h = B(this), c = this.b } break; case u: for (; c + f > h.length;)h = M(this, { m: 2 }); break; default: t(Error("invalid inflate mode")) }if (r) h.set(n.subarray(a, a + f), c), c += f, a += f; else for (; f--;)h[c++] = n[a++]; this.a = a, this.b = c, this.c = h; break; case 1: switch (this.e) { case u: P(this, I, A); break; case o: R(this, I, A); break; default: t(Error("invalid inflate mode")) }break; case 2: var g, m, v, y, b = C(this, 5) + 257, w = C(this, 5) + 1, x = C(this, 4) + 4, S = new (r ? Uint8Array : Array)(d.length), T = e, E = e, O = e, L = e, F = e; for (F = 0; F < x; ++F)S[d[F]] = C(this, 3); if (!r) for (F = x, x = S.length; F < x; ++F)S[d[F]] = 0; for (g = s(S), T = new (r ? Uint8Array : Array)(b + w), F = 0, y = b + w; F < y;)switch (E = D(this, g), E) { case 16: for (L = 3 + C(this, 2); L--;)T[F++] = O; break; case 17: for (L = 3 + C(this, 3); L--;)T[F++] = 0; O = 0; break; case 18: for (L = 11 + C(this, 7); L--;)T[F++] = 0; O = 0; break; default: O = T[F++] = E }switch (m = s(r ? T.subarray(0, b) : T.slice(0, b)), v = s(r ? T.subarray(b) : T.slice(b)), this.e) { case u: P(this, m, v); break; case o: R(this, m, v); break; default: t(Error("invalid inflate mode")) }break; default: t(Error("unknown BTYPE: " + i)) } } switch (this.e) { case o: var k, N, z, U, V, G, H = 0, W = this.c, j = this.g, X = new (r ? Uint8Array : Array)(this.j + (this.b - 32768)); if (0 === j.length) k = r ? this.c.subarray(32768, this.b) : this.c.slice(32768, this.b); else { for (z = 0, U = j.length; z < U; ++z)for (V = 0, G = (N = j[z]).length; V < G; ++V)X[H++] = N[V]; for (z = 32768, U = this.b; z < U; ++z)X[H++] = W[z]; this.g = [], k = this.buffer = X } return k; case u: var q, Y = this.b; return r ? this.o ? (q = new Uint8Array(Y)).set(this.c.subarray(0, Y)) : q = this.c.subarray(0, Y) : (this.c.length > Y && (this.c.length = Y), q = this.c), this.buffer = q; default: t(Error("invalid inflate mode")) } }; var c, l, f = [16, 17, 18, 0, 8, 7, 9, 6, 10, 5, 11, 4, 12, 3, 13, 2, 14, 1, 15], d = r ? new Uint16Array(f) : f, p = [3, 4, 5, 6, 7, 8, 9, 10, 11, 13, 15, 17, 19, 23, 27, 31, 35, 43, 51, 59, 67, 83, 99, 115, 131, 163, 195, 227, 258, 258, 258], _ = r ? new Uint16Array(p) : p, g = [0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 4, 5, 5, 5, 5, 0, 0, 0], m = r ? new Uint8Array(g) : g, v = [1, 2, 3, 4, 5, 7, 9, 13, 17, 25, 33, 49, 65, 97, 129, 193, 257, 385, 513, 769, 1025, 1537, 2049, 3073, 4097, 6145, 8193, 12289, 16385, 24577], y = r ? new Uint16Array(v) : v, b = [0, 0, 0, 0, 1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9, 10, 10, 11, 11, 12, 12, 13, 13], w = r ? new Uint8Array(b) : b, x = new (r ? Uint8Array : Array)(288); for (c = 0, l = x.length; c < l; ++c)x[c] = 143 >= c ? 8 : 255 >= c ? 9 : 279 >= c ? 7 : 8; var S, T, I = s(x), E = new (r ? Uint8Array : Array)(30); for (S = 0, T = E.length; S < T; ++S)E[S] = 5; var A = s(E); function C(e, i) { var n, r = e.f, s = e.d, a = e.input, o = e.a; for (o + (i - s + 7 >> 3) >= a.length && t(Error("input buffer is broken")); s < i;)r |= a[o++] << s, s += 8; return n = r & (1 << i) - 1, e.f = r >>> i, e.d = s - i, e.a = o, n } function D(e, i) { for (var n, r, s = e.f, a = e.d, o = e.input, u = e.a, h = o.length, c = i[0], l = i[1]; a < l && !(u >= h);)s |= o[u++] << a, a += 8; return (r = (n = c[s & (1 << l) - 1]) >>> 16) > a && t(Error("invalid code length: " + r)), e.f = s >> r, e.d = a - r, e.a = u, 65535 & n } function R(t, e, i) { var n = t.c, r = t.b; t.l = e; for (var s, a, o, u, h = n.length - 258; 256 !== (s = D(t, e));)if (256 > s) r >= h && (t.b = r, n = B(t), r = t.b), n[r++] = s; else for (u = _[a = s - 257], 0 < m[a] && (u += C(t, m[a])), s = D(t, i), o = y[s], 0 < w[s] && (o += C(t, w[s])), r >= h && (t.b = r, n = B(t), r = t.b); u--;)n[r] = n[r++ - o]; for (; 8 <= t.d;)t.d -= 8, t.a--; t.b = r } function P(t, e, i) { var n = t.c, r = t.b; t.l = e; for (var s, a, o, u, h = n.length; 256 !== (s = D(t, e));)if (256 > s) r >= h && (h = (n = M(t)).length), n[r++] = s; else for (u = _[a = s - 257], 0 < m[a] && (u += C(t, m[a])), s = D(t, i), o = y[s], 0 < w[s] && (o += C(t, w[s])), r + u > h && (h = (n = M(t)).length); u--;)n[r] = n[r++ - o]; for (; 8 <= t.d;)t.d -= 8, t.a--; t.b = r } function B(t) { var e, i, n = new (r ? Uint8Array : Array)(t.b - 32768), s = t.b - 32768, a = t.c; if (r) n.set(a.subarray(32768, n.length)); else for (e = 0, i = n.length; e < i; ++e)n[e] = a[e + 32768]; if (t.g.push(n), t.j += n.length, r) a.set(a.subarray(s, s + 32768)); else for (e = 0; 32768 > e; ++e)a[e] = a[s + e]; return t.b = 32768, a } function M(t, e) { var i, n, s, a = t.input.length / t.a + 1 | 0, o = t.input, u = t.c; return e && ("number" == typeof e.m && (a = e.m), "number" == typeof e.r && (a += e.r)), n = 2 > a ? (s = (o.length - t.a) / t.l[2] / 2 * 258 | 0) < u.length ? u.length + s : u.length << 1 : u.length * a, r ? (i = new Uint8Array(n)).set(u) : i = u, t.c = i, t.c } function O(e, i) { var n, r; this.input = e, this.a = 0, !i && (i = {}) || (i.index && (this.a = i.index), i.verify && (this.s = i.verify)), n = e[this.a++], r = e[this.a++], (15 & n) === L ? this.method = L : t(Error("unsupported compression method")), 0 != ((n << 8) + r) % 31 && t(Error("invalid fcheck flag:" + ((n << 8) + r) % 31)), 32 & r && t(Error("fdict flag is not supported")), this.n = new a(e, { index: this.a, bufferSize: i.bufferSize, bufferType: i.bufferType, resize: i.resize }) } O.prototype.i = function () { var e, i, n = this.input; if (e = this.n.i(), this.a = this.n.a, this.s) { i = (n[this.a++] << 24 | n[this.a++] << 16 | n[this.a++] << 8 | n[this.a++]) >>> 0; var r = e; if ("string" == typeof r) { var s, a, o = r.split(""); for (s = 0, a = o.length; s < a; s++)o[s] = (255 & o[s].charCodeAt(0)) >>> 0; r = o } for (var u, h = 1, c = 0, l = r.length, f = 0; 0 < l;) { l -= u = 1024 < l ? 1024 : l; do { c += h += r[f++] } while (--u); h %= 65521, c %= 65521 } i !== (c << 16 | h) >>> 0 && t(Error("invalid adler-32 checksum")) } return e }; var L = 8; n("Zlib.Inflate", O), n("Zlib.Inflate.prototype.decompress", O.prototype.i); var F, k, N, z, U = { ADAPTIVE: h.p, BLOCK: h.q }; if (Object.keys) F = Object.keys(U); else for (k in F = [], N = 0, U) F[N++] = k; for (N = 0, z = F.length; N < z; ++N)n("Zlib.Inflate.BufferType." + (k = F[N]), U[k]) }).call(PM); var BM, MM, OM, LM, FM, kM = PM.Zlib; kM.Inflate = kM.Inflate, kM.Inflate.BufferType = kM.Inflate.BufferType, kM.Inflate.prototype.decompress = kM.Inflate.prototype.decompress; var NM = Kn.add, zM = Kn.multiplyScalar, UM = Kn.subtract, VM = hu.transform, GM = hu.fromPoints, HM = Kn.max, WM = Kn.min, jM = Kn.transformQuat, XM = Kn.transformMat4; function qM(t) { switch (t) { case 1: default: return Uint8Array; case 2: return Uint16Array; case 4: return Uint32Array } } var YM = new Kn, KM = new Kn, QM = new Uint8Array, ZM = Gu("cc.Mesh")((MM = function (t) { function e(e) { var i; return (i = t.call(this, e) || this).morphRendering = null, i._struct = OM && OM(), i._hash = LM && LM(), i._data = QM, i._initialized = !1, i._allowDataAccess = FM && FM(), i._isMeshDataUploaded = !1, i._renderingSubMeshes = null, i._boneSpaceBounds = new Map, i._jointBufferIndices = null, i } s(e, t); var i = e.prototype; return i.onLoaded = function () { this.initialize() }, i.initialize = function () { if (!this._initialized) { this._initialized = !0; var t = { struct: this.struct, data: this.data }; if (t.struct.compressed && (G = t, H = new kM.Inflate(G.data).decompress(), G.data = H, G.struct.compressed = !1, t = G), this.struct.encoded && (t = nO(t)), !this.struct.quantized || 16 & B_.gfxDevice.getFormatFeatures(29) || (t = rO(t)), this._struct = t.struct, this._data = t.data, this._struct.dynamic) { for (var e = B_.gfxDevice, i = [], n = [], r = 0; r < this._struct.vertexBundles.length; r++) { var s = this._struct.vertexBundles[r], a = e.createBuffer(new Zd(10, 1, s.view.length, s.view.stride)); i.push(a) } for (var o = 0; o < this._struct.primitives.length; o++) { var u = this._struct.primitives[o], h = u.indexView, c = null; h && (c = e.createBuffer(new Zd(6, 1, h.length, h.stride))); for (var l = [], f = 0; f < u.vertexBundelIndices.length; f++) { var d = u.vertexBundelIndices[f]; l.push(i[d]) } for (var p = [], _ = 0; _ < u.vertexBundelIndices.length; _++)for (var g = u.vertexBundelIndices[_], m = this._struct.vertexBundles[g].attributes, v = 0; v < m.length; v++) { var y = m[v], b = new pp; b.copy(y), p.push(b) } var w = new DB(l, p, u.primitiveMode, c); w.drawInfo = new $d, w.mesh = this, w.subMeshIdx = o, n.push(w) } this._renderingSubMeshes = n } else { for (var x = this._data.buffer, S = B_.gfxDevice, T = this._createVertexBuffers(S, x), I = [], E = [], A = 0; A < this._struct.primitives.length; A++) { var C = this._struct.primitives[A]; if (0 !== C.vertexBundelIndices.length) { var D = null, R = void 0; if (C.indexView) { var P = C.indexView, B = P.stride, M = P.length; if (4 === B && !S.hasFeature(0)) { var O = this._struct.vertexBundles[C.vertexBundelIndices[0]].view.count; if (O >= 65536) { it(10001, O, 65536); continue } B >>= 1, M >>= 1 } D = S.createBuffer(new Zd(4, 1, M, B)), I.push(D), R = new (qM(P.stride))(x, P.offset, P.count), P.stride !== B && (R = qM(B).from(R)), D.update(R) } var L = C.vertexBundelIndices.map((function (t) { return T[t] })), F = []; if (C.vertexBundelIndices.length > 0) for (var k = C.vertexBundelIndices[0], N = this._struct.vertexBundles[k].attributes, z = 0; z < N.length; ++z) { var U = N[z]; F[z] = new pp(U.name, U.format, U.isNormalized, U.stream, U.isInstanced, U.location) } var V = new DB(L, F, C.primitiveMode, D); V.mesh = this, V.subMeshIdx = A, E.push(V) } } this._renderingSubMeshes = E, this._struct.morph && (this.morphRendering = wM(this, S)), this._isMeshDataUploaded = !0, this._allowDataAccess || this.releaseData() } } var G, H }, i.updateSubMesh = function (t, e) { if (this._struct.dynamic) if (t >= this._struct.primitives.length) it(14201); else { var i = []; if (e.positions.length > 0 && i.push(e.positions), e.normals && e.normals.length > 0 && i.push(e.normals), e.uvs && e.uvs.length > 0 && i.push(e.uvs), e.tangents && e.tangents.length > 0 && i.push(e.tangents), e.colors && e.colors.length > 0 && i.push(e.colors), e.customAttributes) for (var n = 0; n < e.customAttributes.length; n++)i.push(e.customAttributes[n].values); for (var r = this._struct.dynamic, s = r.info, a = this._struct.primitives[t], o = this._renderingSubMeshes[t], u = o.drawInfo, h = 0; h < i.length; h++) { var c = i[h], l = this._struct.vertexBundles[a.vertexBundelIndices[h]], f = l.view.stride, d = c.byteLength / f, p = c.byteLength, _ = new Uint8Array(this._data.buffer, l.view.offset, p), g = new Uint8Array(c.buffer, c.byteOffset, p), m = o.vertexBuffers[h]; s.maxSubMeshVertices, p > 0 && (_.set(g), m.update(g, p)), l.view.count = d, u.vertexCount = d } if (a.indexView) { var v = a.indexView, y = v.stride, b = 2 === y ? e.indices16.length : e.indices32.length, w = b * y, x = new Uint8Array(this._data.buffer, v.offset, w), S = 2 === y ? new Uint8Array(e.indices16.buffer, e.indices16.byteOffset, w) : new Uint8Array(e.indices32.buffer, e.indices32.byteOffset, w), T = o.indexBuffer; s.maxSubMeshIndices, w > 0 && (x.set(S), T.update(S, w)), v.count = b, u.indexCount = b } if (e.minPos && e.maxPos) { var I = Qn(e.minPos.x, e.minPos.y, e.minPos.z), E = Qn(e.maxPos.x, e.maxPos.y, e.maxPos.z); r.bounds[t] || (r.bounds[t] = new hu), GM(r.bounds[t], I, E); var A = Qn(), C = Qn(); r.bounds.forEach((function (t) { t && (t.getBoundary(A, C), WM(I, A, I), HM(E, C, E)) })), this._struct.minPosition = Qn(I.x, I.y, I.z), this._struct.maxPosition = Qn(E.x, E.y, E.z) } o.invalidateGeometricInfo() } else it(14200) }, i.destroy = function () { return this.destroyRenderingMesh(), t.prototype.destroy.call(this) }, i.destroyRenderingMesh = function () { if (this._renderingSubMeshes) { for (var t = 0; t < this._renderingSubMeshes.length; t++)this._renderingSubMeshes[t].destroy(); this._renderingSubMeshes = null, this._initialized = !1, this._isMeshDataUploaded = !1 } }, i.assign = function (t, e) { this.reset({ struct: t, data: e }) }, i.reset = function (t) { this.destroyRenderingMesh(), this._struct = t.struct, this._data = t.data, this._hash = 0 }, i.getBoneSpaceBounds = function (t) { if (this._boneSpaceBounds.has(t.hash)) return this._boneSpaceBounds.get(t.hash); var e = []; this._boneSpaceBounds.set(t.hash, e); for (var i = [], n = t.bindposes, r = 0; r < n.length; r++)e.push(new hu(1 / 0, 1 / 0, 1 / 0, -1 / 0, -1 / 0, -1 / 0)), i.push(!1); for (var s = this._struct.primitives, a = 0; a < s.length; a++) { var o = this.readAttribute(a, "a_joints"), u = this.readAttribute(a, "a_weights"), h = this.readAttribute(a, "a_position"); if (o && u && h) for (var c = Math.min(o.length / 4, u.length / 4, h.length / 3), l = 0; l < c; l++) { Kn.set(YM, h[3 * l + 0], h[3 * l + 1], h[3 * l + 2]); for (var f = 0; f < 4; ++f) { var d = 4 * l + f, p = o[d]; if (!(0 === u[d] || p >= n.length)) { XM(KM, YM, n[p]), i[p] = !0; var _ = e[p]; WM(_.center, _.center, KM), HM(_.halfExtents, _.halfExtents, KM) } } } } for (var g = 0; g < n.length; g++) { var m = e[g]; i[g] ? GM(m, m.center, m.halfExtents) : e[g] = null } return e }, i.merge = function (t, e, i) { if (i && !this.validateMergingMesh(t)) return !1; var n = new Kn, r = e && new Er, s = e && new hu; if (r && e.getRotation(r), !this._initialized) { var a = JSON.parse(JSON.stringify(t._struct)), o = t._data.slice(); if (e) { a.maxPosition && a.minPosition && (NM(s.center, a.maxPosition, a.minPosition), zM(s.center, s.center, .5), UM(s.halfExtents, a.maxPosition, a.minPosition), zM(s.halfExtents, s.halfExtents, .5), VM(s, s, e), NM(a.maxPosition, s.center, s.halfExtents), UM(a.minPosition, s.center, s.halfExtents)); for (var u = 0; u < a.vertexBundles.length; u++)for (var h = a.vertexBundles[u], c = 0; c < h.attributes.length; c++)if ("a_position" === h.attributes[c].name || "a_normal" === h.attributes[c].name) { var l = h.attributes[c].format, f = new DataView(o.buffer, h.view.offset + JM(h.attributes, c)), d = eO(f, l), _ = iO(f, l); if (!d || !_) continue; for (var g = h.view.count, m = h.view.stride, v = tO(l), y = 0; y < g; y++) { var b = y * m, w = b + v, x = w + v; switch (n.set(d(b), d(w), d(x)), h.attributes[c].name) { case "a_position": n.transformMat4(e); break; case "a_normal": jM(n, n, r) }_(b, n.x), _(w, n.y), _(x, n.z) } } } return this.reset({ struct: a, data: o }), this.initialize(), !0 } for (var S, T, I, E, A, C = new bM, D = 0, R = 0, P = 0, B = 0, M = 0, O = 0, L = 0, F = 0, k = !1, N = new Array(this._struct.vertexBundles.length), z = 0; z < this._struct.vertexBundles.length; ++z) { var U = this._struct.vertexBundles[z], V = t._struct.vertexBundles[z]; P = U.view.offset, B = V.view.offset, R = U.view.stride, D = U.view.count + V.view.count, S = new ArrayBuffer(D * R), T = new Uint8Array(S), P += (I = this._data.subarray(P, P + U.view.length)).length, B += (E = t._data.subarray(B, B + V.view.length)).length, T.set(I), M = 0; for (var G, H = p(U.attributes); !(G = H()).done;) { var W = G.value; L = 0, k = !1; for (var j, X = p(V.attributes); !(j = X()).done;) { var q = j.value; if (W.name === q.name && W.format === q.format) { k = !0; break } L += Wp[q.format].size } if (k) { F = Wp[W.format].size, O = U.view.length + M; for (var Y = 0; Y < V.view.count; ++Y) { if (A = E.subarray(L, L + F), T.set(A, O), ("a_position" === W.name || "a_normal" === W.name) && e) { var K = new Float32Array(T.buffer, O, 3); switch (n.set(K[0], K[1], K[2]), W.name) { case "a_position": n.transformMat4(e); break; case "a_normal": jM(n, n, r) }K[0] = n.x, K[1] = n.y, K[2] = n.z } O += U.view.stride, L += V.view.stride } } M += Wp[W.format].size } N[z] = { attributes: U.attributes, view: { offset: C.getLength(), length: S.byteLength, count: D, stride: R } }, C.addBuffer(S) } for (var Q, Z, J, $ = 0, tt = 2, et = new Array(this._struct.primitives.length), it = 0; it < this._struct.primitives.length; ++it) { var nt = this._struct.primitives[it], rt = t._struct.primitives[it]; et[it] = { primitiveMode: nt.primitiveMode, vertexBundelIndices: nt.vertexBundelIndices }; for (var st, at = 0, ot = p(nt.vertexBundelIndices); !(st = ot()).done;) { var ut = st.value; at = Math.max(at, this._struct.vertexBundles[ut].view.count) } if (nt.indexView && rt.indexView) { $ = nt.indexView.count, $ += rt.indexView.count, P = nt.indexView.offset, B = rt.indexView.offset, tt = $ < 256 ? 1 : $ < 65536 ? 2 : 4; var ht = new ArrayBuffer($ * tt); if (Q = 2 === tt ? new Uint16Array(ht) : 1 === tt ? new Uint8Array(ht) : new Uint32Array(ht), Z = 2 === nt.indexView.stride ? new Uint16Array(this._data.buffer, P, nt.indexView.count) : 1 === nt.indexView.stride ? new Uint8Array(this._data.buffer, P, nt.indexView.count) : new Uint32Array(this._data.buffer, P, nt.indexView.count), tt === nt.indexView.stride) Q.set(Z); else for (var ct = 0; ct < nt.indexView.count; ++ct)Q[ct] = Z[ct]; P += nt.indexView.length, J = 2 === rt.indexView.stride ? new Uint16Array(t._data.buffer, B, rt.indexView.count) : 1 === rt.indexView.stride ? new Uint8Array(t._data.buffer, B, rt.indexView.count) : new Uint32Array(t._data.buffer, B, rt.indexView.count); for (var lt = 0; lt < rt.indexView.count; ++lt)Q[nt.indexView.count + lt] = at + J[lt]; B += rt.indexView.length, et[it].indexView = { offset: C.getLength(), length: ht.byteLength, count: $, stride: tt }, C.setNextAlignment(tt), C.addBuffer(ht) } } var ft = { vertexBundles: N, primitives: et, minPosition: this._struct.minPosition, maxPosition: this._struct.maxPosition }; return ft.minPosition && t._struct.minPosition && ft.maxPosition && t._struct.maxPosition && (e ? (NM(s.center, t._struct.maxPosition, t._struct.minPosition), zM(s.center, s.center, .5), UM(s.halfExtents, t._struct.maxPosition, t._struct.minPosition), zM(s.halfExtents, s.halfExtents, .5), VM(s, s, e), NM(n, s.center, s.halfExtents), HM(ft.maxPosition, ft.maxPosition, n), UM(n, s.center, s.halfExtents), WM(ft.minPosition, ft.minPosition, n)) : (WM(ft.minPosition, ft.minPosition, t._struct.minPosition), HM(ft.maxPosition, ft.maxPosition, t._struct.maxPosition))), this.reset({ struct: ft, data: new Uint8Array(C.getCombined()) }), this.initialize(), !0 }, i.validateMergingMesh = function (t) { if (this._struct.dynamic || t._struct.dynamic) return !1; if (this._struct.vertexBundles.length !== t._struct.vertexBundles.length) return !1; for (var e = 0; e < this._struct.vertexBundles.length; ++e) { var i = this._struct.vertexBundles[e], n = t._struct.vertexBundles[e]; if (i.attributes.length !== n.attributes.length) return !1; for (var r = 0; r < i.attributes.length; ++r)if (i.attributes[r].format !== n.attributes[r].format) return !1 } if (this._struct.primitives.length !== t._struct.primitives.length) return !1; for (var s = 0; s < this._struct.primitives.length; ++s) { var a = this._struct.primitives[s], o = t._struct.primitives[s]; if (a.vertexBundelIndices.length !== o.vertexBundelIndices.length) return !1; for (var u = 0; u < a.vertexBundelIndices.length; ++u)if (a.vertexBundelIndices[u] !== o.vertexBundelIndices[u]) return !1; if (a.primitiveMode !== o.primitiveMode) return !1; if (a.indexView) { if (void 0 === o.indexView) return !1 } else if (o.indexView) return !1 } return !0 }, i.readAttribute = function (t, e) { var i = this, n = null; return this._accessAttribute(t, e, (function (t, e) { var r = t.view.count, s = t.attributes[e].format, a = $p(Wp[s]); if (0 !== r) { var o = new DataView(i._data.buffer, t.view.offset + JM(t.attributes, e)), u = Wp[s], h = eO(o, s); if (a && h) { for (var c = u.count, l = new a(r * c), f = t.view.stride, d = 0; d < r; ++d)for (var p = 0; p < c; ++p)l[c * d + p] = h(f * d + l.BYTES_PER_ELEMENT * p); n = l } } })), n }, i.copyAttribute = function (t, e, i, n, r) { var s = this, a = !1; return this._accessAttribute(t, e, (function (t, e) { var o = t.view.count; if (0 !== o) { var u = t.attributes[e].format, h = new DataView(s._data.buffer, t.view.offset + JM(t.attributes, e)), c = new DataView(i, r), l = Wp[u], f = eO(h, u), d = iO(c, u); if (f && d) { for (var p = l.count, _ = t.view.stride, g = tO(u), m = n, v = g, y = 0; y < o; ++y)for (var b = 0; b < p; ++b)d(m * y + v * b, f(_ * y + g * b)); a = !0 } } else a = !0 })), a }, i.readIndices = function (t) { if (t >= this._struct.primitives.length) return null; var e = this._struct.primitives[t]; if (!e.indexView) return null; var i = e.indexView.stride; return new (1 === i ? Uint8Array : 2 === i ? Uint16Array : Uint32Array)(this._data.buffer, e.indexView.offset, e.indexView.count) }, i.copyIndices = function (t, e) { if (t >= this._struct.primitives.length) return !1; var i = this._struct.primitives[t]; if (!i.indexView) return !1; for (var n = i.indexView.count, r = 1 === i.indexView.stride ? 6 : 2 === i.indexView.stride ? 9 : 12, s = eO(new DataView(this._data.buffer), r), a = 0; a < n; ++a)e[a] = s(i.indexView.offset + Wp[r].size * a); return !0 }, i.readAttributeFormat = function (t, e) { var i = null; return this._accessAttribute(t, e, (function (t, e) { var n = t.attributes[e].format; i = Wp[n] })), i }, i._accessAttribute = function (t, e, i) { if (!(t >= this._struct.primitives.length)) for (var n = this._struct.primitives[t].vertexBundelIndices, r = 0; r < n.length; r++) { var s = n[r], a = this._struct.vertexBundles[s], o = a.attributes.findIndex((function (t) { return t.name === e })); if (!(o < 0)) { i(a, o); break } } }, i._createVertexBuffers = function (t, e) { return this._struct.vertexBundles.map((function (i) { var n = t.createBuffer(new Zd(8, 1, i.view.length, i.view.stride)), r = new Uint8Array(e, i.view.offset, i.view.length); return n.update(r), n })) }, i.initDefault = function (e) { t.prototype.initDefault.call(this, e), this.reset({ struct: { vertexBundles: [], primitives: [] }, data: QM }) }, i.releaseData = function () { this._data = QM }, n(e, [{ key: "_nativeAsset", get: function () { return this._data.buffer }, set: function (t) { this._data = new Uint8Array(t) } }, { key: "subMeshCount", get: function () { var t = this.renderingSubMeshes; return t ? t.length : 0 } }, { key: "minPosition", get: function () { return this.struct.minPosition } }, { key: "maxPosition", get: function () { return this.struct.maxPosition } }, { key: "struct", get: function () { return this._struct } }, { key: "data", get: function () { return this._data } }, { key: "hash", get: function () { return this._hash || (this._hash = Lf(this._data, 666)), this._hash } }, { key: "jointBufferIndices", get: function () { return this._jointBufferIndices ? this._jointBufferIndices : this._jointBufferIndices = this._struct.primitives.map((function (t) { return t.jointMapIndex || 0 })) } }, { key: "renderingSubMeshes", get: function () { return this.initialize(), this._renderingSubMeshes } }, { key: "allowDataAccess", get: function () { return this._allowDataAccess }, set: function (t) { this._allowDataAccess = t, this._isMeshDataUploaded && !this._allowDataAccess && this.releaseData() } }]), e }(pg), OM = Bu(MM.prototype, "_struct", [eh], (function () { return { vertexBundles: [], primitives: [] } })), LM = Bu(MM.prototype, "_hash", [eh], (function () { return 0 })), FM = Bu(MM.prototype, "_allowDataAccess", [eh], (function () { return !0 })), BM = MM)) || BM; function JM(t, e) { for (var i = 0, n = 0; n < e; ++n) { var r = t[n]; i += Wp[r.format].size } return i } S.Mesh = ZM; var $M = tu.isLittleEndian; function tO(t) { var e = Wp[t]; return e.size / e.count } function eO(t, e) { var i = Wp[e], n = i.size / i.count; switch (i.type) { case 1: case 3: switch (n) { case 1: return function (e) { return t.getUint8(e) }; case 2: return function (e) { return t.getUint16(e, $M) }; case 4: return function (e) { return t.getUint32(e, $M) } }break; case 2: case 4: switch (n) { case 1: return function (e) { return t.getInt8(e) }; case 2: return function (e) { return t.getInt16(e, $M) }; case 4: return function (e) { return t.getInt32(e, $M) } }break; case 6: switch (n) { case 2: return function (e) { return t.getUint16(e, $M) }; case 4: return function (e) { return t.getFloat32(e, $M) } } }return null } function iO(t, e) { var i = Wp[e], n = i.size / i.count; switch (i.type) { case 1: case 3: switch (n) { case 1: return function (e, i) { return t.setUint8(e, i) }; case 2: return function (e, i) { return t.setUint16(e, i, $M) }; case 4: return function (e, i) { return t.setUint32(e, i, $M) } }break; case 2: case 4: switch (n) { case 1: return function (e, i) { return t.setInt8(e, i) }; case 2: return function (e, i) { return t.setInt16(e, i, $M) }; case 4: return function (e, i) { return t.setInt32(e, i, $M) } }break; case 6: switch (n) { case 2: return function (e, i) { return t.setUint16(e, i, $M) }; case 4: return function (e, i) { return t.setFloat32(e, i, $M) } } }return null } function nO(t) { if (!t.struct.encoded) return t; var e = function (t) { t < 0 && rt(14204, t) }, i = JSON.parse(JSON.stringify(t.struct)), n = new bM; n.setNextAlignment(0); for (var r, s = p(i.vertexBundles); !(r = s()).done;) { var a = r.value, o = a.view, u = o.count * o.stride, h = new Uint8Array(u), c = new Uint8Array(t.data.buffer, o.offset, o.length); e(RM.decodeVertexBuffer(h, o.count, o.stride, c)), n.setNextAlignment(o.stride); var l = { offset: n.getLength(), length: h.byteLength, count: o.count, stride: o.stride }; a.view = l, n.addBuffer(h) } for (var f, d = p(i.primitives); !(f = d()).done;) { var _ = f.value; if (void 0 !== _.indexView) { var g = _.indexView, m = g.count * g.stride, v = new Uint8Array(m), y = new Uint8Array(t.data.buffer, g.offset, g.length); e(RM.decodeIndexBuffer(v, g.count, g.stride, y)), n.setNextAlignment(g.stride); var b = { offset: n.getLength(), length: v.byteLength, count: g.count, stride: g.stride }; _.indexView = b, n.addBuffer(v) } } return { struct: i, data: new Uint8Array(n.getCombined()) } } function rO(t) { var e = JSON.parse(JSON.stringify(t.struct)), i = new bM; function n(t, e, i, n, r, s, a) { for (var o = 0; o < i; o++)for (var u = 0; u < n; u++)e(a * o + r * u, t(s * o + r * u)) } function r(t, e, i, n, r, s) { for (var a = 0; a < i; a++)for (var o = 0; o < n; o++)e(s * a + 4 * o, mn(t(r * a + 2 * o))) } i.setNextAlignment(0); for (var s = 0; s < e.vertexBundles.length; ++s) { for (var a = e.vertexBundles[s], o = a.view, u = a.attributes, h = t.struct.vertexBundles[s].attributes, c = [], l = [], f = [], d = 0; d < u.length; ++d) { var _ = u[d], g = eO(new DataView(t.data.buffer, o.offset + JM(h, d)), _.format), m = !0; switch (_.format) { case 8: _.format = 11; break; case 18: _.format = 21; break; case 29: _.format = 32; break; case 41: _.format = 44; break; default: m = !1 }c.push(Wp[_.format].size), l.push(m), f.push(g) } for (var v = c.reduce((function (t, e) { return t + e }), 0), y = new Uint8Array(v * o.count), b = 0; b < u.length; ++b) { var w = u[b], x = f[b], S = iO(new DataView(y.buffer, JM(u, b)), w.format), T = l[b], I = Wp[w.format]; T ? r(x, S, o.count, I.count, o.stride, v) : n(x, S, o.count, I.count, I.size / I.count, o.stride, v) } i.setNextAlignment(v); var E = { offset: i.getLength(), length: y.byteLength, count: o.count, stride: v }; a.view = E, i.addBuffer(y) } for (var A, C = p(e.primitives); !(A = C()).done;) { var D = A.value; if (void 0 !== D.indexView) { var R = D.indexView, P = new Uint8Array(t.data.buffer, R.offset, R.length); i.setNextAlignment(R.stride); var B = { offset: i.getLength(), length: P.byteLength, count: R.count, stride: R.stride }; D.indexView = B, i.addBuffer(P) } } var M = new Uint8Array(i.getCombined()); return e.quantized = !1, { struct: e, data: M } } var sO, aO, oO = [new pp("a_position", 32), new pp("a_normal", 32), new pp("a_texCoord", 21), new pp("a_tangent", 44), new pp("a_color", 44)], uO = new Kn; function hO(t, e, i) { i = i || {}; var n, r = [], s = 0, a = [], o = 0, u = t.positions.slice(); if (u.length > 0) { n = null, t.attributes && (n = t.attributes.find((function (t) { return "a_position" === t.name })) || null), n || (n = oO[0]), r.push(n); var h = Wp[n.format]; o = Math.max(o, Math.floor(u.length / h.count)), a.push({ offset: s, data: u, attribute: n }), s += h.size } if (t.normals && t.normals.length > 0) { n = null, t.attributes && (n = t.attributes.find((function (t) { return "a_normal" === t.name })) || null), n || (n = oO[1]); var c = Wp[n.format]; r.push(n), o = Math.max(o, Math.floor(t.normals.length / c.count)), a.push({ offset: s, data: t.normals, attribute: n }), s += c.size } if (t.uvs && t.uvs.length > 0) { n = null, t.attributes && (n = t.attributes.find((function (t) { return "a_texCoord" === t.name })) || null), n || (n = oO[2]); var l = Wp[n.format]; r.push(n), o = Math.max(o, Math.floor(t.uvs.length / l.count)), a.push({ offset: s, data: t.uvs, attribute: n }), s += l.size } if (t.tangents && t.tangents.length > 0) { n = null, t.attributes && (n = t.attributes.find((function (t) { return "a_tangent" === t.name })) || null), n || (n = oO[3]); var f = Wp[n.format]; r.push(n), o = Math.max(o, Math.floor(t.tangents.length / f.count)), a.push({ offset: s, data: t.tangents, attribute: n }), s += f.size } if (t.colors && t.colors.length > 0) { n = null, t.attributes && (n = t.attributes.find((function (t) { return "a_color" === t.name })) || null), n || (n = oO[4]); var d = Wp[n.format]; r.push(n), o = Math.max(o, Math.floor(t.colors.length / d.count)), a.push({ offset: s, data: t.colors, attribute: n }), s += d.size } if (t.customAttributes) for (var p = 0; p < t.customAttributes.length; p++) { var _ = t.customAttributes[p], g = Wp[_.attr.format]; r.push(_.attr), o = Math.max(o, Math.floor(_.values.length / g.count)), a.push({ offset: s, data: _.values, attribute: _.attr }), s += g.size } var m = new bM, v = new ArrayBuffer(o * s), y = new DataView(v); a.forEach((function (t) { IB(y, t.data, t.attribute.format, t.offset, s) })), m.setNextAlignment(0); var b = { attributes: r, view: { offset: m.getLength(), length: v.byteLength, count: o, stride: s } }; m.addBuffer(v); var w = null, x = 0; if (t.indices) { var S = t.indices; x = S.length, w = new ArrayBuffer(2 * x), IB(new DataView(w), S, 9) } var T = { primitiveMode: t.primitiveMode || 7, vertexBundelIndices: [0] }; w && (m.setNextAlignment(2), T.indexView = { offset: m.getLength(), length: w.byteLength, count: x, stride: 2 }, m.addBuffer(w)); var I = t.minPos; if (!I && i.calculateBounds) { I = Kn.set(new Kn, 1 / 0, 1 / 0, 1 / 0); for (var E = 0; E < o; ++E)Kn.set(uO, u[3 * E + 0], u[3 * E + 1], u[3 * E + 2]), Kn.min(I, I, uO) } var A = t.maxPos; if (!A && i.calculateBounds) { A = Kn.set(new Kn, -1 / 0, -1 / 0, -1 / 0); for (var C = 0; C < o; ++C)Kn.set(uO, u[3 * C + 0], u[3 * C + 1], u[3 * C + 2]), Kn.max(A, A, uO) } var D = { vertexBundles: [b], primitives: [T] }; return I && (D.minPosition = new Kn(I.x, I.y, I.z)), A && (D.maxPosition = new Kn(A.x, A.y, A.z)), e || (e = new ZM), e.reset({ struct: D, data: new Uint8Array(m.getCombined()) }), e } var cO, lO, fO, dO = Qn(), pO = jr(), _O = Kn.transformMat4, gO = Kn.toArray, mO = [{ u: 0, v: 0 }, { u: 0, v: 0 }, { u: 0, v: 0 }, { u: 0, v: 0 }], vO = (t("SpriteFrameEvent", { UV_UPDATED: "uv_updated" }), t("SpriteFrame", Gu("cc.SpriteFrame")((aO = function (t) { function e(e) { var i; return (i = t.call(this, e) || this).vertices = null, i.uv = [], i.unbiasUV = [], i.uvSliced = [], i._rect = ds(), i._trimmedBorder = Bn(), i._offset = os(), i._originalSize = hs(), i._rotated = !1, i._capInsets = [0, 0, 0, 0], i._atlasUuid = "", i._texture = void 0, i._isFlipUVY = !1, i._isFlipUVX = !1, i._original = null, i._packable = !0, i._pixelsToUnit = 100, i._pivot = os(.5, .5), i._meshType = 0, i._extrude = 0, i._customOutLine = [], i._mesh = null, i._minPos = Qn(), i._maxPos = Qn(), i } s(e, t), e.createWithImage = function (t) { var i = t instanceof Pg ? t : new Pg(t), n = new bv; n.image = i; var r = new e; return r.texture = n, r }; var i = e.prototype; return i.textureLoaded = function () { return !!this.texture }, i.isRotated = function () { return this._rotated }, i.setRotated = function (t) { this.rotated = t }, i.getRect = function (t) { return t ? (t.set(this._rect), t) : this._rect.clone() }, i.setRect = function (t) { this.rect = t }, i.getOriginalSize = function (t) { return t ? (t.set(this._originalSize), t) : this._originalSize.clone() }, i.setOriginalSize = function (t) { this.originalSize = t }, i.getOffset = function (t) { return t ? (t.set(this._offset), t) : this._offset.clone() }, i.setOffset = function (t) { this.offset = t }, i.getGFXTexture = function () { return this._texture.getGFXTexture() }, i.getGFXSampler = function () { return this._texture.getGFXSampler() }, i.getHash = function () { return this._texture.getHash() }, i.getSamplerInfo = function () { return this._texture.getSamplerInfo() }, i.reset = function (t, e) { void 0 === e && (e = !1); var i = this, n = !1; if (e && (i._originalSize.set(0, 0), i._rect.set(0, 0, 0, 0), i._offset.set(0, 0), i._capInsets = [0, 0, 0, 0], i._rotated = !1, n = !0), t) { t.texture && (i._rect.set(0, 0, t.texture.width, t.texture.height), i._refreshTexture(t.texture), i.checkRect(i._texture)), t.originalSize && i._originalSize.set(t.originalSize), t.rect && i._rect.set(t.rect), t.offset && i._offset.set(t.offset); var r = i._capInsets; void 0 !== t.borderTop && (r[1] = t.borderTop), void 0 !== t.borderBottom && (r[3] = t.borderBottom), void 0 !== t.borderLeft && (r[0] = t.borderLeft), void 0 !== t.borderRight && (r[2] = t.borderRight), void 0 !== t.isRotate && (i._rotated = !!t.isRotate), void 0 !== t.isFlipUv && (i._isFlipUVY = !!t.isFlipUv), n = !0 } n && i.texture && i._calculateUV(), i._calcTrimmedBorder() }, i.checkRect = function (t) { var e = this._rect, i = e.x, n = e.y; return this._rotated ? (i += e.height, n += e.width) : (i += e.width, n += e.height), i > t.width ? (rt(3300, this.name + "/" + t.name, i, t.width), !1) : !(n > t.height && (rt(3301, this.name + "/" + t.name, n, t.height), 1)) }, i._calcTrimmedBorder = function () { var t = this, e = t._originalSize.width, i = t._originalSize.height, n = .5 * (e - t._rect.width), r = .5 * (i - t._rect.height), s = t._offset, a = t._trimmedBorder; a.x = s.x + n, a.y = s.x - n, a.z = s.y + r, a.w = s.y - r }, i.ensureMeshData = function () { this._mesh || (this._initVertices(), this._createMesh()) }, i.destroy = function () { return this._packable && yM && yM.deleteAtlasSpriteFrame(this), t.prototype.destroy.call(this) }, i._calculateSlicedUV = function () { var t = this, e = t._rect, i = t.texture, n = t._capInsets, r = i.width, s = i.height, a = n[0], o = n[2], u = e.width - a - o, h = n[1], c = n[3], l = e.height - h - c, f = t.uvSliced; if (f.length = 0, t._rotated) { mO[0].u = e.x / r, mO[1].u = (e.x + c) / r, mO[2].u = (e.x + c + l) / r, mO[3].u = (e.x + e.height) / r, mO[3].v = e.y / s, mO[2].v = (e.y + a) / s, mO[1].v = (e.y + a + u) / s, mO[0].v = (e.y + e.width) / s; for (var d = 0; d < 4; ++d)for (var p = mO[d], _ = 0; _ < 4; ++_) { var g = mO[3 - _]; f.push({ u: p.u, v: g.v }) } } else { mO[0].u = e.x / r, mO[1].u = (e.x + a) / r, mO[2].u = (e.x + a + u) / r, mO[3].u = (e.x + e.width) / r, mO[3].v = e.y / s, mO[2].v = (e.y + h) / s, mO[1].v = (e.y + h + l) / s, mO[0].v = (e.y + e.height) / s; for (var m = 0; m < 4; ++m)for (var v = mO[m], y = 0; y < 4; ++y) { var b = mO[y]; f.push({ u: b.u, v: v.v }) } } this.emit("uv_updated", this) }, i._calculateUV = function () { var t = ye, e = this, i = e._rect, n = e.uv, r = e.unbiasUV, s = e.texture, a = s.width, o = s.height; if (e._rotated) { var u = 0 === a ? 0 : i.x / a, h = 0 === a ? 1 : (i.x + i.height) / a, c = 0 === o ? 0 : i.y / o, l = 0 === o ? 1 : (i.y + i.width) / o; e._isFlipUVX && e._isFlipUVY ? t(n, h, l, h, c, u, l, u, c) : e._isFlipUVX ? t(n, h, c, h, l, u, c, u, l) : e._isFlipUVY ? t(n, u, l, u, c, h, l, h, c) : t(n, u, c, u, l, h, c, h, l); var f = 0 === a ? 0 : i.x / a, d = 0 === a ? 1 : (i.x + i.height) / a, p = 0 === o ? 0 : i.y / o, _ = 0 === o ? 1 : (i.y + i.width) / o; e._isFlipUVX && e._isFlipUVY ? t(r, d, _, d, p, f, _, f, p) : e._isFlipUVX ? t(r, d, p, d, _, f, p, f, _) : e._isFlipUVY ? t(r, f, _, f, p, d, _, d, p) : t(r, f, p, f, _, d, p, d, _) } else { var g = 0 === a ? 0 : i.x / a, m = 0 === a ? 1 : (i.x + i.width) / a, v = 0 === o ? 1 : (i.y + i.height) / o, y = 0 === o ? 0 : i.y / o; e._isFlipUVX && e._isFlipUVY ? t(n, m, y, g, y, m, v, g, v) : e._isFlipUVX ? t(n, m, v, g, v, m, y, g, y) : e._isFlipUVY ? t(n, g, y, m, y, g, v, m, v) : t(n, g, v, m, v, g, y, m, y); var b = 0 === a ? 0 : i.x / a, w = 0 === a ? 1 : (i.x + i.width) / a, x = 0 === o ? 1 : (i.y + i.height) / o, S = 0 === o ? 0 : i.y / o; e._isFlipUVX && e._isFlipUVY ? t(r, w, S, b, S, w, x, b, x) : e._isFlipUVX ? t(r, w, x, b, x, w, S, b, S) : e._isFlipUVY ? t(r, b, S, w, S, b, x, w, x) : t(r, b, x, w, x, b, S, w, S) } e._calculateSlicedUV() }, i._setDynamicAtlasFrame = function (t) { t && (this._original = { _texture: this._texture, _x: this._rect.x, _y: this._rect.y }, this._texture = t.texture, this._rect.x = t.x, this._rect.y = t.y, this._calculateUV()) }, i._resetDynamicAtlasFrame = function () { this._original && (this._rect.x = this._original._x, this._rect.y = this._original._y, this._texture = this._original._texture, this._original = null, this._calculateUV()) }, i._checkPackable = function () { var t = yM; if (t) { var e = this._texture; if (e instanceof bv && !e.isCompressed) { var i = this.width, n = this.height; if (!e.image || i > t.maxFrameSize || n > t.maxFrameSize) this._packable = !1; else { var r = E.HTMLCanvasElement; e.image && e.image instanceof r && (this._packable = !0) } } else this._packable = !1 } }, i._serialize = function () { return null }, i._deserialize = function (t) { var e = this, i = t, n = i.rect; n && (e._rect = new fs(n.x, n.y, n.width, n.height)); var r = i.offset; i.offset && (e._offset = os(r.x, r.y)); var s = i.originalSize; i.originalSize && (e._originalSize = hs(s.width, s.height)), e._rotated = !!i.rotated, e._name = i.name, e._packable = !!i.packable, e._pixelsToUnit = i.pixelsToUnit; var a = i.pivot; a && (e._pivot = os(a.x, a.y)), e._meshType = i.meshType; var o = i.capInsets; if (o) { var u = e._capInsets; u[0] = o[0], u[1] = o[1], u[2] = o[2], u[3] = o[3] } var h = i.vertices; if (h) { e.vertices || (e.vertices = { rawPosition: [], positions: [], indexes: h.indexes, uv: h.uv, nuv: h.nuv, minPos: Qn(h.minPos.x, h.minPos.y, h.minPos.z), maxPos: Qn(h.maxPos.x, h.maxPos.y, h.maxPos.z) }), e.vertices.rawPosition.length = 0; for (var c = h.rawPosition, l = 0; l < c.length; l += 3)e.vertices.rawPosition.push(Qn(c[l], c[l + 1], c[l + 2])); e._updateMeshVertices() } }, i.clone = function () { var t, i, n, r, s, a = this, o = new e, u = a.vertices; return o.vertices = u ? { rawPosition: u.rawPosition.slice(0), positions: u.positions.slice(0), indexes: u.indexes.slice(0), uv: u.uv.slice(0), nuv: u.nuv.slice(0), minPos: u.minPos.clone(), maxPos: u.maxPos.clone() } : null, (t = o.uv).splice.apply(t, [0, o.uv.length].concat(a.uv)), (i = o.unbiasUV).splice.apply(i, [0, o.unbiasUV.length].concat(a.unbiasUV)), (n = o.uvSliced).splice.apply(n, [0, o.uvSliced.length].concat(a.uvSliced)), o._rect.set(a._rect), o._trimmedBorder.set(a._trimmedBorder), o._offset.set(a._offset), o._originalSize.set(a._originalSize), o._rotated = a._rotated, (r = o._capInsets).splice.apply(r, [0, o._capInsets.length].concat(a._capInsets)), o._atlasUuid = a._atlasUuid, o._texture = a._texture, o._isFlipUVX = a._isFlipUVX, o._isFlipUVY = a._isFlipUVY, a._original ? o._original = { _texture: a._original._texture, _x: a._original._x, _y: a._original._y } : o._original = null, o._packable = a._packable, o._pixelsToUnit = a._pixelsToUnit, o._pivot.set(a._pivot), o._meshType = a._meshType, o._extrude = a._extrude, (s = o._customOutLine).splice.apply(s, [0, o._customOutLine.length].concat(a._customOutLine)), o._minPos = a._minPos, o._maxPos = a._maxPos, a._mesh && o._createMesh(), o }, i._refreshTexture = function (t) { var e = this; e._texture = t; var i = e._texture, n = {}, r = !1; 0 !== e._rect.width && 0 !== e._rect.height && e.checkRect(i) || (n.rect = ds(0, 0, i.width, i.height), r = !0), (0 === e._originalSize.width || 0 === e._originalSize.height || r) && (n.originalSize = hs(i.width, i.height), r = !0), r && e.reset(n), e._checkPackable(), e._mesh && e._updateMesh() }, i.onLoaded = function () { this._calcTrimmedBorder() }, i.initDefault = function (e) { t.prototype.initDefault.call(this, e); var i = new bv; i.initDefault(), this._refreshTexture(i), this._calculateUV() }, i.validate = function () { return this._texture && this._rect && 0 !== this._rect.width && 0 !== this._rect.height }, i._initVertices = function () { var t = this; if (t.vertices) { var e = t.vertices; e.rawPosition.length = 0, e.positions.length = 0, e.indexes.length = 0, e.uv.length = 0, e.nuv.length = 0, e.minPos.set(0, 0, 0), e.maxPos.set(0, 0, 0) } else t.vertices = { rawPosition: [], positions: [], indexes: [], uv: [], nuv: [], minPos: Qn(), maxPos: Qn() }; var i = t.vertices; if (1 === t._meshType); else { var n = t.texture, r = n.width, s = n.height, a = t.rect, o = a.width, u = a.height, h = a.x, c = s - a.y - u, l = o / 2, f = u / 2, d = 0 === r ? 0 : h / r, p = 0 === r ? 1 : (h + o) / r, _ = 0 === s ? 1 : (c + u) / s, g = 0 === s ? 0 : c / s, m = i.uv, v = i.nuv, y = i.rawPosition, b = i.indexes; dO.set(-l, -f, 0), y.push(dO.clone()), m.push(h, c + u), v.push(d, g), i.minPos.set(dO), dO.set(l, -f, 0), y.push(dO.clone()), m.push(h + o, c + u), v.push(p, g), dO.set(-l, f, 0), y.push(dO.clone()), m.push(h, c), v.push(d, _), dO.set(l, f, 0), y.push(dO.clone()), m.push(h + o, c), v.push(p, _), i.maxPos.set(dO), b.push(0, 1, 2, 2, 1, 3) } this._updateMeshVertices() }, i._updateMeshVertices = function () { pO.identity(); var t = 1 / this._pixelsToUnit, e = Qn(-(this._pivot.x - .5) * this.rect.width * t, -(this._pivot.y - .5) * this.rect.height * t, 0); pO.transform(e), e.set(t, t, 1), pO.scale(e); for (var i = this.vertices, n = 0; n < i.rawPosition.length; n++) { var r = i.rawPosition[n]; _O(e, r, pO), gO(i.positions, e, 3 * n) } _O(this._minPos, i.minPos, pO), _O(this._maxPos, i.maxPos, pO) }, i._createMesh = function () { this._mesh = hO({ primitiveMode: 7, positions: this.vertices.positions, uvs: this.vertices.nuv, indices: this.vertices.indexes, minPos: this._minPos, maxPos: this._maxPos, attributes: [new pp("a_position", 32), new pp("a_texCoord", 21)] }) }, i._updateMesh = function () { this._mesh && this._mesh.destroy(), this._initVertices(), this._createMesh() }, n(e, [{ key: "insetTop", get: function () { return this._capInsets[1] }, set: function (t) { this._capInsets[1] !== t && (this._capInsets[1] = t, this._texture && this._calculateSlicedUV()) } }, { key: "insetBottom", get: function () { return this._capInsets[3] }, set: function (t) { this._capInsets[3] !== t && (this._capInsets[3] = t, this._texture && this._calculateSlicedUV()) } }, { key: "insetLeft", get: function () { return this._capInsets[0] }, set: function (t) { this._capInsets[0] !== t && (this._capInsets[0] = t, this._texture && this._calculateSlicedUV()) } }, { key: "insetRight", get: function () { return this._capInsets[2] }, set: function (t) { this._capInsets[2] !== t && (this._capInsets[2] = t, this._texture && this._calculateSlicedUV()) } }, { key: "rect", get: function () { return this._rect }, set: function (t) { this._rect.equals(t) || (this._rect.set(t), this._texture && this._calculateUV(), this._calcTrimmedBorder()) } }, { key: "originalSize", get: function () { return this._originalSize }, set: function (t) { this._originalSize.equals(t) || (this._originalSize.set(t), this._texture && this._calculateUV(), this._calcTrimmedBorder()) } }, { key: "offset", get: function () { return this._offset }, set: function (t) { this._offset.set(t), this._calcTrimmedBorder() } }, { key: "rotated", get: function () { return this._rotated }, set: function (t) { this._rotated !== t && (this._rotated = t, this._texture && this._calculateUV()) } }, { key: "texture", get: function () { return this._texture }, set: function (t) { t ? t !== this._texture && this.reset({ texture: t }, !0) : it(3122, this.name) } }, { key: "atlasUuid", get: function () { return this._atlasUuid }, set: function (t) { this._atlasUuid = t } }, { key: "width", get: function () { return this._texture.width } }, { key: "height", get: function () { return this._texture.height } }, { key: "_textureSource", set: function (t) { globalThis.Build ? this._texture = t : t && (this._refreshTexture(t), this._calculateUV()) } }, { key: "flipUVX", get: function () { return this._isFlipUVX }, set: function (t) { this._isFlipUVX = t, this._calculateUV() } }, { key: "flipUVY", get: function () { return this._isFlipUVY }, set: function (t) { this._isFlipUVY = t, this._calculateUV() } }, { key: "packable", get: function () { return this._packable }, set: function (t) { this._packable = t } }, { key: "original", get: function () { return this._original } }, { key: "pixelsToUnit", get: function () { return this._pixelsToUnit } }, { key: "pivot", get: function () { return this._pivot } }, { key: "mesh", get: function () { return this._mesh } }, { key: "trimmedBorder", get: function () { return this._trimmedBorder } }]), e }(pg), aO.EVENT_UV_UPDATED = "uv_updated", aO.MeshType = { RECT: 0, POLYGON: 1 }, sO = aO)) || sO)); S.SpriteFrame = vO; var yO, bO = t("SpriteAtlas", Gu("cc.SpriteAtlas")((lO = function (t) { function e(e) { var i; return (i = t.call(this, e) || this).spriteFrames = fO && fO(), i } s(e, t); var i = e.prototype; return i.getTexture = function () { var t = Object.keys(this.spriteFrames); if (t.length > 0) { var e = this.spriteFrames[t[0]]; return e && e.texture } return null }, i.getSpriteFrame = function (t) { var e = this.spriteFrames[t]; return e ? (e.name || (e.name = t), e) : null }, i.getSpriteFrames = function () { var t = [], e = this.spriteFrames; for (var i in e) t.push(e[i]); return t }, i._serialize = function () { return null }, i._deserialize = function (t, e) { var i = t; this._name = i.name; var n = i.spriteFrames; this.spriteFrames = Nt(); for (var r = 0; r < n.length; r += 2)e.result.push(this.spriteFrames, n[r], n[r + 1], fe(vO)) }, e }(pg), fO = Bu(lO.prototype, "spriteFrames", [eh], (function () { return Nt() })), cO = lO)) || cO); S.SpriteAtlas = bO; var wO, xO, SO, TO = t("Font", Gu("cc.Font")(yO = function (t) { function e(e) { return t.call(this, e) || this } return s(e, t), e }(pg)) || yO); S.Font = TO; var IO = t("TTFFont", Gu("cc.TTFFont")((xO = function (t) { function e() { var e; return (e = t.call(this) || this)._fontFamily = SO && SO(), e } return s(e, t), e.prototype.initDefault = function (e) { this._fontFamily = "Arial", t.prototype.initDefault.call(this, e) }, n(e, [{ key: "_nativeAsset", get: function () { return this._fontFamily }, set: function (t) { this._fontFamily = t || "Arial" } }, { key: "_nativeDep", get: function () { return { uuid: this._uuid, __nativeName__: this._native, ext: Lo(this._native), __isNative__: !0 } } }]), e }(TO), SO = Bu(xO.prototype, "_fontFamily", [eh], (function () { return null })), m(xO.prototype, "_nativeAsset", [Oh, Th], Object.getOwnPropertyDescriptor(xO.prototype, "_nativeAsset"), xO.prototype), m(xO.prototype, "_nativeDep", [Oh], Object.getOwnPropertyDescriptor(xO.prototype, "_nativeDep"), xO.prototype), wO = xO)) || wO); S.TTFFont = IO; var EO = {}, AO = t("BASELINE_RATIO", .26), CO = 0, DO = t("MIDDLE_RATIO", (AO + 1) / 2 - AO); function RO() { return CO } var PO = new de(2); PO.get = function () { return this._get() || { key: "", value: 0, prev: null, next: null } }; var BO = t("LRUCache", function () { function t(t) { this.count = 0, this.limit = 0, this.datas = {}, this.head = null, this.tail = null, this.limit = t } var e = t.prototype; return e.moveToHead = function (t) { t.next = this.head, t.prev = null, this.head && (this.head.prev = t), this.head = t, this.tail || (this.tail = t), this.count++, this.datas[t.key] = t }, e.put = function (t, e) { var i = PO.get(); if (i.key = t, i.value = e, this.count >= this.limit) { var n = this.tail; delete this.datas[n.key], this.count--, this.tail = n.prev, this.tail.next = null, n.prev = null, n.next = null, PO.put(n) } this.moveToHead(i) }, e.remove = function (t) { t.prev ? t.prev.next = t.next : this.head = t.next, t.next ? t.next.prev = t.prev : this.tail = t.prev, delete this.datas[t.key], this.count-- }, e.get = function (t) { var e = this.datas[t]; return e ? (this.remove(e), this.moveToHead(e), e.value) : null }, e.clear = function () { this.count = 0, this.datas = {}, this.head = null, this.tail = null }, e.has = function (t) { return !!this.datas[t] }, e.delete = function (t) { var e = this.datas[t]; this.remove(e) }, t }()), MO = new BO(100), OO = /([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûа-яА-ЯЁё]+|\S)/, LO = /^[!,.:;'}\]%\?>、‘“》？。，！]/, FO = "[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁёáàảạãăắằẳẵặâấầẩẫậéèẻẽẹêếềểễệiíìỉĩịóòỏõọôốồổỗộơớờởỡợúùủũụưứừửữựýỳỷỹỵđÁÀẢẠÃĂẮẰẲẴẶÂẤẦẨẪẬÉÈẺẼẸÊẾỀỂỄỆIÍÌỈĨỊÓÒỎÕỌÔỐỒỔỖỘƠỚỜỞỠỢÚÙỦŨỤƯỨỪỬỮỰÝỲỶỸỴĐ]", kO = new RegExp("(" + FO + "+|\\S)$"), NO = new RegExp(FO + "+$"), zO = new RegExp("^" + FO); function UO(t) { return /^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(t) || /[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(t) || /^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(t) } function VO(t) { var e = t.charCodeAt(0); return e >= 9 && e <= 13 || 32 === e || 133 === e || 160 === e || 5760 === e || e >= 8192 && e <= 8202 || 8232 === e || 8233 === e || 8239 === e || 8287 === e || 12288 === e } function GO(t, e, i) { var n = (i || t.font) + "🎮" + e, r = MO.get(n); if (null !== r) return r; var s = t.measureText(e), a = s && s.width || 0; return MO.put(n, a), a } function HO(t) { for (var e = t.length, i = 0, n = 0, r = 0; r < e; r++)8205 !== (n = t.charCodeAt(r)) && (n >= 55296 && n <= 56319 && (n = t.charCodeAt(r + 1)) >= 56320 && n <= 57343 ? ((r + 2 >= e || 8205 !== t.charCodeAt(r + 2)) && i++, r++) : i++); return i } function WO(t, e) { for (var i = t.length, n = 0, r = 0, s = 0, a = 0, o = 0; o < i; o++)if (8205 !== (a = t.charCodeAt(o))) if (a >= 55296 && a <= 56319 && (n++, (a = t.charCodeAt(o + 1)) >= 56320 && a <= 57343)) { if (n++, o + 2 >= i || 8205 !== t.charCodeAt(o + 2)) { if (e === r) return t.slice(s, s + n); s += n, r++, n = 0 } o++ } else { if (e === r) return t.charAt(o); s = o + 1, r++, n = 0 } else n++; return "" } function jO(t, e) { var i = WO(t, e); if (1 === i.length) return "" + i.charCodeAt(0); for (var n = "", r = 0; r < i.length; r++)n += "" + i.charCodeAt(r); return "" + n } function XO(t, e) { if (e >= t.length) return t.length; for (var i = e, n = t[i]; i >= 0 && ("‍" === n && (n = t[--i]), n >= "\udc00" && n <= "\udfff" && i - 1 >= 0 && (n = t[--i]), n >= "\ud800" && n <= "\udbff") && i - 1 >= 0 && "‍" === t[i - 1];)n = t[--i]; return i } function qO(t, e) { for (var i = e, n = e, r = t[n]; n < t.length;)if ("‍" === r && (i++, (r = t[++n]) >= "\ud800" && r <= "\udbff" && (i++, r = t[++n])), r >= "\ud800" && r <= "\udbff") i++, r = t[++n]; else { if (!(r >= "\udc00" && r <= "\udfff")) break; if (r = t[++n], !(n < t.length && "‍" === t[n])) break; i++, r = t[n] } return i } function YO(t, e, i) { var n = XO(t, e); n < e && (n = qO(t, e) + 1); var r = i; if (void 0 !== i) { r = qO(t, i = Math.max(0, i - 1)); var s = XO(t, i); s < n || s === n && e > n ? r = n : r += 1 } return t.substring(n, r) } function KO(t) { return zO.exec(t) } function QO(t) { return NO.exec(t) } function ZO(t, e, i, n) { var r = []; if (0 === t.length || i < 0) return r.push(""), r; for (var s = t; e > i && s.length > 1;) { for (var a = s.length * (i / e) | 0, o = YO(s, a), u = e - n(o), h = o, c = 0, l = 0; u > i && l++ < 100;)a *= i / u, u = e - n(o = YO(s, a |= 0)); for (l = 0; o && u <= i && l++ < 100;) { var f = OO.exec(o); h = o, u = e - n(o = YO(s, a += c = f ? f[0].length : 1)) } 0 == (a -= c) ? (a = 1, h = YO(s, 1)) : 1 === a && s[0] >= "\ud800" && s[0] <= "\udbff" && (a = 2, h = YO(s, 2)); var d = YO(s, 0, a), p = void 0; LO.test(h || o) && (0 == (a -= (p = kO.exec(d)) ? p[0].length : 0) && (a = 1), h = YO(s, a), d = YO(s, 0, a)), zO.test(h) && (p = NO.exec(d)) && d !== p[0] && (h = YO(s, a -= p[0].length), d = YO(s, 0, a)), (0 === r.length || (d = d.trim()).length > 0) && r.push(d), e = n(s = h || o) } return (0 === r.length || (s = s.trim()).length > 0) && r.push(s), r } var JO, $O = E.document, tL = null, eL = -1, iL = "BES bswy:->@123丁ぁᄁ", nL = Object.create(null), rL = [], sL = 3e3, aL = function () { if (void 0 === JO) if ("FontFace" in E) { var t = /Gecko.*Firefox\/(\d+)/.exec(E.navigator.userAgent), e = /OS X.*Version\/10\..*Safari/.exec(E.navigator.userAgent) && /Apple/.exec(E.navigator.vendor); JO = t ? parseInt(t[1], 10) > 42 : !e } else JO = !1; return JO }; function oL() { for (var t = !0, e = Date.now(), i = rL.length - 1; i >= 0; i--) { var n = rL[i], r = n.fontFamilyName; if (e - n.startTime > sL) it(4933, r), n.onComplete(null, r), rL.splice(i, 1); else { var s = n.refWidth, a = "40px " + r; tL.font = a, s !== GO(tL, iL, a) ? (rL.splice(i, 1), n.onComplete(null, r)) : t = !1 } } t && (clearInterval(eL), eL = -1) } function uL(t, e, i) { var n = new Promise((function (i, n) { !function r() { Date.now() - t >= sL ? n() : $O.fonts.load("40px " + e).then((function (t) { t.length >= 1 ? i() : setTimeout(r, 100) }), (function () { n() })) }() })), r = null, s = new Promise((function (t, e) { r = setTimeout(e, sL) })); Promise.race([s, n]).then((function () { r && (clearTimeout(r), r = null), i(null, e) }), (function () { it(4933, e), i(null, e) })) } function hL(t, e, i) { var n = cL(t); if (nL[n]) i(null, n); else { if (!tL) { var r = $O.createElement("canvas"); r.width = 100, r.height = 100, tL = r.getContext("2d") } var s = "40px " + n, a = $O.createElement("style"); a.type = "text/css"; var o = ""; Number.isNaN(n) ? o += "@font-face { font-family:" + n + "; src:" : o += '@font-face { font-family:"' + n + '"; src:', o += 'url("' + t + '");', a.textContent = o + "}", $O.body.appendChild(a); var u = $O.createElement("div"), h = u.style; if (h.fontFamily = n, u.innerHTML = ".", h.position = "absolute", h.left = "-100px", h.top = "-100px", $O.body.appendChild(u), aL()) uL(Date.now(), n, i); else { var c = { fontFamilyName: n, refWidth: GO(tL, iL, s), onComplete: i, startTime: Date.now() }; rL.push(c), -1 === eL && (eL = setInterval(oL, 100)) } nL[n] = a } } function cL(t) { var e = t.lastIndexOf(".ttf"); if (-1 === e) return t; var i, n = t.lastIndexOf("/"); return -1 !== (i = -1 === n ? t.substring(0, e) + "_LABEL" : t.substring(n + 1, e) + "_LABEL").indexOf(" ") && (i = '"' + i + '"'), i } function lL(t, e, i, n) { var r = new IO; r._nativeUrl = t, r._nativeAsset = e, n(null, r) } hS.register({ ".font": hL, ".eot": hL, ".ttf": hL, ".woff": hL, ".svg": hL, ".ttc": hL }), xS.register({ ".font": lL, ".eot": lL, ".ttf": lL, ".woff": lL, ".svg": lL, ".ttc": lL }); var fL, dL, pL, _L, gL, mL, vL, yL, bL, wL = /^(click)(\s)*=|(param)(\s)*=/, xL = /(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*align(\s)*=|(\s)*offset(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/, SL = t("HtmlTextParser", function () { function t() { this._specialSymbolArray = [], this._stack = [], this._resultObjectArray = [], this._specialSymbolArray.push([/&lt;/g, "<"]), this._specialSymbolArray.push([/&gt;/g, ">"]), this._specialSymbolArray.push([/&amp;/g, "&"]), this._specialSymbolArray.push([/&quot;/g, '"']), this._specialSymbolArray.push([/&apos;/g, "'"]) } var e = t.prototype; return e.parse = function (t) { this._resultObjectArray.length = 0, this._stack.length = 0; for (var e = 0, i = t.length; e < i;) { var n = t.indexOf(">", e), r = -1; if (n >= 0 && (r = t.lastIndexOf("<", n)) < e - 1 && (r = t.indexOf("<", n + 1), n = t.indexOf(">", r + 1)), r < 0) this._stack.pop(), this._processResult(t.substring(e)), e = i; else { var s = t.substring(e, r), a = t.substring(r + 1, n); "" === a && (s = t.substring(e, n + 1)), this._processResult(s), -1 === n ? n = r : "/" === t.charAt(r + 1) ? this._stack.pop() : this._addToStack(a), e = n + 1 } } return this._resultObjectArray }, e._attributeToObject = function (t) { t = t.trim(); var e = {}, i = /^(color|size)(\s)*=/.exec(t), n = "", r = 0, s = ""; if (i) { if (n = i[0], "" === (t = t.substring(n.length).trim())) return e; switch (r = t.indexOf(" "), n[0]) { case "c": e.color = r > -1 ? t.substring(0, r).trim() : t; break; case "s": e.size = parseInt(t) }return r > -1 && (s = t.substring(r + 1).trim(), e.event = this._processEventHandler(s)), e } if ((i = /^(br(\s)*\/)/.exec(t)) && i[0].length > 0 && (n = i[0].trim()).startsWith("br") && "/" === n[n.length - 1]) return e.isNewLine = !0, this._resultObjectArray.push({ text: "", style: { isNewLine: !0 } }), e; var a = "", o = -1; if ((i = /^(img(\s)*src(\s)*=[^>]+\/)/.exec(t)) && i[0].length > 0 && (n = i[0].trim()).startsWith("img") && "/" === n[n.length - 1]) { var u; i = xL.exec(t); for (var h = !1; i;) { var c = (n = (t = t.substring(t.indexOf(i[0]))).substring(0, i[0].length)).length; if (n = (n = n.replace(/[^a-zA-Z]/g, "").trim()).toLowerCase(), a = t.substring(c).trim(), o = "src" === n ? this.getRightQuotationIndex(a) : -1, u = (r = a.indexOf(" ", o + 1 >= a.length ? -1 : o + 1)) > -1 ? a.substring(0, r) : a, t = a.substring(r).trim(), u.endsWith("/") && (u = u.slice(0, -1)), "src" === n) { switch (u.charCodeAt(0)) { case 34: case 39: h = !0, u = u.slice(1, -1) }e.isImage = !0, e.src = u } else if ("height" === n) e.imageHeight = parseInt(u); else if ("width" === n) e.imageWidth = parseInt(u); else if ("align" === n) { switch (u.charCodeAt(0)) { case 34: case 39: u = u.slice(1, -1) }e.imageAlign = u.toLowerCase() } else "offset" === n ? e.imageOffset = u : "click" === n && (e.event = this._processEventHandler(n + "=" + u)); e.event && "param" === n && (e.event[n] = u.replace(/^"|"$/g, "")), i = xL.exec(t) } return h && e.isImage && this._resultObjectArray.push({ text: "", style: e }), {} } if (i = /^(outline(\s)*[^>]*)/.exec(t)) { var l = { color: "#ffffff", width: 1 }; if (t = i[0].substring(7).trim()) { var f, d = /(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/; for (i = d.exec(t); i;)n = (t = t.substring(t.indexOf(i[0]))).substring(0, i[0].length), f = (r = (a = t.substring(n.length).trim()).indexOf(" ")) > -1 ? a.substring(0, r) : a, n = (n = n.replace(/[^a-zA-Z]/g, "").trim()).toLowerCase(), t = a.substring(r).trim(), "click" === n ? e.event = this._processEventHandler(n + "=" + f) : "color" === n ? l.color = f : "width" === n && (l.width = parseInt(f)), e.event && "param" === n && (e.event[n] = f.replace(/^"|"$/g, "")), i = d.exec(t) } e.outline = l } if ((i = /^(on|u|b|i)(\s)*/.exec(t)) && i[0].length > 0) { switch (n = i[0], t = t.substring(n.length).trim(), n[0]) { case "u": e.underline = !0; break; case "i": e.italic = !0; break; case "b": e.bold = !0 }if ("" === t) return e; e.event = this._processEventHandler(t) } return e }, e.getRightQuotationIndex = function (t) { var e = -1, i = -1, n = t.indexOf("'"), r = t.indexOf('"'), s = r > -1 && (r < n || -1 === n); return n > -1 && (n < r || -1 === r) ? (e = n, i = t.indexOf("'", e + 1 >= t.length ? -1 : e + 1)) : s && (e = r, i = t.indexOf('"', e + 1 >= t.length ? -1 : e + 1)), i }, e._processEventHandler = function (t) { for (var e = {}, i = 0, n = !1, r = wL.exec(t); r;) { var s = r[0], a = ""; if (n = !1, '"' === (t = t.substring(s.length).trim()).charAt(0)) (i = t.indexOf('"', 1)) > -1 && (a = t.substring(1, i).trim(), n = !0), i++; else if ("'" === t.charAt(0)) (i = t.indexOf("'", 1)) > -1 && (a = t.substring(1, i).trim(), n = !0), i++; else { var o = /(\S)+/.exec(t); i = (a = o ? o[0] : "").length } n && (e[s = s.substring(0, s.length - 1).trim()] = a), t = t.substring(i).trim(), r = wL.exec(t) } return e }, e._addToStack = function (t) { var e = this._attributeToObject(t); if (0 === this._stack.length) this._stack.push(e); else { if (e.isNewLine || e.isImage) return; var i = this._stack[this._stack.length - 1]; for (var n in i) e[n] || (e[n] = i[n]); this._stack.push(e) } }, e._processResult = function (t) { 0 !== t.length && (t = this._escapeSpecialSymbol(t), this._stack.length > 0 ? this._resultObjectArray.push({ text: t, style: this._stack[this._stack.length - 1] }) : this._resultObjectArray.push({ text: t })) }, e._escapeSpecialSymbol = function (t) { for (var e, i = p(this._specialSymbolArray); !(e = i()).done;) { var n = e.value, r = n[0], s = n[1]; t = t.replace(r, s) } return t }, t }()), TL = function () { this.u = 0, this.v = 0, this.w = 0, this.h = 0, this.offsetX = 0, this.offsetY = 0, this.valid = !1, this.xAdvance = 0 }, IL = function () { function t(t) { this.letterDefinitions = {}, this._texture = null, this.texture = t } var e = t.prototype; return e.addLetterDefinitions = function (t, e) { this.letterDefinitions[t] = e }, e.cloneLetterDefinition = function () { var t = {}; for (var e in this.letterDefinitions) { var i = new TL; Kt(i, this.letterDefinitions[e]), t[e] = i } return t }, e.getTexture = function () { return this._texture }, e.getLetter = function (t) { return this.letterDefinitions[t] }, e.getLetterDefinitionForChar = function (t) { var e = jO(t, 0), i = null; return Object.prototype.hasOwnProperty.call(this.letterDefinitions, e) && (i = this.letterDefinitions[e]), i }, e.clear = function () { this.letterDefinitions = {} }, n(t, [{ key: "texture", get: function () { return this._texture }, set: function (t) { var e = this._texture; e !== t && (e && (e.decRef(!1), e.refCount <= 0 && e.destroy()), t && t.addRef(), this._texture = t) } }]), t }(), EL = t("BitmapFont", (fL = Gu("cc.BitmapFont"), dL = Ih(vO), fL((_L = function (t) { function e() { var e; return (e = t.call(this) || this).fntDataStr = gL && gL(), e.spriteFrame = mL && mL(), e.fontSize = vL && vL(), e.fntConfig = yL && yL(), e } return s(e, t), e.prototype.onLoaded = function () { var t = this.spriteFrame; !this.fontDefDictionary && t && (this.fontDefDictionary = new IL(t.texture)); var e = this.fntConfig; if (e) { var i = e.fontDefDictionary; for (var n in i) { var r = i[n], s = new TL, a = r.rect; s.offsetX = r.xOffset, s.offsetY = r.yOffset, s.w = a.width, s.h = a.height, s.u = a.x, s.v = a.y, s.valid = !0, s.xAdvance = r.xAdvance, this.fontDefDictionary.addLetterDefinitions(n, s) } } else it(16376) }, e }(TO), gL = Bu(_L.prototype, "fntDataStr", [eh], (function () { return "" })), mL = Bu(_L.prototype, "spriteFrame", [dL], (function () { return null })), vL = Bu(_L.prototype, "fontSize", [eh], (function () { return -1 })), yL = Bu(_L.prototype, "fntConfig", [eh], (function () { return null })), pL = _L)) || pL)); S.BitmapFont = EL; var AL, CL = t("LabelAtlas", Gu("cc.LabelAtlas")(bL = function (t) { function e() { return t.apply(this, arguments) || this } return s(e, t), e }(EL)) || bL); S.LabelAtlas = CL; var DL = function () { function t() { this.pool = [] } t.getInstance = function () { return AL || (AL = new t), AL }; var e = t.prototype; return e.get = function () { var t = this.pool.pop(); if (!t) { var e = E.document.createElement("canvas"), i = e.getContext("2d"); t = { canvas: e, context: i } } return t }, e.put = function (t) { this.pool.length >= Le.MAX_LABEL_CANVAS_POOL_SIZE || this.pool.push(t) }, t }(), RL = rr.WHITE.clone(), PL = "rgba(255, 255, 255, " + (1 / 255).toFixed(3) + ")", BL = RO(), ML = function () { function t(t, e) { this.image = null, this.data = null, this.canvas = null, this.context = null, this.width = 0, this.height = 0, this.offsetY = 0, this.char = t, this.labelInfo = e, this.hash = "" + jO(t, 0) + e.hash } var e = t.prototype; return e.updateRenderData = function () { this._updateProperties(), this._updateTexture() }, e.destroy = function () { this.image = null, DL.getInstance().put(this.data), this.data = null }, e._updateProperties = function () { if (this.data = DL.getInstance().get(), this.canvas = this.data.canvas, this.context = this.data.context, this.context) { var t = this.labelInfo.fontScale; this.context.font = this.labelInfo.fontDesc; var e = GO(this.context, this.char, this.labelInfo.fontDesc), i = 2 * this.labelInfo.margin + 2; this.width = parseFloat(e.toFixed(2)) * t + i, this.height = (1 + AO) * this.labelInfo.fontSize * t + i, this.offsetY = -this.labelInfo.fontSize * AO * t / 2 } this.canvas.width !== this.width && (this.canvas.width = this.width), this.canvas.height !== this.height && (this.canvas.height = this.height), this.image || (this.image = new Pg), this.image.reset(this.canvas) }, e._updateTexture = function () { if (this.context && this.canvas) { var t = this.context, e = this.labelInfo, i = this.canvas.width, n = this.canvas.height, r = e.fontScale; t.textAlign = "center", t.textBaseline = "alphabetic", t.clearRect(0, 0, i, n), t.fillStyle = PL, t.fillRect(0, 0, i, n), t.font = e.fontDesc.replace(/(\d+)(\.\d+)?(px|em|rem|pt)/g, (function (t, e, i, n) { return (+e * r + (+i || 0) * r).toString() + n })); var s = e.fontSize * r, a = i / 2, o = n / 2 + s * DO + s * BL, u = e.color; if (t.lineJoin = "round", t.fillStyle = "rgba(" + u.r + ", " + u.g + ", " + u.b + ", 1)", e.isOutlined) { var h = e.out || RL; t.strokeStyle = "rgba(" + h.r + ", " + h.g + ", " + h.b + ", " + h.a / 255 + ")", t.lineWidth = 2 * e.margin * r, t.strokeText(this.char, a, o) } t.fillText(this.char, a, o) } }, t }(), OL = function (t) { function e() { return t.apply(this, arguments) || this } s(e, t); var i = e.prototype; return i.initWithSize = function (t, e, i) { void 0 === i && (i = 35), this.reset({ width: t, height: e, format: i }) }, i.drawTextureAt = function (t, e, i) { var n = this.getGFXTexture(); if (t && n) { var r = this._getGFXDevice(); if (r) { var s = new Wd; s.texOffset.x = e, s.texOffset.y = i, s.texExtent.width = t.width, s.texExtent.height = t.height, r.copyTexImagesToTexture([t.data], n, [s]) } else it(16363) } }, e }(bv), LL = function () { function t(t, e) { this._x = 0, this._y = 0, this._nextY = 0, this._width = 0, this._height = 0, this._halfBleed = 0, this._dirty = !1; var i = new OL; i.initWithSize(t, e), this.fontDefDictionary = new IL(i), this._halfBleed = 1, this._width = t, this._height = e, yB.on("director_before_scene_launch", this.beforeSceneLoad, this) } var e = t.prototype; return e.insertLetterTexture = function (t) { var e = t.image, i = yB.root.device; if (!e || !this.fontDefDictionary || !i) return null; var n = e.width, r = e.height; if (this._x + n + 0 > this._width && (this._x = 0, this._y = this._nextY), this._y + r > this._nextY && (this._nextY = this._y + r + 0), this._nextY > this._height) return it(12100), null; if (!this.fontDefDictionary.texture) return null; this.fontDefDictionary.texture.drawTextureAt(e, this._x, this._y), this._dirty = !0; var s = new TL; return s.u = this._x + this._halfBleed, s.v = this._y + this._halfBleed, s.valid = !0, s.w = t.width - 2, s.h = t.height - 2, s.xAdvance = s.w, s.offsetY = t.offsetY, this._x += n + 0, this.fontDefDictionary.addLetterDefinitions(t.hash, s), s }, e.update = function () { this._dirty && (this._dirty = !1) }, e.reset = function () { this._x = 0, this._y = 0, this._nextY = 0, this.fontDefDictionary.clear() }, e.destroy = function () { this.reset(); var t = this.fontDefDictionary; t && t.texture && (t.texture = null) }, e.getTexture = function () { return this.fontDefDictionary.getTexture() }, e.beforeSceneLoad = function () { this.clearAllCache() }, e.clearAllCache = function () { this.destroy(); var t = new OL; t.initWithSize(this._width, this._height), this.fontDefDictionary.texture = t }, e.getLetter = function (t) { return this.fontDefDictionary.letterDefinitions[t] }, e.getLetterDefinitionForChar = function (t, e) { var i = jO(t, 0) + e.hash, n = this.fontDefDictionary.letterDefinitions[i]; if (!n) { var r = new ML(t, e); r.updateRenderData(), n = this.insertLetterTexture(r), r.destroy() } return n }, n(t, [{ key: "width", get: function () { return this._width } }, { key: "height", get: function () { return this._height } }]), t }(), FL = { fontAtlas: null, fontSize: 0, lineHeight: 0, hAlign: 0, vAlign: 0, hash: "", fontFamily: "", fontDesc: "Arial", color: rr.WHITE.clone(), isOutlined: !1, out: rr.WHITE.clone(), margin: 0, fontScale: 1 }; function kL(t) { var e = t.color.toHEX(), i = ""; return t.isOutlined && t.margin > 0 && (i = i + t.margin + t.out.toHEX()), "" + t.fontSize + t.fontFamily + e + i } var NL = "a_position", zL = "a_color", UL = "a_texCoord", VL = "a_color2", GL = [new pp(NL, 32)], HL = [new pp(NL, 32), new pp(zL, 44)], WL = [new pp(NL, 32), new pp(UL, 21), new pp(zL, 44)], jL = [new pp(NL, 32), new pp(UL, 21), new pp(zL, 35, !0)], XL = [new pp(NL, 32), new pp(UL, 21), new pp(zL, 44), new pp(VL, 44)], qL = [new pp(NL, 32), new pp(UL, 21), new pp(zL, 35, !0), new pp(VL, 35, !0)]; function YL(t) { for (var e = 0, i = 0; i < t.length; i++) { var n = t[i]; e += Wp[n.format].count } return e } function KL(t) { for (var e = 0, i = 0; i < t.length; i++) { var n = t[i]; e += Wp[n.format].size } return e } S.internal.vfmtPosUvColor = WL, S.internal.vfmtPosUvTwoColor = XL, S.internal.vfmtPosUvColor4B = jL, S.internal.vfmtPosUvTwoColor4B = qL, t("UIVertexFormat", Object.freeze({ __proto__: null, getAttributeStride: KL, getComponentPerVertex: YL, vfmt: GL, vfmtPosColor: HL, vfmtPosUvColor: WL, vfmtPosUvColor4B: jL, vfmtPosUvTwoColor: XL, vfmtPosUvTwoColor4B: qL })); var QL = t("MeshBuffer", function () { var t = e.prototype; function e() { this._byteOffset = 0, this._vertexOffset = 0, this._indexOffset = 0, this._dirty = !1, this._floatsPerVertex = 0, this._vData = null, this._iData = null, this._vertexFormatBytes = 0, this._initVDataCount = 0, this._initIDataCount = 0, this._attributes = null, this._iaPool = [], this._iaInfo = null, this._nextFreeIAHandle = 0, this.initSharedBuffer(), this.syncSharedBufferToNative() } return t.initSharedBuffer = function () { }, t.syncSharedBufferToNative = function () { }, t.initialize = function (t, e, i, n) { this._initVDataCount = i, this._initIDataCount = n, this._attributes = e, this.floatsPerVertex = KL(e) >> 2, this._initVDataCount, this._floatsPerVertex, ut(9005), this.vData && this.iData || (this.vData = new Float32Array(this._initVDataCount), this.iData = new Uint16Array(this._initIDataCount)), this._iaPool.push(this.createNewIA(t)) }, t.reset = function () { this._nextFreeIAHandle = 0, this.dirty = !1 }, t.destroy = function () { this.reset(), this._attributes = null, this._iaInfo = null, this.vData = null, this.iData = null; for (var t = 0; t < this._iaPool.length; ++t) { var e = this._iaPool[t], i = e.vertexBuffers[0]; i && i.destroy(); var n = e.indexBuffer; n && n.destroy(), e.ia.destroy() } this._iaPool.length = 0 }, t.setDirty = function () { this.dirty = !0 }, t.request = function () { return it(9002), !1 }, t.requireFreeIA = function (t) { return this._iaPool.length <= this._nextFreeIAHandle && this._iaPool.push(this.createNewIA(t)), this._iaPool[this._nextFreeIAHandle++].ia }, t.recycleIA = function (t) { for (var e = this._iaPool, i = 0; i < this._nextFreeIAHandle; ++i)if (t === e[i].ia) { var n = e[i]; return e[i] = e[--this._nextFreeIAHandle], void (e[this._nextFreeIAHandle] = n) } }, t.checkCapacity = function (t, e) { var i = (this.vertexOffset + t) * this._floatsPerVertex, n = this.indexOffset + e; return !(i > this._initVDataCount || n > this._initIDataCount) }, t.uploadBuffers = function () { if (0 !== this.byteOffset && this._dirty) { var t = tu.__isWebIOS14OrIPadOS14Env, e = t ? this._nextFreeIAHandle : 1; if (t && e / this._iaPool.length < .5) { for (var i = e / .5, n = this._iaPool.length - 1; n >= i; n--) { var r = this._iaPool[n]; r.vertexBuffers[0] && r.vertexBuffers[0].destroy(), r.indexBuffer && r.indexBuffer.destroy(), r.ia.destroy() } this._iaPool.length = i } for (var s = this.byteOffset, a = this.indexOffset, o = 0; o < e; ++o) { var u = this._iaPool[o], h = new Float32Array(this.vData.buffer, 0, s >> 2), c = new Uint16Array(this.iData.buffer, 0, a), l = u.vertexBuffers[0]; s > l.size && l.resize(s), l.update(h), 2 * a > u.indexBuffer.size && u.indexBuffer.resize(2 * a), u.indexBuffer.update(c) } this.dirty = !1 } }, t.createNewIA = function (t) { var e, i, n; if (tu.__isWebIOS14OrIPadOS14Env || !this._iaPool[0]) { var r = this._vertexFormatBytes = 4 * this._floatsPerVertex, s = t.createBuffer(new Zd(10, 3, r, r)); n = t.createBuffer(new Zd(6, 3, 2, 2)), i = [s], this._iaInfo = new gp(this._attributes, i, n), e = t.createInputAssembler(this._iaInfo) } else e = t.createInputAssembler(this._iaInfo), i = this._iaInfo.vertexBuffers, n = this._iaInfo.indexBuffer; return { ia: e, vertexBuffers: i, indexBuffer: n } }, n(e, [{ key: "attributes", get: function () { return this._attributes } }, { key: "vertexFormatBytes", get: function () { return this._vertexFormatBytes } }, { key: "byteOffset", get: function () { return this._byteOffset }, set: function (t) { this._byteOffset = t } }, { key: "vertexOffset", get: function () { return this._vertexOffset }, set: function (t) { this._vertexOffset = t } }, { key: "indexOffset", get: function () { return this._indexOffset }, set: function (t) { this._indexOffset = t } }, { key: "dirty", get: function () { return this._dirty }, set: function (t) { this._dirty = t } }, { key: "floatsPerVertex", get: function () { return this._floatsPerVertex }, set: function (t) { this._floatsPerVertex = t } }, { key: "vData", get: function () { return this._vData }, set: function (t) { this._vData = t } }, { key: "iData", get: function () { return this._iData }, set: function (t) { this._iData = t } }, { key: "nativeObj", get: function () { return this._nativeObj } }, { key: "sharedBuffer", get: function () { return this._sharedBuffer } }]), e }()), ZL = function () { function t(t, e) { this._buffers = [], this._device = t, this._attributes = e, this._floatsPerVertex = KL(e) >> 2, this._vertexFormatBytes = 4 * this._floatsPerVertex } var e = t.prototype; return e.initialize = function () { }, e.reset = function () { }, e.request = function () { }, e.appendBuffers = function () { }, e.uploadBuffers = function () { }, e.destroy = function () { this._attributes.length = 0 }, n(t, [{ key: "attributes", get: function () { return this._attributes } }, { key: "vertexFormatBytes", get: function () { return this._vertexFormatBytes } }, { key: "floatsPerVertex", get: function () { return this._floatsPerVertex } }]), t }(), JL = new to((function () { return { offset: 0, length: 0 } }), 32), $L = function () { function t(t, e, i, n, r, s) { this.vertexAccessor = t, this.bufferId = e, this.meshBuffer = i, this.vertexOffset = n, this.vb = r, this.indexCount = s, this._ib = new Uint16Array(s), t.getMeshBuffer(e) } return t.prototype.setIndexBuffer = function () { }, n(t, [{ key: "ib", get: function () { return this._ib } }]), t }(), tF = function (t) { function e(i, n, r, s) { var a; return (a = t.call(this, i, n) || this)._freeLists = [], a._vCount = 0, a._iCount = 0, a._id = 0, a._vCount = r || Math.floor(1024 * Le.BATCHER2D_MEM_INCREMENT / a._vertexFormatBytes), a._iCount = s || a._vCount * e.IB_SCALE, a._id = e.generateID(), a._allocateBuffer(), a } s(e, t); var i = e.prototype; return i.destroy = function () { for (var e = 0; e < this._buffers.length; ++e) { this._buffers[e].destroy(); for (var i = this._freeLists[e], n = 0; n < i.length; ++n)JL.free(i[n]) } this._buffers.length = 0, this._freeLists.length = 0, t.prototype.destroy.call(this) }, i.reset = function () { for (var t = 0; t < this._buffers.length; ++t) { var e = this._buffers[t]; e.indexOffset = 0, e.reset() } }, i.getVertexBuffer = function (t) { return this._buffers[t].vData }, i.getIndexBuffer = function (t) { return this._buffers[t].iData }, i.getMeshBuffer = function (t) { return this._buffers[t] }, i.uploadBuffers = function () { for (var t = 0; t < this._buffers.length; ++t) { var e = this._freeLists[t][0], i = this._buffers[t]; (!e || e.length < i.vData.byteLength) && i.uploadBuffers() } }, i.appendIndices = function (t, e) { var i = this._buffers[t]; if (e.length) { var n = i.indexOffset + e.length; if (i.iData.length < n) { var r = Math.floor(1.25 * n), s = new Uint16Array(r); s.set(i.iData), i.iData = s } i.iData.set(e, i.indexOffset), i.indexOffset += e.length } }, i.allocateChunk = function (t, e) { var i = t * this.vertexFormatBytes; if (t > this._vCount || e > this._iCount) return rt(9004, i), null; for (var n, r = null, s = 0, a = -1, o = null, u = 0; u < this._buffers.length; ++u) { r = this._buffers[u], n = this._freeLists[u]; for (var h = 0; h < n.length; ++h)if (n[h].length >= i) { o = n[h], s = u, a = h; break } if (o) break } if (o || (s = this._allocateBuffer(), (r = this._buffers[s]) && (a = 0, o = this._freeLists[s][a])), o) { var c = o.offset / this.vertexFormatBytes, l = new Float32Array(r.vData.buffer, o.offset, i >> 2).fill(0); return this._allocateChunkFromEntry(s, a, o, i), new $L(this, s, r, c, l, e) } return null }, i.recycleChunk = function (t) { var e = this._freeLists[t.bufferId], i = this._buffers[t.bufferId], n = t.vertexOffset * this.vertexFormatBytes, r = t.vb.byteLength; if (0 !== r) { for (var s = !1, a = 0, o = null, u = e[a]; u && u.offset < n;)o = u, u = e[++a]; if (o && 0 == n - (o.offset + o.length) && (o.length += r, n = o.offset, r = o.length, u && u.offset - (n + r) == 0 && (o.length += u.length, e.splice(a, 1), JL.free(u), u = null), s = !0), !s && u) { if (0 == u.offset - (n + r)) u.offset = n, u.length += r; else { var h = JL.alloc(); h.offset = n, h.length = r, e.splice(a, 0, h) } s = !0 } if (s) n + r === i.byteOffset && (i.byteOffset = n); else { var c = JL.alloc(); c.offset = n, c.length = r, e.push(c) } } }, i._allocateChunkFromEntry = function (t, e, i, n) { var r = i.length - n, s = i.offset + n, a = this._buffers[t]; a.byteOffset < s && (a.byteOffset = s), at(r >= 0, 9004, t, i.offset, i.length), 0 === r ? (this._freeLists[t].splice(e, 1), JL.free(i)) : (i.offset += n, i.length = r) }, i._allocateBuffer = function () { at(this._buffers.length === this._freeLists.length, 9003); var t = new QL, e = this._vCount * this._floatsPerVertex; t.initialize(this._device, this._attributes, e, this._iCount), this._buffers.push(t); var i = JL.alloc(); i.offset = 0, i.length = t.vData.byteLength; var n = [i]; return this._freeLists.push(n), yB.root.batcher2D.syncMeshBuffersToNative(this.id, this._buffers), this._buffers.length - 1 }, e.generateID = function () { return e.ID_COUNT++ }, n(e, [{ key: "id", get: function () { return this._id } }]), e }(ZL); tF.IB_SCALE = 4, tF.ID_COUNT = 0, function () { function t(t) { this._accId = -1, this._bufferId = -1, this._vertexOffset = 0, this._indexOffset = 0, this._vb = null, this._ib = null, this._vData = null, this._iData = null, this._vertDirty = !1, this._vbCount = 0, this._ibCount = 0, this._dataHash = 0, this._isMeshBuffer = !1, this._material = null, this._texture = null, this._sampler = null, this._stride = 0, this._useLocal = !1, this._model = null, this._drawInfoType = 0, this._subNode = null, this._render2dBuffer = null, this.init(t); var e = this._nativeObj.getAttrSharedBufferForJS(), i = 0; this._uint8SharedBuffer = new Uint8Array(e, i, 4), i += 4, this._uint16SharedBuffer = new Uint16Array(e, i, 2), i += 4, this._uint32SharedBuffer = new Uint32Array(e, i, 5) } var e = t.prototype; e.init = function () { }, e.clear = function () { this._bufferId = 0, this._vertexOffset = 0, this._indexOffset = 0, this._vertDirty = !1 }, e.setAccId = function (t) { this._accId = t }, e.setBufferId = function (t) { this._bufferId = t }, e.setAccAndBuffer = function (t, e) { this._bufferId = e, this._accId = t }, e.setVertexOffset = function (t) { this._vertexOffset = t }, e.setIndexOffset = function (t) { this._indexOffset = t }, e.setVB = function () { }, e.setIB = function () { }, e.setVData = function () { }, e.setIData = function () { }, e.setVBCount = function (t) { this._vbCount = t }, e.setIBCount = function () { }, e.setVertDirty = function (t) { this._vertDirty = t }, e.setDataHash = function (t) { this._dataHash = t }, e.setIsMeshBuffer = function (t) { this._isMeshBuffer = t }, e.setVertexPositionInWorld = function () { }, e.setMaterial = function (t) { this._material = t }, e.setTexture = function (t) { this._texture = t }, e.setSampler = function (t) { this._sampler = t }, e.setModel = function () { }, e.setDrawInfoType = function (t) { this._drawInfoType = t }, e.setSubNode = function (t) { this._subNode = t }, e.setStride = function (t) { this._stride = t }, e.initRender2dBuffer = function () { }, e.fillRender2dBuffer = function () { }, n(t, [{ key: "nativeObj", get: function () { return this._nativeObj } }, { key: "render2dBuffer", get: function () { return this._render2dBuffer } }]) }(); var eF, iF, nF, rF, sF, aF, oF, uF, hF, cF, lF, fF = KL(WL) >> 2, dF = t("BaseRenderData", function () { function t(t) { void 0 === t && (t = WL), this.chunk = null, this._renderDrawInfo = null, this._material = null, this._dataHash = 0, this._isMeshBuffer = !1, this._vc = 0, this._ic = 0, this._floatStride = 0, this._vertexFormat = WL, this._drawInfoType = 0, this._multiOwner = !1, this._batcher = null, this._floatStride = t === WL ? fF : KL(t) >> 2, this._vertexFormat = t } var e = t.prototype; return e.isValid = function () { return this._ic > 0 && this.chunk.vertexAccessor }, e.initRenderDrawInfo = function () { }, e.removeRenderDrawInfo = function () { }, e.setRenderDrawInfoAttributes = function () { }, n(t, [{ key: "vertexCount", get: function () { return this._vc } }, { key: "indexCount", get: function () { return this._ic } }, { key: "stride", get: function () { return this._floatStride << 2 } }, { key: "floatStride", get: function () { return this._floatStride } }, { key: "vertexFormat", get: function () { return this._vertexFormat } }, { key: "drawInfoType", get: function () { return this._drawInfoType }, set: function (t) { this._drawInfoType = t } }, { key: "renderDrawInfo", get: function () { return this._renderDrawInfo } }, { key: "material", get: function () { return this._material }, set: function (t) { this._material = t } }, { key: "dataHash", get: function () { return this._dataHash }, set: function (t) { this._dataHash = t } }, { key: "multiOwner", get: function () { return this._multiOwner }, set: function (t) { this._multiOwner = t } }, { key: "batcher", get: function () { return this._batcher || (this._batcher = yB.root.batcher2D), this._batcher } }]), t }()), pF = t("RenderData", function (t) { function e(e, i) { var n; return void 0 === e && (e = WL), void 0 === i && (i = null), (n = t.call(this, e) || this)._vertDirty = !0, n._textureHash = 0, n.indices = null, n.layer = 0, n.nodeDirty = !0, n.passDirty = !0, n.textureDirty = !0, n.hashDirty = !0, n._data = [], n._frame = null, n._accessor = null, n.vertexRow = 1, n.vertexCol = 1, i || (i = n.batcher.switchBufferAccessor(n._vertexFormat)), n._accessor = i, n } s(e, t), e.add = function (t, i) { void 0 === t && (t = WL), void 0 === i && (i = null); var n = new e(t, i); return i || (i = yB.root.batcher2D.switchBufferAccessor(n._vertexFormat)), n._accessor = i, n }, e.remove = function (t) { t.clear(), t._accessor = null }; var i = e.prototype; return i.resize = function (t, e) { t === this._vc && e === this._ic && this.chunk || (this._vc = t, this._ic = e, this.chunk && (this._accessor.recycleChunk(this.chunk), this.chunk = null), this.chunk = this._accessor.allocateChunk(t, e), this.updateHash()) }, i.setRenderDrawInfoAttributes = function () { }, i.fillDrawInfoAttributes = function () { }, i.syncRender2dBuffer = function () { }, i.resizeAndCopy = function (t, e) { if (t !== this._vc || e !== this._ic || !this.chunk) { this._vc = t, this._ic = e; var i = this.chunk; this.chunk = this._accessor.allocateChunk(t, e), i && (this.chunk.vb.set(i.vb), this._accessor.recycleChunk(i)), this.updateHash() } }, i.getMeshBuffer = function () { return this.chunk && this._accessor ? this._accessor.getMeshBuffer(this.chunk.bufferId) : null }, i.updateNode = function (t) { this.layer = t.node.layer, this.nodeDirty = !1, this.hashDirty = !0 }, i.updatePass = function (t) { this.material = t.getRenderMaterial(0), this.passDirty = !1, this.hashDirty = !0 }, i.updateTexture = function (t) { this.frame = t, this.textureHash = t.getHash(), this.textureDirty = !1, this.hashDirty = !0 }, i.updateHash = function () { var t = "" + (this.chunk ? this.chunk.bufferId : -1) + this.layer + " " + this.textureHash; this.dataHash = Lf(t, 666), this.hashDirty = !1 }, i.updateRenderData = function (t, e) { if (this.passDirty && (this.material = t.getRenderMaterial(0), this.passDirty = !1, this.hashDirty = !0), this.nodeDirty) { var i = t.node.scene ? t._getRenderScene() : null; this.layer = t.node.layer, null !== i && (this.nodeDirty = !1), this.hashDirty = !0 } this.textureDirty && (this.frame = e, this.textureHash = e.getHash(), this.textureDirty = !1, this.hashDirty = !0), this.hashDirty && this.updateHash() }, i.clear = function () { this.resize(0, 0), this._data.length = 0, this.indices = null, this.vertDirty = !0, this.material = null, this.nodeDirty = !0, this.passDirty = !0, this.textureDirty = !0, this.hashDirty = !0, this.layer = 0, this.frame = null, this.textureHash = 0, this.dataHash = 0 }, e.createStaticVBAccessor = function (t, e, i) { var n = yB.root.device; return new tF(n, t, e, i) }, n(e, [{ key: "dataLength", get: function () { return this._data.length }, set: function (t) { var e = this._data; if (e.length !== t) { for (var i = e.length; i < t; i++)e.push({ x: 0, y: 0, z: 0, u: 0, v: 0, color: rr.WHITE.clone() }); e.length = t } this.syncRender2dBuffer() } }, { key: "data", get: function () { return this._data } }, { key: "vertDirty", get: function () { return this._vertDirty }, set: function (t) { this._vertDirty = t } }, { key: "textureHash", get: function () { return this._textureHash }, set: function (t) { this._textureHash = t } }, { key: "frame", get: function () { return this._frame }, set: function (t) { this._frame = t } }, { key: "accessor", get: function () { return this._accessor } }]), e }(dF)), _F = t("MeshRenderData", function (t) { function e(e) { var i; return void 0 === e && (e = WL), (i = t.call(this, e) || this)._isMeshBuffer = !0, i.vertexStart = 0, i.vertexRange = 0, i.indexStart = 0, i.indexRange = 0, i.lastFilledIndex = 0, i.lastFilledVertex = 0, i.frame = null, i._byteLength = 0, i._vertexBuffers = [], i._indexBuffer = null, i._iaPool = null, i._iaInfo = null, i.vData = new Float32Array(256 * i.stride), i.iData = new Uint16Array(1536), i } s(e, t), e.add = function (t) { void 0 === t && (t = WL); var i = new e; return i._floatStride = t === WL ? fF : KL(t) >> 2, i._vertexFormat = t, i }, e.remove = function (t) { t.clear() }; var i = e.prototype; return i.request = function (t, e) { var i = this._byteLength + t * this.stride; return !!this.reserve(t, e) && (this._vc += t, this._ic += e, this._byteLength = i, this.vertexRange = this._vc, this.indexRange = this._ic, !0) }, i.reserve = function (t, e) { var i = this._byteLength + t * this.stride, n = this.indexCount + e; if (t + this.vertexCount > 65535) return !1; var r = this.vData.byteLength, s = this.iData.length, a = this.vData.length, o = this.iData.length; if (i > r || n > s) { for (; r < i || s < n;)r = 4 * (a *= 2), s = o *= 2; this._reallocBuffer(a, o) } return !0 }, i.resize = function (t, e) { var i = t * this.stride; t >= 0 && e >= 0 && i <= this.vData.byteLength && this.iData.length, this._vc = t, this._ic = e, this._byteLength = i, this.updateRange(0, t, 0, e) }, i.updateRange = function (t, e, i, n) { e >= 0 && n >= 0 && e <= this._vc && this._ic, this.vertexStart = t, this.indexStart = i, this.vertexRange = e, this.indexRange = n }, i.requestIA = function (t) { this._initIAInfo(t); var e = this._iaPool.add(); return e.firstIndex = this.indexStart, e.indexCount = this.indexRange, e }, i.uploadBuffers = function () { if (0 !== this._byteLength && this._vertexBuffers[0] && this._indexBuffer) { var t = this._ic, e = new Float32Array(this.vData.buffer, 0, this._byteLength >> 2), i = new Uint16Array(this.iData.buffer, 0, t), n = this._vertexBuffers[0]; this._byteLength > n.size && n.resize(this._byteLength), n.update(e); var r = t << 1; r > this._indexBuffer.size && this._indexBuffer.resize(r), this._indexBuffer.update(i) } }, i.freeIAPool = function () { this._iaPool && this._iaPool.reset() }, i.reset = function () { this._vc = 0, this._ic = 0, this._byteLength = 0, this.vertexStart = 0, this.vertexRange = 0, this.indexStart = 0, this.indexRange = 0, this.lastFilledIndex = 0, this.lastFilledVertex = 0, this.material = null, this.freeIAPool() }, i.clear = function () { this.reset(), this._iaPool && this._iaPool.destroy(), this._vertexBuffers[0] && (this._vertexBuffers[0].destroy(), this._vertexBuffers = []), this._iaInfo = null, this.vData = new Float32Array(256 * this.stride), this.iData = new Uint16Array(1536) }, i._initIAInfo = function (t) { var e = this; if (!this._iaInfo) { var i = this.stride, n = this._vertexBuffers; n.length || n.push(t.createBuffer(new Zd(10, 1, i, i))), this._indexBuffer || (this._indexBuffer = t.createBuffer(new Zd(6, 1, 2, 2))), this._iaInfo = new gp(this._vertexFormat, n, this._indexBuffer), this._iaPool = new eo((function () { return t.createInputAssembler(e._iaInfo) }), 1, (function (t) { t.destroy() })) } }, i._reallocBuffer = function (t, e) { var i = this.vData; this.vData = new Float32Array(t), i && this.vData.set(i, 0); var n = this.iData; this.iData = new Uint16Array(e), n && this.iData.set(n, 0) }, i.setRenderDrawInfoAttributes = function () { }, i.particleInitRenderDrawInfo = function () { }, n(e, [{ key: "formatByte", get: function () { return this.stride }, set: function () { } }, { key: "floatStride", get: function () { return this._floatStride } }, { key: "vDataOffset", get: function () { return this._byteLength >>> 2 } }]), e }(dF)), gF = new as, mF = new as, vF = new Kn, yF = new Gr, bF = new Gr, wF = new Gr, xF = new Gr(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0), SF = new fs, TF = Gu("cc.UITransform")(eF = Wu(110)(eF = ju((sF = function (t) { function e() { var e; return (e = t.call(this) || this)._priority = 0, e._contentSize = nF && nF(), e._anchorPoint = rF && rF(), e } s(e, t); var i = e.prototype; return i.__preload = function () { this.node._uiProps.uiTransformComp = this }, i.onLoad = function () { this.node.parent && e.insertChangeMap(this.node.parent) }, i.onEnable = function () { this.node.on("parent-changed", this._parentChanged, this), this._markRenderDataDirty() }, i.onDisable = function () { this.node.off("parent-changed", this._parentChanged, this) }, i.onDestroy = function () { this.node._uiProps.uiTransformComp = null }, i.setContentSize = function (t, e) { var i, n, r = this._contentSize; if (void 0 === e) { if (ji(t.width, r.width, Hi) && ji(t.height, r.height, Hi)) return; i = t.width, n = t.height } else { if (ji(t, r.width, Hi) && ji(e, r.height, Hi)) return; i = t, n = e } r.width = i, r.height = n, this.node.emit("size-changed"), this._markRenderDataDirty() }, i.setAnchorPoint = function (t, e) { var i = this._anchorPoint; if (void 0 === e) { if (t.x === i.x && t.y === i.y) return; i.x = t.x, i.y = t.y } else { if (t === i.x && e === i.y) return; i.x = t, i.y = e } this.node.emit("anchor-changed", this._anchorPoint), this._markRenderDataDirty() }, i.isHit = function (t) { for (var e = this._contentSize.width, i = this._contentSize.height, n = gF, r = mF, s = this._getRenderScene().cameras, a = 0; a < s.length; a++) { var o = s[a]; if (o.visibility & this.node.layer) { o.node.getWorldRT(yF); var u = yF.m12, h = yF.m13, c = eu.center; if (yF.m12 = c.x - (yF.m00 * u + yF.m04 * h), yF.m13 = c.y - (yF.m01 * u + yF.m05 * h), Gr.invert(yF, yF), as.transformMat4(n, t, yF), this.node.getWorldMatrix(wF), Gr.invert(yF, wF), !Gr.strictEquals(yF, xF)) { as.transformMat4(r, n, yF), r.x += this._anchorPoint.x * e, r.y += this._anchorPoint.y * i; var l = !1; if (r.x >= 0 && r.y >= 0 && r.x <= e && r.y <= i && (l = this._maskTest(n)), l) return !0 } } } return !1 }, i.hitTest = function (t, e) { void 0 === e && (e = 0); for (var i = this._contentSize.width, n = this._contentSize.height, r = vF, s = gF, a = mF, o = this._getRenderScene().cameras, u = 0; u < o.length; u++) { var h = o[u]; if (h.visibility & this.node.layer && (!h.window || h.window.swapchain) && h.systemWindowId === e && (Kn.set(r, t.x, t.y, 0), h.screenToWorld(r, r), as.set(s, r.x, r.y), this.node.getWorldMatrix(wF), Gr.invert(yF, wF), !Gr.strictEquals(yF, xF))) { as.transformMat4(a, s, yF), a.x += this._anchorPoint.x * i, a.y += this._anchorPoint.y * n; var c = !1; if (a.x >= 0 && a.y >= 0 && a.x <= i && a.y <= n && (c = this._maskTest(s)), c) return !0 } } return !1 }, i._maskTest = function (t) { var e, i, n = null == (e = this.node) || null == (i = e.eventProcessor) ? void 0 : i.maskList; if (n) for (var r = this.node, s = n.length, a = 0, o = 0; r && o < s; ++a, r = r.parent) { var u = n[o]; if (a === u.index) { if (r !== u.comp.node) { n.length = o; break } var h = u.comp; if (h && h._enabled && !h.isHit(t)) return !1; o++ } else if (a > u.index) { n.length = o; break } } return !0 }, i.convertToNodeSpaceAR = function (t, e) { return this.node.getWorldMatrix(wF), Gr.invert(yF, wF), e || (e = new Kn), Kn.transformMat4(e, t, yF) }, i.convertToWorldSpaceAR = function (t, e) { return this.node.getWorldMatrix(wF), e || (e = new Kn), Kn.transformMat4(e, t, wF) }, i.getBoundingBox = function () { var t = new fs; return this._selfBoundingBox(t), Gr.fromSRT(bF, this.node.rotation, this.node.position, this.node.scale), t.transformMat4(bF), t }, i.getBoundingBoxToWorld = function () { for (var t = new fs, i = this.node.children, n = 0; n < i.length; ++n) { var r = i[n]; if (r && r.active) { var s = r.getComponent(e); s && s.contentSize.width && s.contentSize.height && (s._selfBoundingBox(SF), SF.transformMat4(r.worldMatrix), 0 === t.width ? t.set(SF) : fs.union(t, t, SF)) } } return this._contentSize.width && this._contentSize.height && (this._selfBoundingBox(SF), SF.transformMat4(this.node.worldMatrix), 0 === t.width ? t.set(SF) : fs.union(t, t, SF)), t }, i.getBoundingBoxTo = function (t) { var i = new fs, n = this.node.children; Gr.invert(yF, t); for (var r = 0; r < n.length; ++r) { var s = n[r]; if (s && s.active) { var a = s.getComponent(e); a && a.contentSize.width && a.contentSize.height && (a._selfBoundingBox(SF), Gr.multiply(bF, s.worldMatrix, yF), SF.transformMat4(bF), 0 === i.width ? i.set(SF) : fs.union(i, i, SF)) } } return this._contentSize.width && this._contentSize.height && (this._selfBoundingBox(SF), Gr.multiply(bF, this.node.worldMatrix, yF), SF.transformMat4(bF), 0 === i.width ? i.set(SF) : fs.union(i, i, SF)), i }, i.getComputeAABB = function (t) { var e = this._contentSize.width, i = this._contentSize.height; SF.set(-this._anchorPoint.x * e, -this._anchorPoint.y * i, e, i), SF.transformMat4(this.node.worldMatrix); var n = SF.x + .5 * SF.width, r = SF.y + .5 * SF.height, s = this.node.worldPosition.z, a = SF.width / 2, o = SF.height / 2; return null != t ? (hu.set(t, n, r, s, a, o, .001), t) : new hu(n, r, s, a, o, .001) }, i._selfBoundingBox = function (t) { var e = this._contentSize.width, i = this._contentSize.height; return t.set(-this._anchorPoint.x * e, -this._anchorPoint.y * i, e, i), t }, i._parentChanged = function () { this.node.getComponent("cc.RenderRoot2D") || this.node.parent && e.insertChangeMap(this.node.parent) }, i._markRenderDataDirty = function () { var t = this.node._uiProps.uiComp; t && t._markForUpdateRenderData() }, e.insertChangeMap = function (t) { var i = t.uuid; e.priorityChangeNodeMap.has(i) || e.priorityChangeNodeMap.set(i, t) }, e._sortChildrenSibling = function (t) { var e = t.children; e && e.sort((function (t, e) { var i = t._getUITransformComp(), n = e._getUITransformComp(), r = (i ? i._priority : 0) - (n ? n._priority : 0); return 0 === r ? t.siblingIndex - e.siblingIndex : r })) }, e._sortSiblings = function () { e.priorityChangeNodeMap.forEach((function (t) { e._sortChildrenSibling(t), t._updateSiblingIndex(), t.emit("childrenSiblingOrderChanged") })), e.priorityChangeNodeMap.clear() }, e._cleanChangeMap = function () { e.priorityChangeNodeMap.clear() }, n(e, [{ key: "contentSize", get: function () { return this._contentSize }, set: function (t) { this._contentSize.equals(t) || (this._contentSize.set(t), this.node.emit("size-changed"), this._markRenderDataDirty()) } }, { key: "width", get: function () { return this._contentSize.width }, set: function (t) { this._contentSize.width !== t && (this._contentSize.width = t, this.node.emit("size-changed"), this._markRenderDataDirty()) } }, { key: "height", get: function () { return this._contentSize.height }, set: function (t) { this.contentSize.height !== t && (this._contentSize.height = t, this.node.emit("size-changed"), this._markRenderDataDirty()) } }, { key: "anchorPoint", get: function () { return this._anchorPoint }, set: function (t) { this._anchorPoint.equals(t) || (this._anchorPoint.set(t), this.node.emit("anchor-changed", this._anchorPoint), this._markRenderDataDirty()) } }, { key: "anchorX", get: function () { return this._anchorPoint.x }, set: function (t) { this._anchorPoint.x !== t && (this._anchorPoint.x = t, this.node.emit("anchor-changed", this._anchorPoint), this._markRenderDataDirty()) } }, { key: "anchorY", get: function () { return this._anchorPoint.y }, set: function (t) { this._anchorPoint.y !== t && (this._anchorPoint.y = t, this.node.emit("anchor-changed", this._anchorPoint), this._markRenderDataDirty()) } }, { key: "priority", get: function () { return this._priority }, set: function (t) { this._priority !== t && (this.node.getComponent("cc.RenderRoot2D") ? it(6706) : (this._priority = t, this.node.parent && e.insertChangeMap(this.node.parent))) } }, { key: "visibility", get: function () { var t = yB.root.batcher2D.getFirstRenderCamera(this.node); return t ? t.visibility : 0 } }, { key: "cameraPriority", get: function () { var t = yB.root.batcher2D.getFirstRenderCamera(this.node); return t ? t.priority : 0 } }]), e }(am), sF.EventType = Rv, sF.priorityChangeNodeMap = new Map, nF = Bu((iF = sF).prototype, "_contentSize", [eh], (function () { return new us(100, 100) })), rF = Bu(iF.prototype, "_anchorPoint", [eh], (function () { return new as(.5, .5) })), eF = iF)) || eF) || eF) || eF; t({ UITransform: TF, UITransformComponent: TF }), yB.on("director_after_update", TF._sortSiblings), yB.on("director_before_scene_launch", TF._cleanChangeMap); var IF, EF, AF, CF, DF, RF, PF, BF, MF, OF, LF, FF, kF = { parent: null, owner: null, subModelIdx: 0 }, NF = ju, zF = Ih, UF = t("Renderer", (aF = Gu("cc.Renderer"), oF = zF(gT), uF = zF([gT]), aF(hF = NF((cF = function (t) { function e() { var e; return (e = t.call(this) || this)._materials = lF && lF(), e._materialInstances = [], e } s(e, t); var i = e.prototype; return i.getMaterial = function (t) { return this.getSharedMaterial(t) }, i.setMaterial = function (t, e) { this.setSharedMaterial(t, e) }, i.getSharedMaterial = function (t) { return t < 0 || t >= this._materials.length ? null : this._materials[t] }, i.setSharedMaterial = function (t, e) { if (t && t instanceof IT && rt(12012), this._materials[e] !== t) { this._materials[e] = t; var i = this._materialInstances[e]; i && (i.destroy(), this._materialInstances[e] = null), this._onMaterialModified(e, this._materials[e]) } }, i.getMaterialInstance = function (t) { if (!this._materials[t]) return null; if (!this._materialInstances[t]) { kF.parent = this._materials[t], kF.owner = this, kF.subModelIdx = t; var e = new IT(kF); kF.parent = null, kF.owner = null, kF.subModelIdx = 0, this.setMaterialInstance(e, t) } return this._materialInstances[t] }, i.setMaterialInstance = function (t, e) { if ("number" == typeof t) { it(12007); var i = t; t = e, e = i } var n = this._materialInstances[e]; t && t.parent ? t !== n && (this._materialInstances[e] = t, this._onMaterialModified(e, t)) : (t !== this._materials[e] || n) && this.setSharedMaterial(t, e) }, i.getRenderMaterial = function (t) { return this._materialInstances[t] || this._materials[t] }, i._onMaterialModified = function () { }, i._onRebuildPSO = function () { }, i._clearMaterials = function () { }, n(e, [{ key: "sharedMaterial", get: function () { return this.getSharedMaterial(0) } }, { key: "sharedMaterials", get: function () { return this._materials }, set: function (t) { for (var e = 0; e < t.length; e++)t[e] !== this._materials[e] && this.setSharedMaterial(t[e], e); if (t.length < this._materials.length) { for (var i = t.length; i < this._materials.length; i++)this.setSharedMaterial(null, i); this._materials.splice(t.length) } } }, { key: "material", get: function () { return this.getMaterialInstance(0) }, set: function (t) { (1 !== this._materials.length || this._materialInstances[0] || this._materials[0] !== t) && this.setMaterialInstance(t, 0) } }, { key: "materials", get: function () { for (var t = 0; t < this._materials.length; t++)this._materialInstances[t] = this.getMaterialInstance(t); return this._materialInstances }, set: function (t) { for (var e = t.length, i = this._materials.length, n = e; n < i; n++)this.setMaterialInstance(null, n); this._materials.length = e, this._materialInstances.length = e; for (var r = 0; r < e; r++)this._materialInstances[r] != t[r] && this.setMaterialInstance(t[r], r) } }]), e }(am), m(cF.prototype, "sharedMaterials", [oF], Object.getOwnPropertyDescriptor(cF.prototype, "sharedMaterials"), cF.prototype), lF = Bu(cF.prototype, "_materials", [uF], (function () { return [] })), hF = cF)) || hF) || hF)), VF = function () { function t() { this._renderEntityType = 0, this._dynamicDrawInfoArr = [], this._node = null, this._renderTransform = null, this._stencilStage = 0, this._useLocal = !1, this._maskMode = 0, this._color = rr.WHITE.clone(), this._localOpacity = 255, this._colorDirty = !0, this._enabled = !1 } var e = t.prototype; return e.addDynamicRenderDrawInfo = function () { }, e.removeDynamicRenderDrawInfo = function () { }, e.clearDynamicRenderDrawInfos = function () { }, e.clearStaticRenderDrawInfos = function () { }, e.setDynamicRenderDrawInfo = function () { }, e.setMaskMode = function (t) { this._maskMode = t }, e.getStaticRenderDrawInfo = function () { return null }, e.setNode = function (t) { this._node = t }, e.setRenderTransform = function (t) { this._renderTransform = t }, e.setStencilStage = function (t) { this._stencilStage = t }, e.setUseLocal = function (t) { this._useLocal = t }, e.initSharedBuffer = function () { }, n(t, [{ key: "nativeObj", get: function () { return this._nativeObj } }, { key: "renderDrawInfoArr", get: function () { return this._dynamicDrawInfoArr } }, { key: "renderEntityType", get: function () { return this._renderEntityType } }, { key: "color", get: function () { return this._color }, set: function (t) { this._color = t } }, { key: "localOpacity", get: function () { return this._localOpacity }, set: function (t) { this._localOpacity = t } }, { key: "colorDirty", get: function () { return this._colorDirty }, set: function (t) { this._colorDirty = t } }, { key: "enabled", get: function () { return this._enabled }, set: function (t) { this._enabled = t } }]), t }(); De(fd), De(dd), De(pd), t("InstanceMaterialType", { ADD_COLOR: 0, ADD_COLOR_AND_TEXTURE: 1, GRAYSCALE: 2, USE_ALPHA_SEPARATED: 3, USE_ALPHA_SEPARATED_AND_GRAY: 4 }); var GF = (IF = Gu("cc.UIRenderer"), EF = Hu(TF), AF = Ih(gT), CF = Ih(gT), IF(DF = EF((FF = function (t) { function e() { var e; return (e = t.call(this) || this)._renderData = null, e._materials = PF && PF(), e._customMaterial = BF && BF(), e._srcBlendFactor = MF && MF(), e._dstBlendFactor = OF && OF(), e._color = LF && LF(), e._stencilStage = 0, e._assembler = null, e._postAssembler = null, e._renderDataFlag = !0, e._renderFlag = !0, e._instanceMaterialType = -1, e._srcBlendFactorCache = 2, e._dstBlendFactorCache = 4, e._dirtyVersion = -1, e._internalId = -1, e._flagChangedVersion = -1, e._useVertexOpacity = !1, e._lastParent = null, e._renderEntity = e.createRenderEntity(), e } s(e, t); var i = e.prototype; return i.setRenderData = function (t) { this._renderData = t }, i.onLoad = function () { this._renderEntity.setNode(this.node) }, i.__preload = function () { this.node._uiProps.uiComp = this, this._flushAssembler && this._flushAssembler() }, i.onEnable = function () { this.node.on("anchor-changed", this._nodeStateChange, this), this.node.on("size-changed", this._nodeStateChange, this), this.node.on("parent-changed", this._colorDirty, this), !this._renderData && this._flushAssembler && this._flushAssembler(), this.updateMaterial(), this._colorDirty(), oB.addRenderer(this), this._markForUpdateRenderData() }, i.onRestore = function () { this.updateMaterial(), this._markForUpdateRenderData() }, i.onDisable = function () { this.node.off("anchor-changed", this._nodeStateChange, this), this.node.off("size-changed", this._nodeStateChange, this), this.node.off("parent-changed", this._colorDirty, this), this.destroyRenderData(), oB.removeRenderer(this), this._renderFlag = !1, this._renderEntity.enabled = !1 }, i.onDestroy = function () { if (this._renderEntity.setNode(null), this.node._uiProps.uiComp === this && (this.node._uiProps.uiComp = null), this.destroyRenderData(), this._materialInstances) for (var t = 0; t < this._materialInstances.length; t++) { var e = this._materialInstances[t]; e && e.destroy() } }, i.markForUpdateRenderData = function (t) { void 0 === t && (t = !0), this._markForUpdateRenderData(t) }, i._markForUpdateRenderData = function (t) { if (void 0 === t && (t = !0), t) { var e = this._renderData; e && (e.vertDirty = !0), oB.markDirtyRenderer(this) } }, i.requestRenderData = function (t) { void 0 === t && (t = 0); var e = pF.add(); return e.initRenderDrawInfo(this, t), this._renderData = e, e }, i.destroyRenderData = function () { this._renderData && (this._renderData.removeRenderDrawInfo(this), pF.remove(this._renderData), this._renderData = null) }, i.updateRenderer = function () { var t = this._assembler; t && t.updateRenderData && t.updateRenderData(this), this._renderFlag = this._canRender(), this._renderEntity.enabled = this._renderFlag }, i.fillBuffers = function (t) { this._renderFlag && this._render(t) }, i.postUpdateAssembler = function (t) { this._postAssembler && this._renderFlag && this._postRender(t) }, i._render = function () { }, i._postRender = function () { }, i._canRender = function () { return null !== this.getSharedMaterial(0) && this._enabled && this._color.a > 0 }, i._postCanRender = function () { }, i.updateMaterial = function () { if (this._customMaterial) this.getSharedMaterial(0) !== this._customMaterial && this.setSharedMaterial(this._customMaterial, 0); else { var t = this._updateBuiltinMaterial(); this.setSharedMaterial(t, 0), 2 !== this.stencilStage && 6 !== this.stencilStage || this.getMaterialInstance(0).recompileShaders({ USE_ALPHA_TEST: !0 }), this._updateBlendFunc() } }, i._updateColor = function () { this.node._uiProps.colorDirty = !0, this.setEntityColorDirty(!0), this.setEntityColor(this._color), this.setEntityOpacity(this.node._uiProps.localOpacity); var t = this._assembler; if (t) { t.updateColor && t.updateColor(this); var e = this._renderFlag; if (this._renderFlag = this._canRender(), this.setEntityEnabled(this._renderFlag), e !== this._renderFlag) { var i = this.renderData; i && (i.vertDirty = !0) } } }, e.setEntityColorDirtyRecursively = function (t, i) { var n = t._uiProps.uiComp; n && n.color && (n._renderEntity.colorDirty = i); for (var r = 0; r < t.children.length; r++)e.setEntityColorDirtyRecursively(t.children[r], i) }, i.setEntityColorDirty = function () { }, i.setEntityColor = function () { }, i.setEntityOpacity = function () { }, i.setEntityEnabled = function () { }, i._updateBlendFunc = function () { var t = this.getRenderMaterial(0).passes[0].blendState.targets[0]; if (this._dstBlendFactorCache = t.blendDst, this._srcBlendFactorCache = t.blendSrc, this._dstBlendFactorCache !== this._dstBlendFactor || this._srcBlendFactorCache !== this._srcBlendFactor) { (t = this.getMaterialInstance(0).passes[0].blendState.targets[0]).blend = !0, t.blendDstAlpha = 4, t.blendDst = this._dstBlendFactor, t.blendSrc = this._srcBlendFactor; var e = this.getMaterialInstance(0).passes[0]; e.blendState.setTarget(0, t), e._updatePassHash(), this._dstBlendFactorCache = this._dstBlendFactor, this._srcBlendFactorCache = this._srcBlendFactor } }, i._nodeStateChange = function () { this._renderData && this._markForUpdateRenderData(); for (var t = 0; t < this.node.children.length; ++t) { var i = this.node.children[t].getComponent(e); i && i._markForUpdateRenderData() } }, i._colorDirty = function () { this.node._uiProps.colorDirty = !0, this.setEntityColorDirty(!0) }, i._onMaterialModified = function (e, i) { this._renderData && (this._markForUpdateRenderData(), this._renderData.passDirty = !0), t.prototype._onMaterialModified.call(this, e, i) }, i._updateBuiltinMaterial = function () { var t; switch (this._instanceMaterialType) { case 0: t = YS.get("ui-base-material"); break; case 2: t = YS.get("ui-sprite-gray-material"); break; case 3: t = YS.get("ui-sprite-alpha-sep-material"); break; case 4: t = YS.get("ui-sprite-gray-alpha-sep-material"); break; default: t = YS.get("ui-sprite-material") }return t }, i.setNodeDirty = function () { this._renderData && (this._renderData.nodeDirty = !0) }, i.setTextureDirty = function () { this._renderData && (this._renderData.textureDirty = !0) }, i.createRenderEntity = function () { return new VF(0) }, n(e, [{ key: "sharedMaterials", get: function () { return this._materials }, set: function (t) { for (var e = 0; e < t.length; e++)t[e] !== this._materials[e] && this.setSharedMaterial(t[e], e); if (t.length < this._materials.length) { for (var i = t.length; i < this._materials.length; i++)this.setSharedMaterial(null, i); this._materials.splice(t.length) } } }, { key: "customMaterial", get: function () { return this._customMaterial }, set: function (t) { this._customMaterial = t, this.updateMaterial() } }, { key: "color", get: function () { return this._color }, set: function (t) { this._color.equals(t) || (this._color.set(t), this._updateColor()) } }, { key: "renderData", get: function () { return this._renderData } }, { key: "useVertexOpacity", get: function () { return this._useVertexOpacity } }, { key: "stencilStage", get: function () { return this._stencilStage }, set: function (t) { this._stencilStage = t, this._renderEntity.setStencilStage(t) } }, { key: "srcBlendFactor", get: function () { return this._srcBlendFactor }, set: function (t) { this._srcBlendFactor = t } }, { key: "batcher", get: function () { return yB.root.batcher2D } }, { key: "renderEntity", get: function () { return this._renderEntity } }]), e }(UF), FF.BlendState = fd, FF.Assembler = null, FF.PostAssembler = null, m((RF = FF).prototype, "sharedMaterials", [Oh], Object.getOwnPropertyDescriptor(RF.prototype, "sharedMaterials"), RF.prototype), m(RF.prototype, "customMaterial", [AF], Object.getOwnPropertyDescriptor(RF.prototype, "customMaterial"), RF.prototype), PF = Bu(RF.prototype, "_materials", [Oh], (function () { return [] })), BF = Bu(RF.prototype, "_customMaterial", [CF], (function () { return null })), MF = Bu(RF.prototype, "_srcBlendFactor", [eh], (function () { return 2 })), OF = Bu(RF.prototype, "_dstBlendFactor", [eh], (function () { return 4 })), LF = Bu(RF.prototype, "_color", [eh], (function () { return rr.WHITE.clone() })), DF = RF)) || DF) || DF); t({ UIRenderer: GF, RenderComponent: GF, UIRenderable: GF, Renderable2D: GF }), S.internal.UIRenderer = GF; var HF, WF, jF, XF, qF, YF, KF, QF, ZF, JF, $F, tk, ek, ik, nk, rk, sk, ak, ok, uk, hk, ck, lk, fk, dk, pk, _k, gk, mk, vk, yk, bk, wk, xk, Sk = function () { function t() { this.isBold = !1, this.isItalic = !1, this.isUnderline = !1, this.underlineHeight = 1, this.isOutlined = !1, this.outlineColor = rr.WHITE.clone(), this.outlineWidth = 1, this.hasShadow = !1, this.shadowColor = rr.BLACK.clone(), this.shadowBlur = 2, this.shadowOffsetX = 0, this.shadowOffsetY = 0, this.color = rr.WHITE.clone(), this.fontSize = 40, this.actualFontSize = 0, this.isSystemFontUsed = !1, this.originFontSize = 0, this.bmfontScale = 1, this.fontFamily = "Arial", this.fontDesc = "", this.fntConfig = null, this.spriteFrame = null, this.fontScale = 1 } return t.prototype.reset = function () { this.isBold = !1, this.isItalic = !1, this.isUnderline = !1, this.underlineHeight = 1, this.isOutlined = !1, this.outlineColor.set(), this.outlineWidth = 1, this.hasShadow = !1, this.shadowColor.set(), this.shadowBlur = 2, this.shadowOffsetX = 0, this.shadowOffsetY = 0 }, t }(), Tk = function () { function t() { this.horizontalAlign = 0, this.verticalAlign = 0, this.wrapping = !0, this.overFlow = 0, this.lineHeight = 10, this.maxLineWidth = 0, this.spacingX = 0, this.textWidthTemp = 0, this.textHeightTemp = 0, this.textDimensions = new us, this.horizontalKerning = [], this.numberOfLines = 1, this.linesOffsetX = [], this.letterOffsetY = 0, this.tailoredTopY = 0, this.tailoredBottomY = 0, this.textDesiredHeight = 0, this.linesWidth = [] } return t.prototype.reset = function () { this.horizontalAlign = 0, this.verticalAlign = 0, this.wrapping = !0, this.overFlow = 0, this.lineHeight = 10, this.maxLineWidth = 0, this.spacingX = 0, this.textWidthTemp = 0, this.textHeightTemp = 0, this.textDimensions.set(), this.horizontalKerning.length = 0, this.numberOfLines = 1, this.linesOffsetX.length = 0, this.letterOffsetY = 0, this.tailoredTopY = 0, this.tailoredBottomY = 0, this.textDesiredHeight = 0, this.linesWidth.length = 0 }, t }(), Ik = function () { function t() { this.parsedString = [], this.nodeContentSize = us.ZERO.clone(), this.canvasSize = new us, this.canvasPadding = new fs, this.contentSizeExtend = us.ZERO.clone(), this.startPosition = as.ZERO.clone() } return t.prototype.reset = function () { this.parsedString.length = 0, this.nodeContentSize.set(0, 0), this.canvasSize.set(), this.canvasPadding.set(), this.contentSizeExtend.set(), this.startPosition.set() }, t }(), Ek = function () { function t() { this.quadCount = 0, this.vertexBuffer = [], this.texture = null, this.uiTransAnchorX = .5, this.uiTransAnchorY = .5 } return t.prototype.reset = function () { this.quadCount = 0, this.vertexBuffer.length = 0, this.texture = null, this.uiTransAnchorX = .5, this.uiTransAnchorY = .5 }, t }(); rr.WHITE.clone(); var Ak = t("HorizontalTextAlignment", { LEFT: 0, CENTER: 1, RIGHT: 2 }); De(Ak); var Ck = t("VerticalTextAlignment", { TOP: 0, CENTER: 1, BOTTOM: 2 }); De(Ck); var Dk = t("Overflow", { NONE: 0, CLAMP: 1, SHRINK: 2, RESIZE_HEIGHT: 3 }); De(Dk); var Rk = t("CacheMode", { NONE: 0, BITMAP: 1, CHAR: 2 }); De(Rk); var Pk, Bk, Mk, Ok, Lk, Fk, kk, Nk, zk, Uk, Vk, Gk, Hk, Wk, jk, Xk, qk, Yk, Kk, Qk, Zk = (HF = Gu("cc.Label"), WF = Wu(110), jF = Ih(Ak), XF = Ih(Ck), qF = Ih(Dk), YF = Ih(TO), KF = Ih(Rk), HF(QF = WF((xk = function (t) { function e() { var e; return (e = t.call(this) || this)._string = JF && JF(), e._horizontalAlign = $F && $F(), e._verticalAlign = tk && tk(), e._actualFontSize = ek && ek(), e._fontSize = ik && ik(), e._fontFamily = nk && nk(), e._lineHeight = rk && rk(), e._overflow = sk && sk(), e._enableWrapText = ak && ak(), e._font = ok && ok(), e._isSystemFontUsed = uk && uk(), e._spacingX = hk && hk(), e._isItalic = ck && ck(), e._isBold = lk && lk(), e._isUnderline = fk && fk(), e._underlineHeight = dk && dk(), e._cacheMode = pk && pk(), e._enableOutline = _k && _k(), e._outlineColor = gk && gk(), e._outlineWidth = mk && mk(), e._enableShadow = vk && vk(), e._shadowColor = yk && yk(), e._shadowOffset = bk && bk(), e._shadowBlur = wk && wk(), e._N$file = null, e._texture = null, e._ttfSpriteFrame = null, e._userDefinedFont = null, e._assemblerData = null, e._fontAtlas = null, e._letterTexture = null, e._contentWidth = 0, e._textStyle = null, e._textLayout = null, e._textRenderData = null, e._textLayoutData = null, e._ttfSpriteFrame = null, e._textStyle = new Sk, e._textLayout = new Tk, e._textLayoutData = new Ik, e._textRenderData = new Ek, e } s(e, t); var i = e.prototype; return i.onEnable = function () { t.prototype.onEnable.call(this), this._font || this._isSystemFontUsed || (this.useSystemFont = !0), this._isSystemFontUsed && !this._fontFamily && (this.fontFamily = "Arial"), this._applyFontTexture() }, i.destroyTtfSpriteFrame = function () { if (this._ttfSpriteFrame) { this._ttfSpriteFrame._resetDynamicAtlasFrame(); var t = this._ttfSpriteFrame.texture; if (this._ttfSpriteFrame.destroy(), t) { var e = t; e.image && e.image.destroy(), t.destroy() } this._ttfSpriteFrame = null } }, i._onPreDestroy = function () { t.prototype._onPreDestroy.call(this), this._isOnLoadCalled || this.destroyTtfSpriteFrame() }, i.onDestroy = function () { this._assembler && this._assembler.resetAssemblerData && this._assembler.resetAssemblerData(this._assemblerData), this._assemblerData = null, this.destroyTtfSpriteFrame(), this.destroyLetterTexture(), t.prototype.onDestroy.call(this) }, i.destroyLetterTexture = function () { var t = this._letterTexture; t && (t.decRef(!1), t.refCount <= 0 && t.destroy()), this._letterTexture = null }, i.updateRenderData = function (t) { void 0 === t && (t = !1), t && (this._flushAssembler(), this.renderData && (this.renderData.vertDirty = !0), this._applyFontTexture()), this._assembler && this._assembler.updateRenderData(this) }, i._render = function (t) { t.commitComp(this, this.renderData, this._texture, this._assembler, null) }, i._updateColor = function () { t.prototype._updateColor.call(this), this._markForUpdateRenderData() }, i.setEntityColor = function () { }, i._canRender = function () { if (!t.prototype._canRender.call(this) || !this._string) return !1; var e = this._font; if (e && e instanceof EL) { var i = e.spriteFrame; if (!i || !i.texture) return !1 } return !0 }, i._flushAssembler = function () { var t = e.Assembler.getAssembler(this); this._assembler !== t && (this.destroyRenderData(), this._assembler = t, this.textStyle.reset(), this.textLayout.reset(), this.textLayoutData.reset(), this.textRenderData.reset()), this.renderData || this._assembler && this._assembler.createData && (this._renderData = this._assembler.createData(this), this.renderData.material = this.material, this._updateColor()) }, i._applyFontTexture = function () { this._markForUpdateRenderData(); var t = this._font; if (t instanceof EL) { var e = t.spriteFrame; e && e.texture && (this._texture = e, this.renderData && (this.renderData.textureDirty = !0), this.changeMaterialForDefine(), this._assembler && this._assembler.updateRenderData(this)) } else { if (2 === this.cacheMode) { var i = this._letterTexture, n = this._assembler.getAssemblerData(); n !== i && (this.destroyLetterTexture(), n && n.addRef()), this._texture = this._letterTexture = n } else if (!this._ttfSpriteFrame) { this._ttfSpriteFrame = new vO, this._assemblerData = this._assembler.getAssemblerData(); var r = new Pg(this._assemblerData.canvas), s = new bv; s.image = r, this._ttfSpriteFrame.texture = s } 2 !== this.cacheMode && (this._texture = this._ttfSpriteFrame), this.changeMaterialForDefine() } }, i.changeMaterialForDefine = function () { if (this._texture) { var t = !1; if (2 !== this.cacheMode) { var e = this._texture.texture; if (e instanceof Fg) { var i = e.getPixelFormat(); t = 1026 === i || 1025 === i || 1024 === i } } this._instanceMaterialType = t ? 3 : 1, this.updateMaterial() } }, i._updateBlendFunc = function () { t.prototype._updateBlendFunc.call(this) }, n(e, [{ key: "string", get: function () { return this._string }, set: function (t) { t = null == t ? "" : t.toString(), this._string !== t && (this._string = t, this._markForUpdateRenderData()) } }, { key: "horizontalAlign", get: function () { return this._horizontalAlign }, set: function (t) { this._horizontalAlign !== t && (this._horizontalAlign = t, this._markForUpdateRenderData()) } }, { key: "verticalAlign", get: function () { return this._verticalAlign }, set: function (t) { this._verticalAlign !== t && (this._verticalAlign = t, this._markForUpdateRenderData()) } }, { key: "actualFontSize", get: function () { return this._actualFontSize }, set: function (t) { this._actualFontSize = t } }, { key: "fontSize", get: function () { return this._fontSize }, set: function (t) { this._fontSize !== t && (this._fontSize = t, this._markForUpdateRenderData()) } }, { key: "lineHeight", get: function () { return this._lineHeight }, set: function (t) { this._lineHeight !== t && (this._lineHeight = t, this._markForUpdateRenderData()) } }, { key: "spacingX", get: function () { return this._spacingX }, set: function (t) { this._spacingX !== t && (this._spacingX = t, this._markForUpdateRenderData()) } }, { key: "overflow", get: function () { return this._overflow }, set: function (t) { this._overflow !== t && (this._overflow = t, this._markForUpdateRenderData()) } }, { key: "enableWrapText", get: function () { return this._enableWrapText }, set: function (t) { this._enableWrapText !== t && (this._enableWrapText = t, this._markForUpdateRenderData()) } }, { key: "useSystemFont", get: function () { return this._isSystemFontUsed }, set: function (t) { this._isSystemFontUsed !== t && (this.destroyRenderData(), this._isSystemFontUsed = !!t, t && (this.font = null), this._flushAssembler(), this._markForUpdateRenderData()) } }, { key: "fontFamily", get: function () { return this._fontFamily }, set: function (t) { this._fontFamily !== t && (this._fontFamily = t, this._markForUpdateRenderData()) } }, { key: "font", get: function () { return this._font }, set: function (t) { this._font !== t && (this._isSystemFontUsed = !t, this._font = t, this.destroyRenderData(), this._fontAtlas = null, this.updateRenderData(!0)) } }, { key: "cacheMode", get: function () { return this._cacheMode }, set: function (t) { var e = this._cacheMode; e !== t && (1 !== e || this._font instanceof EL || !this._ttfSpriteFrame || this._ttfSpriteFrame._resetDynamicAtlasFrame(), 2 === e && (this._ttfSpriteFrame = null, this.destroyLetterTexture()), this._cacheMode = t, this.updateRenderData(!0)) } }, { key: "isBold", get: function () { return this._isBold }, set: function (t) { this._isBold !== t && (this._isBold = t, this._markForUpdateRenderData()) } }, { key: "isItalic", get: function () { return this._isItalic }, set: function (t) { this._isItalic !== t && (this._isItalic = t, this._markForUpdateRenderData()) } }, { key: "isUnderline", get: function () { return this._isUnderline }, set: function (t) { this._isUnderline !== t && (this._isUnderline = t, this._markForUpdateRenderData()) } }, { key: "underlineHeight", get: function () { return this._underlineHeight }, set: function (t) { this._underlineHeight !== t && (this._underlineHeight = t, this._markForUpdateRenderData()) } }, { key: "enableOutline", get: function () { return this._enableOutline }, set: function (t) { this._enableOutline !== t && (this._enableOutline = t, this._markForUpdateRenderData()) } }, { key: "outlineColor", get: function () { return this._outlineColor }, set: function (t) { this._outlineColor !== t && (this._outlineColor.set(t), this._markForUpdateRenderData()) } }, { key: "outlineWidth", get: function () { return this._outlineWidth }, set: function (t) { this._outlineWidth !== t && (this._outlineWidth = t, this._markForUpdateRenderData()) } }, { key: "enableShadow", get: function () { return this._enableShadow }, set: function (t) { this._enableShadow !== t && (this._enableShadow = t, this._markForUpdateRenderData()) } }, { key: "shadowColor", get: function () { return this._shadowColor }, set: function (t) { this._shadowColor !== t && (this._shadowColor.set(t), this._markForUpdateRenderData()) } }, { key: "shadowOffset", get: function () { return this._shadowOffset }, set: function (t) { this._shadowOffset !== t && (this._shadowOffset.set(t), this._markForUpdateRenderData()) } }, { key: "shadowBlur", get: function () { return this._shadowBlur }, set: function (t) { this._shadowBlur !== t && (this._shadowBlur = t, this._markForUpdateRenderData()) } }, { key: "spriteFrame", get: function () { return this._texture } }, { key: "ttfSpriteFrame", get: function () { return this._ttfSpriteFrame } }, { key: "assemblerData", get: function () { return this._assemblerData } }, { key: "fontAtlas", get: function () { return this._fontAtlas }, set: function (t) { this._fontAtlas = t } }, { key: "_bmFontOriginalSize", get: function () { return this._font instanceof EL ? this._font.fontSize : -1 } }, { key: "textStyle", get: function () { return this._textStyle } }, { key: "textLayout", get: function () { return this._textLayout } }, { key: "textRenderData", get: function () { return this._textRenderData } }, { key: "textLayoutData", get: function () { return this._textLayoutData } }, { key: "contentWidth", get: function () { return this._contentWidth }, set: function (t) { this._contentWidth = t } }]), e }(GF), xk.HorizontalAlign = Ak, xk.VerticalAlign = Ck, xk.Overflow = Dk, xk.CacheMode = Rk, xk._canvasPool = DL.getInstance(), m((ZF = xk).prototype, "horizontalAlign", [jF], Object.getOwnPropertyDescriptor(ZF.prototype, "horizontalAlign"), ZF.prototype), m(ZF.prototype, "verticalAlign", [XF], Object.getOwnPropertyDescriptor(ZF.prototype, "verticalAlign"), ZF.prototype), m(ZF.prototype, "overflow", [qF], Object.getOwnPropertyDescriptor(ZF.prototype, "overflow"), ZF.prototype), m(ZF.prototype, "font", [YF], Object.getOwnPropertyDescriptor(ZF.prototype, "font"), ZF.prototype), m(ZF.prototype, "cacheMode", [KF], Object.getOwnPropertyDescriptor(ZF.prototype, "cacheMode"), ZF.prototype), JF = Bu(ZF.prototype, "_string", [eh], (function () { return "label" })), $F = Bu(ZF.prototype, "_horizontalAlign", [eh], (function () { return 1 })), tk = Bu(ZF.prototype, "_verticalAlign", [eh], (function () { return 1 })), ek = Bu(ZF.prototype, "_actualFontSize", [eh], (function () { return 0 })), ik = Bu(ZF.prototype, "_fontSize", [eh], (function () { return 40 })), nk = Bu(ZF.prototype, "_fontFamily", [eh], (function () { return "Arial" })), rk = Bu(ZF.prototype, "_lineHeight", [eh], (function () { return 40 })), sk = Bu(ZF.prototype, "_overflow", [eh], (function () { return 0 })), ak = Bu(ZF.prototype, "_enableWrapText", [eh], (function () { return !0 })), ok = Bu(ZF.prototype, "_font", [eh], (function () { return null })), uk = Bu(ZF.prototype, "_isSystemFontUsed", [eh], (function () { return !0 })), hk = Bu(ZF.prototype, "_spacingX", [eh], (function () { return 0 })), ck = Bu(ZF.prototype, "_isItalic", [eh], (function () { return !1 })), lk = Bu(ZF.prototype, "_isBold", [eh], (function () { return !1 })), fk = Bu(ZF.prototype, "_isUnderline", [eh], (function () { return !1 })), dk = Bu(ZF.prototype, "_underlineHeight", [eh], (function () { return 2 })), pk = Bu(ZF.prototype, "_cacheMode", [eh], (function () { return 0 })), _k = Bu(ZF.prototype, "_enableOutline", [eh], (function () { return !1 })), gk = Bu(ZF.prototype, "_outlineColor", [eh], (function () { return new rr(0, 0, 0, 255) })), mk = Bu(ZF.prototype, "_outlineWidth", [eh], (function () { return 2 })), vk = Bu(ZF.prototype, "_enableShadow", [eh], (function () { return !1 })), yk = Bu(ZF.prototype, "_shadowColor", [eh], (function () { return new rr(0, 0, 0, 255) })), bk = Bu(ZF.prototype, "_shadowOffset", [eh], (function () { return new as(2, 2) })), wk = Bu(ZF.prototype, "_shadowBlur", [eh], (function () { return 2 })), QF = ZF)) || QF) || QF); t({ Label: Zk, LabelComponent: Zk }), S.Label = Zk; var Jk = { SIMPLE: 0, SLICED: 1, TILED: 2, FILLED: 3 }; De(Jk); var $k = { HORIZONTAL: 0, VERTICAL: 1, RADIAL: 2 }; De($k); var tN = { CUSTOM: 0, TRIMMED: 1, RAW: 2 }; De(tN); var eN, iN = (Pk = Gu("cc.Sprite"), Bk = Wu(110), Mk = Ih(bO), Ok = Ih(vO), Lk = Ih(Jk), Fk = Ih($k), kk = Ih(tN), Pk(Nk = Bk((Qk = function (t) { function e() { var e; return (e = t.call(this) || this)._spriteFrame = Uk && Uk(), e._type = Vk && Vk(), e._fillType = Gk && Gk(), e._sizeMode = Hk && Hk(), e._fillCenter = Wk && Wk(), e._fillStart = jk && jk(), e._fillRange = Xk && Xk(), e._isTrimmedMode = qk && qk(), e._useGrayscale = Yk && Yk(), e._atlas = Kk && Kk(), e } s(e, t); var i = e.prototype; return i.__preload = function () { this.changeMaterialForDefine(), t.prototype.__preload.call(this) }, i.onEnable = function () { t.prototype.onEnable.call(this), this._activateMaterial(); var e = this._spriteFrame; e && (this._updateUVs(), 1 === this._type && e.on("uv_updated", this._updateUVs, this)) }, i.onDisable = function () { t.prototype.onDisable.call(this), this._spriteFrame && 1 === this._type && this._spriteFrame.off("uv_updated", this._updateUVs, this) }, i.onDestroy = function () { t.prototype.onDestroy.call(this) }, i.changeSpriteFrameFromAtlas = function (t) { if (this._atlas) { var e = this._atlas.getSpriteFrame(t); this.spriteFrame = e } else it(16377) }, i.changeMaterialForDefine = function () { var t, e = this._instanceMaterialType; this._spriteFrame && (t = this._spriteFrame.texture); var i = !1; if (t instanceof Fg) { var n = t.getPixelFormat(); i = 1026 === n || 1025 === n || 1024 === n } i && this.grayscale ? this._instanceMaterialType = 4 : i ? this._instanceMaterialType = 3 : this.grayscale ? this._instanceMaterialType = 2 : this._instanceMaterialType = 1, e !== this._instanceMaterialType && this.updateMaterial() }, i._updateBuiltinMaterial = function () { var e = t.prototype._updateBuiltinMaterial.call(this); if (this.spriteFrame && this.spriteFrame.texture instanceof KR) { var i = new gT; i.copy(e, { defines: { SAMPLE_FROM_RT: !0 } }), e = i } return e }, i._render = function (t) { t.commitComp(this, this.renderData, this._spriteFrame, this._assembler, null) }, i._canRender = function () { if (!t.prototype._canRender.call(this)) return !1; var e = this._spriteFrame; return !(!e || !e.texture) }, i._flushAssembler = function () { var t = this, i = e.Assembler.getAssembler(t); t._assembler !== i && (t.destroyRenderData(), t._assembler = i), t._renderData || i && i.createData && ((t._renderData = i.createData(t)).material = t.getRenderMaterial(0), t._markForUpdateRenderData(), t.spriteFrame && i.updateUVs(t), t._updateColor()); var n = t._spriteFrame; n && (1 === t._type ? n.on("uv_updated", t._updateUVs, t) : n.off("uv_updated", t._updateUVs, t)) }, i._applySpriteSize = function () { var t = this, e = t._spriteFrame; if (e) { var i = t.node._uiProps; if (2 === t._sizeMode) { var n = e.originalSize; i.uiTransformComp.setContentSize(n) } else if (1 === t._sizeMode) { var r = e.rect; i.uiTransformComp.setContentSize(r.width, r.height) } } }, i._resized = function () { }, i._activateMaterial = function () { var t = this._spriteFrame, e = this.getRenderMaterial(0); t && e && this._markForUpdateRenderData(), this.renderData && (this.renderData.material = e) }, i._updateUVs = function () { this._assembler && this._assembler.updateUVs(this) }, i._applySpriteFrame = function (t) { var e = this, i = e._spriteFrame; t && 1 === e._type && t.off("uv_updated", e._updateUVs, e); var n = !1; i && (t && t.texture === i.texture || (n = !0), n && (e.renderData && (e.renderData.textureDirty = !0), (!!t && t.texture instanceof KR) != i.texture instanceof KR && (e._instanceMaterialType = -1), e.changeMaterialForDefine()), e._applySpriteSize(), 1 === e._type && i.on("uv_updated", e._updateUVs, e)) }, n(e, [{ key: "spriteAtlas", get: function () { return this._atlas }, set: function (t) { this._atlas !== t && (this._atlas = t) } }, { key: "spriteFrame", get: function () { return this._spriteFrame }, set: function (t) { if (this._spriteFrame !== t) { var e = this._spriteFrame; this._spriteFrame = t, this._markForUpdateRenderData(), this._applySpriteFrame(e) } } }, { key: "type", get: function () { return this._type }, set: function (t) { this._type !== t && (this._type = t, this._flushAssembler()) } }, { key: "fillType", get: function () { return this._fillType }, set: function (t) { this._fillType !== t && (2 === t || 2 === this._fillType ? this.destroyRenderData() : this.renderData && this._markForUpdateRenderData(!0)), this._fillType = t, this._flushAssembler() } }, { key: "fillCenter", get: function () { return this._fillCenter }, set: function (t) { this._fillCenter.x = t.x, this._fillCenter.y = t.y, 3 === this._type && this.renderData && this._markForUpdateRenderData() } }, { key: "fillStart", get: function () { return this._fillStart }, set: function (t) { this._fillStart = Xi(t, 0, 1), 3 === this._type && this.renderData && (this._markForUpdateRenderData(), this._updateUVs()) } }, { key: "fillRange", get: function () { return this._fillRange }, set: function (t) { this._fillRange = Xi(t, -1, 1), 3 === this._type && this.renderData && (this._markForUpdateRenderData(), this._updateUVs()) } }, { key: "trim", get: function () { return this._isTrimmedMode }, set: function (t) { this._isTrimmedMode !== t && (this._isTrimmedMode = t, 0 === this._type && this.renderData && this._markForUpdateRenderData(!0)) } }, { key: "grayscale", get: function () { return this._useGrayscale }, set: function (t) { this._useGrayscale !== t && (this._useGrayscale = t, this.changeMaterialForDefine(), this.updateMaterial()) } }, { key: "sizeMode", get: function () { return this._sizeMode }, set: function (t) { this._sizeMode !== t && (this._sizeMode = t, 0 !== t && this._applySpriteSize()) } }]), e }(GF), Qk.FillType = $k, Qk.Type = Jk, Qk.SizeMode = tN, Qk.EventType = { SPRITE_FRAME_CHANGED: "spriteframe-changed" }, m((zk = Qk).prototype, "spriteAtlas", [Mk], Object.getOwnPropertyDescriptor(zk.prototype, "spriteAtlas"), zk.prototype), m(zk.prototype, "spriteFrame", [Ok], Object.getOwnPropertyDescriptor(zk.prototype, "spriteFrame"), zk.prototype), m(zk.prototype, "type", [Lk], Object.getOwnPropertyDescriptor(zk.prototype, "type"), zk.prototype), m(zk.prototype, "fillType", [Fk], Object.getOwnPropertyDescriptor(zk.prototype, "fillType"), zk.prototype), m(zk.prototype, "sizeMode", [kk], Object.getOwnPropertyDescriptor(zk.prototype, "sizeMode"), zk.prototype), Uk = Bu(zk.prototype, "_spriteFrame", [eh], (function () { return null })), Vk = Bu(zk.prototype, "_type", [eh], (function () { return 0 })), Gk = Bu(zk.prototype, "_fillType", [eh], (function () { return 0 })), Hk = Bu(zk.prototype, "_sizeMode", [eh], (function () { return 1 })), Wk = Bu(zk.prototype, "_fillCenter", [eh], (function () { return new as(0, 0) })), jk = Bu(zk.prototype, "_fillStart", [eh], (function () { return 0 })), Xk = Bu(zk.prototype, "_fillRange", [eh], (function () { return 0 })), qk = Bu(zk.prototype, "_isTrimmedMode", [eh], (function () { return !0 })), Yk = Bu(zk.prototype, "_useGrayscale", [eh], (function () { return !1 })), Kk = Bu(zk.prototype, "_atlas", [eh], (function () { return null })), Nk = zk)) || Nk) || Nk); t({ Sprite: iN, SpriteComponent: iN }), S.Sprite = iN; var nN, rN = Gu("cc.UIMeshRenderer")(eN = Wu(110)(eN = function (t) { function e() { var e; return (e = t.call(this) || this)._modelComponent = null, e._dirtyVersion = -1, e._internalId = -1, e.stencilStage = 0, e._renderData = null, e._renderEntity = new VF(1), e } s(e, t); var i = e.prototype; return i.__preload = function () { this.node._uiProps.uiComp = this }, i.onEnable = function () { oB.addRenderer(this), this._markForUpdateRenderData() }, i.onDisable = function () { oB.removeRenderer(this), this.renderEntity.enabled = this._canRender() }, i.onLoad = function () { this.node._getUITransformComp() || this.node.addComponent("cc.UITransform"), this._modelComponent = this.getComponent("cc.ModelRenderer"), this._modelComponent ? this.renderEntity.setNode(this.node) : it(16378, this.node ? this.node.name : "") }, i.onDestroy = function () { this.renderEntity.setNode(null), this.node._uiProps.uiComp === this && (this.node._uiProps.uiComp = null), this._modelComponent = this.getComponent("cc.ModelRenderer"), this._modelComponent && (this._modelComponent._sceneGetter = null) }, i._render = function (t) { if (this._modelComponent) { var e = this._modelComponent._collectModels(); this._modelComponent._detachFromScene(); for (var i = 0; i < e.length; i++)e[i].enabled && t.commitModel(this, e[i], this._modelComponent.material); return !0 } return !1 }, i.fillBuffers = function (t) { this.enabled && this._render(t) }, i.updateRenderer = function () { }, i._uploadRenderData = function () { }, i.postUpdateAssembler = function () { }, i.update = function () { this._fitUIRenderQueue() }, i._fitUIRenderQueue = function () { if (this._modelComponent) for (var t = this._modelComponent.sharedMaterials.length, e = 0; e < t; e++) { var i = this._modelComponent.getMaterialInstance(e); if (null != i) for (var n = i.passes, r = n.length, s = 0; s < r; s++)n[s].setPriority(244), i.recompileShaders({ CC_FORCE_FORWARD_SHADING: !0 }, s) } }, i.markForUpdateRenderData = function (t) { void 0 === t && (t = !0), this._markForUpdateRenderData(t) }, i._markForUpdateRenderData = function () { oB.markDirtyRenderer(this) }, i.setNodeDirty = function () { }, i.setTextureDirty = function () { }, i._canRender = function () { return this.enabled && null !== this._modelComponent }, n(e, [{ key: "modelComponent", get: function () { return this._modelComponent } }, { key: "renderEntity", get: function () { return this._renderEntity } }, { key: "renderData", get: function () { return this._renderData } }]), e }(am)) || eN) || eN; t({ UIMeshRenderer: rN, UIModelComponent: rN }), S.UIMeshRenderer = rN; var sN = Gu("cc.LabelOutline")(nN = Wu(110)(nN = Hu(Zk)(nN = function (t) { function e() { return t.apply(this, arguments) || this } s(e, t); var i = e.prototype; return i.onEnable = function () { this.node.getComponent(Zk).enableOutline = !0 }, i.onDisable = function () { this.node.getComponent(Zk).enableOutline = !1 }, n(e, [{ key: "color", get: function () { return this.node.getComponent(Zk).outlineColor }, set: function (t) { this.node.getComponent(Zk).outlineColor = t } }, { key: "width", get: function () { return this.node.getComponent(Zk).outlineWidth }, set: function (t) { this.node.getComponent(Zk).outlineWidth = t } }]), e }(am)) || nN) || nN) || nN; t({ LabelOutline: sN, LabelOutlineComponent: sN }), S.LabelOutline = sN; var aN, oN, uN, hN = Iv.Enum.NONE | Iv.Enum.UI_3D, cN = function () { function t() { this.model = null, this.texture = null, this.sampler = null, this.useLocalData = null, this.isStatic = !1, this.textureHash = 0, this.samplerHash = 0, this._passes = [], this._shaders = [], this.visFlags = hN, this.inputAssembler = null, this.descriptorSet = null } var e = t.prototype; return e.destroy = function () { this._passes = [] }, e.clear = function () { this.inputAssembler = null, this.descriptorSet = null, this.texture = null, this.sampler = null, this.textureHash = 0, this.samplerHash = 0, this.model = null, this.isStatic = !1, this.useLocalData = null, this.visFlags = hN }, e.fillPasses = function (t, e, i, n) { if (t) { var r = t.passes; if (!r) return; this._shaders.length = r.length; for (var s = 0; s < r.length; s++) { this._passes[s] || (this._passes[s] = new tT(S.director.root)); var a = r[s], o = this._passes[s]; a.update(), e || (e = a.depthStencilState, i = 0), o._initPassFromTarget(a, e, i), this._shaders[s] = o.getShaderVariant(n) } } }, n(t, [{ key: "passes", get: function () { return this._passes } }, { key: "shaders", get: function () { return this._shaders } }]), t }(), lN = Gu("cc.UIStaticBatch")(aN = Wu(110)((oN = function (t) { function e() { var e; return (e = t.call(this) || this)._init = !1, e._bufferAccessor = null, e._dirty = !0, e._uiDrawBatchList = [], e } s(e, t); var i = e.prototype; return i.postUpdateAssembler = function () { }, i.markAsDirty = function () { }, i._requireDrawBatch = function () { var t = new cN; return t.isStatic = !0, this._uiDrawBatchList.push(t), t }, i._clearData = function () { if (this._bufferAccessor) { this._bufferAccessor.reset(); for (var t = this._getBatcher(), e = 0; e < this._uiDrawBatchList.length; e++)this._uiDrawBatchList[e].destroy(t) } this._uiDrawBatchList.length = 0, this._init = !1 }, i._getBatcher = function () { return yB.root && yB.root.batcher2D ? yB.root.batcher2D : (it(9301), null) }, n(e, [{ key: "color", get: function () { return this._color }, set: function (t) { this._color !== t && this._color.set(t) } }, { key: "drawBatchList", get: function () { return this._uiDrawBatchList } }]), e }(GF), m(oN.prototype, "color", [Oh], Object.getOwnPropertyDescriptor(oN.prototype, "color"), oN.prototype), aN = oN)) || aN) || aN; t({ UIStaticBatch: lN, UIStaticBatchComponent: lN }); var fN, dN, pN, _N = t("LabelShadow", Gu("cc.LabelShadow")(uN = Wu(110)(uN = Hu(Zk)(uN = function (t) { function e() { return t.apply(this, arguments) || this } s(e, t); var i = e.prototype; return i.onEnable = function () { this.node.getComponent(Zk).enableShadow = !0 }, i.onDisable = function () { this.node.getComponent(Zk).enableShadow = !1 }, n(e, [{ key: "color", get: function () { return this.node.getComponent(Zk).shadowColor }, set: function (t) { this.node.getComponent(Zk).shadowColor = t } }, { key: "offset", get: function () { return this.node.getComponent(Zk).shadowOffset }, set: function (t) { this.node.getComponent(Zk).shadowOffset = t } }, { key: "blur", get: function () { return this.node.getComponent(Zk).shadowBlur }, set: function (t) { this.node.getComponent(Zk).shadowBlur = t } }]), e }(am)) || uN) || uN) || uN), gN = Gu("cc.UIOpacity")(fN = Wu(110)(fN = ju((dN = function (t) { function e() { var e; return (e = t.call(this) || this)._parentOpacity = 1, e._parentOpacityResetFlag = !0, e._opacity = pN && pN(), e } s(e, t); var i = e.prototype; return i._setParentOpacity = function (t) { this._parentOpacity = t }, i._getParentOpacity = function (t) { if (null == t || !t.isValid) return 1; var i = t._uiProps.uiComp, n = t.getComponent(e); return i && i.color ? 1 : n ? n._parentOpacity * (n._opacity / 255) : this._getParentOpacity(t.getParent()) }, i._parentChanged = function () { }, i._setEntityLocalOpacityRecursively = function () { }, i.onEnable = function () { this.node.on("parent-changed", this._parentChanged, this), this.node._uiProps.localOpacity = this._parentOpacity * this._opacity / 255, this._parentOpacityResetFlag ? (this._parentChanged(), this._parentOpacityResetFlag = !1) : this._setEntityLocalOpacityRecursively(this.node._uiProps.localOpacity) }, i.onDisable = function () { this.node.off("parent-changed", this._parentChanged, this), this.node._uiProps.localOpacity = 1, this._setEntityLocalOpacityRecursively(this.node._uiProps.localOpacity) }, n(e, [{ key: "opacity", get: function () { return this._opacity }, set: function (t) { this._opacity !== t && (t = Xi(t, 0, 255), this._opacity = t, this.node._uiProps.localOpacity = t / 255) } }]), e }(am), pN = Bu(dN.prototype, "_opacity", [eh], (function () { return 255 })), fN = dN)) || fN) || fN) || fN; function mN(t) { return --t, t |= t >> 16, t |= t >> 8, t |= t >> 4, t |= t >> 2, t |= t >> 1, ++t } function vN(t, e) { return Math.ceil(t / e) * e } t({ UIOpacity: gN, UIOpacityComponent: gN }); var yN = function () { function t(t) { this._format = 0, this._formatSize = 0, this._chunks = [], this._chunkCount = 0, this._handles = [], this._region0 = new Wd, this._region1 = new Wd, this._region2 = new Wd, this._roundUpFn = null, this._bufferViewCtor = Uint8Array, this._channels = 4, this._alignment = 1, this._device = t } var e = t.prototype; return e.initialize = function (t) { var e = Wp[t.format]; this._format = t.format, this._formatSize = e.size, this._channels = e.count, this._bufferViewCtor = $p(e), this._roundUpFn = t.roundUpFn || null, this._alignment = t.alignment || 1, t.inOrderFree && (this.alloc = this._McDonaldAlloc) }, e.destroy = function () { for (var t = 0; t < this._chunkCount; ++t)this._chunks[t].texture.destroy(); this._chunks.length = 0, this._handles.length = 0 }, e.alloc = function (t, e) { t = vN(t, this._alignment); var i = -1, n = -1; if (void 0 !== e && (i = e, n = this._findAvailableSpace(t, i)), n < 0) for (var r = 0; r < this._chunkCount && (i = r, !((n = this._findAvailableSpace(t, i)) >= 0)); ++r); if (n >= 0) { var s = this._chunks[i]; s.start += t; var a = { chunkIdx: i, start: n, end: n + t, texture: s.texture }; return this._handles.push(a), a } var o = Math.sqrt(t / this._formatSize), u = this._roundUpFn && this._roundUpFn(o, this._formatSize) || Math.max(1024, mN(o)), h = this._chunks[this.createChunk(u)]; h.start += t; var c = { chunkIdx: this._chunkCount - 1, start: 0, end: t, texture: h.texture }; return this._handles.push(c), c }, e.free = function (t) { for (var e = 0; e < this._handles.length; ++e)if (this._handles[e] === t) return this._chunks[t.chunkIdx].end = t.end, void this._handles.splice(e, 1) }, e.createChunk = function (t) { var e = t * t * this._formatSize; q("TextureBufferPool: Allocate chunk " + this._chunkCount + ", size: " + e + ", format: " + this._format); var i = { texture: this._device.createTexture(new ip(1, 6, this._format, t, t)), size: e, start: 0, end: e }; return this._chunks[this._chunkCount] = i, this._chunkCount++ }, e.update = function (t, e) { var i = [], n = [], r = t.start / this._formatSize, s = e.byteLength / this._formatSize, a = r % t.texture.width, o = Math.floor(r / t.texture.width), u = Math.min(t.texture.width - a, s), h = 0; a > 0 && (this._region0.texOffset.x = a, this._region0.texOffset.y = o, this._region0.texExtent.width = u, this._region0.texExtent.height = 1, i.push(new this._bufferViewCtor(e, h * this._formatSize, u * this._channels)), n.push(this._region0), a = 0, o += 1, s -= u, h += u), s > 0 && (this._region1.texOffset.x = a, this._region1.texOffset.y = o, s > t.texture.width ? (this._region1.texExtent.width = t.texture.width, this._region1.texExtent.height = Math.floor(s / t.texture.width), u = this._region1.texExtent.width * this._region1.texExtent.height) : (u = s, this._region1.texExtent.width = u, this._region1.texExtent.height = 1), i.push(new this._bufferViewCtor(e, h * this._formatSize, u * this._channels)), n.push(this._region1), a = 0, o += this._region1.texExtent.height, s -= u, h += u), s > 0 && (this._region2.texOffset.x = a, this._region2.texOffset.y = o, this._region2.texExtent.width = s, this._region2.texExtent.height = 1, i.push(new this._bufferViewCtor(e, h * this._formatSize, s * this._channels)), n.push(this._region2)), this._device.copyBuffersToTexture(i, t.texture, n) }, e._findAvailableSpace = function (t, e) { var i = this._chunks[e], n = !1, r = i.start; if (r + t <= i.size) n = !0; else { r = 0; for (var s = this._handles.filter((function (t) { return t.chunkIdx === e })).sort((function (t, e) { return t.start - e.start })), a = 0; a < s.length; a++) { var o = s[a]; if (r + t <= o.start) { n = !0; break } r = o.end } !n && r + t <= i.size && (n = !0) } return n ? r : -1 }, e._McDonaldAlloc = function (t) { t = vN(t, this._alignment); for (var e = 0; e < this._chunkCount; ++e) { var i = this._chunks[e], n = !1, r = i.start; if (r + t <= i.end ? n = !0 : r > i.end ? r + t <= i.size ? n = !0 : t <= i.end && (i.start = r = 0, n = !0) : r === i.end && (i.start = r = 0, i.end = i.size, t <= i.end && (n = !0)), n) { i.start += t; var s = { chunkIdx: e, start: r, end: r + t, texture: i.texture }; return this._handles.push(s), s } } var a = Math.sqrt(t / this._formatSize), o = this._roundUpFn && this._roundUpFn(a, this._formatSize) || Math.max(1024, mN(a)), u = this._chunks[this.createChunk(o)]; u.start += t; var h = { chunkIdx: this._chunkCount, start: 0, end: t, texture: u.texture }; return this._handles.push(h), h }, t }(); ft(rP.prototype, "RenderScene.prototype", [{ name: "raycastUI2DNode" }, { name: "raycastUINode" }]), ft(rP.prototype, "RenderScene.prototype", [{ name: "raycastAll", suggest: "using intersect.rayModel in geometry" }, { name: "raycastAllModels", suggest: "using intersect.rayModel in geometry" }, { name: "raycastSingleModel", suggest: "using intersect.rayModel in geometry" }, { name: "raycastAllCanvas", suggest: "using intersect.rayAABB in geometry" }, { name: "rayResultCanvas" }, { name: "rayResultModels" }, { name: "rayResultAll" }, { name: "rayResultSingleModel" }]), ft(TR.prototype, "Model.prototype", [{ name: "isInstancingEnabled" }, { name: "instancedAttributes" }]); var bN = {}; ft(bN, "CameraVisFlags", [{ name: "GENERAL" }]), lt(bN, "CameraVisFlags", [{ name: "PROFILER", newName: "PROFILER", target: Iv.BitMask, targetName: "PROFILER" }, { name: "GIZMOS", newName: "GIZMOS", target: Iv.BitMask, targetName: "GIZMOS" }, { name: "EDITOR", newName: "EDITOR", target: Iv.BitMask, targetName: "EDITOR" }, { name: "UI", newName: "UI", target: Iv.BitMask, targetName: "UI_3D" }, { name: "UI2D", newName: "UI2D", target: Iv.BitMask, targetName: "UI_2D" }]), T.CameraVisFlags = bN; var wN = {}; ft(wN, "VisibilityFlags", [{ name: "GENERAL" }]), lt(wN, "VisibilityFlags", [{ name: "ALWALS", newName: "ALWALS", target: Iv.Enum, targetName: "ALWALS" }, { name: "PROFILER", newName: "PROFILER", target: Iv.Enum, targetName: "PROFILER" }, { name: "GIZMOS", newName: "GIZMOS", target: Iv.Enum, targetName: "GIZMOS" }, { name: "EDITOR", newName: "EDITOR", target: Iv.Enum, targetName: "EDITOR" }, { name: "UI", newName: "UI", target: Iv.Enum, targetName: "UI_3D" }, { name: "UI2D", newName: "UI2D", target: Iv.Enum, targetName: "UI_2D" }]), T.VisibilityFlags = wN, lt(tT.prototype, "Pass.prototype", [{ name: "getBindingTypeFromHandle", newName: "getDescriptorTypeFromHandle" }]), ft(dR.prototype, "Camera.prototype", [{ name: "getSplitFrustum" }, { name: "setMatView" }, { name: "setMatViewInv" }, { name: "setMatProjInv" }, { name: "setMatViewProjInv" }, { name: "setMatProj" }, { name: "setMatViewProj" }, { name: "getMatViewInv" }]), ft(ST.prototype, "Shadows.prototype", [{ name: "aspect" }, { name: "selfShadow" }, { name: "linear" }, { name: "packing" }, { name: "autoAdapt" }, { name: "fixedArea" }, { name: "pcf" }, { name: "bias" }, { name: "normalBias" }, { name: "near" }, { name: "far" }, { name: "shadowDistance" }, { name: "invisibleOcclusionRange" }, { name: "orthoSize" }, { name: "saturation" }]), ft(VR.prototype, "SpotLight.prototype", [{ name: "aspect" }]), lt(_R.prototype, "SubModel.prototype", [{ name: "subMeshData", newName: "subMesh" }]), ft(_R.prototype, "SubModel.prototype", [{ name: "getSubModel", suggest: "Use `subModels[i]` instead" }, { name: "subModelNum", suggest: "Use `subModels.length` instead" }]); var xN = Object.freeze({ __proto__: null, BatchingSchemes: { NONE: 0, INSTANCING: 1 }, CameraVisFlags: bN, MaterialInstance: IT, Pass: tT, PassInstance: TT, PassStage: { DEFAULT: 1, FORWARD: 2, SHADOWCAST: 4 }, RenderQueue: { OPAQUE: 0, TRANSPARENT: 1, OVERLAY: 2 }, RenderScene: rP, RenderWindow: hP, TextureBufferPool: yN, VisibilityFlags: wN, createIA: function (t, e) { if (!e.positions) return rt(16306), null; for (var i = [], n = e.positions.length / 3, r = 0; r < n; ++r)i.push(e.positions[3 * r], e.positions[3 * r + 1], e.positions[3 * r + 2]), e.normals && i.push(e.normals[3 * r], e.normals[3 * r + 1], e.normals[3 * r + 2]), e.uvs && i.push(e.uvs[2 * r], e.uvs[2 * r + 1]), e.colors && i.push(e.colors[3 * r], e.colors[3 * r + 1], e.colors[3 * r + 2]); var s = []; s.push(new pp("a_position", 32)), e.normals && s.push(new pp("a_normal", 32)), e.uvs && s.push(new pp("a_texCoord", 21)), e.colors && s.push(new pp("a_color", 32)); var a = t.createBuffer(new Zd(10, 1, 4 * i.length, 4 * i.length / n)); a.update(new Float32Array(i)); var o = null; return e.indices && (o = t.createBuffer(new Zd(6, 1, 2 * e.indices.length, 2))).update(new Uint16Array(e.indices)), t.createInputAssembler(new gp(s, [a], o)) }, customizeType: Mw, genHandle: Cw, getBindingFromHandle: Rw, getCountFromHandle: Pw, getDefaultFromType: Nw, getDeviceShaderVersion: rx, getOffsetFromHandle: Bw, getStringFromType: zw, getTypeFromHandle: Dw, nearestPOT: mN, overrideMacros: Uw, programLib: fx, scene: nP, type2reader: Ow, type2validator: Fw, type2writer: Lw }); t("renderer", xN); var SN = { BUTT: 0, ROUND: 1, SQUARE: 2 }; De(SN); var TN = { BEVEL: 0, ROUND: 1, MITER: 2 }; De(TN), De({ PT_CORNER: 1, PT_LEFT: 2, PT_BEVEL: 4, PT_INNERBEVEL: 8 }); var IN = Math.PI, EN = Math.min, AN = Math.max, CN = Math.cos, DN = Math.sin, RN = Math.abs, PN = Math.sign, BN = .5522847493; function MN(t, e, i, n, r, s, a) { var o, u, h = 0, c = 0, l = 0, f = 0, d = 0, p = 0, _ = 0, g = 0, m = 0, v = 0, y = 0, b = 0, w = 0, x = 0; if (c = s - r, a = a || !1) if (RN(c) >= 2 * IN) c = 2 * IN; else for (; c < 0;)c += 2 * IN; else if (RN(c) >= 2 * IN) c = 2 * -IN; else for (; c > 0;)c -= 2 * IN; for (u = 0 | AN(1, EN(RN(c) / (.5 * IN) + .5, 5)), l = RN(4 / 3 * (1 - CN(o = c / u / 2)) / DN(o)), a || (l = -l), x = 0; x <= u; x++)p = e + (f = CN(h = r + c * (x / u))) * n, _ = i + (d = DN(h)) * n, g = -d * n * l, m = f * n * l, 0 === x ? t.moveTo(p, _) : t.bezierCurveTo(v + b, y + w, p - g, _ - m, p, _), v = p, y = _, b = g, w = m } function ON(t, e, i, n, r) { t.moveTo(e - n, i), t.bezierCurveTo(e - n, i + r * BN, e - n * BN, i + r, e, i + r), t.bezierCurveTo(e + n * BN, i + r, e + n, i + r * BN, e + n, i), t.bezierCurveTo(e + n, i - r * BN, e + n * BN, i - r, e, i - r), t.bezierCurveTo(e - n * BN, i - r, e - n, i - r * BN, e - n, i), t.close() } function LN(t, e, i, n, r, s) { if (s < .1) t.rect(e, i, n, r); else { var a = EN(s, .5 * RN(n)) * PN(n), o = EN(s, .5 * RN(r)) * PN(r); t.moveTo(e, i + o), t.lineTo(e, i + r - o), t.bezierCurveTo(e, i + r - o * (1 - BN), e + a * (1 - BN), i + r, e + a, i + r), t.lineTo(e + n - a, i + r), t.bezierCurveTo(e + n - a * (1 - BN), i + r, e + n, i + r - o * (1 - BN), e + n, i + r - o), t.lineTo(e + n, i + o), t.bezierCurveTo(e + n, i + o * (1 - BN), e + n - a * (1 - BN), i, e + n - a, i), t.lineTo(e + a, i), t.bezierCurveTo(e + a * (1 - BN), i, e, i + o * (1 - BN), e, i + o), t.close() } } function FN(t, e, i, n, r, s, a, o, u, h, c) { var l, f, d, p, _, g, m, v, y, b, w, x, S, T, I, E; h > 10 || (_ = .5 * (s + o), g = .5 * (a + u), m = .5 * ((l = .5 * (e + n)) + (d = .5 * (n + s))), v = .5 * ((f = .5 * (i + r)) + (p = .5 * (r + a))), ((I = RN((n - o) * (T = u - i) - (r - u) * (S = o - e))) + (E = RN((s - o) * T - (a - u) * S))) * (I + E) < t.tessTol * (S * S + T * T) ? t.addPoint(o, u, 0 === c ? 4 | c : c) : (FN(t, e, i, l, f, m, v, w = .5 * (m + (y = .5 * (d + _))), x = .5 * (v + (b = .5 * (p + g))), h + 1, 0), FN(t, w, x, y, b, _, g, o, u, h + 1, c))) } var kN, NN, zN, UN, VN, GN, HN, WN, jN, XN, qN, YN, KN, QN, ZN, JN, $N, tz, ez, iz, nz, rz, sz, az = function (t) { function e(e, i) { var n; return (n = t.call(this, e, i) || this).dx = 0, n.dy = 0, n.dmx = 0, n.dmy = 0, n.flags = 0, n.len = 0, n } return s(e, t), e.prototype.reset = function () { this.dx = 0, this.dy = 0, this.dmx = 0, this.dmy = 0, this.flags = 0, this.len = 0 }, e }(as), oz = function () { function t() { this.closed = !1, this.bevel = 0, this.complex = !0, this.points = [] } return t.prototype.reset = function () { this.closed = !1, this.bevel = 0, this.complex = !0, this.points.length = 0 }, t }(), uz = function () { function t(t) { this.dataOffset = 0, this.updatePathOffset = !1, this.pathLength = 0, this.pathOffset = 0, this.paths = [], this.tessTol = .25, this.distTol = .01, this.fillColor = rr.WHITE.clone(), this.lineCap = 0, this.strokeColor = rr.BLACK.clone(), this.lineJoin = 2, this.lineWidth = 0, this.pointsOffset = 0, this._commandX = 0, this._commandY = 0, this._points = [], this._renderDataList = [], this._curPath = null, this._comp = t } var e = t.prototype; return e.moveTo = function (t, e) { this.updatePathOffset && (this.pathOffset = this.pathLength, this.updatePathOffset = !1), this._addPath(), this.addPoint(t, e, 1), this._commandX = t, this._commandY = e }, e.lineTo = function (t, e) { this.addPoint(t, e, 1), this._commandX = t, this._commandY = e }, e.bezierCurveTo = function (t, e, i, n, r, s) { var a = this._curPath, o = a.points[a.points.length - 1]; o && (o.x !== t || o.y !== e || i !== r || n !== s ? (FN(this, o.x, o.y, t, e, i, n, r, s, 0, 1), this._commandX = r, this._commandY = s) : this.lineTo(r, s)) }, e.quadraticCurveTo = function (t, e, i, n) { var r = this._commandX, s = this._commandY; this.bezierCurveTo(r + 2 / 3 * (t - r), s + 2 / 3 * (e - s), i + 2 / 3 * (t - i), n + 2 / 3 * (e - n), i, n) }, e.arc = function (t, e, i, n, r, s) { MN(this, t, e, i, n, r, s) }, e.ellipse = function (t, e, i, n) { ON(this, t, e, i, n), this._curPath.complex = !1 }, e.circle = function (t, e, i) { ON(this, t, e, i, i), this._curPath.complex = !1 }, e.rect = function (t, e, i, n) { this.moveTo(t, e), this.lineTo(t + i, e), this.lineTo(t + i, e + n), this.lineTo(t, e + n), this.close(), this._curPath.complex = !1 }, e.roundRect = function (t, e, i, n, r) { LN(this, t, e, i, n, r), this._curPath.complex = !1 }, e.clear = function () { this.pathLength = 0, this.pathOffset = 0, this.pointsOffset = 0, this.dataOffset = 0, this._curPath = null, this.paths.length = 0, this._points.length = 0; for (var t = this._renderDataList, e = 0, i = t.length; e < i; e++) { var n = t[e]; n && (_F.remove(n), n.removeRenderDrawInfo(this._comp)) } this._renderDataList.length = 0 }, e.close = function () { this._curPath.closed = !0 }, e.requestRenderData = function () { var t = _F.add(); return this._renderDataList.push(t), t }, e.getRenderDataList = function () { return 0 === this._renderDataList.length && this.requestRenderData(), this._renderDataList }, e.addPoint = function (t, e, i) { var n = this._curPath; if (n) { var r = this._points, s = n.points, a = r[this.pointsOffset++]; a ? (a.x = t, a.y = e) : (a = new az(t, e), r.push(a)), a.flags = i, s.push(a) } }, e._addPath = function () { var t = this.pathLength, e = this.paths[t]; return e ? e.reset() : (e = new oz, this.paths.push(e)), this.pathLength++, this._curPath = e, e }, t }(), hz = HL.concat([new pp("a_dist", 11)]), cz = YL(hz), lz = KL(hz), fz = (kN = Gu("cc.Graphics"), NN = Wu(110), zN = Ih(TN), UN = Ih(SN), kN(VN = NN((KN = function (t) { function e() { var e; return (e = t.call(this) || this).impl = null, e.model = null, e._lineWidth = HN && HN(), e._strokeColor = WN && WN(), e._lineJoin = jN && jN(), e._lineCap = XN && XN(), e._fillColor = qN && qN(), e._miterLimit = YN && YN(), e._isDrawing = !1, e._isNeedUploadData = !0, e._graphicsUseSubMeshes = [], e._instanceMaterialType = 0, e.impl = new uz(l(e)), e } s(e, t); var i = e.prototype; return i.onRestore = function () { this.impl || this._flushAssembler() }, i.onLoad = function () { t.prototype.onLoad.call(this), this.model = yB.root.createModel(TR), this.model.node = this.model.transform = this.node, this._flushAssembler() }, i.onEnable = function () { t.prototype.onEnable.call(this), this._updateMtlForGraphics() }, i.onDestroy = function () { this._sceneGetter = null, this.model && (yB.root.destroyModel(this.model), this.model = null); var e = this._graphicsUseSubMeshes.length; if (e > 0) { for (var i = 0; i < e; ++i)this._graphicsUseSubMeshes[i].destroy(); this._graphicsUseSubMeshes.length = 0 } this.impl && (this._isDrawing = !1, this.impl.clear(), this.impl = null), t.prototype.onDestroy.call(this) }, i.moveTo = function (t, e) { this.impl && this.impl.moveTo(t, e) }, i.lineTo = function (t, e) { this.impl && this.impl.lineTo(t, e) }, i.bezierCurveTo = function (t, e, i, n, r, s) { this.impl && this.impl.bezierCurveTo(t, e, i, n, r, s) }, i.quadraticCurveTo = function (t, e, i, n) { this.impl && this.impl.quadraticCurveTo(t, e, i, n) }, i.arc = function (t, e, i, n, r, s) { this.impl && this.impl.arc(t, e, i, n, r, s) }, i.ellipse = function (t, e, i, n) { this.impl && this.impl.ellipse(t, e, i, n) }, i.circle = function (t, e, i) { this.impl && this.impl.circle(t, e, i) }, i.rect = function (t, e, i, n) { this.impl && this.impl.rect(t, e, i, n) }, i.roundRect = function (t, e, i, n, r) { this.impl && this.impl.roundRect(t, e, i, n, r) }, i.fillRect = function (t, e, i, n) { this.rect(t, e, i, n), this.fill() }, i.clear = function () { if (this.impl) { if (this.impl.clear(), this._isDrawing = !1, this.model) for (var t = 0; t < this.model.subModels.length; t++)this.model.subModels[t].inputAssembler.indexCount = 0; this._markForUpdateRenderData() } }, i.close = function () { this.impl && this.impl.close() }, i.stroke = function () { this._assembler || this._flushAssembler(), this._isDrawing = !0, this._isNeedUploadData = !0, this._assembler.stroke(this) }, i.fill = function () { this._assembler || this._flushAssembler(), this._isDrawing = !0, this._isNeedUploadData = !0, this._assembler.fill(this) }, i._updateMtlForGraphics = function () { var t; this._customMaterial ? t = this.getMaterialInstance(0) : (t = YS.get("ui-graphics-material"), this.setSharedMaterial(t, 0), (t = this.getMaterialInstance(0)).recompileShaders({ USE_LOCAL: !0 })) }, i.activeSubModel = function (t) { if (this.model) { if (this.model.subModels.length <= t) { var e = B_.gfxDevice, i = e.createBuffer(new Zd(10, 1, 65535 * lz, lz)), n = e.createBuffer(new Zd(6, 1, 262140, 2)), r = new DB([i], hz, 7, n); r.subMeshIdx = 0, this.model.initSubModel(t, r, this.getMaterialInstance(0)), this._graphicsUseSubMeshes.push(r) } } else it(4500, this.node.name) }, i._uploadData = function () { var t = this.impl; if (t) { var e = t && t.getRenderDataList(); if (!(e.length <= 0) && this.model) { for (var i = this.model.subModels, n = 0; n < e.length; n++) { var r = e[n], s = i[n].inputAssembler; if (r.lastFilledVertex !== r.vertexStart) { var a = new Float32Array(r.vData.buffer, 0, r.vertexStart * cz); s.vertexBuffers[0].update(a), s.vertexCount = r.vertexStart; var o = new Uint16Array(r.iData.buffer, 0, r.indexStart); s.indexBuffer.update(o), s.indexCount = r.indexStart, r.lastFilledVertex = r.vertexStart, r.lastFilledIndex = r.indexStart } } this._isNeedUploadData = !1 } } }, i._render = function (t) { if (this._isNeedUploadData) { if (this.impl) { var e = this.impl.getRenderDataList(), i = this.model.subModels.length; if (e.length > i) for (var n = i; n < e.length; n++)this.activeSubModel(n) } this._uploadData() } t.commitModel(this, this.model, this.getMaterialInstance(0)) }, i._flushAssembler = function () { var t = e.Assembler.getAssembler(this); this._assembler !== t && (this._assembler = t) }, i._canRender = function () { return !!t.prototype._canRender.call(this) && !!this.model && this._isDrawing }, i.updateRenderer = function () { t.prototype.updateRenderer.call(this) }, i.createRenderEntity = function () { return new VF(1) }, n(e, [{ key: "lineWidth", get: function () { return this._lineWidth }, set: function (t) { this._lineWidth = t, this.impl && (this.impl.lineWidth = t) } }, { key: "lineJoin", get: function () { return this._lineJoin }, set: function (t) { this._lineJoin = t, this.impl && (this.impl.lineJoin = t) } }, { key: "lineCap", get: function () { return this._lineCap }, set: function (t) { this._lineCap = t, this.impl && (this.impl.lineCap = t) } }, { key: "strokeColor", get: function () { return this._strokeColor }, set: function (t) { this.impl && (this._strokeColor.set(t), this.impl.strokeColor = this._strokeColor) } }, { key: "fillColor", get: function () { return this._fillColor }, set: function (t) { this.impl && (this._fillColor.set(t), this.impl.fillColor = this._fillColor) } }, { key: "miterLimit", get: function () { return this._miterLimit }, set: function (t) { this._miterLimit = t } }, { key: "color", get: function () { return this._color }, set: function (t) { this._color !== t && this._color.set(t) } }, { key: "graphicsNativeProxy", get: function () { return this._graphicsNativeProxy } }]), e }(GF), KN.LineJoin = TN, KN.LineCap = SN, m((GN = KN).prototype, "lineJoin", [zN], Object.getOwnPropertyDescriptor(GN.prototype, "lineJoin"), GN.prototype), m(GN.prototype, "lineCap", [UN], Object.getOwnPropertyDescriptor(GN.prototype, "lineCap"), GN.prototype), m(GN.prototype, "color", [Oh], Object.getOwnPropertyDescriptor(GN.prototype, "color"), GN.prototype), HN = Bu(GN.prototype, "_lineWidth", [eh], (function () { return 1 })), WN = Bu(GN.prototype, "_strokeColor", [eh], (function () { return rr.BLACK.clone() })), jN = Bu(GN.prototype, "_lineJoin", [eh], (function () { return 2 })), XN = Bu(GN.prototype, "_lineCap", [eh], (function () { return 0 })), qN = Bu(GN.prototype, "_fillColor", [eh], (function () { return rr.WHITE.clone() })), YN = Bu(GN.prototype, "_miterLimit", [eh], (function () { return 10 })), VN = GN)) || VN) || VN); t({ GraphicsComponent: fz, Graphics: fz }), S.Graphics = fz; var dz = new Gr, pz = new as, _z = new Gr, gz = []; function mz(t, e, i) { gz.length = 0; for (var n = 2 * Math.PI / i, r = 0; r < i; ++r)gz.push(new Kn(e.x * Math.cos(n * r) + t.x, e.y * Math.sin(n * r) + t.y, 0)); return gz } var vz = t("MaskType", { GRAPHICS_RECT: 0, GRAPHICS_ELLIPSE: 1, GRAPHICS_STENCIL: 2, SPRITE_STENCIL: 3 }); De(vz); var yz, bz, wz, xz, Sz, Tz, Iz = (QN = Gu("cc.Mask"), ZN = Wu(110), JN = Ih(vz), QN($N = ZN((sz = function (t) { function e() { var e; return (e = t.call(this) || this)._type = ez && ez(), e._inverted = iz && iz(), e._segments = nz && nz(), e._alphaThreshold = rz && rz(), e._sprite = null, e._graphics = null, e._stencilStage = 0, e } s(e, t); var i = e.prototype; return i.onLoad = function () { this._changeRenderType() }, i.onEnable = function () { this._changeRenderType(), this._updateGraphics(), this._enableRender(), this.node.on("anchor-changed", this._nodeStateChange, this), this.node.on("size-changed", this._nodeStateChange, this) }, i.onRestore = function () { this._changeRenderType(), this._updateGraphics() }, i.onDisable = function () { this._disableRender(), this.node.off("anchor-changed", this._nodeStateChange, this), this.node.off("size-changed", this._nodeStateChange, this) }, i.onDestroy = function () { this._removeMaskNode() }, i.isHit = function (t) { var e = this.node._getUITransformComp(), i = e.contentSize, n = i.width, r = i.height, s = pz; this.node.getWorldMatrix(dz), Gr.invert(_z, dz), as.transformMat4(s, t, _z); var a = e.anchorPoint; s.x += a.x * n, s.y += a.y * r; var o = !1; if (0 === this.type || 2 === this.type || 3 === this.type) o = s.x >= 0 && s.y >= 0 && s.x <= n && s.y <= r; else if (1 === this.type) { var u = n / 2, h = r / 2, c = s.x - .5 * n, l = s.y - .5 * r; o = c * c / (u * u) + l * l / (h * h) < 1 } return this._inverted && (o = !o), o }, i._nodeStateChange = function () { this._updateGraphics() }, i._changeRenderType = function () { 3 !== this._type ? this._createGraphics() : this._createSprite() }, i._createSprite = function () { if (!this._sprite) { var t = this._sprite = this.node.getComponent(iN); if (!t) { var e = this.node; t = this._sprite = e.addComponent(iN) } } this._sprite.stencilStage = this.inverted ? 6 : 2, this._sprite.updateMaterial() }, i._createGraphics = function () { if (!this._graphics) { var t = this._graphics = this.node.getComponent(fz); if (!t) { var e = this.node; t = this._graphics = e.addComponent(fz) } t.lineWidth = 1; var i = rr.WHITE.clone(); i.a = 0, t.fillColor = i } this._graphics.stencilStage = this.inverted ? 6 : 2 }, i._updateGraphics = function () { if (this._graphics && (0 === this._type || 1 === this._type)) { var t = this.node._getUITransformComp(), e = this._graphics; e.clear(); var i = t.contentSize, n = i.width, r = i.height, s = t.anchorPoint, a = -n * s.x, o = -r * s.y; if (0 === this._type) e.rect(a, o, n, r); else if (1 === this._type) { for (var u = mz(new Kn(a + n / 2, o + r / 2, 0), new Kn(n / 2, r / 2, 0), this._segments), h = 0; h < u.length; ++h) { var c = u[h]; 0 === h ? e.moveTo(c.x, c.y) : e.lineTo(c.x, c.y) } e.close() } e.fill() } }, i._enableRender = function () { this.subComp && (this.subComp.enabled = !0) }, i._disableRender = function () { this.subComp && (this.subComp.stencilStage = 0, this.subComp.updateMaterial(), this.node.activeInHierarchy && (this.subComp.enabled = !1)) }, i._removeMaskNode = function () { this._sprite && (this._sprite = null), this._graphics && (this._graphics = null) }, i.markForUpdateRenderData = function (t) { void 0 === t && (t = !0), it(9007), this.subComp && this.subComp._markForUpdateRenderData(t) }, i.requestRenderData = function () { it(9007) }, i.destroyRenderData = function () { it(9007) }, i.updateRenderer = function () { it(9007), this.subComp && this.subComp.updateRenderer() }, i.fillBuffers = function () { it(9007) }, i.postUpdateAssembler = function () { it(9007) }, i.setNodeDirty = function () { it(9007), this.subComp && this.subComp.setNodeDirty() }, i.setTextureDirty = function () { it(9007), this.subComp && this.subComp.setTextureDirty() }, i.getMaterial = function (t) { return it(9007), this.subComp ? this.subComp.getSharedMaterial(t) : null }, i.setMaterial = function (t, e) { it(9007), this.subComp && this.subComp.setMaterial(t, e) }, i.getMaterialInstance = function (t) { return it(9007), this.subComp ? this.subComp.getMaterialInstance(t) : null }, i.setMaterialInstance = function (t, e) { it(9007), this.subComp && this.subComp.setMaterialInstance(t, e) }, i.getRenderMaterial = function (t) { return it(9007), this.subComp ? this.subComp.getRenderMaterial(t) : null }, n(e, [{ key: "type", get: function () { return this._type }, set: function (t) { this._type !== t && (this._type = t, 3 !== this._type ? (this._sprite && (this.node.removeComponent(iN), this._sprite._destroyImmediate(), this._sprite = null), this._changeRenderType(), this._updateGraphics()) : (this._graphics && (this._graphics.clear(), this.node.removeComponent(fz), this._graphics._destroyImmediate(), this._graphics = null), this._changeRenderType())) } }, { key: "inverted", get: function () { return this._inverted }, set: function (t) { this._inverted = t, this.subComp.stencilStage = this.inverted ? 6 : 2 } }, { key: "segments", get: function () { return this._segments }, set: function (t) { this._segments !== t && (this._segments = Xi(t, 3, 1e4), this._updateGraphics()) } }, { key: "spriteFrame", get: function () { return this._sprite ? this._sprite.spriteFrame : null }, set: function (t) { this._sprite ? this._sprite.spriteFrame = t : rt(16307) } }, { key: "alphaThreshold", get: function () { return this._alphaThreshold }, set: function (t) { this._alphaThreshold !== t && (this._alphaThreshold = t, 3 === this.type && this._sprite && this._sprite.getMaterialInstance(0).setProperty("alphaThreshold", this._alphaThreshold)) } }, { key: "subComp", get: function () { return this._graphics || this._sprite } }, { key: "customMaterial", get: function () { return it(9007), this.subComp ? this.subComp.customMaterial : null }, set: function (t) { it(9007), this.subComp && (this.subComp.customMaterial = t) } }, { key: "color", get: function () { return it(9007), this.subComp ? this.subComp.color : null }, set: function (t) { it(9007), this.subComp && t && (this.subComp.color = t) } }, { key: "sharedMaterial", get: function () { return it(9007), this.subComp ? this.subComp.sharedMaterial : null } }, { key: "sharedMaterials", get: function () { return it(9007), this.subComp ? this.subComp.sharedMaterials : null }, set: function (t) { it(9007), this.subComp && t && (this.subComp.sharedMaterials = t) } }, { key: "material", get: function () { return it(9007), this.subComp ? this.subComp.material : null }, set: function (t) { it(9007), this.subComp && (this.subComp.material = t) } }, { key: "materials", get: function () { return it(9007), this.subComp ? this.subComp.materials : [null] }, set: function (t) { it(9007), this.subComp && (this.subComp.materials = t) } }]), e }(am), sz.Type = vz, m((tz = sz).prototype, "type", [JN], Object.getOwnPropertyDescriptor(tz.prototype, "type"), tz.prototype), ez = Bu(tz.prototype, "_type", [eh], (function () { return 0 })), iz = Bu(tz.prototype, "_inverted", [eh], (function () { return !1 })), nz = Bu(tz.prototype, "_segments", [eh], (function () { return 64 })), rz = Bu(tz.prototype, "_alphaThreshold", [eh], (function () { return .1 })), $N = tz)) || $N) || $N); t({ MaskComponent: Iz, Mask: Iz }), dy._maskComp = Iz, S.Mask = Iz, St({ RenderComponent: { newName: "UIRenderer", since: "1.2.0", removed: !0 }, UITransformComponent: { newName: "UITransform", since: "1.2.0", removed: !1 }, CanvasComponent: { newName: "Canvas", since: "1.2.0", removed: !1 } }), St({ UIRenderable: { newName: "UIRenderer", since: "3.0.0", removed: !0 } }), St({ Renderable2D: { newName: "UIRenderer", since: "3.6.0", removed: !1 } }); var Ez, Az, Cz, Dz, Rz, Pz, Bz, Mz, Oz, Lz, Fz, kz, Nz, zz, Uz, Vz, Gz, Hz, Wz, jz, Xz, qz, Yz, Kz, Qz, Zz, Jz, $z, tU, eU, iU, nU, rU, sU, aU, oU, uU = Gu("cc.PostProcess")(yz = ju((Tz = function (t) { function e() { var e; return (e = t.call(this) || this).global = wz && wz(), e._shadingScale = xz && xz(), e.enableShadingScaleInEditor = Sz && Sz(), e.settings = new Map, e } s(e, t); var i = e.prototype; return i.addSetting = function (t) { this.settings.set(t.constructor, t) }, i.removeSetting = function (t) { this.settings.delete(t.constructor) }, i.getSetting = function (t) { return this.settings.get(t) }, i.onEnable = function () { e.all.push(this) }, i.onDisable = function () { var t = e.all.indexOf(this); -1 !== t && e.all.splice(t, 1) }, n(e, [{ key: "shadingScale", get: function () { return this._shadingScale }, set: function (t) { this._shadingScale = t } }]), e }(am), Tz.all = [], wz = Bu((bz = Tz).prototype, "global", [Xu, eh], (function () { return !0 })), xz = Bu(bz.prototype, "_shadingScale", [eh], (function () { return 1 })), m(bz.prototype, "shadingScale", [Xu], Object.getOwnPropertyDescriptor(bz.prototype, "shadingScale"), bz.prototype), Sz = Bu(bz.prototype, "enableShadingScaleInEditor", [Xu, eh], (function () { return !1 })), yz = bz)) || yz) || yz, hU = new Kn, cU = Ee(eR), lU = Ee(tR), fU = Ee(iR), dU = Ee(rR), pU = Ee(nR), _U = Ee({ SKYBOX: 14, SOLID_COLOR: 7, DEPTH_ONLY: 6, DONT_CLEAR: 0 }), gU = (Ez = Gu("cc.Camera"), Az = Ih(Iv.BitMask), Cz = Ih(_U), Dz = Ih(cU), Rz = Ih(lU), Pz = Ih(fU), Bz = Ih(dU), Mz = Ih(pU), Oz = Ih(KR), Lz = Ih(uU), Ez((aU = function (t) { function e() { var e; return (e = t.call(this) || this)._projection = Nz && Nz(), e._priority = zz && zz(), e._fov = Uz && Uz(), e._fovAxis = Vz && Vz(), e._orthoHeight = Gz && Gz(), e._near = Hz && Hz(), e._far = Wz && Wz(), e._color = jz && jz(), e._depth = Xz && Xz(), e._stencil = qz && qz(), e._clearFlags = Yz && Yz(), e._rect = Kz && Kz(), e._aperture = Qz && Qz(), e._shutter = Zz && Zz(), e._iso = Jz && Jz(), e._screenScale = $z && $z(), e._visibility = tU && tU(), e._targetTexture = eU && eU(), e._postProcess = iU && iU(), e._usePostProcess = nU && nU(), e._camera = null, e._inEditorMode = !1, e._flows = void 0, e._cameraType = rU && rU(), e._trackingType = sU && sU(), e } s(e, t); var i = e.prototype; return i.onLoad = function () { this._createCamera() }, i.onEnable = function () { this.node.hasChangedFlags |= 1, this._camera && this._attachToScene() }, i.onDisable = function () { this._camera && this._detachFromScene() }, i.onDestroy = function () { this._camera && (this._camera.destroy(), this._camera = null), this._targetTexture && this._targetTexture.off("resize") }, i.screenPointToRay = function (t, e, i) { return i || (i = Rs.create()), this._camera && this._camera.screenPointToRay(i, t, e), i }, i.worldToScreen = function (t, e) { return e || (e = new Kn), this._camera && this._camera.worldToScreen(e, t), e }, i.screenToWorld = function (t, e) { return e || (e = this.node.getWorldPosition()), this._camera && this._camera.screenToWorld(e, t), e }, i.convertToUINode = function (t, e, i) { if (i || (i = new Kn), !this._camera) return i; this.worldToScreen(t, hU); var n = e.getComponent("cc.UITransform"), r = S.view, s = r.getVisibleSize(), a = hU.x - .5 * this._camera.width, o = hU.y - .5 * this._camera.height; return hU.x = a / r.getScaleX() + .5 * s.width, hU.y = o / r.getScaleY() + .5 * s.height, n && n.convertToNodeSpaceAR(hU, i), i }, i._createCamera = function () { this._camera || (this._camera = S.director.root.createCamera(), this._camera.initialize({ name: this.node.name, node: this.node, projection: this._projection, window: this._inEditorMode ? S.director.root && S.director.root.mainWindow : S.director.root && S.director.root.tempWindow, priority: this._priority, cameraType: this.cameraType, trackingType: this.trackingType }), this._camera.setViewportInOrientedSpace(this._rect), this._camera.fovAxis = this._fovAxis, this._camera.fov = Ki(this._fov), this._camera.orthoHeight = this._orthoHeight, this._camera.nearClip = this._near, this._camera.farClip = this._far, this._camera.clearColor = this._color, this._camera.clearDepth = this._depth, this._camera.clearStencil = this._stencil, this._camera.clearFlag = this._clearFlags, this._camera.visibility = this._visibility, this._camera.aperture = this._aperture, this._camera.shutter = this._shutter, this._camera.iso = this._iso, this._camera.postProcess = this._postProcess, this._camera.usePostProcess = this._usePostProcess), this._updateTargetTexture() }, i._attachToScene = function () { this.node.scene && this._camera && (this._camera && this._camera.scene && this._camera.scene.removeCamera(this._camera), this._getRenderScene().addCamera(this._camera)) }, i._detachFromScene = function () { this._camera && this._camera.scene && this._camera.scene.removeCamera(this._camera) }, i._checkTargetTextureEvent = function (t) { var e = this; t && t.off("resize"), this._targetTexture && this._targetTexture.on("resize", (function (t) { e._camera && e._camera.setFixedSize(t.width, t.height) }), this) }, i._updateTargetTexture = function () { if (this._camera && this._targetTexture) { var t = this._targetTexture.window; this._camera.changeTargetWindow(t), this._camera.setFixedSize(t.width, t.height) } }, n(e, [{ key: "camera", get: function () { return this._camera } }, { key: "priority", get: function () { return this._priority }, set: function (t) { this._priority = t, this._camera && (this._camera.priority = t) } }, { key: "visibility", get: function () { return this._visibility }, set: function (t) { this._visibility = t, this._camera && (this._camera.visibility = t) } }, { key: "clearFlags", get: function () { return this._clearFlags }, set: function (t) { this._clearFlags = t, this._camera && (this._camera.clearFlag = t) } }, { key: "clearColor", get: function () { return this._color }, set: function (t) { this._color.set(t), this._camera && (this._camera.clearColor = this._color) } }, { key: "clearDepth", get: function () { return this._depth }, set: function (t) { this._depth = t, this._camera && (this._camera.clearDepth = t) } }, { key: "clearStencil", get: function () { return this._stencil }, set: function (t) { this._stencil = t, this._camera && (this._camera.clearStencil = t) } }, { key: "projection", get: function () { return this._projection }, set: function (t) { this._projection = t, this._camera && (this._camera.projectionType = t) } }, { key: "fovAxis", get: function () { return this._fovAxis }, set: function (t) { t !== this._fovAxis && (this._fovAxis = t, this._camera && (this._camera.fovAxis = t, this.fov = 0 === t ? this._fov * this._camera.aspect : this._fov / this._camera.aspect)) } }, { key: "fov", get: function () { return this._fov }, set: function (t) { this._fov = t, this._camera && (this._camera.fov = Ki(t)) } }, { key: "orthoHeight", get: function () { return this._orthoHeight }, set: function (t) { this._orthoHeight = t, this._camera && (this._camera.orthoHeight = t) } }, { key: "near", get: function () { return this._near }, set: function (t) { this._near = t, this._camera && (this._camera.nearClip = t) } }, { key: "far", get: function () { return this._far }, set: function (t) { this._far = t, this._camera && (this._camera.farClip = t) } }, { key: "aperture", get: function () { return this._aperture }, set: function (t) { this._aperture = t, this._camera && (this._camera.aperture = t) } }, { key: "shutter", get: function () { return this._shutter }, set: function (t) { this._shutter = t, this._camera && (this._camera.shutter = t) } }, { key: "iso", get: function () { return this._iso }, set: function (t) { this._iso = t, this._camera && (this._camera.iso = t) } }, { key: "rect", get: function () { return this._rect }, set: function (t) { this._rect = t, this._camera && this._camera.setViewportInOrientedSpace(t) } }, { key: "targetTexture", get: function () { return this._targetTexture }, set: function (t) { if (this._targetTexture !== t) { var e = this._targetTexture; this._targetTexture = t, this._checkTargetTextureEvent(e), this._updateTargetTexture(), !t && this._camera && (this._camera.changeTargetWindow(null), this._camera.isWindowSize = !0), this.node.emit("tex-change", this) } } }, { key: "usePostProcess", get: function () { return this._usePostProcess }, set: function (t) { this._usePostProcess = t, this._camera && (this._camera.usePostProcess = t) } }, { key: "postProcess", get: function () { return this._postProcess }, set: function (t) { this._postProcess = t, this._camera && (this._camera.postProcess = t) } }, { key: "screenScale", get: function () { return this._screenScale }, set: function (t) { this._screenScale = t, this._camera && (this._camera.screenScale = t) } }, { key: "inEditorMode", get: function () { return this._inEditorMode }, set: function (t) { if (this._inEditorMode = t, this._camera) { var e = S.director.root; this._camera.changeTargetWindow(t ? e && e.mainWindow : e && e.tempWindow) } } }, { key: "cameraType", get: function () { return this._cameraType }, set: function (t) { this._cameraType !== t && (this._cameraType = t, this.camera && (this.camera.cameraType = t)) } }, { key: "trackingType", get: function () { return this._trackingType }, set: function (t) { this._trackingType !== t && (this._trackingType = t, this.camera && (this.camera.trackingType = t)) } }]), e }(am), aU.ProjectionType = cU, aU.FOVAxis = lU, aU.ClearFlag = _U, aU.Aperture = fU, aU.Shutter = dU, aU.ISO = pU, aU.TARGET_TEXTURE_CHANGE = "tex-change", Nz = Bu((kz = aU).prototype, "_projection", [eh], (function () { return cU.PERSPECTIVE })), zz = Bu(kz.prototype, "_priority", [eh], (function () { return 0 })), Uz = Bu(kz.prototype, "_fov", [eh], (function () { return 45 })), Vz = Bu(kz.prototype, "_fovAxis", [eh], (function () { return lU.VERTICAL })), Gz = Bu(kz.prototype, "_orthoHeight", [eh], (function () { return 10 })), Hz = Bu(kz.prototype, "_near", [eh], (function () { return 1 })), Wz = Bu(kz.prototype, "_far", [eh], (function () { return 1e3 })), jz = Bu(kz.prototype, "_color", [eh], (function () { return new rr("#333333") })), Xz = Bu(kz.prototype, "_depth", [eh], (function () { return 1 })), qz = Bu(kz.prototype, "_stencil", [eh], (function () { return 0 })), Yz = Bu(kz.prototype, "_clearFlags", [eh], (function () { return _U.SOLID_COLOR })), Kz = Bu(kz.prototype, "_rect", [eh], (function () { return new fs(0, 0, 1, 1) })), Qz = Bu(kz.prototype, "_aperture", [eh], (function () { return fU.F16_0 })), Zz = Bu(kz.prototype, "_shutter", [eh], (function () { return dU.D125 })), Jz = Bu(kz.prototype, "_iso", [eh], (function () { return pU.ISO100 })), $z = Bu(kz.prototype, "_screenScale", [eh], (function () { return 1 })), tU = Bu(kz.prototype, "_visibility", [eh], (function () { return yw })), eU = Bu(kz.prototype, "_targetTexture", [eh], (function () { return null })), iU = Bu(kz.prototype, "_postProcess", [eh], (function () { return null })), nU = Bu(kz.prototype, "_usePostProcess", [eh], (function () { return !1 })), rU = Bu(kz.prototype, "_cameraType", [eh], (function () { return -1 })), sU = Bu(kz.prototype, "_trackingType", [eh], (function () { return 0 })), m(kz.prototype, "visibility", [Az], Object.getOwnPropertyDescriptor(kz.prototype, "visibility"), kz.prototype), m(kz.prototype, "clearFlags", [Cz], Object.getOwnPropertyDescriptor(kz.prototype, "clearFlags"), kz.prototype), m(kz.prototype, "projection", [Dz], Object.getOwnPropertyDescriptor(kz.prototype, "projection"), kz.prototype), m(kz.prototype, "fovAxis", [Rz], Object.getOwnPropertyDescriptor(kz.prototype, "fovAxis"), kz.prototype), m(kz.prototype, "aperture", [Pz], Object.getOwnPropertyDescriptor(kz.prototype, "aperture"), kz.prototype), m(kz.prototype, "shutter", [Bz], Object.getOwnPropertyDescriptor(kz.prototype, "shutter"), kz.prototype), m(kz.prototype, "iso", [Mz], Object.getOwnPropertyDescriptor(kz.prototype, "iso"), kz.prototype), m(kz.prototype, "targetTexture", [Oz], Object.getOwnPropertyDescriptor(kz.prototype, "targetTexture"), kz.prototype), m(kz.prototype, "usePostProcess", [Xu], Object.getOwnPropertyDescriptor(kz.prototype, "usePostProcess"), kz.prototype), m(kz.prototype, "postProcess", [Lz], Object.getOwnPropertyDescriptor(kz.prototype, "postProcess"), kz.prototype), Fz = kz)) || Fz); t({ Camera: gU, CameraComponent: gU }), S.Camera = gU; var mU, vU, yU, bU, wU, xU, SU, TU, IU, EU = t("RenderRoot2D", Gu("cc.RenderRoot2D")(oU = Wu(100)(oU = Hu(TF)(oU = ju(oU = function (t) { function e() { return t.apply(this, arguments) || this } s(e, t); var i = e.prototype; return i.onEnable = function () { S.director.root.batcher2D.addScreen(this) }, i.onDisable = function () { S.director.root.batcher2D.removeScreen(this) }, i.onDestroy = function () { S.director.root.batcher2D.removeScreen(this) }, e }(am)) || oU) || oU) || oU) || oU), AU = new Kn, CU = (mU = Gu("cc.Canvas"), vU = Wu(100), yU = Ih(gU), bU = Ih(gU), mU(wU = vU(wU = ju((xU = function (t) { function e() { var e; return (e = t.call(this) || this)._cameraComponent = SU && SU(), e._alignCanvasWithScreen = TU && TU(), e._pos = new Kn, e._renderMode = 0, e._thisOnCameraResized = e._onResizeCamera.bind(l(e)), e } s(e, t); var i = e.prototype; return i.__preload = function () { var t = this.getComponent("cc.Widget"); t && t.updateAlignment(), this._cameraComponent && (this._cameraComponent._createCamera(), this._cameraComponent.node.on("tex-change", this._thisOnCameraResized)), this._onResizeCamera(), cM.on("canvas-resize", this._thisOnCameraResized, this), cM.on("design-resolution-changed", this._thisOnCameraResized, this) }, i.onEnable = function () { t.prototype.onEnable.call(this), this._cameraComponent && this._cameraComponent.node.on("tex-change", this._thisOnCameraResized) }, i.onDisable = function () { t.prototype.onDisable.call(this), this._cameraComponent && this._cameraComponent.node.off("tex-change", this._thisOnCameraResized) }, i.onDestroy = function () { t.prototype.onDestroy.call(this), cM.off("canvas-resize", this._thisOnCameraResized, this), cM.off("design-resolution-changed", this._thisOnCameraResized, this) }, i._onResizeCamera = function () { if (this._cameraComponent && this._alignCanvasWithScreen) { if (this._cameraComponent.targetTexture) this._cameraComponent.orthoHeight = eu.height / 2; else { var t = $o.windowSize; this._cameraComponent.orthoHeight = t.height / cM.getScaleY() / 2 } this.node.getWorldPosition(AU), this._cameraComponent.node.setWorldPosition(AU.x, AU.y, 1e3) } }, i._getViewPriority = function () { if (this._cameraComponent) { var t, e = null == (t = this.cameraComponent) ? void 0 : t.priority; return 0 === this._renderMode ? e | 1 << 30 : -1073741825 & e } return 0 }, n(e, [{ key: "renderMode", get: function () { return this._renderMode }, set: function (t) { this._renderMode = t, this._cameraComponent && (this._cameraComponent.priority = this._getViewPriority()) } }, { key: "cameraComponent", get: function () { return this._cameraComponent }, set: function (t) { this._cameraComponent !== t && (this._cameraComponent = t, this._onResizeCamera()) } }, { key: "alignCanvasWithScreen", get: function () { return this._alignCanvasWithScreen }, set: function (t) { this._alignCanvasWithScreen = t, this._onResizeCamera() } }]), e }(EU), m(xU.prototype, "cameraComponent", [yU], Object.getOwnPropertyDescriptor(xU.prototype, "cameraComponent"), xU.prototype), SU = Bu(xU.prototype, "_cameraComponent", [bU], (function () { return null })), TU = Bu(xU.prototype, "_alignCanvasWithScreen", [eh], (function () { return !0 })), wU = xU)) || wU) || wU) || wU); function DU(t, e, i) { var n = t.o, r = t.d, s = 1 / r.x, a = 1 / r.y, o = 1 / r.z, u = (e.x - n.x) * s, h = (i.x - n.x) * s, c = (e.y - n.y) * a, l = (i.y - n.y) * a, f = (e.z - n.z) * o, d = (i.z - n.z) * o, p = Math.max(Math.max(Math.min(u, h), Math.min(c, l)), Math.min(f, d)), _ = Math.min(Math.min(Math.max(u, h), Math.max(c, l)), Math.max(f, d)); return _ < 0 || p > _ ? 0 : p > 0 ? p : _ } t({ Canvas: CU, CanvasComponent: CU }), S.Canvas = CU, ft(t("UIComponent", Gu("cc.UIComponent")(IU = Hu(TF)(IU = Wu(110)(IU = ju(IU = function (t) { function e() { var e; return (e = t.call(this) || this)._lastParent = null, e.stencilStage = 0, e } s(e, t); var i = e.prototype; return i.__preload = function () { this.node._uiProps.uiComp = this }, i.onEnable = function () { }, i.onDisable = function () { }, i.onDestroy = function () { var t = this.node._uiProps; t.uiComp === this && (t.uiComp = null) }, i.postUpdateAssembler = function () { }, i.markForUpdateRenderData = function () { }, i.setNodeDirty = function () { }, i.setTextureDirty = function () { }, e }(am)) || IU) || IU) || IU) || IU).prototype, "UIComponent", [{ name: "_visibility" }, { name: "setVisibility" }]), lt(CU.prototype, "Canvas.prototype", [{ name: "camera", newName: "cameraComponent.camera", customGetter: function () { var t; return null == (t = this._cameraComponent) ? void 0 : t.camera } }, { name: "clearFlag", newName: "cameraComponent.clearFlags", customGetter: function () { return this._cameraComponent ? this._cameraComponent.clearFlags : 0 }, customSetter: function (t) { this._cameraComponent && (this._cameraComponent.clearFlags = t) } }, { name: "color", newName: "cameraComponent.clearColor", customGetter: function () { return this._cameraComponent ? this._cameraComponent.clearColor : rr.BLACK }, customSetter: function (t) { this._cameraComponent && (this._cameraComponent.clearColor = t) } }, { name: "priority", newName: "cameraComponent.priority", customGetter: function () { return this._cameraComponent ? this._cameraComponent.priority : 0 }, customSetter: function (t) { this._cameraComponent && (this._cameraComponent.priority = t) } }, { name: "targetTexture", newName: "cameraComponent.targetTexture", customGetter: function () { return this._cameraComponent ? this._cameraComponent.targetTexture : null }, customSetter: function (t) { this._cameraComponent && (this._cameraComponent.targetTexture = t) } }, { name: "visibility", newName: "cameraComponent.visibility", customGetter: function () { return this._cameraComponent ? this._cameraComponent.visibility : 0 } }]), dt(TF.prototype, "UITransform.prototype", [{ name: "priority", suggest: "Please use setSiblingIndex to change index of the current node in its parent's children array." }]), S.UITransformComponent = TF, ae(TF, "cc.UITransformComponent"), ae(GF, "cc.RenderComponent"), S.CanvasComponent = CU, ae(CU, "cc.CanvasComponent"), S.internal.Renderable2D = GF, ae(GF, "cc.Renderable2D"); var RU, PU, BU, MU, OU, LU, FU, kU, NU = (RU = Qa.create(), PU = { distance: 1 / 0, doubleSided: !1, mode: 2 }, BU = 0, MU = function (t, e, i, n, r, s) { 1 === t ? (BU > e || 0 === BU) && (BU = e, s && (0 === s.length ? s.push({ distance: e, vertexIndex0: i / 3, vertexIndex1: n / 3, vertexIndex2: r / 3 }) : (s[0].distance = e, s[0].vertexIndex0 = i / 3, s[0].vertexIndex1 = n / 3, s[0].vertexIndex2 = r / 3))) : (BU = e, s && s.push({ distance: e, vertexIndex0: i / 3, vertexIndex1: n / 3, vertexIndex2: r / 3 })) }, OU = function (t, e, i, n, r) { if (7 === i) for (var s = e.length, a = 0; a < s; a += 3) { var o = 3 * e[a], u = 3 * e[a + 1], h = 3 * e[a + 2]; Kn.set(RU.a, t[o], t[o + 1], t[o + 2]), Kn.set(RU.b, t[u], t[u + 1], t[u + 2]), Kn.set(RU.c, t[h], t[h + 1], t[h + 2]); var c = Wa.rayTriangle(n, RU, r.doubleSided); if (!(0 === c || c > r.distance) && (MU(r.mode, c, o, u, h, r.result), 2 === r.mode)) return c } else if (8 === i) for (var l = e.length - 2, f = 0, d = 0; d < l; d += 1) { var p = 3 * e[d - f], _ = 3 * e[d + f + 1], g = 3 * e[d + 2]; Kn.set(RU.a, t[p], t[p + 1], t[p + 2]), Kn.set(RU.b, t[_], t[_ + 1], t[_ + 2]), Kn.set(RU.c, t[g], t[g + 1], t[g + 2]), f = ~f; var m = Wa.rayTriangle(n, RU, r.doubleSided); if (!(0 === m || m > r.distance) && (MU(r.mode, m, p, _, g, r.result), 2 === r.mode)) return m } else if (9 === i) { var v = e.length - 1, y = 3 * e[0]; Kn.set(RU.a, t[y], t[y + 1], t[y + 2]); for (var b = 1; b < v; b += 1) { var w = 3 * e[b], x = 3 * e[b + 1]; Kn.set(RU.b, t[w], t[w + 1], t[w + 2]), Kn.set(RU.c, t[x], t[x + 1], t[x + 2]); var S = Wa.rayTriangle(n, RU, r.doubleSided); if (!(0 === S || S > r.distance) && (MU(r.mode, S, y, w, x, r.result), 2 === r.mode)) return S } } return BU }, function (t, e, i) { if (BU = 0, 0 === e.geometricInfo.positions.length) return BU; var n = void 0 === i ? PU : i; if (DU(t, e.geometricInfo.boundingBox.min, e.geometricInfo.boundingBox.max)) { var r = e.primitiveMode, s = e.geometricInfo, a = s.positions, o = s.indices; OU(a, o, r, t, n) } return BU }), zU = function () { var t = 0, e = { distance: 1 / 0, doubleSided: !1, mode: 2 }; return function (i, n, r) { t = 0; var s = void 0 === r ? e : r, a = n.renderingSubMeshes.length, o = n.struct.minPosition, u = n.struct.maxPosition; if (o && u && !DU(i, o, u)) return t; for (var h = 0; h < a; h++) { var c = n.renderingSubMeshes[h], l = NU(i, c, s); if (l) if (1 === s.mode) (0 === t || t > l) && (t = l, s.subIndices && (s.subIndices[0] = h)); else if (t = l, s.subIndices && s.subIndices.push(h), 2 === s.mode) return l } return t && 1 === s.mode && (s.result && (s.result[0].distance = t, s.result.length = 1), s.subIndices && (s.subIndices.length = 1)), t } }(), UU = function () { var t = 0, e = { distance: 1 / 0, doubleSided: !1, mode: 2 }, i = new Rs, n = new Gr; return function (r, s, a) { t = 0; var o = void 0 === a ? e : a, u = s.worldBounds; if (u && !Wa.rayAABB(r, u)) return t; Rs.copy(i, r), s.node && (Gr.invert(n, s.node.getWorldMatrix(n)), Kn.transformMat4(i.o, r.o, n), Kn.transformMat4Normal(i.d, r.d, n)); for (var h = s.subModels, c = 0; c < h.length; c++) { var l = h[c].subMesh, f = NU(i, l, o); if (f) if (1 === o.mode) (0 === t || t > f) && (t = f, o.subIndices && (o.subIndices[0] = c)); else if (t = f, o.subIndices && o.subIndices.push(c), 2 === o.mode) return f } return t && 1 === o.mode && (o.result && (o.result[0].distance = t, o.result.length = 1), o.subIndices && (o.subIndices.length = 1)), t } }(); Wa.rayModel = UU, Wa.raySubMesh = NU, Wa.rayMesh = zU, KS("specular-pass"); var VU, GU, HU, WU, jU, XU = Gu("cc.ModelRenderer")((FU = function (t) { function e() { var e; return (e = t.call(this) || this)._visFlags = kU && kU(), e._models = [], e._priority = 0, e } s(e, t); var i = e.prototype; return i._collectModels = function () { return this._models }, i.onEnable = function () { this._updatePriority() }, i._attachToScene = function () { }, i._detachFromScene = function () { }, i._onVisibilityChange = function () { }, i._updatePriority = function () { if (this._models.length > 0) for (var t = 0; t < this._models.length; t++)this._models[t].priority = this._priority }, n(e, [{ key: "visibility", get: function () { return this._visFlags }, set: function (t) { this._visFlags = t, this._onVisibilityChange(t) } }, { key: "priority", get: function () { return this._priority }, set: function (t) { t !== this._priority && (this._priority = t, this._updatePriority()) } }]), e }(UF), kU = Bu(FU.prototype, "_visFlags", [eh], (function () { return Iv.Enum.NONE })), LU = FU)) || LU; t({ ModelRenderer: XU, RenderableComponent: XU }); var qU, YU, KU, QU, ZU, JU, $U, tV, eV, iV, nV, rV = eh, sV = Ih; t("PrefabLink", (VU = Gu("cc.PrefabLink"), GU = sV(sB), VU((WU = function (t) { function e() { var e; return (e = t.call(this) || this).prefab = jU && jU(), e } return s(e, t), e }(am), jU = Bu(WU.prototype, "prefab", [GU, rV], (function () { return null })), HU = WU)) || HU)), lt(gU, "Camera", [{ name: "CameraClearFlag", newName: "ClearFlag" }]), lt(gU.prototype, "Camera.prototype", [{ name: "color", newName: "clearColor" }, { name: "depth", newName: "clearDepth" }, { name: "stencil", newName: "clearStencil" }]), dt(UF.prototype, "Renderer.prototype", [{ name: "getMaterial", suggest: "please use renderer.getSharedMaterial instead." }]), S.CameraComponent = gU, ae(gU, "cc.CameraComponent"), S.RenderableComponent = XU, ae(XU, "cc.RenderableComponent"), t("SpriteRenderer", (qU = Gu("cc.SpriteRenderer"), YU = Wu(100), KU = Ih(vO), qU(QU = YU((ZU = function (t) { function e() { var e; return (e = t.call(this) || this)._spriteFrame = JU && JU(), e._mode = $U && $U(), e._color = tV && tV(), e._flipX = eV && eV(), e._flipY = iV && iV(), e._size = nV && nV(), e._model = null, e } s(e, t); var i = e.prototype; return i.onLoad = function () { this._spriteFrame && (this._spriteFrame.mesh || this._spriteFrame.ensureMeshData(), this._spriteFrame.mesh.initialize()), this._updateModels() }, i.onRestore = function () { this._updateModels(), this.enabledInHierarchy && this._attachToScene() }, i.onEnable = function () { t.prototype.onEnable.call(this), this._model || this._updateModels(), this._attachToScene() }, i.onDisable = function () { this._model && this._detachFromScene() }, i.onDestroy = function () { this._model && (S.director.root.destroyModel(this._model), this._model = null, this._models.length = 0) }, i._updateModels = function () { if (this._spriteFrame) { var t = this._model; if (t ? (t.destroy(), t.initialize(), t.node = t.transform = this.node) : this._createModel(), this._model) { var e = this._spriteFrame.mesh; this._model.createBoundingShape(e.struct.minPosition, e.struct.maxPosition), this._updateModelParams(), this._onUpdateLocalDescriptorSet() } } }, i._createModel = function () { var t = this._model = S.director.root.createModel(TR); t.visFlags = this.visibility, t.node = t.transform = this.node, this._models.length = 0, this._models.push(this._model) }, i._updateModelParams = function () { if (this._spriteFrame && this._model) { this._spriteFrame.ensureMeshData(); var t = this._spriteFrame.mesh; this.node.hasChangedFlags |= 1, this._model.transform.hasChangedFlags |= 1; var e = t ? t.renderingSubMeshes : null; if (e) for (var i = e.length, n = 0; n < i; ++n) { var r = this.getRenderMaterial(n); r && !r.isValid && (r = null); var s = e[n]; s && this._model.initSubModel(n, s, r || this._getBuiltinMaterial()) } this._model.enabled = !0 } }, i._getBuiltinMaterial = function () { return YS.get("missing-material") }, i._onMaterialModified = function (e, i) { t.prototype._onMaterialModified.call(this, e, i), this._spriteFrame && this._model && this._model.inited && this._onRebuildPSO(e, i || this._getBuiltinMaterial()) }, i._onRebuildPSO = function (t, e) { this._model && this._model.inited && (this._model.setSubModelMaterial(t, e), this._onUpdateLocalDescriptorSet()) }, i._onUpdateLocalDescriptorSet = function () { if (this._spriteFrame && this._model && this._model.inited) for (var t = this._spriteFrame.getGFXTexture(), e = this._spriteFrame.getGFXSampler(), i = this._model.subModels, n = 0; n < i.length; n++) { var r = i[n].descriptorSet; r.bindTexture(12, t), r.bindSampler(12, e), r.update() } }, i._attachToScene = function () { if (this.node.scene && this._model) { var t = this._getRenderScene(); null !== this._model.scene && this._detachFromScene(), t.addModel(this._model) } }, i._detachFromScene = function () { this._model && this._model.scene && this._model.scene.removeModel(this._model) }, n(e, [{ key: "spriteFrame", get: function () { return this._spriteFrame }, set: function (t) { this._spriteFrame !== t && (this._spriteFrame, this._spriteFrame = t, this._spriteFrame && (this._spriteFrame.ensureMeshData(), this._spriteFrame.mesh.initialize()), this._updateModels(), this.enabledInHierarchy && this._attachToScene()) } }, { key: "model", get: function () { return this._model } }]), e }(XU), m(ZU.prototype, "spriteFrame", [KU], Object.getOwnPropertyDescriptor(ZU.prototype, "spriteFrame"), ZU.prototype), JU = Bu(ZU.prototype, "_spriteFrame", [eh], (function () { return null })), $U = Bu(ZU.prototype, "_mode", [eh], (function () { return 0 })), tV = Bu(ZU.prototype, "_color", [eh], (function () { return rr.WHITE.clone() })), eV = Bu(ZU.prototype, "_flipX", [eh], (function () { return !1 })), iV = Bu(ZU.prototype, "_flipY", [eh], (function () { return !1 })), nV = Bu(ZU.prototype, "_size", [eh], (function () { return new as })), QU = ZU)) || QU) || QU)); var aV, oV, uV, hV, cV, lV, fV, dV, pV, _V, gV, mV, vV, yV, bV, wV, xV, SV, TV, IV, EV, AV, CV, DV, RV, PV = new SL, BV = "RICHTEXT_CHILD", MV = "RICHTEXT_Image_CHILD", OV = new as, LV = new as, FV = new de((function (t) { if (!S.isValid(t.node)) return !1; var e = t.node.getComponent(Zk); return e && (e.outlineWidth = 0), !0 }), 20), kV = new de((function (t) { return S.isValid(t.node) }), 10); function NV(t) { return { node: new ky(t), comp: null, lineCount: 0, styleIndex: 0, imageOffset: "", clickParam: "", clickHandler: "", type: t } } function zV(t, e) { var i; t === BV ? i = FV._get() : t === MV && (i = kV._get()); var n = (i = i || NV(t)).node; return n || (n = new ky(t)), n.hideFlags |= 1032, n.active = !0, t === MV ? (i.comp = n.getComponent(iN) || n.addComponent(iN), i.comp.spriteFrame = e, i.comp.type = iN.Type.SLICED, i.comp.sizeMode = 0) : (i.comp = n.getComponent(Zk) || n.addComponent(Zk), i.comp.string = e, i.comp.horizontalAlign = 0, i.comp.verticalAlign = 0, i.comp.underlineHeight = 2), n.setPosition(0, 0, 0), n._getUITransformComp().setAnchorPoint(.5, .5), i.node = n, i.lineCount = 0, i.styleIndex = 0, i.imageOffset = "", i.clickParam = "", i.clickHandler = "", i } var UV = t("RichTextComponent", (aV = Gu("cc.RichText"), oV = Wu(110), uV = Ih(Ak), hV = Ih(Ck), cV = Ih(rr), lV = Ih(TO), fV = Ih(Rk), dV = Ih(bO), aV(pV = oV((RV = function (t) { function e() { var e; return (e = t.call(this) || this)._lineHeight = gV && gV(), e._string = mV && mV(), e._horizontalAlign = vV && vV(), e._verticalAlign = yV && yV(), e._fontSize = bV && bV(), e._fontColor = wV && wV(), e._maxWidth = xV && xV(), e._fontFamily = SV && SV(), e._font = TV && TV(), e._isSystemFontUsed = IV && IV(), e._userDefinedFont = EV && EV(), e._cacheMode = AV && AV(), e._imageAtlas = CV && CV(), e._handleTouchEvent = DV && DV(), e._textArray = [], e._segments = [], e._labelSegmentsCache = [], e._linesWidth = [], e._lineCount = 1, e._labelWidth = 0, e._labelHeight = 0, e._layoutDirty = !0, e._lineOffsetX = 0, e._labelChildrenNum = 0, e._updateRichTextStatus = e._updateRichText, e } s(e, t); var i = e.prototype; return i.onLoad = function () { this.node.on("layer-changed", this._applyLayer, this), this.node.on("anchor-changed", this._updateRichTextPosition, this) }, i.onEnable = function () { this.handleTouchEvent && this._addEventListeners(), this._updateRichText(), this._activateChildren(!0) }, i.onDisable = function () { this.handleTouchEvent && this._removeEventListeners(), this._activateChildren(!1) }, i.onRestore = function () { }, i.onDestroy = function () { this._segments.forEach((function (t) { t.node.removeFromParent(), t.type === BV ? FV.put(t) : t.type === MV && kV.put(t) })), this.node.off("anchor-changed", this._updateRichTextPosition, this), this.node.off("layer-changed", this._applyLayer, this) }, i._addEventListeners = function () { this.node.on("touch-end", this._onTouchEnded, this) }, i._removeEventListeners = function () { this.node.off("touch-end", this._onTouchEnded, this) }, i._updateLabelSegmentTextAttributes = function () { var t = this; this._segments.forEach((function (e) { t._applyTextAttribute(e) })) }, i._createFontLabel = function (t) { return zV(BV, t) }, i._createImage = function (t) { return zV(MV, t) }, i._onTTFLoaded = function () { this._font, this._layoutDirty = !0, this._updateRichText() }, i.splitLongStringApproximatelyIn2048 = function (t, e) { var i = []; if (t.length * this.fontSize <= 1638.4) return i.push(t), i; if (this._calculateSize(OV, e, t), OV.x < 2048) i.push(t); else for (var n = t.split("\n"), r = 0; r < n.length; r++)if (this._calculateSize(OV, e, n[r]), OV.x < 2048) i.push(n[r]); else { var s = this.splitLongStringOver2048(n[r], e); i.push.apply(i, s) } return i }, i.splitLongStringOver2048 = function (t, e) { var i = [], n = t, r = 0, s = n.length / 2, a = n.substring(r, s), o = n.substring(s), u = this._calculateSize(OV, e, a), h = this._calculateSize(LV, e, o), c = this._maxWidth; 0 === this._maxWidth && (c = 2047.9); for (var l = 1 * c; u.x > l;) { if ((s /= 2) < 1) { s *= 2; break } a = a.substring(r, s), o = n.substring(s), this._calculateSize(u, e, a) } for (var f = 1e3, d = 1; f && r < t.length;) { for (; f && u.x < l;) { var p = KO(o); p && p.length > 0 && (d = p[0].length), s += d, a = n.substring(r, s), o = n.substring(s), this._calculateSize(u, e, a), f-- } for (; f && a.length >= 2 && u.x > l;)s -= d, a = n.substring(r, s), this._calculateSize(u, e, a), d = 1, f--; if (a.length >= 2) { var _ = QO(a); _ && _.length > 0 && a !== _[0] && (s -= _[0].length, a = n.substring(r, s)) } if (i.push(a), r = s, s += a.length, a = n.substring(r, s), o = n.substring(s), this._calculateSize(h, e, o), this._calculateSize(u, e, a), f--, h.x < 2048 && u.x < l) { i.push(a), r = t.length, s = t.length, a = o, "" !== o && i.push(a); break } } return i }, i._measureText = function (t, e) { var i = this, n = function (e) { return i._calculateSize(OV, t, e).x }; return e ? n(e) : n }, i._calculateSize = function (t, e, i) { var n; 0 === this._labelSegmentsCache.length ? (n = this._createFontLabel(i), this._labelSegmentsCache.push(n)) : (n = this._labelSegmentsCache[0]).node.getComponent(Zk).string = i, n.styleIndex = e, this._applyTextAttribute(n); var r = n.node._getUITransformComp().contentSize; return as.set(t, r.x, r.y), t }, i._onTouchEnded = function (t) { var e = this, i = this.node.getComponents(am); this._segments.forEach((function (n) { var r = n.clickHandler, s = n.clickParam; r && e._containsTouchLocation(n, t.touch.getUILocation()) && (i.forEach((function (e) { var i = e[r]; e.enabledInHierarchy && i && i.call(e, t, s) })), t.propagationStopped = !0) })) }, i._containsTouchLocation = function (t, e) { var i = t.node.getComponent(TF); return !!i && i.getBoundingBoxToWorld().contains(e) }, i._resetState = function () { for (var t = this.node.children, e = t.length - 1; e >= 0; e--) { var i = t[e]; if (i.name === BV || i.name === MV) { i.parent = null; var n = NV(i.name); n.node = i, i.name === BV ? (n.comp = i.getComponent(Zk), FV.put(n)) : (n.comp = i.getComponent(iN), kV.put(n)), this._labelChildrenNum-- } } this._segments.length = 0, this._labelSegmentsCache.length = 0, this._linesWidth.length = 0, this._lineOffsetX = 0, this._lineCount = 1, this._labelWidth = 0, this._labelHeight = 0, this._layoutDirty = !0 }, i._activateChildren = function (t) { for (var e = this.node.children.length - 1; e >= 0; e--) { var i = this.node.children[e]; i.name !== BV && i.name !== MV || (i.active = t) } }, i._addLabelSegment = function (t, e) { var i; if (0 === this._labelSegmentsCache.length) i = this._createFontLabel(t); else { var n = (i = this._labelSegmentsCache.pop()).node.getComponent(Zk); n && (n.string = t) } var r = i.comp; return r.verticalAlign !== this._verticalAlign && (r.verticalAlign = this._verticalAlign), i.styleIndex = e, i.lineCount = this._lineCount, i.node._getUITransformComp().setAnchorPoint(0, 0), i.node.layer = this.node.layer, this.node.insertChild(i.node, this._labelChildrenNum++), this._applyTextAttribute(i), this._segments.push(i), i }, i._updateRichTextWithMaxWidth = function (t, e, i) { var n = e; if (this._lineOffsetX > 0 && n + this._lineOffsetX > this._maxWidth) for (var r = 0; this._lineOffsetX <= this._maxWidth;) { var s = this._getFirstWordLen(t, r, t.length), a = t.substr(r, s), o = this._measureText(i, a); if (!(this._lineOffsetX + o <= this._maxWidth)) { if (r > 0) { var u = t.substr(0, r); this._addLabelSegment(u, i), t = t.substr(r, t.length), n = this._measureText(i, t) } this._updateLineInfo(); break } this._lineOffsetX += o, r += s } if (n > this._maxWidth) for (var h = ZO(t, n, this._maxWidth, this._measureText(i)), c = 0; c < h.length; ++c) { var l = h[c], f = this._addLabelSegment(l, i).node._getUITransformComp().contentSize; this._lineOffsetX += f.width, h.length > 1 && c < h.length - 1 && this._updateLineInfo() } else this._lineOffsetX += n, this._addLabelSegment(t, i) }, i._isLastComponentCR = function (t) { return t.length - 1 === t.lastIndexOf("\n") }, i._updateLineInfo = function () { this._linesWidth.push(this._lineOffsetX), this._lineOffsetX = 0, this._lineCount++ }, i._needsUpdateTextLayout = function (t) { if (this._layoutDirty || !this._textArray || !t) return !0; if (this._textArray.length !== t.length) return !0; for (var e = 0; e < this._textArray.length; e++) { var i = this._textArray[e], n = t[e]; if (i.text !== n.text) return !0; var r = i.style, s = n.style; if (r) { if (s) { if (!!s.outline != !!r.outline) return !0; if (r.size !== s.size || r.italic !== s.italic || r.isImage !== s.isImage) return !0; if (r.src !== s.src || r.imageAlign !== s.imageAlign || r.imageHeight !== s.imageHeight || r.imageWidth !== s.imageWidth || r.imageOffset !== s.imageOffset) return !0 } else if (r.size || r.italic || r.isImage || r.outline) return !0 } else if (s && (s.size || s.italic || s.isImage || s.outline)) return !0 } return !1 }, i._addRichTextImageElement = function (t) { if (t.style) { var e = t.style, i = e.src, n = this._imageAtlas && i && this._imageAtlas.getSpriteFrame(i); if (n) { var r = this._createImage(n); switch (r.comp, e.imageAlign) { case "top": r.node._getUITransformComp().setAnchorPoint(0, 1); break; case "center": r.node._getUITransformComp().setAnchorPoint(0, .5); break; default: r.node._getUITransformComp().setAnchorPoint(0, 0) }e.imageOffset && (r.imageOffset = e.imageOffset), r.node.layer = this.node.layer, this.node.insertChild(r.node, this._labelChildrenNum++), this._segments.push(r); var s = n.rect.clone(), a = 1, o = s.width, u = s.height, h = e.imageWidth || 0, c = e.imageHeight || 0; c > 0 ? (o *= a = c / u, u *= a) : (o *= a = this._lineHeight / u, u *= a), h > 0 && (o = h), this._maxWidth > 0 ? (this._lineOffsetX + o > this._maxWidth && this._updateLineInfo(), this._lineOffsetX += o) : (this._lineOffsetX += o, this._lineOffsetX > this._labelWidth && (this._labelWidth = this._lineOffsetX)), r.node._getUITransformComp().setContentSize(o, u), r.lineCount = this._lineCount, r.clickHandler = "", r.clickParam = ""; var l = e.event; l && (r.clickHandler = l.click, r.clickParam = l.param) } else it(4400) } }, i._updateTextDefaultColor = function () { for (var t = 0; t < this._segments.length; ++t) { var e, i, n = this._segments[t], r = n.node.getComponent(Zk); r && (null != (e = this._textArray[n.styleIndex]) && null != (i = e.style) && i.color || (r.color = this._fontColor)) } }, i._updateRichText = function () { if (this.enabledInHierarchy) { var t = PV.parse(this._string); if (!this._needsUpdateTextLayout(t)) return this._textArray = t.slice(), void this._updateLabelSegmentTextAttributes(); this._textArray = t.slice(), this._resetState(); for (var e, i = !1, n = 0; n < this._textArray.length; ++n) { var r = this._textArray[n], s = r.text; if (void 0 !== s) { if ("" === s) { if (r.style && r.style.isNewLine) { this._updateLineInfo(); continue } if (r.style && r.style.isImage && this._imageAtlas) { this._addRichTextImageElement(r); continue } } for (var a = (s = this.splitLongStringApproximatelyIn2048(s, n).join("\n")).split("\n"), o = 0; o < a.length; ++o) { var u = a[o]; if ("" !== u) if (i = !1, this._maxWidth > 0) { var h = this._measureText(n, u); this._updateRichTextWithMaxWidth(u, h, n), a.length > 1 && o < a.length - 1 && this._updateLineInfo() } else e = this._addLabelSegment(u, n), this._lineOffsetX += e.node._getUITransformComp().width, this._lineOffsetX > this._labelWidth && (this._labelWidth = this._lineOffsetX), a.length > 1 && o < a.length - 1 && this._updateLineInfo(); else { if (this._isLastComponentCR(s) && o === a.length - 1) continue; this._updateLineInfo(), i = !0 } } } } i || this._linesWidth.push(this._lineOffsetX), this._maxWidth > 0 && (this._labelWidth = this._maxWidth), this._labelHeight = (this._lineCount + AO) * this._lineHeight, this.node._getUITransformComp().setContentSize(this._labelWidth, this._labelHeight), this._updateRichTextPosition(), this._layoutDirty = !1 } }, i._getFirstWordLen = function (t, e, i) { var n = WO(t, e); if (UO(n) || VO(n)) return 1; for (var r = 1, s = e + 1; s < i && !VO(n = WO(t, s)) && !UO(n); ++s)r++; return r }, i._updateRichTextPosition = function () { for (var t = 0, e = 1, i = this._lineCount, n = this.node._getUITransformComp(), r = n.anchorX, s = n.anchorY, a = 0; a < this._segments.length; ++a) { var o = this._segments[a], u = o.lineCount; u > e && (t = 0, e = u); var h = this._labelWidth * (.5 * this._horizontalAlign - r); switch (this._horizontalAlign) { case 0: break; case 1: h -= this._linesWidth[u - 1] / 2; break; case 2: h -= this._linesWidth[u - 1] }var c = o.node.position; if (o.node.setPosition(t + h, this._lineHeight * (i - u) - this._labelHeight * s, c.z), u === e && (t += o.node._getUITransformComp().width), o.node.getComponent(iN)) { var l = o.node.position.clone(), f = this._lineHeight, d = this._lineHeight * (1 + AO); switch (o.node._getUITransformComp().anchorY) { case 1: l.y += f + (d - f) / 2; break; case .5: l.y += d / 2; break; default: l.y += (d - f) / 2 }if (o.imageOffset) { var p = o.imageOffset.split(","); if (1 === p.length && p[0]) { var _ = parseFloat(p[0]); Number.isInteger(_) && (l.y += _) } else if (2 === p.length) { var g = parseFloat(p[0]), m = parseFloat(p[1]); Number.isInteger(g) && (l.x += g), Number.isInteger(m) && (l.y += m) } } o.node.position = l } var v = o.node.getComponent(Zk); if (v && v.enableOutline) { var y = o.node.position.clone(); y.y -= v.outlineWidth, o.node.position = y } } }, i._convertLiteralColorValue = function (t) { var e = t.toUpperCase(); return rr[e] ? rr[e] : (new rr).fromHEX(t) }, i._applyTextAttribute = function (t) { var e = t.node.getComponent(Zk); if (e) { this._resetLabelState(e); var i, n = t.styleIndex; if (this._textArray[n] && (i = this._textArray[n].style), i) { if (i.color ? e.color = this._convertLiteralColorValue(i.color) : e.color = this._fontColor, e.isBold = !!i.bold, e.isItalic = !!i.italic, e.isUnderline = !!i.underline, i.outline) { var r = t.node.getComponent(Zk); r || (r = t.node.addComponent(Zk)), r.enableOutline = !0, r.outlineColor = this._convertLiteralColorValue(i.outline.color), r.outlineWidth = i.outline.width } e.fontSize = i.size || this._fontSize, t.clickHandler = "", t.clickParam = ""; var s = i.event; s && (t.clickHandler = s.click || "", t.clickParam = s.param || "") } e.cacheMode = this._cacheMode, this._font instanceof TO && !this._isSystemFontUsed ? e.font = this._font : e.fontFamily = this._fontFamily, e.useSystemFont = this._isSystemFontUsed, e.lineHeight = this._lineHeight, e.updateRenderData(!0) } }, i._applyLayer = function () { var t = this; this._segments.forEach((function (e) { e.node.layer = t.node.layer })) }, i._resetLabelState = function (t) { t.fontSize = this._fontSize, t.color = this._fontColor, t.isBold = !1, t.isItalic = !1, t.isUnderline = !1 }, n(e, [{ key: "string", get: function () { return this._string }, set: function (t) { this._string !== t && (this._string = t, this._updateRichTextStatus()) } }, { key: "horizontalAlign", get: function () { return this._horizontalAlign }, set: function (t) { this.horizontalAlign !== t && (this._horizontalAlign = t, this._layoutDirty = !0, this._updateRichTextStatus()) } }, { key: "verticalAlign", get: function () { return this._verticalAlign }, set: function (t) { this._verticalAlign !== t && (this._verticalAlign = t, this._layoutDirty = !0, this._updateRichTextStatus()) } }, { key: "fontSize", get: function () { return this._fontSize }, set: function (t) { this._fontSize !== t && (this._fontSize = t, this._layoutDirty = !0, this._updateRichTextStatus()) } }, { key: "fontColor", get: function () { return this._fontColor }, set: function (t) { this._fontColor !== t && (this._fontColor = t, this._updateTextDefaultColor()) } }, { key: "fontFamily", get: function () { return this._fontFamily }, set: function (t) { this._fontFamily !== t && (this._fontFamily = t, this._layoutDirty = !0, this._updateRichTextStatus()) } }, { key: "font", get: function () { return this._font }, set: function (t) { this._font !== t && (this._font = t, this._layoutDirty = !0, this._font ? (this.useSystemFont = !1, this._onTTFLoaded()) : this.useSystemFont = !0, this._updateRichTextStatus()) } }, { key: "useSystemFont", get: function () { return this._isSystemFontUsed }, set: function (t) { this._isSystemFontUsed !== t && (this._isSystemFontUsed = t, this._layoutDirty = !0, this._updateRichTextStatus()) } }, { key: "cacheMode", get: function () { return this._cacheMode }, set: function (t) { this._cacheMode !== t && (this._cacheMode = t, this._updateRichTextStatus()) } }, { key: "maxWidth", get: function () { return this._maxWidth }, set: function (t) { this._maxWidth !== t && (this._maxWidth = t, this._layoutDirty = !0, this._updateRichTextStatus()) } }, { key: "lineHeight", get: function () { return this._lineHeight }, set: function (t) { this._lineHeight !== t && (this._lineHeight = t, this._layoutDirty = !0, this._updateRichTextStatus()) } }, { key: "imageAtlas", get: function () { return this._imageAtlas }, set: function (t) { this._imageAtlas !== t && (this._imageAtlas = t, this._layoutDirty = !0, this._updateRichTextStatus()) } }, { key: "handleTouchEvent", get: function () { return this._handleTouchEvent }, set: function (t) { this._handleTouchEvent !== t && (this._handleTouchEvent = t, this.enabledInHierarchy && (this.handleTouchEvent ? this._addEventListeners() : this._removeEventListeners())) } }]), e }(am), RV.HorizontalAlign = Ak, RV.VerticalAlign = Ck, m((_V = RV).prototype, "horizontalAlign", [uV], Object.getOwnPropertyDescriptor(_V.prototype, "horizontalAlign"), _V.prototype), m(_V.prototype, "verticalAlign", [hV], Object.getOwnPropertyDescriptor(_V.prototype, "verticalAlign"), _V.prototype), m(_V.prototype, "fontColor", [cV], Object.getOwnPropertyDescriptor(_V.prototype, "fontColor"), _V.prototype), m(_V.prototype, "font", [lV], Object.getOwnPropertyDescriptor(_V.prototype, "font"), _V.prototype), m(_V.prototype, "cacheMode", [fV], Object.getOwnPropertyDescriptor(_V.prototype, "cacheMode"), _V.prototype), m(_V.prototype, "imageAtlas", [dV], Object.getOwnPropertyDescriptor(_V.prototype, "imageAtlas"), _V.prototype), gV = Bu(_V.prototype, "_lineHeight", [eh], (function () { return 40 })), mV = Bu(_V.prototype, "_string", [eh], (function () { return "<color=#00ff00>Rich</color><color=#0fffff>Text</color>" })), vV = Bu(_V.prototype, "_horizontalAlign", [eh], (function () { return 0 })), yV = Bu(_V.prototype, "_verticalAlign", [eh], (function () { return 0 })), bV = Bu(_V.prototype, "_fontSize", [eh], (function () { return 40 })), wV = Bu(_V.prototype, "_fontColor", [eh], (function () { return rr.WHITE.clone() })), xV = Bu(_V.prototype, "_maxWidth", [eh], (function () { return 0 })), SV = Bu(_V.prototype, "_fontFamily", [eh], (function () { return "Arial" })), TV = Bu(_V.prototype, "_font", [eh], (function () { return null })), IV = Bu(_V.prototype, "_isSystemFontUsed", [eh], (function () { return !0 })), EV = Bu(_V.prototype, "_userDefinedFont", [eh], (function () { return null })), AV = Bu(_V.prototype, "_cacheMode", [eh], (function () { return 0 })), CV = Bu(_V.prototype, "_imageAtlas", [eh], (function () { return null })), DV = Bu(_V.prototype, "_handleTouchEvent", [eh], (function () { return !0 })), pV = _V)) || pV) || pV)); S.RichText = UV, S.MaskComponent = Iz, ae(Iz, "cc.MaskComponent"), S.LabelComponent = Zk, ae(Zk, "cc.LabelComponent"), S.LabelOutlineComponent = sN, ae(sN, "cc.LabelOutlineComponent"), S.RichTextComponent = UV, ae(UV, "cc.RichTextComponent"), S.SpriteComponent = iN, ae(iN, "cc.SpriteComponent"), S.UIModelComponent = rN, ae(rN, "cc.UIModelComponent"), S.GraphicsComponent = fz, ae(fz, "cc.GraphicsComponent"), ae(lN, "cc.UIStaticBatchComponent"), ae(gN, "cc.UIOpacityComponent"), lt(Iz.prototype, "Mask", [{ name: "graphics", newName: "subComp", target: Iz.prototype, targetName: "Mask" }]), lt(vz, "MaskType", [{ name: "RECT", newName: "GRAPHICS_RECT", target: vz, targetName: "MaskType" }, { name: "ELLIPSE", newName: "GRAPHICS_ELLIPSE", target: vz, targetName: "MaskType" }, { name: "IMAGE_STENCIL", newName: "SPRITE_STENCIL", target: vz, targetName: "MaskType" }]), dt(sN.prototype, "LabelOutline", [{ name: "width", suggest: "Please use Label.outlineWidth instead." }, { name: "color", suggest: "Please use Label.outlineColor instead." }]), dt(_N.prototype, "LabelShadow", [{ name: "color", suggest: "Please use Label.shadowColor instead." }, { name: "offset", suggest: "Please use Label.shadowOffset instead." }, { name: "blur", suggest: "Please use Label.shadowBlur instead." }]); var VV = ["left", "center", "right"], GV = 2048, HV = RO(), WV = (1 / 255).toFixed(3), jV = function () { this.char = "", this.valid = !0, this.x = 0, this.y = 0, this.line = 0, this.hash = "" }, XV = function () { function t() { this._context = null, this._canvas = null, this._canvasData = null, this._lettersInfo = [], this._tmpRect = new fs, this._maxFontSize = 100, this._fontScale = 1; var t = this._canvasData = DL.getInstance().get(); this._canvas = t.canvas, this._context = t.context } var e = t.prototype; return e.destroy = function () { DL.getInstance().put(this._canvasData), this._canvasData = null, this._canvas = null, this._context = null, this._lettersInfo.length = 0 }, e.processingString = function (t, e, i, n, r, s) { if (t) e.fntConfig ? this._fontScale = 1 : this._fontScale = this._getStyleFontScale(e.originFontSize, e.fontScale), FL.fontScale = this._fontScale, this._setupBMFontOverflowMetrics(i, n), this._updateFontScale(e), this._computeHorizontalKerningForText(e, i, r), this._alignText(e, i, n, r); else { var a = 0; for (this._fontScale = this._getStyleFontScale(e.fontSize, e.fontScale), this._updatePaddingRect(e, n), this._calculateLabelFont(e, i, n, r); (n.canvasSize.width > GV || n.canvasSize.height > GV) && a <= 3;) { if (++a > 3) this._fontScale = 1; else { var o = Math.max(n.canvasSize.width, n.canvasSize.height), u = GV / o; this._fontScale *= u, this._fontScale = Math.max(1, this._fontScale) } this._updatePaddingRect(e, n), this._calculateLabelFont(e, i, n, r) } } s && (s = n.parsedString) }, e.generateRenderInfo = function (t, e, i, n, r, s, a) { t ? (this._computeAlignmentOffset(e, i, n), this.generateVertexData(t, e, i, n, r, s, a)) : (this._updateLabelDimensions(e, i, n), this._updateTexture(e, i, n, r), this.generateVertexData(t, e, i, n, r, s, a)) }, e.setCanvasUsed = function (t, e) { this._canvas = t, this._context = e }, e._getStyleFontScale = function (t, e) { var i = e, n = this._maxFontSize; return i * t > n && t < n && (i = n / t), i < 1 && (i = 1), i }, e._calculateLabelFont = function (t, e, i, n) { if (this._context) { t.actualFontSize = t.fontSize * this._fontScale; var r = n.split("\n"), s = i.parsedString = r, a = this._getFontDesc(t.actualFontSize, t.fontFamily, t.isBold, t.isItalic); this._context.font = t.fontDesc = a; var o = i.canvasSize, u = i.nodeContentSize, h = i.canvasPadding, c = i.contentSizeExtend, l = this._fontScale; switch (e.overFlow) { case 0: for (var f = 0, d = 0; d < r.length; ++d) { var p = GO(this._context, r[d], a); f = f > p ? f : p } var _ = f, g = (s.length + AO) * this._getLineHeight(e.lineHeight, t.actualFontSize, t.fontSize); o.width = _ + h.width * l, o.height = g + h.height * l, u.width = (_ + c.width * l) / l, u.height = (g + c.height * l) / l; break; case 2: this._calculateShrinkFont(r, t, e, i), this._calculateWrapText(r, t, e, i), o.width = u.width * l, o.height = u.height * l; break; case 1: this._calculateWrapText(r, t, e, i), o.width = u.width * l, o.height = u.height * l; break; case 3: this._calculateWrapText(r, t, e, i); var m = (i.parsedString.length + AO) * this._getLineHeight(e.lineHeight, t.actualFontSize, t.fontSize); o.width = u.width * l, o.height = m + h.height * l, u.height = (m + c.height * l) / l } } }, e._getFontDesc = function (t, e, i, n) { var r = t.toString() + "px "; return r += e, i && (r = "bold " + r), n && (r = "italic " + r), r }, e._getLineHeight = function (t, e, i) { return 0 === t ? e : t * e / i }, e._calculateShrinkFont = function (t, e, i, n) { if (this._context) { var r = this._getFontDesc(e.actualFontSize, e.fontFamily, e.isBold, e.isItalic); this._context.font = r; var s = this._calculateParagraphLength(t, this._context, r), a = 0, o = 0, u = 0, h = e.actualFontSize, c = n.canvasSize, l = n.nodeContentSize, f = n.canvasPadding, d = this._fontScale; if (i.wrapping) { var p = l.width * d, _ = l.height * d; if (p < 0 || _ < 0) return; o = _ + 1; for (var g = 0, m = 0 | e.actualFontSize + 1, v = 0; g < m;) { if ((v = g + m + 1 >> 1) <= 0) { J(4003); break } h = v, r = this._getFontDesc(h, e.fontFamily, e.isBold, e.isItalic), this._context.font = r; var y = this._getLineHeight(i.lineHeight, h, e.fontSize); for (o = 0, a = 0; a < t.length; ++a) { var b = GO(this._context, t[a], r); o += ZO(t[a], b, p, this._measureText(this._context, r)).length * y } o > _ ? m = v - 1 : g = v } 0 === g ? J(4003) : (h = g, r = this._getFontDesc(h, e.fontFamily, e.isBold, e.isItalic), this._context.font = r) } else { for (o = t.length * this._getLineHeight(i.lineHeight, h, e.fontSize), a = 0; a < t.length; ++a)u < s[a] && (u = s[a]); var w = (c.width - f.width) * d / u, x = c.height * d / o; h = e.actualFontSize * Math.min(1, w, x) | 0, r = this._getFontDesc(h, e.fontFamily, e.isBold, e.isItalic), this._context.font = r } e.actualFontSize = h, e.fontDesc = r } }, e._calculateWrapText = function (t, e, i, n) { if (i.wrapping && this._context) { var r = [], s = n.nodeContentSize.width * this._fontScale, a = this._getFontDesc(e.actualFontSize, e.fontFamily, e.isBold, e.isItalic); this._context.font = a; for (var o = 0; o < t.length; ++o) { var u = GO(this._context, t[o], a), h = ZO(t[o], u, s, this._measureText(this._context, a)); r = r.concat(h) } n.parsedString = r, e.fontDesc = a } }, e._measureText = function (t, e) { return function (i) { return GO(t, i, e) } }, e._calculateParagraphLength = function (t, e, i) { return t.map((function (t) { return GO(e, t, i) })) }, e._updatePaddingRect = function (t, e) { var i = 0, n = 0, r = 0, s = 0, a = 0, o = e.contentSizeExtend, u = e.canvasPadding; if (o.width = o.height = 0, t.isOutlined && (i = n = r = s = a = t.outlineWidth, o.width = o.height = 2 * a), t.hasShadow) { var h = t.shadowBlur + a, c = t.shadowOffsetX, l = t.shadowOffsetY; r = Math.max(r, -c + h), s = Math.max(s, c + h), i = Math.max(i, l + h), n = Math.max(n, -l + h) } if (t.isItalic) { var f = t.fontSize * Math.tan(.20943951); s += f, o.width += f } u.x = r, u.y = i, u.width = r + s, u.height = i + n }, e._updateLabelDimensions = function (t, e, i) { var n = i.canvasSize; n.width = Math.min(n.width, GV), n.height = Math.min(n.height, GV); var r = this._canvas, s = this._context; r.width = n.width, r.height = n.height, s.font = t.fontDesc, s.textAlign = VV[e.horizontalAlign], s.textBaseline = "alphabetic" }, e._calculateFillTextStartPosition = function (t, e, i) { var n = 0, r = i.canvasSize, s = i.canvasPadding; 2 === e.horizontalAlign ? n = r.width - s.width : 1 === e.horizontalAlign && (n = (r.width - s.width) / 2); var a = this._getLineHeight(e.lineHeight, t.actualFontSize, t.fontSize) * (i.parsedString.length - 1), o = t.actualFontSize * (1 - AO / 2); if (0 !== e.verticalAlign) { var u = a + s.height + t.actualFontSize - r.height; 2 === e.verticalAlign ? o -= u += AO / 2 * t.actualFontSize : o -= u / 2 } o += HV * t.actualFontSize, i.startPosition.set(n + s.x, o + s.y) }, e._updateTexture = function (t, e, i, n) { var r = this._context, s = this._canvas; if (r && s) { r.clearRect(0, 0, s.width, s.height), r.font = t.fontDesc, this._calculateFillTextStartPosition(t, e, i); var a = this._getLineHeight(e.lineHeight, t.actualFontSize, t.fontSize); r.lineJoin = "round", t.isOutlined ? (r.fillStyle = "rgba(" + t.outlineColor.r + ", " + t.outlineColor.g + ", " + t.outlineColor.b + ", " + WV + ")", r.fillRect(0, 0, s.width, s.height)) : (r.fillStyle = "rgba(" + t.color.r + ", " + t.color.g + ", " + t.color.b + ", " + WV + ")", r.fillRect(0, 0, s.width, s.height)), r.fillStyle = "rgb(" + t.color.r + ", " + t.color.g + ", " + t.color.b + ")"; var o = i.startPosition, u = new as(o.x, o.y), h = u.x, c = 0; this._drawTextEffect(u, a, t, e, i); for (var l = i.parsedString, f = 0; f < l.length; ++f)c = u.y + f * a, t.hasShadow && (this._setupShadow(t), r.fillText(l[f], h, c)), t.isOutlined && (this._setupOutline(t), r.strokeText(l[f], h, c)), t.hasShadow && !t.isOutlined || r.fillText(l[f], h, c); t.hasShadow && (r.shadowColor = "transparent"), this._uploadTexture(n) } }, e._uploadTexture = function (t) { var e, i = this._canvas; t.texture && i && (e = t.texture instanceof vO ? t.texture.texture : t.texture, 0 !== i.width && 0 !== i.height && (e.getGFXTexture(), e.getGFXSampler(), e.reset({ width: i.width, height: i.height, mipmapLevel: 1 }), e.uploadData(i), e.setWrapMode(2, 2), t.texture instanceof vO && (t.texture.rect = new fs(0, 0, i.width, i.height), t.texture._calculateUV()), S.director.root && S.director.root.batcher2D && S.director.root.batcher2D._releaseDescriptorSetCache(e.getHash()))) }, e._drawTextEffect = function (t, e, i, n, r) { if (i.hasShadow || i.isOutlined || i.isUnderline) { for (var s = this._context, a = r.parsedString, o = a.length > 1 && i.hasShadow, u = this._measureText(this._context, i.fontDesc), h = 0, c = 0, l = 0; l < a.length; ++l)if (h = t.x, c = t.y + l * e, o && (i.hasShadow && (this._setupShadow(i), s.fillText(a[l], h, c)), i.isOutlined && (this._setupOutline(i), s.strokeText(a[l], h, c)), i.hasShadow && !i.isOutlined || s.fillText(a[l], h, c)), i.isUnderline) { var f = u(a[l]), d = new as; 2 === n.horizontalAlign ? d.x = t.x - f : 1 === n.horizontalAlign ? d.x = t.x - f / 2 : d.x = t.x, d.y = c + i.actualFontSize / 8, s.fillRect(d.x, d.y, f, i.underlineHeight * this._fontScale) } o && (s.shadowColor = "transparent") } }, e._setupOutline = function (t) { var e = this._context; e.shadowBlur = 0, e.shadowOffsetX = 0, e.shadowOffsetY = 0, e.strokeStyle = "rgba(" + t.outlineColor.r + ", " + t.outlineColor.g + ", " + t.outlineColor.b + ", " + t.outlineColor.a / 255 + ")", e.lineWidth = 2 * t.outlineWidth * this._fontScale }, e._setupShadow = function (t) { var e = this._context, i = this._fontScale; e.shadowColor = "rgba(" + t.shadowColor.r + ", " + t.shadowColor.g + ", " + t.shadowColor.b + ", " + t.shadowColor.a / 255 + ")", e.shadowBlur = t.shadowBlur * i, e.shadowOffsetX = t.shadowOffsetX * i, e.shadowOffsetY = -t.shadowOffsetY * i }, e.generateVertexData = function (t, e, i, n, r, s, a) { t ? this._updateQuads(e, i, n, r, s, a) : (this.updateQuatCount(r), a(e, n, r)) }, e.updateQuatCount = function (t) { var e = t.vertexBuffer, i = t.quadCount; if (e.length !== i) { for (var n = e.length; n < i; n++)e.push({ x: 0, y: 0, z: 0, u: 0, v: 0, color: rr.WHITE.clone() }); e.length = i } }, e._setupBMFontOverflowMetrics = function (t, e) { var i = e.nodeContentSize, n = i.width, r = i.height; 3 === t.overFlow && (r = 0), 0 === t.overFlow && (n = 0, r = 0), t.textWidthTemp = n, t.textHeightTemp = r, t.textDimensions.width = n, t.textDimensions.height = r, t.maxLineWidth = n }, e._updateFontScale = function (t) { t.bmfontScale = t.actualFontSize / (t.originFontSize * this._fontScale) }, e._computeHorizontalKerningForText = function (t, e, i) { var n = i, r = n.length; if (t.fntConfig) { var s = t.fntConfig.kerningDict, a = e.horizontalKerning; if (s && 0 !== s.length) for (var o = -1, u = 0; u < r; ++u) { var h = n.charCodeAt(u), c = s[o << 16 | 65535 & h] || 0; a[u] = u < r - 1 ? c : 0, o = h } } }, e._alignText = function (t, e, i, n) { this._multilineTextWrap(t, e, i, n, this._getFirstWordLen), 2 === e.overFlow && (t.fontSize > 0 && this._isVerticalClamp(t, e, i, n, this) && this._shrinkLabelToContentSize(t, e, i, n, this._isVerticalClamp), t.fontSize > 0 && this._isHorizontalNeedShrink(e, i) && this._shrinkLabelToContentSize(t, e, i, n, this._isHorizontalClamp)), this._parsedString(i, n) }, e._parsedString = function (t, e) { for (var i = [], n = "", r = 0, s = 0, a = HO(e); r < a; ++r) { var o = this._lettersInfo[r]; o.valid && (s === o.line ? n += o.char : (i = i.concat(n), s = o.line, n = "")) } i = i.concat(n), t.parsedString = i }, e._multilineTextWrap = function (t, e, i, n, r) { e.linesWidth.length = 0; for (var s = n, a = s.length, o = 0, u = 0, h = 0, c = 0, l = 0, f = 0, d = 0, p = null, _ = 0; _ < a;) { var g = WO(s, _); if ("\n" !== g) { for (var m = r(t, e, s, _, a), v = f, y = d, b = l, w = u, x = !1, S = new as, T = 0; T < m; ++T) { var I = _ + T; if ("\r" !== (g = WO(s, I))) if (p = FL.fontAtlas.getLetterDefinitionForChar(g, FL)) { var E = w + p.offsetX * t.bmfontScale - FL.margin; if (e.wrapping && e.maxLineWidth > 0 && u > 0 && E + p.w * t.bmfontScale > e.maxLineWidth && !VO(g)) { e.linesWidth.push(l), l = 0, o++, u = 0, h -= e.lineHeight * this._getFontScale(t, e) + 0, x = !0; break } S.x = E, S.y = h - p.offsetY * t.bmfontScale, this._recordLetterInfo(S, g, I, o), I + 1 < e.horizontalKerning.length && I < a - 1 && (w += e.horizontalKerning[I + 1] * t.bmfontScale), w += p.xAdvance * t.bmfontScale + e.spacingX, b = S.x + p.w * t.bmfontScale, v < S.y && (v = S.y), y > S.y - p.h * t.bmfontScale && (y = S.y - p.h * t.bmfontScale) } else this._recordPlaceholderInfo(I, g), null != t.fntConfig ? J(16354, t.fntConfig.atlasName, g) : J(16355, t.fontFamily, g); else this._recordPlaceholderInfo(I, g) } x || (u = w, f < v && (f = v), d > y && (d = y), c < (l = b) && (c = l), _ += m) } else e.linesWidth.push(l), l = 0, o++, u = 0, h -= e.lineHeight * this._getFontScale(t, e) + 0, this._recordPlaceholderInfo(_, g), _++ } e.linesWidth.push(l), e.numberOfLines = o + 1, e.textDesiredHeight = e.numberOfLines * e.lineHeight * this._getFontScale(t, e), e.numberOfLines > 1 && (e.textDesiredHeight += 0 * (e.numberOfLines - 1)); var A = i.nodeContentSize; return A.width = e.textWidthTemp, A.height = e.textHeightTemp, e.textWidthTemp <= 0 && (A.width = parseFloat(c.toFixed(2)) + 2 * FL.margin), e.textHeightTemp <= 0 && (A.height = parseFloat(e.textDesiredHeight.toFixed(2)) + 2 * FL.margin), e.tailoredTopY = A.height, e.tailoredBottomY = 0, f > 0 && (e.tailoredTopY = A.height + f), d < -e.textDesiredHeight && (e.tailoredBottomY = e.textDesiredHeight + d), !0 }, e._recordPlaceholderInfo = function (t, e) { var i = this._lettersInfo; if (t >= i.length) { var n = new jV; i.push(n) } i[t].char = e, i[t].hash = "" + jO(e, 0) + FL.hash, i[t].valid = !1 }, e._recordLetterInfo = function (t, e, i, n) { var r = this._lettersInfo; if (i >= r.length) { var s = new jV; r.push(s) } var a = "" + jO(e, 0) + FL.hash; r[i].line = n, r[i].char = e, r[i].hash = a, r[i].valid = FL.fontAtlas.getLetter(a).valid, r[i].x = t.x, r[i].y = t.y }, e._getFirstWordLen = function (t, e, i, n, r) { var s = WO(i, n); if (UO(s) || "\n" === s || VO(s)) return 1; var a = FL.fontAtlas, o = 1, u = a.getLetterDefinitionForChar(s, FL); if (!u) return o; for (var h = u.xAdvance * t.bmfontScale + e.spacingX, c = n + 1; c < r && (s = WO(i, c), u = a.getLetterDefinitionForChar(s, FL)); ++c) { if (h + u.offsetX * t.bmfontScale + u.w * t.bmfontScale > e.maxLineWidth && !VO(s) && e.maxLineWidth > 0) return o; if (h += u.xAdvance * t.bmfontScale + e.spacingX, "\n" === s || VO(s) || UO(s)) break; o++ } return o }, e._computeAlignmentOffset = function (t, e, i) { var n = i.nodeContentSize; switch (e.linesOffsetX.length = 0, e.letterOffsetY = 0, e.horizontalAlign) { case 0: for (var r = 0; r < e.numberOfLines; ++r)e.linesOffsetX.push(0); break; case 1: for (var s = 0, a = e.linesWidth.length; s < a; s++)e.linesOffsetX.push((n.width - e.linesWidth[s]) / 2); break; case 2: for (var o = 0, u = e.linesWidth.length; o < u; o++)e.linesOffsetX.push(n.width - e.linesWidth[o]) }if (e.letterOffsetY = n.height, 0 !== e.verticalAlign) { var h = n.height - e.textDesiredHeight + e.lineHeight * this._getFontScale(t, e) - t.originFontSize * this._fontScale * t.bmfontScale; 2 === e.verticalAlign ? e.letterOffsetY -= h : e.letterOffsetY -= h / 2 } }, e._getFontScale = function (t, e) { return 2 === e.overFlow ? t.bmfontScale : 1 }, e._isVerticalClamp = function (t, e, i) { return e.textDesiredHeight > i.nodeContentSize.height }, e._isHorizontalClamp = function (t, e, i, n, r) { for (var s = !1, a = 0, o = HO(n); a < o; ++a) { var u = r._lettersInfo[a]; if (u.valid) { var h = FL.fontAtlas.getLetterDefinitionForChar(u.char, FL); if (!h) continue; var c = u.x + h.w * t.bmfontScale, l = u.line; if (e.textWidthTemp > 0) { var f = i.nodeContentSize; if (e.wrapping) { if (e.linesWidth[l] > f.width && (c > f.width || c < 0)) { s = !0; break } } else if (c > f.width) { s = !0; break } } } } return s }, e._isHorizontalNeedShrink = function (t, e) { for (var i = 0, n = t.linesWidth.length; i < n; ++i)if (t.linesWidth[i] > e.nodeContentSize.width) return !0; return !1 }, e._shrinkLabelToContentSize = function (t, e, i, n, r) { for (var s = 0, a = 0 | t.actualFontSize, o = 0; s < a;) { var u = o = s + a + 1 >> 1; if (u <= 0) break; t.bmfontScale = u / (t.originFontSize * this._fontScale), this._multilineTextWrap(t, e, i, n, this._getFirstWordLen), this._computeAlignmentOffset(t, e, i), r(t, e, i, n, this) ? a = o - 1 : s = o } s >= 0 && this._scaleFontSizeDown(t, e, i, n, s) }, e._scaleFontSizeDown = function (t, e, i, n, r) { var s = !0; r || (r = .1, s = !1), t.actualFontSize = r, s && (this._updateFontScale(t), this._multilineTextWrap(t, e, i, n, this._getFirstWordLen)) }, e._updateQuads = function (t, e, i, n, r, s) { for (var a = FL.fontAtlas, o = t.spriteFrame ? t.spriteFrame.texture : a.getTexture(), u = i.nodeContentSize, h = n.uiTransAnchorX * u.width, c = n.uiTransAnchorY * u.height, l = 0, f = HO(r); l < f; ++l) { var d = this._lettersInfo[l]; if (d.valid) { var p = a.getLetter(d.hash); if (p) { var _ = this._tmpRect; _.height = p.h, _.width = p.w, _.x = p.u, _.y = p.v; var g = d.y + e.letterOffsetY; if (e.textHeightTemp > 0) { if (g > e.tailoredTopY) { var m = g - e.tailoredTopY; _.y += m, _.height -= m, g -= m } g - _.height * t.bmfontScale < e.tailoredBottomY && 1 === e.overFlow && (_.height = g < e.tailoredBottomY ? 0 : (g - e.tailoredBottomY) / t.bmfontScale) } var v = d.line, y = d.x + p.w / 2 * t.bmfontScale + e.linesOffsetX[v]; if (e.textWidthTemp > 0 && this._isHorizontalClamped(e, i, y, v) && 1 === e.overFlow && (_.width = 0), _.height > 0 && _.width > 0) { var b = this._determineRect(t), w = d.x + e.linesOffsetX[d.line], x = n.quadCount; n.quadCount += 4, this.updateQuatCount(n), s(t, i, n, x, o, _, b, w - h, g - c) } } else it(16353) } } return !0 }, e._isHorizontalClamped = function (t, e, i, n) { var r = e.nodeContentSize, s = t.linesWidth[n], a = i > r.width || i < 0; return t.wrapping ? s > r.width && a : a }, e._determineRect = function (t) { var e = t.spriteFrame; if (!e) return !1; var i = e.isRotated(), n = e.getOriginalSize(), r = e.getRect(), s = e.getOffset(), a = s.x + (n.width - r.width) / 2, o = s.y - (n.height - r.height) / 2, u = this._tmpRect; if (i) { var h = u.x; u.x = r.x + r.height - u.y - u.height - o, u.y = h + r.y - a, u.y < 0 && (u.height += o) } else u.x += r.x - a, u.y += r.y + o; return i }, t }(); XV.instance = void 0, XV.instance = new XV; var qV = new LL(64, 64), YV = new IL(null), KV = null, QV = null, ZV = null, JV = null, $V = null, tG = function () { function t() { } var e = t.prototype; return e.updateProcessingData = function (t, e, i, n, r, s) { t.fontSize = r.fontSize, t.actualFontSize = r.fontSize, t.originFontSize = ZV ? ZV.fontSize : r.fontSize, e.horizontalAlign = r.horizontalAlign, e.verticalAlign = r.verticalAlign, e.spacingX = r.spacingX; var a = r.overflow; e.overFlow = a, e.lineHeight = r.lineHeight, i.nodeContentSize.width = s.width, i.nodeContentSize.height = s.height, 0 === a ? (e.wrapping = !1, i.nodeContentSize.width += 2 * FL.margin, i.nodeContentSize.height += 2 * FL.margin) : 3 === a ? (e.wrapping = !0, i.nodeContentSize.height += 2 * FL.margin) : e.wrapping = r.enableWrapText, n.uiTransAnchorX = s.anchorX, n.uiTransAnchorY = s.anchorY, FL.lineHeight = r.lineHeight, FL.fontSize = r.fontSize, t.spriteFrame = JV, t.fntConfig = ZV, t.fontFamily = FL.fontFamily, t.color.set(r.color) }, e.updateRenderData = function (t) { if (t.renderData && KV !== t) { if (t.renderData.vertDirty) { QV = (KV = t).node._getUITransformComp(); var e = t.renderData, i = XV.instance, n = t.textStyle, r = t.textLayout, s = t.textLayoutData, a = t.textRenderData; n.fontScale = cM.getScaleX(), this._updateFontFamily(t), this.updateProcessingData(n, r, s, a, t, QV), this._updateLabelInfo(t), n.fontDesc = FL.fontDesc, i.processingString(!0, n, r, s, t.string), a.quadCount = 0, i.generateRenderInfo(!0, n, r, s, a, t.string, this.generateVertexData), e.dataLength !== a.quadCount && (this.resetRenderData(t), e.dataLength = a.quadCount, e.resize(e.dataLength, e.dataLength / 2 * 3)); for (var o = e.data, u = 0, h = a.quadCount; u < h; u++)o[u] = a.vertexBuffer[u]; var c = e.indexCount; this.createQuadIndices(c), e.chunk.setIndexBuffer($V), KV.actualFontSize = n.actualFontSize, QV.setContentSize(s.nodeContentSize), this.updateUVs(t), e.vertDirty = !1, KV = null, this._resetProperties() } t.spriteFrame && t.renderData.updateRenderData(t, t.spriteFrame) } }, e.updateUVs = function (t) { for (var e = t.renderData, i = e.chunk.vb, n = e.vertexCount, r = e.floatStride, s = e.data, a = 3, o = 0; o < n; o++) { var u = s[o]; i[a] = u.u, i[a + 1] = u.v, a += r } }, e.updateColor = function () { }, e.resetRenderData = function (t) { var e = t.renderData; e.dataLength = 0, e.resize(0, 0) }, e.generateVertexData = function (t, e, i, n, r, s, a, o, u) { var h = n, c = t.bmfontScale, l = i.vertexBuffer, f = r.width, d = r.height, p = s.width, _ = s.height, g = 0, m = 0, v = 0, y = 0; a ? (g = s.x / f, y = (s.x + _) / f, m = (s.y + p) / d, v = s.y / d, l[h].u = g, l[h].v = v, l[h + 1].u = g, l[h + 1].v = m, l[h + 2].u = y, l[h + 2].v = v, l[h + 3].u = y, l[h + 3].v = m) : (g = s.x / f, y = (s.x + p) / f, m = (s.y + _) / d, v = s.y / d, l[h].u = g, l[h].v = m, l[h + 1].u = y, l[h + 1].v = m, l[h + 2].u = g, l[h + 2].v = v, l[h + 3].u = y, l[h + 3].v = v), l[h].x = o, l[h].y = u - _ * c, l[h + 1].x = o + p * c, l[h + 1].y = u - _ * c, l[h + 2].x = o, l[h + 2].y = u, l[h + 3].x = o + p * c, l[h + 3].y = u }, e._updateFontFamily = function (t) { var e = t.font; JV = e.spriteFrame, ZV = e.fntConfig, FL.fontAtlas = e.fontDefDictionary, FL.fontAtlas || (2 === t.cacheMode ? FL.fontAtlas = qV : FL.fontAtlas = YV), yM.packToDynamicAtlas(t, JV) }, e._updateLabelInfo = function () { FL.hash = "", FL.margin = 0 }, e._resetProperties = function () { ZV = null, JV = null, FL.hash = "", FL.margin = 0 }, e.createQuadIndices = function (t) { if (t % 6 == 0) { var e = t / 6; $V = new Uint16Array(t); for (var i = 0, n = 0; n < e; n++)$V[i++] = 0 + 4 * n, $V[i++] = 1 + 4 * n, $V[i++] = 2 + 4 * n, $V[i++] = 1 + 4 * n, $V[i++] = 3 + 4 * n, $V[i++] = 2 + 4 * n } else rt(16308) }, t }(), eG = new rr(255, 255, 255, 255), iG = function (t) { function e() { return t.apply(this, arguments) || this } s(e, t); var i = e.prototype; return i.createData = function (t) { var e = t.requestRenderData(); return e.resize(0, 0), e }, i.fillBuffers = function (t) { var e = t.node; eG.set(t.color), eG.a = 255 * e._uiProps.opacity, O_(e, 0, t.renderData, eG) }, e }(tG), nG = new iG, rG = null, sG = function (t) { function e() { return t.apply(this, arguments) || this } s(e, t); var i = e.prototype; return i.getAssemblerData = function () { return rG || (rG = new LL(1024, 1024)), rG.getTexture() }, i._updateFontFamily = function (t) { FL.fontAtlas = rG, FL.fontFamily = this._getFontFamily(t), t.enableOutline && t.outlineWidth > 0 ? (FL.isOutlined = !0, FL.margin = t.outlineWidth, FL.out = t.outlineColor.clone(), FL.out.a = t.outlineColor.a * t.color.a / 255) : (FL.isOutlined = !1, FL.margin = 0) }, i._getFontFamily = function (t) { var e = "Arial"; return t.useSystemFont ? e = t.fontFamily || "Arial" : t.font && (e = t.font._nativeAsset || "Arial"), e }, i._updateLabelInfo = function (t) { FL.fontDesc = this._getFontDesc(), FL.color.set(t.color), FL.hash = kL(FL) }, i._getFontDesc = function () { return FL.fontSize.toString() + "px " + FL.fontFamily }, e }(tG), aG = new rr(255, 255, 255, 255), oG = function (t) { function e() { return t.apply(this, arguments) || this } s(e, t); var i = e.prototype; return i.createData = function (t) { var e = t.requestRenderData(); return e.resize(0, 0), e }, i.fillBuffers = function (t) { if (t.renderData) { var e = t.node; aG.a = 255 * e._uiProps.opacity, O_(e, 0, t.renderData, aG) } }, i.updateColor = function () { }, e }(sG), uG = new oG; Zk.Overflow; var hG = function () { function t() { } var e = t.prototype; return e.updateProcessingData = function (t, e, i, n, r, s) { t.isSystemFontUsed = r.useSystemFont, t.fontSize = r.fontSize, i.nodeContentSize.width = i.canvasSize.width = s.width, i.nodeContentSize.height = i.canvasSize.height = s.height, e.lineHeight = r.lineHeight, e.overFlow = r.overflow, 0 === r.overflow ? e.wrapping = !1 : 3 === r.overflow ? e.wrapping = !0 : e.wrapping = r.enableWrapText, t.isBold = r.isBold, t.isItalic = r.isItalic, t.isUnderline = r.isUnderline, t.underlineHeight = r.underlineHeight, r.enableOutline && r.outlineWidth > 0 ? (t.isOutlined = !0, t.outlineColor.set(r.outlineColor), t.outlineWidth = r.outlineWidth) : t.isOutlined = !1, r.enableShadow && (r.shadowBlur > 0 || !ji(r.shadowOffset.x, 0) || !ji(r.shadowOffset.y, 0)) ? (t.hasShadow = !0, t.shadowColor.set(r.shadowColor), t.shadowBlur = r.shadowBlur, t.shadowOffsetX = r.shadowOffset.x, t.shadowOffsetY = r.shadowOffset.y) : t.hasShadow = !1, t.color.set(r.color), n.texture = r.spriteFrame, n.uiTransAnchorX = s.anchorX, n.uiTransAnchorY = s.anchorY, e.horizontalAlign = r.horizontalAlign, e.verticalAlign = r.verticalAlign }, e.getAssemblerData = function () { var t = Zk._canvasPool.get(); return t.canvas.width = t.canvas.height = 1, t }, e.resetAssemblerData = function (t) { t && Zk._canvasPool.put(t) }, e.updateRenderData = function (t) { if (t.renderData) { if (t.renderData.vertDirty) { var e = t.node._getUITransformComp(), i = XV.instance, n = t.textStyle, r = t.textLayout, s = t.textLayoutData, a = t.textRenderData; n.fontScale = cM.getScaleX(), this.updateProcessingData(n, r, s, a, t, e), i.setCanvasUsed(t.assemblerData.canvas, t.assemblerData.context), n.fontFamily = this._updateFontFamily(t), this._resetDynamicAtlas(t), i.processingString(!1, n, r, s, t.string), i.generateRenderInfo(!1, n, r, s, a, t.string, this.generateVertexData); var o = t.renderData; o.textureDirty = !0, this._calDynamicAtlas(t, s), t.actualFontSize = n.actualFontSize, e.setContentSize(s.nodeContentSize); var u = o.data; u[0] = a.vertexBuffer[0], u[1] = a.vertexBuffer[1], u[2] = a.vertexBuffer[2], u[3] = a.vertexBuffer[3], this.updateUVs(t), t.renderData.vertDirty = !1, t.contentWidth = s.nodeContentSize.width } t.spriteFrame && t.renderData.updateRenderData(t, t.spriteFrame) } }, e.generateVertexData = function (t, e, i) { var n = i.vertexBuffer, r = e.nodeContentSize.width, s = e.nodeContentSize.height, a = i.uiTransAnchorX * r, o = i.uiTransAnchorY * s; n[0].x = -a, n[0].y = -o, n[1].x = r - a, n[1].y = -o, n[2].x = -a, n[2].y = s - o, n[3].x = r - a, n[3].y = s - o }, e.updateVertexData = function () { }, e.updateUVs = function () { }, e._updateFontFamily = function (t) { return t.useSystemFont ? t.fontFamily || "Arial" : t.font && t.font._nativeAsset || "Arial" }, e._calDynamicAtlas = function (t, e) { if (!(1 !== t.cacheMode || e.canvasSize.width <= 0 || e.canvasSize.height <= 0)) { var i = t.ttfSpriteFrame; yM.packToDynamicAtlas(t, i) } }, e._resetDynamicAtlas = function (t) { if (1 === t.cacheMode) { var e = t.ttfSpriteFrame; yM.deleteAtlasSpriteFrame(e), e._resetDynamicAtlasFrame() } }, t }(), cG = rr.WHITE.clone(), lG = Uint16Array.from([0, 1, 2, 1, 3, 2]), fG = function (t) { function e() { return t.apply(this, arguments) || this } s(e, t); var i = e.prototype; return i.createData = function (t) { var e = t.requestRenderData(); e.dataLength = 4, e.resize(4, 6), t.textRenderData.quadCount = 4; for (var i = e.chunk.vb, n = e.floatStride, r = [{ u: 0, v: 1 }, { u: 1, v: 1 }, { u: 0, v: 0 }, { u: 1, v: 0 }], s = 3, a = 0, o = e.dataLength; a < o; ++a)i[s] = r[a].u, i[s + 1] = r[a].v, s += n; for (var u = 5, h = 0; h < e.dataLength; h++)rr.toArray(i, cG, u), u += n; return e.chunk.setIndexBuffer(lG), e }, i.fillBuffers = function (t) { for (var e = t.renderData, i = e.chunk, n = e.data, r = t.node, s = i.vb, a = r.worldMatrix, o = e.floatStride, u = 0, h = n.length, c = 0; c < h; c++) { var l = n[c], f = l.x, d = l.y, p = a.m03 * f + a.m07 * d + a.m15; p = p ? 1 / p : 1, s[0 + (u = c * o)] = (a.m00 * f + a.m04 * d + a.m12) * p, s[u + 1] = (a.m01 * f + a.m05 * d + a.m13) * p, s[u + 2] = (a.m02 * f + a.m06 * d + a.m14) * p } var _ = i.vertexOffset, g = i.meshBuffer, m = i.meshBuffer.iData, v = g.indexOffset; m[v++] = _, m[v++] = _ + 1, m[v++] = _ + 2, m[v++] = _ + 2, m[v++] = _ + 1, m[v++] = _ + 3, g.indexOffset += 6 }, i.updateVertexData = function (t) { var e = t.renderData; if (e) { var i = t.node._getUITransformComp(), n = i.width, r = i.height, s = i.anchorX * n, a = i.anchorY * r, o = e.data; o[0].x = -s, o[0].y = -a, o[1].x = n - s, o[1].y = -a, o[2].x = -s, o[2].y = r - a, o[3].x = n - s, o[3].y = r - a } }, i.updateUVs = function (t) { var e = t.renderData; if (e && t.ttfSpriteFrame) for (var i = e.chunk.vb, n = t.ttfSpriteFrame.uv, r = e.floatStride, s = 3, a = 0; a < e.dataLength; ++a) { var o = 2 * a; i[s] = n[o], i[s + 1] = n[o + 1], s += r } }, i.updateColor = function () { }, e }(hG), dG = new fG, pG = t("labelAssembler", { getAssembler: function (t) { var e = dG; return t.font instanceof EL ? e = nG : 2 === t.cacheMode && (e = uG), e } }); Zk.Assembler = pG, iN.FillType; var _G = new Gr, gG = Uint16Array.from([0, 1, 2, 1, 3, 2]), mG = function () { function t() { } var e = t.prototype; return e.updateRenderData = function (t) { var e = t.spriteFrame; yM.packToDynamicAtlas(t, e); var i = t.renderData; if (i && e) { if (!i.vertDirty) return; var n = t.fillStart, r = t.fillRange; r < 0 && (n += r, r = -r), r = (r = (r = n + r) > 1 ? 1 : r) < 0 ? 0 : r; var s = (n = (n = n > 1 ? 1 : n) < 0 ? 0 : n) + (r = (r -= n) < 0 ? 0 : r); s = s > 1 ? 1 : s, this.updateUVs(t, n, s), this.updateVertexData(t, n, s), i.updateRenderData(t, e) } }, e.updateUVs = function (t, e, i) { var n = t.spriteFrame, r = t.renderData, s = r.chunk.vb, a = n.width, o = n.height, u = n.rect, h = 0, c = 0, l = 0, f = 0, d = 0, p = 0, _ = 0, g = 0, m = 0, v = 0; n.isRotated() ? (h = u.x / a, c = (u.y + u.width) / o, l = d = h, _ = m = (u.x + u.height) / a, p = v = c, f = g = u.y / o) : (h = u.x / a, c = (u.y + u.height) / o, l = _ = h, d = m = (u.x + u.width) / a, f = p = c, g = v = u.y / o); var y = r.floatStride, b = 3; switch (t.fillType) { case 0: s[b] = l + (d - l) * e, s[b + 1] = f + (p - f) * e, s[b += y] = l + (d - l) * i, s[b + 1] = f + (p - f) * i, s[b += y] = _ + (m - _) * e, s[b + 1] = g + (v - g) * e, s[b += y] = _ + (m - _) * i, s[b + 1] = g + (v - g) * i; break; case 1: s[b] = l + (_ - l) * e, s[b + 1] = f + (g - f) * e, s[b += y] = d + (m - d) * e, s[b + 1] = p + (v - p) * e, s[b += y] = l + (_ - l) * i, s[b + 1] = f + (g - f) * i, s[b += y] = d + (m - d) * i, s[b + 1] = p + (v - p) * i; break; default: rt(2626) } }, e.updateVertexData = function (t, e, i) { var n = t.renderData.data, r = t.node._getUITransformComp(), s = r.width, a = r.height, o = r.anchorX * s, u = r.anchorY * a, h = -o, c = -u, l = s - o, f = a - u, d = 0; switch (t.fillType) { case 0: d = h + (l - h) * i, h += (l - h) * e, l = d; break; case 1: d = c + (f - c) * i, c += (f - c) * e, f = d; break; default: rt(2626) }n[0].x = h, n[0].y = c, n[1].x = l, n[1].y = c, n[2].x = h, n[2].y = f, n[3].x = l, n[3].y = f }, e.createData = function (t) { var e = t.requestRenderData(); return e.dataLength = 4, e.resize(4, 6), e.chunk.setIndexBuffer(gG), e.data.forEach((function (t) { t.z = 0 })), e }, e.updateWorldVertexData = function (t, e) { t.node.getWorldMatrix(_G); for (var i = t.renderData.floatStride, n = t.renderData.data, r = e.vb, s = 0, a = 0; a < 4; a++) { var o = n[a], u = o.x, h = o.y, c = _G.m03 * u + _G.m07 * h + _G.m15; c = c ? 1 / c : 1, r[s = a * i] = (_G.m00 * u + _G.m04 * h + _G.m12) * c, r[s + 1] = (_G.m01 * u + _G.m05 * h + _G.m13) * c, r[s + 2] = (_G.m02 * u + _G.m06 * h + _G.m14) * c } }, e.fillBuffers = function (t) { var e = t.renderData, i = e.chunk; (t._flagChangedVersion !== t.node.flagChangedVersion || e.vertDirty) && (this.updateWorldVertexData(t, i), e.vertDirty = !1, t._flagChangedVersion = t.node.flagChangedVersion), i.bufferId; var n = i.vertexOffset, r = i.meshBuffer, s = i.meshBuffer.iData, a = r.indexOffset; s[a++] = n, s[a++] = n + 1, s[a++] = n + 2, s[a++] = n + 2, s[a++] = n + 1, s[a++] = n + 3, r.indexOffset += 6 }, e.updateColor = function (t) { for (var e = t.renderData, i = e.chunk.vb, n = e.floatStride, r = 5, s = t.color, a = s.r / 255, o = s.g / 255, u = s.b / 255, h = t.node._uiProps.opacity, c = 0; c < 4; c++)i[r] = a, i[r + 1] = o, i[r + 2] = u, i[r + 3] = h, r += n }, t }(), vG = new mG, yG = 2 * Math.PI, bG = 1e-6, wG = new Gr, xG = [new as, new as, new as, new as], SG = new Array(4), TG = new Array(8), IG = [new as, new as, new as, new as], EG = [new as, new as, new as, new as], AG = new as, CG = [new as, new as, new as, new as], DG = null; function RG(t, e, i, n, r, s, a) { var o = Math.sin(s); o = Math.abs(o) > bG ? o : 0; var u = Math.cos(s), h = 0, c = 0; if (0 !== (u = Math.abs(u) > bG ? u : 0)) { if (h = o / u, (t - r.x) * u > 0) { var l = r.y + h * (t - r.x); a[0].x = t, a[0].y = l } if ((e - r.x) * u > 0) { var f = r.y + h * (e - r.x); a[2].x = e, a[2].y = f } } if (0 !== o) { if (c = u / o, (n - r.y) * o > 0) { var d = r.x + c * (n - r.y); a[3].x = d, a[3].y = n } if ((i - r.y) * o > 0) { var p = r.x + c * (i - r.y); a[1].x = p, a[1].y = i } } } function PG(t) { var e = t.node._getUITransformComp(), i = e.width, n = e.height, r = e.anchorX * i, s = e.anchorY * n, a = -r, o = -s, u = i - r, h = n - s, c = SG; c[0] = a, c[1] = o, c[2] = u, c[3] = h; var l = t.fillCenter, f = AG.x = Math.min(Math.max(0, l.x), 1) * (u - a) + a, d = AG.y = Math.min(Math.max(0, l.y), 1) * (h - o) + o; xG[0].x = xG[3].x = a, xG[1].x = xG[2].x = u, xG[0].y = xG[1].y = o, xG[2].y = xG[3].y = h, CG.forEach((function (t) { as.set(t, 0, 0) })), f !== c[0] && as.set(CG[0], 3, 0), f !== c[2] && as.set(CG[2], 1, 2), d !== c[1] && as.set(CG[1], 0, 1), d !== c[3] && as.set(CG[3], 2, 3) } function BG(t) { var e = t.width, i = t.height, n = t.getRect(), r = 0, s = 0, a = 0, o = 0, u = TG; t.isRotated() ? (r = n.x / e, s = (n.x + n.height) / e, a = n.y / i, o = (n.y + n.width) / i, u[0] = u[2] = r, u[4] = u[6] = s, u[3] = u[7] = o, u[1] = u[5] = a) : (r = n.x / e, s = (n.x + n.width) / e, a = n.y / i, o = (n.y + n.height) / i, u[0] = u[4] = r, u[2] = u[6] = s, u[1] = u[3] = o, u[5] = u[7] = a) } function MG(t, e) { var i = e.x - t.x, n = e.y - t.y; if (0 === i && 0 === n) return 0; if (0 === i) return n > 0 ? .5 * Math.PI : 1.5 * Math.PI; var r = Math.atan(n / i); return i < 0 && (r += Math.PI), r } function OG(t, e, i, n, r) { var s = SG, a = s[0], o = s[1], u = s[2], h = s[3]; t[e].x = i.x, t[e].y = i.y, t[e + 1].x = n.x, t[e + 1].y = n.y, t[e + 2].x = r.x, t[e + 2].y = r.y, LG((i.x - a) / (u - a), (i.y - o) / (h - o), t, e), LG((n.x - a) / (u - a), (n.y - o) / (h - o), t, e + 1), LG((r.x - a) / (u - a), (r.y - o) / (h - o), t, e + 2) } function LG(t, e, i, n) { var r = TG, s = r[0] + (r[2] - r[0]) * t, a = r[4] + (r[6] - r[4]) * t, o = r[1] + (r[3] - r[1]) * t, u = r[5] + (r[7] - r[5]) * t, h = i[n]; h.u = s + (a - s) * e, h.v = o + (u - o) * e } for (var FG = function () { function t() { } var e = t.prototype; return e.createData = function (t) { return t.requestRenderData() }, e.updateRenderData = function (t) { var e = t.spriteFrame; yM.packToDynamicAtlas(t, e), this.updateUVs(t); var i = t.renderData; if (i && e) { if (!i.vertDirty) return; var n = i.data, r = t.fillStart, s = t.fillRange; for (s < 0 && (r += s, s = -s); r >= 1;)r -= 1; for (; r < 0;)r += 1; var a = (r *= yG) + (s *= yG); PG(t), BG(e), RG(SG[0], SG[2], SG[1], SG[3], AG, r, IG), RG(SG[0], SG[2], SG[1], SG[3], AG, r + s, EG); for (var o = 0, u = 0; u < 4; ++u) { var h = CG[u]; if (h) if (s >= yG) i.dataLength = o + 3, OG(n, o, AG, xG[h.x], xG[h.y]), o += 3; else { var c = MG(AG, xG[h.x]), l = MG(AG, xG[h.y]); l < c && (l += yG), c -= yG, l -= yG; for (var f = 0; f < 3; ++f)c >= a || (c >= r ? (i.dataLength = o + 3, OG(n, o, AG, xG[h.x], l >= a ? EG[u] : xG[h.y]), o += 3) : l > r && (l <= a ? (i.dataLength = o + 3, OG(n, o, AG, IG[u], xG[h.y]), o += 3) : (i.dataLength = o + 3, OG(n, o, AG, IG[u], EG[u]), o += 3))), c += yG, l += yG } } 0 === o && (i.dataLength = 0), i.resize(o, o), i.updateRenderData(t, e) } }, e.createQuadIndices = function (t) { DG = null, DG = new Uint16Array(t); for (var e = 0, i = 0; i < t; i++)DG[e++] = i }, e.fillBuffers = function (t) { var e = t.node, i = t.renderData, n = i.chunk; (t._flagChangedVersion !== e.flagChangedVersion || i.vertDirty) && (this.updateWorldVertexAndUVData(t, n), i.vertDirty = !1, t._flagChangedVersion = e.flagChangedVersion), this.updateColorLate(t), n.bufferId; for (var r = n.vertexOffset, s = n.meshBuffer, a = n.meshBuffer.iData, o = s.indexOffset, u = 0; u < i.indexCount; u++)a[o + u] = r + u; s.indexOffset += i.indexCount, s.setDirty() }, e.updateWorldUVData = function (t) { for (var e = t.renderData, i = e.floatStride, n = e.data, r = e.chunk.vb, s = 0; s < n.length; s++) { var a = s * i; r[a + 3] = n[s].u, r[a + 4] = n[s].v } }, e.updateWorldVertexAndUVData = function (t, e) { t.node.getWorldMatrix(wG); for (var i = t.renderData, n = i.floatStride, r = t.renderData.data, s = e.vb, a = i.vertexCount, o = 0, u = 0; u < a; u++) { var h = r[u], c = h.x, l = h.y, f = wG.m03 * c + wG.m07 * l + wG.m15; f = f ? 1 / f : 1, s[o + 0] = (wG.m00 * c + wG.m04 * l + wG.m12) * f, s[o + 1] = (wG.m01 * c + wG.m05 * l + wG.m13) * f, s[o + 2] = (wG.m02 * c + wG.m06 * l + wG.m14) * f, s[o + 3] = h.u, s[o + 4] = h.v, o += n } }, e.updateUVs = function (t) { t.renderData.vertDirty = !0, t._markForUpdateRenderData() }, e.updateColorLate = function (t) { for (var e = t.renderData, i = e.chunk.vb, n = e.floatStride, r = e.vertexCount, s = 5, a = t.color, o = a.r / 255, u = a.g / 255, h = a.b / 255, c = t.node._uiProps.opacity, l = 0; l < r; l++)i[s] = o, i[s + 1] = u, i[s + 2] = h, i[s + 3] = c, s += n }, e.updateColor = function () { }, t }(), kG = new FG, NG = Uint16Array.from([0, 1, 2, 1, 3, 2]), zG = function () { function t() { } var e = t.prototype; return e.createData = function (t) { var e = t.requestRenderData(); return e.dataLength = 4, e.resize(4, 6), e.chunk.setIndexBuffer(NG), e }, e.updateRenderData = function (t) { var e = t.spriteFrame; yM.packToDynamicAtlas(t, e), this.updateUVs(t); var i = t.renderData; i && e && (i.vertDirty && this.updateVertexData(t), i.updateRenderData(t, e)) }, e.updateWorldVerts = function (t, e) { var i = t.renderData; if (i) for (var n = e.vb, r = i.data, s = t.node.worldMatrix, a = s.m00, o = s.m01, u = s.m02, h = s.m03, c = s.m04, l = s.m05, f = s.m06, d = s.m07, p = s.m12, _ = s.m13, g = s.m14, m = s.m15, v = i.floatStride, y = 0, b = r.length, w = 0; w < b; ++w) { var x = r[w], S = x.x, T = x.y, I = h * S + d * T + m; I = I ? 1 / I : 1, n[0 + (y = w * v)] = (a * S + c * T + p) * I, n[y + 1] = (o * S + l * T + _) * I, n[y + 2] = (u * S + f * T + g) * I } }, e.fillBuffers = function (t) { if (null !== t) { var e = t.renderData; if (e) { var i = e.chunk; (t._flagChangedVersion !== t.node.flagChangedVersion || e.vertDirty) && (this.updateWorldVerts(t, i), e.vertDirty = !1, t._flagChangedVersion = t.node.flagChangedVersion); var n = i.vertexOffset, r = i.meshBuffer, s = i.meshBuffer.iData, a = r.indexOffset, o = n; s[a++] = o, s[a++] = o + 1, s[a++] = o + 2, s[a++] = o + 1, s[a++] = o + 3, s[a++] = o + 2, r.indexOffset += 6 } } }, e.updateVertexData = function (t) { var e = t.renderData; if (e) { var i = t.node._getUITransformComp(), n = e.data, r = i.width, s = i.height, a = i.anchorX * r, o = i.anchorY * s, u = 0, h = 0, c = 0, l = 0; if (t.trim) u = -a, h = -o, c = r - a, l = s - o; else { var f = t.spriteFrame, d = f.originalSize, p = r / d.width, _ = s / d.height, g = f.trimmedBorder; u = g.x * p - a, h = g.z * _ - o, c = r + g.y * p - a, l = s + g.w * _ - o } n[0].x = u, n[0].y = h, n[1].x = c, n[1].y = h, n[2].x = u, n[2].y = l, n[3].x = c, n[3].y = l, e.vertDirty = !0 } }, e.updateUVs = function (t) { var e = t.renderData; if (t.spriteFrame && e) for (var i = e.chunk.vb, n = t.spriteFrame.uv, r = e.floatStride, s = 3, a = 0; a < e.dataLength; ++a) { var o = 2 * a; i[s] = n[o], i[s + 1] = n[o + 1], s += r } }, e.updateColor = function (t) { var e = t.renderData; if (e) for (var i = e.chunk.vb, n = 5, r = t.color, s = r.r / 255, a = r.g / 255, o = r.b / 255, u = r.a / 255, h = 0; h < 4; h++, n += e.floatStride)i[n] = s, i[n + 1] = a, i[n + 2] = o, i[n + 3] = u }, t }(), UG = new zG, VG = [], GG = 0; GG < 4; GG++)VG.push({ x: 0, y: 0, z: 0, u: 0, v: 0, color: new rr }); var HG, WG, jG, XG, qG, YG, KG, QG = function () { function t() { this.QUAD_INDICES = void 0 } var e = t.prototype; return e.createData = function (t) { var e = t.requestRenderData(); e.dataLength = 16, e.resize(16, 54); var i = this.QUAD_INDICES = new Uint16Array(54); return this.createQuadIndices(4, 4), e.chunk.setIndexBuffer(i), e }, e.createQuadIndices = function (t, e) { for (var i = 0, n = this.QUAD_INDICES, r = 0; r < t - 1; r++)for (var s = 0; s < e - 1; s++) { var a = r * e + s; n[i++] = a, n[i++] = a + 1, n[i++] = a + e, n[i++] = a + 1, n[i++] = a + 1 + e, n[i++] = a + e } }, e.updateRenderData = function (t) { var e = t.spriteFrame; yM.packToDynamicAtlas(t, e), this.updateUVs(t); var i = t.renderData; i && e && (i.vertDirty && this.updateVertexData(t), i.updateRenderData(t, e)) }, e.updateVertexData = function (t) { var e = t.renderData; if (e) { var i = e.data, n = t.node._getUITransformComp(), r = n.width, s = n.height, a = n.anchorX * r, o = n.anchorY * s, u = t.spriteFrame, h = u.insetLeft, c = u.insetRight, l = u.insetTop, f = u.insetBottom, d = r - h - c, p = s - l - f, _ = r / (h + c), g = s / (l + f); _ = Number.isNaN(_) || _ > 1 ? 1 : _, g = Number.isNaN(g) || g > 1 ? 1 : g, d = d < 0 ? 0 : d, p = p < 0 ? 0 : p, VG[0].x = -a, VG[0].y = -o, VG[1].x = h * _ - a, VG[1].y = f * g - o, VG[2].x = VG[1].x + d, VG[2].y = VG[1].y + p, VG[3].x = r - a, VG[3].y = s - o; for (var m = 0; m < 4; m++)for (var v = 0; v < 4; v++) { var y = 4 * m + v; y < e.dataLength && m < VG.length && v < VG.length && (i[y].x = VG[v].x, i[y].y = VG[m].y) } } }, e.fillBuffers = function (t) { var e = t.renderData; if (e) { var i = e.chunk; (t._flagChangedVersion !== t.node.flagChangedVersion || e.vertDirty) && (this.updateWorldVertexData(t, i), e.vertDirty = !1, t._flagChangedVersion = t.node.flagChangedVersion), i.bufferId; for (var n = i.vertexOffset, r = i.meshBuffer, s = i.meshBuffer.iData, a = r.indexOffset, o = 0; o < 3; ++o)for (var u = 0; u < 3; ++u) { var h = n + 4 * o + u; s[a++] = h, s[a++] = h + 1, s[a++] = h + 4, s[a++] = h + 1, s[a++] = h + 5, s[a++] = h + 4 } r.indexOffset = a } }, e.updateWorldVertexData = function (t, e) { var i = t.renderData; if (i) for (var n = i.floatStride, r = i.data, s = e.vb, a = t.node.worldMatrix, o = a.m00, u = a.m01, h = a.m02, c = a.m03, l = a.m04, f = a.m05, d = a.m06, p = a.m07, _ = a.m12, g = a.m13, m = a.m14, v = a.m15, y = 0, b = 0; b < 4; ++b)for (var w = r[4 * b], x = 0; x < 4; ++x) { var S = r[x].x, T = w.y, I = c * S + p * T + v; I = I ? 1 / I : 1, s[0 + (y = (4 * b + x) * n)] = (o * S + l * T + _) * I, s[y + 1] = (u * S + f * T + g) * I, s[y + 2] = (h * S + d * T + m) * I } }, e.updateUVs = function (t) { var e = t.renderData; if (t.spriteFrame && e) for (var i = e.chunk.vb, n = e.floatStride, r = t.spriteFrame.uvSliced, s = 3, a = 0; a < 16; a++)i[s] = r[a].u, i[s + 1] = r[a].v, s += n }, e.updateColor = function (t) { var e = t.renderData; if (e) for (var i = e.chunk.vb, n = e.floatStride, r = 5, s = t.color, a = s.r / 255, o = s.g / 255, u = s.b / 255, h = t.node._uiProps.opacity, c = 0; c < 16; c++)i[r] = a, i[r + 1] = o, i[r + 2] = u, i[r + 3] = h, r += n }, t }(), ZG = new QG, JG = new Gr, $G = 0, tH = [], eH = null; function iH(t) { return t && (t.insetTop > 0 || t.insetBottom > 0 || t.insetLeft > 0 || t.insetRight > 0) ? 2 : 0 } var nH = function () { function t() { } var e = t.prototype; return e.createData = function (t) { return t.requestRenderData() }, e.updateRenderData = function (t) { var e = t.renderData; if (e) { var i = t.spriteFrame; if (i && e && e.vertDirty) { var n = t.node._getUITransformComp(), r = Math.abs(n.width), s = Math.abs(n.height), a = i.getRect(), o = i.insetLeft, u = i.insetRight, h = a.width - o - u, c = i.insetTop, l = i.insetBottom, f = a.height - c - l, d = r - o - u, p = s - c - l; d = d > 0 ? d : 0, p = p > 0 ? p : 0; var _ = 0 === h ? d : d / h, g = 0 === f ? p : p / f, m = iH(i), v = Math.ceil(g + m), y = Math.ceil(_ + m); e.dataLength = 4 * v * y, this.updateVerts(t, d, p, v, y), e.vertexCount !== v * y * 4 && (t.renderEntity.colorDirty = !0), e.resize(v * y * 4, v * y * 6), e.updateRenderData(t, i) } } }, e.createQuadIndices = function (t) { if (t % 6 == 0) { var e = t / 6; eH = new Uint16Array(t); for (var i = 0, n = 0; n < e; n++)eH[i++] = 0 + 4 * n, eH[i++] = 1 + 4 * n, eH[i++] = 2 + 4 * n, eH[i++] = 1 + 4 * n, eH[i++] = 3 + 4 * n, eH[i++] = 2 + 4 * n } else rt(16308) }, e.updateUVs = function (t) { var e = t.renderData; e && (e.vertDirty = !0, t._markForUpdateRenderData()) }, e.fillBuffers = function (t) { var e = t.node, i = t.renderData; if (i) { var n = i.chunk; if (null !== n) { (t._flagChangedVersion !== e.flagChangedVersion || i.vertDirty) && (this.updateWorldVertexAndUVData(t, n), i.vertDirty = !1, t._flagChangedVersion = e.flagChangedVersion), this.updateColorLate(t), n.bufferId; for (var r = n.vertexOffset, s = n.meshBuffer, a = n.meshBuffer.iData, o = s.indexOffset, u = 0; u < i.indexCount; u += 6)a[o++] = r, a[o++] = r + 1, a[o++] = r + 2, a[o++] = r + 1, a[o++] = r + 3, a[o++] = r + 2, r += 4, s.indexOffset += 6; s.setDirty() } } }, e.updateWorldUVData = function (t) { var e = t.renderData; if (e) for (var i = e.floatStride, n = e.data, r = e.chunk.vb, s = 0; s < n.length; s++) { var a = s * i; r[a + 3] = n[s].u, r[a + 4] = n[s].v } }, e.updateWorldVertexAndUVData = function (t, e) { var i = t.renderData; if (i) { t.node.getWorldMatrix(JG); for (var n = i.floatStride, r = i.data, s = e.vb, a = r.length, o = 0; o < a; o++) { var u = r[o].x, h = r[o].y, c = r[o].z, l = JG.m03 * u + JG.m07 * h + JG.m11 * c + JG.m15; l = l ? 1 / l : 1; var f = o * n; s[f] = (JG.m00 * u + JG.m04 * h + JG.m08 * c + JG.m12) * l, s[f + 1] = (JG.m01 * u + JG.m05 * h + JG.m09 * c + JG.m13) * l, s[f + 2] = (JG.m02 * u + JG.m06 * h + JG.m10 * c + JG.m14) * l } this.updateWorldUVData(t) } }, e.updateVerts = function (t, e, i, n, r) { var s = t.node._getUITransformComp(), a = t.renderData; if (a) { var o, u, h = a.data, c = t.spriteFrame, l = c.rect, f = Math.abs(s.width), d = Math.abs(s.height), p = s.anchorX * f, _ = s.anchorY * d, g = c.insetLeft, m = c.insetRight, v = l.width - g - m, y = c.insetTop, b = c.insetBottom, w = l.height - y - b, x = s.width / (g + m) > 1 ? 1 : s.width / (g + m), S = s.height / (y + b) > 1 ? 1 : s.height / (y + b); o = v > 0 ? Math.floor(1e3 * e) / 1e3 % v == 0 ? v : e % v : e, u = w > 0 ? Math.floor(1e3 * i) / 1e3 % w == 0 ? w : i % w : i, tH.length = 0, $G = Math.max(n + 1, r + 1); for (var T = 0; T < $G; T++)tH.push({ x: 0, y: 0, z: 0, u: 0, v: 0, color: new rr }); var I = iH(c); if (0 === I) for (var E = 0; E < $G; E++)tH[E].x = E >= r ? f - p : E * v - p, tH[E].y = E >= n ? d - _ : E * w - _; else for (var A = 0; A < $G; A++)0 === A ? tH[A].x = -p : 1 === A ? tH[A].x = g * x - p : A > 1 && A < r - 1 ? tH[A].x = v > 0 ? g * x - p + v * (A - 1) : g + e - p : A === r - 1 ? tH[A].x = g * x - p + o + v * (A - 2) : A >= r && (tH[A].x = Math.min(g + e + m, f) - p), 0 === A ? tH[A].y = -_ : 1 === A ? tH[A].y = b * S - _ : A > 1 && A < n - 1 ? tH[A].y = w > 0 ? b * S - _ + w * (A - 1) : b + i - _ : A === n - 1 ? tH[A].y = b * S - _ + u + w * (A - 2) : A >= n && (tH[A].y = Math.min(b + i + y, d) - _); for (var C = 0, D = 0, R = 0, P = 0, B = 0; B < n; ++B) { R = tH[B].y, P = tH[B + 1].y; for (var M = 0; M < r; ++M) { C = tH[M].x, D = tH[M + 1].x; var O = 4 * (B * r + M); h[O].x = C, h[O].y = R, h[O + 1].x = D, h[O + 1].y = R, h[O + 2].x = C, h[O + 2].y = P, h[O + 3].x = D, h[O + 3].y = P } } var L = c.rotated; c.uv; var F = c.uvSliced; HG = F[0], WG = F[1], jG = F[2], XG = F[3], qG = F[4], YG = F[8], KG = F[12]; for (var k = 0, N = 0, z = 0 === v ? e : e / v, U = 0 === w ? i : i / w, V = [], G = [], H = 0; H < n; ++H) { N = i > w ? i >= (I > 0 ? H : H + 1) * w ? 1 : U % 1 : U; for (var W = 0; W < r; ++W) { k = e > v ? e >= (I > 0 ? W : W + 1) * v ? 1 : z % 1 : z, L ? (0 === I ? (V[0] = qG.u, V[1] = qG.u, V[2] = qG.u + (YG.u - qG.u) * N, G[0] = WG.v, G[1] = WG.v + (jG.v - WG.v) * k, G[2] = WG.v) : (0 === H ? (V[0] = HG.u, V[1] = HG.u, V[2] = qG.u) : H < n - 1 ? (V[0] = qG.u, V[1] = qG.u, V[2] = qG.u + (YG.u - qG.u) * N) : H === n - 1 && (V[0] = YG.u, V[1] = YG.u, V[2] = KG.u), 0 === W ? (G[0] = HG.v, G[1] = WG.v, G[2] = HG.v) : W < r - 1 ? (G[0] = WG.v, G[1] = WG.v + (jG.v - WG.v) * k, G[2] = WG.v) : W === r - 1 && (G[0] = jG.v, G[1] = XG.v, G[2] = jG.v)), V[3] = V[2], G[3] = G[1]) : (0 === I ? (V[0] = WG.u, V[1] = WG.u + (jG.u - WG.u) * k, V[2] = WG.u, G[0] = qG.v, G[1] = qG.v, G[2] = qG.v + (YG.v - qG.v) * N) : (0 === W ? (V[0] = HG.u, V[1] = WG.u, V[2] = HG.u) : W < r - 1 ? (V[0] = WG.u, V[1] = WG.u + (jG.u - WG.u) * k, V[2] = WG.u) : W === r - 1 && (V[0] = jG.u, V[1] = XG.u, V[2] = jG.u), 0 === H ? (G[0] = HG.v, G[1] = HG.v, G[2] = qG.v) : H < n - 1 ? (G[0] = qG.v, G[1] = qG.v, G[2] = qG.v + (YG.v - qG.v) * N) : H === n - 1 && (G[0] = YG.v, G[1] = YG.v, G[2] = KG.v)), V[3] = V[1], G[3] = G[2]); var j = 4 * (H * r + W); h[j].u = V[0], h[j].v = G[0], h[j + 1].u = V[1], h[j + 1].v = G[1], h[j + 2].u = V[2], h[j + 2].v = G[2], h[j + 3].u = V[3], h[j + 3].v = G[3] } } } }, e.updateColorLate = function (t) { var e = t.renderData; if (e) for (var i = e.chunk.vb, n = e.floatStride, r = e.vertexCount, s = 5, a = t.color, o = a.r / 255, u = a.g / 255, h = a.b / 255, c = t.node._uiProps.opacity, l = 0; l < r; l++)i[s] = o, i[s + 1] = u, i[s + 2] = h, i[s + 3] = c, s += n }, e.updateColor = function () { }, t }(), rH = new nH; iN.Type, iN.FillType; var sH = t("spriteAssembler", { getAssembler: function (t) { var e = UG, i = t; switch (i.type) { case 1: e = ZG; break; case 2: e = rH; break; case 3: e = 2 === i.fillType ? kG : vG }return e } }); iN.Assembler = sH; var aH = t("StencilManager", function () { function t() { this._maskStack = [], this._stencilPattern = { stencilTest: !0, func: 7, stencilMask: 65535, writeMask: 65535, failOp: 1, zFailOp: 1, passOp: 1, ref: 1 }, this._stage = 0, this.stencilStateMap = new Map, this.stencilStateMapWithDepth = new Map } var e = t.prototype; return e.pushMask = function (t) { this._maskStack.push(t) }, e.clear = function (t) { return 2 !== t.stencilStage ? 5 : 1 }, e.enableMask = function () { this.stage = 3 }, e.exitMask = function () { 0 !== this._maskStack.length && (this._maskStack.pop(), 0 === this._maskStack.length ? this.stage = 0 : this.stage = 3) }, e.getWriteMask = function () { return 1 << this._maskStack.length - 1 }, e.getExitWriteMask = function () { return 1 << this._maskStack.length }, e.getStencilRef = function () { for (var t = 0, e = 0; e < this._maskStack.length; ++e)t += 1 << e; return t }, e.getMaskStackSize = function () { return this._maskStack.length }, e.reset = function () { this._maskStack.length = 0, this.stage = 0 }, e.destroy = function () { this.stencilStateMap.forEach((function (t) { t.destroy() })), this.stencilStateMap.clear() }, e.getStencilStage = function (t, e) { var i = 0, n = !1, r = !1, s = 1, a = this.stencilStateMap; if (e && e.passes[0]) { var o = e.passes[0].depthStencilState, u = 0, h = 0; o.depthTest && (u = 1), o.depthWrite && (h = 1), i = u | h << 1 | o.depthFunc << 2 | t << 6 | this._maskStack.length << 9, n = o.depthTest, r = o.depthWrite, s = o.depthFunc, a = this.stencilStateMapWithDepth } else i = t << 16 | this._maskStack.length; if (a && a.has(i)) return a.get(i); this.setStateFromStage(t); var c = this._stencilPattern, l = new p_(n, r, s, c.stencilTest, c.func, c.stencilMask, c.writeMask, c.failOp, c.zFailOp, c.passOp, c.ref, c.stencilTest, c.func, c.stencilMask, c.writeMask, c.failOp, c.zFailOp, c.passOp, c.ref); return a.set(i, l), l }, e.getStencilHash = function (t) { return t << 8 | this._maskStack.length }, e.setStateFromStage = function (t) { var e = this._stencilPattern; 0 === t ? (e.stencilTest = !1, e.func = 7, e.failOp = 1, e.stencilMask = e.writeMask = 65535, e.ref = 1) : (e.stencilTest = !0, 3 === t ? (e.func = 2, e.failOp = 1, e.stencilMask = e.ref = this.getStencilRef(), e.writeMask = this.getWriteMask()) : 1 === t ? (e.func = 0, e.failOp = 0, e.writeMask = e.stencilMask = e.ref = this.getWriteMask()) : 5 === t || 2 === t ? (e.func = 0, e.failOp = 2, e.writeMask = e.stencilMask = e.ref = this.getWriteMask()) : 6 === t && (e.func = 0, e.failOp = 0, e.writeMask = e.stencilMask = e.ref = this.getWriteMask())) }, n(t, [{ key: "stage", get: function () { return this._stage }, set: function (t) { this._stage = t } }, { key: "pattern", get: function () { return this._stencilPattern } }]), t }()); aH.sharedManager = null, aH.sharedManager = new aH; var oH = ["mouse-down", "mouse-move", "mouse-up", "mouse-wheel", "mouse-leave-window", "mouse-enter-window"], uH = ["touch-start", "touch-move", "touch-end", "touch-cancel"], hH = function () { function t() { this.priority = 1, this._isListDirty = !1, this._inDispatchCount = 0, this._pointerEventProcessorList = [], this._processorListToAdd = [], this._processorListToRemove = [], QD._registerEventDispatcher(this); var t = dy.callbacksInvoker; t.on(0, this.addPointerEventProcessor, this), t.on(1, this.removePointerEventProcessor, this), t.on(2, this._markListDirty, this) } var e = t.prototype; return e.onThrowException = function () { this._inDispatchCount = 0 }, e.dispatchEvent = function (t) { var e = t.type; return uH.includes(e) ? this.dispatchEventTouch(t) : !oH.includes(e) || this.dispatchEventMouse(t) }, e.addPointerEventProcessor = function (t) { 0 === this._inDispatchCount ? this._pointerEventProcessorList.includes(t) || (this._pointerEventProcessorList.push(t), this._isListDirty = !0) : this._processorListToAdd.includes(t) || this._processorListToAdd.push(t), me(this._processorListToRemove, t) }, e.removePointerEventProcessor = function (t) { 0 === this._inDispatchCount ? (me(this._pointerEventProcessorList, t), this._isListDirty = !0) : this._processorListToRemove.includes(t) || this._processorListToRemove.push(t), me(this._processorListToAdd, t) }, e.dispatchEventMouse = function (t) { this._inDispatchCount++, this._sortPointerEventProcessorList(); for (var e = this._pointerEventProcessorList, i = e.length, n = !0, r = 0; r < i; ++r) { var s = e[r]; if (s.isEnabled && s.shouldHandleEventMouse && s._handleEventMouse(t)) { if (n = !1, !t.preventSwallow) break; t.preventSwallow = !1 } } return --this._inDispatchCount <= 0 && this._updatePointerEventProcessorList(), n }, e.dispatchEventTouch = function (t) { this._inDispatchCount++, this._sortPointerEventProcessorList(); for (var e = this._pointerEventProcessorList, i = e.length, n = t.touch, r = !0, s = 0; s < i; ++s) { var a = e[s]; if (a.isEnabled && a.shouldHandleEventTouch) if ("touch-start" === t.type) { if (a._handleEventTouch(t)) { if (a.isEnabled) a.claimedTouchIdList.push(n.getID()); else { var o = new Fv([t.touch], !0, "touch-cancel"); o.touch = t.touch, a.dispatchEvent(o), a.claimedTouchIdList.length = 0 } if (r = !1, !t.preventSwallow) break; t.preventSwallow = !1 } } else if (a.claimedTouchIdList.length > 0) { var u = a.claimedTouchIdList.indexOf(n.getID()); if (-1 !== u) { if (a._handleEventTouch(t), "touch-end" !== t.type && "touch-cancel" !== t.type || (_e(a.claimedTouchIdList, u), t.preventSwallow || this._removeClaimedTouch(s + 1, n.getID())), r = !1, !t.preventSwallow) break; t.preventSwallow = !1 } } } return --this._inDispatchCount <= 0 && this._updatePointerEventProcessorList(), r }, e._removeClaimedTouch = function (t, e) { for (var i = this._pointerEventProcessorList, n = i.length, r = t; r < n; ++r) { var s = i[r], a = s.claimedTouchIdList.indexOf(e); -1 !== a && _e(s.claimedTouchIdList, a) } }, e._updatePointerEventProcessorList = function () { for (var t = this._processorListToAdd, e = t.length, i = 0; i < e; ++i)this.addPointerEventProcessor(t[i]); t.length = 0; for (var n = this._processorListToRemove, r = n.length, s = 0; s < r; ++s)this.removePointerEventProcessor(n[s]); n.length = 0 }, e._sortPointerEventProcessorList = function () { if (this._isListDirty) { for (var t = this._pointerEventProcessorList, e = t.length, i = 0; i < e; ++i) { var n = t[i], r = n.node; if (r._uiProps) { var s = r._getUITransformComp(); n.cachedCameraPriority = s.cameraPriority } } t.sort(this._sortByPriority), this._isListDirty = !1 } }, e._sortByPriority = function (t, e) { var i = t.node, n = e.node; if (!(e && n && n.activeInHierarchy && n._getUITransformComp())) return -1; if (!(t && i && i.activeInHierarchy && i._getUITransformComp())) return 1; if (t.cachedCameraPriority !== e.cachedCameraPriority) return e.cachedCameraPriority - t.cachedCameraPriority; for (var r = i, s = n, a = !1; (null == (o = r.parent) ? void 0 : o.uuid) !== (null == (u = s.parent) ? void 0 : u.uuid);) { var o, u, h, c, l, f; r = null === (null == (h = r) || null == (c = h.parent) ? void 0 : c.parent) ? (a = !0) && n : r && r.parent, s = null === (null == (l = s) || null == (f = l.parent) ? void 0 : f.parent) ? (a = !0) && i : s && s.parent } if (r.uuid === s.uuid) { if (r.uuid === n.uuid) return -1; if (r.uuid === i.uuid) return 1 } var d = r ? r.siblingIndex : 0, p = s ? s.siblingIndex : 0; return a ? d - p : p - d }, e._markListDirty = function () { this._isListDirty = !0 }, t }(); new hH; var cH = new Dp(null), lH = new Gr, fH = t("UI", function () { function t(t) { var e = this; this._screens = [], this._staticVBBuffer = null, this._bufferAccessors = new Map, this._currBID = -1, this._indexStart = 0, this._emptyMaterial = new gT, this._currRenderData = null, this._currMaterial = this._emptyMaterial, this._currTexture = null, this._currSampler = null, this._currStaticRoot = null, this._currComponent = null, this._currTransform = null, this._currTextureHash = 0, this._currSamplerHash = 0, this._currLayer = 0, this._currDepthStencilStateStage = null, this._currIsStatic = !1, this._currHash = 0, this._currIsMiddleware = !1, this._middlewareEnableBatch = !1, this._middlewareBuffer = null, this._middlewareIndexStart = 0, this._middlewareIndexCount = 0, this._pOpacity = 1, this._opacityDirty = 0, this._descriptorSetCache = new pH, this._meshDataArray = [], this._maskClearModel = null, this._maskClearMtl = null, this._maskModelMesh = null, this._root = t, this.device = t.device, this._batches = new io(64), this._drawBatchPool = new to((function () { return new cN }), 128, (function (t) { return t.destroy(e) })) } var e = t.prototype; return e.initialize = function () { return !0 }, e.destroy = function () { for (var t = 0; t < this._batches.length; t++)this._batches.array[t] && this._batches.array[t].destroy(this); this._batches.destroy(); for (var e, i = p(this._bufferAccessors.values()); !(e = i()).done;)e.value.destroy(); this._bufferAccessors.clear(), this._drawBatchPool && this._drawBatchPool.destroy(), this._descriptorSetCache.destroy(), aH.sharedManager.destroy(), this._maskClearModel && this._maskModelMesh && (S.director.root.destroyModel(this._maskClearModel), this._maskModelMesh.destroy()), this._maskClearMtl && this._maskClearMtl.destroy() }, e.syncRootNodesToNative = function () { }, e.addScreen = function (t) { this._screens.push(t), this._screens.sort(this._screenSort) }, e.removeScreen = function (t) { var e = this._screens.indexOf(t); -1 !== e && this._screens.splice(e, 1) }, e.sortScreens = function () { this._screens.sort(this._screenSort) }, e.getFirstRenderCamera = function (t) { if (t.scene && t.scene.renderScene) for (var e = t.scene.renderScene.cameras, i = 0; i < e.length; i++) { var n = e[i]; if (n.visibility & t.layer) return n } return null }, e.update = function () { for (var t = this._screens, e = 0, i = 0; i < t.length; ++i) { var n = t[i], r = n._getRenderScene(); if (n.enabledInHierarchy && r) { this._opacityDirty = 0, this._pOpacity = 1, this.walk(n.node), this.autoMergeBatches(this._currComponent), this.resetRenderStates(); var s = 0; if (this._batches.length > e) for (; e < this._batches.length; ++e) { var a = this._batches.array[e]; if (a.model) for (var o = a.model.subModels, u = 0; u < o.length; u++)o[u].priority = s++; else a.descriptorSet = this._descriptorSetCache.getDescriptorSet(a); r.addBatch(a) } } } }, e.uploadBuffers = function () { if (this._batches.length > 0) { for (var t = this._meshDataArray.length, e = 0; e < t; e++)this._meshDataArray[e].uploadBuffers(); for (var i, n = p(this._bufferAccessors.values()); !(i = n()).done;) { var r = i.value; r.uploadBuffers(), r.reset() } this._descriptorSetCache.update() } }, e.reset = function () { for (var t = 0; t < this._batches.length; ++t) { var e = this._batches.array[t]; e.isStatic || (e.clear(), this._drawBatchPool.free(e)) } for (var i, n = p(this._bufferAccessors.values()); !(i = n()).done;)i.value.reset(); for (var r = this._meshDataArray.length, s = 0; s < r; s++)this._meshDataArray[s].freeIAPool(); this._meshDataArray.length = 0, this._staticVBBuffer = null, this._currBID = -1, this._indexStart = 0, this._currHash = 0, this._currLayer = 0, this._currRenderData = null, this._currMaterial = this._emptyMaterial, this._currTexture = null, this._currSampler = null, this._currComponent = null, this._currTransform = null, this._batches.clear(), aH.sharedManager.reset() }, e.switchBufferAccessor = function (t) { void 0 === t && (t = WL); var e = t === WL ? 36 : KL(t); if (!this._staticVBBuffer || this._staticVBBuffer.vertexFormatBytes !== e) { var i = this._bufferAccessors.get(e); i || (i = new tF(this.device, t), this._bufferAccessors.set(e, i)), this._staticVBBuffer = i, this._currBID = -1 } return this._staticVBBuffer }, e.registerBufferAccessor = function (t, e) { this._bufferAccessors.set(t, e) }, e.updateBuffer = function (t, e) { var i = this.switchBufferAccessor(t); this._currBID !== e && (this._currBID = e, this._indexStart = i.getMeshBuffer(e).indexOffset) }, e.commitComp = function (t, e, i, n, r) { var s, a = 0, o = -1; if (e && e.chunk) { if (!e.isValid()) return; a = e.dataHash, s = e.material, o = e.chunk.bufferId } 2 === t.stencilStage || 6 === t.stencilStage ? this._insertMaskBatch(t) : t.stencilStage = aH.sharedManager.stage; var u = t.stencilStage; this._currHash === a && 0 !== a && this._currMaterial === s && this._currDepthStencilStateStage === u || (this.autoMergeBatches(this._currComponent), e && !e._isMeshBuffer && this.updateBuffer(e.vertexFormat, o), this._currRenderData = e, this._currHash = e ? e.dataHash : 0, this._currComponent = t, this._currTransform = r, this._currMaterial = t.getRenderMaterial(0), this._currDepthStencilStateStage = u, this._currLayer = t.node.layer, i ? (this._currTexture = i.getGFXTexture(), this._currSampler = i.getGFXSampler(), this._currTextureHash = i.getHash(), this._currSamplerHash = this._currSampler.hash) : (this._currTexture = null, this._currSampler = null, this._currTextureHash = 0, this._currSamplerHash = 0)), n.fillBuffers && n.fillBuffers(t, this) }, e.commitIA = function (t, e, i, n, r) { this._currMaterial !== this._emptyMaterial && (this.autoMergeBatches(this._currComponent), this.resetRenderStates()); var s = null, a = 0; t && (t.stencilStage = aH.sharedManager.stage, s = null !== t.customMaterial ? aH.sharedManager.getStencilStage(t.stencilStage, n) : aH.sharedManager.getStencilStage(t.stencilStage), a = aH.sharedManager.getStencilHash(t.stencilStage)); var o = this._currStaticRoot ? this._currStaticRoot._requireDrawBatch() : this._drawBatchPool.alloc(); o.visFlags = t.node.layer, o.inputAssembler = e, o.useLocalData = r || null, i && (o.texture = i.getGFXTexture(), o.sampler = i.getGFXSampler(), o.textureHash = i.getHash(), o.samplerHash = o.sampler.hash), o.fillPasses(n || null, s, a, null), this._batches.push(o) }, e.commitMiddleware = function (t, e, i, n, r, s, a) { var o = r.getGFXTexture(); a && this._middlewareEnableBatch && this._middlewareBuffer === e && this._currTexture === o && this._currMaterial.hash === s.hash && this._middlewareIndexStart + this._middlewareIndexCount === i && this._currLayer === t.node.layer ? this._middlewareIndexCount += n : (this.autoMergeBatches(this._currComponent), this.resetRenderStates(), this._currComponent = t, this._currTexture = o, this._currSampler = r.getGFXSampler(), this._currTextureHash = r.getHash(), this._currLayer = t.node.layer, this._currSamplerHash = this._currSampler.hash, this._currHash = 0, this._currTransform = a ? null : t.node, this._middlewareEnableBatch = a, this._middlewareBuffer = e, this._currMaterial = s, this._middlewareIndexStart = i, this._middlewareIndexCount = n), this._currIsMiddleware = !0 }, e.commitModel = function (t, e, i) { this._currMaterial !== this._emptyMaterial && (this.autoMergeBatches(this._currComponent), this.resetRenderStates()); var n = null, r = 0; i && (2 === t.stencilStage || 6 === t.stencilStage ? this._insertMaskBatch(t) : t.stencilStage = aH.sharedManager.stage, n = aH.sharedManager.getStencilStage(t.stencilStage, i), r = aH.sharedManager.getStencilHash(t.stencilStage)); var s = S.director.getTotalFrames(); e && (e.updateTransform(s), e.updateUBOs(s)); for (var a = 0; a < e.subModels.length; a++) { var o = this._drawBatchPool.alloc(), u = e.subModels[a]; o.visFlags = t.node.layer, o.model = e, o.texture = null, o.sampler = null, o.useLocalData = null, n || (n = null), o.fillPasses(i, n, r, u.patches), o.inputAssembler = u.inputAssembler, o.model.visFlags = o.visFlags, o.descriptorSet = u.descriptorSet, this._batches.push(o) } }, e.setupStaticBatch = function (t, e) { this.finishMergeBatches(), this._staticVBBuffer = e, this.currStaticRoot = t }, e.endStaticBatch = function () { this.finishMergeBatches(), this.currStaticRoot = null, this._staticVBBuffer = null, this.switchBufferAccessor() }, e.commitStaticBatch = function (t) { this._batches.concat(t.drawBatchList), this.finishMergeBatches() }, e.autoMergeBatches = function (t) { if (this._currIsMiddleware) this.mergeBatchesForMiddleware(t); else { var e = this._currMaterial; if (e) { var i, n = this._currRenderData, r = this._staticVBBuffer; if (n && n._isMeshBuffer) i = n.requestIA(this.device), -1 === this._meshDataArray.indexOf(n) && this._meshDataArray.push(n); else if (r) { var s = this._currBID, a = r.getMeshBuffer(s); if (!a) return; var o = a.indexOffset - this._indexStart; if (o <= 0) return; this._indexStart, a.indexOffset, a.setDirty(), (i = a.requireFreeIA(this.device)).firstIndex = this._indexStart, i.indexCount = o, this._indexStart = a.indexOffset } if (this._currBID = -1, i && this._currTexture) { var u = null, h = 0; t && (u = null !== t.customMaterial ? aH.sharedManager.getStencilStage(t.stencilStage, e) : aH.sharedManager.getStencilStage(t.stencilStage), h = aH.sharedManager.getStencilHash(t.stencilStage)); var c = this._currStaticRoot ? this._currStaticRoot._requireDrawBatch() : this._drawBatchPool.alloc(); c.visFlags = this._currLayer, c.texture = this._currTexture, c.sampler = this._currSampler, c.inputAssembler = i, c.useLocalData = this._currTransform, c.textureHash = this._currTextureHash, c.samplerHash = this._currSamplerHash, c.fillPasses(e, u, h, null), this._batches.push(c) } } } }, e.mergeBatchesForMiddleware = function (t) { var e, i; t.stencilStage = aH.sharedManager.stage, i = null !== t.customMaterial ? aH.sharedManager.getStencilStage(t.stencilStage, this._currMaterial) : aH.sharedManager.getStencilStage(t.stencilStage), e = aH.sharedManager.getStencilHash(t.stencilStage); var n = this._currStaticRoot ? this._currStaticRoot._requireDrawBatch() : this._drawBatchPool.alloc(); n.visFlags = t.node.layer; var r = this._middlewareBuffer.requireFreeIA(this.device); r.firstIndex = this._middlewareIndexStart, r.indexCount = this._middlewareIndexCount, n.inputAssembler = r, n.useLocalData = this._currTransform, n.texture = this._currTexture, n.sampler = this._currSampler, n.textureHash = this._currTextureHash, n.samplerHash = this._currSamplerHash, n.fillPasses(this._currMaterial || null, i, e, null), this._batches.push(n), this._currIsMiddleware = !1, this._middlewareBuffer = null }, e.forceMergeBatches = function (t, e, i) { this._currMaterial = t, e ? (this._currTexture = e.getGFXTexture(), this._currSampler = e.getGFXSampler(), this._currTextureHash = e.getHash(), this._currSamplerHash = this._currSampler.hash) : (this._currTexture = this._currSampler = null, this._currTextureHash = this._currSamplerHash = 0), this._currLayer = i.node.layer, this.autoMergeBatches(i) }, e.resetRenderStates = function () { this._currMaterial = this._emptyMaterial, this._currRenderData = null, this._currTexture = null, this._currComponent = null, this._currTransform = null, this._currTextureHash = 0, this._currSamplerHash = 0, this._currLayer = 0 }, e.finishMergeBatches = function () { this.autoMergeBatches(), this.resetRenderStates() }, e.flushMaterial = function (t) { this._currMaterial = t }, e.walk = function (t, e) { if (void 0 === e && (e = 0), t.activeInHierarchy) { var i = t.children, n = t._uiProps, r = n.uiComp, s = this._pOpacity, a = s, o = r && r.color ? r.color.a / 255 : 1; if (this._pOpacity = a *= o * n.localOpacity, n.setOpacity(a), !ji(a, 0, Hi)) { if (n.colorDirty && this._opacityDirty++, r && r.enabledInHierarchy && r.fillBuffers(this), this._opacityDirty && r && !r.useVertexOpacity && r.renderData && r.renderData.vertexCount > 0) { L_(r.renderData, a); var u = r.renderData.getMeshBuffer(); u && u.setDirty() } if (i.length > 0 && !t._static) for (var h = 0; h < i.length; ++h) { var c = i[h]; this.walk(c, e) } n.colorDirty && (this._opacityDirty--, n.colorDirty = !1) } this._pOpacity = s, r && r.enabledInHierarchy && (r.postUpdateAssembler(this), (2 === r.stencilStage || 6 === r.stencilStage) && aH.sharedManager.getMaskStackSize() > 0 && (this.autoMergeBatches(this._currComponent), this.resetRenderStates(), aH.sharedManager.exitMask())), e += 1 } }, e._screenSort = function (t, e) { return t.node.siblingIndex - e.node.siblingIndex }, e._releaseDescriptorSetCache = function (t) { this._descriptorSetCache.releaseDescriptorSetCache(t) }, e._createClearModel = function () { if (!this._maskClearModel) { this._maskClearMtl = YS.get("default-clear-stencil"), this._maskClearModel = S.director.root.createModel(TR); var t = KL(GL), e = B_.gfxDevice, i = e.createBuffer(new Zd(10, 1, 4 * t, t)), n = new Float32Array([-1, -1, 0, 1, -1, 0, -1, 1, 0, 1, 1, 0]); i.update(n); var r = e.createBuffer(new Zd(6, 1, 12, 2)), s = new Uint16Array([0, 1, 2, 2, 1, 3]); r.update(s), this._maskModelMesh = new DB([i], GL, 7, r), this._maskModelMesh.subMeshIdx = 0, this._maskClearModel.initSubModel(0, this._maskModelMesh, this._maskClearMtl) } }, e._insertMaskBatch = function (t) { this.autoMergeBatches(this._currComponent), this.resetRenderStates(), this._createClearModel(), this._maskClearModel.node = this._maskClearModel.transform = t.node; var e = aH.sharedManager; e.pushMask(1); var i = e.clear(t), n = null, r = 0, s = this._maskClearMtl; s && (n = e.getStencilStage(i, s), r = e.getStencilHash(i)); var a = this._maskClearModel, o = S.director.getTotalFrames(); a && (a.updateTransform(o), a.updateUBOs(o)); for (var u = 0; u < a.subModels.length; u++) { var h = this._drawBatchPool.alloc(), c = a.subModels[u]; h.visFlags = t.node.layer, h.model = a, h.texture = null, h.sampler = null, h.useLocalData = null, n || (n = null), h.fillPasses(s, n, r, c.patches), h.inputAssembler = c.inputAssembler, h.model.visFlags = h.visFlags, h.descriptorSet = c.descriptorSet, this._batches.push(h) } e.enableMask() }, e.syncMeshBuffersToNative = function () { }, n(t, [{ key: "nativeObj", get: function () { return this._nativeObj } }, { key: "currBufferAccessor", get: function () { return this._staticVBBuffer || (this._staticVBBuffer = this.switchBufferAccessor()), this._staticVBBuffer } }, { key: "batches", get: function () { return this._batches } }, { key: "currStaticRoot", set: function (t) { this._currStaticRoot = t } }, { key: "currIsStatic", set: function (t) { this._currIsStatic = t } }]), t }()), dH = function () { var t = e.prototype; function e() { this._descriptorSet = null, this._transform = null, this._textureHash = 0, this._samplerHash = 0, this._localBuffer = null, this._transformUpdate = !0; var t = B_.gfxDevice; this._localData = new Float32Array(56), this._localBuffer = t.createBuffer(new Zd(18, 3, 224, 224)) } return t.getDescriptorSet = function () { return this._descriptorSet }, t.initialize = function (t) { var e = B_.gfxDevice; this._transform = t.useLocalData, this._textureHash = t.textureHash, this._samplerHash = t.samplerHash, cH.layout = t.passes[0].localSetLayout, this._descriptorSet = e.createDescriptorSet(cH), this._descriptorSet.bindBuffer(0, this._localBuffer), this._descriptorSet.bindTexture(12, t.texture), this._descriptorSet.bindSampler(12, t.sampler), this._descriptorSet.update(), this._transformUpdate = !0 }, t.updateTransform = function (t) { t !== this._transform && (this._transform = t, this._transformUpdate = !0, this.uploadLocalData()) }, t.equals = function (t, e, i) { return this._transform === t && this._textureHash === e && this._samplerHash === i }, t.reset = function () { this._transform = null, this._textureHash = 0, this._samplerHash = 0 }, t.destroy = function () { this._localBuffer && (this._localBuffer.destroy(), this._localBuffer = null), this._descriptorSet && (this._descriptorSet.destroy(), this._descriptorSet = null), this._localData = null }, t.isValid = function () { return this._transform && this._transform.isValid }, t.uploadLocalData = function () { var t = this._transform; if ((t.hasChangedFlags || t.isTransformDirty()) && (t.updateWorldTransform(), this._transformUpdate = !0), this._transformUpdate) { var e = t.worldMatrix; Gr.toArray(this._localData, e, 0), Gr.invert(lH, e), Gr.transpose(lH, lH); var i = Gr.determinant(lH), n = 1 / Math.sqrt(i); Gr.multiplyScalar(lH, lH, n), Gr.toArray(this._localData, lH, 16), this._localBuffer.update(this._localData), this._transformUpdate = !1 } }, e }(), pH = function () { function t() { this._descriptorSetCache = new Map, this._dsCacheHashByTexture = new Map, this._localDescriptorSetCache = [], this._localCachePool = new to((function () { return new dH }), 16, (function (t) { return t.destroy() })) } var e = t.prototype; return e.getDescriptorSet = function (t) { if (S.director.root, t.useLocalData) { for (var e = this._localDescriptorSetCache, i = 0, n = e.length; i < n; i++) { var r = e[i]; if (r.equals(t.useLocalData, t.textureHash, t.samplerHash)) return r.getDescriptorSet() } var s = this._localCachePool.alloc(); return s.initialize(t), this._localDescriptorSetCache.push(s), s.getDescriptorSet() } var a = t.textureHash ^ t.samplerHash; if (this._descriptorSetCache.has(a)) return this._descriptorSetCache.get(a); cH.layout = t.passes[0].localSetLayout; var o = B_.gfxDevice.createDescriptorSet(cH); return o.bindTexture(12, t.texture), o.bindSampler(12, t.sampler), o.update(), this._descriptorSetCache.set(a, o), this._dsCacheHashByTexture.set(t.textureHash, a), o }, e.update = function () { var t = this._localDescriptorSetCache, e = t.length; if (0 !== e) { for (var i = [], n = 0; n < e; n++) { var r = t[n]; if (r.isValid()) r.uploadLocalData(); else { r.reset(); var s = t.indexOf(r); i.push(s) } } for (var a = i.length - 1; a >= 0; a--) { var o = i[a], u = t[o]; t.splice(o, 1), this._localCachePool.free(u) } } }, e.reset = function () { for (var t = this._localDescriptorSetCache, e = t.length, i = 0; i < e; i++) { var n = t[i]; this._localCachePool.free(n) } this._localDescriptorSetCache.length = 0 }, e.releaseDescriptorSetCache = function (t) { var e = this._dsCacheHashByTexture.get(t); e && this._descriptorSetCache.has(e) && (this._descriptorSetCache.get(e).destroy(), this._descriptorSetCache.delete(e), this._dsCacheHashByTexture.delete(t)) }, e.destroy = function () { for (var t, e = p(this._descriptorSetCache.values()); !(t = e()).done;)t.value.destroy(); this._descriptorSetCache.clear(), this._dsCacheHashByTexture.clear(), this._localDescriptorSetCache.length = 0, this._localCachePool.destroy() }, t }(); S.internal.Batcher2D = fH, t("UIDrawBatch", function (t) { function e() { return t.apply(this, arguments) || this } return s(e, t), e }(cN)), dt(QL.prototype, "MeshBuffer", ["byteStart", "vertexStart", "indicesStart", "request"].map((function (t) { return { name: t, suggest: "please use meshBuffer.accessor." + t + " instead" } }))), lt(QL.prototype, "MeshBuffer", [{ name: "indicesOffset", newName: "indexOffset" }]), ft(QL.prototype, "MeshBuffer", [{ name: "vertexBuffers" }, { name: "indexBuffer" }]), lt(fH.prototype, "Batcher2D", [{ name: "currBufferBatch", newName: "currBufferAccessor" }, { name: "acquireBufferBatch", newName: "switchBufferAccessor" }]), ft(_F.prototype, "MeshRenderData", [{ name: "formatByte" }, { name: "byteStart" }, { name: "byteCount" }]), lt(_F.prototype, "MeshRenderData", [{ name: "indicesStart", newName: "indexStart" }]), t("QuadRenderData", function (t) { function e(e) { var i; return i = t.call(this, e) || this, it(9006), i } return s(e, t), e }(_F)), S.UI = { MeshBuffer: QL, spriteAssembler: sH, labelAssembler: pG, RenderData: pF, MeshRenderData: _F }, mM.on(gM.EVENT_POST_SUBSYSTEM_INIT, (function () { wH.init() })); var _H, gH, mH, vH, yH, bH, wH = t("SortingLayers", function () { function t() { } return t.getSortingPriority = function (t, e) { return void 0 === t && (t = 0), void 0 === e && (e = 0), (t + 32768 << 16 | e + 32768) >>> 0 }, t.getLayerIndex = function (t) { void 0 === t && (t = 0); var e = 0; return this.indexMap.has(t) ? e = this.indexMap.get(t) : rt(2105), e }, t.getLayerIndexByName = function (t) { var e = this.getLayerByName(t); return this.getLayerIndex(e) }, t.getLayerName = function (t) { void 0 === t && (t = 0); var e = ""; return this.nameMap.has(t) ? e = this.nameMap.get(t) : rt(2105), e }, t.getLayerByName = function (t) { for (var e = this.nameMap.size, i = this.nameMap.keys(), n = 0, r = 0; r < e; r++)if (n = i.next().value, this.nameMap.get(n) === t) return n; return rt(2106), 0 }, t.isLayerValid = function (t) { return !!this.indexMap.has(t) || (rt(2105), !1) }, t.getBuiltinLayers = function () { return [{ id: 0, name: "default", value: 0 }] }, t.init = function () { var e = Oe.querySettings("engine", "sortingLayers"); e && 0 !== e.length || (e = this.getBuiltinLayers()), t.resetState(); for (var i = 0; i < e.length; i++) { var n = e[i]; t.setLayer(n.id, n.name, n.value), t.Enum[n.name] = n.id } Ee.update(t.Enum), Ee.sortList(t.Enum, (function (e, i) { return t.getLayerIndex(e.value) - t.getLayerIndex(i.value) })) }, t.setLayer = function (t, e, i) { this.nameMap.set(t, e), this.indexMap.set(t, i) }, t.resetState = function () { for (var e = Object.keys(t.Enum), i = 0; i < e.length; i++)delete t.Enum[t.Enum[e[i]]], delete t.Enum[e[i]]; t.indexMap.clear(), t.nameMap.clear() }, t }()); wH.nameMap = new Map, wH.indexMap = new Map, wH.Enum = Ee({ default: 0 }), t("Sorting", (_H = Gu("cc.Sorting"), gH = Ih(wH.Enum), _H(mH = ju((m((vH = function (t) { function e() { var e; return (e = t.call(this) || this)._sortingLayer = yH && yH(), e._sortingOrder = bH && bH(), e._modelRenderer = null, e } s(e, t); var i = e.prototype; return i.__preload = function () { this._modelRenderer = this.getComponent("cc.ModelRenderer"), this._modelRenderer || it(16301, this.node.name), this._updateSortingPriority() }, i._updateSortingPriority = function () { var t = wH.getLayerIndex(this._sortingLayer), e = wH.getSortingPriority(t, this._sortingOrder); this._modelRenderer && this._modelRenderer.isValid && (this._modelRenderer.priority = e) }, n(e, [{ key: "sortingLayer", get: function () { return this._sortingLayer }, set: function (t) { t !== this._sortingLayer && wH.isLayerValid(t) && (this._sortingLayer = t, this._updateSortingPriority()) } }, { key: "sortingOrder", get: function () { return this._sortingOrder }, set: function (t) { t !== this._sortingOrder && (this._sortingOrder = Xi(t, -32768, 32767), this._updateSortingPriority()) } }]), e }(am)).prototype, "sortingLayer", [gH], Object.getOwnPropertyDescriptor(vH.prototype, "sortingLayer"), vH.prototype), yH = Bu(vH.prototype, "_sortingLayer", [eh], (function () { return wH.Enum.default })), bH = Bu(vH.prototype, "_sortingOrder", [eh], (function () { return 0 })), mH = vH)) || mH) || mH)); var xH, SH, TH, IH = t("AffineTransform", function () { function t(t, e, i, n, r, s) { void 0 === t && (t = 1), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 1), void 0 === r && (r = 0), void 0 === s && (s = 0), this.a = t, this.b = e, this.c = i, this.d = n, this.tx = r, this.ty = s } return t.identity = function () { return new t }, t.clone = function (e) { return new t(e.a, e.b, e.c, e.d, e.tx, e.ty) }, t.concat = function (t, e, i) { var n = e.a, r = e.b, s = e.c, a = e.d, o = e.tx, u = e.ty; t.a = n * i.a + r * i.c, t.b = n * i.b + r * i.d, t.c = s * i.a + a * i.c, t.d = s * i.b + a * i.d, t.tx = o * i.a + u * i.c + i.tx, t.ty = o * i.b + u * i.d + i.ty }, t.invert = function (t, e) { var i = 1 / (e.a * e.d - e.b * e.c); t.a = i * e.d, t.b = -i * e.b, t.c = -i * e.c, t.d = i * e.a, t.tx = i * (e.c * e.ty - e.d * e.tx), t.ty = i * (e.b * e.tx - e.a * e.ty) }, t.fromMat4 = function (t, e) { t.a = e.m00, t.b = e.m01, t.c = e.m04, t.d = e.m05, t.tx = e.m12, t.ty = e.m13 }, t.transformVec2 = function (t, e, i, n) { var r, s; n ? (r = e, s = i) : (n = i, r = e.x, s = e.y), t.x = n.a * r + n.c * s + n.tx, t.y = n.b * r + n.d * s + n.ty }, t.transformSize = function (t, e, i) { t.width = i.a * e.width + i.c * e.height, t.height = i.b * e.width + i.d * e.height }, t.transformRect = function (t, e, i) { var n = e.x + e.width, r = e.y + e.height, s = i.a * e.x + i.c * e.y + i.tx, a = i.b * e.x + i.d * e.y + i.ty, o = i.a * n + i.c * e.y + i.tx, u = i.b * n + i.d * e.y + i.ty, h = i.a * e.x + i.c * r + i.tx, c = i.b * e.x + i.d * r + i.ty, l = i.a * n + i.c * r + i.tx, f = i.b * n + i.d * r + i.ty, d = Math.min(s, o, h, l), p = Math.max(s, o, h, l), _ = Math.min(a, u, c, f), g = Math.max(a, u, c, f); t.x = d, t.y = _, t.width = p - d, t.height = g - _ }, t.transformObb = function (t, e, i, n, r, s, a) { void 0 === a && (a = !0); var o = s.a * r.x + s.c * r.y + s.tx, u = s.b * r.x + s.d * r.y + s.ty, h = s.a * r.width, c = s.b * r.width, l = s.c * r.height, f = s.d * r.height; a ? (e.x = o, e.y = u, i.x = h + o, i.y = c + u, t.x = l + o, t.y = f + u, n.x = h + l + o, n.y = c + f + u) : (t.x = o, t.y = u, n.x = h + o, n.y = c + u, e.x = l + o, e.y = f + u, i.x = h + l + o, i.y = c + f + u) }, t }()); T.AffineTransform = IH, function (t) { t.PLAYED = "play", t.PAUSED = "pause", t.STOPPED = "stop", t.SEEKED = "seeked", t.ENDED = "ended", t.INTERRUPTION_BEGIN = "interruptionBegin", t.INTERRUPTION_END = "interruptionEnd", t.USER_GESTURE = "on_gesture" }(xH || (xH = {})), function (t) { t[t.DOM_AUDIO = 0] = "DOM_AUDIO", t[t.WEB_AUDIO = 1] = "WEB_AUDIO", t[t.MINIGAME_AUDIO = 2] = "MINIGAME_AUDIO", t[t.NATIVE_AUDIO = 3] = "NATIVE_AUDIO", t[t.UNKNOWN_AUDIO = 4] = "UNKNOWN_AUDIO" }(SH || (SH = {})), function (t) { t[t.INIT = 0] = "INIT", t[t.PLAYING = 1] = "PLAYING", t[t.PAUSED = 2] = "PAUSED", t[t.STOPPED = 3] = "STOPPED", t[t.INTERRUPTED = 4] = "INTERRUPTED" }(TH || (TH = {})); var EH = t("AudioPCMDataView", function () { function t() { this._bufferView = void 0, this._normalizeFactor = 1; for (var t = arguments.length, e = new Array(t), i = 0; i < t; i++)e[i] = arguments[i]; if (2 === e.length) this._bufferView = e[0], this._normalizeFactor = e[1]; else { var n = e[0], r = e[1], s = e[2]; this._bufferView = new r(n), this._normalizeFactor = s } } return t.prototype.getData = function (t) { return this._bufferView[t] * this._normalizeFactor }, n(t, [{ key: "length", get: function () { return this._bufferView.length } }]), t }()); function AH(t) { for (var e = t._operationQueue.length, i = t._operationQueue.slice(), n = [], r = !1, s = e - 1; s >= 0; s--) { var a = i[s]; if ("stop" === a.op) { n.push(a); break } if ("seek" === a.op) r || (n.push(a), r = !0); else { if (r) { n.push(a); break } 0 === n.length && n.push(a) } } t._operationQueue = n.reverse() } var CH, DH = 0; function RH(t, e) { var i; e.invoking || (e.invoking = !0, (i = e.func).call.apply(i, [t].concat(e.args)).then((function () { e.invoking = !1, t._operationQueue.shift(), t._eventTarget.emit(e.id.toString()), t._eventTarget.off(e.id.toString()), AH(t); var i = t._operationQueue[0]; i && RH(t, i) })).catch((function () { }))) } function PH(t, e, i) { var n = i.value; i.value = function () { for (var t = this, i = arguments.length, r = new Array(i), s = 0; s < i; s++)r[s] = arguments[s]; return new Promise((function (i) { var s = DH++, a = t; a._operationQueue.push({ op: e, id: s, func: n, args: r, invoking: !1 }), a._eventTarget.once(s.toString(), i), RH(a, a._operationQueue[0]) })) } } function BH(t) { return new Promise((function (e) { var i = t.play(); return void 0 === i ? e() : (i.then(e).catch((function () { var i = function i() { t.play().then((function () { null == n || n.removeEventListener("touchend", i, { capture: !0 }), null == n || n.removeEventListener("mouseup", i, { capture: !0 }) })).catch((function () { })), e() }, n = document.getElementById("GameCanvas"); null == n || n.addEventListener("touchend", i, { capture: !0 }), null == n || n.addEventListener("mouseup", i, { capture: !0 }) })), null) })) } var MH, OH, LH = function () { function t(t, e) { this._domAudio = void 0, this._onPlayCb = void 0, this._onEndCb = void 0, this._domAudio = t, t.volume = e } var e = t.prototype; return e.play = function () { var t = this; BH(this._domAudio).then((function () { null == t.onPlay || t.onPlay() })).catch((function () { })) }, e.stop = function () { this._domAudio.pause() }, n(t, [{ key: "onPlay", get: function () { return this._onPlayCb }, set: function (t) { this._onPlayCb = t } }, { key: "onEnd", get: function () { return this._onEndCb }, set: function (t) { this._onEndCb && this._domAudio.removeEventListener("ended", this._onEndCb), this._onEndCb = t, t && this._domAudio.addEventListener("ended", t) } }]), t }(), FH = (CH = function () { function t(t) { var e = this; this._domAudio = void 0, this._state = TH.INIT, this._onEnded = void 0, this._eventTarget = new wo, this._operationQueue = [], this._domAudio = t, mM.on(gM.EVENT_PAUSE, this._onInterruptedBegin, this), mM.on(gM.EVENT_RESUME, this._onInterruptedEnd, this), this._onEnded = function () { e.seek(0).catch((function () { })), e._state = TH.INIT, e._eventTarget.emit(xH.ENDED) }, this._domAudio.addEventListener("ended", this._onEnded) } var e = t.prototype; return e.destroy = function () { mM.off(gM.EVENT_PAUSE, this._onInterruptedBegin, this), mM.off(gM.EVENT_RESUME, this._onInterruptedEnd, this), this._domAudio.removeEventListener("ended", this._onEnded), this._domAudio = null }, t.load = function (e) { return new Promise((function (i, n) { t.loadNative(e).then((function (e) { i(new t(e)) })).catch(n) })) }, t.loadNative = function (t) { return new Promise((function (e, i) { var n = document.createElement("audio"), r = "canplaythrough"; Ro.os === Io.IOS ? r = "loadedmetadata" : Ro.browserType === xo.FIREFOX && (r = "canplay"); var s = setTimeout((function () { 0 === n.readyState ? u() : o() }), 8e3), a = function () { clearTimeout(s), n.removeEventListener(r, o, !1), n.removeEventListener("error", u, !1) }, o = function () { a(), e(n) }, u = function () { a(), i(new Error("load audio failure - " + t)) }; n.addEventListener(r, o, !1), n.addEventListener("error", u, !1), n.src = t })) }, t.loadOneShotAudio = function (e, i) { return new Promise((function (n, r) { t.loadNative(e).then((function (t) { var e = new LH(t, i); n(e) })).catch(r) })) }, e._onInterruptedBegin = function () { var t = this; this._state === TH.PLAYING && this.pause().then((function () { t._state = TH.INTERRUPTED, t._eventTarget.emit(xH.INTERRUPTION_BEGIN) })).catch((function () { })) }, e._onInterruptedEnd = function () { var t = this; this._state === TH.INTERRUPTED && this.play().then((function () { t._eventTarget.emit(xH.INTERRUPTION_END) })).catch((function () { })) }, e.getPCMData = function () { }, e.seek = function (t) { return t = Xi(t, 0, this.duration), this._domAudio.currentTime = t, Promise.resolve() }, e.play = function () { var t = this; return new Promise((function (e) { BH(t._domAudio).then((function () { t._state = TH.PLAYING, e() })).catch((function () { })) })) }, e.pause = function () { return this._domAudio.pause(), this._state = TH.PAUSED, Promise.resolve() }, e.stop = function () { var t = this; return new Promise((function (e) { t._domAudio.pause(), t._domAudio.currentTime = 0, t._state = TH.STOPPED, e() })) }, e.onInterruptionBegin = function (t) { this._eventTarget.on(xH.INTERRUPTION_BEGIN, t) }, e.offInterruptionBegin = function (t) { this._eventTarget.off(xH.INTERRUPTION_BEGIN, t) }, e.onInterruptionEnd = function (t) { this._eventTarget.on(xH.INTERRUPTION_END, t) }, e.offInterruptionEnd = function (t) { this._eventTarget.off(xH.INTERRUPTION_END, t) }, e.onEnded = function (t) { this._eventTarget.on(xH.ENDED, t) }, e.offEnded = function (t) { this._eventTarget.off(xH.ENDED, t) }, n(t, [{ key: "src", get: function () { return this._domAudio ? this._domAudio.src : "" } }, { key: "type", get: function () { return SH.DOM_AUDIO } }, { key: "state", get: function () { return this._state } }, { key: "loop", get: function () { return this._domAudio.loop }, set: function (t) { this._domAudio.loop = t } }, { key: "volume", get: function () { return this._domAudio.volume }, set: function (t) { t = qi(t), this._domAudio.volume = t } }, { key: "duration", get: function () { return this._domAudio.duration } }, { key: "currentTime", get: function () { return this._domAudio.currentTime } }, { key: "sampleRate", get: function () { return 0 } }]), t }(), m(CH.prototype, "seek", [PH], Object.getOwnPropertyDescriptor(CH.prototype, "seek"), CH.prototype), m(CH.prototype, "play", [PH], Object.getOwnPropertyDescriptor(CH.prototype, "play"), CH.prototype), m(CH.prototype, "pause", [PH], Object.getOwnPropertyDescriptor(CH.prototype, "pause"), CH.prototype), m(CH.prototype, "stop", [PH], Object.getOwnPropertyDescriptor(CH.prototype, "stop"), CH.prototype), CH), kH = function () { function t(t) { this._nativeAudio = void 0, this._startTime = 0, this._startOffset = 0, this._isPaused = !0, this._nativeAudio = t } var e = t.prototype; return e.destroy = function () { this._nativeAudio = void 0 }, e._now = function () { return performance.now() / 1e3 }, e._calculateCurrentTime = function () { var t = this._now() - this._startTime, e = this._startOffset + t; return e >= this.duration && (this._startTime = this._now(), this._startOffset = 0), e % this.duration }, e.start = function () { this._isPaused = !1, this._startTime = this._now() }, e.pause = function () { this._isPaused || (this._isPaused = !0, this._startOffset = this._calculateCurrentTime()) }, e.stop = function () { this._isPaused = !0, this._startOffset = 0 }, e.seek = function (t) { this._startTime = this._now(), this._startOffset = Xi(t, 0, this.duration) }, n(t, [{ key: "duration", get: function () { return this._nativeAudio.duration } }, { key: "currentTime", get: function () { return this._isPaused ? this._startOffset : this._calculateCurrentTime() } }]), t }(), NH = function () { function t() { this._audioBufferDataMap = {} } var e = t.prototype; return e.addCache = function (t, e) { this._audioBufferDataMap[t] ? it(5204, t) : this._audioBufferDataMap[t] = { usedCount: 1, audioBuffer: e } }, e.retainCache = function (t) { var e = this._audioBufferDataMap[t]; e ? e.usedCount++ : it(5203, t) }, e.getCache = function (t) { var e = this._audioBufferDataMap[t]; return null == e ? void 0 : e.audioBuffer }, e.tryReleasingCache = function (t) { var e = this._audioBufferDataMap[t]; e ? --e.usedCount <= 0 && delete this._audioBufferDataMap[t] : it(5203, t) }, t }(), zH = new NH, UH = window.AudioContext || window.webkitAudioContext || window.mozAudioContext, VH = "on-context-running", GH = function () { function t() { var t = this; this._eventTarget = void 0, this._context = void 0, this._isRunning = !1, this._context = new (window.AudioContext || window.webkitAudioContext || window.mozAudioContext), this._eventTarget = new wo, this._context.onstatechange = function () { "running" === t._context.state ? (t._isRunning = !0, t._eventTarget.emit(VH)) : t._isRunning = !1 } } var e = t.prototype; return e.onceRunning = function (t, e) { this._eventTarget.once(VH, t, e) }, e.offRunning = function (t, e) { this._eventTarget.off(VH, t, e) }, e.decodeAudioData = function (t) { var e = this; return new Promise((function (i, n) { var r = e._context.decodeAudioData(t, (function (t) { i(t) }), (function (t) { console.error("failed to load Web Audio", t) })); null == r || r.catch(n) })) }, e.runContext = function () { var t = this; return new Promise((function (e) { if (t.isRunning) e(); else { var i = t._context; if (i.resume) { if ("suspended" === i.state) i.resume().catch((function (t) { W("runContext error", t) })); else if ("running" === i.state) return void e(); var n = document.getElementById("GameCanvas"), r = function t() { i.resume().then((function () { null == n || n.removeEventListener("touchend", t, { capture: !0 }), null == n || n.removeEventListener("mouseup", t, { capture: !0 }), e() })).catch((function (t) { W("onGesture resume error", t) })) }; null == n || n.addEventListener("touchend", r, { capture: !0 }), null == n || n.addEventListener("mouseup", r, { capture: !0 }) } else e() } })) }, e.createBufferSource = function (t, e) { var i = this._context.createBufferSource(); return void 0 !== t && (i.buffer = t), void 0 !== e && (i.loop = e), i }, e.createGain = function (t) { void 0 === t && (t = 1); var e = this._context.createGain(); return this.setGainValue(e, t), e }, e.setGainValue = function (t, e) { if (t.gain.setTargetAtTime) try { t.gain.setTargetAtTime(e, this._context.currentTime, 0) } catch (i) { t.gain.setTargetAtTime(e, this._context.currentTime, .01) } else t.gain.value = e }, e.connectContext = function (t) { this._context && t.connect(this._context.destination) }, n(t, [{ key: "isRunning", get: function () { return this._isRunning } }, { key: "currentTime", get: function () { return this._context.currentTime } }]), t }(); GH.support = !!UH, GH.support && (OH = new GH); var HH, WH, jH, XH, qH = function () { function t(t, e, i) { this._duration = void 0, this._bufferSourceNode = void 0, this._onPlayCb = void 0, this._currentTimer = 0, this._url = void 0, this._onEndCb = void 0, this._duration = t.duration, this._url = i, this._bufferSourceNode = OH.createBufferSource(t, !1); var n = OH.createGain(e); this._bufferSourceNode.connect(n), OH.connectContext(n) } var e = t.prototype; return e.play = function () { var t = this; this._bufferSourceNode.start(), OH.runContext().then((function () { null == t.onPlay || t.onPlay(), t._currentTimer = window.setTimeout((function () { zH.tryReleasingCache(t._url), null == t.onEnd || t.onEnd() }), 1e3 * t._duration) })).catch((function (t) { W("play error", t) })) }, e.stop = function () { clearTimeout(this._currentTimer), zH.tryReleasingCache(this._url), this._bufferSourceNode.stop(), this._bufferSourceNode.disconnect(), this._bufferSourceNode.buffer = null }, n(t, [{ key: "onPlay", get: function () { return this._onPlayCb }, set: function (t) { this._onPlayCb = t } }, { key: "onEnd", get: function () { return this._onEndCb }, set: function (t) { this._onEndCb = t } }]), t }(), YH = (MH = function () { function t(t, e) { this._src = void 0, this._audioBuffer = void 0, this._sourceNode = void 0, this._gainNode = void 0, this._currentTimer = 0, this._volume = 1, this._loop = !1, this._state = TH.INIT, this._audioTimer = void 0, this._runningCallback = void 0, this._eventTarget = new wo, this._operationQueue = [], this._audioBuffer = t, this._audioTimer = new kH(t), this._gainNode = OH.createGain(), OH.connectContext(this._gainNode), this._src = e, mM.on(gM.EVENT_PAUSE, this._onInterruptedBegin, this), mM.on(gM.EVENT_RESUME, this._onInterruptedEnd, this) } var e = t.prototype; return e.destroy = function () { window.clearTimeout(this._currentTimer), this._audioTimer.destroy(), this._audioBuffer && (this._audioBuffer = null), zH.tryReleasingCache(this._src), mM.off(gM.EVENT_PAUSE, this._onInterruptedBegin, this), mM.off(gM.EVENT_RESUME, this._onInterruptedEnd, this), this.offRunning() }, t.load = function (e) { return new Promise((function (i, n) { t.loadNative(e).then((function (n) { i(new t(n, e)) })).catch(n) })) }, t.loadNative = function (t) { return new Promise((function (e, i) { var n = zH.getCache(t); if (n) return zH.retainCache(t), void e(n); var r = new XMLHttpRequest, s = "load audio failed: " + t + ", status: "; r.open("GET", t, !0), r.responseType = "arraybuffer", r.onload = function () { 200 === r.status || 0 === r.status ? OH.decodeAudioData(r.response).then((function (i) { zH.addCache(t, i), e(i) })).catch((function (e) { W("loadNative error", t, e) })) : i(new Error("" + s + r.status + "(no response)")) }, r.onerror = function () { i(new Error("" + s + r.status + "(error)")) }, r.ontimeout = function () { i(new Error("" + s + r.status + "(time out)")) }, r.onabort = function () { i(new Error("" + s + r.status + "(abort)")) }, r.send(null) })) }, t.loadOneShotAudio = function (e, i) { return new Promise((function (n, r) { t.loadNative(e).then((function (t) { var r = new qH(t, i, e); n(r) })).catch(r) })) }, e.getPCMData = function (t) { return new EH(this._audioBuffer.getChannelData(t), 1) }, e._onInterruptedBegin = function () { var t = this; this._state === TH.PLAYING && this.pause().then((function () { t._state = TH.INTERRUPTED, t._eventTarget.emit(xH.INTERRUPTION_BEGIN) })).catch((function (t) { W("_onInterruptedBegin error", t) })) }, e._onInterruptedEnd = function () { var t = this; this._state === TH.INTERRUPTED && this.play().then((function () { t._eventTarget.emit(xH.INTERRUPTION_END) })).catch((function (t) { W("_onInterruptedEnd error", t) })) }, e.offRunning = function () { this._runningCallback && (OH.offRunning(this._runningCallback), this._runningCallback = void 0) }, e.seek = function (t) { var e = this; return new Promise((function (i) { e.offRunning(), e._audioTimer.seek(t), e._state === TH.PLAYING ? e._doPlay().then(i).catch((function (t) { W("seek error", t) })) : i() })) }, e.play = function () { return this.offRunning(), this._doPlay() }, e._doPlay = function () { var t = this; return new Promise((function (e) { OH.isRunning ? (t._startSourceNode(), e()) : (t.offRunning(), t._runningCallback = function () { t._startSourceNode(), e() }, OH.onceRunning(t._runningCallback), OH.runContext().catch((function (t) { W("doPlay error", t) }))) })) }, e._startSourceNode = function () { var t = this; this._stopSourceNode(), this._sourceNode = OH.createBufferSource(this._audioBuffer, this.loop), this._sourceNode.connect(this._gainNode), this._sourceNode.loop = this._loop, this._sourceNode.start(0, this._audioTimer.currentTime), this._state = TH.PLAYING, this._audioTimer.start(), window.clearTimeout(this._currentTimer), this._currentTimer = window.setTimeout((function e() { t.loop ? t._currentTimer = window.setTimeout(e, 1e3 * t._audioBuffer.duration) : (t._audioTimer.stop(), t._eventTarget.emit(xH.ENDED), t._state = TH.INIT) }), 1e3 * (this._audioBuffer.duration - this._audioTimer.currentTime)) }, e._stopSourceNode = function () { try { this._sourceNode && (this._sourceNode.stop(), this._sourceNode.disconnect(), this._sourceNode.buffer = null, this._sourceNode = void 0) } catch (t) { } }, e.pause = function () { return this.offRunning(), this._state === TH.PLAYING && this._sourceNode ? (this._audioTimer.pause(), this._state = TH.PAUSED, window.clearTimeout(this._currentTimer), this._stopSourceNode(), Promise.resolve()) : Promise.resolve() }, e.stop = function () { return this.offRunning(), this._sourceNode ? (this._audioTimer.stop(), this._state = TH.STOPPED, window.clearTimeout(this._currentTimer), this._stopSourceNode(), Promise.resolve()) : (this._audioTimer.stop(), this._state = TH.STOPPED, Promise.resolve()) }, e.onInterruptionBegin = function (t) { this._eventTarget.on(xH.INTERRUPTION_BEGIN, t) }, e.offInterruptionBegin = function (t) { this._eventTarget.off(xH.INTERRUPTION_BEGIN, t) }, e.onInterruptionEnd = function (t) { this._eventTarget.on(xH.INTERRUPTION_END, t) }, e.offInterruptionEnd = function (t) { this._eventTarget.off(xH.INTERRUPTION_END, t) }, e.onEnded = function (t) { this._eventTarget.on(xH.ENDED, t) }, e.offEnded = function (t) { this._eventTarget.off(xH.ENDED, t) }, n(t, [{ key: "sampleRate", get: function () { return this._audioBuffer.sampleRate } }, { key: "src", get: function () { return this._src } }, { key: "type", get: function () { return SH.WEB_AUDIO } }, { key: "state", get: function () { return this._state } }, { key: "loop", get: function () { return this._loop }, set: function (t) { this._loop = t, this._sourceNode && (this._sourceNode.loop = t) } }, { key: "volume", get: function () { return this._volume }, set: function (t) { t = qi(t), this._volume = t, OH.setGainValue(this._gainNode, t) } }, { key: "duration", get: function () { return this._audioBuffer.duration } }, { key: "currentTime", get: function () { return this._audioTimer.currentTime } }]), t }(), m(MH.prototype, "seek", [PH], Object.getOwnPropertyDescriptor(MH.prototype, "seek"), MH.prototype), m(MH.prototype, "play", [PH], Object.getOwnPropertyDescriptor(MH.prototype, "play"), MH.prototype), m(MH.prototype, "pause", [PH], Object.getOwnPropertyDescriptor(MH.prototype, "pause"), MH.prototype), m(MH.prototype, "stop", [PH], Object.getOwnPropertyDescriptor(MH.prototype, "stop"), MH.prototype), MH), KH = function () { function t(t) { this._audio = void 0, this._audio = t } var e = t.prototype; return e.play = function () { this._audio.play() }, e.stop = function () { this._audio.stop() }, n(t, [{ key: "onPlay", get: function () { return this._audio.onPlay }, set: function (t) { this._audio.onPlay = t } }, { key: "onEnd", get: function () { return this._audio.onEnd }, set: function (t) { this._audio.onEnd = t } }]), t }(), QH = function () { function t(t) { this._player = void 0, this._player = t } t.load = function (e, i) { return new Promise((function (n, r) { (null == i ? void 0 : i.audioLoadMode) !== SH.DOM_AUDIO && GH.support ? YH.load(e).then((function (e) { n(new t(e)) })).catch(r) : (GH.support || it(5201), FH.load(e).then((function (e) { n(new t(e)) })).catch(r)) })) }; var e = t.prototype; return e.destroy = function () { this._player.destroy() }, t.loadNative = function (t, e) { return (null == e ? void 0 : e.audioLoadMode) !== SH.DOM_AUDIO && GH.support ? YH.loadNative(t) : (GH.support || it(5201), FH.loadNative(t)) }, t.loadOneShotAudio = function (t, e, i) { return new Promise((function (n, r) { (null == i ? void 0 : i.audioLoadMode) !== SH.DOM_AUDIO && GH.support ? YH.loadOneShotAudio(t, e).then((function (t) { n(new KH(t)) })).catch(r) : (GH.support || it(5201), FH.loadOneShotAudio(t, e).then((function (t) { n(new KH(t)) })).catch(r)) })) }, e.getPCMData = function (t) { return this._player.getPCMData(t) }, e.seek = function (t) { return this._player.seek(t) }, e.play = function () { return this._player.play() }, e.pause = function () { return this._player.pause() }, e.stop = function () { return this._player.stop() }, e.onInterruptionBegin = function (t) { this._player.onInterruptionBegin(t) }, e.offInterruptionBegin = function (t) { this._player.offInterruptionBegin(t) }, e.onInterruptionEnd = function (t) { this._player.onInterruptionEnd(t) }, e.offInterruptionEnd = function (t) { this._player.offInterruptionEnd(t) }, e.onEnded = function (t) { this._player.onEnded(t) }, e.offEnded = function (t) { this._player.offEnded(t) }, n(t, [{ key: "src", get: function () { return this._player.src } }, { key: "type", get: function () { return this._player.type } }, { key: "state", get: function () { return this._player.state } }, { key: "loop", get: function () { return this._player.loop }, set: function (t) { this._player.loop = t } }, { key: "volume", get: function () { return this._player.volume }, set: function (t) { this._player.volume = t } }, { key: "duration", get: function () { return this._player.duration } }, { key: "currentTime", get: function () { return this._player.currentTime } }, { key: "sampleRate", get: function () { return this._player.sampleRate } }]), t }(); QH.maxAudioChannel = 24; var ZH = t("AudioClip", Gu("cc.AudioClip")((XH = function (t) { function e(e) { var i; return (i = t.call(this, e) || this)._duration = jH && jH(), i._loadMode = SH.UNKNOWN_AUDIO, i._meta = null, i._player = null, i } s(e, t); var i = e.prototype; return i.destroy = function () { var e, i = t.prototype.destroy.call(this); return null == (e = this._player) || e.destroy(), this._player = null, this._meta && (this._meta.player = null), i }, i.validate = function () { return !!this._meta }, i.getDuration = function () { return this._duration ? this._duration : this._meta ? this._meta.duration : 0 }, i.getCurrentTime = function () { return this._player ? this._player.currentTime : 0 }, i.getVolume = function () { return this._player ? this._player.volume : 0 }, i.getLoop = function () { return !!this._player && this._player.loop }, i.setCurrentTime = function (t) { var e; null == (e = this._player) || e.seek(t).catch((function () { })) }, i.setVolume = function (t) { this._player && (this._player.volume = t) }, i.setLoop = function (t) { this._player && (this._player.loop = t) }, i.play = function () { var t; null == (t = this._player) || t.play().catch((function () { })) }, i.pause = function () { var t; null == (t = this._player) || t.pause().catch((function () { })) }, i.stop = function () { var t; null == (t = this._player) || t.stop().catch((function () { })) }, i.playOneShot = function (t) { void 0 === t && (t = 1), this._nativeAsset && QH.loadOneShotAudio(this._nativeAsset.url, t).then((function (t) { t.play() })).catch((function () { })) }, n(e, [{ key: "duration", set: function (t) { this._duration = t } }, { key: "_nativeAsset", get: function () { return this._meta }, set: function (t) { this._meta = t, t ? (this._loadMode = t.type, this._player = t.player) : (this._meta = null, this._loadMode = SH.UNKNOWN_AUDIO, this._duration = 0) } }, { key: "_nativeDep", get: function () { return { uuid: this._uuid, audioLoadMode: this.loadMode, ext: this._native, __isNative__: !0 } } }, { key: "loadMode", get: function () { return this._loadMode } }, { key: "state", get: function () { return this._player ? this._player.state : TH.INIT } }]), e }(pg), XH.AudioType = SH, jH = Bu((WH = XH).prototype, "_duration", [eh], (function () { return 0 })), m(WH.prototype, "_nativeDep", [Oh], Object.getOwnPropertyDescriptor(WH.prototype, "_nativeDep"), WH.prototype), HH = WH)) || HH); function JH(t, e, i) { QH.load(t, { audioLoadMode: e.audioLoadMode }).then((function (e) { var n = { player: e, url: t, duration: e.duration, type: e.type }; i(null, n) })).catch((function (t) { i(t) })) } function $H(t, e, i, n) { var r = new ZH; r._nativeUrl = t, r._nativeAsset = e, r.duration = e.duration, n(null, r) } S.AudioClip = ZH, hS.register({ ".mp3": JH, ".ogg": JH, ".wav": JH, ".m4a": JH }), xS.register({ ".mp3": $H, ".ogg": $H, ".wav": $H, ".m4a": $H }); var tW, eW, iW, nW, rW, sW, aW, oW, uW, hW, cW = new (function () { function t() { this._oneShotAudioInfoList = [], this._audioPlayerInfoList = [] } var e = t.prototype; return e._findIndex = function (t, e) { return t.findIndex((function (t) { return t.audio === e })) }, e._tryAddPlaying = function (t, e) { var i = this._findIndex(t, e); if (i > -1) return t[i].playTime = performance.now(), !1; var n = { audio: e, playTime: performance.now() }; return t.push(n), !0 }, e.addPlaying = function (t) { t instanceof QH ? this._tryAddPlaying(this._audioPlayerInfoList, t) : this._tryAddPlaying(this._oneShotAudioInfoList, t) }, e._tryRemovePlaying = function (t, e) { var i = this._findIndex(t, e); return -1 !== i && (ge(t, i), !0) }, e.removePlaying = function (t) { t instanceof QH ? this._tryRemovePlaying(this._audioPlayerInfoList, t) : this._tryRemovePlaying(this._oneShotAudioInfoList, t) }, e.discardOnePlayingIfNeeded = function () { var t; this._audioPlayerInfoList.length + this._oneShotAudioInfoList.length < QH.maxAudioChannel || (this._oneShotAudioInfoList.length > 0 ? this._oneShotAudioInfoList.forEach((function (e) { (!t || e.playTime < t.playTime) && (t = e) })) : this._audioPlayerInfoList.forEach((function (e) { (!t || e.playTime < t.playTime) && (t = e) })), t && (t.audio.stop(), this.removePlaying(t.audio))) }, e.pause = function () { this._oneShotAudioInfoList.forEach((function (t) { t.audio.stop() })), this._audioPlayerInfoList.forEach((function (t) { t.audio.pause().catch((function () { })) })) }, e.resume = function () { this._audioPlayerInfoList.forEach((function (t) { t.audio.play().catch((function () { })) })) }, t }()), lW = "audiosource-loaded", fW = (tW = Gu("cc.AudioSource"), eW = Ih(ZH), iW = Ih(ZH), tW((hW = function (t) { function e() { var e; return (e = t.call(this) || this)._clip = sW && sW(), e._player = null, e._hasRegisterListener = !1, e._loop = aW && aW(), e._playOnAwake = oW && oW(), e._volume = uW && uW(), e._cachedCurrentTime = -1, e._operationsBeforeLoading = [], e._isLoaded = !1, e._lastSetClip = null, e } s(e, t); var i = e.prototype; return i._resetPlayer = function () { this._player && (cW.removePlaying(this._player), this._unregisterListener(), this._player.destroy(), this._player = null) }, i._syncPlayer = function () { var t = this, e = this._clip; if (this._lastSetClip !== e) return e ? void (e._nativeAsset ? (this._isLoaded = !1, this._lastSetClip = e, this._operationsBeforeLoading.length = 0, QH.load(e._nativeAsset.url, { audioLoadMode: e.loadMode }).then((function (i) { var n; t._lastSetClip === e ? (t._isLoaded = !0, t._resetPlayer(), t._player = i, t._syncStates(), null == (n = t.node) || n.emit(lW)) : i.destroy() })).catch((function () { }))) : console.error("Invalid audio clip")) : (this._lastSetClip = null, void this._resetPlayer()) }, i._registerListener = function () { var t = this; if (!this._hasRegisterListener && this._player) { var e = this._player; e.onEnded((function () { var i; cW.removePlaying(e), null == (i = t.node) || i.emit("ended", t) })), e.onInterruptionBegin((function () { cW.removePlaying(e) })), e.onInterruptionEnd((function () { t._player === e && cW.addPlaying(e) })), this._hasRegisterListener = !0 } }, i._unregisterListener = function () { this._player && this._hasRegisterListener && (this._player.offEnded(), this._player.offInterruptionBegin(), this._player.offInterruptionEnd(), this._hasRegisterListener = !1) }, i.onLoad = function () { this._syncPlayer() }, i.onEnable = function () { this._playOnAwake && !this.playing && this.play() }, i.onDisable = function () { var t = this._getRootNode(); null != t && t._persistNode || this.pause() }, i.onDestroy = function () { this.stop(), this.clip = null }, i.getPCMData = function (t) { var e = this; return new Promise((function (i) { if (0 !== t && 1 !== t) return W("Only support channel index 0 or 1 to get buffer"), void i(void 0); var n; e._player ? i(e._player.getPCMData(t)) : null == (n = e.node) || n.once(lW, (function () { var n; i(null == (n = e._player) ? void 0 : n.getPCMData(t)) })) })) }, i.getSampleRate = function () { var t = this; return new Promise((function (e) { var i; t._player ? e(t._player.sampleRate) : null == (i = t.node) || i.once(lW, (function () { e(t._player.sampleRate) })) })) }, i._getRootNode = function () { for (var t, e, i = this.node, n = null == (t = i) || null == (e = t.parent) ? void 0 : e.parent; n;) { var r, s, a; n = null == (s = i = null == (r = i) ? void 0 : r.parent) || null == (a = s.parent) ? void 0 : a.parent } return i }, i.play = function () { var t = this; if (this._isLoaded || !this.clip) { var e; this._registerListener(), cW.discardOnePlayingIfNeeded(), this.state === TH.PLAYING && (null == (e = this._player) || e.stop().catch((function () { }))); var i = this._player; i && (i.play().then((function () { var e; null == (e = t.node) || e.emit("started", t) })).catch((function () { cW.removePlaying(i) })), cW.addPlaying(i)) } else this._operationsBeforeLoading.push({ op: "play", params: null }) }, i.pause = function () { var t; this._isLoaded || !this.clip ? null == (t = this._player) || t.pause().catch((function () { })) : this._operationsBeforeLoading.push({ op: "pause", params: null }) }, i.stop = function () { this._isLoaded || !this.clip ? this._player && (this._player.stop().catch((function () { })), cW.removePlaying(this._player)) : this._operationsBeforeLoading.push({ op: "stop", params: null }) }, i.playOneShot = function (t, e) { var i; void 0 === e && (e = 1), t._nativeAsset ? QH.loadOneShotAudio(t._nativeAsset.url, this._volume * e, { audioLoadMode: t.loadMode }).then((function (t) { i = t, cW.discardOnePlayingIfNeeded(), t.onEnd = function () { cW.removePlaying(t) }, t.play(), cW.addPlaying(t) })).catch((function () { i && cW.removePlaying(i) })) : console.error("Invalid audio clip") }, i._syncStates = function () { var t = this; this._player && (this._player.loop = this._loop, this._player.volume = this._volume, this._operationsBeforeLoading.forEach((function (e) { var i; "seek" === e.op ? (t._cachedCurrentTime = e.params && e.params[0], t._player && t._player.seek(t._cachedCurrentTime).catch((function () { }))) : null == (i = t[e.op]) || i.call(t) })), this._operationsBeforeLoading.length = 0) }, n(e, [{ key: "clip", get: function () { return this._clip }, set: function (t) { t !== this._clip && (this._clip = t, this._syncPlayer()) } }, { key: "loop", get: function () { return this._loop }, set: function (t) { this._loop = t, this._player && (this._player.loop = t) } }, { key: "playOnAwake", get: function () { return this._playOnAwake }, set: function (t) { this._playOnAwake = t } }, { key: "volume", get: function () { return this._volume }, set: function (t) { Number.isNaN(t) ? W("illegal audio volume!") : (t = Xi(t, 0, 1), this._player ? (this._player.volume = t, this._volume = this._player.volume) : this._volume = t) } }, { key: "currentTime", get: function () { return this._player ? this._player.currentTime : this._cachedCurrentTime < 0 ? 0 : this._cachedCurrentTime }, set: function (t) { var e; Number.isNaN(t) ? W("illegal audio time!") : (t = Xi(t, 0, this.duration), this._isLoaded || !this.clip ? (this._cachedCurrentTime = t, null == (e = this._player) || e.seek(this._cachedCurrentTime).catch((function () { }))) : this._operationsBeforeLoading.push({ op: "seek", params: [t] })) } }, { key: "duration", get: function () { var t, e; return null !== (t = null == (e = this._clip) ? void 0 : e.getDuration()) && void 0 !== t ? t : this._player ? this._player.duration : 0 } }, { key: "state", get: function () { return this._player ? this._player.state : TH.INIT } }, { key: "playing", get: function () { return this.state === e.AudioState.PLAYING } }], [{ key: "maxAudioChannel", get: function () { return QH.maxAudioChannel } }]), e }(am), hW.AudioState = TH, hW.EventType = { STARTED: "started", ENDED: "ended" }, sW = Bu((rW = hW).prototype, "_clip", [eW], (function () { return null })), aW = Bu(rW.prototype, "_loop", [eh], (function () { return !1 })), oW = Bu(rW.prototype, "_playOnAwake", [eh], (function () { return !0 })), uW = Bu(rW.prototype, "_volume", [eh], (function () { return 1 })), m(rW.prototype, "clip", [iW], Object.getOwnPropertyDescriptor(rW.prototype, "clip"), rW.prototype), nW = rW)) || nW); t({ AudioSource: fW, AudioSourceComponent: fW }), lt(ZH, "AudioClip", [{ name: "PlayingState", newName: "AudioState", target: fW, targetName: "AudioSource" }]), dt(ZH.prototype, "AudioClip.prototype", ["state", "play", "pause", "stop", "playOneShot", "setCurrentTime", "setVolume", "setLoop", "getCurrentTime", "getVolume", "getLoop"].map((function (t) { return { name: t, suggest: "please use AudioSource.prototype." + t + " instead" } }))), S.AudioSourceComponent = fW, ae(fW, "cc.AudioSourceComponent"), T.log = H, T.warn = W, T.error = j, T.assert = X, T._throw = K, T.logID = J, T.warnID = it, T.errorID = rt, T.assertID = at, T.debug = gt, T.path = { join: Oo, extname: Lo, mainFileName: Fo, basename: ko, dirname: No, changeExtname: zo, changeBasename: Uo, _normalize: Vo, stripSep: Go, get sep() { return Ho() } }; var dW = 1, pW = -4192741, _W = []; function gW(t) { return "function" == typeof t._instantiate } function mW(t) { var e; if (co(t)) { if (gW(t)) return S.game._isCloning = !0, e = t._instantiate(null, !0), S.game._isCloning = !1, e; if (t instanceof S.Asset) throw new TypeError(ut(6903)) } return S.game._isCloning = !0, e = vW(t), S.game._isCloning = !1, e } function vW(t, e) { var i; bW(t, i = t._iN$t ? t._iN$t : t.constructor ? new (0, t.constructor) : Object.create(null), e); for (var n = 0, r = _W.length; n < r; ++n)_W[n]._iN$t = null; return _W.length = 0, i } function yW(t, e, i, n) { for (var r = t.__values__, s = 0; s < r.length; s++) { var a = r[s], o = e[a]; if ("object" == typeof o && o) { var u = i[a]; u instanceof Re && u.constructor === o.constructor ? u.set(o) : i[a] = o._iN$t || wW(o, n) } else i[a] = o } } function bW(t, e, i) { Ot(t, "_iN$t", e, !0), _W.push(t); var n = t.constructor; if (Bi(n)) yW(n, t, e, i); else for (var r in t) if (t.hasOwnProperty(r) && (95 !== r.charCodeAt(0) || 95 !== r.charCodeAt(1) || "__type__" === r || "__prefab" === r)) { var s = t[r]; if ("object" == typeof s && s) { if (s === e) continue; e[r] = s._iN$t || wW(s, i) } else e[r] = s } co(t) && (e._objFlags &= pW) } function wW(t, e) { if (t instanceof Re) return t.clone(); if (t instanceof S.Asset) return t; var i; if (ArrayBuffer.isView(t)) { var n = t.length; i = new t.constructor(n), t._iN$t = i, _W.push(t); for (var r = 0; r < n; ++r)i[r] = t[r]; return i } if (Array.isArray(t)) { var s = t.length; i = new Array(s), t._iN$t = i, _W.push(t); for (var a = 0; a < s; ++a) { var o = t[a]; i[a] = "object" == typeof o && o ? o._iN$t || wW(o, e) : o } return i } if (t._objFlags & dW) return null; var u = t.constructor; if (Bi(u)) { if (e) if (e instanceof am) { if (t instanceof ky || t instanceof am) return t } else if (e instanceof ky) if (t instanceof ky) { if (!t.isChildOf(e)) return t } else if (t instanceof am && t.node && !t.node.isChildOf(e)) return t; i = new u } else if (u === Object) i = {}; else { if (u) return t; i = Object.create(null) } return bW(t, i, e), i } mW._clone = vW, S.instantiate = mW; var xW, SW, TW = t("NodePool", function () { function t(t) { this._pool = [], this.poolHandlerComp = t } var e = t.prototype; return e.size = function () { return this._pool.length }, e.clear = function () { for (var t = this._pool.length, e = 0; e < t; ++e)this._pool[e].destroy(); this._pool.length = 0 }, e.put = function (t) { if (t && -1 === this._pool.indexOf(t)) { t.removeFromParent(); var e = this.poolHandlerComp ? t.getComponent(this.poolHandlerComp) : null; e && e.unuse && e.unuse(), this._pool.push(t) } }, e.get = function () { for (var t = arguments.length, e = new Array(t), i = 0; i < t; i++)e[i] = arguments[i]; var n = this._pool.length - 1; if (n < 0) return null; var r = this._pool[n]; this._pool.length = n; var s = this.poolHandlerComp ? r.getComponent(this.poolHandlerComp) : null; return s && s.reuse && s.reuse(arguments), r }, t }()); T.NodePool = TW; var IW = null !== (xW = globalThis.jsb) && void 0 !== xW ? xW : {}; t("native", { DownloaderHints: IW.DownloaderHints, Downloader: IW.Downloader, zipUtils: IW.zipUtils, fileUtils: IW.fileUtils, DebugRenderer: IW.DebugRenderer, copyTextToClipboard: null == (SW = IW.copyTextToClipboard) ? void 0 : SW.bind(IW), garbageCollect: IW.garbageCollect, reflection: IW.reflection, bridge: IW.bridge, jsbBridgeWrapper: IW.jsbBridgeWrapper, AssetsManager: IW.AssetsManager, EventAssetsManager: IW.EventAssetsManager, Manifest: IW.Manifest, saveImageData: IW.saveImageData, process: IW.process, adpf: IW.adpf }), T.renderer = xN; var EW = function () { function t(t, e, i, n) { void 0 === t && (t = null), void 0 === e && (e = 0), void 0 === i && (i = !1), void 0 === n && (n = null), this.light = t, this.probe = n, this.level = e, this.culledByLight = i } return t.prototype.reset = function (t, e, i, n) { this.light = t, this.probe = n, this.level = e, this.culledByLight = i }, t }(), AW = function () { function t(t, e, i, n, r) { void 0 === t && (t = ""), void 0 === e && (e = ""), void 0 === i && (i = 0), void 0 === n && (n = 1), void 0 === r && (r = 1), this.source = t, this.target = e, this.resolveFlags = i, this.mode = n, this.mode1 = r } return t.prototype.reset = function (t, e, i, n, r) { this.source = t, this.target = e, this.resolveFlags = i, this.mode = n, this.mode1 = r }, t }(), CW = function () { function t(t, e, i, n, r, s, a, o, u, h) { void 0 === t && (t = ""), void 0 === e && (e = ""), void 0 === i && (i = 4294967295), void 0 === n && (n = 4294967295), void 0 === r && (r = 0), void 0 === s && (s = 0), void 0 === a && (a = 0), void 0 === o && (o = 0), void 0 === u && (u = 0), void 0 === h && (h = 0), this.source = t, this.target = e, this.mipLevels = i, this.numSlices = n, this.sourceMostDetailedMip = r, this.sourceFirstSlice = s, this.sourcePlaneSlice = a, this.targetMostDetailedMip = o, this.targetFirstSlice = u, this.targetPlaneSlice = h } return t.prototype.reset = function (t, e, i, n, r, s, a, o, u, h) { this.source = t, this.target = e, this.mipLevels = i, this.numSlices = n, this.sourceMostDetailedMip = r, this.sourceFirstSlice = s, this.sourcePlaneSlice = a, this.targetMostDetailedMip = o, this.targetFirstSlice = u, this.targetPlaneSlice = h }, t }(), DW = function () { function t(t, e, i, n, r, s, a) { void 0 === t && (t = new Uint8Array(0)), void 0 === e && (e = ""), void 0 === i && (i = 4294967295), void 0 === n && (n = 4294967295), void 0 === r && (r = 0), void 0 === s && (s = 0), void 0 === a && (a = 0), this.source = t, this.target = e, this.mipLevels = i, this.numSlices = n, this.targetMostDetailedMip = r, this.targetFirstSlice = s, this.targetPlaneSlice = a } return t.prototype.reset = function (t, e, i, n, r, s) { this.target = t, this.mipLevels = e, this.numSlices = i, this.targetMostDetailedMip = n, this.targetFirstSlice = r, this.targetPlaneSlice = s }, t }(), RW = function () { function t(t, e, i, n, r, s, a) { void 0 === t && (t = ""), void 0 === e && (e = ""), void 0 === i && (i = 4294967295), void 0 === n && (n = 4294967295), void 0 === r && (r = 0), void 0 === s && (s = 0), void 0 === a && (a = 0), this.source = t, this.target = e, this.mipLevels = i, this.numSlices = n, this.targetMostDetailedMip = r, this.targetFirstSlice = s, this.targetPlaneSlice = a } return t.prototype.reset = function (t, e, i, n, r, s, a) { this.source = t, this.target = e, this.mipLevels = i, this.numSlices = n, this.targetMostDetailedMip = r, this.targetFirstSlice = s, this.targetPlaneSlice = a }, t }(), PW = function () { function t() { this.numRenderPasses = 0, this.numManagedTextures = 0, this.totalManagedTextures = 0, this.numUploadBuffers = 0, this.numUploadBufferViews = 0, this.numFreeUploadBuffers = 0, this.numFreeUploadBufferViews = 0, this.numDescriptorSets = 0, this.numFreeDescriptorSets = 0, this.numInstancingBuffers = 0, this.numInstancingUniformBlocks = 0 } return t.prototype.reset = function () { this.numRenderPasses = 0, this.numManagedTextures = 0, this.totalManagedTextures = 0, this.numUploadBuffers = 0, this.numUploadBufferViews = 0, this.numFreeUploadBuffers = 0, this.numFreeUploadBufferViews = 0, this.numDescriptorSets = 0, this.numFreeDescriptorSets = 0, this.numInstancingBuffers = 0, this.numInstancingUniformBlocks = 0 }, t }(); function BW(t) { return new eo((function () { return new t }), 16) } var MW, OW, LW, FW = function () { function t() { this.li = BW(EW), this.rp = BW(AW), this.cp = BW(CW), this.up = BW(DW), this.mp = BW(RW), this.ps = BW(PW) } var e = t.prototype; return e.reset = function () { this.li.reset(), this.rp.reset(), this.cp.reset(), this.up.reset(), this.mp.reset(), this.ps.reset() }, e.createLightInfo = function (t, e, i, n) { void 0 === t && (t = null), void 0 === e && (e = 0), void 0 === i && (i = !1), void 0 === n && (n = null); var r = this.li.add(); return r.reset(t, e, i, n), r }, e.createResolvePair = function (t, e, i, n, r) { void 0 === t && (t = ""), void 0 === e && (e = ""), void 0 === i && (i = 0), void 0 === n && (n = 1), void 0 === r && (r = 1); var s = this.rp.add(); return s.reset(t, e, i, n, r), s }, e.createCopyPair = function (t, e, i, n, r, s, a, o, u, h) { void 0 === t && (t = ""), void 0 === e && (e = ""), void 0 === i && (i = 4294967295), void 0 === n && (n = 4294967295), void 0 === r && (r = 0), void 0 === s && (s = 0), void 0 === a && (a = 0), void 0 === o && (o = 0), void 0 === u && (u = 0), void 0 === h && (h = 0); var c = this.cp.add(); return c.reset(t, e, i, n, r, s, a, o, u, h), c }, e.createUploadPair = function (t, e, i, n, r, s) { void 0 === t && (t = ""), void 0 === e && (e = 4294967295), void 0 === i && (i = 4294967295), void 0 === n && (n = 0), void 0 === r && (r = 0), void 0 === s && (s = 0); var a = this.up.add(); return a.reset(t, e, i, n, r, s), a }, e.createMovePair = function (t, e, i, n, r, s, a) { void 0 === t && (t = ""), void 0 === e && (e = ""), void 0 === i && (i = 4294967295), void 0 === n && (n = 4294967295), void 0 === r && (r = 0), void 0 === s && (s = 0), void 0 === a && (a = 0); var o = this.mp.add(); return o.reset(t, e, i, n, r, s, a), o }, e.createPipelineStatistics = function () { var t = this.ps.add(); return t.reset(), t }, t }(), kW = function () { function t(t, e) { this.source = void 0, this.target = void 0, this.source = t, this.target = e } return t.prototype.equals = function (t) { return this.source === t.source && this.target === t.target }, t }(), NW = function () { function t(t) { this.target = void 0, this.target = t } return t.prototype.equals = function (t) { return this.target === t.target }, t }(); MW = Symbol.iterator; var zW = function () { function t(t, e) { this.iterator = void 0, this.source = void 0, this.iterator = t, this.source = e } var e = t.prototype; return e[MW] = function () { return this }, e.next = function () { var t = this.iterator.next(); return t.done ? { value: void 0, done: !0 } : { value: new kW(this.source, t.value.target), done: !1 } }, t }(); OW = Symbol.iterator; var UW = function () { function t(t, e) { this.iterator = void 0, this.source = void 0, this.iterator = t, this.source = e } var e = t.prototype; return e[OW] = function () { return this }, e.next = function () { var t = this.iterator.next(); return t.done ? { value: void 0, done: !0 } : { value: new kW(t.value.target, this.source), done: !1 } }, t }(); LW = Symbol.iterator; var VW = function () { function t(t, e) { this.graph = void 0, this.iterator = void 0, this.graph = t, this.iterator = e } var e = t.prototype; return e[LW] = function () { return this }, e.next = function () { var t = this.iterator.next(); return t.done ? { value: void 0, done: !0 } : { value: this.graph.target(t.value), done: !1 } }, t }(); function GW(t, e) { if (e === t.N) return ""; for (var i = []; e !== t.N; e = t.getParent(e))i.push(t.vertexName(e)); for (var n = "", r = i.length; r-- > 0;)n += "/", n += i[r]; return n } function HW(t, e, i) { var n = t.N, r = i.split("/"); if (0 === r.length) return e; var s = e, a = 0; "" === r[0] && (s = n, ++a); for (var o = a; o !== r.length; ++o) { var u = r[o]; if ("" !== u && "." !== u) if (".." !== u) { if ((s = t.locateChild(s, u)) === n) return n } else { if (s === n) return n; s = t.getParent(s) } } return s } var WW = function () { function t() { } return t.prototype.terminate = function () { return !1 }, t }(); function jW(t) { var e = t.v().next(); return e.done ? t.N : e.value } var XW = function (t, e, i) { this.v = void 0, this.e = void 0, this.iter = void 0, this.v = t, this.e = e, this.iter = i }; function qW(t, e, i, n, r) { var s = null, a = null, o = new Array; for (n.put(e, 1), i.discoverVertex(e, t), a = t.oe(e), r.terminate(e, t) ? o.push(new XW(e, null, null)) : o.push(new XW(e, null, a)); o.length;) { var u = o.pop(); if (e = u.v, s = u.e, a = u.iter, null !== s && i.finishEdge(s, t), a) for (var h = a.next(); !h.done; h = a.next()) { var c = h.value, l = c.target; i.examineEdge(c, t); var f = n.get(l); if (0 === f) { if (i.treeEdge(c, t), s = c, o.push(new XW(e, s, a)), e = l, n.put(e, 1), i.discoverVertex(e, t), a = t.oe(e), r.terminate(e, t)) break } else 1 === f ? i.backEdge(c, t) : i.forwardOrCrossEdge(c, t), i.finishEdge(c, t) } n.put(e, 4), i.finishVertex(e, t) } } function YW(t, e, i, n) { if (void 0 === n && (n = null), null !== (n = n || jW(t)) && 0 !== t.nv()) { for (var r, s = p(t.v()); !(r = s()).done;) { var a = r.value; i.put(a, 0), e.initializeVertex(a, t) } var o = new WW; n !== jW(t) && (e.startVertex(n, t), qW(t, n, e, i, o)); for (var u, h = p(t.v()); !(u = h()).done;) { var c = u.value; 0 === i.get(c) && (e.startVertex(c, t), qW(t, c, e, i, o)) } } } var KW = function () { function t() { } var e = t.prototype; return e.initializeVertex = function () { }, e.startVertex = function () { }, e.discoverVertex = function () { }, e.examineEdge = function () { }, e.treeEdge = function () { }, e.backEdge = function () { }, e.forwardOrCrossEdge = function () { }, e.finishEdge = function () { }, e.finishVertex = function () { }, t }(), QW = function () { function t(t) { this.g = void 0, this.g = t, this.N = t.N } var e = t.prototype; return e.edge = function (t, e) { return this.g.reference(t, e) }, e.source = function (t) { return this.g.parent(t) }, e.target = function (t) { return this.g.child(t) }, e.oe = function (t) { return this.g.children(t) }, e.od = function (t) { return this.g.numChildren(t) }, e.v = function () { return this.g.v() }, e.nv = function () { return this.g.nv() }, t }(); function ZW(t) { t.x = 0, t.y = 0, t.z = 0, t.w = 0 } function JW(t) { t.left = 0, t.top = 0, t.width = 0, t.height = 0, t.minDepth = 0, t.maxDepth = 1 } var $W = function () { function t(t, e, i, n) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 0), this.x = t, this.y = e, this.z = i, this.w = n } return t.prototype.reset = function (t, e, i, n) { this.x = t, this.y = e, this.z = i, this.w = n }, t }(), tj = function () { function t(t, e, i, n, r, s, a, o) { void 0 === t && (t = ""), void 0 === e && (e = 2), void 0 === i && (i = 0), void 0 === n && (n = 0), void 0 === r && (r = 0), void 0 === s && (s = 7), void 0 === a && (a = new Xd), void 0 === o && (o = 0), this.slotName1 = "", this.slotID = 0, this.slotName = t, this.accessType = e, this.attachmentType = i, this.loadOp = n, this.storeOp = r, this.clearFlags = s, this.clearColor = a, this.shaderStageFlags = o } return t.prototype.reset = function (t, e, i, n, r, s, a) { this.slotName = t, this.slotName1 = "", this.accessType = e, this.attachmentType = i, this.loadOp = n, this.storeOp = r, this.clearFlags = s, ZW(this.clearColor), this.slotID = 0, this.shaderStageFlags = a }, t }(), ej = function () { function t(t, e, i, n, r, s) { void 0 === t && (t = ""), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 0), void 0 === r && (r = new $W), void 0 === s && (s = 0), this.plane = 0, this.name = t, this.accessType = e, this.clearFlags = i, this.clearValueType = n, this.clearValue = r, this.shaderStageFlags = s } return t.prototype.reset = function (t, e, i, n, r) { this.name = t, this.accessType = e, this.plane = 0, this.clearFlags = i, this.clearValueType = n, this.clearValue.reset(0, 0, 0, 0), this.shaderStageFlags = r }, t }(), ij = function () { function t() { this.dimension = 0, this.alignment = 0, this.width = 0, this.height = 0, this.depthOrArraySize = 0, this.mipLevels = 0, this.format = 0, this.sampleCount = 1, this.textureFlags = 0, this.flags = 0, this.viewType = 1 } return t.prototype.reset = function () { this.dimension = 0, this.alignment = 0, this.width = 0, this.height = 0, this.depthOrArraySize = 0, this.mipLevels = 0, this.format = 0, this.sampleCount = 1, this.textureFlags = 0, this.flags = 0, this.viewType = 1 }, t }(), nj = function () { function t(t) { void 0 === t && (t = 0), this.residency = t } return t.prototype.reset = function (t) { this.residency = t }, t }(), rj = function () { function t(t, e) { void 0 === t && (t = null), void 0 === e && (e = !1), this.renderWindow = null, this.currentID = 0, this.numBackBuffers = 0, this.generation = 4294967295, this.swapchain = t, this.isDepthStencil = e } return t.prototype.reset = function (t, e) { this.swapchain = t, this.renderWindow = null, this.currentID = 0, this.numBackBuffers = 0, this.generation = 4294967295, this.isDepthStencil = e }, t }(), sj = function () { function t() { this.states = 0 } return t.prototype.reset = function () { this.states = 0 }, t }(), aj = function () { function t(t) { void 0 === t && (t = null), this.fenceValue = 0, this.buffer = t } return t.prototype.reset = function (t) { this.buffer = t, this.fenceValue = 0 }, t }(), oj = function () { function t(t) { void 0 === t && (t = null), this.fenceValue = 0, this.buffer = t } return t.prototype.reset = function (t) { this.buffer = t, this.fenceValue = 0 }, t }(), uj = function () { function t(t) { void 0 === t && (t = null), this.fenceValue = 0, this.texture = t } return t.prototype.reset = function (t) { this.texture = t, this.fenceValue = 0 }, t }(), hj = function () { function t(t) { void 0 === t && (t = null), this.fenceValue = 0, this.texture = t } return t.prototype.reset = function (t) { this.texture = t, this.fenceValue = 0 }, t }(), cj = function () { function t() { this.unused = 0 } return t.prototype.reset = function () { this.unused = 0 }, t }(), lj = function () { function t() { this.rasterViews = new Map, this.computeViews = new Map, this.resolvePairs = [] } return t.prototype.reset = function () { this.rasterViews.clear(), this.computeViews.clear(), this.resolvePairs.length = 0 }, t }(), fj = function () { this.o = [], this.i = [] }, dj = function () { function t() { this.N = 4294967295, this.x = [], this._names = [], this._subpasses = [] } var e = t.prototype; return e.edge = function (t, e) { for (var i, n = p(this.x[t].o); !(i = n()).done;)if (e === i.value.target) return !0; return !1 }, e.source = function (t) { return t.source }, e.target = function (t) { return t.target }, e.oe = function (t) { return new zW(this.x[t].o.values(), t) }, e.od = function (t) { return this.x[t].o.length }, e.ie = function (t) { return new UW(this.x[t].i.values(), t) }, e.id = function (t) { return this.x[t].i.length }, e.d = function (t) { return this.od(t) + this.id(t) }, e.adj = function (t) { return new VW(this, this.oe(t)) }, e.v = function () { return this.x.keys() }, e.nv = function () { return this.x.length }, e.ne = function () { for (var t, e = 0, i = p(this.v()); !(t = i()).done;) { var n = t.value; e += this.od(n) } return e }, e.clear = function () { this._names.length = 0, this._subpasses.length = 0, this.x.length = 0 }, e.addVertex = function (t, e) { var i = new fj, n = this.x.length; return this.x.push(i), this._names.push(t), this._subpasses.push(e), n }, e.addEdge = function (t, e) { return this.x[t].o.push(new NW(e)), this.x[e].i.push(new NW(t)), new kW(t, e) }, e.vertexName = function (t) { return this._names[t] }, e.getName = function (t) { return this._names[t] }, e.setName = function (t, e) { this._names[t] = e }, e.getSubpass = function (t) { return this._subpasses[t] }, t }(), pj = function () { function t(t, e, i) { void 0 === t && (t = 4294967295), void 0 === e && (e = 1), void 0 === i && (i = 0), this.rasterViews = new Map, this.computeViews = new Map, this.resolvePairs = [], this.viewport = new jd, this.showStatistics = !1, this.subpassID = t, this.count = e, this.quality = i } return t.prototype.reset = function (t, e, i) { this.rasterViews.clear(), this.computeViews.clear(), this.resolvePairs.length = 0, JW(this.viewport), this.subpassID = t, this.count = e, this.quality = i, this.showStatistics = !1 }, t }(), _j = function () { function t(t) { void 0 === t && (t = 4294967295), this.rasterViews = new Map, this.computeViews = new Map, this.subpassID = t } return t.prototype.reset = function (t) { this.rasterViews.clear(), this.computeViews.clear(), this.subpassID = t }, t }(), gj = function () { function t() { this.rasterViews = new Map, this.computeViews = new Map, this.attachmentIndexMap = new Map, this.textures = new Map, this.subpassGraph = new dj, this.width = 0, this.height = 0, this.count = 1, this.quality = 0, this.viewport = new jd, this.versionName = "", this.version = 0, this.hashValue = 0, this.showStatistics = !1 } return t.prototype.reset = function () { this.rasterViews.clear(), this.computeViews.clear(), this.attachmentIndexMap.clear(), this.textures.clear(), this.subpassGraph.clear(), this.width = 0, this.height = 0, this.count = 1, this.quality = 0, JW(this.viewport), this.versionName = "", this.version = 0, this.hashValue = 0, this.showStatistics = !1 }, t }(), mj = function () { function t(t, e) { void 0 === t && (t = null), void 0 === e && (e = null), this.clearColors = [], this.clearDepth = 0, this.clearStencil = 0, this.renderPass = t, this.framebuffer = e } return t.prototype.reset = function (t, e) { this.renderPass = t, this.framebuffer = e, this.clearColors.length = 0, this.clearDepth = 0, this.clearStencil = 0 }, t }(), vj = function () { function t() { this.format = 0 } return t.prototype.reset = function () { this.format = 0 }, t }(), yj = function () { function t() { this.textureView = null, this.format = 0, this.indexOrFirstMipLevel = 0, this.numMipLevels = 0, this.firstArraySlice = 0, this.numArraySlices = 0, this.firstPlane = 0, this.numPlanes = 0 } return t.prototype.reset = function () { this.textureView = null, this.format = 0, this.indexOrFirstMipLevel = 0, this.numMipLevels = 0, this.firstArraySlice = 0, this.numArraySlices = 0, this.firstPlane = 0, this.numPlanes = 0 }, t }(), bj = function (t, e) { this.o = [], this.i = [], this.t = void 0, this.j = void 0, this.id = t, this.object = e, this.t = t, this.j = e }, wj = function () { function t() { this.N = 4294967295, this.x = [], this._names = [], this._descs = [], this._traits = [], this._states = [], this._samplerInfo = [], this._valueIndex = new Map, this.renderPasses = new Map, this.nextFenceValue = 0, this.version = 0 } var e = t.prototype; return e.edge = function (t, e) { for (var i, n = p(this.x[t].o); !(i = n()).done;)if (e === i.value.target) return !0; return !1 }, e.source = function (t) { return t.source }, e.target = function (t) { return t.target }, e.oe = function (t) { return new zW(this.x[t].o.values(), t) }, e.od = function (t) { return this.x[t].o.length }, e.ie = function (t) { return new UW(this.x[t].i.values(), t) }, e.id = function (t) { return this.x[t].i.length }, e.d = function (t) { return this.od(t) + this.id(t) }, e.adj = function (t) { return new VW(this, this.oe(t)) }, e.v = function () { return this.x.keys() }, e.nv = function () { return this.x.length }, e.ne = function () { for (var t, e = 0, i = p(this.v()); !(t = i()).done;) { var n = t.value; e += this.od(n) } return e }, e.clear = function () { this.renderPasses.clear(), this.nextFenceValue = 0, this.version = 0, this._valueIndex.clear(), this._names.length = 0, this._descs.length = 0, this._traits.length = 0, this._states.length = 0, this._samplerInfo.length = 0, this.x.length = 0 }, e.addVertex = function (t, e, i, n, r, s, a, o) { void 0 === o && (o = 4294967295); var u = new bj(t, e), h = this.x.length; return this.x.push(u), this._names.push(i), this._descs.push(n), this._traits.push(r), this._states.push(s), this._samplerInfo.push(a), this._valueIndex.set(i, h), 4294967295 !== o && this.addEdge(o, h), h }, e.addEdge = function (t, e) { return this.x[t].o.push(new NW(e)), this.x[e].i.push(new NW(t)), new kW(t, e) }, e.vertexName = function (t) { return this._names[t] }, e.getName = function (t) { return this._names[t] }, e.setName = function (t, e) { this._names[t] = e }, e.getDesc = function (t) { return this._descs[t] }, e.getTraits = function (t) { return this._traits[t] }, e.getStates = function (t) { return this._states[t] }, e.getSampler = function (t) { return this._samplerInfo[t] }, e.h = function (t, e) { return this.x[e].t === t }, e.w = function (t) { return this.x[t].t }, e.object = function (t) { return this.x[t].j }, e.value = function (t, e) { if (this.x[e].t === t) return this.x[e].j; throw Error("value id not match") }, e.visitVertex = function (t, e) { var i = this.x[e]; switch (i.t) { case 0: return t.managed(i.j); case 1: return t.managedBuffer(i.j); case 2: return t.managedTexture(i.j); case 3: return t.persistentBuffer(i.j); case 4: return t.persistentTexture(i.j); case 5: return t.framebuffer(i.j); case 6: return t.swapchain(i.j); case 7: return t.formatView(i.j); case 8: return t.subresourceView(i.j); default: throw Error("polymorphic type not found") } }, e.j = function (t) { return this.x[t].j }, e.reference = function (t, e) { for (var i, n = p(this.x[t].o); !(i = n()).done;)if (e === i.value.target) return !0; return !1 }, e.parent = function (t) { return t.source }, e.child = function (t) { return t.target }, e.children = function (t) { return new zW(this.x[t].o.values(), t) }, e.numChildren = function (t) { return this.x[t].o.length }, e.getParent = function (t) { if (4294967295 === t) return 4294967295; var e = this.x[t].i; return 0 === e.length ? 4294967295 : e[0].target }, e.addReference = function (t, e) { return this.addEdge(t, e) }, e.contains = function (t) { return this._valueIndex.has(t) }, e.vertex = function (t) { return this._valueIndex.get(t) }, e.find = function (t) { var e = this._valueIndex.get(t); return void 0 === e ? 4294967295 : e }, t }(), xj = function () { function t() { this.computeViews = new Map, this.textures = new Map } return t.prototype.reset = function () { this.computeViews.clear(), this.textures.clear() }, t }(), Sj = function () { function t() { this.resolvePairs = [] } return t.prototype.reset = function () { this.resolvePairs.length = 0 }, t }(), Tj = function () { function t() { this.copyPairs = [], this.uploadPairs = [] } return t.prototype.reset = function () { this.copyPairs.length = 0, this.uploadPairs.length = 0 }, t }(), Ij = function () { function t() { this.movePairs = [] } return t.prototype.reset = function () { this.movePairs.length = 0 }, t }(), Ej = function () { function t() { this.computeViews = new Map } return t.prototype.reset = function () { this.computeViews.clear() }, t }(), Aj = function () { function t(t, e, i) { void 0 === t && (t = ""), void 0 === e && (e = 7), void 0 === i && (i = new Xd), this.slotName = t, this.clearFlags = e, this.clearColor = i } return t.prototype.reset = function (t, e) { this.slotName = t, this.clearFlags = e, ZW(this.clearColor) }, t }(), Cj = function () { function t(t, e, i) { void 0 === t && (t = 1), void 0 === e && (e = 4294967295), void 0 === i && (i = 4294967295), this.viewport = null, this.hint = t, this.phaseID = e, this.passLayoutID = i } return t.prototype.reset = function (t, e, i) { this.hint = t, this.phaseID = e, this.passLayoutID = i, this.viewport = null }, t }(), Dj = function () { function t(t, e, i, n, r, s) { void 0 === t && (t = null), void 0 === e && (e = null), void 0 === i && (i = 0), void 0 === n && (n = new EW), void 0 === r && (r = 1), void 0 === s && (s = null), this.scene = t, this.camera = e, this.light = n, this.flags = i, this.cullingFlags = r, this.shadingLight = s } return t.prototype.reset = function (t, e, i, n, r) { this.scene = t, this.camera = e, this.light.reset(null, 0, !1, null), this.flags = i, this.cullingFlags = n, this.shadingLight = r }, t }(), Rj = function () { function t(t, e, i, n, r) { void 0 === t && (t = null), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 0), void 0 === r && (r = 0), this.material = t, this.passID = e, this.threadGroupCountX = i, this.threadGroupCountY = n, this.threadGroupCountZ = r } return t.prototype.reset = function (t, e, i, n, r) { this.material = t, this.passID = e, this.threadGroupCountX = i, this.threadGroupCountY = n, this.threadGroupCountZ = r }, t }(), Pj = function () { function t(t, e, i, n) { void 0 === t && (t = null), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = null), this.material = t, this.passID = e, this.sceneFlags = i, this.camera = n } return t.prototype.reset = function (t, e, i, n) { this.material = t, this.passID = e, this.sceneFlags = i, this.camera = n }, t }(), Bj = function () { function t() { this.constants = new Map, this.buffers = new Map, this.textures = new Map, this.samplers = new Map, this.custom = "" } return t.prototype.reset = function () { this.constants.clear(), this.buffers.clear(), this.textures.clear(), this.samplers.clear(), this.custom = "" }, t }(), Mj = function (t, e) { this.o = [], this.i = [], this.c = [], this.p = [], this.t = void 0, this.j = void 0, this.id = t, this.object = e, this.t = t, this.j = e }, Oj = function () { function t() { this.N = 4294967295, this.x = [], this._names = [], this._layoutNodes = [], this._data = [], this._valid = [], this.index = new Map, this.sortedVertices = [] } var e = t.prototype; return e.edge = function (t, e) { for (var i, n = p(this.x[t].o); !(i = n()).done;)if (e === i.value.target) return !0; return !1 }, e.source = function (t) { return t.source }, e.target = function (t) { return t.target }, e.oe = function (t) { return new zW(this.x[t].o.values(), t) }, e.od = function (t) { return this.x[t].o.length }, e.ie = function (t) { return new UW(this.x[t].i.values(), t) }, e.id = function (t) { return this.x[t].i.length }, e.d = function (t) { return this.od(t) + this.id(t) }, e.adj = function (t) { return new VW(this, this.oe(t)) }, e.v = function () { return this.x.keys() }, e.nv = function () { return this.x.length }, e.ne = function () { for (var t, e = 0, i = p(this.v()); !(t = i()).done;) { var n = t.value; e += this.od(n) } return e }, e.clear = function () { this.index.clear(), this.sortedVertices.length = 0, this._names.length = 0, this._layoutNodes.length = 0, this._data.length = 0, this._valid.length = 0, this.x.length = 0 }, e.addVertex = function (t, e, i, n, r, s, a) { void 0 === a && (a = 4294967295); var o = new Mj(t, e), u = this.x.length; return this.x.push(o), this._names.push(i), this._layoutNodes.push(n), this._data.push(r), this._valid.push(s), 4294967295 !== a && (this.x[a].c.push(new NW(u)), o.p.push(new NW(a))), u }, e.addEdge = function (t, e) { return this.x[t].o.push(new NW(e)), this.x[e].i.push(new NW(t)), new kW(t, e) }, e.vertexName = function (t) { return this._names[t] }, e.getName = function (t) { return this._names[t] }, e.setName = function (t, e) { this._names[t] = e }, e.getLayout = function (t) { return this._layoutNodes[t] }, e.setLayout = function (t, e) { this._layoutNodes[t] = e }, e.getData = function (t) { return this._data[t] }, e.getValid = function (t) { return this._valid[t] }, e.setValid = function (t, e) { this._valid[t] = e }, e.h = function (t, e) { return this.x[e].t === t }, e.w = function (t) { return this.x[t].t }, e.object = function (t) { return this.x[t].j }, e.value = function (t, e) { if (this.x[e].t === t) return this.x[e].j; throw Error("value id not match") }, e.visitVertex = function (t, e) { var i = this.x[e]; switch (i.t) { case 0: return t.rasterPass(i.j); case 1: return t.rasterSubpass(i.j); case 2: return t.computeSubpass(i.j); case 3: return t.compute(i.j); case 4: return t.resolve(i.j); case 5: return t.copy(i.j); case 6: return t.move(i.j); case 7: return t.raytrace(i.j); case 8: return t.queue(i.j); case 9: return t.scene(i.j); case 10: return t.blit(i.j); case 11: return t.dispatch(i.j); case 12: return t.clear(i.j); case 13: return t.viewport(i.j); default: throw Error("polymorphic type not found") } }, e.j = function (t) { return this.x[t].j }, e.reference = function (t, e) { for (var i, n = p(this.x[t].c); !(i = n()).done;)if (e === i.value.target) return !0; return !1 }, e.parent = function (t) { return t.source }, e.child = function (t) { return t.target }, e.children = function (t) { return new zW(this.x[t].c.values(), t) }, e.numChildren = function (t) { return this.x[t].c.length }, e.getParent = function (t) { if (4294967295 === t) return 4294967295; var e = this.x[t].p; return 0 === e.length ? 4294967295 : e[0].target }, e.addReference = function (t, e) { return this.x[t].c.push(new NW(e)), this.x[e].p.push(new NW(t)), new kW(t, e) }, t }(); function Lj(t) { return new eo((function () { return new t }), 16) } var Fj = function () { function t(t) { this.renderCommon = void 0, this.cv = Lj($W), this.rv = Lj(tj), this.cv1 = Lj(ej), this.rd = Lj(ij), this.rt = Lj(nj), this.rs = Lj(rj), this.rs1 = Lj(sj), this.mb = Lj(aj), this.pb = Lj(oj), this.mt = Lj(uj), this.pt = Lj(hj), this.mr = Lj(cj), this.s = Lj(lj), this.sg = Lj(dj), this.rs2 = Lj(pj), this.cs = Lj(_j), this.rp = Lj(gj), this.prpaf = Lj(mj), this.fv = Lj(vj), this.sv = Lj(yj), this.rg = Lj(wj), this.cp = Lj(xj), this.rp1 = Lj(Sj), this.cp1 = Lj(Tj), this.mp = Lj(Ij), this.rp2 = Lj(Ej), this.cv2 = Lj(Aj), this.rq = Lj(Cj), this.sd = Lj(Dj), this.d = Lj(Rj), this.b = Lj(Pj), this.rd1 = Lj(Bj), this.rg1 = Lj(Oj), this.renderCommon = t } var e = t.prototype; return e.reset = function () { this.cv.reset(), this.rv.reset(), this.cv1.reset(), this.rd.reset(), this.rt.reset(), this.rs.reset(), this.rs1.reset(), this.mb.reset(), this.pb.reset(), this.mt.reset(), this.pt.reset(), this.mr.reset(), this.s.reset(), this.sg.reset(), this.rs2.reset(), this.cs.reset(), this.rp.reset(), this.prpaf.reset(), this.fv.reset(), this.sv.reset(), this.rg.reset(), this.cp.reset(), this.rp1.reset(), this.cp1.reset(), this.mp.reset(), this.rp2.reset(), this.cv2.reset(), this.rq.reset(), this.sd.reset(), this.d.reset(), this.b.reset(), this.rd1.reset(), this.rg1.reset() }, e.createClearValue = function (t, e, i, n) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 0); var r = this.cv.add(); return r.reset(t, e, i, n), r }, e.createRasterView = function (t, e, i, n, r, s, a) { void 0 === t && (t = ""), void 0 === e && (e = 2), void 0 === i && (i = 0), void 0 === n && (n = 0), void 0 === r && (r = 0), void 0 === s && (s = 7), void 0 === a && (a = 0); var o = this.rv.add(); return o.reset(t, e, i, n, r, s, a), o }, e.createComputeView = function (t, e, i, n, r) { void 0 === t && (t = ""), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 0), void 0 === r && (r = 0); var s = this.cv1.add(); return s.reset(t, e, i, n, r), s }, e.createResourceDesc = function () { var t = this.rd.add(); return t.reset(), t }, e.createResourceTraits = function (t) { void 0 === t && (t = 0); var e = this.rt.add(); return e.reset(t), e }, e.createRenderSwapchain = function (t, e) { void 0 === t && (t = null), void 0 === e && (e = !1); var i = this.rs.add(); return i.reset(t, e), i }, e.createResourceStates = function () { var t = this.rs1.add(); return t.reset(), t }, e.createManagedBuffer = function (t) { void 0 === t && (t = null); var e = this.mb.add(); return e.reset(t), e }, e.createPersistentBuffer = function (t) { void 0 === t && (t = null); var e = this.pb.add(); return e.reset(t), e }, e.createManagedTexture = function (t) { void 0 === t && (t = null); var e = this.mt.add(); return e.reset(t), e }, e.createPersistentTexture = function (t) { void 0 === t && (t = null); var e = this.pt.add(); return e.reset(t), e }, e.createManagedResource = function () { var t = this.mr.add(); return t.reset(), t }, e.createSubpass = function () { var t = this.s.add(); return t.reset(), t }, e.createSubpassGraph = function () { var t = this.sg.add(); return t.clear(), t }, e.createRasterSubpass = function (t, e, i) { void 0 === t && (t = 4294967295), void 0 === e && (e = 1), void 0 === i && (i = 0); var n = this.rs2.add(); return n.reset(t, e, i), n }, e.createComputeSubpass = function (t) { void 0 === t && (t = 4294967295); var e = this.cs.add(); return e.reset(t), e }, e.createRasterPass = function () { var t = this.rp.add(); return t.reset(), t }, e.createPersistentRenderPassAndFramebuffer = function (t, e) { void 0 === t && (t = null), void 0 === e && (e = null); var i = this.prpaf.add(); return i.reset(t, e), i }, e.createFormatView = function () { var t = this.fv.add(); return t.reset(), t }, e.createSubresourceView = function () { var t = this.sv.add(); return t.reset(), t }, e.createResourceGraph = function () { var t = this.rg.add(); return t.clear(), t }, e.createComputePass = function () { var t = this.cp.add(); return t.reset(), t }, e.createResolvePass = function () { var t = this.rp1.add(); return t.reset(), t }, e.createCopyPass = function () { var t = this.cp1.add(); return t.reset(), t }, e.createMovePass = function () { var t = this.mp.add(); return t.reset(), t }, e.createRaytracePass = function () { var t = this.rp2.add(); return t.reset(), t }, e.createClearView = function (t, e) { void 0 === t && (t = ""), void 0 === e && (e = 7); var i = this.cv2.add(); return i.reset(t, e), i }, e.createRenderQueue = function (t, e, i) { void 0 === t && (t = 1), void 0 === e && (e = 4294967295), void 0 === i && (i = 4294967295); var n = this.rq.add(); return n.reset(t, e, i), n }, e.createSceneData = function (t, e, i, n, r) { void 0 === t && (t = null), void 0 === e && (e = null), void 0 === i && (i = 0), void 0 === n && (n = 1), void 0 === r && (r = null); var s = this.sd.add(); return s.reset(t, e, i, n, r), s }, e.createDispatch = function (t, e, i, n, r) { void 0 === t && (t = null), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 0), void 0 === r && (r = 0); var s = this.d.add(); return s.reset(t, e, i, n, r), s }, e.createBlit = function (t, e, i, n) { void 0 === t && (t = null), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = null); var r = this.b.add(); return r.reset(t, e, i, n), r }, e.createRenderData = function () { var t = this.rd1.add(); return t.reset(), t }, e.createRenderGraph = function () { var t = this.rg1.add(); return t.clear(), t }, t }(), kj = function () { this.subpass = 0 }; function Nj(t, e) { e.name = t.s(), e.type = t.n(), e.count = t.n() } function zj(t, e) { var i; e.set = t.n(), e.binding = t.n(), e.name = t.s(), i = t.n(), e.members.length = i; for (var n = 0; n !== i; ++n) { var r = new sp; Nj(t, r), e.members[n] = r } e.count = t.n() } function Uj(t, e) { e.binding = t.n(), e.descriptorType = t.n(), e.count = t.n(), e.stageFlags = t.n() } function Vj(t, e) { var i = t.n(); e.bindings.length = i; for (var n = 0; n !== i; ++n) { var r = new Ap; Uj(t, r), e.bindings[n] = r } } var Gj = function () { }; Gj.type = 0, Gj.isWebGPU = !1; var Hj = function () { function t(t, e, i) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 1), this.descriptorID = t, this.type = e, this.count = i } return t.prototype.reset = function (t, e, i) { this.descriptorID = t, this.type = e, this.count = i }, t }(), Wj = function () { function t(t, e, i, n, r, s, a) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 1), void 0 === r && (r = 0), void 0 === s && (s = 0), void 0 === a && (a = 0), this.offset = 0, this.descriptors = [], this.type = t, this.visibility = e, this.capacity = i, this.accessType = n, this.viewDimension = r, this.sampleType = s, this.format = a } return t.prototype.reset = function (t, e, i, n, r, s, a) { this.type = t, this.visibility = e, this.offset = 0, this.capacity = i, this.accessType = n, this.viewDimension = r, this.sampleType = s, this.format = a, this.descriptors.length = 0 }, t }(), jj = function () { function t(t, e, i, n, r) { void 0 === t && (t = 4294967295), void 0 === e && (e = 0), void 0 === i && (i = []), void 0 === n && (n = new Map), void 0 === r && (r = new Map), this.uniformBlockCapacity = 0, this.samplerTextureCapacity = 0, this.slot = t, this.capacity = e, this.descriptorBlocks = i, this.uniformBlocks = n, this.bindingMap = r } return t.prototype.reset = function (t, e) { this.slot = t, this.capacity = e, this.uniformBlockCapacity = 0, this.samplerTextureCapacity = 0, this.descriptorBlocks.length = 0, this.uniformBlocks.clear(), this.bindingMap.clear() }, t }(), Xj = function () { function t(t, e, i) { void 0 === t && (t = new jj), void 0 === e && (e = null), void 0 === i && (i = null), this.descriptorSetLayoutInfo = new Cp, this.descriptorSetLayoutData = t, this.descriptorSetLayout = e, this.descriptorSet = i } return t.prototype.reset = function (t, e) { this.descriptorSetLayoutData.reset(4294967295, 0), this.descriptorSetLayoutInfo.bindings.length = 0, this.descriptorSetLayout = t, this.descriptorSet = e }, t }(), qj = function () { function t() { this.descriptorSets = new Map, this.descriptorGroups = new Map } var e = t.prototype; return e.reset = function () { this.descriptorSets.clear(), this.descriptorGroups.clear() }, e.getSets = function () { return Gj.isWebGPU ? this.descriptorGroups : this.descriptorSets }, e.getSet = function (t) { return Gj.isWebGPU ? this.descriptorGroups.get(t) : this.descriptorSets.get(t) }, t }(), Yj = function () { function t() { this.descriptorBindings = new Map } return t.prototype.reset = function () { this.descriptorBindings.clear() }, t }(), Kj = function () { function t() { this.layoutData = new Map, this.bindingData = new Map } return t.prototype.reset = function () { this.layoutData.clear(), this.bindingData.clear() }, t }(), Qj = function () { function t() { this.passes = [] } return t.prototype.reset = function () { this.passes.length = 0 }, t }(), Zj = function () { function t() { this.techniques = new Map } return t.prototype.reset = function () { this.techniques.clear() }, t }(), Jj = function () { function t() { this.layout = new qj, this.pipelineLayout = null } return t.prototype.reset = function () { this.layout.reset(), this.pipelineLayout = null }, t }(), $j = function () { function t() { this.descriptorVisibility = new Map } return t.prototype.reset = function () { this.descriptorVisibility.clear() }, t }(), tX = function () { function t() { this.rootSignature = "", this.shaderPrograms = [], this.shaderIndex = new Map, this.pipelineLayout = null } return t.prototype.reset = function () { this.rootSignature = "", this.shaderPrograms.length = 0, this.shaderIndex.clear(), this.pipelineLayout = null }, t }(), eX = function (t, e) { this.o = [], this.i = [], this.t = void 0, this.j = void 0, this.id = t, this.object = e, this.t = t, this.j = e }, iX = function () { function t() { this.N = 4294967295, this.x = [], this._names = [], this._updateFrequencies = [], this._layouts = [], this.valueNames = [], this.attributeIndex = new Map, this.constantIndex = new Map, this.shaderLayoutIndex = new Map, this.effects = new Map, this.constantMacros = "" } var e = t.prototype; return e.edge = function (t, e) { for (var i, n = p(this.x[t].o); !(i = n()).done;)if (e === i.value.target) return !0; return !1 }, e.source = function (t) { return t.source }, e.target = function (t) { return t.target }, e.oe = function (t) { return new zW(this.x[t].o.values(), t) }, e.od = function (t) { return this.x[t].o.length }, e.ie = function (t) { return new UW(this.x[t].i.values(), t) }, e.id = function (t) { return this.x[t].i.length }, e.d = function (t) { return this.od(t) + this.id(t) }, e.adj = function (t) { return new VW(this, this.oe(t)) }, e.v = function () { return this.x.keys() }, e.nv = function () { return this.x.length }, e.ne = function () { for (var t, e = 0, i = p(this.v()); !(t = i()).done;) { var n = t.value; e += this.od(n) } return e }, e.clear = function () { this.valueNames.length = 0, this.attributeIndex.clear(), this.constantIndex.clear(), this.shaderLayoutIndex.clear(), this.effects.clear(), this.constantMacros = "", this._names.length = 0, this._updateFrequencies.length = 0, this._layouts.length = 0, this.x.length = 0 }, e.addVertex = function (t, e, i, n, r, s) { void 0 === s && (s = 4294967295); var a = new eX(t, e), o = this.x.length; return this.x.push(a), this._names.push(i), this._updateFrequencies.push(n), this._layouts.push(r), 4294967295 !== s && this.addEdge(s, o), o }, e.addEdge = function (t, e) { return this.x[t].o.push(new NW(e)), this.x[e].i.push(new NW(t)), new kW(t, e) }, e.vertexName = function (t) { return this._names[t] }, e.getName = function (t) { return this._names[t] }, e.getUpdate = function (t) { return this._updateFrequencies[t] }, e.setUpdate = function (t, e) { this._updateFrequencies[t] = e }, e.getLayout = function (t) { return this._layouts[t] }, e.h = function (t, e) { return this.x[e].t === t }, e.w = function (t) { return this.x[t].t }, e.object = function (t) { return this.x[t].j }, e.value = function (t, e) { if (this.x[e].t === t) return this.x[e].j; throw Error("value id not match") }, e.visitVertex = function (t, e) { var i = this.x[e]; switch (i.t) { case 0: return t.renderStage(i.j); case 1: return t.renderPhase(i.j); default: throw Error("polymorphic type not found") } }, e.j = function (t) { return this.x[t].j }, e.reference = function (t, e) { for (var i, n = p(this.x[t].o); !(i = n()).done;)if (e === i.value.target) return !0; return !1 }, e.parent = function (t) { return t.source }, e.child = function (t) { return t.target }, e.children = function (t) { return new zW(this.x[t].o.values(), t) }, e.numChildren = function (t) { return this.x[t].o.length }, e.getParent = function (t) { if (4294967295 === t) return 4294967295; var e = this.x[t].i; return 0 === e.length ? 4294967295 : e[0].target }, e.addReference = function (t, e) { return this.addEdge(t, e) }, e.locateChild = function (t, e) { if (4294967295 === t) { for (var i, n = p(this.x.keys()); !(i = n()).done;) { var r = i.value; if (0 === this.x[r].i.length && this._names[r] === e) return r } return 4294967295 } for (var s, a = p(this.x[t].o); !(s = a()).done;) { var o = s.value.target; if (e === this._names[o]) return o } return 4294967295 }, e.locate = function (t) { return HW(this, 4294967295, t) }, e.locateRelative = function (t, e) { return void 0 === e && (e = 4294967295), HW(this, e, t) }, e.path = function (t) { return GW(this, t) }, t }(); function nX(t, e) { e.descriptorID = t.n(), e.type = t.n(), e.count = t.n() } function rX(t, e) { var i; e.type = t.n(), e.visibility = t.n(), e.offset = t.n(), e.capacity = t.n(), e.accessType = t.n(), e.viewDimension = t.n(), e.sampleType = t.n(), e.format = t.n(), i = t.n(), e.descriptors.length = i; for (var n = 0; n !== i; ++n) { var r = new Hj; nX(t, r), e.descriptors[n] = r } } function sX(t, e) { e.slot = t.n(), e.capacity = t.n(), e.uniformBlockCapacity = t.n(), e.samplerTextureCapacity = t.n(); var i = 0; i = t.n(), e.descriptorBlocks.length = i; for (var n = 0; n !== i; ++n) { var r = new Wj; rX(t, r), e.descriptorBlocks[n] = r } i = t.n(); for (var s = 0; s !== i; ++s) { var a = t.n(), o = new ap; zj(t, o), e.uniformBlocks.set(a, o) } i = t.n(); for (var u = 0; u !== i; ++u) { var h = t.n(), c = t.n(); e.bindingMap.set(h, c) } } function aX(t, e) { sX(t, e.descriptorSetLayoutData), Vj(t, e.descriptorSetLayoutInfo) } function oX(t, e) { var i = 0; i = t.n(); for (var n = 0; n !== i; ++n) { var r = t.n(), s = new Xj; aX(t, s), e.descriptorSets.set(r, s) } i = t.n(); for (var a = 0; a !== i; ++a) { var o = t.n(), u = new Xj; aX(t, u), e.descriptorGroups.set(o, u) } } function uX(t, e) { var i; i = t.n(); for (var n = 0; n !== i; ++n) { var r = t.n(), s = t.n(); e.descriptorBindings.set(r, s) } } function hX(t, e) { var i = 0; i = t.n(); for (var n = 0; n !== i; ++n) { var r = t.n(), s = new jj; sX(t, s), e.layoutData.set(r, s) } i = t.n(); for (var a = 0; a !== i; ++a) { var o = t.n(), u = new Yj; uX(t, u), e.bindingData.set(o, u) } } function cX(t, e) { var i; i = t.n(), e.passes.length = i; for (var n = 0; n !== i; ++n) { var r = new Kj; hX(t, r), e.passes[n] = r } } function lX(t, e) { var i; i = t.n(); for (var n = 0; n !== i; ++n) { var r = t.s(), s = new Qj; cX(t, s), e.techniques.set(r, s) } } function fX(t, e) { oX(t, e.layout) } function dX(t, e) { var i; i = t.n(); for (var n = 0; n !== i; ++n) { var r = t.n(), s = t.n(); e.descriptorVisibility.set(r, s) } } function pX(t, e) { e.rootSignature = t.s(); var i = 0; i = t.n(), e.shaderPrograms.length = i; for (var n = 0; n !== i; ++n) { var r = new Jj; fX(t, r), e.shaderPrograms[n] = r } i = t.n(); for (var s = 0; s !== i; ++s) { var a = t.s(), o = t.n(); e.shaderIndex.set(a, o) } } function _X(t, e) { var i = t.n(); t.n(), t.n(), t.n(); for (var n = 0; n !== i; ++n) { var r = t.n(), s = t.n(), a = t.s(), o = t.n(), u = new qj; switch (oX(t, u), r) { case 0: var h = new $j; dX(t, h), e.addVertex(0, h, a, o, u, s); break; case 1: var c = new tX; pX(t, c), e.addVertex(1, c, a, o, u, s) } } var l = 0; l = t.n(), e.valueNames.length = l; for (var f = 0; f !== l; ++f)e.valueNames[f] = t.s(); l = t.n(); for (var d = 0; d !== l; ++d) { var p = t.s(), _ = t.n(); e.attributeIndex.set(p, _) } l = t.n(); for (var g = 0; g !== l; ++g) { var m = t.s(), v = t.n(); e.constantIndex.set(m, v) } l = t.n(); for (var y = 0; y !== l; ++y) { var b = t.s(), w = t.n(); e.shaderLayoutIndex.set(b, w) } l = t.n(); for (var x = 0; x !== l; ++x) { var S = t.s(), T = new Zj; lX(t, T), e.effects.set(S, T) } } var gX = function () { function t(t) { this.colors = void 0, this.colors = new Array(t) } var e = t.prototype; return e.get = function (t) { return this.colors[t] }, e.put = function (t, e) { this.colors[t] = e }, t }(); function mX(t) { switch (t) { case 1: case 5: case 9: case 13: return 1; case 6: case 14: case 10: case 2: return 2; case 15: case 3: case 11: case 7: return 3; case 4: case 16: case 12: case 8: case 17: return 4; case 18: case 20: return 6; case 19: case 23: return 8; case 21: return 9; case 22: case 24: return 12; case 25: return 16; default: return 0 } } function vX(t, e) { var i = 1; return 1 & t || 0 !== e || (i = 8 & t ? 1 : 0), 6 & ~t && 1 === e && (2 & t || (i = 0), 4 & t || (i = 0)), i } function yX(t, e, i, n, r, s) { void 0 === n && (n = null), void 0 === r && (r = 0), void 0 === s && (s = void 0), s = s || new Nd; var a = t ? t.viewport : new Nd(0, 0, 1, 1), o = e, u = i; if (s.x = a.x * o, s.y = a.y * u, s.width = a.width * o, s.height = a.height * u, n) switch (n.type) { case 0: var h = n; if (h.shadowFixedArea || h.csmLevel === bT.LEVEL_1) s.x = 0, s.y = 0, s.width = o, s.height = u; else { var c = S.director.root.device.capabilities.screenSpaceSignY; s.x = r % 2 * .5 * o, s.y = c > 0 ? .5 * (1 - Math.floor(r / 2)) * u : .5 * Math.floor(r / 2) * u, s.width = .5 * o, s.height = .5 * u } break; case 2: s.x = 0, s.y = 0, s.width = o, s.height = u }return s } function bX(t, e, i, n, r) { var s = "Camera" + r, a = i.renderArea(), o = a.x, u = a.y, h = i.camera, c = "reflectionProbePassColor" + s, l = "reflectionProbePassDS" + s; e.containsResource(c) || (e.addRenderWindow(c, 35, o, u, n), e.addDepthStencil(l, 55, o, u, 3)), e.updateRenderWindow(c, n), e.updateDepthStencil(l, o, u); var f = e.addRenderPass(o, u, "default"); f.name = "ReflectionProbePass" + r, f.setViewport(new jd(0, 0, o, u)), f.addRenderTarget(c, vX(h.clearFlag, 0), 0, new Xd(h.clearColor.x, h.clearColor.y, h.clearColor.z, h.clearColor.w)), f.addDepthStencil(l, vX(h.clearFlag, 1), 0, h.clearDepth, h.clearStencil, h.clearFlag); var d = f.addQueue(1, "reflect-map"), p = new EW; p.probe = i, d.addSceneOfCamera(t, p, 8193), wX(d, h, e) } function wX(t, e, i) { var n = S.director.root.pipeline, r = i.pipelineSceneData, s = r.skybox; t.setMat4("cc_matView", e.matView), t.setMat4("cc_matViewInv", e.node.worldMatrix), t.setMat4("cc_matProj", e.matProj), t.setMat4("cc_matProjInv", e.matProjInv), t.setMat4("cc_matViewProj", e.matViewProj), t.setMat4("cc_matViewProjInv", e.matViewProjInv), t.setVec4("cc_cameraPos", new Pn(e.position.x, e.position.y, e.position.z, n.getCombineSignY())), t.setVec4("cc_surfaceTransform", new Pn(e.surfaceTransform, 0, Math.cos(Ki(s.getRotationAngle())), Math.sin(Ki(s.getRotationAngle())))), t.setVec4("cc_screenScale", new Pn(r.shadingScale, r.shadingScale, 1 / r.shadingScale, 1 / r.shadingScale)), t.setVec4("cc_exposure", new Pn(e.exposure, 1 / e.exposure, r.isHDR ? 1 : 0, 1 / dR.standardExposureValue)) } function xX(t, e, i) { i instanceof n_ ? t.bindBuffer(e, i) : i instanceof S_ ? t.bindTexture(e, i) : i instanceof w_ && t.bindSampler(e, i) } function SX(t, e, i) { xX(t, e, i) } function TX(t, e) { for (var i, n = p(e.descriptorSetLayoutData.descriptorBlocks); !(i = n()).done;)for (var r = i.value, s = 0; s !== r.descriptors.length; ++s)if (t === r.descriptors[s].descriptorID) return r.offset + s; return -1 } new hu(0, 0, 0, .5, .5, .5), new hu; var IX = function () { function t(t, e) { void 0 === e && (e = 2), this.buffers = [], this.currBuffIdx = 0, this.device = void 0, this.currUniform = void 0, this._root = void 0; var i = (this._root = S.director.root).device; this.device = i, this.currUniform = new Float32Array(t / 4); for (var n = 0; n < e; n++) { var r = new Zd(18, 3, t, t); this.buffers.push(this.device.createBuffer(r)) } } var e = t.prototype; return e.getCurrentBuffer = function () { var t = S.director; return this.currBuffIdx = t.getTotalFrames() % this.buffers.length, this.buffers[this.currBuffIdx] }, e.updateData = function (t) { this.currUniform.set(t) }, e.updateBuffer = function (t, e) { var i = e.descriptorSet, n = this.getCurrentBuffer(); n.update(this.currUniform), SX(i, t, n) }, t }(), EX = new Map, AX = new Map, CX = new Map; function DX(t) { var e = CX.get(t); if (e) return e; var i = S.director.root.pipeline, n = i.layoutGraph.locateChild(i.layoutGraph.N, t), r = i.layoutGraph.getLayout(n).getSet(3); return CX.set(t, r), r } function RX(t, e, i, n) { void 0 === n && (n = "default"), VX(n, e, i, t) } function PX(t, e) { var i = S.director.root.pipeline.layoutGraph, n = i.locateChild(4294967295, e), r = i.getLayout(n).getSet(3).descriptorSetLayoutData, s = i.attributeIndex.get(t); return r.uniformBlocks.get(s) } function BX(t, e, i) { var n = PX(e, i); if (!n) return -1; for (var r, s = 0, a = p(n.members); !(r = a()).done;) { var o = r.value, u = mX(o.type); if (o.name === t) return s; s += u * o.count } return -1 } var MX = new Map, OX = function () { this.offset = -1, this.buffer = [], this.blockId = -1 }, LX = new Map; function FX(t, e, i) { var n = !1; if (i < 0 || i > t.length) return n; for (var r = Math.min(e.length, t.length - i), s = 0; s < r; s++)t[i + s] !== e[s] && (t[i + s] = e[s], n = !0); return n } function kX(t, e) { var i = MX.get(t); if (i) return i; i = [], S.director.root.pipeline.layoutGraph; var n = 0, r = PX(t, e); if (!r) return null; for (var s, a = p(r.members); !(s = a()).done;) { var o = s.value; n += mX(o.type) * o.count } return i.length = n, i.fill(0), MX.set(t, i), i } function NX(t, e) { var i = EX.get(t); i || (EX.set(t, new IX(4 * e.length, 2)), i = EX.get(t)), i.updateData(e) } function zX(t, e, i, n, r) { var s = t.blockId, a = t.buffer, o = FX(a, e, t.offset), u = TX(s, i), h = i.descriptorSet; if (o || !h.getBuffer(u) && -1 !== u) { var c = "" + s + u + r + n; AX.set(c, u), NX(c, a) } } function UX(t, e, i, n, r) { var s = TX(t, r); if (-1 !== s) { var a = "" + t + s + i + e; AX.set(a, s), NX(a, n) } } function VX(t, e, i, n) { var r = n.constants, s = n.samplers, a = n.textures, o = n.buffers, u = S.director.root.pipeline.layoutGraph, h = DX(t); AX.clear(); for (var c, l = function () { var n = c.value, r = n[0], s = n[1], a = LX.get(r); if (a) zX(a, s, h, e, i); else for (var o, l = Array.from(u.constantIndex).find((function (t) { return t[0], t[1] === r }))[0], f = p(u.attributeIndex); !(o = f()).done;) { var d = o.value, _ = d[0], g = d[1], m = kX(_, t); if (m) { var v = BX(l, _, t); -1 !== v ? (LX.set(r, new OX), (a = LX.get(r)).buffer = m, a.blockId = g, a.offset = v, zX(a, s, h, e, i)) : UX(g, e, i, m, h) } } }, f = p(r); !(c = f()).done;)l(); for (var d, _ = h.descriptorSet, g = p(a); !(d = g()).done;) { var m = d.value, v = m[0], y = m[1], b = TX(v, h); if (-1 !== b) { var w = _.getTexture(b); y === w && (w.gpuTexture || w.gpuTextureView && w.gpuTextureView.gpuTexture) || SX(_, b, y) } } for (var x, T = p(s); !(x = T()).done;) { var I = x.value, E = I[0], A = I[1], C = TX(E, h); -1 !== C && _.getSampler(C) !== A && SX(_, C, A) } for (var D, R = p(AX); !(D = R()).done;) { var P = D.value, B = P[0], M = P[1]; EX.get(B).updateBuffer(M, h) } for (var O, L = p(o); !(O = L()).done;) { var F = O.value, k = F[0], N = F[1], z = TX(k, h); -1 !== z && (_.getBuffer(z) || SX(_, z, N)) } } function GX(t) { return t + "-" } function HX(t) { for (var e = 0, i = 0; i < t.length; i++)e = (e << 5) - e + t.charCodeAt(i), e |= 0; return e } function WX(t) { return !!t } function jX(t, e) { return t + (e - 1) & ~(e - 1) } function XX(t, e, i, n, r, s) { var a = new Float32Array(4), o = 0, u = 0, h = 0, c = 0; if (t && 1 === t.type) { var l = t; a[0] = l.position.x, a[1] = l.position.y, a[2] = l.position.z, a[3] = 1, o = l.size, u = l.range, h = l.luminanceHDR, c = l.luminanceLDR } else if (t && 2 === t.type) { var f = t; a[0] = f.position.x, a[1] = f.position.y, a[2] = f.position.z, a[3] = 2, o = f.size, u = f.range, h = f.luminanceHDR, c = f.luminanceLDR } else if (t && 3 === t.type) { var d = t; a[0] = d.position.x, a[1] = d.position.y, a[2] = d.position.z, a[3] = 3, o = 0, u = d.range, h = d.luminanceHDR, c = d.luminanceLDR } else if (t && 4 === t.type) { var p = t; a[0] = p.position.x, a[1] = p.position.y, a[2] = p.position.z, a[3] = 4, o = 0, u = 0, h = p.illuminanceHDR, c = p.illuminanceLDR } var _ = s + 0; r.set(a, _), _ = s + 8, a.set([o, u, 0, 0]), r.set(a, _), _ = s + 4; var g = t ? t.color : new Xd; if (t && t.useColorTemperature) { var m = t.colorTemperatureRGB; r[_++] = g.x * m.x, r[_++] = g.y * m.y, r[_++] = g.z * m.z } else r[_++] = g.x, r[_++] = g.y, r[_++] = g.z; switch (r[_] = e ? h * i * 1e4 : c, t ? t.type : 5) { case 1: case 3: r[s + 8 + 2] = 0, r[s + 8 + 3] = 0; break; case 2: var v = t; r[s + 8 + 2] = v.spotAngle, r[s + 8 + 3] = n && n.enabled && v.shadowEnabled && n.type === vT.ShadowMap ? 1 : 0, _ = s + 12; var y = v.direction; r[_++] = y.x, r[_++] = y.y, r[_] = y.z, r[s + 16 + 0] = 0, r[s + 16 + 1] = 0, r[s + 16 + 2] = 0, r[s + 16 + 3] = v.angleAttenuationStrength; break; case 4: var b = t, w = b.right; r[s + 8 + 0] = w.x, r[s + 8 + 1] = w.y, r[s + 8 + 2] = w.z, r[s + 8 + 3] = 0; var x = b.direction; r[s + 12 + 0] = x.x, r[s + 12 + 1] = x.y, r[s + 12 + 2] = x.z, r[s + 12 + 3] = 0; var S = b.scale; r[s + 16 + 0] = .5 * S.x, r[s + 16 + 1] = .5 * S.y, r[s + 16 + 2] = .5 * S.z, r[s + 16 + 3] = 0 } } function qX(t) { for (var e, i = "", n = p(t.rasterViews); !(e = n()).done;) { var r = e.value, s = r[0], a = r[1]; i += GX(s), i += GX(a.slotName), i += GX(a.accessType), i += GX(a.attachmentType), i += GX(a.loadOp), i += GX(a.storeOp), i += GX(a.clearFlags), i += GX(a.clearColor.x), i += GX(a.clearColor.y), i += GX(a.clearColor.z), i += GX(a.clearColor.w), i += GX(a.slotID), i += GX(a.shaderStageFlags) } for (var o, u = p(t.computeViews); !(o = u()).done;) { var h = o.value, c = h[0], l = h[1]; i += GX(c); for (var f, d = p(l); !(f = d()).done;) { var _ = f.value; i += GX(_.name), i += GX(_.accessType), i += GX(_.clearFlags), i += GX(_.clearValueType), i += GX(_.clearValue.x), i += GX(_.clearValue.y), i += GX(_.clearValue.z), i += GX(_.clearValue.w), i += GX(_.shaderStageFlags) } } i += GX(t.width), i += GX(t.height), i += GX(t.viewport.left), i += GX(t.viewport.top), i += GX(t.viewport.width), i += GX(t.viewport.height), i += GX(t.viewport.minDepth), i += GX(t.viewport.maxDepth), i += GX(t.showStatistics ? 1 : 0), t.hashValue = HX(i) } var YX = new Pn, KX = new Kn, QX = new Xd, ZX = new Gr, JX = new Gr; function $X(t, e) { var i = e.skybox, n = S.director.root, r = n.pipeline; if (i.reflectionMap) { var s = i.reflectionMap.getGFXTexture(), a = n.device.getSampler(i.reflectionMap.getSamplerInfo()); t.setTexture("cc_environment", s), t.setSampler("cc_environment", a) } else { var o = i.envmap ? i.envmap : YS.get("default-cube-texture"); if (o) { var u = o.getGFXTexture(), h = n.device.getSampler(o.getSamplerInfo()); t.setTexture("cc_environment", u), t.setSampler("cc_environment", h) } } var c = i.diffuseMap ? i.diffuseMap : YS.get("default-cube-texture"); if (c) { var l = c.getGFXTexture(), f = n.device.getSampler(c.getSamplerInfo()); t.setTexture("cc_diffuseMap", l), t.setSampler("cc_diffuseMap", f) } t.hasSampler("cc_shadowMap") || t.setSampler("cc_shadowMap", r.defaultSampler), t.hasTexture("cc_shadowMap") || t.setTexture("cc_shadowMap", r.defaultShadowTexture), t.hasSampler("cc_spotShadowMap") || t.setSampler("cc_spotShadowMap", r.defaultSampler), t.hasTexture("cc_spotShadowMap") || t.setTexture("cc_spotShadowMap", r.defaultShadowTexture) } function tq(t, e, i, n) { var r, s = S.director.root.pipeline, a = i.shadows, o = i.skybox, u = i.shadingScale; e && (t.setMat4("cc_matView", e.matView), t.setMat4("cc_matViewInv", e.node.worldMatrix), t.setMat4("cc_matProj", e.matProj), t.setMat4("cc_matProjInv", e.matProjInv), t.setMat4("cc_matViewProj", e.matViewProj), t.setMat4("cc_matViewProjInv", e.matViewProjInv), YX.set(e.surfaceTransform, e.cameraUsage, Math.cos(Ki(o.getRotationAngle())), Math.sin(Ki(o.getRotationAngle()))), t.setVec4("cc_surfaceTransform", YX), YX.set(e.exposure, 1 / e.exposure, i.isHDR ? 1 : 0, 1 / dR.standardExposureValue), t.setVec4("cc_exposure", YX)), e ? YX.set(e.position.x, e.position.y, e.position.z, s.getCombineSignY()) : YX.set(0, 0, 0, s.getCombineSignY()), t.setVec4("cc_cameraPos", YX), YX.set(i.shadingScale, i.shadingScale, 1 / i.shadingScale, 1 / i.shadingScale), t.setVec4("cc_screenScale", YX); var h = n && n.mainLight; if (h) { var c = h.shadowEnabled && a.type === vT.ShadowMap ? 1 : 0; YX.set(h.direction.x, h.direction.y, h.direction.z, c), t.setVec4("cc_mainLitDir", YX); var l = h.color.x, f = h.color.y, d = h.color.z; h.useColorTemperature && (l *= h.colorTemperatureRGB.x, f *= h.colorTemperatureRGB.y, d *= h.colorTemperatureRGB.z); var p = h.illuminance; i.isHDR && e && (p *= e.exposure), YX.set(l, f, d, p), t.setVec4("cc_mainLitColor", YX) } else YX.set(0, 0, 1, 0), t.setVec4("cc_mainLitDir", YX), YX.set(0, 0, 0, 0), t.setVec4("cc_mainLitColor", YX); var _ = i.ambient, g = _.skyColor; i.isHDR ? g.w = _.skyIllum * (e ? e.exposure : 1) : g.w = _.skyIllum, YX.set(g.x, g.y, g.z, g.w), t.setVec4("cc_ambientSky", YX), YX.set(_.groundAlbedo.x, _.groundAlbedo.y, _.groundAlbedo.z, o.envmap ? null == (r = o.envmap) ? void 0 : r.mipmapLevel : 1), t.setVec4("cc_ambientGround", YX); var m = i.fog, v = m.colorArray; YX.set(v.x, v.y, v.z, v.z), t.setVec4("cc_fogColor", YX), YX.set(m.fogStart, m.fogEnd, m.fogDensity, 0), t.setVec4("cc_fogBase", YX), YX.set(m.fogTop, m.fogRange, m.fogAtten, 0), t.setVec4("cc_fogAdd", YX), e && (YX.set(e.nearClip, e.farClip, e.getClipSpaceMinz(), 0), t.setVec4("cc_nearFar", YX), YX.set(e.viewport.x, e.viewport.y, u * e.window.width * e.viewport.z, u * e.window.height * e.viewport.w), t.setVec4("cc_viewPort", YX)) } var eq = function () { function t(t, e, i, n, r, s) { void 0 === t && (t = null), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 0), void 0 === r && (r = 0), void 0 === s && (s = 0), this.subModel = void 0, this.priority = void 0, this.hash = void 0, this.depth = void 0, this.shaderID = void 0, this.passIndex = void 0, this.subModel = t, this.priority = e, this.hash = i, this.depth = n, this.shaderID = r, this.passIndex = s } return t.prototype.update = function (t, e, i, n, r, s) { void 0 === t && (t = null), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 0), void 0 === r && (r = 0), void 0 === s && (s = 0), this.subModel = t, this.priority = e, this.hash = i, this.depth = n, this.shaderID = r, this.passIndex = s }, t }(), iq = new eo((function () { return new eq }), 8), nq = "CC_USE_RGBE_OUTPUT"; function rq(t, e) { for (var i = t.passes, n = 0; n < i.length; n++)if (i[n].phaseID === e) return n; return -1 } var sq = function () { function t() { var t; this.probeMap = new Array, this.defaultId = (t = S.rendering).getPhaseID(t.getPassID("default"), "default") } var e = t.prototype; return e.clear = function () { this.probeMap.length = 0 }, e.applyMacro = function () { for (var t, e = p(this.probeMap); !(t = e()).done;) { var i = t.value, n = [{ name: nq, value: !0 }]; i.patches && (n = n.concat(i.patches)), i.onMacroPatchesStateChanged(n) } }, e.removeMacro = function () { for (var t, e = p(this.probeMap); !(t = e()).done;) { var i = t.value; if (i.patches) { var n = i.patches.filter((function (t) { return t.name !== nq })); 0 === n.length ? i.onMacroPatchesStateChanged(null) : i.onMacroPatchesStateChanged(n) } } }, e.addToProbeQueue = function (t, e) { for (var i = t.subModels, n = 0; n < i.length; n++) { var r = i[n]; if (!r.passes[0].blendState.targets[0].blend) { var s = rq(r, e), a = !0; s < 0 && (s = rq(r, e = this.defaultId), a = !1), s < 0 || a || this.probeMap.push(r) } } }, t }(); function aq(t, e, i, n) { var r = S.director.root.pipeline, s = r.device, a = r.pipelineSceneData, o = a.shadows; if (o.type !== vT.Planar) { var u = a.csmLayers, h = Sw(s) ? 0 : 1, c = r.device.capabilities; switch (o.enabled && o.type === vT.ShadowMap && i && i.node && 0 === i.type && u.update(a, e), i.type) { case 0: var l = i; if (o.enabled && l && l.shadowEnabled && o.type === vT.ShadowMap) { var f, d, p, _ = .1, g = 0, m = 0; if (l.shadowFixedArea || l.csmLevel === bT.LEVEL_1) f = u.specialLayer.matShadowView, d = u.specialLayer.matShadowProj, p = u.specialLayer.matShadowViewProj, l.shadowFixedArea ? (_ = l.shadowNear, g = l.shadowFar, m = 0) : (_ = .1, g = u.specialLayer.shadowCameraFar, m = 1), YX.set(0, h, l.shadowNormalBias, 0), t.setVec4("cc_shadowLPNNInfo", YX); else { var v = u.layers[n]; f = v.matShadowView, d = v.matShadowProj, p = v.matShadowViewProj, _ = v.splitCameraNear, g = v.splitCameraFar, m = l.csmLevel } t.setMat4("cc_matLightView", f), YX.set(d.m10, d.m14, d.m11, d.m15), t.setVec4("cc_shadowProjDepthInfo", YX), YX.set(d.m00, d.m05, 1 / d.m00, 1 / d.m05), t.setVec4("cc_shadowProjInfo", YX), t.setMat4("cc_matLightViewProj", p), YX.set(_, g, 0, 1 - l.shadowSaturation), t.setVec4("cc_shadowNFLSInfo", YX), YX.set(0, h, l.shadowNormalBias, m), t.setVec4("cc_shadowLPNNInfo", YX), YX.set(o.size.x, o.size.y, l.shadowPcf, l.shadowBias), t.setVec4("cc_shadowWHPBInfo", YX) } break; case 2: var y = i; if (o.enabled && y && y.shadowEnabled) { Gr.invert(ZX, y.node.getWorldMatrix()), t.setMat4("cc_matLightView", ZX), Gr.perspective(JX, y.angle, 1, .001, y.range, !0, c.clipSpaceMinZ, c.clipSpaceSignY, 0); var b = JX.clone().invert(), w = JX.clone(); Gr.multiply(ZX, JX, ZX), t.setMat4("cc_matLightViewProj", ZX), YX.set(.01, i.range, 0, 0), t.setVec4("cc_shadowNFLSInfo", YX), YX.set(o.size.x, o.size.y, y.shadowPcf, y.shadowBias), t.setVec4("cc_shadowWHPBInfo", YX), YX.set(2, h, y.shadowNormalBias, 0), t.setVec4("cc_shadowLPNNInfo", YX), YX.set(w.m10, w.m14, w.m11, w.m15), t.setVec4("cc_shadowProjDepthInfo", YX), YX.set(b.m10, b.m14, b.m11, b.m15), t.setVec4("cc_shadowInvProjDepthInfo", YX), YX.set(w.m00, w.m05, 1 / w.m00, 1 / w.m05), t.setVec4("cc_shadowProjInfo", YX) } break; case 1: YX.set(o.size.x, o.size.y, 1, 0), t.setVec4("cc_shadowWHPBInfo", YX), YX.set(1, h, 0, 0), t.setVec4("cc_shadowLPNNInfo", YX); break; case 3: YX.set(o.size.x, o.size.y, 1, 0), t.setVec4("cc_shadowWHPBInfo", YX), YX.set(3, h, 0, 0), t.setVec4("cc_shadowLPNNInfo", YX) }QX.set(o.shadowColor.x, o.shadowColor.y, o.shadowColor.z, o.shadowColor.w), t.setColor("cc_shadowColor", QX) } } function oq(t, e) { var i = t.size.x; switch (e.shadowPcf) { case yT.HARD: return 0; case yT.SOFT: return 1 / (.5 * i); case yT.SOFT_2X: return 2 / (.5 * i); case yT.SOFT_4X: return 3 / (.5 * i) }return 0 } function uq(t, e) { var i = S.director, n = i.root.pipeline, r = n.device, s = i.getScene(), a = e && e.scene ? e.scene.mainLight : s ? s.renderScene.mainLight : null, o = n.pipelineSceneData, u = o.shadows, h = o.csmLayers, c = o.csmSupported, l = Sw(r) ? 0 : 1; if (a && u.enabled) { if (u.type === vT.ShadowMap) { if (a.shadowEnabled) { if (a.shadowFixedArea || a.csmLevel === bT.LEVEL_1 || !c) { var f = h.specialLayer.matShadowView, d = h.specialLayer.matShadowProj, p = h.specialLayer.matShadowViewProj, _ = a.shadowNear, g = a.shadowFar; t.setMat4("cc_matLightView", f), YX.set(d.m10, d.m14, d.m11, d.m15), t.setVec4("cc_shadowProjDepthInfo", YX), YX.set(d.m00, d.m05, 1 / d.m00, 1 / d.m05), t.setVec4("cc_shadowProjInfo", YX), t.setMat4("cc_matLightViewProj", p), YX.set(_, g, 0, 1 - a.shadowSaturation), t.setVec4("cc_shadowNFLSInfo", YX), YX.set(0, l, a.shadowNormalBias, 0), t.setVec4("cc_shadowLPNNInfo", YX) } else { for (var m = oq(u, a), v = 0; v < a.csmLevel; v++) { var y = h.layers[v], b = y.matShadowView; YX.set(b.m00, b.m04, b.m08, m), t.setVec4("cc_csmViewDir0", YX, v), YX.set(b.m01, b.m05, b.m09, y.splitCameraNear), t.setVec4("cc_csmViewDir1", YX, v), YX.set(b.m02, b.m06, b.m10, y.splitCameraFar), t.setVec4("cc_csmViewDir2", YX, v); var w = y.csmAtlas; t.setVec4("cc_csmAtlas", w, v); var x = y.matShadowViewProj; t.setMat4("cc_matCSMViewProj", x, v); var T = y.matShadowProj; YX.set(T.m10, T.m14, T.m11, T.m15), t.setVec4("cc_csmProjDepthInfo", YX, v), YX.set(T.m00, T.m05, 1 / T.m00, 1 / T.m05), t.setVec4("cc_csmProjInfo", YX, v) } YX.set(a.csmTransitionRange, 0, 0, 0), t.setVec4("cc_csmSplitsInfo", YX), YX.set(.1, a.shadowDistance, 0, 1 - a.shadowSaturation), t.setVec4("cc_shadowNFLSInfo", YX), YX.set(0, l, a.shadowNormalBias, a.csmLevel), t.setVec4("cc_shadowLPNNInfo", YX) } YX.set(u.size.x, u.size.y, a.shadowPcf, a.shadowBias), t.setVec4("cc_shadowWHPBInfo", YX) } } else Kn.normalize(KX, u.normal), YX.set(KX.x, KX.y, KX.z, -u.distance), t.setVec4("cc_planarNDInfo", YX), YX.set(0, 0, 0, u.planeBias), t.setVec4("cc_shadowWHPBInfo", YX); t.setMathColor("cc_shadowColor", u.shadowColor) } } var hq = function () { function t(t, e) { this._data = void 0, this._lg = void 0, this._vertID = -1, this._currBlock = void 0, this._currStage = "", this._currFrequency = 3, this._currCount = void 0, this._currConstant = [], this._data = t, this._lg = e } var e = t.prototype; return e.setMat4 = function (e, i, n) { void 0 === n && (n = 0), t.setMat4(this._lg, this._data, e, i, n) }, t.setMat4 = function (e, i, n, r, s) { void 0 === s && (s = 0); var a = t.getConstantInfo(e, i, n); Gr.toArray(a.dataArr, r, 16 * s), i.constants.set(a.constantID, a.dataArr) }, e.setQuaternion = function (e, i, n) { void 0 === n && (n = 0), t.setQuaternion(this._lg, this._data, e, i, n) }, t.setQuaternion = function (e, i, n, r, s) { void 0 === s && (s = 0); var a = t.getConstantInfo(e, i, n); Er.toArray(a.dataArr, r, 4 * s), i.constants.set(a.constantID, a.dataArr) }, e.setColor = function (e, i, n) { void 0 === n && (n = 0), t.setColor(this._lg, this._data, e, i, n) }, t.setColor = function (e, i, n, r, s) { void 0 === s && (s = 0); var a = t.getConstantInfo(e, i, n), o = 4 * s; a.dataArr[0 + o] = r.x, a.dataArr[1 + o] = r.y, a.dataArr[2 + o] = r.z, a.dataArr[3 + o] = r.w, i.constants.set(a.constantID, a.dataArr) }, e.setMathColor = function (e, i, n) { void 0 === n && (n = 0), t.setMathColor(this._lg, this._data, e, i, n) }, t.setMathColor = function (e, i, n, r, s) { void 0 === s && (s = 0); var a = t.getConstantInfo(e, i, n); rr.toArray(a.dataArr, r, 4 * s), i.constants.set(a.constantID, a.dataArr) }, t.getConstantInfo = function (t, e, i) { var n = t.constantIndex.get(i); if (void 0 === n) throw new Error("Constant with name " + i + " not found."); return { constantID: n, dataArr: e.constants.get(n) || [] } }, e.setVec4 = function (e, i, n) { void 0 === n && (n = 0), t.setVec4(this._lg, this._data, e, i, n) }, t.setVec4 = function (e, i, n, r, s) { void 0 === s && (s = 0); var a = t.getConstantInfo(e, i, n); Pn.toArray(a.dataArr, r, 4 * s), i.constants.set(a.constantID, a.dataArr) }, e.setVec2 = function (e, i, n) { void 0 === n && (n = 0), t.setVec2(this._lg, this._data, e, i, n) }, t.setVec2 = function (e, i, n, r, s) { void 0 === s && (s = 0); var a = t.getConstantInfo(e, i, n); as.toArray(a.dataArr, r, 2 * s), i.constants.set(a.constantID, a.dataArr) }, e.setFloat = function (e, i, n) { void 0 === n && (n = 0), t.setFloat(this._lg, this._data, e, i, n) }, t.setFloat = function (e, i, n, r, s) { void 0 === s && (s = 0); var a = t.getConstantInfo(e, i, n); a.dataArr[0 + s] = r, i.constants.set(a.constantID, a.dataArr) }, e.setArrayBuffer = function (e, i) { t.setArrayBuffer(this._lg, this._data, e, i) }, t.setArrayBuffer = function () { throw new Error("Method not implemented.") }, e.setBuffer = function (e, i) { t.setBuffer(this._lg, this._data, e, i) }, t.setBuffer = function (t, e, i, n) { var r = t.attributeIndex.get(i); e.buffers.set(r, n) }, e.setTexture = function (e, i) { t.setTexture(this._lg, this._data, e, i) }, t.setTexture = function (t, e, i, n) { var r = t.attributeIndex.get(i); e.textures.set(r, n) }, e.setReadWriteBuffer = function (e, i) { t.setReadWriteBuffer(this._lg, this._data, e, i) }, t.setReadWriteBuffer = function (t, e, i, n) { var r = t.attributeIndex.get(i); e.buffers.set(r, n) }, e.setReadWriteTexture = function (e, i) { t.setReadWriteTexture(this._lg, this._data, e, i) }, t.setReadWriteTexture = function (t, e, i, n) { var r = t.attributeIndex.get(i); e.textures.set(r, n) }, e.setSampler = function (e, i) { t.setSampler(this._lg, this._data, e, i) }, t.setSampler = function (t, e, i, n) { var r = t.attributeIndex.get(i); e.samplers.set(r, n) }, e.getParentLayout = function () { var t = S.director.root.pipeline, e = t.renderGraph.getParent(this._vertID); return t.renderGraph.getLayout(e) }, e.getCurrentLayout = function () { return S.director.root.pipeline.renderGraph.getLayout(this._vertID) }, e.setBuiltinCameraConstants = function (t) { var e = S.director.root.pipeline; this.getParentLayout(), tq(this, t, e.pipelineSceneData, t.scene) }, e.setBuiltinDirectionalLightFrustumConstants = function (t, e, i) { void 0 === i && (i = 0), aq(this, t, e, i) }, e.setBuiltinSpotLightFrustumConstants = function (t) { aq(this, null, t, 0) }, e.setBuiltinDirectionalLightConstants = function () { uq(this, null, this.getParentLayout()) }, e.setBuiltinSphereLightConstants = function (t, e) { var i = S.director.root.pipeline.pipelineSceneData; YX.set(t.position.x, t.position.y, t.position.z, 1), this.setVec4("cc_lightPos", YX), YX.set(t.size, t.range, 0, 0), this.setVec4("cc_lightSizeRangeAngle", YX); var n = i.isHDR; if (YX.set(t.color.x, t.color.y, t.color.z, 0), t.useColorTemperature) { var r = t.finalColor; YX.x = r.x, YX.y = r.y, YX.z = r.z } YX.w = n ? t.luminance * e.exposure * 1e4 : t.luminance, this.setVec4("cc_lightColor", YX) }, e.setBuiltinSpotLightConstants = function (t, e) { var i = S.director.root.pipeline.pipelineSceneData, n = i.shadows; YX.set(t.position.x, t.position.y, t.position.z, 2), this.setVec4("cc_lightPos", YX), YX.set(t.size, t.range, t.spotAngle, n.enabled && t.shadowEnabled && n.type === vT.ShadowMap ? 1 : 0), this.setVec4("cc_lightSizeRangeAngle", YX), YX.set(t.direction.x, t.direction.y, t.direction.z, 0), this.setVec4("cc_lightDir", YX); var r = i.isHDR; if (YX.set(t.color.x, t.color.y, t.color.z, 0), t.useColorTemperature) { var s = t.finalColor; YX.x = s.x, YX.y = s.y, YX.z = s.z } YX.w = r ? t.luminance * e.exposure * 1e4 : t.luminance, this.setVec4("cc_lightColor", YX), YX.set(0, 0, 0, t.angleAttenuationStrength), this.setVec4("cc_lightBoundingSizeVS", YX) }, e.setBuiltinPointLightConstants = function (t, e) { var i = S.director.root.pipeline.pipelineSceneData; YX.set(t.position.x, t.position.y, t.position.z, 3), this.setVec4("cc_lightPos", YX), YX.set(0, t.range, 0, 0), this.setVec4("cc_lightSizeRangeAngle", YX); var n = i.isHDR; if (t.useColorTemperature) { var r = t.finalColor; YX.x = r.x, YX.y = r.y, YX.z = r.z } YX.w = n ? t.luminance * e.exposure * 1e4 : t.luminance, YX.set(t.color.x, t.color.y, t.color.z, 0), this.setVec4("cc_lightColor", YX) }, e.setBuiltinRangedDirectionalLightConstants = function (t, e) { var i = S.director.root.pipeline.pipelineSceneData; YX.set(t.position.x, t.position.y, t.position.z, 4), this.setVec4("cc_lightPos", YX), YX.set(t.right.x, t.right.y, t.right.z, 0), this.setVec4("cc_lightSizeRangeAngle", YX), YX.set(t.direction.x, t.direction.y, t.direction.z, 0), this.setVec4("cc_lightDir", YX); var n = t.scale; YX.set(.5 * n.x, .5 * n.y, .5 * n.z, 0), this.setVec4("cc_lightBoundingSizeVS", YX); var r = i.isHDR; if (YX.set(t.color.x, t.color.y, t.color.z, 0), t.useColorTemperature) { var s = t.finalColor; YX.x = s.x, YX.y = s.y, YX.z = s.z } YX.w = r ? t.illuminance * e.exposure : t.illuminance, this.setVec4("cc_lightColor", YX) }, e.hasSampler = function (t) { var e = this._lg.constantIndex.get(t); return void 0 !== e && this._data.samplers.has(e) }, e.hasTexture = function (t) { var e = this._lg.constantIndex.get(t); return void 0 !== e && this._data.textures.has(e) }, e.setCustomBehavior = function () { throw new Error("Method not implemented.") }, n(t, [{ key: "name", get: function () { return "" }, set: function () { } }]), t }(), cq = function () { function t() { this.instances = new Array } var e = t.prototype; return e.empty = function () { return 0 === this.instances.length }, e.clear = function () { this.instances.length = 0 }, e.add = function (t, e, i, n) { var r = t.subModels[i], s = r.passes[n].priority, a = r.priority, o = r.shaders[n].typedID, u = s << 16 | a << 8 | n, h = t.priority, c = iq.add(); c.update(r, h, u, e, o, n), this.instances.push(c) }, e.sortOpaqueOrCutout = function () { this.instances.sort((function (t, e) { return t.hash !== e.hash ? t.hash - e.hash : t.depth !== e.depth ? t.depth - e.depth : t.shaderID - e.shaderID })) }, e.sortTransparent = function () { this.instances.sort((function (t, e) { return t.priority !== e.priority ? t.priority - e.priority : t.hash !== e.hash ? t.hash - e.hash : t.depth !== e.depth ? e.depth - t.depth : t.shaderID - e.shaderID })) }, e.recordCommandBuffer = function (t, e, i, n, r, s) { void 0 === n && (n = null), void 0 === r && (r = 0), void 0 === s && (s = null); for (var a, o = p(this.instances); !(a = o()).done;) { var u = a.value, h = u.subModel, c = u.passIndex, l = h.inputAssembler, f = h.passes[c], d = h.shaders[c], _ = fT.getOrCreatePipelineState(t, f, d, e, l); i.bindPipelineState(_), i.bindDescriptorSet(1, f.descriptorSet), n && i.bindDescriptorSet(0, n, [r]), s ? i.bindDescriptorSet(2, h.descriptorSet, s) : i.bindDescriptorSet(2, h.descriptorSet), i.bindInputAssembler(l), i.draw(l) } }, t }(), lq = function () { function t() { this.passInstances = new Map, this.instanceBuffers = new Array } var e = t.prototype; return e.empty = function () { return 0 === this.passInstances.size }, e.add = function (t, e, i) { if (void 0 === this.passInstances.get(t)) { var n = this.passInstances.size; n >= this.instanceBuffers.length && this.instanceBuffers.push(new QS(t)), this.passInstances.set(t, n); var r = this.instanceBuffers[n]; r.pass = t, r.instances } this.instanceBuffers[this.passInstances.get(t)].merge(e, i) }, e.clear = function () { this.passInstances.clear(), this.instanceBuffers.forEach((function (t) { t.clear() })) }, e.sort = function () { }, e.uploadBuffers = function (t) { for (var e, i = p(this.passInstances.entries()); !(e = i()).done;) { var n = e.value; n[0]; var r = n[1], s = this.instanceBuffers[r]; s.hasPendingModels && s.uploadBuffers(t) } }, e.recordCommandBuffer = function (t, e, i, n, r) { void 0 === i && (i = null), void 0 === n && (n = 0), void 0 === r && (r = null); for (var s, a = p(this.instanceBuffers); !(s = a()).done;) { var o = s.value; if (o.hasPendingModels) { var u = o.instances, h = o.pass; e.bindDescriptorSet(1, h.descriptorSet); for (var c, l = null, f = p(u); !(c = f()).done;) { var d = c.value; if (d.count) { var _ = fT.getOrCreatePipelineState(B_.gfxDevice, h, d.shader, t, d.ia); l !== _ && (e.bindPipelineState(_), l = _), i && e.bindDescriptorSet(0, i, [n]), r ? e.bindDescriptorSet(2, d.descriptorSet, r) : e.bindDescriptorSet(2, d.descriptorSet, o.dynamicOffsets), e.bindInputAssembler(d.ia), e.draw(d.ia) } } } } }, t }(), fq = function () { function t(t, e, i) { void 0 === t && (t = 4294967295), void 0 === e && (e = 4294967295), void 0 === i && (i = 4294967295), this.frustumCulledResultID = void 0, this.lightBoundsCulledResultID = void 0, this.renderQueueTarget = void 0, this.frustumCulledResultID = t, this.lightBoundsCulledResultID = e, this.renderQueueTarget = i } return t.prototype.update = function (t, e, i) { void 0 === t && (t = 4294967295), void 0 === e && (e = 4294967295), void 0 === i && (i = 4294967295), this.frustumCulledResultID = t, this.lightBoundsCulledResultID = e, this.renderQueueTarget = i }, t }(); function dq(t, e, i, n, r, s) { var a; if (r && s && (a = fT.getOrCreatePipelineState(B_.gfxDevice, i, r, e, s)), a) { var o = s; t.bindPipelineState(a), t.bindDescriptorSet(1, i.descriptorSet), t.bindDescriptorSet(2, n), t.bindInputAssembler(o), t.draw(o) } } var pq = function () { function t() { this.probeQueue = new sq, this.opaqueQueue = new cq, this.transparentQueue = new cq, this.opaqueInstancingQueue = new lq, this.transparentInstancingQueue = new lq, this.camera = null, this.sceneFlags = 0, this.lightByteOffset = 4294967295 } var e = t.prototype; return e.sort = function () { this.opaqueQueue.sortOpaqueOrCutout(), this.transparentQueue.sortTransparent(), this.opaqueInstancingQueue.sort(), this.transparentInstancingQueue.sort() }, e.update = function () { this.probeQueue.clear(), this.opaqueQueue.clear(), this.transparentQueue.clear(), this.opaqueInstancingQueue.clear(), this.transparentInstancingQueue.clear(), this.camera = null, this.sceneFlags = 0, this.lightByteOffset = 4294967295 }, e.empty = function () { return this.opaqueQueue.empty() && this.transparentQueue.empty() && this.opaqueInstancingQueue.empty() && this.transparentInstancingQueue.empty() }, e.recordCommands = function (t, e, i) { var n = 4294967295 === this.lightByteOffset ? null : [this.lightByteOffset]; 3 & i && (this.opaqueQueue.recordCommandBuffer(B_.gfxDevice, e, t, null, 0, n), this.opaqueInstancingQueue.recordCommandBuffer(e, t, null, 0, n)), 4 & i && (this.transparentInstancingQueue.recordCommandBuffer(e, t, null, 0, n), this.transparentQueue.recordCommandBuffer(B_.gfxDevice, e, t, null, 0, n)) }, t }(), _q = 4294967295; function gq(t) { switch (t) { case 0: return 1; case 1: return 2; case 2: return 16; case 3: return 32; case 4: return 64; case 5: return 4; case 6: return 8; case 7: return 128; case 8: return 256; default: return j("DescriptorType not found"), 256 } } function mq(t) { switch (t) { case 1: return 0; case 2: return 1; case 16: return 2; case 32: return 3; case 64: return 4; case 4: return 5; case 8: return 6; case 128: return 7; case 256: return 8; default: return j("DescriptorTypeOrder not found"), 8 } } function vq(t, e) { return t.locateChild(t.N, e || "default") } function yq(t, e, i) { return t.locateChild(e, i) } function bq(t, e, i) { return void 0 === i ? t.locateChild(e, "default") : "number" == typeof i ? t.locateChild(e, i.toString()) : t.locateChild(e, i) } var wq, xq, Sq = new Map([["cc_lightPos", 1], ["cc_lightColor", 1], ["cc_lightSizeRangeAngle", 1], ["cc_lightDir", 1], ["cc_lightBoundingSizeVS", 1]]); function Tq(t) { for (var e, i = 0, n = p(t); !(e = n()).done;) { var r = e.value; if (r.count) i += Jp(r.type) * r.count; else { var s = Sq.get(r.name); if (void 0 === s) if ("cc_joints" !== r.name) j("Invalid uniform count: " + r.name); else { var a = Jp(r.type) * Pb.LAYOUT.members[0].count; X(a !== Pb.SIZE), i += a } else i += Jp(r.type) * s } } return X(!!i), i } function Iq(t, e) { var i = JSON.parse(t[0]), n = JSON.parse(e[0]); return 1e4 * i.updateFrequency + 1e3 * i.parameterType + 100 * i.descriptorType + i.visibility - (1e4 * n.updateFrequency + 1e3 * n.parameterType + 100 * n.descriptorType + n.visibility) } function Eq(t, e) { var i = JSON.parse(t[0]), n = JSON.parse(e[0]); return 1e9 * i.updateFrequency + 1e8 * i.parameterType + 1e7 * i.descriptorType + 1e6 * i.visibility + 1e5 * i.accessType + 1e4 * i.viewDimension + 1e3 * i.sampleType + i.format - (1e9 * n.updateFrequency + 1e8 * n.parameterType + 1e7 * n.descriptorType + 1e6 * n.visibility + 1e5 * n.accessType + 1e4 * n.viewDimension + 1e3 * n.sampleType + n.format) } function Aq(t, e) { var i = t.attributeIndex.get(e); if (void 0 === i) { var n = t.valueNames.length; return t.attributeIndex.set(e, n), t.valueNames.push(e), n } return i } function Cq(t, e) { e.bindings.length = 0; for (var i = 0; i < t.descriptorBlocks.length; ++i)for (var n = t.descriptorBlocks[i], r = n.offset, s = 0; s < n.descriptors.length; ++s) { var a = n.descriptors[s], o = new Ap; o.binding = r, o.descriptorType = gq(n.type), o.count = a.count, o.stageFlags = n.visibility, o.access = n.accessType, o.viewDimension = n.viewDimension, o.sampleType = n.sampleType, o.format = n.format, o.immutableSamplers = [], e.bindings.push(o), r += a.count } } function Dq(t, e) { var i = new Cp; return Cq(e, i), t ? t.createDescriptorSetLayout(i) : null } function Rq(t, e) { for (var i = 0; i < e._layouts.length; ++i)e.getLayout(i).getSets().forEach((function (e) { var i = e, n = i.descriptorSetLayoutData; if (t) { var r = Dq(t, n); r && (i.descriptorSetLayout = r, i.descriptorSet = t.createDescriptorSet(new Dp(r))) } else Cq(n, i.descriptorSetLayoutInfo) })) } function Pq(t, e) { var i = JSON.stringify(e), n = t.get(i); if (n) return n; var r = new Wj(e.descriptorType, e.visibility, 0); return t.set(i, r), r } function Bq(t, e) { var i = JSON.stringify(e), n = t.get(i); if (n) return n; var r = new Wj(e.descriptorType, e.visibility, 0, e.accessType, e.viewDimension, e.sampleType, e.format); return t.set(i, r), r } function Mq(t) { switch (t) { case 26: case 33: case 39: return 2; case 28: case 35: case 41: return 4; case 29: case 36: case 42: return 5; case 31: case 38: case 44: return 9; case 30: case 37: case 43: return 8; default: return 0 } } function Oq(t, e, i, n) { for (var r = new Map, s = new Map, a = 0; a < n.blocks.length; a++) { var o = n.blocks[a], u = Gj.isWebGPU ? Bq(r, { updateFrequency: e, parameterType: 4, descriptorType: 0, visibility: o.stageFlags, accessType: 1, viewDimension: 1, sampleType: 0, format: 0 }) : Pq(r, { updateFrequency: e, parameterType: 4, descriptorType: 0, visibility: o.stageFlags }), h = Aq(t, o.name); u.descriptors.push(new Hj(h, 0, 1)), s.set(h, new ap(i, 4294967295, o.name, o.members, 1)) } for (var c = 0; c < n.samplerTextures.length; c++) { var l = n.samplerTextures[c], f = Gj.isWebGPU ? Bq(r, { updateFrequency: e, parameterType: 4, descriptorType: 2, visibility: l.stageFlags, accessType: 1, viewDimension: Mq(l.type), sampleType: l.sampleType, format: 0 }) : Pq(r, { updateFrequency: e, parameterType: 4, descriptorType: 2, visibility: l.stageFlags }), d = Aq(t, l.name); f.descriptors.push(new Hj(d, l.type, l.count)) } for (var _ = 0; _ < n.samplers.length; _++) { var g = n.samplers[_], m = Gj.isWebGPU ? Bq(r, { updateFrequency: e, parameterType: 4, descriptorType: 3, visibility: g.stageFlags, accessType: 1, viewDimension: 0, sampleType: 0, format: 0 }) : Pq(r, { updateFrequency: e, parameterType: 4, descriptorType: 3, visibility: g.stageFlags }), v = Aq(t, g.name); m.descriptors.push(new Hj(v, 32, g.count)) } for (var y = 0; y < n.textures.length; y++) { var b = n.textures[y], w = Gj.isWebGPU ? Bq(r, { updateFrequency: e, parameterType: 4, descriptorType: 4, visibility: b.stageFlags, accessType: 1, viewDimension: Mq(b.type), sampleType: b.sampleType, format: 0 }) : Pq(r, { updateFrequency: e, parameterType: 4, descriptorType: 4, visibility: b.stageFlags }), x = Aq(t, b.name); w.descriptors.push(new Hj(x, b.type, b.count)) } for (var S = 0; S < n.buffers.length; S++) { var T = n.buffers[S], I = Gj.isWebGPU ? Bq(r, { updateFrequency: e, parameterType: 4, descriptorType: 5, visibility: T.stageFlags, accessType: 1, viewDimension: 1, sampleType: 0, format: 0 }) : Pq(r, { updateFrequency: e, parameterType: 4, descriptorType: 5, visibility: T.stageFlags }), E = Aq(t, T.name); I.descriptors.push(new Hj(E, 0, 1)) } for (var A = 0; A < n.images.length; A++) { var C = n.images[A], D = Gj.isWebGPU ? Bq(r, { updateFrequency: e, parameterType: 4, descriptorType: 7, visibility: C.stageFlags, accessType: 1, viewDimension: Mq(C.type), sampleType: 0, format: 0 }) : Pq(r, { updateFrequency: e, parameterType: 4, descriptorType: 7, visibility: C.stageFlags }), R = Aq(t, C.name); D.descriptors.push(new Hj(R, C.type, C.count)) } for (var P = 0; P < n.subpassInputs.length; P++) { var B = n.subpassInputs[P], M = Gj.isWebGPU ? Bq(r, { updateFrequency: e, parameterType: 4, descriptorType: 8, visibility: B.stageFlags, accessType: 1, viewDimension: 4, sampleType: 0, format: 0 }) : Pq(r, { updateFrequency: e, parameterType: 4, descriptorType: 8, visibility: B.stageFlags }), O = Aq(t, B.name); M.descriptors.push(new Hj(O, 0, B.count)) } for (var L, F = Gj.isWebGPU ? Array.from(r).sort(Eq) : Array.from(r).sort(Iq), k = new jj(i, 0), N = 0, z = p(F); !(L = z()).done;) { var U = L.value, V = U[0], G = U[1], H = JSON.parse(V); G.offset = N; for (var W, q = p(G.descriptors); !(W = q()).done;) { var Y = W.value; if (0 === H.descriptorType) { var K = s.get(Y.descriptorID); if (!K) { j("Uniform block not found for " + Y.descriptorID); continue } X(4294967295 === K.binding), K.binding = G.capacity, k.uniformBlocks.set(Y.descriptorID, K) } void 0 !== k.bindingMap.get(Y.descriptorID) && j("Duplicated descriptor " + Y.descriptorID), k.bindingMap.set(Y.descriptorID, G.offset + G.capacity), G.capacity += Y.count } N += G.capacity, k.capacity += G.capacity, 0 === H.descriptorType || 1 === H.descriptorType ? k.uniformBlockCapacity += G.capacity : 2 === H.descriptorType && (k.samplerTextureCapacity += G.capacity), k.descriptorBlocks.push(G) } return k } function Lq(t, e) { e.bindings.length = 0; for (var i = 0; i < t.descriptorBlocks.length; ++i)for (var n = t.descriptorBlocks[i], r = n.offset, s = 0; s < n.descriptors.length; ++s) { var a = n.descriptors[s], o = new Ap; o.binding = r, o.descriptorType = gq(n.type), o.count = a.count, o.stageFlags = n.visibility, o.access = n.accessType, o.viewDimension = n.viewDimension, o.sampleType = n.sampleType, o.format = n.format, o.immutableSamplers = [], e.bindings.push(o), r += a.count } } function Fq(t, e, i) { var n = t.getSet(e); n && n.descriptorSetLayout ? i.setLayouts.push(n.descriptorSetLayout) : i.setLayouts.push(wq) } function kq(t, e) { Gj.type = 8 === t.gfxAPI ? 1 : 0, Gj.isWebGPU = 8 === t.gfxAPI, wq = t.createDescriptorSetLayout(new Cp), xq = t.createPipelineLayout(new Rp); for (var i, n = p(e.v()); !(i = n()).done;)for (var r, s = i.value, a = p(e.getLayout(s).getSets()); !(r = a()).done;) { var o = r.value; o[0]; var u = o[1]; null !== u.descriptorSetLayout && W("descriptor set layout already initialized. It will be overwritten"), Lq(u.descriptorSetLayoutData, u.descriptorSetLayoutInfo), u.descriptorSetLayout = t.createDescriptorSetLayout(u.descriptorSetLayoutInfo) } for (var h, c = p(e.v()); !(h = c()).done;) { var l = h.value; if (e.h(1, l)) { var f = e.getParent(l), d = l, _ = e.getLayout(f), g = e.getLayout(d), m = new Rp; Fq(_, 3, m), Fq(g, 2, m), Fq(g, 1, m), Fq(g, 0, m), e.j(d).pipelineLayout = t.createPipelineLayout(m) } } } function Nq(t) { for (var e, i = p(t.v()); !(e = i()).done;)for (var n, r = e.value, s = p(t.getLayout(r).getSets()); !(n = s()).done;) { var a = n.value; a[0]; var o = a[1]; null !== o.descriptorSetLayout && o.descriptorSetLayout.destroy() } xq.destroy(), wq.destroy() } function zq() { return wq } function Uq() { return xq } function Vq(t, e, i, n) { if (n < 3) { var r = t.getLayout(i).getSet(n); return r ? r.descriptorSetLayout ? r.descriptorSetLayout : (j("descriptor set layout not initialized"), wq) : wq } X(3 === n), X(e === t.getParent(i)); var s = t.getLayout(e).getSet(n); return s ? s.descriptorSetLayout ? s.descriptorSetLayout : (j("descriptor set layout not initialized"), wq) : wq } function Gq(t, e, i, n) { if (n < 3) { var r = t.getLayout(i).getSet(n); return r ? r.descriptorSetLayout ? r.descriptorSetLayout : (j("descriptor set layout not initialized"), null) : null } X(3 === n), X(e === t.getParent(i)); var s = t.getLayout(e).getSet(n); return s ? s.descriptorSetLayout ? s.descriptorSetLayout : (j("descriptor set layout not initialized"), null) : null } function Hq(t, e, i) { X(e !== t.N); var n = t.j(e).shaderIndex.get(i); return void 0 === n ? _q : n } function Wq(t, e) { var i = t.attributeIndex.get(e); return void 0 === i ? _q : i } function jq(t, e) { return e >= t.valueNames.length ? "" : t.valueNames[e] } var Xq = function () { this.frustumCullingKeyRecycle = new eo((function () { return new tY }), 8), this.frustumCullingsRecycle = new eo((function () { return new aY }), 8), this.lightBoundsCullingRecycle = new eo((function () { return new iY }), 8), this.lightBoundsCullingResultRecycle = new eo((function () { return new nY }), 8), this.lightBoundsCullingKeyRecycle = new eo((function () { return new eY }), 8), this.renderQueueRecycle = new eo((function () { return new pq }), 8), this.renderQueueQueryRecycle = new eo((function () { return new fq }), 8) }, qq = Iv.makeMaskExclude([Iv.BitMask.UI_2D, Iv.BitMask.UI_3D, Iv.BitMask.GIZMOS, Iv.BitMask.EDITOR, Iv.BitMask.SCENE_GIZMO, Iv.BitMask.PROFILER]), Yq = new WeakMap, Kq = "", Qq = 0; function Zq(t) { return Yq.has(t) || Yq.set(t, ++Qq), Yq.get(t) } function Jq(t, e, i) { void 0 === i && (i = -1), Kq = ""; var n = t.camera, r = t.light.light, s = t.light.level, a = t.light.probe, o = t.shadingLight; return Kq += GX(n ? Zq(n) : 0), Kq += GX(a ? Zq(a) : 0), Kq += GX(-1 === i && r ? Zq(r) : 0), Kq += GX(-1 !== i && o ? Zq(o) : 0), Kq += GX(-1 === i ? s : 0), Kq += GX(e ? 1 : 0), Kq += GX(i) } var $q, tY = function () { function t(t, e) { void 0 === t && (t = null), void 0 === e && (e = !1), this.sceneData = null, this.castShadows = !1, this.sceneData = t, this.castShadows = e } return t.prototype.update = function (t, e) { this.sceneData = t, this.castShadows = e }, t }(), eY = function () { function t(t, e) { void 0 === t && (t = null), void 0 === e && (e = -1), this.sceneData = null, this.frustumCullingID = -1, this.sceneData = t, this.frustumCullingID = e } return t.prototype.update = function (t, e) { void 0 === t && (t = null), void 0 === e && (e = -1), this.sceneData = t, this.frustumCullingID = e }, t }(), iY = function () { function t() { this.resultKeyIndex = new Map, this.resultIndex = new Map } return t.prototype.update = function () { this.resultIndex.clear(), this.resultKeyIndex.clear() }, t }(), nY = function () { function t() { this.instances = [], this.lightByteOffset = 4294967295 } return t.prototype.update = function () { return this.instances.length = 0, this.lightByteOffset = 4294967295, this }, t }(); function rY(t, e, i) { return t + "-" + e + "-" + i } function sY(t) { var e = t.split("-"); return [parseInt(e[0]), parseInt(e[1]), parseInt(e[2])] } var aY = function () { function t() { this.resultIndex = new Map, this.resultKeyIndex = new Map } return t.prototype.update = function () { this.resultIndex.clear(), this.resultKeyIndex.clear() }, t }(); function oY(t, e) { return t && (e & t.layer) === t.layer } function uY(t, e) { return !!(e & t.visFlags) } function hY(t, e) { return oY(t.node, e) || uY(t, e) } function cY(t) { return WX((t.node.layer & qq) === t.node.layer || qq & t.visFlags) } var lY = new hu; function fY(t, e, i) { var n = t.worldBounds, r = $q.shadows; return i && r.type === vT.Planar ? (hu.transform(lY, n, r.matLight), !Wa.aabbFrustum(lY, e)) : !Wa.aabbFrustum(n, e) } function dY(t, e, i, n, r, s) { var a, o, u = $q.skybox, h = u.model, c = e.visibility, l = 8 & e.clearFlag; !n && u && u.enabled && h && l && s.push(h); for (var f, d = p(t.models); !(f = d()).done;) { var _ = f.value; if (_.enabled && _.node && (!n || _.castShadow) && !t.isCulledByLod(e, _)) { var g = _.worldBounds; if (r) if (0 === r.probeType) { if (!hY(_, c)) continue; if (g && (a = g, o = r.boundingBox, !Wa.aabbWithAABB(a, o))) continue; s.push(_) } else cY(_) && s.push(_); else { if (!hY(_, c)) continue; if (g && fY(_, i, n)) continue; s.push(_) } } } } var pY = new Kn; function _Y(t, e) { var i = 0; return e.node && (Kn.subtract(pY, e.worldBounds ? e.worldBounds.center : e.node.worldPosition, t.position), i = Kn.dot(pY, t.forward)), i } function gY(t, e, i, n, r, s, a) { var o = a.probeQueue; n && o.addToProbeQueue(s, t); for (var u = s.subModels, h = u.length, c = $q.skybox.model, l = _Y(r, s), f = 0; f < h; ++f) { var d = u[f], p = d.passes, _ = p.length; o.probeMap.includes(d) && (t = o.defaultId); for (var g = 0; g < _; ++g)if (s !== c || f || g || !e) { var m = p[g]; if (t === m.phaseID) { var v = m.blendState.targets[0].blend; !i && v || !e && !v || (1 === m.batchingScheme ? v ? a.transparentInstancingQueue.add(m, d, g) : a.opaqueInstancingQueue.add(m, d, g) : v ? a.transparentQueue.add(s, l, f, g) : a.opaqueQueue.add(s, l, f, g)) } } else a.opaqueQueue.add(s, l, f, g) } } var mY, vY = new hu(0, 0, 0, .5, .5, .5), yY = new hu, bY = function () { function t() { this.frustumCullings = new Map, this.frustumCullingResults = [], this.lightBoundsCullings = new Map, this.lightBoundsCullingResults = [], this.renderQueueIndex = new Map, this.renderQueues = [], this.renderQueueQueryIndex = new Map, this.cullingPools = new Xq, this.numFrustumCulling = 0, this.numLightBoundsCulling = 0, this.numRenderQueues = 0, this.layoutGraph = void 0, this.renderGraph = void 0, this.enableLightCulling = !0, this.kFilterMask = 8200, this.kDrawMask = 7, this.kAllMask = this.kFilterMask | this.kDrawMask } var e = t.prototype; return e.resetPool = function () { var t = this.cullingPools; t.frustumCullingKeyRecycle.reset(), t.frustumCullingsRecycle.reset(), t.lightBoundsCullingRecycle.reset(), t.lightBoundsCullingResultRecycle.reset(), t.lightBoundsCullingKeyRecycle.reset(), t.renderQueueRecycle.reset(), t.renderQueueQueryRecycle.reset(), iq.reset() }, e.clear = function () { this.resetPool(), this.frustumCullings.clear(), this.frustumCullingResults.length = 0, this.lightBoundsCullings.clear(), this.lightBoundsCullingResults.length = 0, this.renderQueueIndex.clear(), this.renderQueues.length = 0, this.renderQueueQueryIndex.clear(), this.numLightBoundsCulling = 0, this.numFrustumCulling = 0, this.numRenderQueues = 0 }, e.buildRenderQueues = function (t, e, i) { this.layoutGraph = e, this.renderGraph = t, $q = i, this.collectCullingQueries(t), this.batchFrustumCulling(i), this.batchLightBoundsCulling(), this.fillRenderQueues() }, e.getOrCreateLightBoundsCulling = function (t, e) { var i; if (!(4 & t.cullingFlags)) return 4294967295; if (0 === (null == (i = t.shadingLight) ? void 0 : i.type)) return 4294967295; if (!this.enableLightCulling) return 4294967295; var n = t.scene, r = this.lightBoundsCullings.get(n); if (!r) { var s = this.cullingPools.lightBoundsCullingRecycle.add(); s.update(), this.lightBoundsCullings.set(n, s), r = this.lightBoundsCullings.get(n) } var a = Jq(t, !1, e), o = r.resultIndex.get(a); if (void 0 !== o) return o; var u = this.numLightBoundsCulling++; this.numLightBoundsCulling > this.lightBoundsCullingResults.length && this.lightBoundsCullingResults.push(this.cullingPools.lightBoundsCullingResultRecycle.add().update()), r.resultIndex.set(a, u); var h = this.cullingPools.lightBoundsCullingKeyRecycle.add(); return h.update(t, e), r.resultKeyIndex.set(a, h), u }, e.getOrCreateFrustumCulling = function (t) { var e = this.renderGraph.j(t), i = e.scene, n = this.frustumCullings.get(i); if (!n) { var r = this.cullingPools.frustumCullingsRecycle.add(); r.update(), this.frustumCullings.set(i, r), n = this.frustumCullings.get(i) } var s = WX(8 & e.flags), a = Jq(e, s), o = n.resultIndex.get(a); if (void 0 !== o) return o; var u = this.numFrustumCulling++; this.numFrustumCulling > this.frustumCullingResults.length && this.frustumCullingResults.push([]), n.resultIndex.set(a, u); var h = this.cullingPools.frustumCullingKeyRecycle.add(); return h.update(e, s), n.resultKeyIndex.set(a, h), u }, e.getOrCreateRenderQueue = function (t, e, i) { var n = this.renderQueueIndex.get(t); if (void 0 !== n) return this.renderQueues[n].sceneFlags |= e & this.kDrawMask, n; var r = this.numRenderQueues++; if (this.numRenderQueues > this.renderQueues.length) { var s = this.cullingPools.renderQueueRecycle.add(); s.update(), this.renderQueues.push(s) } var a = this.renderQueues[r]; return this.renderQueueIndex.set(t, r), a.camera = i, a.sceneFlags = e & this.kAllMask, r }, e.collectCullingQueries = function (t) { for (var e, i = p(t.v()); !(e = i()).done;) { var n = e.value; if (t.h(9, n) && t.getValid(n)) { var r = t.j(n); if (r.scene) { var s = this.getOrCreateFrustumCulling(n), a = this.getOrCreateLightBoundsCulling(r, s), o = t.getParent(n), u = rY(s, a, t.j(o).phaseID), h = this.getOrCreateRenderQueue(u, r.flags, r.camera), c = this.cullingPools.renderQueueQueryRecycle.add(); c.update(s, a, h), this.renderQueueQueryIndex.set(n, c) } } } }, e.uploadInstancing = function (t) { for (var e = 0; e !== this.numRenderQueues; ++e) { var i = this.renderQueues[e]; i.opaqueInstancingQueue.uploadBuffers(t), i.transparentInstancingQueue.uploadBuffers(t) } }, e._getPhaseIdFromScene = function (t) { var e = this.renderGraph, i = e.getParent(t); return e.j(i).phaseID }, e.getBuiltinShadowFrustum = function (t, e, i, n) { var r = t.csmLayers, s = i.csmLevel, a = t.shadows; return a.type === vT.Planar ? e.frustum : (a.enabled && a.type === vT.ShadowMap && i && i.node && r.update(t, e), i.shadowFixedArea || s === bT.LEVEL_1 ? r.specialLayer.validFrustum : r.layers[n].validFrustum) }, e.batchFrustumCulling = function (t) { for (var e, i = p(this.frustumCullings); !(e = i()).done;)for (var n, r = e.value, s = r[0], a = r[1], o = p(a.resultIndex); !(n = o()).done;) { var u = n.value, h = u[0], c = u[1], l = a.resultKeyIndex.get(h), f = l.sceneData, d = f.light.light, _ = f.light.level, g = l.castShadows, m = f.light.probe, v = m ? m.camera : f.camera, y = this.frustumCullingResults[c]; if (m) dY(s, v, v.frustum, g, m, y); else if (d) switch (d.type) { case 2: dY(s, v, d.frustum, g, null, y); break; case 0: dY(s, v, this.getBuiltinShadowFrustum(t, v, d, _), g, null, y) } else dY(s, v, v.frustum, g, null, y) } }, e.executeSphereLightCulling = function (t, e, i) { for (var n, r = t.aabb, s = p(e); !(n = s()).done;) { var a = n.value, o = a.worldBounds; o && !Wa.aabbWithAABB(o, r) || i.push(a) } }, e.executeSpotLightCulling = function (t, e, i) { for (var n, r = t.aabb, s = t.frustum, a = p(e); !(n = a()).done;) { var o = n.value, u = o.worldBounds; (!u || Wa.aabbWithAABB(r, u) && Wa.aabbFrustum(u, s)) && i.push(o) } }, e.executePointLightCulling = function (t, e, i) { for (var n, r = t.aabb, s = p(e); !(n = s()).done;) { var a = n.value, o = a.worldBounds; o && !Wa.aabbWithAABB(r, o) || i.push(a) } }, e.executeRangedDirectionalLightCulling = function (t, e, i) { vY.transform(t.node.worldMatrix, null, null, null, yY); for (var n, r = p(e); !(n = r()).done;) { var s = n.value, a = s.worldBounds; a && !Wa.aabbWithAABB(yY, a) || i.push(s) } }, e.batchLightBoundsCulling = function () { for (var t, e = p(this.lightBoundsCullings); !(t = e()).done;) { var i = t.value; i[0]; for (var n, r = i[1], s = p(r.resultIndex); !(n = s()).done;) { var a = n.value, o = a[0], u = a[1], h = r.resultKeyIndex.get(o), c = h.sceneData, l = h.frustumCullingID, f = this.frustumCullingResults[l], d = this.lightBoundsCullingResults[u]; switch (c.shadingLight.type) { case 1: var _ = c.shadingLight; this.executeSphereLightCulling(_, f, d.instances); break; case 2: var g = c.shadingLight; this.executeSpotLightCulling(g, f, d.instances); break; case 3: var m = c.shadingLight; this.executePointLightCulling(m, f, d.instances); break; case 4: var v = c.shadingLight; this.executeRangedDirectionalLightCulling(v, f, d.instances) } } } }, e._getModelsByCullingResults = function (t, e) { return 4294967295 !== t ? t < this.lightBoundsCullingResults.length ? this.lightBoundsCullingResults[t].instances : [] : e < this.frustumCullingResults.length ? this.frustumCullingResults[e] : [] }, e.fillRenderQueues = function () { for (var t, e = p(this.renderQueueIndex); !(t = e()).done;) { var i = t.value, n = i[0], r = i[1], s = this.renderQueues[r], a = sY(n), o = a[0], u = a[1], h = a[2], c = WX(4 & s.sceneFlags), l = WX(3 & s.sceneFlags), f = WX(8 & s.sceneFlags), d = WX(8192 & s.sceneFlags); if (f || c || l || d) { for (var _, g = this._getModelsByCullingResults(u, o), m = s.camera, v = p(g); !(_ = v()).done;)gY(h, l, c, d, m, _.value, s); s.sort() } } }, t }(), wY = function () { function t() { this.cpuBuffer = void 0, this.programLibrary = void 0, this.device = null, this.elementSize = 0, this.maxNumLights = 16, this.binding = 4294967295, this.resized = !1, this.lightBuffer = void 0, this.firstLightBufferView = null, this.lights = [], this.lightIndex = new Map } var e = t.prototype; return e.init = function (t, e, i) { this.device = e, this.programLibrary = t; var n = this.programLibrary.localLayoutData, r = t.layoutGraph.attributeIndex.get("CCForwardLight"), s = n.uniformBlocks.get(r); this.elementSize = jX(Tq(s.members), this.device.capabilities.uboOffsetAlignment), this.maxNumLights = i, this.binding = t.localLayoutData.bindingMap.get(r); var a = this.elementSize * this.maxNumLights; this.lightBuffer = this.device.createBuffer(new Zd(18, 3, a, this.elementSize)), this.firstLightBufferView = this.device.createBuffer(new Jd(this.lightBuffer, 0, this.elementSize)), this.cpuBuffer = new Float32Array(a / 4), this.resized = !0 }, e.buildLights = function (t, e, i) { for (var n, r = p(t.lightBoundsCullings); !(n = r()).done;) { var s = n.value; s[0]; for (var a, o = s[1], u = p(o.resultIndex); !(a = u()).done;) { var h = a.value, c = h[0], l = h[1], f = o.resultKeyIndex.get(c).sceneData, d = 1; if (f.camera) d = f.camera.exposure; else { if (!f.light.probe || !f.light.probe.camera) throw new Error("Unexpected situation: No camera or probe found."); d = f.light.probe.camera.exposure } var _ = this.addLight(f.shadingLight, e, d, i); t.lightBoundsCullingResults[l].lightByteOffset = _ } } for (var g, m = p(t.renderQueueQueryIndex); !(g = m()).done;) { var v = g.value; v[0]; var y = v[1]; if (4294967295 !== y.lightBoundsCulledResultID) { var b = t.lightBoundsCullingResults[y.lightBoundsCulledResultID].lightByteOffset; t.renderQueues[y.renderQueueTarget].lightByteOffset = b } } }, e.tryUpdateRenderSceneLocalDescriptorSet = function (t) { if (t.lightBoundsCullings.size) { for (var e, i = p(t.frustumCullings); !(e = i()).done;) { var n = e.value, r = n[0]; n[1]; for (var s, a = p(r.models); !(s = a()).done;) { var o = s.value; if (!o) throw new Error("Unexpected null model."); for (var u, h = p(o.subModels); !(u = h()).done;) { var c = u.value.descriptorSet, l = c.getBuffer(this.binding); (this.resized || l !== this.firstLightBufferView) && (c.bindBuffer(this.binding, this.firstLightBufferView), c.update()) } } } this.resized = !1 } }, e.clear = function () { this.cpuBuffer.fill(0), this.lights.length = 0, this.lightIndex.clear() }, e.addLight = function (t, e, i, n) { var r = this.lightIndex.get(t); if (void 0 !== r) return r; if (this.lights.length === this.maxNumLights) { this.resized = !0, this.maxNumLights *= 2; var s = this.elementSize * this.maxNumLights; this.lightBuffer.resize(s), this.firstLightBufferView = this.device.createBuffer(new Jd(this.lightBuffer, 0, this.elementSize)); var a = this.cpuBuffer; this.cpuBuffer = new Float32Array(s / 4), this.cpuBuffer.set(a) } var o = this.lights.length; this.lights[o] = t, this.lightIndex.set(t, o); var u = this.elementSize / 4 * o; return XX(t, e, i, n, this.cpuBuffer, u, this.elementSize), o * this.elementSize }, e.buildLightBuffer = function (t) { t.updateBuffer(this.lightBuffer, this.cpuBuffer, this.lights.length * this.elementSize / 4) }, t }(), xY = function () { function t(t) { void 0 === t && (t = ""), this.name = void 0, this.name = t, mY && mY.pipeline.resourceUses.push(t) } var e = t.prototype; return e.checkTexture = function (t) { var e = mY.deviceTextures.get(t); if (!e) return !1; var i = mY.resourceGraph.getDesc(mY.resourceGraph.vertex(t)), n = i.width, r = i.height, s = function (t, e) { return t === n && e === r }; return e.texture ? s(e.texture.width, e.texture.height) : !!e.swapchain && s(e.swapchain.width, e.swapchain.height) }, e.createDeviceTex = function (t) { var e, i = mY.deviceTextures.get(this.name); i && this.checkTexture(this.name) || (null != (e = i) && e.texture && i.texture.destroy(), i = new TY(this.name, t), mY.deviceTextures.set(this.name, i)) }, e.checkBuffer = function (t) { var e = mY.deviceBuffers.get(t), i = mY.resourceGraph.vertex(this.name), n = mY.resourceGraph.getDesc(i); return e.buffer.size >= n.width }, e.createDeviceBuf = function (t) { var e, i = mY.deviceBuffers.get(this.name); i && this.checkBuffer(this.name) || (null != (e = i) && e.buffer && i.buffer.destroy(), i = new EY(this.name, t), mY.deviceBuffers.set(this.name, i)) }, e.managed = function (t) { this.createDeviceTex(t) }, e.managedBuffer = function (t) { this.createDeviceBuf(t) }, e.managedTexture = function () { }, e.persistentBuffer = function (t) { this.createDeviceBuf(t) }, e.persistentTexture = function (t) { this.createDeviceTex(t) }, e.framebuffer = function (t) { this.createDeviceTex(t) }, e.swapchain = function (t) { this.createDeviceTex(t) }, e.formatView = function () { }, e.subresourceView = function () { }, n(t, [{ key: "resName", set: function (t) { this.name = t } }]), t }(), SY = function () { function t(t) { this._name = void 0, this._name = t } return n(t, [{ key: "name", get: function () { return this._name } }]), t }(), TY = function (t) { function e(e, i) { var n; (n = t.call(this, e) || this)._texture = null, n._swapchain = null, n._framebuffer = null, n._desc = null, n._trait = null; var r = mY.resourceGraph, s = r.vertex(e); return n._desc = r.getDesc(s), n._trait = r.getTraits(s), i instanceof S_ ? n._texture = i : i instanceof u_ ? n._framebuffer = i : i instanceof rj ? n._swapchain = i.swapchain : n.createTextureFromDesc(n._desc), n } s(e, t); var i = e.prototype; return i.createTextureFromDesc = function (t) { var e = 1; switch (t.dimension) { case 1: e = 0; break; case 3: e = 2 }var i = [[16, 16], [32, 32], [64, 64], [8, 4], [4, 8], [256, 1], [512, 2]].reduce((function (e, i) { var n = i[0], r = i[1]; return t.flags & n ? e | r : e }), 0); this._texture = mY.device.createTexture(new ip(e, i, t.format, t.width, t.height)) }, i.release = function () { var t, e; null == (t = this.framebuffer) || t.destroy(), this._framebuffer = null, null == (e = this.texture) || e.destroy(), this._texture = null }, n(e, [{ key: "texture", get: function () { return this._texture } }, { key: "framebuffer", get: function () { return this._framebuffer }, set: function (t) { this._framebuffer = t } }, { key: "description", get: function () { return this._desc } }, { key: "trait", get: function () { return this._trait } }, { key: "swapchain", get: function () { return this._swapchain } }]), e }(SY); function IY(t) { var e = S.director.root.pipeline.pipelineSceneData; return !!(e.shadows.enabled && e.shadows.type === vT.ShadowMap && t && 8 & t.flags) } var EY = function (t) { function e(e) { var i; (i = t.call(this, e) || this)._buffer = null; var n = mY.resourceGraph, r = n.vertex(e), s = n.getDesc(r), a = new Zd(i.calculateBufferUsage(s.flags), 1, s.width); return i._buffer = mY.device.createBuffer(a), i } s(e, t); var i = e.prototype; return i.calculateBufferUsage = function (t) { return [[2, 64], [1, 16], [4, 32], [256, 1], [512, 2]].reduce((function (e, i) { var n = i[0], r = i[1]; return t & n ? e | r : e }), 0) }, i.release = function () { var t; null == (t = this._buffer) || t.destroy(), this._buffer = null }, n(e, [{ key: "buffer", get: function () { return this._buffer } }]), e }(SY), AY = new Float32Array(4), CY = function () { function t(t) { this._isUpdate = !1, this._isGatherLight = !1, this._blit = void 0, this._screenQuad = null, this._stageDesc = void 0, this._lightVolumeBuffer = null, this._lightMeterScale = 1e4, this._lightBufferData = void 0, this._blit = t } var e = t.prototype; return e._createQuadInputAssembler = function () { return mY.blit.pipelineIAData }, e.createScreenQuad = function () { this._screenQuad || (this._screenQuad = this._createQuadInputAssembler()) }, e._gatherVolumeLights = function (t) { var e = this; if (t.scene) { for (var i, n = mY.pipeline, r = mY.commandBuffer, s = t.scene.sphereLights, a = t.scene.spotLights, o = t.exposure, u = Cb.LIGHTS_PER_PASS, h = Pn.length, c = h * u, l = Vs.create(0, 0, 0, 1), f = 0, d = function (i, r) { if (!(f >= u) && (Vs.set(l, i.position.x, i.position.y, i.position.z, i.range), Wa.sphereFrustum(l, t.frustum))) { if (Kn.toArray(AY, i.position), AY[3] = r ? 1 : 0, e._lightBufferData.set(AY, f * h + 0 * c), Kn.toArray(AY, i.color), i.useColorTemperature) { var s = i.colorTemperatureRGB; AY[0] *= s.x, AY[1] *= s.y, AY[2] *= s.z } AY[3] = n.pipelineSceneData.isHDR ? i.luminance * o * e._lightMeterScale : i.luminance, e._lightBufferData.set(AY, f * h + 1 * c), AY[0] = i.size, AY[1] = i.range, AY[2] = r ? i.spotAngle : 0, e._lightBufferData.set(AY, f * h + 2 * c), r && (Kn.toArray(AY, i.direction), e._lightBufferData.set(AY, f * h + 3 * c)), f++ } }, _ = p(s); !(i = _()).done;)d(i.value, !1); for (var g, m = p(a); !(g = m()).done;)d(g.value, !0); var v = 3 * c + 3; this._lightBufferData.set([f], v), r.updateBuffer(this._lightVolumeBuffer, this._lightBufferData) } }, e.update = function () { 64 & this.blit.sceneFlags && this.blit.camera && !this._isGatherLight && (this._gatherVolumeLights(this.blit.camera), this._isGatherLight = !0, this._isUpdate = !1), this._isUpdate || (this._stageDesc.update(), this._isUpdate = !0) }, e.reset = function () { this._isUpdate = !1, this._isGatherLight = !1 }, e.createStageDescriptor = function () { var t = this.blit, e = t.material.passes[t.passID], i = mY.device; if (this._stageDesc = mY.blit.stageDescs.get(e) || i.createDescriptorSet(new Dp(e.localSetLayout)), mY.blit.stageDescs.set(e, this._stageDesc), 64 & this.blit.sceneFlags) { this._lightVolumeBuffer = mY.blit.lightVolumeBuffer; var n = mY.blit.deferredLitsBufView; this._lightBufferData = mY.blit.lightBufferData, this._lightBufferData.fill(0), this._stageDesc.bindBuffer(Ab.BINDING, n) } this._stageDesc.bindBuffer(xb.BINDING, mY.blit.emptyLocalUBO) }, n(t, [{ key: "screenQuad", get: function () { return this._screenQuad } }, { key: "blit", get: function () { return this._blit }, set: function (t) { this._blit = t } }, { key: "stageDesc", get: function () { return this._stageDesc } }]), t }(), DY = function () { function t() { this._devicePass = void 0, this._hint = 0, this._phaseID = KS("default"), this._renderPhase = null, this._descSetData = null, this._layoutID = -1, this._isUpdateUBO = !1, this._isUploadInstance = !1, this._isUploadBatched = !1, this._queueId = -1 } var e = t.prototype; return e.preRecord = function () { }, e.postRecord = function () { }, e.init = function (t, e, i) { this.reset(), this.queueHint = e.hint, this.queueId = i, this._devicePass = t, this._phaseID = S.rendering.getPhaseID(t.passID, mY.renderGraph.getLayout(i)) }, e.reset = function () { this._isUpdateUBO = !1, this._isUploadInstance = !1, this._isUploadBatched = !1 }, e.record = function () { this._descSetData && this._descSetData.descriptorSet && mY.commandBuffer.bindDescriptorSet(3, this._descSetData.descriptorSet) }, n(t, [{ key: "phaseID", get: function () { return this._phaseID } }, { key: "layoutID", get: function () { return this._layoutID }, set: function (t) { this._layoutID = t; var e = mY.layoutGraph; this._renderPhase = e.h(1, t) ? e.j(t) : null; var i = e.getLayout(t); this._descSetData = i.getSet(2) } }, { key: "descSetData", get: function () { return this._descSetData } }, { key: "renderPhase", get: function () { return this._renderPhase } }, { key: "queueId", get: function () { return this._queueId }, set: function (t) { this._queueId = t } }, { key: "isUpdateUBO", get: function () { return this._isUpdateUBO }, set: function (t) { this._isUpdateUBO = t } }, { key: "isUploadInstance", get: function () { return this._isUploadInstance }, set: function (t) { this._isUploadInstance = t } }, { key: "isUploadBatched", get: function () { return this._isUploadBatched }, set: function (t) { this._isUploadBatched = t } }, { key: "queueHint", get: function () { return this._hint }, set: function (t) { this._hint = t } }, { key: "devicePass", get: function () { return this._devicePass } }]), t }(), RY = function () { function t() { this._renderScenes = [], this._devicePass = void 0, this._hint = 0, this._graphQueue = void 0, this._phaseID = KS("default"), this._renderPhase = null, this._descSetData = null, this._viewport = null, this._scissor = null, this._layoutID = -1, this._isUpdateUBO = !1, this._isUploadInstance = !1, this._isUploadBatched = !1, this._blitDesc = null, this._queueId = -1 } var e = t.prototype; return e.init = function (t, e, i) { this.reset(), this._graphQueue = e, this.queueHint = e.hint; var n = this._viewport = e.viewport; n && (this._scissor = new Nd(n.left, n.top, n.width, n.height)), this.queueId = i, this._devicePass = t, this._phaseID = S.rendering.getPhaseID(t.passID, mY.renderGraph.getLayout(i)) }, e.createBlitDesc = function (t) { this._blitDesc || (this._blitDesc = new CY(t)), this._blitDesc.createScreenQuad(), this._blitDesc.createStageDescriptor() }, e.setScene = function (t, e, i) { var n = mY.pools.addDeviceScene(); return n.init(this, t, e, i), this._renderScenes.push(n), n }, e.reset = function () { var t; this._renderScenes.length = 0, this._isUpdateUBO = !1, this._isUploadInstance = !1, this._isUploadBatched = !1, null == (t = this._blitDesc) || t.reset() }, e.preRecord = function () { }, e.record = function () { this._descSetData && this._descSetData.descriptorSet && mY.commandBuffer.bindDescriptorSet(3, this._descSetData.descriptorSet), this._renderScenes.forEach((function (t) { t.record() })) }, e.postRecord = function () { }, n(t, [{ key: "phaseID", get: function () { return this._phaseID } }, { key: "layoutID", get: function () { return this._layoutID }, set: function (t) { this._layoutID = t; var e = mY.layoutGraph; this._renderPhase = e.h(1, t) ? e.j(t) : null; var i = e.getLayout(t); this._descSetData = i.getSet(2) } }, { key: "descSetData", get: function () { return this._descSetData } }, { key: "renderPhase", get: function () { return this._renderPhase } }, { key: "viewport", get: function () { return this._viewport } }, { key: "scissor", get: function () { return this._scissor } }, { key: "queueId", get: function () { return this._queueId }, set: function (t) { this._queueId = t } }, { key: "isUpdateUBO", get: function () { return this._isUpdateUBO }, set: function (t) { this._isUpdateUBO = t } }, { key: "isUploadInstance", get: function () { return this._isUploadInstance }, set: function (t) { this._isUploadInstance = t } }, { key: "isUploadBatched", get: function () { return this._isUploadBatched }, set: function (t) { this._isUploadBatched = t } }, { key: "graphQueue", get: function () { return this._graphQueue } }, { key: "blitDesc", get: function () { return this._blitDesc } }, { key: "renderScenes", get: function () { return this._renderScenes } }, { key: "queueHint", get: function () { return this._hint }, set: function (t) { this._hint = t } }, { key: "devicePass", get: function () { return this._devicePass } }]), t }(), PY = function () { function t(t, e, i) { this._layoutID = 0, this._vertID = -1, this._resID = -1, this._stage = null, this._layout = void 0, this._inputName = void 0, this._descriptorSet = null, this._inputName = i[0], this._layoutID = t, this._vertID = e; var n = mY.layoutGraph; this._stage = n.j(t), this._layout = n.getLayout(t); var r = this._layout.getSet(3); if (r) { var s = r.descriptorSet, a = mY.deviceTextures.get(this._inputName), o = null == a ? void 0 : a.texture, u = mY.deviceBuffers.get(this._inputName), h = null == u ? void 0 : u.buffer; if (!o && !h) throw Error("Could not find texture with resource name " + this._inputName); this._resID = mY.resourceGraph.vertex(this._inputName); for (var c, l = mY.resourceGraph.getSampler(this._resID), f = p(i[1]); !(c = f()).done;) { var d = c.value.name, _ = n.attributeIndex.get(d); void 0 !== _ && this.bindDescriptor(s, _, o, h, l, i[1][0].accessType) } } } return t.prototype.bindDescriptor = function (t, e, i, n, r, s) { for (var a, o = this._layout.getSet(3), u = mY.resourceGraph.getDesc(this._resID), h = p(o.descriptorSetLayoutData.descriptorBlocks); !(a = h()).done;)for (var c = a.value, l = 0; l < c.descriptors.length; ++l)if (e === c.descriptors[l].descriptorID) { var f = c.offset; if (i) { t.bindTexture(f + l, i); var d = mY.renderGraph.getData(this._vertID).samplers.get(e) || mY.device.getSampler(r); t.bindSampler(f + l, d) } else if (4 & u.flags) { var _ = 0 !== s ? 8388608 : 32768; t.bindBuffer(c.offset + l, n, 0, _) } else t.bindBuffer(f + l, n); this._descriptorSet || (this._descriptorSet = t); break } }, n(t, [{ key: "descriptorSet", get: function () { return this._descriptorSet } }, { key: "layoutID", get: function () { return this._layoutID } }, { key: "vertID", get: function () { return this._vertID } }, { key: "stage", get: function () { return this._stage } }, { key: "layout", get: function () { return this._layout } }]), t }(), BY = new jd, MY = new Nd, OY = new xY, LY = function () { function t(t, e) { this._renderPass = void 0, this._framebuffer = void 0, this._clearColor = [], this._deviceQueues = new Map, this._clearDepth = 1, this._clearStencil = 0, this._passID = void 0, this._rasterID = void 0, this._rasterPass = void 0, this._layoutName = void 0, this._viewport = null, this._layout = null, this._idxOfRenderData = 0, this._rasterID = t, this._rasterPass = e; var i = mY.device; this._layoutName = mY.renderGraph.getLayout(t), this._passID = S.rendering.getPassID(this._layoutName); var n = new vp; n.format = 55; for (var r, s = [], a = [], o = null, u = null, h = null, c = p(e.rasterViews); !(r = c()).done;) { var l = r.value, f = l[0], d = l[1], _ = mY.deviceTextures.get(f); if (_) { var g = mY.resourceGraph, m = g.vertex(f), v = g.object(m); if (_.framebuffer && v instanceof u_ && _.framebuffer !== v) _.framebuffer = v; else if (_.texture) { var y = g.getDesc(m); _.texture.width === y.width && _.texture.height === y.height || _.texture.resize(y.width, y.height) } } else this.visitResource(f), _ = mY.deviceTextures.get(f); if (u || (u = _.swapchain), h || (h = _.framebuffer), 0 === d.attachmentType) { _.swapchain || _.framebuffer || a.push(_.texture); var b = new mp; b.format = _.description.format, b.sampleCount = _.description.sampleCount, b.loadOp = d.loadOp, b.storeOp = d.storeOp, b.barrier = i.getGeneralBarrier(new Sp(0 === d.loadOp ? 2097152 : 0, 0 === d.storeOp ? 2097152 : 0)); var w = new Xd; w.copy(d.clearColor), this._clearColor.push(w), s.push(b) } else 1 === d.attachmentType && (n.depthStoreOp = d.storeOp, n.stencilStoreOp = d.storeOp, n.depthLoadOp = d.loadOp, n.stencilLoadOp = d.loadOp, n.barrier = i.getGeneralBarrier(new Sp(0 === d.loadOp ? 4194304 : 0, 0 === d.storeOp ? 4194304 : 0)), _.swapchain || _.framebuffer ? _.swapchain && (o = _.swapchain.depthStencilTexture) : o = _.texture, this._clearDepth = d.clearColor.x, this._clearStencil = d.clearColor.y) } if (0 === s.length) { var x = new mp; s.push(x) } if (0 === a.length && !u && !h) { var T = i.createTexture(new ip); a.push(T) } var I = new wp; I.colorAttachments = s, (u ? u.depthStencilTexture : o) && (I.depthStencilAttachment = n), this._renderPass = i.createRenderPass(I), this._createFramebuffer(h, u ? [u.colorTexture] : a, u ? u.depthStencilTexture : o) } var e = t.prototype; return e.addIdxOfRD = function () { this._idxOfRenderData++ }, e.visitResource = function (t) { var e = mY.resourceGraph, i = e.vertex(t); OY.resName = t, e.visitVertex(OY, i) }, e.addQueue = function (t) { this._deviceQueues.set(t.queueId, t) }, e.preRecord = function () { mY.passDescriptorSet = DX(this.layoutName).descriptorSet }, e._applyRenderLayout = function (t) { var e = mY.renderGraph.getLayout(this._rasterID); if (e) { var i = mY.layoutGraph, n = i.locateChild(i.N, e); 4294967295 !== n && (this._layout = new PY(n, this._rasterID, t)) } }, e.getGlobalDescData = function () { var t = mY.layoutGraph.locateChild(mY.layoutGraph.N, "default"); return mY.layoutGraph.getLayout(t).getSet(3) }, e._applyViewport = function () { this._viewport = null; var t = this._rasterPass.viewport; 0 === t.left && 0 === t.top && 0 === t.width && 0 === t.height || (this._viewport = t) }, e._showProfiler = function (t) { var e = mY.pipeline.profiler; if (e && e.enabled) { var i = mY.profilerDescriptorSet, n = this._renderPass, r = mY.commandBuffer, s = e.subModels[0], a = s.passes[0], o = s.inputAssembler; BY.width = t.width, BY.height = t.height, r.setViewport(BY), r.setScissor(t), r.bindDescriptorSet(0, i), dq(r, n, a, s.descriptorSet, s.shaders[0], o) } }, e.beginPass = function () { var t = this.framebuffer.colorTextures[0]; this._applyViewport(t); var e = mY.commandBuffer; this._viewport ? (MY.x = this._viewport.left, MY.y = this._viewport.top, MY.width = this._viewport.width, MY.height = this._viewport.height) : (MY.y = MY.x = 0, MY.width = t.width, MY.height = t.height), e.beginRenderPass(this.renderPass, this.framebuffer, MY, this.clearColor, this.clearDepth, this.clearStencil), mY.passDescriptorSet && e.bindDescriptorSet(0, mY.passDescriptorSet) }, e.endPass = function () { mY.commandBuffer.endRenderPass() }, e.record = function () { this.beginPass(); for (var t, e = p(this._deviceQueues.values()); !(t = e()).done;)t.value.record(); this._rasterPass.showStatistics && this._showProfiler(MY), this.endPass() }, e.postRecord = function () { }, e._processRenderLayout = function (t) { for (var e, i = p(t.computeViews); !(e = i()).done;) { var n = e.value; this._applyRenderLayout(n) } this.renderLayout && this.renderLayout.descriptorSet && this.renderLayout.descriptorSet.update() }, e.processRenderLayout = function () { this._processRenderLayout(this._rasterPass) }, e._createFramebuffer = function (t, e, i) { (t || e.length) && (this._framebuffer && t !== this._framebuffer && this._framebuffer.destroy(), this._framebuffer = t || mY.device.createFramebuffer(new Ep(this._renderPass, e, i))) }, e.resetResource = function (t, e) { var i, n, r, s; this._rasterID = t, this._rasterPass = e, this._layoutName = mY.renderGraph.getLayout(t), this._passID = S.rendering.getPassID(this._layoutName), this._deviceQueues.clear(), this._idxOfRenderData = 0; for (var a, o = null, u = [], h = this._framebuffer, c = null !== (i = null == h ? void 0 : h.depthStencilTexture) && void 0 !== i ? i : null, l = h ? c : null, f = null !== (n = null == h ? void 0 : h.width) && void 0 !== n ? n : 0, d = null !== (r = null == h ? void 0 : h.height) && void 0 !== r ? r : 0, _ = 0, g = 0, m = p(e.rasterViews); !(a = m()).done;) { var v = a.value, y = v[0]; if (2 !== v[1].attachmentType) { var b = mY.resourceGraph.getDesc(mY.resourceGraph.vertex(y)); _ = b.width, g = b.height; break } } for (var w, x = (null == h ? void 0 : h.colorTextures.some((function (t) { return !t || 0 === t.getTextureHandle() }))) || c && 0 === c.getTextureHandle(), T = _ !== f || g !== d || null !== (s = null == h ? void 0 : h.needRebuild) && void 0 !== s && s || x, I = p(e.rasterViews); !(w = I()).done;) { var E = w.value, A = E[0], C = E[1], D = mY.deviceTextures.get(A); D || (this.visitResource(A), D = mY.deviceTextures.get(A)); var R = mY.resourceGraph, P = R.vertex(A), B = R.object(P), M = R.getDesc(P); if (D.framebuffer && B instanceof u_ && (D.framebuffer !== B || B !== this._framebuffer)) o = this._framebuffer = D.framebuffer = B; else if (D.texture && T) { var O = D.texture; O.resize(M.width, M.height), 0 === C.attachmentType ? u.push(O) : 1 === C.attachmentType && (l = O) } } this._createFramebuffer(o, u, l) }, n(t, [{ key: "indexOfRD", get: function () { return this._idxOfRenderData } }, { key: "rasterID", get: function () { return this._rasterID } }, { key: "layoutName", get: function () { return this._layoutName } }, { key: "passID", get: function () { return this._passID } }, { key: "renderLayout", get: function () { return this._layout } }, { key: "renderPass", get: function () { return this._renderPass } }, { key: "framebuffer", get: function () { return this._framebuffer } }, { key: "clearColor", get: function () { return this._clearColor } }, { key: "clearDepth", get: function () { return this._clearDepth } }, { key: "clearStencil", get: function () { return this._clearStencil } }, { key: "deviceQueues", get: function () { return this._deviceQueues } }, { key: "viewport", get: function () { return this._viewport } }]), t }(), FY = function () { function t() { this._id = void 0, this._pass = void 0 } return t.prototype.applyInfo = function (t, e) { this._id = t, this._pass = e }, n(t, [{ key: "id", get: function () { return this._id } }, { key: "pass", get: function () { return this._pass } }]), t }(), kY = function () { function t(t) { this._deviceQueues = [], this._passID = void 0, this._layoutName = void 0, this._viewport = null, this._computeInfo = void 0, this._layout = null, this._computeInfo = t, this._layoutName = mY.renderGraph.getLayout(t.id), this._passID = S.rendering.getPassID(this._layoutName); for (var e, i = p(t.pass.computeViews); !(e = i()).done;) { var n = e.value, r = mY.deviceTextures.get(n[0]); r || (this.visitResource(n[0]), r = mY.deviceTextures.get(n[0])), this._applyRenderLayout(n) } this.renderLayout && this.renderLayout.descriptorSet && this.renderLayout.descriptorSet.update() } var e = t.prototype; return e.preRecord = function () { mY.passDescriptorSet = DX(this.layoutName).descriptorSet }, e.postRecord = function () { }, e.visitResource = function (t) { var e = mY.resourceGraph, i = e.vertex(t); OY.resName = t, e.visitVertex(OY, i) }, e.addQueue = function (t) { this._deviceQueues.push(t) }, e._applyRenderLayout = function (t) { var e = mY.renderGraph.getLayout(this._computeInfo.id); if (e) { var i = mY.layoutGraph, n = i.locateChild(i.N, e); 4294967295 !== n && (this._layout = new PY(n, this._computeInfo.id, t)) } }, e.getGlobalDescData = function () { var t = mY.layoutGraph.locateChild(mY.layoutGraph.N, "default"); return mY.layoutGraph.getLayout(t).getSet(3) }, e.record = function () { var t = mY.commandBuffer; mY.passDescriptorSet && t.bindDescriptorSet(0, mY.passDescriptorSet); for (var e, i = p(this._deviceQueues); !(e = i()).done;)e.value.record(); RX(mY.renderGraph.getData(this._computeInfo.id), -1, 0, mY.renderGraph.getLayout(this._computeInfo.id)) }, e.resetResource = function (t, e) { this._computeInfo.applyInfo(t, e), this._layoutName = mY.renderGraph.getLayout(t), this._passID = S.rendering.getPassID(this._layoutName), this._deviceQueues.length = 0; for (var i, n = p(this._computeInfo.pass.computeViews); !(i = n()).done;) { var r = i.value; this._applyRenderLayout(r) } this.renderLayout && this.renderLayout.descriptorSet && this.renderLayout.descriptorSet.update() }, n(t, [{ key: "layoutName", get: function () { return this._layoutName } }, { key: "passID", get: function () { return this._passID } }, { key: "renderLayout", get: function () { return this._layout } }, { key: "deviceQueues", get: function () { return this._deviceQueues } }, { key: "computePassInfo", get: function () { return this._computeInfo } }]), t }(), NY = new jd, zY = function () { function t() { this._currentQueue = void 0, this._renderPass = void 0, this._scene = null, this._camera = null, this._sceneData = void 0, this._blit = void 0, this._sceneID = -1 } var e = t.prototype; return e.preRecord = function () { this._blit && (this._currentQueue.createBlitDesc(this._blit), this._currentQueue.blitDesc.update()), mY.lightResource.buildLightBuffer(mY.commandBuffer), mY.lightResource.tryUpdateRenderSceneLocalDescriptorSet(mY.culling) }, e.postRecord = function () { }, e.init = function (t, e, i, n) { this._currentQueue = t, this._sceneData = i, this._blit = n, this._sceneID = e, this._renderPass = t.devicePass.renderPass; var r = i && i.camera ? i.camera : null; r && (this._scene = r.scene, this._camera = r) }, e._recordUI = function () { for (var t = this.camera.scene.batches, e = 0; e < t.length; e++) { var i = t[e], n = !1; if (this.camera.visibility & i.visFlags && (n = !0), n) for (var r = i.shaders.length, s = 0; s < r; s++) { var a = i.passes[s]; if (a.phaseID === this._currentQueue.phaseID) { var o = i.shaders[s], u = i.inputAssembler, h = i.descriptorSet; dq(mY.commandBuffer, this._renderPass, a, h, o, u) } } } }, e._recordBlit = function () { if (this.blit) { var t = this.blit, e = t.material.passes[t.passID]; e.update(); var i = e.getShaderVariant(), n = this._currentQueue.blitDesc, r = n.screenQuad.quadIA; dq(mY.commandBuffer, this._renderPass, e, n.stageDesc, i, r) } }, e._updateGlobal = function (t, e) { var i = this._currentQueue.devicePass; i.addIdxOfRD(), RX(t, e, i.indexOfRD, mY.renderGraph.getLayout(i.rasterID)) }, e._updateRenderData = function () { var t; if (!this._currentQueue.isUpdateUBO) { var e = this._currentQueue.devicePass, i = e.rasterID, n = mY.renderGraph.getData(i), r = this.sceneID; this._updateGlobal(n, r); var s = this._currentQueue.queueId, a = mY.renderGraph.getData(s); this._updateGlobal(a, r); var o = mY.renderGraph.getData(r); o && this._updateGlobal(o, r), e.processRenderLayout(), null == (t = mY.passDescriptorSet) || t.update(), this._currentQueue.isUpdateUBO = !0 } }, e._applyViewport = function () { var t = this._currentQueue.viewport; if (t) mY.commandBuffer.setViewport(t), mY.commandBuffer.setScissor(this._currentQueue.scissor); else if (!this._currentQueue.devicePass.viewport) { var e = this._currentQueue.devicePass.framebuffer.colorTextures[0], i = this.sceneData ? this.sceneData.light : null, n = IY(this.sceneData) && this.sceneData && i.light ? yX(this.camera, e.width, e.height, i.light, i.level) : yX(this.camera, e.width, e.height); NY.left = n.x, NY.top = n.y, NY.width = n.width, NY.height = n.height, mY.commandBuffer.setViewport(NY), mY.commandBuffer.setScissor(n) } }, e.record = function () { var t = this._currentQueue.devicePass, e = mY.culling; if (this._updateRenderData(), this._applyViewport(), this.blit) this._recordBlit(); else { var i, n = e.renderQueueQueryIndex.get(this.sceneID), r = e.renderQueues[n.renderQueueTarget], s = this.sceneData, a = WX(8192 & s.flags); a && r.probeQueue.applyMacro(), r.recordCommands(mY.commandBuffer, this._renderPass, s.flags), a && r.probeQueue.removeMacro(), 512 & s.flags && (null == (i = this.camera.geometryRenderer) || i.render(t.renderPass, mY.commandBuffer, mY.pipeline.pipelineSceneData)), 16 & s.flags && this._recordUI() } }, n(t, [{ key: "blit", get: function () { return this._blit } }, { key: "sceneData", get: function () { return this._sceneData } }, { key: "sceneID", get: function () { return this._sceneID } }, { key: "camera", get: function () { return this._camera } }]), t }(), UY = function () { function t() { this.deviceQueuePool = void 0, this.computeQueuePool = void 0, this.passPool = void 0, this.deviceScenePool = void 0, this.deviceQueuePool = new eo((function () { return new RY }), 16), this.deviceScenePool = new eo((function () { return new zY }), 16), this.computeQueuePool = new eo((function () { return new DY }), 16), this.passPool = new eo((function () { return { priority: 0, hash: 0, depth: 0, shaderId: 0, subModel: null, passIdx: 0 } }), 64) } var e = t.prototype; return e.addDeviceQueue = function () { return this.deviceQueuePool.add() }, e.addComputeQueue = function () { return this.computeQueuePool.add() }, e.addDeviceScene = function () { return this.deviceScenePool.add() }, e.reset = function () { this.deviceQueuePool.reset(), this.computeQueuePool.reset(), this.deviceScenePool.reset() }, t }(), VY = new Nd, GY = function () { function t(t) { this._pipelineIAData = void 0, this._context = void 0, this._width = void 0, this._height = void 0, this._lightVolumeBuffer = void 0, this._lightBufferData = void 0, this._deferredLitsBufView = void 0, this._localUBO = void 0, this._stageDescs = new Map, this._context = t, this._width = t.width, this._height = t.height, this._pipelineIAData = this._createQuadInputAssembler(); var e = this._genQuadVertexData(0, new Nd(0, 0, t.width, t.height)); this._pipelineIAData.quadVB.update(e), this._createLightVolumes(), this._localUBO = t.device.createBuffer(new Zd(18, 1, 224, 224)) } var e = t.prototype; return e.resize = function (t, e) { if (t !== this._width || e !== this._height) { VY.y = VY.x = 0, VY.width = t, VY.height = e; var i = this._genQuadVertexData(0, VY); this._pipelineIAData.quadVB.update(i) } }, e._createLightVolumes = function () { var t = this._context.root.device, e = 80 * Cb.LIGHTS_PER_PASS; e = Math.ceil(e / t.capabilities.uboOffsetAlignment) * t.capabilities.uboOffsetAlignment, this._lightVolumeBuffer = t.createBuffer(new Zd(18, 3, e, t.capabilities.uboOffsetAlignment)), this._deferredLitsBufView = t.createBuffer(new Jd(this._lightVolumeBuffer, 0, e)), this._lightBufferData = new Float32Array(e / 4) }, e._genQuadVertexData = function (t, e) { var i = e.x / this._context.width, n = (e.x + e.width) / this._context.width, r = e.y / this._context.height, s = (e.y + e.height) / this._context.height; if (this._context.root.device.capabilities.screenSpaceSignY > 0) { var a = [s, r]; r = a[0], s = a[1] } var o = new Float32Array(16), u = function (t, e, i, n, r, s, a, u, h, c, l, f, d, p, _, g) { o.set([t, e, i, n, r, s, a, u, h, c, l, f, d, p, _, g]) }; switch (t) { case 0: u(-1, -1, i, s, 1, -1, n, s, -1, 1, i, r, 1, 1, n, r); break; case 1: u(-1, -1, n, s, 1, -1, n, r, -1, 1, i, s, 1, 1, i, r); break; case 2: u(-1, -1, i, r, 1, -1, n, r, -1, 1, i, s, 1, 1, n, s); break; case 3: u(-1, -1, i, r, 1, -1, i, s, -1, 1, n, r, 1, 1, n, s) }return o }, e._createQuadInputAssembler = function () { var t = new xB, e = S.director.root.device, i = e.createBuffer(new Zd(10, 3, 64, 16)); if (!i) return t; var n = e.createBuffer(new Zd(6, 1, 12, 2)); if (!n) return t; var r = new Uint16Array(6); r[0] = 0, r[1] = 1, r[2] = 2, r[3] = 1, r[4] = 3, r[5] = 2, n.update(r.buffer); var s = new Array(2); s[0] = new pp("a_position", 21), s[1] = new pp("a_texCoord", 21); var a = e.createInputAssembler(new gp(s, [i], n)); return t.quadIB = n, t.quadVB = i, t.quadIA = a, t }, n(t, [{ key: "pipelineIAData", get: function () { return this._pipelineIAData } }, { key: "deferredLitsBufView", get: function () { return this._deferredLitsBufView } }, { key: "lightVolumeBuffer", get: function () { return this._lightVolumeBuffer } }, { key: "lightBufferData", get: function () { return this._lightBufferData } }, { key: "stageDescs", get: function () { return this._stageDescs } }, { key: "emptyLocalUBO", get: function () { return this._localUBO } }]), t }(), HY = function () { function t(t, e, i, n, r, s, a, o) { void 0 === o && (o = null), this.device = void 0, this.pipeline = void 0, this.commandBuffer = void 0, this.pipelineSceneData = void 0, this.resourceGraph = void 0, this.devicePasses = new Map, this.deviceTextures = new Map, this.deviceBuffers = new Map, this.layoutGraph = void 0, this.root = void 0, this.pools = void 0, this.blit = void 0, this.culling = void 0, this.lightResource = new wY, this.renderGraph = void 0, this.width = void 0, this.height = void 0, this.cullCamera = void 0, this.passDescriptorSet = void 0, this.profilerDescriptorSet = void 0, this.pipeline = t, this.device = e, this.commandBuffer = e.commandBuffer, this.pipelineSceneData = t.pipelineSceneData, this.resourceGraph = i, this.renderGraph = n, this.root = T.director.root, this.layoutGraph = r, this.width = s, this.height = a, this.pools = new UY, this.blit = new GY(this), this.culling = new bY, this.passDescriptorSet = o, this.profilerDescriptorSet = DX("default").descriptorSet } var e = t.prototype; return e.reset = function () { this.culling.clear(), this.pools.reset(), this.cullCamera = null, this.lightResource.clear() }, e.resize = function (t, e) { this.width = t, this.height = e, this.blit.resize(t, e) }, t }(), WY = function () { function t(t, e, i, n, r, s) { this._context = void 0, this._visitor = void 0, mY = this._context = new HY(t, e, i, new Oj, n, r, s); var a = S.rendering.programLib; mY.lightResource.init(a, e, 16) } var e = t.prototype; return e.resize = function (t, e) { mY.resize(t, e) }, e._removeDeviceResource = function () { for (var t, e = mY.pipeline.resourceUses, i = [], n = mY.deviceTextures, r = p(n); !(t = r()).done;) { var s = t.value, a = s[0]; s[1]; var o = mY.resourceGraph.vertex(a), u = mY.resourceGraph.getTraits(o); e.includes(a) || 0 !== u.residency || i.push(a) } for (var h = 0, c = i; h < c.length; h++) { var l = c[h]; n.get(l).release(), n.delete(l) } for (var f, d = [], _ = mY.deviceBuffers, g = p(_); !(f = g()).done;) { var m = f.value, v = m[0]; m[1]; var y = mY.resourceGraph.vertex(v), b = mY.resourceGraph.getTraits(y); e.includes(v) || 0 !== b.residency || d.push(v) } for (var w = 0, x = d; w < x.length; w++) { var S = x[w]; _.get(S).release(), _.delete(S) } e.length = 0 }, e.execute = function (t) { mY.renderGraph = t, mY.reset(); var e = mY.commandBuffer, i = mY.culling; i.buildRenderQueues(t, mY.layoutGraph, mY.pipelineSceneData), mY.lightResource.buildLights(i, mY.pipelineSceneData.isHDR, mY.pipelineSceneData.shadows), this._removeDeviceResource(), e.begin(), i.uploadInstancing(e), this._visitor || (this._visitor = new YY), YW(this._visitor.graphView, this._visitor, this._visitor.colorMap), e.end(), mY.device.queue.submit([e]) }, e.release = function () { mY.devicePasses.clear(); for (var t, e = p(mY.deviceTextures); !(t = e()).done;) { var i = t.value; i[0], i[1].release() } mY.deviceTextures.clear(); for (var n, r = p(mY.deviceBuffers); !(n = r()).done;) { var s = n.value; s[0], s[1].release() } mY.deviceBuffers.clear() }, t }(), jY = function () { function t() { this.queueID = 4294967295, this.sceneID = 4294967295, this.passID = 4294967295, this.dispatchID = 4294967295, this.currPass = void 0, this.currQueue = void 0, this.rg = void 0, this.rg = mY.renderGraph } var e = t.prototype; return e._isRasterPass = function (t) { return mY.renderGraph.h(0, t) }, e.isComputePass = function (t) { return mY.renderGraph.h(3, t) }, e.isDispatch = function (t) { return mY.renderGraph.h(11, t) }, e._isQueue = function (t) { return mY.renderGraph.h(8, t) }, e._isScene = function (t) { return mY.renderGraph.h(9, t) }, e._isBlit = function (t) { return mY.renderGraph.h(10, t) }, e.applyID = function (t) { this._isRasterPass(t) ? this.passID = t : this._isQueue(t) ? this.queueID = t : this._isScene(t) || this._isBlit(t) ? this.sceneID = t : this.isComputePass(t) ? this.passID = t : this.isDispatch(t) && (this.dispatchID = t) }, t }(), XY = function (t) { function e() { return t.call(this) || this } s(e, t); var i = e.prototype; return i.clear = function () { }, i.viewport = function () { }, i.rasterPass = function (t) { if (this.rg.getValid(this.passID)) { var e = mY.devicePasses, i = t.hashValue; this.currPass = e.get(i), this.currPass ? this.currPass.resetResource(this.passID, t) : (this.currPass = new LY(this.passID, t), e.set(i, this.currPass)), this.currPass.preRecord() } }, i.rasterSubpass = function () { }, i.computeSubpass = function () { }, i.resolve = function () { }, i.move = function () { }, i.raytrace = function () { }, i.compute = function (t) { if (this.rg.getValid(this.passID)) { mY.devicePasses; var e = new FY; e.applyInfo(this.passID, t), this.currPass = new kY(e), this.currPass.preRecord(), this.currPass.record() } }, i.copy = function (t) { if (t.uploadPairs.length) for (var e, i = p(t.uploadPairs); !(e = i()).done;) { var n = e.value, r = mY.deviceBuffers, s = mY.resourceGraph, a = s.vertex(n.target); OY.resName = n.target, s.visitVertex(OY, a); var o = r.get(n.target); mY.device.commandBuffer.updateBuffer(o.buffer, n.source, n.source.byteLength) } }, i.queue = function (t) { if (this.rg.getValid(this.queueID)) { var e; this.currPass instanceof LY ? ((e = mY.pools.addDeviceQueue()).init(this.currPass, t, this.queueID), this.currQueue = e, this.currPass.addQueue(e)) : ((e = mY.pools.addComputeQueue()).init(this.currPass, t, this.queueID), this.currQueue = e, this.currPass.addQueue(e)); var i = this.rg.getLayout(this.queueID); if (i) { var n = mY.layoutGraph; if (this.currPass.renderLayout) { var r = n.locateChild(this.currPass.renderLayout.layoutID, i); this.currQueue.layoutID = r } } this.currQueue.preRecord() } }, i.scene = function (t) { this.rg.getValid(this.sceneID) && this.currQueue.setScene(this.sceneID, t).preRecord() }, i.blit = function (t) { this.rg.getValid(this.sceneID) && this.currQueue.setScene(this.sceneID, void 0, t).preRecord() }, i.dispatch = function (t) { var e, i = null, n = this.currPass, r = null == (e = t.material) ? void 0 : e.passes[t.passID]; null == r || r.update(); var s = null == r ? void 0 : r.getShaderVariant(); if (null !== r && null !== s) { var a = new m_(s, null == r ? void 0 : r.pipelineLayout); a.bindPoint = 1, i = B_.gfxDevice.createPipelineState(a) } var o = mY.commandBuffer; if (i) { o.bindPipelineState(i); var u = n.renderLayout.descriptorSet; o.bindDescriptorSet(0, u) } var h = t.threadGroupCountX, c = t.threadGroupCountY, l = t.threadGroupCountZ; o.dispatch(new tp(h, c, l)) }, e }(jY), qY = function (t) { function e() { return t.call(this) || this } s(e, t); var i = e.prototype; return i.clear = function () { }, i.viewport = function () { }, i.rasterPass = function (t) { var e = mY.devicePasses, i = t.hashValue, n = e.get(i); n && (this.currPass = n, this.currPass.record()) }, i.rasterSubpass = function () { }, i.computeSubpass = function () { }, i.resolve = function () { }, i.compute = function () { }, i.copy = function () { }, i.move = function () { }, i.raytrace = function () { }, i.queue = function () { }, i.scene = function () { }, i.blit = function () { }, i.dispatch = function () { }, e }(jY), YY = function (t) { function e() { var e; return (e = t.call(this) || this)._preVisitor = void 0, e._postVisitor = void 0, e._graphView = void 0, e._colorMap = void 0, e._preVisitor = new XY, e._postVisitor = new qY, e._graphView = new QW(mY.renderGraph), e._colorMap = new gX(mY.renderGraph.nv()), e } s(e, t); var i = e.prototype; return i.discoverVertex = function (t, e) { var i = e.g; this._preVisitor.applyID(t), i.visitVertex(this._preVisitor, t) }, i.finishVertex = function (t, e) { e.g.visitVertex(this._postVisitor, t) }, n(e, [{ key: "graphView", get: function () { return this._graphView } }, { key: "colorMap", get: function () { return this._colorMap } }]), e }(KW), KY = new Map, QY = function () { function t(t) { this.queueID = 4294967295, this.sceneID = 4294967295, this.passID = 4294967295, this.dispatchID = 4294967295, this.resID = 4294967295, this.context = void 0, this._currPass = null, this._resVisitor = void 0, this.context = t, this._resVisitor = new JY(this.context) } var e = t.prototype; return e._isRasterPass = function (t) { return this.context.renderGraph.h(0, t) }, e._isCopyPass = function (t) { return this.context.renderGraph.h(5, t) }, e._isCompute = function (t) { return this.context.renderGraph.h(3, t) }, e._isDispatch = function (t) { return this.context.renderGraph.h(11, t) }, e._isQueue = function (t) { return this.context.renderGraph.h(8, t) }, e._isShadowMap = function (t) { var e = this._getSceneData(t); return !!e && e.light && !!e.light.light && !!(8 & e.flags) }, e._getSceneData = function (t) { return this.context.renderGraph.h(9, t) ? this.context.renderGraph.j(t) : null }, e._isScene = function (t) { return this.context.renderGraph.h(9, t) }, e._isBlit = function (t) { return this.context.renderGraph.h(10, t) }, e._useResourceInfo = function (t, e) { var i = this.context.resourceContext, n = i.get(t), r = this.context.resourceGraph; if (n) { var s = n.rasters; if (s.get(this.passID) === e) return; for (var a, o = n.computes, u = p(s); !(a = u()).done;) { var h = a.value; h[0], h[1], this.passID } for (var c, l = p(o); !(c = l()).done && !(c.value[0] > this.passID);); s.set(this.passID, e) } else { var f = r.vertex(t); r.getTraits(f).residency; var d = new $Y; i.set(t, d), d.rasters.set(this.passID, e) } }, e._fetchValidPass = function () { var t = this.context.renderGraph, e = this.context.resourceContext, i = this.resID, n = this.context.resourceGraph.vertexName(i); KY.clear(); for (var r, s = this._currPass, a = t.getValid(this.passID), o = p(s.rasterViews); !(r = o()).done;) { var u = r.value, h = u[0], c = u[1]; h !== n || 0 === c.accessType ? 2 !== c.accessType && KY.set(h, c) : (this._useResourceInfo(h, c), t.setValid(this.passID, !0), t.setValid(this.queueID, !0), t.setValid(this.sceneID, !0)) } if (!a && t.getValid(this.sceneID)) { for (var l, f = p(s.rasterViews); !(l = f()).done;) { var d = l.value, _ = d[0]; d[1], eK.pipeline.resourceUses.push(_) } for (var g, m, v, y = p(KY); !(v = y()).done;) { var b = v.value, w = b[0]; b[1], 4294967295 !== (m = (g = this.context.resourceGraph).find(w)) && (this._resVisitor.resID = m, g.visitVertex(this._resVisitor, m)) } for (var x, S = p(s.computeViews); !(x = S()).done;) { var T = x.value, I = T[0], E = T[1], A = e.get(I); A || (A = new $Y, e.set(I, A)); var C = A.computes, D = C.get(this.passID); D ? D.push(E) : C.set(this.passID, [E]), 4294967295 !== (m = (g = this.context.resourceGraph).find(I)) && (this._resVisitor.resID = m, g.visitVertex(this._resVisitor, m)) } qX(s) } }, e.applyID = function (t, e) { this.resID = e, this._isRasterPass(t) || this._isCopyPass(t) || this._isCompute(t) ? this.passID = t : this._isQueue(t) ? this.queueID = t : this._isScene(t) || this._isBlit(t) ? this.sceneID = t : this._isDispatch(t) && (this.dispatchID = t) }, e.rasterPass = function (t) { this._currPass = t }, e.rasterSubpass = function () { }, e.computeSubpass = function () { }, e.compute = function (t) { this._currPass = t, eK.renderGraph.setValid(this.passID, !0) }, e.resolve = function () { }, e.copy = function (t) { var e = eK.renderGraph; if (!e.getValid(this.passID)) { var i = this.context.resourceGraph; this._currPass = t; for (var n, r, s = this.resID, a = i.vertexName(s), o = p(t.copyPairs); !(r = o()).done;) { var u = r.value; u.target === a && (e.setValid(this.passID, !0), 4294967295 !== (n = i.find(u.source)) && (this._resVisitor.resID = n, i.visitVertex(this._resVisitor, n))) } } }, e.move = function () { }, e.raytrace = function () { }, e.queue = function () { }, e.scene = function () { this._fetchValidPass() }, e.blit = function () { this._fetchValidPass() }, e.dispatch = function () { var t = this.context.renderGraph; t.setValid(this.queueID, !0), t.setValid(this.dispatchID, !0) }, e.clear = function () { }, e.viewport = function () { }, t }(), ZY = function (t) { function e(e, i) { var n; return (n = t.call(this) || this)._colorMap = void 0, n._graphView = void 0, n._passVisitor = void 0, n._resId = 4294967295, n._resId = i, n._passVisitor = new QY(e), n._graphView = new QW(e.renderGraph), n._colorMap = new gX(e.renderGraph.nv()), n } return s(e, t), e.prototype.discoverVertex = function (t, e) { var i = e.g; this._passVisitor.applyID(t, this.resId), i.visitVertex(this._passVisitor, t) }, n(e, [{ key: "resId", get: function () { return this._resId }, set: function (t) { this._resId = t, this._colorMap.colors.length = eK.renderGraph.nv() } }, { key: "graphView", get: function () { return this._graphView } }, { key: "colorMap", get: function () { return this._colorMap } }]), e }(KW), JY = function () { function t(t) { this._context = void 0, this.resID = 4294967295, this._passManagerVis = void 0, this._context = t } var e = t.prototype; return e.managedBuffer = function () { }, e.managedTexture = function () { }, e.managed = function () { this.dependency() }, e.persistentBuffer = function () { }, e.dependency = function () { this._passManagerVis ? this._passManagerVis.resId = this.resID : this._passManagerVis = new ZY(this._context, this.resID), YW(this._passManagerVis.graphView, this._passManagerVis, this._passManagerVis.colorMap) }, e.persistentTexture = function () { this.dependency() }, e.framebuffer = function () { this.dependency() }, e.swapchain = function () { this.dependency() }, e.formatView = function () { }, e.subresourceView = function () { }, t }(), $Y = function () { this.rasters = new Map, this.computes = new Map }, tK = function () { function t() { this.resourceGraph = void 0, this.pipeline = void 0, this.renderGraph = void 0, this.layoutGraph = void 0, this.resourceContext = void 0 } return t.prototype.set = function (t, e, i, n) { this.pipeline = t, this.resourceGraph = e, this.renderGraph = i, this.layoutGraph = n, this.resourceContext || (this.resourceContext = new Map), this.resourceContext.clear() }, t }(), eK = new tK; !function (t) { function e(e) { var i; return (i = t.call(this) || this)._colorMap = void 0, i._resourceGraph = void 0, i._resVisitor = void 0, i._colorMap = new gX(e.resourceGraph.nv()), i._resourceGraph = e.resourceGraph, i._resVisitor = new JY(e), i } s(e, t), e.prototype.discoverVertex = function (t) { var e = this._resourceGraph.getTraits(t); 0 !== e.residency && 1 !== e.residency && (this._resVisitor.resID = t, this._resourceGraph.visitVertex(this._resVisitor, t)) }, n(e, [{ key: "colorMap", get: function () { return this._colorMap } }]) }(KW); var iK, nK, rK = new Pn, sK = new rp(1, 1, 0, 2, 2, 2), aK = function () { function t() { var t = this; this.renderData = new Bj, this.layoutGraph = new iX, this.rg = new Oj, this.vertId = -1, this.sceneData = new Dj, this.resourceGraph = new wj, this.computePass = new xj, this.rasterPass = new gj, this.rasterSubpass = new pj, this.renderQueue = new Cj, this.sceneBuilder = new eo((function () { return new hK(t.renderData, t.layoutGraph, t.rg, t.vertId, t.sceneData) }), 16), this.renderPassBuilder = new eo((function () { return new fK(t.renderData, t.rg, t.layoutGraph, t.resourceGraph, t.vertId, t.rasterPass, t.getPipelineSceneData()) }), 16), this.computeQueueBuilder = new eo((function () { return new dK(t.renderData, t.rg, t.layoutGraph, t.vertId, t.renderQueue, t.getPipelineSceneData()) }), 16), this.renderQueueBuilder = new eo((function () { return new cK(t.renderData, t.rg, t.layoutGraph, t.vertId, t.renderQueue, t.getPipelineSceneData()) }), 16), this.renderSubpassBuilder = new eo((function () { return new lK(t.renderData, t.rg, t.layoutGraph, t.vertId, t.rasterSubpass, t.getPipelineSceneData()) }), 16), this.computePassBuilder = new eo((function () { return new pK(t.renderData, t.rg, t.layoutGraph, t.resourceGraph, t.vertId, t.computePass, t.getPipelineSceneData()) }), 16), this.samplerInfo = new eo((function () { return new rp }), 16), this.color = new eo((function () { return new Xd }), 16), this.renderCommonObjectPool = new FW, this.renderGraphPool = new Fj(this.renderCommonObjectPool), this.viewport = new eo((function () { return new jd }), 16) } var e = t.prototype; return e.getPipelineSceneData = function () { return T.director.root.pipeline.pipelineSceneData }, e.createColor = function (t, e, i, n) { void 0 === t && (t = 0), void 0 === e && (e = 0), void 0 === i && (i = 0), void 0 === n && (n = 0); var r = this.color.add(); return r.set(t, e, i, n), r }, e.createSamplerInfo = function (t, e, i, n, r, s, a, o) { void 0 === t && (t = 2), void 0 === e && (e = 2), void 0 === i && (i = 0), void 0 === n && (n = 0), void 0 === r && (r = 0), void 0 === s && (s = 0), void 0 === a && (a = 0), void 0 === o && (o = 7); var u = this.samplerInfo.add(); return u.minFilter = t, u.magFilter = e, u.mipFilter = i, u.addressU = n, u.addressV = r, u.addressW = s, u.maxAnisotropy = a, u.cmpFunc = o, u }, e.reset = function () { this.sceneBuilder.reset(), this.renderPassBuilder.reset(), this.computePassBuilder.reset(), this.computeQueueBuilder.reset(), this.renderCommonObjectPool.reset(), this.renderGraphPool.reset(), this.viewport.reset(), this.samplerInfo.reset(), this.color.reset(), this.renderQueueBuilder.reset(), this.renderSubpassBuilder.reset() }, t }(); function oK(t, e) { switch (t) { case 1: return e > 1 ? 4 : 0; case 2: return e > 1 ? 5 : 1; case 3: return 2; case 0: return 1 }return 1 } function uK(t) { switch (t) { case 0: case 4: return 1; case 1: case 5: case 3: return 2; case 2: return 3 }return 2 } var hK = function (t) { function e(e, i, n, r, s) { var a; return (a = t.call(this, e, i) || this)._renderGraph = void 0, a._scene = void 0, a._renderGraph = n, a._scene = s, a._vertID = r, a } s(e, t); var i = e.prototype; return i.update = function (t, e, i, n, r) { this._data = t, this._lg = e, this._renderGraph = i, this._scene = r, this._vertID = n }, i.useLightFrustum = function (t, e, i) { if (void 0 === e && (e = 0), void 0 === i && (i = void 0), this._scene.light.light = t, this._scene.light.level = e, this._scene.light.culledByLight = !0, i && (this._scene.camera = i), !(32768 & this._scene.flags)) { var n = this._renderGraph.getParent(this._vertID), r = this._renderGraph.getParent(n); this._renderGraph.getLayout(r), aq(this, this._scene.camera, t, e) } }, e }(hq), cK = function (t) { function e(e, i, n, r, s, a) { var o; return (o = t.call(this, e, n) || this)._renderGraph = void 0, o._queue = void 0, o._pipeline = void 0, o._renderGraph = i, o._vertID = r, o._queue = s, o._pipeline = a, o } s(e, t); var i = e.prototype; return i.update = function (t, e, i, n, r, s) { this._data = t, this._lg = i, this._renderGraph = e, this._vertID = n, this._queue = r, this._pipeline = s }, i.setArrayBuffer = function () { throw new Error("Method not implemented.") }, i.addSceneOfCamera = function (t, e, i, n) { void 0 === i && (i = 0), void 0 === n && (n = "Camera"); var r = e.light, s = nK.createSceneData(t.scene, t, i, !r || 8 & i ? 1 : 5, r); this._renderGraph.addVertex(9, s, n, "", nK.createRenderData(), !0, this._vertID), this.getParentLayout(); var a = S.director.getScene(); tq(this, t, this._pipeline, t.scene || (a ? a.renderScene : null)), 8 & i || r && 0 !== r.type ? aq(this, t, r, e.level) : uq(this, t) }, i.addScene = function (t, e, i, n) { void 0 === e && (e = 0), void 0 === i && (i = void 0), void 0 === n && (n = void 0); var r = nK.createSceneData(n || t.scene, t, e, !i || 8 & e ? 1 : 5, i), s = nK.createRenderData(), a = this._renderGraph.addVertex(9, r, "Scene", "", s, !0, this._vertID); 32768 & e || (this.getParentLayout(), tq(this, t, this._pipeline, n || t.scene), i && 0 !== i.type ? aq(this, t, i, 0) : 8 & e || uq(this, t)); var o = iK.sceneBuilder.add(); return o.update(s, this._lg, this._renderGraph, a, r), o }, i.addFullscreenQuad = function (t, e, i, n) { void 0 === i && (i = 0), void 0 === n && (n = "Quad"), this._renderGraph.addVertex(10, nK.createBlit(t, e, i, null), n, "", nK.createRenderData(), !0, this._vertID), this.getParentLayout(); var r = S.director.getScene(); tq(this, null, this._pipeline, r ? r.renderScene : null), 8 & i || uq(this, null) }, i.addCameraQuad = function (t, e, i, n) { void 0 === n && (n = 0), this._renderGraph.addVertex(10, nK.createBlit(e, i, n, t), "CameraQuad", "", nK.createRenderData(), !0, this._vertID), this.getParentLayout(); var r = S.director.getScene(); tq(this, t, this._pipeline, t.scene || (r ? r.renderScene : null)), 8 & n || uq(this, t) }, i.clearRenderTarget = function (t, e) { void 0 === e && (e = new Xd); var i = nK.createClearView(t, 1); i.clearColor.copy(e), this._renderGraph.addVertex(12, [i], "ClearRenderTarget", "", nK.createRenderData(), !0, this._vertID) }, i.setViewport = function (t) { var e = iK.viewport.add(); this._queue.viewport = e.copy(t) }, i.addCustomCommand = function () { throw new Error("Method not implemented.") }, n(e, [{ key: "name", get: function () { return this._renderGraph.getName(this._vertID) }, set: function (t) { this._renderGraph.setName(this._vertID, t) } }]), e }(hq), lK = function (t) { function e(e, i, n, r, s, a) { var o; (o = t.call(this, e, n) || this)._renderGraph = void 0, o._layoutID = void 0, o._subpass = void 0, o._pipeline = void 0, o._renderGraph = i, o._vertID = r, o._subpass = s, o._pipeline = a; var u = o._renderGraph.getLayout(o._vertID); return o._layoutID = n.locateChild(n.N, u), o } s(e, t); var i = e.prototype; return i.update = function (t, e, i, n, r, s) { this._data = t, this._lg = i, this._renderGraph = e, this._vertID = n, this._subpass = r, this._pipeline = s; var a = this._renderGraph.getLayout(this._vertID); this._layoutID = i.locateChild(i.N, a) }, i.addRenderTarget = function () { throw new Error("Method not implemented.") }, i.setCustomShaderStages = function () { throw new Error("Method not implemented.") }, i.setArrayBuffer = function () { throw new Error("Method not implemented.") }, i.addDepthStencil = function () { throw new Error("Method not implemented.") }, i.addTexture = function () { throw new Error("Method not implemented.") }, i.addStorageBuffer = function () { throw new Error("Method not implemented.") }, i.addStorageImage = function () { throw new Error("Method not implemented.") }, i.setViewport = function () { throw new Error("Method not implemented.") }, i.addQueue = function (t, e) { void 0 === t && (t = 1), void 0 === e && (e = "default"); var i = this._lg.locateChild(this._layoutID, e), n = nK.createRenderQueue(t, i), r = nK.createRenderData(), s = this._renderGraph.addVertex(8, n, "", e, r, !0, this._vertID), a = iK.renderQueueBuilder.add(); return a.update(r, this._renderGraph, this._lg, s, n, this._pipeline), a }, n(e, [{ key: "name", get: function () { return this._renderGraph.getName(this._vertID) }, set: function (t) { this._renderGraph.setName(this._vertID, t) } }, { key: "showStatistics", get: function () { return this._subpass.showStatistics }, set: function (t) { this._subpass.showStatistics = t } }]), e }(hq), fK = function (t) { function e(e, i, n, r, s, a, o) { var u; (u = t.call(this, e, n) || this)._renderGraph = void 0, u._layoutID = void 0, u._pass = void 0, u._pipeline = void 0, u._resourceGraph = void 0, u._renderGraph = i, u._resourceGraph = r, u._vertID = s, u._pass = a, u._pipeline = o; var h = u._renderGraph.getLayout(u._vertID); return u._layoutID = n.locateChild(n.N, h), u } s(e, t); var i = e.prototype; return i.update = function (t, e, i, n, r, s, a) { this._renderGraph = e, this._lg = i, this._resourceGraph = n, this._vertID = r, this._pass = s, this._pipeline = a, this._data = t; var o = this._renderGraph.getLayout(this._vertID); this._layoutID = i.locateChild(i.N, o) }, i.setCustomShaderStages = function () { throw new Error("Method not implemented.") }, i.setArrayBuffer = function () { throw new Error("Method not implemented.") }, i.setVersion = function (t, e) { this._pass.versionName = t, this._pass.version = e }, i.addRenderTarget = function (t, e, i, n) { void 0 === e && (e = 1), void 0 === i && (i = 0), void 0 === n && (n = new Xd); var r = 1; 0 === e && (r = 0); var s = nK.createRasterView("", 2, 0, e, i, r); s.clearColor.copy(n), this._pass.rasterViews.set(t, s) }, i.addDepthStencil = function (t, e, i, n, r, s) { void 0 === e && (e = 1), void 0 === i && (i = 0), void 0 === n && (n = 1), void 0 === r && (r = 0), void 0 === s && (s = 6); var a = nK.createRasterView("", 2, 1, e, i, s); a.clearColor.set(n, r, 0, 0), this._pass.rasterViews.set(t, a) }, i.resolveRenderTarget = function () { }, i.resolveDepthStencil = function () { }, i._addComputeResource = function (t, e, i) { var n, r = nK.createComputeView(i); r.accessType = e, this._pass.computeViews.has(t) ? null == (n = this._pass.computeViews.get(t)) || n.push(r) : this._pass.computeViews.set(t, [r]) }, i.addTexture = function (t, e, i) { if (void 0 === i && (i = null), this._addComputeResource(t, 0, e), i) { var n = this._lg.attributeIndex.get(e); this._data.samplers.set(n, i) } }, i.addStorageBuffer = function (t, e, i) { this._addComputeResource(t, e, i) }, i.addStorageImage = function (t, e, i) { this._addComputeResource(t, e, i) }, i.addRenderSubpass = function (t) { void 0 === t && (t = ""); var e = "Raster", i = this._pass.subpassGraph.nv(); this._pass.subpassGraph.addVertex(e, nK.createSubpass()); var n = nK.createRasterSubpass(i, 1, 0), r = nK.createRenderData(), s = this._renderGraph.addVertex(1, n, e, t, r, !0), a = iK.renderSubpassBuilder.add(); return a.update(r, this._renderGraph, this._lg, s, n, this._pipeline), a }, i.addQueue = function (t, e) { void 0 === t && (t = 1), void 0 === e && (e = "default"); var i = this._lg.locateChild(this._layoutID, e), n = nK.createRenderQueue(t, i), r = nK.createRenderData(), s = this._renderGraph.addVertex(8, n, "", e, r, !0, this._vertID), a = iK.renderQueueBuilder.add(); return a.update(r, this._renderGraph, this._lg, s, n, this._pipeline), a }, i.addFullscreenQuad = function (t, e, i, n) { void 0 === i && (i = 0), void 0 === n && (n = "FullscreenQuad"); var r = nK.createRenderQueue(3), s = this._renderGraph.addVertex(8, r, "Queue", "", nK.createRenderData(), !0, this._vertID); this._renderGraph.addVertex(10, nK.createBlit(t, e, i, null), n, "", nK.createRenderData(), !0, s) }, i.addCameraQuad = function (t, e, i, n, r) { void 0 === r && (r = "CameraQuad"); var s = nK.createRenderQueue(3), a = this._renderGraph.addVertex(8, s, "Queue", "", nK.createRenderData(), !0, this._vertID); this._renderGraph.addVertex(10, nK.createBlit(e, i, n, t), r, "", nK.createRenderData(), !0, a) }, i.setViewport = function (t) { this._pass.viewport.copy(t) }, n(e, [{ key: "name", get: function () { return this._renderGraph.getName(this._vertID) }, set: function (t) { this._renderGraph.setName(this._vertID, t) } }, { key: "showStatistics", get: function () { return this._pass.showStatistics }, set: function (t) { this._pass.showStatistics = t } }]), e }(hq), dK = function (t) { function e(e, i, n, r, s, a) { var o; return (o = t.call(this, e, n) || this)._renderGraph = void 0, o._queue = void 0, o._pipeline = void 0, o._renderGraph = i, o._vertID = r, o._queue = s, o._pipeline = a, o } s(e, t); var i = e.prototype; return i.update = function (t, e, i, n, r, s) { this._data = t, this._lg = i, this._renderGraph = e, this._vertID = n, this._queue = r, this._pipeline = s }, i.setArrayBuffer = function () { throw new Error("Method not implemented.") }, i.addDispatch = function (t, e, i, n, r, s) { void 0 === n && (n = null), void 0 === r && (r = 0), void 0 === s && (s = "Dispatch"), this._renderGraph.addVertex(11, nK.createDispatch(n, r, t, e, i), s, "", nK.createRenderData(), !0, this._vertID) }, n(e, [{ key: "name", get: function () { return this._renderGraph.getName(this._vertID) }, set: function (t) { this._renderGraph.setName(this._vertID, t) } }]), e }(hq), pK = function (t) { function e(e, i, n, r, s, a, o) { var u; (u = t.call(this, e, n) || this)._renderGraph = void 0, u._resourceGraph = void 0, u._layoutID = void 0, u._pass = void 0, u._pipeline = void 0, u._renderGraph = i, u._resourceGraph = r, u._vertID = s, u._pass = a, u._pipeline = o; var h = u._renderGraph.getLayout(u._vertID); return u._layoutID = n.locateChild(n.N, h), u } s(e, t); var i = e.prototype; return i.update = function (t, e, i, n, r, s, a) { this._data = t, this._renderGraph = e, this._lg = i, this._resourceGraph = n, this._vertID = r, this._pass = s, this._pipeline = a; var o = this._renderGraph.getLayout(this._vertID); this._layoutID = i.locateChild(i.N, o) }, i.setCustomShaderStages = function () { throw new Error("Method not implemented.") }, i.setArrayBuffer = function () { throw new Error("Method not implemented.") }, i.addTexture = function () { throw new Error("Method not implemented.") }, i.addStorageBuffer = function (t, e, i) { this._addComputeResource(t, e, i) }, i.addStorageImage = function (t, e, i) { this._addComputeResource(t, e, i) }, i.addMaterialTexture = function () { throw new Error("Method not implemented.") }, i.addQueue = function (t) { void 0 === t && (t = "default"); var e = this._lg.locateChild(this._layoutID, t), i = nK.createRenderQueue(1, e), n = nK.createRenderData(), r = this._renderGraph.addVertex(8, i, "", t, n, !0, this._vertID), s = iK.computeQueueBuilder.add(); return s.update(n, this._renderGraph, this._lg, r, i, this._pipeline), s }, i._addComputeResource = function (t, e, i) { var n, r = nK.createComputeView(i); r.accessType = e, this._pass.computeViews.has(t) ? null == (n = this._pass.computeViews.get(t)) || n.push(r) : this._pass.computeViews.set(t, [r]) }, n(e, [{ key: "name", get: function () { return this._renderGraph.getName(this._vertID) }, set: function (t) { this._renderGraph.setName(this._vertID, t) } }]), e }(hq); !function () { function t(t, e, i) { this._renderGraph = void 0, this._vertID = void 0, this._pass = void 0, this._renderGraph = t, this._vertID = e, this._pass = i } var e = t.prototype; e.setCustomBehavior = function () { throw new Error("Method not implemented.") }, e.addPair = function (t) { this._pass.movePairs.push(t) }, n(t, [{ key: "name", get: function () { return this._renderGraph.getName(this._vertID) }, set: function (t) { this._renderGraph.setName(this._vertID, t) } }]) }(), function () { function t(t, e, i) { this._renderGraph = void 0, this._vertID = void 0, this._pass = void 0, this._renderGraph = t, this._vertID = e, this._pass = i } var e = t.prototype; e.addPair = function () { throw new Error("Method not implemented.") }, e.setCustomBehavior = function () { throw new Error("Method not implemented.") }, n(t, [{ key: "name", get: function () { return this._renderGraph.getName(this._vertID) }, set: function (t) { this._renderGraph.setName(this._vertID, t) } }]) }(); var _K = function () { function t(t) { this.globalDSManager = void 0, this.descriptorSetLayout = void 0, this.descriptorSet = void 0, this._width = 0, this._height = 0, this._usesDeferredPipeline = !1, this._copyPassMat = new gT, this._device = void 0, this._defaultSampler = void 0, this._profilerDescriptorSet = null, this._macros = {}, this._pipelineSceneData = new QB, this._constantMacros = "", this._lightingMode = 1, this._profiler = null, this._cameras = [], this._resourceUses = [], this._layoutGraph = void 0, this._resourceGraph = new wj, this._renderGraph = null, this._compiler = null, this._executor = null, this._customPipelineName = "", this._globalDescSetData = void 0, this._combineSignY = 0, this._layoutGraph = t } var e = t.prototype; return e.addCustomBuffer = function () { throw new Error("Method not implemented.") }, e.addCustomTexture = function () { throw new Error("Method not implemented.") }, e.tryAddRenderWindowDepthStencil = function (t, e, i, n) { i && (n ? this.addDepthStencilImpl(i, n.depthStencilTexture.format, t, e, 4, n) : this.addDepthStencilImpl(i, 55, t, e, 0)) }, e.addRenderWindow = function (t, e, i, n, r, s) { var a = this._resourceGraph.find(t); if (4294967295 !== a) return this.updateRenderWindow(t, r, s), a; this.tryAddRenderWindowDepthStencil(i, n, s, r.swapchain); var o = new ij; return o.dimension = 2, o.width = i, o.height = n, o.depthOrArraySize = 1, o.mipLevels = 1, o.format = r.framebuffer.colorTextures[0].format, o.flags = 16, r.swapchain ? this._resourceGraph.addVertex(6, new rj(r.swapchain), t, o, new nj(4), new sj, new rp) : (o.sampleCount = r.framebuffer.colorTextures[0].info.samples, this._resourceGraph.addVertex(5, r.framebuffer, t, o, new nj(3), new sj, new rp)) }, e.updateRenderWindow = function (t, e, i) { var n = this.resourceGraph.vertex(t), r = this.resourceGraph.getDesc(n); r.width = e.width, r.height = e.height, this.resourceGraph.object(n) !== e.framebuffer && (this.resourceGraph.x[n].j = e.framebuffer), this.tryAddRenderWindowDepthStencil(e.width, e.height, i, e.swapchain) }, e.updateStorageBuffer = function (t, e, i) { void 0 === i && (i = 0); var n = this.resourceGraph.vertex(t), r = this.resourceGraph.getDesc(n); r.width = e, 0 !== i && (r.format = i) }, e.updateRenderTarget = function (t, e, i, n) { void 0 === n && (n = 0); var r = this.resourceGraph.vertex(t), s = this.resourceGraph.getDesc(r); s.width = e, s.height = i, 0 !== n && (s.format = n) }, e.updateDepthStencil = function (t, e, i, n) { void 0 === n && (n = 0); var r = this.resourceGraph.find(t); 4294967295 !== r && this.updateDepthStencilImpl(r, e, i, n) }, e.updateStorageTexture = function (t, e, i, n) { void 0 === n && (n = 0); var r = this.resourceGraph.vertex(t), s = this.resourceGraph.getDesc(r); s.width = e, s.height = i, 0 !== n && (s.format = n) }, e.updateShadingRateTexture = function (t, e, i) { var n = this.resourceGraph.vertex(t), r = this.resourceGraph.getDesc(n); r.width = e, r.height = i }, e.addBuffer = function (t, e, i, n) { var r = this._resourceGraph.find(t); if (4294967295 !== r) return this.updateBuffer(t, e), r; var s = new ij; return s.dimension = 0, s.width = e, s.flags = i, this._resourceGraph.addVertex(0, new cj, t, s, new nj(n), new sj, new rp(2, 2, 0, 2, 2, 2)) }, e.updateBuffer = function (t, e) { this.updateResource(t, 0, e, 0, 0, 0, 0, 1) }, e.addExternalTexture = function () { throw new Error("Method not implemented.") }, e.updateExternalTexture = function () { throw new Error("Method not implemented.") }, e.addTexture = function (t, e, i, n, r, s, a, o, u, h, c) { var l = this._resourceGraph.find(t); if (4294967295 !== l) return this.updateTexture(t, i, n, r, s, a, o, u), l; var f = new ij; return f.dimension = uK(e), f.width = n, f.height = r, f.depthOrArraySize = 3 === f.dimension ? s : a, f.mipLevels = o, f.format = i, f.sampleCount = u, f.flags = h, f.viewType = e, this._resourceGraph.addVertex(0, new cj, t, f, new nj(c), new sj, new rp(2, 2, 0, 2, 2, 2)) }, e.updateTexture = function (t, e, i, n, r, s, a, o) { this.updateResource(t, e, i, n, r, s, a, o) }, e.addResource = function (t, e, i, n, r, s, a, o, u, h, c) { var l = this._resourceGraph.find(t); return 4294967295 !== l ? (this.updateResource(t, i, n, r, s, a, o, u), l) : 0 === e ? this.addBuffer(t, n, h, c) : this.addTexture(t, oK(e, a), i, n, r, s, a, o, u, h, c) }, e.updateResource = function (t, e, i, n, r, s, a, o) { var u = this.resourceGraph.vertex(t), h = this.resourceGraph.getDesc(u); h.width = i, h.height = n, h.depthOrArraySize = 3 === h.dimension ? r : s, h.mipLevels = a, 0 !== e && (h.format = e), h.sampleCount = o }, e.containsResource = function (t) { return this._resourceGraph.contains(t) }, e.addResolvePass = function () { throw new Error("Method not implemented.") }, e.addComputePass = function (t) { var e = nK.createComputePass(), i = nK.createRenderData(), n = this._renderGraph.addVertex(3, e, "Compute", t, i, !0), r = iK.computePassBuilder.add(); return r.update(i, this._renderGraph, this._layoutGraph, this._resourceGraph, n, e, this._pipelineSceneData), S.director.root.pipeline, r }, e.addUploadPass = function (t) { for (var e, i = nK.createCopyPass(), n = p(t); !(e = n()).done;) { var r = e.value; i.uploadPairs.push(r) } this._renderGraph.addVertex(5, i, "UploadPass", "", nK.createRenderData(), !0) }, e.addCopyPass = function (t) { for (var e, i = p(t); !(e = i()).done;) { var n = e.value, r = n.target, s = this.resourceGraph.find(r), a = this.resourceGraph.getDesc(s), o = this.addRenderPass(a.width, a.height, "copy-pass"); o.addRenderTarget(r, 1, 0, iK.createColor()), o.addTexture(n.source, "outputResultMap"), o.addQueue(0).addFullscreenQuad(this._copyPassMat, 0, 0) } }, e._generateConstantMacros = function () { var t = ""; t += "#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE " + (3 & this._device.getFormatFeatures(44) ? 1 : 0) + "\n", t += "#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS " + this._device.capabilities.maxVertexUniformVectors + "\n", t += "#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS " + this._device.capabilities.maxFragmentUniformVectors + "\n", t += "#define CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT " + (this._device.hasFeature(5) ? 1 : 0) + "\n", t += "#define CC_PLATFORM_ANDROID_AND_WEBGL " + (Ro.os === Io.ANDROID && Ro.isBrowser ? 1 : 0) + "\n", t += "#define CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES " + (Le.ENABLE_WEBGL_HIGHP_STRUCT_VALUES ? 1 : 0) + "\n", t += "#define CC_JOINT_UNIFORM_CAPACITY " + Pb.JOINT_UNIFORM_CAPACITY + "\n", this._constantMacros = t, this._layoutGraph.constantMacros = this._constantMacros }, e.setCustomPipelineName = function (t) { this._customPipelineName = t, "Deferred" === this._customPipelineName && (this._usesDeferredPipeline = !0) }, e.getGlobalDescriptorSetData = function () { var t = this.layoutGraph.locateChild(this.layoutGraph.N, "default"); return this.layoutGraph.getLayout(t).getSet(3) }, e._initCombineSignY = function () { var t = this._device; this._combineSignY = .5 * t.capabilities.screenSpaceSignY + .5 << 1 | .5 * t.capabilities.clipSpaceSignY + .5 }, e.getCombineSignY = function () { return this._combineSignY }, e._compileMaterial = function () { this._copyPassMat.initialize({ effectName: "pipeline/copy-pass" }); for (var t = 0; t < this._copyPassMat.passes.length; ++t)this._copyPassMat.passes[t].tryCompile() }, e.activate = function () { this._device = B_.gfxDevice, iK = new aK, nK = iK.renderGraphPool, Rq(this._device, this._layoutGraph), this._compileMaterial(), this.setMacroBool("CC_USE_HDR", this._pipelineSceneData.isHDR), this.setMacroBool("CC_USE_FLOAT_OUTPUT", Le.ENABLE_FLOAT_OUTPUT && Tw(this._device)), this._generateConstantMacros(!1), this._pipelineSceneData.activate(this._device), this._initCombineSignY(); var e = Sw(this._device) ? 0 : 1; this.setMacroInt("CC_SHADOWMAP_FORMAT", e); var i = 6 === this._device.gfxAPI ? 1 : 0; this.setMacroInt("CC_SHADOWMAP_USE_LINEAR_DEPTH", i); var n = S.director.root; return this._defaultSampler = n.device.getSampler(sK), this.pipelineSceneData.csmSupported = this.device.capabilities.maxFragmentUniformVectors >= t.CSM_UNIFORM_VECTORS + t.GLOBAL_UNIFORM_VECTORS, this.setMacroBool("CC_SUPPORT_CASCADED_SHADOW_MAP", this.pipelineSceneData.csmSupported), this.setMacroInt("CC_SHADOW_TYPE", 0), this.setMacroInt("CC_DIR_SHADOW_PCF_TYPE", yT.HARD), this.setMacroInt("CC_DIR_LIGHT_SHADOW_TYPE", 0), this.setMacroBool("CC_CASCADED_LAYERS_TRANSITION", !1), this.usesDeferredPipeline && this.setMacroInt("CC_PIPELINE_TYPE", 1), !0 }, e.destroy = function () { var t; return null == (t = this._pipelineSceneData) || t.destroy(), !0 }, e.getMacroString = function (t) { var e = this._macros[t]; return void 0 === e ? "" : e }, e.getMacroInt = function (t) { var e = this._macros[t]; return void 0 === e ? 0 : e }, e.getMacroBool = function (t) { var e = this._macros[t]; return void 0 !== e && e }, e.getSamplerInfo = function (t) { if (this.containsResource(t)) { var e = this._resourceGraph.vertex(t); return this._resourceGraph.getSampler(e) } return null }, e.setMacroString = function (t, e) { this._macros[t] = e }, e.setMacroInt = function (t, e) { this._macros[t] = e }, e.setMacroBool = function (t, e) { this._macros[t] = e }, e.onGlobalPipelineStateChanged = function () { var t = S.rendering.getCustomPipeline(Le.CUSTOM_PIPELINE_NAME); t && ("function" == typeof t.onGlobalPipelineStateChanged && t.onGlobalPipelineStateChanged(), S.rendering.forceResizeAllWindows()) }, e.beginSetup = function () { this._renderGraph || (this._renderGraph = new Oj), iK.reset() }, e.endSetup = function () { this.compile() }, e.addStorageBuffer = function (t, e, i, n) { void 0 === n && (n = 0); var r = this._resourceGraph.find(t); if (4294967295 !== r) return this.updateStorageBuffer(t, i, e), r; var s = new ij; return s.dimension = 0, s.width = i, s.height = 1, s.depthOrArraySize = 1, s.mipLevels = 1, s.format = e, s.flags = 4, 2 === n ? this._resourceGraph.addVertex(3, new oj, t, s, new nj(2), new sj, new rp) : this._resourceGraph.addVertex(1, new aj, t, s, new nj(n), new sj, new rp) }, e.addRenderTarget = function (t, e, i, n, r) { void 0 === r && (r = 0); var s = this._resourceGraph.find(t); if (4294967295 !== s) return this.updateRenderTarget(t, i, n, e), s; var a = new ij; return a.dimension = 2, a.width = i, a.height = n, a.depthOrArraySize = 1, a.mipLevels = 1, a.format = e, a.sampleCount = 1, a.flags = 24, this._resourceGraph.addVertex(0, new cj, t, a, new nj(r), new sj, new rp(2, 2, 0, 2, 2, 2)) }, e.updateDepthStencilImpl = function (t, e, i, n, r) { var s = this.resourceGraph.getDesc(t); if (s.width = e, s.height = i, r) { var a = this.resourceGraph.j(t); a.swapchain = r, s.format = a.swapchain.depthStencilTexture.format } else 0 !== n && (s.format = n) }, e.addDepthStencilImpl = function (t, e, i, n, r, s) { var a = this._resourceGraph.find(t); if (4294967295 !== a) return this.updateDepthStencilImpl(a, i, n, e, s), a; var o = new ij; return o.dimension = 2, o.width = i, o.height = n, o.depthOrArraySize = 1, o.mipLevels = 1, o.format = e, o.sampleCount = 1, o.flags = 40, s ? this._resourceGraph.addVertex(6, new rj(s, !0), t, o, new nj(r), new sj, new rp(1, 1, 0)) : this._resourceGraph.addVertex(0, new cj, t, o, new nj(r), new sj, new rp(1, 1, 0)) }, e.addDepthStencil = function (t, e, i, n, r) { return void 0 === r && (r = 0), this.addDepthStencilImpl(t, e, i, n, r) }, e.addStorageTexture = function (t, e, i, n, r) { void 0 === r && (r = 0); var s = this._resourceGraph.find(t); if (4294967295 !== s) return this.updateStorageTexture(t, i, n, e), s; var a = new ij; return a.dimension = 2, a.width = i, a.height = n, a.depthOrArraySize = 1, a.mipLevels = 1, a.format = e, a.flags = 12, this._resourceGraph.addVertex(0, new cj, t, a, new nj(r), new sj, new rp(1, 1, 0)) }, e.addShadingRateTexture = function (t, e, i, n) { void 0 === n && (n = 0); var r = this._resourceGraph.find(t); if (4294967295 !== r) return this.addShadingRateTexture(t, e, i), r; var s = new ij; return s.dimension = 2, s.width = e, s.height = i, s.depthOrArraySize = 1, s.mipLevels = 1, s.format = 6, s.flags = 140, this._resourceGraph.addVertex(0, new cj, t, s, new nj(n), new sj, new rp(2, 2, 0, 2, 2, 2)) }, e.beginFrame = function () { S.director.buildRenderPipeline() }, e.update = function () { }, e.endFrame = function () { var t; null == (t = this.renderGraph) || t.clear() }, e.compile = function () { if (!this._renderGraph) throw new Error("RenderGraph cannot be built without being created"); this._renderGraph.x.forEach((function (t) { 0 === t.t && qX(t.j) })) }, e.execute = function () { if (!this._renderGraph) throw new Error("Cannot run without creating rendergraph"); this._executor || (this._executor = new WY(this, this._device, this._resourceGraph, this.layoutGraph, this.width, this.height)), this._executor.resize(this.width, this.height), this._executor.execute(this._renderGraph) }, e._applySize = function (t) { var e = this, i = this._width, n = this._height; t.forEach((function (t) { var r = t.window; i = Math.max(r.width, i), n = Math.max(r.height, n), e._cameras.includes(t) || e._cameras.push(t) })), i === this._width && n === this._height || (this._width = i, this._height = n) }, e.render = function (t) { 0 !== t.length && (this._applySize(t), pT(t), this.beginFrame(), this.execute(), this.endFrame()) }, e.addBuiltinReflectionProbePass = function (t) { var e = S.internal.reflectionProbeManager; if (e) { var i = e.getProbes(); if (0 !== i.length) for (var n = 0; n < i.length; n++) { var r = i[n]; r.needRender && 1 === i[n].probeType && bX(t, this, r, r.realtimePlanarTexture.window, 0) } } }, e.addRenderPassImpl = function (t, e, i, n, r) { void 0 === n && (n = 1), void 0 === r && (r = 0); var s = nK.createRasterPass(); s.viewport.width = t, s.viewport.height = e, s.count = n, s.quality = r; var a = nK.createRenderData(), o = this._renderGraph.addVertex(0, s, "Raster", i, a, !0), u = iK.renderPassBuilder.add(); return u.update(a, this._renderGraph, this._layoutGraph, this._resourceGraph, o, s, this._pipelineSceneData), this._updateRasterPassConstants(u, t, e, i), $X(u, this._pipelineSceneData), u }, e.addRenderPass = function (t, e, i) { return void 0 === i && (i = "default"), this.addRenderPassImpl(t, e, i) }, e.addMultisampleRenderPass = function (t, e, i, n, r) { return void 0 === r && (r = "default"), this.addRenderPassImpl(t, e, r, i, n) }, e.getDescriptorSetLayout = function (t, e) { var i = this._layoutGraph, n = i.shaderLayoutIndex.get(t); return i.getLayout(n).getSet(e).descriptorSetLayout }, e._updateRasterPassConstants = function (t, e, i) { var n = S.director, r = n.root, s = e, a = i; r.pipeline.layoutGraph, rK.set(r.cumulativeTime, r.frameTime, n.getTotalFrames()), t.setVec4("cc_time", rK), rK.set(s, a, 1 / s, 1 / a), t.setVec4("cc_screenSize", rK), rK.set(s, a, 1 / s, 1 / a), t.setVec4("cc_nativeSize", rK); var o = r.debugView; if (rK.set(0, 0, 0, 0), o) { for (var u = [o.singleMode, 0, 0, 0], h = 0; h < 17; h++) { var c = h % 8; u[1 + (h >> 3)] += (o.isCompositeModeEnabled(h) ? 1 : 0) * Math.pow(10, c) } u[3] += (o.lightingWithAlbedo ? 1 : 0) * Math.pow(10, 6), u[3] += (o.csmLayerColoration ? 1 : 0) * Math.pow(10, 7), rK.set(u[0], u[1], u[2], u[3]) } t.setVec4("cc_debug_view_mode", rK) }, n(t, [{ key: "type", get: function () { return 0 } }, { key: "capabilities", get: function () { return new kj } }, { key: "enableCpuLightCulling", get: function () { return !this._executor || this._executor._context.culling.enableLightCulling }, set: function (t) { this._executor && (this._executor._context.culling.enableLightCulling = t) } }, { key: "globalDescriptorSetData", get: function () { return this._globalDescSetData } }, { key: "defaultSampler", get: function () { return this._defaultSampler } }, { key: "defaultShadowTexture", get: function () { return xw(this.device) } }, { key: "device", get: function () { return this._device } }, { key: "lightingMode", get: function () { return this._lightingMode }, set: function (t) { this._lightingMode = t } }, { key: "usesDeferredPipeline", get: function () { return this._usesDeferredPipeline } }, { key: "macros", get: function () { return this._macros } }, { key: "profilerDescriptorSet", get: function () { return this._profilerDescriptorSet } }, { key: "commandBuffers", get: function () { return [this._device.commandBuffer] } }, { key: "pipelineSceneData", get: function () { return this._pipelineSceneData } }, { key: "constantMacros", get: function () { return this._constantMacros } }, { key: "profiler", get: function () { return this._profiler }, set: function (t) { this._profiler = t } }, { key: "geometryRenderer", get: function () { throw new Error("Method not implemented.") } }, { key: "shadingScale", get: function () { return this._pipelineSceneData.shadingScale }, set: function (t) { this._pipelineSceneData.shadingScale = t } }, { key: "width", get: function () { return this._width } }, { key: "height", get: function () { return this._height } }, { key: "renderGraph", get: function () { return this._renderGraph } }, { key: "resourceGraph", get: function () { return this._resourceGraph } }, { key: "layoutGraph", get: function () { return this._layoutGraph } }, { key: "resourceUses", get: function () { return this._resourceUses } }]), t }(); _K.MAX_BLOOM_FILTER_PASS_NUM = 6, _K.CSM_UNIFORM_VECTORS = 61, _K.GLOBAL_UNIFORM_VECTORS = 64, function () { function t() { this.capacity = 0, this.size = 0, this.buffer = void 0, this.dataView = void 0, this.capacity = 4096, this.buffer = new Uint8Array(this.capacity), this.dataView = new DataView(this.buffer.buffer) } var e = t.prototype; e.b = function (t) { var e = this.size + 1; e > this.capacity && this.reserve(e), this.dataView.setUint8(this.size, t ? 1 : 0), this.size = e }, e.n = function (t) { var e = this.size + 8; e > this.capacity && this.reserve(e), this.dataView.setFloat64(this.size, t, !0), this.size = e }, e.s = function (t) { this.n(t.length); var e = this.size + t.length; e > this.capacity && this.reserve(e); for (var i = 0; i < t.length; i++)this.dataView.setUint8(this.size + i, t.charCodeAt(i)); this.size = e }, e.reserve = function (t) { var e = Math.max(t, 2 * this.capacity), i = this.buffer; this.buffer = new Uint8Array(e), this.buffer.set(i), this.dataView = new DataView(this.buffer.buffer), this.capacity = e }, n(t, [{ key: "data", get: function () { return this.buffer.buffer.slice(0, this.size) } }]) }(); var gK = function () { function t(t, e) { this.offset = 0, this.dataView = void 0, this.dataView = new DataView(t, e) } var e = t.prototype; return e.b = function () { return 0 !== this.dataView.getUint8(this.offset++) }, e.n = function () { var t = this.dataView.getFloat64(this.offset, !0); return this.offset += 8, t }, e.s = function () { var t = this.n(), e = String.fromCharCode.apply(null, Array.from(new Uint8Array(this.dataView.buffer, this.offset, t))); return this.offset += t, e }, t }(), mK = function (t, e, i, n, r) { this.programInfo = t, this.shaderInfo = e, this.attributes = i, this.blockSizes = n, this.handleMap = r }, vK = function () { this.programInfos = new Map, this.programProxies = new Map }, yK = [2, 1, 3, 0]; function bK(t, e) { var i = r({}, e); return i.effectName = t, Jw(i), i } function wK(t, e) { for (var i, n = p(t.blocks); !(i = n()).done;) { var r = i.value; if (r.name === e) return { set: r.set, binding: r.binding } } for (var s, a = p(t.buffers); !(s = a()).done;) { var o = s.value; if (o.name === e) return { set: o.set, binding: o.binding } } for (var u, h = p(t.samplerTextures); !(u = h()).done;) { var c = u.value; if (c.name === e) return { set: c.set, binding: c.binding } } for (var l, f = p(t.samplers); !(l = f()).done;) { var d = l.value; if (d.name === e) return { set: d.set, binding: d.binding } } for (var _, g = p(t.textures); !(_ = g()).done;) { var m = _.value; if (m.name === e) return { set: m.set, binding: m.binding } } for (var v, y = p(t.images); !(v = y()).done;) { var b = v.value; if (b.name === e) return { set: b.set, binding: b.binding } } for (var w, x = p(t.subpassInputs); !(w = x()).done;) { var S = w.value; if (S.name === e) return { set: S.set, binding: S.binding } } throw j("binding not found in shaderInfo!") } function xK(t, e) { for (var i = e, n = /layout\s*\(([^)])+\)\s+uniform\s+(\b\w+\b\s+)?sampler(\w+)\s+(\b\w+\b)/g, r = n.exec(i); r;) { var s = wK(t, r[4]), a = "layout(set = " + s.set + ", binding = " + s.binding + ") uniform " + (r[2] ? r[2] : "") + " sampler" + r[3] + " " + r[4]; i = i.replace(r[0], a), r = n.exec(i) } for (var o = /layout\s*\(([^)]+)\)\s*(readonly|writeonly)?\s*\b((uniform\s*|buffer\s*|image2D\s*){1,2})\b\s*(\b\w+\b)\s*[{;]/g, u = o.exec(i); u;) { var h = wK(t, u[5]), c = h.set, l = h.binding, f = u[2] ? u[2] : "", d = " {"; u[3].includes("image") && (d = ";"); var p = u[1], _ = "layout(" + (p = (p = p.replace(/set\s*=\s*\d+/g, "set = " + c)).replace(/binding\s*=\s*\d+/g, "binding = " + l)) + ") " + f + " " + u[3] + " " + u[5] + d; i = i.replace(u[0], _), u = o.exec(i) } return i } function SK(t, e) { "glsl4" === rx(B_.gfxDevice) && (e.glsl4.vert && (e.glsl4.vert = xK(t, e.glsl4.vert)), e.glsl4.frag && (e.glsl4.frag = xK(t, e.glsl4.frag)), e.glsl4.compute && (e.glsl4.compute = xK(t, e.glsl4.compute))) } function TK(t, e) { SK(t, e); for (var i, n = yK[1], r = p(e.blocks); !(i = r()).done;) { for (var s, a = i.value, o = !1, u = p(t.blocks); !(s = u()).done;) { var h = s.value; if (h.set === n && h.name === a.name) { a.binding = h.binding, o = !0; break } } o || j("Block " + a.name + " not found in shader " + t.name) } } function IK(t, e, i, n, r) { for (var s, a = p(t.descriptorBlocks); !(s = a()).done;) { var o = s.value, u = o.visibility, h = o.offset; switch (o.type) { case 0: for (var c, l = p(e.blocks); !(c = l()).done;) { var f = c.value; f.stageFlags === u && (r.push(Kw(f.members)), n.blocks.push(new ap(i, h, f.name, f.members.map((function (t) { return new sp(t.name, t.type, t.count) })), 1)), ++h) } break; case 1: case 6: break; case 2: for (var d, _ = p(e.samplerTextures); !(d = _()).done;) { var g = d.value; g.stageFlags === u && (n.samplerTextures.push(new op(i, h, g.name, g.type, g.count)), ++h) } break; case 3: for (var m, v = p(e.samplers); !(m = v()).done;) { var y = m.value; y.stageFlags === u && (n.samplers.push(new up(i, h, y.name, y.count)), ++h) } break; case 4: for (var b, w = p(e.textures); !(b = w()).done;) { var x = b.value; x.stageFlags === u && (n.textures.push(new hp(i, h, x.name, x.type, x.count)), ++h) } break; case 5: for (var S, T = p(e.buffers); !(S = T()).done;) { var I = S.value; I.stageFlags === u && (n.buffers.push(new lp(i, h, I.name, 1, I.memoryAccess)), ++h) } break; case 7: for (var E, A = p(e.images); !(E = A()).done;) { var C = E.value; C.stageFlags === u && (n.images.push(new cp(i, h, C.name, C.type, C.count, C.memoryAccess)), ++h) } break; case 8: for (var D, R = p(e.subpassInputs); !(D = R()).done;) { var P = D.value; P.stageFlags === u && (n.subpassInputs.push(new fp(i, P.binding, P.name, P.count)), ++h) } } } } function EK(t, e, i, n, r) { for (var s, a = p(e.descriptorBlocks); !(s = a()).done;) { var o = s.value, u = o.offset; switch (o.type) { case 0: for (var h, c = p(o.descriptors); !(h = c()).done;) { var l = h.value, f = e.uniformBlocks.get(l.descriptorID); void 0 !== f ? (r.push(Kw(f.members)), n.blocks.push(new ap(i, u, t[l.descriptorID], f.members.map((function (t) { return new sp(t.name, t.type, t.count) })), 1)), ++u) : j("Failed to find uniform block " + l.descriptorID + " in layout") } u !== o.offset + o.capacity && j("Uniform buffer binding mismatch for set " + i); break; case 1: case 6: break; case 2: for (var d, _ = p(o.descriptors); !(d = _()).done;) { var g = d.value; n.samplerTextures.push(new op(i, u, t[g.descriptorID], g.type, g.count)), ++u } break; case 3: for (var m, v = p(o.descriptors); !(m = v()).done;) { var y = m.value; n.samplers.push(new up(i, u, t[y.descriptorID], y.count)), ++u } break; case 4: for (var b, w = p(o.descriptors); !(b = w()).done;) { var x = b.value; n.textures.push(new hp(i, u, t[x.descriptorID], x.type, x.count)), ++u } break; case 5: for (var S, T = p(o.descriptors); !(S = T()).done;) { var I = S.value; n.buffers.push(new lp(i, u, t[I.descriptorID], 1, 3)), ++u } break; case 7: for (var E, A = p(o.descriptors); !(E = A()).done;) { var C = E.value; n.images.push(new cp(i, u, t[C.descriptorID], C.type, C.count, 3)), ++u } break; case 8: for (var D, R = p(o.descriptors); !(D = R()).done;) { var P = D.value; n.subpassInputs.push(new fp(i, u, t[P.descriptorID], P.count)), ++u } } } } function AK(t, e, i, n) { for (var r = yK[0], s = function () { var s = t.blocks[a], o = e.layouts[s.name], u = o && e.bindings.find((function (t) { return t.binding === o.binding })); if (!(o && u && u.descriptorType & jp)) return console.warn("builtin UBO '" + s.name + "' not available!"), 1; n.push(Kw(s.members)), i.blocks.push(new ap(r, u.binding, s.name, s.members.map((function (t) { return new sp(t.name, t.type, t.count) })), 1)) }, a = 0; a < t.blocks.length; a++)s(); for (var o = function () { var n = t.samplerTextures[u], s = e.layouts[n.name], a = s && e.bindings.find((function (t) { return t.binding === s.binding })); if (!(s && a && a.descriptorType & Xp)) return console.warn("builtin samplerTexture '" + n.name + "' not available!"), 1; i.samplerTextures.push(new op(r, a.binding, n.name, n.type, n.count)) }, u = 0; u < t.samplerTextures.length; u++)o() } function CK(t) { for (var e, i = 0, n = p(t.bindings); !(e = n()).done;) { var r = e.value; 1 !== r.descriptorType && 2 !== r.descriptorType || (i += r.count) } return i } function DK(t) { for (var e, i = 0, n = p(t.bindings); !(e = n()).done;) { var r = e.value; 1 !== r.descriptorType && 2 !== r.descriptorType && (i += r.count) } return i } function RK(t, e) { for (var i, n = p(e); !(i = n()).done;) { var r = i.value; r.flattened = t[r.set] + r.binding } } function PK(t, e, i) { for (var n, r = p(i); !(n = r()).done;) { var s = n.value; s.flattened = t[s.set] + s.binding - e[s.set] } } function BK(t, e, i) { var n, r, s, a, o = new Array(4), u = (null == (n = t[3]) ? void 0 : n.uniformBlockCapacity) || 0, h = (null == (r = t[2]) ? void 0 : r.uniformBlockCapacity) || 0, c = (null == (s = t[1]) ? void 0 : s.uniformBlockCapacity) || 0, l = e ? CK(e) : (null == (a = t[0]) ? void 0 : a.uniformBlockCapacity) || 0; o[yK[3]] = u, o[yK[2]] = h, o[yK[1]] = c, o[yK[0]] = l; var f = 0 + u, d = f + h, p = d + l, _ = new Array(4); _[yK[3]] = 0, _[yK[2]] = f, _[yK[1]] = p, _[yK[0]] = d, RK(_, i.blocks); var g, m, v, y = 0 + ((null == (g = t[3]) ? void 0 : g.samplerTextureCapacity) || 0), b = y + ((null == (m = t[2]) ? void 0 : m.samplerTextureCapacity) || 0), w = b + (e ? DK(e) : (null == (v = t[0]) ? void 0 : v.samplerTextureCapacity) || 0), x = new Array(4); x[yK[3]] = 0, x[yK[2]] = y, x[yK[1]] = w, x[yK[0]] = b, PK(x, o, i.samplerTextures) } function MK(t, e, i, n, r, s) { var a = [null, null, null, null], o = null, u = new _p, h = [], c = e.getSet(3); c && (a[3] = c.descriptorSetLayoutData, EK(t.valueNames, c.descriptorSetLayoutData, yK[3], u, h)); var l = i.getSet(2); l && (a[2] = l.descriptorSetLayoutData, EK(t.valueNames, l.descriptorSetLayoutData, yK[2], u, h)); var f = n.descriptors[1]; if (r) { var d = r.layout.getSet(1); d && (a[1] = d.descriptorSetLayoutData, EK(t.valueNames, d.descriptorSetLayoutData, yK[1], u, h)) } else { var p = i.getSet(1); p && (a[1] = p.descriptorSetLayoutData, IK(p.descriptorSetLayoutData, f, yK[1], u, h)) } var _ = n.descriptors[0]; if (r) if (s) o = rb, AK(_, rb, u, h); else { var g = r.layout.getSet(0); g && (a[0] = g.descriptorSetLayoutData, EK(t.valueNames, g.descriptorSetLayoutData, yK[0], u, h)) } else { var m = i.getSet(0); m && (a[0] = m.descriptorSetLayoutData, IK(m.descriptorSetLayoutData, _, yK[0], u, h)) } return BK(a, o, u), u.stages.push(new dp(1, "")), u.stages.push(new dp(16, "")), [u, h] } var OK = function () { function t(t, e) { void 0 === e && (e = null), this.shader = void 0, this.pipelineState = null, this.shader = t, this.pipelineState = e } return n(t, [{ key: "name", get: function () { return this.shader.name } }]), t }(); function LK(t, e) { for (var i in t.layouts) { var n = t.layouts[i]; if (n.binding === e) { X(n.name === i); var r = 0; return (n instanceof op || n instanceof cp) && (r = n.type), [n.name, r] } } return j("descriptor not found"), ["", 0] } function FK(t, e) { for (var i, n = new jj, r = p(e.bindings); !(i = r()).done;) { var s = i.value, a = LK(e, s.binding), o = a[0], u = a[1], h = Aq(t, o), c = mq(s.descriptorType), l = new Wj(c, s.stageFlags, s.count, s.access, s.viewDimension, s.sampleType, s.format); l.offset = s.binding, l.descriptors.push(new Hj(h, u, s.count)), n.descriptorBlocks.push(l), void 0 !== n.bindingMap.get(h) && j("duplicate descriptor name '" + o + "'"), n.bindingMap.set(h, s.binding); var f = e.layouts[o]; f instanceof ap && n.uniformBlocks.set(h, f) } return n } function kK(t, e, i, n, r, s) { var a = r.layout.getSets(), o = Oq(i, 1, yK[1], e.descriptors[1]), u = new Xj(o); if (Lq(u.descriptorSetLayoutData, u.descriptorSetLayoutInfo), a.set(1, u), s) { var h = FK(i, rb), c = new Xj(h); if (Lq(c.descriptorSetLayoutData, c.descriptorSetLayoutInfo), rb.bindings.length !== c.descriptorSetLayoutInfo.bindings.length) j("local descriptor set layout inconsistent"); else for (var l = 0; l !== rb.bindings.length; ++l) { var f = rb.bindings[l], d = c.descriptorSetLayoutInfo.bindings[l]; f.binding === d.binding && f.descriptorType === d.descriptorType && f.count === d.count && f.stageFlags === d.stageFlags || j("local descriptor set layout inconsistent") } a.set(0, c) } else { var p = Oq(i, 0, yK[0], e.descriptors[0]), _ = new Xj(p); Lq(_.descriptorSetLayoutData, _.descriptorSetLayoutInfo), a.set(0, _) } var g = n.shaderPrograms.length; n.shaderIndex.set(t, g), n.shaderPrograms.push(r) } function NK(t, e, i, n, r) { X(r < 2); var s = e.j(i), a = s.shaderIndex.get(n); if (void 0 === a) return zq(); var o = s.shaderPrograms[a].layout.getSet(r); return void 0 === o ? zq() : (o.descriptorSetLayout || (o.descriptorSetLayout = t.createDescriptorSetLayout(o.descriptorSetLayoutInfo)), o.descriptorSetLayout) } function zK(t, e, i, n, r) { X(r < 2); var s = e.j(i), a = s.shaderIndex.get(n); if (void 0 === a) return null; var o = s.shaderPrograms[a].layout.getSet(r); return void 0 === o ? null : (o.descriptorSetLayout || (o.descriptorSetLayout = t.createDescriptorSetLayout(o.descriptorSetLayoutInfo)), o.descriptorSetLayout) } function UK(t, e, i) { var n = i.program, r = vq(t, i.pass); if (r === _q) return j("Invalid render pass, program: " + n), [_q, _q, _q, null, _q]; var s = i.subpass && "" !== i.subpass && !0, a = s ? yq(t, r, i.subpass) : _q; if (s && a === _q) return j("Invalid render subpass, program: " + n), [_q, _q, _q, null, _q]; var o = bq(t, a === _q ? r : a, i.phase); if (o === _q) return j("Invalid render phase, program: " + n), [_q, _q, _q, null, _q]; for (var u = null, h = _q, c = 0; c < e.shaders.length; ++c) { var l = e.shaders[c]; if (l.name === n) { u = l, h = c; break } } return [r, a, o, u, h] } function VK(t) { return void 0 === t.descriptors ? (j("No descriptors in shader: " + t.name + ", please reimport ALL effects"), 1) : 0 } var GK = function () { function t(t) { this.layoutGraph = void 0, this.phases = new Map, this.mergeHighFrequency = !1, this.fixedLocal = !0, this.localLayoutData = new jj, this.localDescriptorSetLayout = null, this.pipeline = null, this.device = null, this.layoutGraph = t; for (var e, i = p(t.v()); !(e = i()).done;) { var n = e.value; t.h(1, n) && this.phases.set(n, new vK) } } var e = t.prototype; return e.init = function (t) { if (this.device !== t) { this.device = t; var e = Math.floor((this.device.capabilities.maxVertexUniformVectors - 38) / 3); e = e < 256 ? e : 256, Pb.initLayout(e); for (var i, n = this.layoutGraph, r = p(n.v()); !(i = r()).done;)for (var s, a = i.value, o = p(n.getLayout(a).getSets()); !(s = o()).done;) { var u = s.value; u[0]; var h = u[1]; Lq(h.descriptorSetLayoutData, h.descriptorSetLayoutInfo), h.descriptorSetLayout = this.device.createDescriptorSetLayout(h.descriptorSetLayoutInfo), X(!!h.descriptorSetLayout), h.descriptorSet = this.device.createDescriptorSet(new Dp(h.descriptorSetLayout)), X(!!h.descriptorSet) } for (var c, l = p(n.v()); !(c = l()).done;) { var f = c.value; if (n.h(1, f)) { var d = f, _ = n.getParent(d), g = n.getLayout(_), m = n.getLayout(d), v = new Rp; Fq(g, 3, v), Fq(m, 2, v), Fq(m, 1, v), Fq(m, 0, v), n.j(d).pipelineLayout = this.device.createPipelineLayout(v) } } var y = rb; this.localLayoutData = FK(n, y); var b, w = new Cp; Lq(this.localLayoutData, w), this.localDescriptorSetLayout = this.device.createDescriptorSetLayout(w), X(!!this.localDescriptorSetLayout); for (var x, S = 0, T = p(this.localLayoutData.descriptorBlocks); !(x = T()).done;) { var I = x.value; if (0 === I.type || 1 === I.type) for (var E, A = p(I.descriptors); !(E = A()).done;)S += E.value.count } X(7 === S), b = this.device, this.layoutGraph.constantMacros, b.getFormatFeatures(44), b.capabilities.maxVertexUniformVectors, b.capabilities.maxFragmentUniformVectors, b.hasFeature(5), Pb.JOINT_UNIFORM_CAPACITY } }, e.addEffect = function (t) { for (var e, i = this, n = this.layoutGraph, r = p(t.techniques); !(e = r()).done;)for (var s, a = function () { var e = s.value, r = e.program, a = UK(n, t, e), o = a[0], u = a[1], h = a[2], c = a[3]; if (null === c || VK(c)) return j("program: " + r + " not found"), 1; X(o !== _q && h !== _q); var l = u === _q ? o : u, f = n.getLayout(l), d = n.getLayout(h), p = i.phases.get(h); void 0 === p && (p = new vK, i.phases.set(h, p)); var _ = p.programInfos, g = bK(t.name, c), m = null; if (!i.mergeHighFrequency) { var v = n.j(h); m = new Jj, kK(r, c, n, v, m, i.fixedLocal) } var y = MK(n, f, d, c, m, i.fixedLocal), b = y[0], w = y[1]; TK(b, g); var x = Qw(b), S = []; g.attributes.forEach((function (t) { S.push(new pp(t.name, t.format, t.isNormalized, 0, t.isInstanced, t.location)) })); var T = new mK(g, b, S, w, x); _.set(c.name, T) }, o = p(e.value.passes); !(s = o()).done;)a() }, e.precompileEffect = function (t, e) { for (var i, n = this, r = this.layoutGraph, s = p(e.techniques); !(i = s()).done;)for (var a, o = function () { var i = a.value, s = i.program, o = UK(r, e, i), u = o[0]; o[1]; var h = o[2], c = o[3], l = o[4]; if (null === c || VK(c)) return j("program: " + s + " not valid"), 0; X(u !== _q && h !== _q && l !== _q); var f = e.combinations[l]; if (!f) return 0; $w(f).forEach((function (e) { return n.getProgramVariant(t, h, s, e) })) }, u = p(i.value.passes); !(a = u()).done;)o() }, e.getProgramInfo = function (t, e) { return X(t !== _q), this.phases.get(t).programInfos.get(e).programInfo }, e.getShaderInfo = function (t, e) { return X(t !== _q), this.phases.get(t).programInfos.get(e).shaderInfo }, e.getKey = function (t, e, i) { X(t !== _q); var n = this.phases.get(t); if (void 0 === n) return j("Invalid render phase, program: " + e), ""; var r = n.programInfos.get(e); return void 0 === r ? (j("Invalid program, program: " + e), "") : Xw(r.programInfo, i) }, e.getProgramVariant = function (t, e, i, n, r) { var s; void 0 === r && (r = null), Object.assign(n, null == (s = this.pipeline) ? void 0 : s.macros), X(e !== _q); var a = this.phases.get(e); if (void 0 === a) return j("Invalid render phase, program: " + i), null; var o = a.programInfos.get(i); if (void 0 === o) return j("Invalid program, program: " + i), null; var u = o.programInfo; null === r && (r = Xw(u, n)); var h = a.programProxies, c = h.get(r); if (void 0 !== c) return c; var l = Gw(n, u.defines), f = this.layoutGraph.constantMacros + u.constantMacros + l.reduce((function (t, e) { return t + "#define " + e.name + " " + e.value + "\n" }), ""), d = u.glsl3, p = rx(t); p ? d = u[p] : rt(16346); var _ = o.shaderInfo; d.compute ? (_.stages[0].source = f + d.compute, _.stages[0].stage = 32, _.stages.length = 1) : (_.stages[0].source = f + d.vert, _.stages[1].source = f + d.frag), _.attributes = jw(u, o.attributes, n), _.name = Hw(i, l); var g = t.createShader(_), m = new OK(g); return h.set(r, m), m }, e.getMaterialDescriptorSetLayout = function (t, e, i) { if (this.mergeHighFrequency) { X(e !== _q); var n = this.layoutGraph.getParent(e); return Vq(this.layoutGraph, n, e, 1) } return NK(t, this.layoutGraph, e, i, 1) }, e.getLocalDescriptorSetLayout = function (t, e, i) { if (this.mergeHighFrequency) { X(e !== _q); var n = this.layoutGraph.getParent(e); return Vq(this.layoutGraph, n, e, 0) } return NK(t, this.layoutGraph, e, i, 0) }, e.getBlockSizes = function (t, e) { X(t !== _q); var i = this.phases.get(t); if (!i) return j("Invalid render phase, program: " + e), []; var n = i.programInfos.get(e); return n ? n.blockSizes : (j("Invalid program, program: " + e), []) }, e.getHandleMap = function (t, e) { X(t !== _q); var i = this.phases.get(t); if (!i) return j("Invalid render phase, program: " + e), {}; var n = i.programInfos.get(e); return n ? n.handleMap : (j("Invalid program, program: " + e), {}) }, e.getPipelineLayout = function (t, e, i) { if (this.mergeHighFrequency) return X(e !== _q), this.layoutGraph.j(e).pipelineLayout; var n = this.layoutGraph, r = n.j(e), s = r.shaderIndex.get(i); if (void 0 === s) return Uq(); var a = r.shaderPrograms[s]; if (a.pipelineLayout) return a.pipelineLayout; var o = n.getParent(e); if (o === _q) return Uq(); var u = new Rp, h = Gq(this.layoutGraph, o, e, 3); h && u.setLayouts.push(h); var c = Gq(this.layoutGraph, o, e, 2); c && u.setLayouts.push(c); var l = zK(t, n, e, i, 1); l && u.setLayouts.push(l); var f = zK(t, n, e, i, 0); return f && u.setLayouts.push(f), a.pipelineLayout = t.createPipelineLayout(u), a.pipelineLayout }, e.getProgramID = function (t, e) { return Hq(this.layoutGraph, t, e) }, e.getDescriptorNameID = function (t) { return Wq(this.layoutGraph, t) }, e.getDescriptorName = function (t) { return jq(this.layoutGraph, t) }, t }(), HK = null, WK = !1; function jK() { WK = !0 } var XK = [], qK = 4294967295, YK = new iX, KK = new GK(YK), QK = new Map, ZK = Object.freeze({ __proto__: null, AccessType: { READ: 0, READ_WRITE: 1, WRITE: 2 }, AttachmentType: { RENDER_TARGET: 0, DEPTH_STENCIL: 1, SHADING_RATE: 2 }, ClearValueType: { NONE: 0, FLOAT_TYPE: 1, INT_TYPE: 2 }, CopyPair: CW, INVALID_ID: qK, LightInfo: EW, LightingMode: { NONE: 0, DEFAULT: 1, CLUSTERED: 2 }, MovePair: RW, ParameterType: { CONSTANTS: 0, CBV: 1, UAV: 2, SRV: 3, TABLE: 4, SSV: 5 }, PipelineCapabilities: kj, PipelineStatistics: PW, PipelineType: { BASIC: 0, STANDARD: 1 }, QueueHint: { NONE: 0, OPAQUE: 1, MASK: 2, BLEND: 3, RENDER_OPAQUE: 1, RENDER_CUTOUT: 2, RENDER_TRANSPARENT: 3 }, RenderCommonObjectPool: FW, ResolveFlags: { NONE: 0, COLOR: 1, DEPTH: 2, STENCIL: 4 }, ResolvePair: AW, ResourceDimension: { BUFFER: 0, TEXTURE1D: 1, TEXTURE2D: 2, TEXTURE3D: 3 }, ResourceFlags: { NONE: 0, UNIFORM: 1, INDIRECT: 2, STORAGE: 4, SAMPLED: 8, COLOR_ATTACHMENT: 16, DEPTH_STENCIL_ATTACHMENT: 32, INPUT_ATTACHMENT: 64, SHADING_RATE: 128, TRANSFER_SRC: 256, TRANSFER_DST: 512 }, ResourceResidency: { MANAGED: 0, MEMORYLESS: 1, PERSISTENT: 2, EXTERNAL: 3, BACKBUFFER: 4 }, SceneFlags: { NONE: 0, OPAQUE: 1, MASK: 2, BLEND: 4, OPAQUE_OBJECT: 1, CUTOUT_OBJECT: 2, TRANSPARENT_OBJECT: 4, SHADOW_CASTER: 8, UI: 16, DEFAULT_LIGHTING: 32, VOLUMETRIC_LIGHTING: 64, CLUSTERED_LIGHTING: 128, PLANAR_SHADOW: 256, GEOMETRY: 512, PROFILER: 1024, DRAW_INSTANCING: 2048, DRAW_NON_INSTANCING: 4096, REFLECTION_PROBE: 8192, GPU_DRIVEN: 16384, NON_BUILTIN: 32768, ALL: 4294967295 }, SubpassCapabilities: { NONE: 0, INPUT_DEPTH_STENCIL: 1, INPUT_COLOR: 2, INPUT_COLOR_MRT: 4, HETEROGENEOUS_SAMPLE_COUNT: 8 }, TaskType: { SYNC: 0, ASYNC: 1 }, UpdateFrequency: { PER_INSTANCE: 0, PER_BATCH: 1, PER_PHASE: 2, PER_PASS: 3, COUNT: 4 }, UploadPair: DW, completePhaseName: function (t) { return "number" == typeof t ? t.toString() : "string" == typeof t ? t : "default" }, createCustomPipeline: function () { var t = new _K(YK), e = Le.CUSTOM_PIPELINE_NAME; return t.setCustomPipelineName(e), KK.pipeline = t, t }, customPipelineBuilderMap: QK, defaultWindowResize: function (t, e, i, n) { t.addRenderWindow(e.colorName, 36, i, n, e), t.addDepthStencil(e.depthStencilName, 55, i, n); var r = e.renderWindowId, s = Sw(t.device) ? 11 : 35, a = t.pipelineSceneData.shadows.size; t.addRenderTarget("ShadowMap" + r, s, a.x, a.y), t.addDepthStencil("ShadowDepth" + r, 55, a.x, a.y) }, destroy: function () { Nq(YK) }, dispatchResizeEvents: function (t, e, i) { if (e.windowResize) { for (var n, r = p(t); !(n = r()).done;) { var s = n.value; if (s.window.isRenderWindowResized() || WK) { var a = Math.max(Math.floor(s.window.width), 1), o = Math.max(Math.floor(s.window.height), 1); e.windowResize(i, s.window, s, a, o), XK.push(s.window) } } for (var u, h = p(XK); !(u = h()).done;)u.value.setRenderWindowResizeHandled(); XK.length = 0, WK = !1 } }, enableEffectImport: !0, forceResizeAllWindows: jK, getCustomPipeline: function (t) { var e = QK.get(t); return e || (e = QK.get("Forward")), e }, getEditorPipelineSettings: function () { return HK }, getPassID: function (t) { return vq(YK, t) }, getPhaseID: function (t, e) { return bq(YK, t, e) }, getSubpassID: function (t, e) { return yq(YK, t, e) }, init: function (t, e) { if (e && e.byteLength >= 8) { var i = new Uint8Array(e); if (new DataView(i.buffer, i.byteOffset, 8).getUint32(0) === qK) { var n = new kM.Inflate(new Uint8Array(i.buffer, i.byteOffset + 8)).decompress(); _X(new gK(n.buffer, n.byteOffset), YK) } else _X(new gK(i.buffer, i.byteOffset), YK) } kq(t, YK) }, loadCopyPair: function (t, e) { e.source = t.s(), e.target = t.s(), e.mipLevels = t.n(), e.numSlices = t.n(), e.sourceMostDetailedMip = t.n(), e.sourceFirstSlice = t.n(), e.sourcePlaneSlice = t.n(), e.targetMostDetailedMip = t.n(), e.targetFirstSlice = t.n(), e.targetPlaneSlice = t.n() }, loadLightInfo: function (t, e) { e.level = t.n(), e.culledByLight = t.b() }, loadMovePair: function (t, e) { e.source = t.s(), e.target = t.s(), e.mipLevels = t.n(), e.numSlices = t.n(), e.targetMostDetailedMip = t.n(), e.targetFirstSlice = t.n(), e.targetPlaneSlice = t.n() }, loadPipelineStatistics: function (t, e) { e.numRenderPasses = t.n(), e.numManagedTextures = t.n(), e.totalManagedTextures = t.n(), e.numUploadBuffers = t.n(), e.numUploadBufferViews = t.n(), e.numFreeUploadBuffers = t.n(), e.numFreeUploadBufferViews = t.n(), e.numDescriptorSets = t.n(), e.numFreeDescriptorSets = t.n(), e.numInstancingBuffers = t.n(), e.numInstancingUniformBlocks = t.n() }, loadResolvePair: function (t, e) { e.source = t.s(), e.target = t.s(), e.resolveFlags = t.n(), e.mode = t.n(), e.mode1 = t.n() }, packRGBE: function (t) { var e = Math.max(Math.max(t.x, t.y), t.z), i = 128; e > 1e-4 && (i = Math.log(e) / Math.log(1.1), i = Xi((i = Math.ceil(i)) + 128, 0, 255)); var n = 1 / Math.pow(1.1, i - 128), r = ar(t.multiplyScalar(n), new Kn(0, 0, 0), new Kn(1, 1, 1)); r.multiplyScalar(255); var s, a, o = or(r).add((s = r.subtract(or(r))) < (a = new Kn(.5, .5, .5)) ? a : s); return new Pn(o.x / 255, o.y / 255, o.z / 255, i / 255) }, programLib: KK, saveCopyPair: function (t, e) { t.s(e.source), t.s(e.target), t.n(e.mipLevels), t.n(e.numSlices), t.n(e.sourceMostDetailedMip), t.n(e.sourceFirstSlice), t.n(e.sourcePlaneSlice), t.n(e.targetMostDetailedMip), t.n(e.targetFirstSlice), t.n(e.targetPlaneSlice) }, saveLightInfo: function (t, e) { t.n(e.level), t.b(e.culledByLight) }, saveMovePair: function (t, e) { t.s(e.source), t.s(e.target), t.n(e.mipLevels), t.n(e.numSlices), t.n(e.targetMostDetailedMip), t.n(e.targetFirstSlice), t.n(e.targetPlaneSlice) }, savePipelineStatistics: function (t, e) { t.n(e.numRenderPasses), t.n(e.numManagedTextures), t.n(e.totalManagedTextures), t.n(e.numUploadBuffers), t.n(e.numUploadBufferViews), t.n(e.numFreeUploadBuffers), t.n(e.numFreeUploadBufferViews), t.n(e.numDescriptorSets), t.n(e.numFreeDescriptorSets), t.n(e.numInstancingBuffers), t.n(e.numInstancingUniformBlocks) }, saveResolvePair: function (t, e) { t.s(e.source), t.s(e.target), t.n(e.resolveFlags), t.n(e.mode), t.n(e.mode1) }, setCustomPipeline: function (t, e) { QK.set(t, e), jK() }, setEditorPipelineSettings: function (t) { HK = t, WK = !0 } }); t("rendering", ZK), T.rendering = ZK; var JK = function (t) { function e() { var e; return (e = t.call(this) || this)._gpuDescriptorSet = null, e } s(e, t); var i = e.prototype; return i.initialize = function (t) { this._layout = t.layout; var e = t.layout.gpuDescriptorSetLayout, i = e.bindings, n = e.descriptorIndices, r = e.descriptorCount; this._buffers = Array(r).fill(null), this._textures = Array(r).fill(null), this._samplers = Array(r).fill(null); var s = []; this._gpuDescriptorSet = { gpuDescriptors: s, descriptorIndices: n }; for (var a = 0; a < i.length; ++a)for (var o = i[a], u = 0; u < o.count; u++) { var h = { type: o.descriptorType, gpuBuffer: null, gpuTexture: null, gpuSampler: null }; s.push(h) } }, i.destroy = function () { this._layout = null, this._gpuDescriptorSet = null }, i.update = function () { if (this._isDirty && this._gpuDescriptorSet) { for (var t = this._gpuDescriptorSet.gpuDescriptors, e = 0; e < t.length; ++e)if (t[e].type & jp) { var i = this._buffers[e]; i && (t[e].gpuBuffer = i.gpuBuffer || i.gpuBufferView) } else t[e].type & Xp && (this._textures[e] && (t[e].gpuTexture = this._textures[e].gpuTexture), this._samplers[e] && (t[e].gpuSampler = this._samplers[e].gpuSampler)); this._isDirty = !1 } }, n(e, [{ key: "gpuDescriptorSet", get: function () { return this._gpuDescriptorSet } }]), e }(c_), $K = Math.max, tQ = Math.min; function eQ(t) { switch (t) { case 4: case 6: case 14: case 16: case 24: case 25: case 27: case 36: case 35: case 37: case 39: case 51: case 53: case 56: case 58: case 60: case 61: case 62: case 63: case 64: case 66: case 70: case 71: case 72: case 73: case 74: case 75: case 76: case 79: case 81: case 83: case 84: case 85: case 86: case 87: case 88: case 89: case 90: case 91: case 92: case 93: case 94: case 95: case 96: case 97: case 98: case 99: case 100: case 101: case 102: case 103: case 104: case 105: case 106: case 107: case 108: case 109: case 110: case 111: case 112: case 113: case 114: case 115: case 116: default: return 5121; case 5: case 7: case 15: case 17: case 26: case 28: case 38: case 40: case 65: case 67: case 80: case 82: return 5120; case 8: case 18: case 29: case 41: return 36193; case 9: case 19: case 30: case 42: return 5123; case 10: case 20: case 31: case 43: return 5122; case 11: case 21: case 32: case 44: case 48: case 69: case 68: return 5126; case 12: case 22: case 33: case 45: case 52: case 54: return 5125; case 13: case 23: case 34: case 46: return 5124; case 47: return 33635; case 49: return 32820; case 50: return 32819; case 55: return 34042 } } function iQ(t) { switch (t) { case 47: return 36194; case 49: return 32855; case 50: return 32854; case 41: return 34842; case 44: return 34836; case 37: return 35907; case 54: return 33189; case 55: return 34041; default: return rt(16309), 6408 } } function nQ(t) { switch (t) { case 1: return 6406; case 2: return 6409; case 3: return 6410; case 24: case 29: case 32: case 47: return 6407; case 36: case 35: case 37: case 41: case 44: case 49: case 50: return 6408; case 54: return 6402; case 55: return 34041; case 56: return 33776; case 57: return 33777; case 58: return 35916; case 59: return 35917; case 60: return 33778; case 61: return 35918; case 62: return 33779; case 63: return 35919; case 72: return 36196; case 73: return 37492; case 74: return 37493; case 75: return 37494; case 76: return 37495; case 77: return 37496; case 78: return 37497; case 79: return 37488; case 80: return 37489; case 81: return 37490; case 82: return 37491; case 83: return 35841; case 84: return 35843; case 85: return 35840; case 86: return 35842; case 89: return 37808; case 90: return 37809; case 91: return 37810; case 92: return 37811; case 93: return 37812; case 94: return 37813; case 95: return 37814; case 96: return 37815; case 97: return 37816; case 98: return 37817; case 99: return 37818; case 100: return 37819; case 101: return 37820; case 102: return 37821; case 103: return 37840; case 104: return 37841; case 105: return 37842; case 106: return 37843; case 107: return 37844; case 108: return 37845; case 109: return 37846; case 110: return 37847; case 111: return 37848; case 112: return 37849; case 113: return 37850; case 114: return 37851; case 115: return 37852; case 116: return 37853; default: return rt(16310), 6408 } } function rQ(t) { switch (t) { case 1: return 35670; case 2: return 35671; case 3: return 35672; case 4: return 35673; case 5: return 5124; case 6: return 35667; case 7: return 35668; case 8: return 35669; case 9: return 5125; case 13: return 5126; case 14: return 35664; case 15: return 35665; case 16: return 35666; case 17: return 35674; case 21: return 35675; case 25: return 35676; case 28: return 35678; case 31: return 35680; default: return rt(16311), 0 } } function sQ(t) { switch (t) { case 1: case 2: case 3: case 4: case 5: case 6: case 7: case 8: case 9: return Int32Array; case 13: case 14: case 15: case 16: case 17: case 21: case 25: return Float32Array; default: return rt(16312), Float32Array } } function aQ(t) { switch (t) { case 35670: return 1; case 35671: return 2; case 35672: return 3; case 35673: return 4; case 5124: return 5; case 35667: return 6; case 35668: return 7; case 35669: return 8; case 5125: return 9; case 5126: return 13; case 35664: return 14; case 35665: return 15; case 35666: return 16; case 35674: return 17; case 35675: return 21; case 35676: return 25; case 35678: return 28; case 35680: return 31; default: return rt(16313), 0 } } function oQ(t) { switch (t) { case 35670: case 5124: case 5125: case 5126: case 35678: case 35680: return 4; case 35671: case 35667: case 35664: return 8; case 35672: case 35668: case 35665: return 12; case 35673: case 35669: case 35666: case 35674: return 16; case 35675: return 36; case 35676: return 64; default: return rt(16314), 0 } } function uQ(t) { switch (t) { case 35674: return 2; case 35675: return 3; case 35676: return 4; default: return 1 } } var hQ = [512, 513, 514, 515, 516, 517, 518, 519], cQ = [0, 7680, 7681, 7682, 7683, 5386, 34055, 34056], lQ = [32774, 32778, 32779, 32775, 32776], fQ = [0, 1, 770, 772, 771, 773, 768, 774, 769, 775, 776, 32769, 32770, 32771, 32772]; function dQ(t, e) { var i = t.gl, n = t.stateCache, r = 2 & e.memUsage ? 35048 : 35044; if (8 & e.usage) { e.glTarget = 34962; var s = i.createBuffer(); s && (e.glBuffer = s, e.size > 0 && (t.extensions.useVAO && n.glVAO && (t.extensions.OES_vertex_array_object.bindVertexArrayOES(null), n.glVAO = null), TQ.gpuInputAssembler = null, n.glArrayBuffer !== e.glBuffer && (i.bindBuffer(34962, e.glBuffer), n.glArrayBuffer = e.glBuffer), i.bufferData(34962, e.size, r), i.bindBuffer(34962, null), n.glArrayBuffer = null)) } else if (4 & e.usage) { e.glTarget = 34963; var a = i.createBuffer(); a && (e.glBuffer = a, e.size > 0 && (t.extensions.useVAO && n.glVAO && (t.extensions.OES_vertex_array_object.bindVertexArrayOES(null), n.glVAO = null), TQ.gpuInputAssembler = null, n.glElementArrayBuffer !== e.glBuffer && (i.bindBuffer(34963, e.glBuffer), n.glElementArrayBuffer = e.glBuffer), i.bufferData(34963, e.size, r), i.bindBuffer(34963, null), n.glElementArrayBuffer = null)) } else 16 & e.usage ? (e.glTarget = 0, e.buffer && (e.vf32 = new Float32Array(e.buffer.buffer))) : (64 & e.usage || 2 & e.usage || 1 & e.usage || rt(16315), e.glTarget = 0) } function pQ(t, e) { var i = t.gl, n = t.stateCache; if (e.glBuffer) { switch (e.glTarget) { case 34962: t.extensions.useVAO && n.glVAO && (t.extensions.OES_vertex_array_object.bindVertexArrayOES(null), n.glVAO = null), TQ.gpuInputAssembler = null, i.bindBuffer(34962, null), n.glArrayBuffer = null; break; case 34963: t.extensions.useVAO && n.glVAO && (t.extensions.OES_vertex_array_object.bindVertexArrayOES(null), n.glVAO = null), TQ.gpuInputAssembler = null, i.bindBuffer(34963, null), n.glElementArrayBuffer = null }i.deleteBuffer(e.glBuffer), e.glBuffer = null } } function _Q(t, e, i, n, r) { if (16 & e.usage) ArrayBuffer.isView(i) ? e.vf32.set(i, n / 4) : e.vf32.set(new Float32Array(i), n / 4); else if (64 & e.usage) { e.indirects.clearDraws(); for (var s = i.drawInfos, a = 0; a < s.length; ++a)e.indirects.setDrawInfo(n + a, s[a]) } else { var o = i, u = t.gl, h = t.stateCache; switch (e.glTarget) { case 34962: t.extensions.useVAO && h.glVAO && (t.extensions.OES_vertex_array_object.bindVertexArrayOES(null), h.glVAO = null), TQ.gpuInputAssembler = null, h.glArrayBuffer !== e.glBuffer && (u.bindBuffer(34962, e.glBuffer), h.glArrayBuffer = e.glBuffer); break; case 34963: t.extensions.useVAO && h.glVAO && (t.extensions.OES_vertex_array_object.bindVertexArrayOES(null), h.glVAO = null), TQ.gpuInputAssembler = null, h.glElementArrayBuffer !== e.glBuffer && (u.bindBuffer(34963, e.glBuffer), h.glElementArrayBuffer = e.glBuffer); break; default: return void rt(16316) }Ro.os === Io.IOS && 2 & e.memUsage && 0 === n && r === o.byteLength ? u.bufferData(e.glTarget, o, u.DYNAMIC_DRAW) : r === o.byteLength ? u.bufferSubData(e.glTarget, n, o) : u.bufferSubData(e.glTarget, n, o.slice(0, r)) } } function gQ(t, e) { var i = t.gl, n = t.stateCache; e.glFormat = e.glInternalFmt = nQ(e.format), e.glType = eQ(e.format); var r = e.width, s = e.height; switch (e.type) { case 1: e.glTarget = 3553; var a = $K(r, s); if (a > t.capabilities.maxTextureSize && rt(9100, a, t.capabilities.maxTextureSize), t.textureExclusive[e.format] || t.extensions.WEBGL_depth_texture || !Wp[e.format].hasDepth) { if (e.glTexture = i.createTexture(), e.size > 0) { var o = n.glTexUnits[n.texUnit]; if (o.glTexture !== e.glTexture && (i.bindTexture(3553, e.glTexture), o.glTexture = e.glTexture), Wp[e.format].isCompressed) for (var u = 0; u < e.mipLevel; ++u) { var h = Kp(e.format, r, s, 1), c = new Uint8Array(h); i.compressedTexImage2D(3553, u, e.glInternalFmt, r, s, 0, c), r = $K(1, r >> 1), s = $K(1, s >> 1) } else for (var l = 0; l < e.mipLevel; ++l)i.texImage2D(3553, l, e.glInternalFmt, r, s, 0, e.glFormat, e.glType, null), r = $K(1, r >> 1), s = $K(1, s >> 1); e.isPowerOf2 ? (e.glWrapS = 10497, e.glWrapT = 10497) : (e.glWrapS = 33071, e.glWrapT = 33071), e.glMinFilter = 9729, e.glMagFilter = 9729, i.texParameteri(e.glTarget, 10242, e.glWrapS), i.texParameteri(e.glTarget, 10243, e.glWrapT), i.texParameteri(e.glTarget, 10241, e.glMinFilter), i.texParameteri(e.glTarget, 10240, e.glMagFilter) } } else e.glInternalFmt = iQ(e.format), e.glRenderbuffer = i.createRenderbuffer(), e.size > 0 && (n.glRenderbuffer !== e.glRenderbuffer && (i.bindRenderbuffer(36161, e.glRenderbuffer), n.glRenderbuffer = e.glRenderbuffer), i.renderbufferStorage(36161, e.glInternalFmt, r, s)); break; case 3: e.glTarget = 34067; var f = $K(r, s); if (f > t.capabilities.maxCubeMapTextureSize && rt(9100, f, t.capabilities.maxTextureSize), e.glTexture = i.createTexture(), e.size > 0) { var d = n.glTexUnits[n.texUnit]; if (d.glTexture !== e.glTexture && (i.bindTexture(34067, e.glTexture), d.glTexture = e.glTexture), Wp[e.format].isCompressed) for (var p = 0; p < 6; ++p) { r = e.width, s = e.height; for (var _ = 0; _ < e.mipLevel; ++_) { var g = Kp(e.format, r, s, 1), m = new Uint8Array(g); i.compressedTexImage2D(34069 + p, _, e.glInternalFmt, r, s, 0, m), r = $K(1, r >> 1), s = $K(1, s >> 1) } } else for (var v = 0; v < 6; ++v) { r = e.width, s = e.height; for (var y = 0; y < e.mipLevel; ++y)i.texImage2D(34069 + v, y, e.glInternalFmt, r, s, 0, e.glFormat, e.glType, null), r = $K(1, r >> 1), s = $K(1, s >> 1) } e.isPowerOf2 ? (e.glWrapS = 10497, e.glWrapT = 10497) : (e.glWrapS = 33071, e.glWrapT = 33071), e.glMinFilter = 9729, e.glMagFilter = 9729, i.texParameteri(e.glTarget, 10242, e.glWrapS), i.texParameteri(e.glTarget, 10243, e.glWrapT), i.texParameteri(e.glTarget, 10241, e.glMinFilter), i.texParameteri(e.glTarget, 10240, e.glMagFilter) } break; default: rt(16317), e.type = 1, e.glTarget = 3553 } } function mQ(t, e) { var i = t.gl, n = t.stateCache; if (e.glTexture) { var r = n.glTexUnits, s = n.texUnit; i.deleteTexture(e.glTexture); for (var a = 0; a < r.length; a++)r[a].glTexture === e.glTexture && (i.activeTexture(33984 + a), s = a, i.bindTexture(e.glTarget, null), r[a].glTexture = null); n.texUnit = s, e.glTexture = null } if (e.glRenderbuffer) { var o = n.glRenderbuffer; i.deleteRenderbuffer(e.glRenderbuffer), o === e.glRenderbuffer && (i.bindRenderbuffer(36161, null), n.glRenderbuffer = null), e.glRenderbuffer = null } } function vQ(t, e) { if (e.size) { var i = t.gl, n = t.stateCache, r = e.width, s = e.height; switch (e.type) { case 1: e.glTarget = 3553; var a = $K(r, s); if (a > t.capabilities.maxTextureSize && rt(9100, a, t.capabilities.maxTextureSize), e.glRenderbuffer) n.glRenderbuffer !== e.glRenderbuffer && (i.bindRenderbuffer(36161, e.glRenderbuffer), n.glRenderbuffer = e.glRenderbuffer), i.renderbufferStorage(36161, e.glInternalFmt, r, s); else if (e.glTexture) { var o = n.glTexUnits[n.texUnit]; if (o.glTexture !== e.glTexture && (i.bindTexture(3553, e.glTexture), o.glTexture = e.glTexture), Wp[e.format].isCompressed) for (var u = 0; u < e.mipLevel; ++u) { var h = Kp(e.format, r, s, 1), c = new Uint8Array(h); i.compressedTexImage2D(3553, u, e.glInternalFmt, r, s, 0, c), r = $K(1, r >> 1), s = $K(1, s >> 1) } else for (var l = 0; l < e.mipLevel; ++l)i.texImage2D(3553, l, e.glInternalFmt, r, s, 0, e.glFormat, e.glType, null), r = $K(1, r >> 1), s = $K(1, s >> 1) } break; case 3: e.glTarget = 34067; var f = $K(r, s); f > t.capabilities.maxCubeMapTextureSize && rt(9100, f, t.capabilities.maxTextureSize); var d = n.glTexUnits[n.texUnit]; if (d.glTexture !== e.glTexture && (i.bindTexture(34067, e.glTexture), d.glTexture = e.glTexture), Wp[e.format].isCompressed) for (var p = 0; p < 6; ++p) { r = e.width, s = e.height; for (var _ = 0; _ < e.mipLevel; ++_) { var g = Kp(e.format, r, s, 1), m = new Uint8Array(g); i.compressedTexImage2D(34069 + p, _, e.glInternalFmt, r, s, 0, m), r = $K(1, r >> 1), s = $K(1, s >> 1) } } else for (var v = 0; v < 6; ++v) { r = e.width, s = e.height; for (var y = 0; y < e.mipLevel; ++y)i.texImage2D(34069 + v, y, e.glInternalFmt, r, s, 0, e.glFormat, e.glType, null), r = $K(1, r >> 1), s = $K(1, s >> 1) } break; default: rt(16317), e.type = 1, e.glTarget = 3553 } } } function yQ(t, e) { for (var i = 0; i < e.gpuColorTextures.length; ++i)if (e.gpuColorTextures[i].isSwapchainTexture) return void (e.isOffscreen = !1); var n = t.gl, r = t.stateCache, s = [], a = n.createFramebuffer(); if (a) { e.glFramebuffer = a, r.glFramebuffer !== e.glFramebuffer && n.bindFramebuffer(36160, e.glFramebuffer); for (var o = 0; o < e.gpuColorTextures.length; ++o) { var u = e.gpuColorTextures[o]; u && (u.glTexture ? n.framebufferTexture2D(36160, 36064 + o, u.glTarget, u.glTexture, 0) : n.framebufferRenderbuffer(36160, 36064 + o, 36161, u.glRenderbuffer), s.push(36064 + o), e.width = tQ(e.width, u.width), e.height = tQ(e.height, u.height)) } var h = e.gpuDepthStencilTexture; if (h) { var c = Wp[h.format].hasStencil ? 33306 : 36096; h.glTexture ? n.framebufferTexture2D(36160, c, h.glTarget, h.glTexture, 0) : n.framebufferRenderbuffer(36160, c, 36161, h.glRenderbuffer), e.width = tQ(e.width, h.width), e.height = tQ(e.height, h.height) } t.extensions.WEBGL_draw_buffers && t.extensions.WEBGL_draw_buffers.drawBuffersWEBGL(s); var l = n.checkFramebufferStatus(36160); if (36053 !== l) switch (l) { case 36054: rt(16318); break; case 36055: rt(16319); break; case 36057: rt(16320); break; case 36061: rt(16321) }r.glFramebuffer !== e.glFramebuffer && n.bindFramebuffer(36160, r.glFramebuffer) } } function bQ(t, e) { for (var i, n = t.gl, r = t.stateCache, s = function () { var t = e.gpuStages[a], i = 0, r = "", s = 1; switch (t.type) { case 1: r = "VertexShader", i = 35633; break; case 16: r = "FragmentShader", i = 35632; break; default: return rt(16322), { v: void 0 } }var o = n.createShader(i); if (o && (t.glShader = o, n.shaderSource(t.glShader, t.source), n.compileShader(t.glShader), !n.getShaderParameter(t.glShader, 35713))) { rt(16323, r, e.name), rt(16324, t.source.replace(/^|\n/g, (function () { return "\n" + s++ + " " }))), j(n.getShaderInfoLog(t.glShader)); for (var u = 0; u < e.gpuStages.length; u++) { var h = e.gpuStages[a]; h.glShader && (n.deleteShader(h.glShader), h.glShader = null) } return { v: void 0 } } }, a = 0; a < e.gpuStages.length; a++)if (i = s()) return i.v; var o = n.createProgram(); if (o) { e.glProgram = o; for (var u = 0; u < e.gpuStages.length; u++) { var h = e.gpuStages[u]; n.attachShader(e.glProgram, h.glShader) } if (n.linkProgram(e.glProgram), t.extensions.destroyShadersImmediately) for (var c = 0; c < e.gpuStages.length; c++) { var l = e.gpuStages[c]; l.glShader && (n.detachShader(e.glProgram, l.glShader), n.deleteShader(l.glShader), l.glShader = null) } if (!n.getProgramParameter(e.glProgram, 35714)) return rt(16326, e.name), void j(n.getProgramInfoLog(e.glProgram)); tt(16325, e.name); var f = n.getProgramParameter(e.glProgram, 35721); e.glInputs = new Array(f); for (var d = 0; d < f; ++d) { var p = n.getActiveAttrib(e.glProgram, d); if (p) { var _, g = p.type, m = p.name, v = p.size, y = m.indexOf("["); _ = -1 !== y ? m.substring(0, y) : m; var b = n.getAttribLocation(e.glProgram, _), w = aQ(g), x = oQ(g); e.glInputs[d] = { binding: b, name: _, type: w, stride: x, count: v, size: x * v, glType: g, glLoc: b } } } if (e.blocks.length > 0) { e.glBlocks = new Array(e.blocks.length); for (var T = 0; T < e.blocks.length; ++T) { var I = e.blocks[T], E = { set: I.set, binding: I.binding, name: I.name, size: 0, glUniforms: new Array(I.members.length), glActiveUniforms: [] }; e.glBlocks[T] = E; for (var A = 0; A < I.members.length; ++A) { var C = I.members[A], D = rQ(C.type), R = oQ(D), P = R * C.count; E.glUniforms[A] = { binding: -1, name: C.name, type: C.type, stride: R, count: C.count, size: P, offset: 0, glType: D, glLoc: null, array: null } } } } for (var B = 0; B < e.subpassInputs.length; ++B) { var M = e.subpassInputs[B]; e.samplerTextures.push(new op(M.set, M.binding, M.name, 28, M.count)) } if (e.samplerTextures.length > 0) { e.glSamplerTextures = new Array(e.samplerTextures.length); for (var O = 0; O < e.samplerTextures.length; ++O) { var L = e.samplerTextures[O]; e.glSamplerTextures[O] = { set: L.set, binding: L.binding, name: L.name, type: L.type, count: L.count, units: [], glUnits: null, glType: rQ(L.type), glLoc: null } } } for (var F = n.getProgramParameter(e.glProgram, 35718), k = 0; k < F; ++k) { var N = n.getActiveUniform(e.glProgram, k); if (N && 35678 !== N.type && 35680 !== N.type) { var z = n.getUniformLocation(e.glProgram, N.name); if (t.extensions.isLocationActive(z)) { var U, V = N.name.indexOf("["); U = -1 !== V ? N.name.substring(0, V) : N.name; for (var G = 0; G < e.glBlocks.length; G++)for (var H = e.glBlocks[G], W = 0; W < H.glUniforms.length; W++) { var X = H.glUniforms[W]; if (X.name === U) { X.glLoc = z, X.count = N.size, X.size = X.stride * X.count, X.array = new (sQ(X.type))(X.size / 4), H.glActiveUniforms.push(X); break } } } } } for (var q = 0; q < e.glBlocks.length; q++)for (var Y = e.glBlocks[q], K = 0; K < Y.glUniforms.length; K++) { var Q = Y.glUniforms[K]; Q.offset = Y.size / 4, Y.size += Q.size } var Z = [], J = [], $ = t.bindingMappings, et = t.capabilities, it = t.stateCache.texUnitCacheMap, nt = et.maxTextureUnits; if (S.rendering && S.rendering.enableEffectImport) for (var st = 0; st < e.samplerTextures.length; ++st) { var at = e.samplerTextures[st], ot = n.getUniformLocation(e.glProgram, at.name); t.extensions.isLocationActive(ot) && (Z.push(e.glSamplerTextures[st]), J.push(ot)), void 0 === it[at.name] && (it[at.name] = at.flattened % nt) } else { for (var ut = 0, ht = 0; ht < e.blocks.length; ++ht)e.blocks[ht].set === $.flexibleSet && ut++; for (var ct = 0, lt = 0; lt < e.samplerTextures.length; ++lt) { var ft = e.samplerTextures[lt], dt = n.getUniformLocation(e.glProgram, ft.name); if (t.extensions.isLocationActive(dt) && (Z.push(e.glSamplerTextures[lt]), J.push(dt)), void 0 === it[ft.name]) { var pt = ft.binding + $.samplerTextureOffsets[ft.set] + ct; ft.set === $.flexibleSet && (pt -= ut), it[ft.name] = pt % nt, ct += ft.count - 1 } } } if (Z.length) { for (var _t = [], gt = 0; gt < Z.length; ++gt) { var mt = Z[gt], vt = it[mt.name]; if (void 0 !== vt) { mt.glLoc = J[gt]; for (var yt = 0; yt < mt.count; ++yt) { for (; _t[vt];)vt = (vt + 1) % nt; mt.units.push(vt), _t[vt] = !0 } } } for (var bt = 0, wt = 0; wt < Z.length; ++wt) { var xt = Z[wt]; if (!t.extensions.isLocationActive(xt.glLoc)) { xt.glLoc = J[wt]; for (var St = 0; St < xt.count; ++St) { for (; _t[bt];)bt = (bt + 1) % nt; void 0 === it[xt.name] && (it[xt.name] = bt), xt.units.push(bt), _t[bt] = !0 } } } r.glProgram !== e.glProgram && n.useProgram(e.glProgram); for (var Tt = 0; Tt < Z.length; Tt++) { var It = Z[Tt]; It.glUnits = new Int32Array(It.units), n.uniform1iv(It.glLoc, It.glUnits) } r.glProgram !== e.glProgram && n.useProgram(r.glProgram) } for (var Et = 0; Et < e.glBlocks.length;)e.glBlocks[Et].glActiveUniforms.length ? Et++ : (e.glBlocks[Et] = e.glBlocks[e.glBlocks.length - 1], e.glBlocks.length--); e.glSamplerTextures = Z } } function wQ(t, e) { if (e.glProgram) { var i = t.gl, n = t.stateCache; if (!t.extensions.destroyShadersImmediately) for (var r = 0; r < e.gpuStages.length; r++) { var s = e.gpuStages[r]; s.glShader && (i.detachShader(e.glProgram, s.glShader), i.deleteShader(s.glShader), s.glShader = null) } i.deleteProgram(e.glProgram), n.glProgram === e.glProgram && (i.useProgram(null), n.glProgram = null), e.glProgram = null } } function xQ(t, e) { t.gl, e.glAttribs = new Array(e.attributes.length); for (var i = [0, 0, 0, 0, 0, 0, 0, 0], n = 0; n < e.attributes.length; ++n) { var r = e.attributes[n], s = r.format, a = r.isNormalized, o = r.isInstanced, u = void 0 !== r.stream ? r.stream : 0, h = e.gpuVertexBuffers[u], c = eQ(s), l = Wp[s].size; e.glAttribs[n] = { name: r.name, glBuffer: h.glBuffer, glType: c, size: l, count: Wp[s].count, stride: h.stride, componentCount: uQ(c), isNormalized: void 0 !== a && a, isInstanced: void 0 !== o && o, offset: i[u] }, i[u] += l } } function SQ(t, e) { for (var i = t.stateCache, n = e.glVAOs.values(), r = n.next(), s = t.extensions.OES_vertex_array_object, a = i.glVAO; !r.done;)s.deleteVertexArrayOES(r.value), a === r.value && (s.bindVertexArrayOES(null), a = null), r = n.next(); i.glVAO = a, e.glVAOs.clear() } var TQ = { gpuPipelineState: null, gpuInputAssembler: null, glPrimitive: 0 }, IQ = new Nd; function EQ(t, e, i, n, r, s, a) { var o = t.gl, u = t.stateCache, h = 0; if (i) { var c = i.lodLevel; IQ.x = n.x << c, IQ.y = n.y << c, IQ.width = n.width << c, IQ.height = n.height << c } if (i && e) { var l = i.glFramebuffer, f = IQ.x, d = IQ.y, p = IQ.width, _ = IQ.height; u.glFramebuffer !== l && (o.bindFramebuffer(36160, l), u.glFramebuffer = l); var g = u.viewport; g.left === f && g.top === d && g.width === p && g.height === _ || (o.viewport(f, d, p, _), g.left = f, g.top = d, g.width = p, g.height = _); var m = u.scissorRect; m.x === f && m.y === d && m.width === p && m.height === _ || (o.scissor(f, d, p, _), m.x = f, m.y = d, m.width = p, m.height = _); var v = r.length; t.extensions.WEBGL_draw_buffers || (v = 1); for (var y = u.dss, b = 0; b < v; ++b) { var w = e.colorAttachments[b]; if (0 !== w.format) switch (w.loadOp) { case 0: break; case 1: 15 !== u.bs.targets[0].blendColorMask && o.colorMask(!0, !0, !0, !0); var x = r[0]; o.clearColor(x.x, x.y, x.z, x.w), h |= 16384 } } if (e.depthStencilAttachment && 0 !== e.depthStencilAttachment.format) { switch (e.depthStencilAttachment.depthLoadOp) { case 0: break; case 1: y.depthWrite || o.depthMask(!0), o.clearDepth(s), h |= 256 }if (Wp[e.depthStencilAttachment.format].hasStencil) switch (e.depthStencilAttachment.stencilLoadOp) { case 0: break; case 1: y.stencilWriteMaskFront || o.stencilMaskSeparate(1028, 65535), y.stencilWriteMaskBack || o.stencilMaskSeparate(1029, 65535), o.clearStencil(a), h |= 1024 } } if (h && o.clear(h), 16384 & h) { var S = u.bs.targets[0].blendColorMask; if (15 !== S) { var T = !!(1 & S), I = !!(2 & S), E = !!(4 & S), A = !!(8 & S); o.colorMask(T, I, E, A) } } 256 & h && !y.depthWrite && o.depthMask(!1), 1024 & h && (y.stencilWriteMaskFront || o.stencilMaskSeparate(1028, 0), y.stencilWriteMaskBack || o.stencilMaskSeparate(1029, 0)) } } function AQ(t, e, i, n, r, s) { var a, o, u, h = t.gl, c = t.stateCache, l = c.dss, f = c.bs, d = e && e.gpuShader, p = !1; if (e && TQ.gpuPipelineState !== e) { if (TQ.gpuPipelineState = e, TQ.glPrimitive = e.glPrimitive, e.gpuShader) { var _ = e.gpuShader.glProgram; c.glProgram !== _ && (h.useProgram(_), c.glProgram = _, p = !0) } var g = e.rs, m = c.rs; if (g) { if (m.cullMode !== g.cullMode) { switch (g.cullMode) { case 0: h.disable(2884); break; case 1: h.enable(2884), h.cullFace(1028); break; case 2: h.enable(2884), h.cullFace(1029) }m.cullMode = g.cullMode } var v = g.isFrontFaceCCW; m.isFrontFaceCCW !== v && (h.frontFace(v ? 2305 : 2304), m.isFrontFaceCCW = v), m.depthBias === g.depthBias && m.depthBiasSlop === g.depthBiasSlop || (h.polygonOffset(g.depthBias, g.depthBiasSlop), m.depthBias = g.depthBias, m.depthBiasSlop = g.depthBiasSlop), m.lineWidth !== g.lineWidth && (h.lineWidth(g.lineWidth), m.lineWidth = g.lineWidth) } var y = e.dss; y && (l.depthTest !== y.depthTest && (y.depthTest ? h.enable(2929) : h.disable(2929), l.depthTest = y.depthTest), l.depthWrite !== y.depthWrite && (h.depthMask(y.depthWrite), l.depthWrite = y.depthWrite), l.depthFunc !== y.depthFunc && (h.depthFunc(hQ[y.depthFunc]), l.depthFunc = y.depthFunc), l.stencilTestFront === y.stencilTestFront && l.stencilTestBack === y.stencilTestBack || (y.stencilTestFront || y.stencilTestBack ? h.enable(2960) : h.disable(2960), l.stencilTestFront = y.stencilTestFront, l.stencilTestBack = y.stencilTestBack), l.stencilFuncFront === y.stencilFuncFront && l.stencilRefFront === y.stencilRefFront && l.stencilReadMaskFront === y.stencilReadMaskFront || (h.stencilFuncSeparate(1028, hQ[y.stencilFuncFront], y.stencilRefFront, y.stencilReadMaskFront), l.stencilFuncFront = y.stencilFuncFront, l.stencilRefFront = y.stencilRefFront, l.stencilReadMaskFront = y.stencilReadMaskFront), l.stencilFailOpFront === y.stencilFailOpFront && l.stencilZFailOpFront === y.stencilZFailOpFront && l.stencilPassOpFront === y.stencilPassOpFront || (h.stencilOpSeparate(1028, cQ[y.stencilFailOpFront], cQ[y.stencilZFailOpFront], cQ[y.stencilPassOpFront]), l.stencilFailOpFront = y.stencilFailOpFront, l.stencilZFailOpFront = y.stencilZFailOpFront, l.stencilPassOpFront = y.stencilPassOpFront), l.stencilWriteMaskFront !== y.stencilWriteMaskFront && (h.stencilMaskSeparate(1028, y.stencilWriteMaskFront), l.stencilWriteMaskFront = y.stencilWriteMaskFront), l.stencilFuncBack === y.stencilFuncBack && l.stencilRefBack === y.stencilRefBack && l.stencilReadMaskBack === y.stencilReadMaskBack || (h.stencilFuncSeparate(1029, hQ[y.stencilFuncBack], y.stencilRefBack, y.stencilReadMaskBack), l.stencilFuncBack = y.stencilFuncBack, l.stencilRefBack = y.stencilRefBack, l.stencilReadMaskBack = y.stencilReadMaskBack), l.stencilFailOpBack === y.stencilFailOpBack && l.stencilZFailOpBack === y.stencilZFailOpBack && l.stencilPassOpBack === y.stencilPassOpBack || (h.stencilOpSeparate(1029, cQ[y.stencilFailOpBack], cQ[y.stencilZFailOpBack], cQ[y.stencilPassOpBack]), l.stencilFailOpBack = y.stencilFailOpBack, l.stencilZFailOpBack = y.stencilZFailOpBack, l.stencilPassOpBack = y.stencilPassOpBack), l.stencilWriteMaskBack !== y.stencilWriteMaskBack && (h.stencilMaskSeparate(1029, y.stencilWriteMaskBack), l.stencilWriteMaskBack = y.stencilWriteMaskBack)); var b = e.bs; if (b) { f.isA2C !== b.isA2C && (b.isA2C ? h.enable(32926) : h.disable(32926), f.isA2C = b.isA2C), f.blendColor.x === b.blendColor.x && f.blendColor.y === b.blendColor.y && f.blendColor.z === b.blendColor.z && f.blendColor.w === b.blendColor.w || (h.blendColor(b.blendColor.x, b.blendColor.y, b.blendColor.z, b.blendColor.w), f.blendColor.x = b.blendColor.x, f.blendColor.y = b.blendColor.y, f.blendColor.z = b.blendColor.z, f.blendColor.w = b.blendColor.w); var w = b.targets[0], x = f.targets[0]; x.blend !== w.blend && (w.blend ? h.enable(3042) : h.disable(3042), x.blend = w.blend), x.blendEq === w.blendEq && x.blendAlphaEq === w.blendAlphaEq || (h.blendEquationSeparate(lQ[w.blendEq], lQ[w.blendAlphaEq]), x.blendEq = w.blendEq, x.blendAlphaEq = w.blendAlphaEq), x.blendSrc === w.blendSrc && x.blendDst === w.blendDst && x.blendSrcAlpha === w.blendSrcAlpha && x.blendDstAlpha === w.blendDstAlpha || (h.blendFuncSeparate(fQ[w.blendSrc], fQ[w.blendDst], fQ[w.blendSrcAlpha], fQ[w.blendDstAlpha]), x.blendSrc = w.blendSrc, x.blendDst = w.blendDst, x.blendSrcAlpha = w.blendSrcAlpha, x.blendDstAlpha = w.blendDstAlpha), x.blendColorMask !== w.blendColorMask && (h.colorMask(!!(1 & w.blendColorMask), !!(2 & w.blendColorMask), !!(4 & w.blendColorMask), !!(8 & w.blendColorMask)), x.blendColorMask = w.blendColorMask) } } if (e && e.gpuPipelineLayout && d) { for (var S = d.glBlocks.length, T = e.gpuPipelineLayout.dynamicOffsetIndices, I = 0; I < S; I++) { var E = d.glBlocks[I], A = n[E.set], C = A && A.descriptorIndices[E.binding], D = C >= 0 && A.gpuDescriptors[C], R = null, P = 0; if (D && D.gpuBuffer) { var B = D.gpuBuffer, M = T[E.set], O = M && M[E.binding]; O >= 0 && (P = r[O]), "vf32" in B ? R = B.vf32 : (P += B.offset, R = B.gpuBuffer.vf32), P >>= 2 } if (R) for (var L = E.glActiveUniforms.length, F = 0; F < L; F++) { var k = E.glActiveUniforms[F]; switch (k.glType) { case 35670: case 5124: for (var N = 0; N < k.array.length; ++N) { var z = k.offset + P + N; if (R[z] !== k.array[N]) { for (var U = N, V = z; U < k.array.length; ++U, ++V)k.array[U] = R[V]; h.uniform1iv(k.glLoc, k.array); break } } break; case 35671: case 35667: for (var G = 0; G < k.array.length; ++G) { var H = k.offset + P + G; if (R[H] !== k.array[G]) { for (var W = G, j = H; W < k.array.length; ++W, ++j)k.array[W] = R[j]; h.uniform2iv(k.glLoc, k.array); break } } break; case 35672: case 35668: for (var X = 0; X < k.array.length; ++X) { var q = k.offset + P + X; if (R[q] !== k.array[X]) { for (var Y = X, K = q; Y < k.array.length; ++Y, ++K)k.array[Y] = R[K]; h.uniform3iv(k.glLoc, k.array); break } } break; case 35673: case 35669: for (var Q = 0; Q < k.array.length; ++Q) { var Z = k.offset + P + Q; if (R[Z] !== k.array[Q]) { for (var J = Q, $ = Z; J < k.array.length; ++J, ++$)k.array[J] = R[$]; h.uniform4iv(k.glLoc, k.array); break } } break; case 5126: for (var tt = 0; tt < k.array.length; ++tt) { var et = k.offset + P + tt; if (R[et] !== k.array[tt]) { for (var it = tt, nt = et; it < k.array.length; ++it, ++nt)k.array[it] = R[nt]; h.uniform1fv(k.glLoc, k.array); break } } break; case 35664: for (var rt = 0; rt < k.array.length; ++rt) { var st = k.offset + P + rt; if (R[st] !== k.array[rt]) { for (var at = rt, ot = st; at < k.array.length; ++at, ++ot)k.array[at] = R[ot]; h.uniform2fv(k.glLoc, k.array); break } } break; case 35665: for (var ut = 0; ut < k.array.length; ++ut) { var ht = k.offset + P + ut; if (R[ht] !== k.array[ut]) { for (var ct = ut, lt = ht; ct < k.array.length; ++ct, ++lt)k.array[ct] = R[lt]; h.uniform3fv(k.glLoc, k.array); break } } break; case 35666: for (var ft = 0; ft < k.array.length; ++ft) { var dt = k.offset + P + ft; if (R[dt] !== k.array[ft]) { for (var pt = ft, _t = dt; pt < k.array.length; ++pt, ++_t)k.array[pt] = R[_t]; h.uniform4fv(k.glLoc, k.array); break } } break; case 35674: for (var gt = 0; gt < k.array.length; ++gt) { var mt = k.offset + P + gt; if (R[mt] !== k.array[gt]) { for (var vt = gt, yt = mt; vt < k.array.length; ++vt, ++yt)k.array[vt] = R[yt]; h.uniformMatrix2fv(k.glLoc, !1, k.array); break } } break; case 35675: for (var bt = 0; bt < k.array.length; ++bt) { var wt = k.offset + P + bt; if (R[wt] !== k.array[bt]) { for (var xt = bt, St = wt; xt < k.array.length; ++xt, ++St)k.array[xt] = R[St]; h.uniformMatrix3fv(k.glLoc, !1, k.array); break } } break; case 35676: for (var Tt = 0; Tt < k.array.length; ++Tt) { var It = k.offset + P + Tt; if (R[It] !== k.array[Tt]) { for (var Et = Tt, At = It; Et < k.array.length; ++Et, ++At)k.array[Et] = R[At]; h.uniformMatrix4fv(k.glLoc, !1, k.array); break } } } } } for (var Ct = d.glSamplerTextures.length, Dt = 0; Dt < Ct; Dt++)for (var Rt = d.glSamplerTextures[Dt], Pt = n[Rt.set], Bt = Pt && Pt.descriptorIndices[Rt.binding], Mt = Bt >= 0 && Pt.gpuDescriptors[Bt], Ot = Rt.units.length, Lt = 0; Lt < Ot; Lt++) { var Ft = Rt.units[Lt]; if (Mt && Mt.gpuSampler) { if (Mt.gpuTexture && Mt.gpuTexture.size > 0) { var kt = Mt.gpuTexture, Nt = c.glTexUnits[Ft]; Nt.glTexture !== kt.glTexture && (c.texUnit !== Ft && (h.activeTexture(33984 + Ft), c.texUnit = Ft), kt.glTexture ? h.bindTexture(kt.glTarget, kt.glTexture) : h.bindTexture(kt.glTarget, t.nullTex2D.gpuTexture.glTexture), Nt.glTexture = kt.glTexture); var zt = Mt.gpuSampler; kt.isPowerOf2 ? (a = zt.glWrapS, o = zt.glWrapT) : (a = 33071, o = 33071), u = kt.isPowerOf2 ? kt.mipLevel <= 1 && (9985 === zt.glMinFilter || 9987 === zt.glMinFilter) ? 9729 : zt.glMinFilter : 9729 === zt.glMinFilter || 9985 === zt.glMinFilter || 9987 === zt.glMinFilter ? 9729 : 9728, kt.glWrapS !== a && (c.texUnit !== Ft && (h.activeTexture(33984 + Ft), c.texUnit = Ft), h.texParameteri(kt.glTarget, 10242, a), kt.glWrapS = a), kt.glWrapT !== o && (c.texUnit !== Ft && (h.activeTexture(33984 + Ft), c.texUnit = Ft), h.texParameteri(kt.glTarget, 10243, o), kt.glWrapT = o), kt.glMinFilter !== u && (c.texUnit !== Ft && (h.activeTexture(33984 + Ft), c.texUnit = Ft), h.texParameteri(kt.glTarget, 10241, u), kt.glMinFilter = u), kt.glMagFilter !== zt.glMagFilter && (c.texUnit !== Ft && (h.activeTexture(33984 + Ft), c.texUnit = Ft), h.texParameteri(kt.glTarget, 10240, zt.glMagFilter), kt.glMagFilter = zt.glMagFilter) } Mt = Pt.gpuDescriptors[++Bt] } } } if (i && d && (p || TQ.gpuInputAssembler !== i)) { TQ.gpuInputAssembler = i; var Ut = t.extensions.ANGLE_instanced_arrays; if (t.extensions.useVAO) { var Vt = t.extensions.OES_vertex_array_object, Gt = i.glVAOs.get(d.glProgram); if (!Gt) { var Ht; Gt = Vt.createVertexArrayOES(), i.glVAOs.set(d.glProgram, Gt), Vt.bindVertexArrayOES(Gt), h.bindBuffer(34962, null), h.bindBuffer(34963, null), c.glArrayBuffer = null, c.glElementArrayBuffer = null; for (var Wt = d.glInputs.length, jt = 0; jt < Wt; jt++) { var Xt = d.glInputs[jt]; Ht = null; for (var qt = i.glAttribs.length, Yt = 0; Yt < qt; Yt++) { var Kt = i.glAttribs[Yt]; if (Kt.name === Xt.name) { Ht = Kt; break } } if (Ht) { c.glArrayBuffer !== Ht.glBuffer && (h.bindBuffer(34962, Ht.glBuffer), c.glArrayBuffer = Ht.glBuffer); for (var Qt = 0; Qt < Ht.componentCount; ++Qt) { var Zt = Xt.glLoc + Qt, Jt = Ht.offset + Ht.size * Qt; h.enableVertexAttribArray(Zt), c.glCurrentAttribLocs[Zt] = !0, h.vertexAttribPointer(Zt, Ht.count, Ht.glType, Ht.isNormalized, Ht.stride, Jt), Ut && Ut.vertexAttribDivisorANGLE(Zt, Ht.isInstanced ? 1 : 0) } } } var $t = i.gpuIndexBuffer; $t && h.bindBuffer(34963, $t.glBuffer), Vt.bindVertexArrayOES(null), h.bindBuffer(34962, null), h.bindBuffer(34963, null), c.glArrayBuffer = null, c.glElementArrayBuffer = null } c.glVAO !== Gt && (Vt.bindVertexArrayOES(Gt), c.glVAO = Gt) } else { for (var te = 0; te < t.capabilities.maxVertexAttributes; ++te)c.glCurrentAttribLocs[te] = !1; for (var ee = d.glInputs.length, ie = 0; ie < ee; ie++) { for (var ne = d.glInputs[ie], re = null, se = i.glAttribs.length, ae = 0; ae < se; ae++) { var oe = i.glAttribs[ae]; if (oe.name === ne.name) { re = oe; break } } if (re) { c.glArrayBuffer !== re.glBuffer && (h.bindBuffer(34962, re.glBuffer), c.glArrayBuffer = re.glBuffer); for (var ue = 0; ue < re.componentCount; ++ue) { var he = ne.glLoc + ue, ce = re.offset + re.size * ue; !c.glEnabledAttribLocs[he] && he >= 0 && (h.enableVertexAttribArray(he), c.glEnabledAttribLocs[he] = !0), c.glCurrentAttribLocs[he] = !0, h.vertexAttribPointer(he, re.count, re.glType, re.isNormalized, re.stride, ce), Ut && Ut.vertexAttribDivisorANGLE(he, re.isInstanced ? 1 : 0) } } } var le = i.gpuIndexBuffer; le && c.glElementArrayBuffer !== le.glBuffer && (h.bindBuffer(34963, le.glBuffer), c.glElementArrayBuffer = le.glBuffer); for (var fe = 0; fe < t.capabilities.maxVertexAttributes; ++fe)c.glEnabledAttribLocs[fe] !== c.glCurrentAttribLocs[fe] && (h.disableVertexAttribArray(fe), c.glEnabledAttribLocs[fe] = !1) } } if (e && e.dynamicStates.length) for (var de = e.dynamicStates.length, pe = 0; pe < de; pe++)switch (e.dynamicStates[pe]) { case 1: c.rs.lineWidth !== s.lineWidth && (h.lineWidth(s.lineWidth), c.rs.lineWidth = s.lineWidth); break; case 2: c.rs.depthBias === s.depthBiasConstant && c.rs.depthBiasSlop === s.depthBiasSlope || (h.polygonOffset(s.depthBiasConstant, s.depthBiasSlope), c.rs.depthBias = s.depthBiasConstant, c.rs.depthBiasSlop = s.depthBiasSlope); break; case 4: var _e = s.blendConstant; f.blendColor.x === _e.x && f.blendColor.y === _e.y && f.blendColor.z === _e.z && f.blendColor.w === _e.w || (h.blendColor(_e.x, _e.y, _e.z, _e.w), f.blendColor.copy(_e)); break; case 16: var ge = s.stencilStatesFront, me = s.stencilStatesBack; l.stencilWriteMaskFront !== ge.writeMask && (h.stencilMaskSeparate(1028, ge.writeMask), l.stencilWriteMaskFront = ge.writeMask), l.stencilWriteMaskBack !== me.writeMask && (h.stencilMaskSeparate(1029, me.writeMask), l.stencilWriteMaskBack = me.writeMask); break; case 32: var ve = s.stencilStatesFront, ye = s.stencilStatesBack; l.stencilRefFront === ve.reference && l.stencilReadMaskFront === ve.compareMask || (h.stencilFuncSeparate(1028, hQ[l.stencilFuncFront], ve.reference, ve.compareMask), l.stencilRefFront = ve.reference, l.stencilReadMaskFront = ve.compareMask), l.stencilRefBack === ye.reference && l.stencilReadMaskBack === ye.compareMask || (h.stencilFuncSeparate(1029, hQ[l.stencilFuncBack], ye.reference, ye.compareMask), l.stencilRefBack = ye.reference, l.stencilReadMaskBack = ye.compareMask) } } function CQ(t, e) { var i = t.gl, n = t.extensions, r = n.ANGLE_instanced_arrays, s = n.WEBGL_multi_draw, a = TQ.gpuInputAssembler, o = TQ.glPrimitive; if (a) { var u = a.gpuIndexBuffer; if (a.gpuIndirectBuffer) { var h = a.gpuIndirectBuffer.indirects; if (h.drawByIndex) { for (var c = 0; c < h.drawCount; c++)h.byteOffsets[c] = h.offsets[c] * u.stride; if (s) h.instancedDraw ? s.multiDrawElementsInstancedWEBGL(o, h.counts, 0, a.glIndexType, h.byteOffsets, 0, h.instances, 0, h.drawCount) : s.multiDrawElementsWEBGL(o, h.counts, 0, a.glIndexType, h.byteOffsets, 0, h.drawCount); else for (var l = 0; l < h.drawCount; l++)h.instances[l] && r ? r.drawElementsInstancedANGLE(o, h.counts[l], a.glIndexType, h.byteOffsets[l], h.instances[l]) : i.drawElements(o, h.counts[l], a.glIndexType, h.byteOffsets[l]) } else if (s) h.instancedDraw ? s.multiDrawArraysInstancedWEBGL(o, h.offsets, 0, h.counts, 0, h.instances, 0, h.drawCount) : s.multiDrawArraysWEBGL(o, h.offsets, 0, h.counts, 0, h.drawCount); else for (var f = 0; f < h.drawCount; f++)h.instances[f] && r ? r.drawArraysInstancedANGLE(o, h.offsets[f], h.counts[f], h.instances[f]) : i.drawArrays(o, h.offsets[f], h.counts[f]) } else if (e.instanceCount && r) if (u) { if (e.indexCount > 0) { var d = e.firstIndex * u.stride; r.drawElementsInstancedANGLE(o, e.indexCount, a.glIndexType, d, e.instanceCount) } } else e.vertexCount > 0 && r.drawArraysInstancedANGLE(o, e.firstVertex, e.vertexCount, e.instanceCount); else if (u) { if (e.indexCount > 0) { var p = e.firstIndex * u.stride; i.drawElements(o, e.indexCount, a.glIndexType, p) } } else e.vertexCount > 0 && i.drawArrays(o, e.firstVertex, e.vertexCount) } } function DQ(t, e, i, n) { var r = t.gl, s = t.stateCache, a = s.glTexUnits[s.texUnit]; a.glTexture !== i.glTexture && (r.bindTexture(i.glTarget, i.glTexture), a.glTexture = i.glTexture); var o = 0, u = 0; switch (i.glTarget) { case 3553: for (var h = 0; h < n.length; h++) { var c = n[h]; r.texSubImage2D(3553, c.texSubres.mipLevel, c.texOffset.x, c.texOffset.y, i.glFormat, i.glType, e[o++]) } break; case 34067: for (var l = 0; l < n.length; l++) { var f = n[l], d = f.texOffset, p = f.texSubres, _ = p.baseArrayLayer + p.layerCount; for (u = p.baseArrayLayer; u < _; ++u)r.texSubImage2D(34069 + u, p.mipLevel, d.x, d.y, i.glFormat, i.glType, e[o++]) } break; default: rt(16327) }1 & i.flags && i.isPowerOf2 && r.generateMipmap(i.glTarget) } var RQ = new Uint8Array(1); function PQ(t, e, i, n, r) { var s = t_(e).height, a = Kp(e, r.width, r.height, r.depth), o = Kp(e, n.width, 1, 1), u = Kp(e, n.width, n.height, 1), h = Kp(e, r.width, 1, 1), c = $p(Wp[e]); RQ.byteLength < a && (RQ = new Uint8Array(a)); for (var l = 0, f = i, d = 0; d < r.depth; d++) { f = i + u * d; for (var p = 0; p < r.height; p += s)RQ.subarray(l, l + h).set(new Uint8Array(t.buffer, t.byteOffset + f, h)), l += h, f += o } var _ = a / c.BYTES_PER_ELEMENT; return at(Number.isInteger(_), 9101), new c(RQ.buffer, 0, _) } function BQ(t, e, i, n) { var r = t.gl, s = t.stateCache, a = s.glTexUnits[s.texUnit]; a.glTexture !== i.glTexture && (r.bindTexture(i.glTarget, i.glTexture), a.glTexture = i.glTexture); var o = 0, u = 0, h = Wp[i.format], c = $p(h), l = h.isCompressed, f = t_(i.format), d = new zd, p = new kd, _ = new zd; switch (i.glTarget) { case 3553: for (var g = 0; g < n.length; g++) { var m = n[g], v = m.texSubres.mipLevel, y = m.texOffset, b = m.texExtent, w = b.width, x = b.height, S = f.width, T = f.height, I = m.buffStride; p.x = 0 === y.x ? 0 : e_(y.x, S), p.y = 0 === y.y ? 0 : e_(y.y, T), d.width = w < S ? w : e_(w, S), d.height = x < T ? w : e_(x, T), _.width = I > 0 ? I : d.width, _.height = m.buffTexHeight > 0 ? m.buffTexHeight : d.height; var E = w + p.x === i.width >> v ? w : d.width, A = x + p.y === i.height >> v ? x : d.height, C = void 0, D = e[o++]; if (_.width === d.width && _.height === d.height) { var R = Kp(i.format, E, A, 1) / c.BYTES_PER_ELEMENT; at(Number.isInteger(R), 9101), C = new c(D.buffer, D.byteOffset + m.buffOffset, R) } else C = PQ(D, i.format, m.buffOffset, _, d); l ? 36196 === i.glInternalFmt || t.extensions.noCompressedTexSubImage2D ? r.compressedTexImage2D(3553, v, i.glInternalFmt, E, A, 0, C) : r.compressedTexSubImage2D(3553, v, p.x, p.y, E, A, i.glFormat, C) : r.texSubImage2D(3553, v, p.x, p.y, E, A, i.glFormat, i.glType, C) } break; case 34067: for (var P = 0; P < n.length; P++) { var B = n[P], M = B.texSubres.mipLevel, O = B.texOffset, L = B.texExtent, F = B.texSubres, k = L.width, N = L.height, z = f.width, U = f.height; p.x = 0 === O.x ? 0 : e_(O.x, z), p.y = 0 === O.y ? 0 : e_(O.y, U), d.width = k < z ? k : e_(k, z), d.height = N < U ? k : e_(N, U), _.width = B.buffStride > 0 ? B.buffStride : d.width, _.height = B.buffTexHeight > 0 ? B.buffTexHeight : d.height; var V = k + p.x === i.width >> M ? k : d.width, G = N + p.y === i.height >> M ? N : d.height, H = F.baseArrayLayer + F.layerCount; for (u = F.baseArrayLayer; u < H; ++u) { var W = void 0, j = e[o++]; if (_.width === d.width && _.height === d.height) { var X = Kp(i.format, V, G, 1) / c.BYTES_PER_ELEMENT; at(Number.isInteger(X), 9101), W = new c(j.buffer, j.byteOffset + B.buffOffset, X) } else W = PQ(j, i.format, B.buffOffset, _, d); l ? 36196 === i.glInternalFmt || t.extensions.noCompressedTexSubImage2D ? r.compressedTexImage2D(34069 + u, M, i.glInternalFmt, V, G, 0, W) : r.compressedTexSubImage2D(34069 + u, M, p.x, p.y, V, G, i.glFormat, W) : r.texSubImage2D(34069 + u, M, p.x, p.y, V, G, i.glFormat, i.glType, W) } } break; default: rt(16327) }1 & i.flags && r.generateMipmap(i.glTarget) } function MQ(t, e, i, n) { var r = t.gl, s = t.stateCache, a = r.createFramebuffer(); r.bindFramebuffer(36160, a); var o = 0, u = 0, h = 1, c = 1; if (3553 === e.glTarget) for (var l = 0; l < n.length; l++) { var f = n[l]; r.framebufferTexture2D(36160, 36064, e.glTarget, e.glTexture, f.texSubres.mipLevel), o = f.texOffset.x, u = f.texOffset.y, h = f.texExtent.width, c = f.texExtent.height, r.readPixels(o, u, h, c, e.glFormat, e.glType, i[l]) } else rt(16399); r.bindFramebuffer(36160, null), s.glFramebuffer = null, r.deleteFramebuffer(a) } function OQ(t, e, i, n, r) { t.blitManager.draw(e, i, n, r) } var LQ = function () { function t() { } return t.setInstance = function (e) { t._instance = e }, n(t, null, [{ key: "instance", get: function () { return t._instance } }]), t }(); function FQ(t) { return new Int32Array(t) } LQ._instance = null; var kQ = function () { function t() { this.drawCount = 0, this.drawByIndex = !1, this.instancedDraw = !1, this._capacity = 4, this.counts = FQ(this._capacity), this.offsets = FQ(this._capacity), this.instances = FQ(this._capacity), this.byteOffsets = FQ(this._capacity) } var e = t.prototype; return e.clearDraws = function () { this.drawCount = 0, this.drawByIndex = !1, this.instancedDraw = !1 }, e.setDrawInfo = function (t, e) { this._ensureCapacity(t), this.drawByIndex = e.indexCount > 0, this.instancedDraw = !!e.instanceCount, this.drawCount = Math.max(t + 1, this.drawCount), this.drawByIndex ? (this.counts[t] = e.indexCount, this.offsets[t] = e.firstIndex) : (this.counts[t] = e.vertexCount, this.offsets[t] = e.firstVertex), this.instances[t] = Math.max(1, e.instanceCount) }, e._ensureCapacity = function (t) { if (!(this._capacity > t)) { this._capacity = P(t); var e = FQ(this._capacity), i = FQ(this._capacity), n = FQ(this._capacity); this.byteOffsets = FQ(this._capacity), e.set(this.counts), i.set(this.offsets), n.set(this.instances), this.counts = e, this.offsets = i, this.instances = n } }, t }(), NQ = function () { function t() { this._gpuShader = null, this._gpuDescriptorSetLayout = null, this._gpuPipelineLayout = null, this._gpuPipelineState = null, this._gpuVertexBuffer = null, this._gpuInputAssembler = null, this._gpuPointSampler = null, this._gpuLinearSampler = null, this._gpuDescriptorSet = null, this._gpuUniformBuffer = null, this._drawInfo = null, this._glFramebuffer = null, this._uniformBuffer = null; var t = LQ.instance.bindingMappingInfo.maxBlockCounts[0]; this._gpuShader = { name: "Blit Pass", blocks: [new ap(0, 0, "BlitParams", [new sp("tilingOffsetSrc", 16, 1), new sp("tilingOffsetDst", 16, 1)], 1)], samplerTextures: [new op(0, t, "textureSrc", 28, 1)], subpassInputs: [], gpuStages: [{ type: 1, source: "\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nuniform vec4 tilingOffsetSrc;\nuniform vec4 tilingOffsetDst;\nvarying vec2 v_texCoord;\nvoid main() {\n    v_texCoord = a_texCoord * tilingOffsetSrc.xy + tilingOffsetSrc.zw;\n    gl_Position = vec4((a_position + 1.0) * tilingOffsetDst.xy - 1.0 + tilingOffsetDst.zw * 2.0, 0, 1);\n}", glShader: null }, { type: 16, source: "\nprecision mediump float;\nuniform sampler2D textureSrc;\nvarying vec2 v_texCoord;\nvoid main() {\n    gl_FragColor = texture2D(textureSrc, v_texCoord);\n}", glShader: null }], glProgram: null, glInputs: [], glUniforms: [], glBlocks: [], glSamplerTextures: [] }, bQ(LQ.instance, this._gpuShader), this._gpuDescriptorSetLayout = { bindings: [new Ap(0, 1, 1, 1), new Ap(t, 16, 1, 16)], dynamicBindings: [], descriptorIndices: [], descriptorCount: t + 1 }; for (var e = 0; e < t; e++)this._gpuDescriptorSetLayout.descriptorIndices[e] = 0; this._gpuDescriptorSetLayout.descriptorIndices.push(1), this._gpuPipelineLayout = { gpuSetLayouts: [this._gpuDescriptorSetLayout], dynamicOffsetCount: 0, dynamicOffsetOffsets: [0], dynamicOffsetIndices: [[]] }, this._gpuPipelineState = { glPrimitive: 5, gpuShader: this._gpuShader, gpuPipelineLayout: this._gpuPipelineLayout, rs: null, dss: new p_(!1, !1), bs: null, dynamicStates: [], gpuRenderPass: null }, this._gpuVertexBuffer = { usage: 8, memUsage: 1, size: 64, stride: 16, buffer: null, vf32: null, indirects: new kQ, glTarget: 0, glBuffer: null }, dQ(LQ.instance, this._gpuVertexBuffer), LQ.instance.memoryStatus.bufferSize += this._gpuVertexBuffer.size; var i = new Float32Array([-1, -1, 0, 0, 1, -1, 1, 0, -1, 1, 0, 1, 1, 1, 1, 1]); _Q(LQ.instance, this._gpuVertexBuffer, i, 0, i.length), this._gpuInputAssembler = { attributes: [new pp("a_position", 21), new pp("a_texCoord", 21)], gpuVertexBuffers: [this._gpuVertexBuffer], gpuIndexBuffer: null, gpuIndirectBuffer: null, glAttribs: [], glIndexType: 0, glVAOs: new Map }, xQ(LQ.instance, this._gpuInputAssembler), this._gpuPointSampler = { glMinFilter: 9728, glMagFilter: 9728, glWrapS: 10497, glWrapT: 10497, glWrapR: 10497 }, this._gpuLinearSampler = { glMinFilter: 9729, glMagFilter: 9729, glWrapS: 10497, glWrapT: 10497, glWrapR: 10497 }, this._uniformBuffer = new Float32Array(8), this._gpuUniformBuffer = { usage: 16, memUsage: 1, size: 32, stride: 32, buffer: this._uniformBuffer, vf32: null, indirects: new kQ, glTarget: 0, glBuffer: null }, dQ(LQ.instance, this._gpuUniformBuffer), LQ.instance.memoryStatus.bufferSize += this._gpuUniformBuffer.size, this._gpuDescriptorSet = { gpuDescriptors: [{ type: 1, gpuBuffer: this._gpuUniformBuffer, gpuTexture: null, gpuSampler: null }, { type: 16, gpuBuffer: null, gpuTexture: null, gpuSampler: null }], descriptorIndices: this._gpuDescriptorSetLayout.descriptorIndices }, this._drawInfo = new $d(4, 0, 0, 0, 0, 0, 0), this._glFramebuffer = LQ.instance.gl.createFramebuffer() } var e = t.prototype; return e.destroy = function () { this._glFramebuffer && (LQ.instance.gl.deleteFramebuffer(this._glFramebuffer), this._glFramebuffer = null), this._gpuVertexBuffer && (LQ.instance.memoryStatus.bufferSize -= this._gpuVertexBuffer.size, pQ(LQ.instance, this._gpuVertexBuffer)), this._gpuUniformBuffer && (LQ.instance.memoryStatus.bufferSize -= this._gpuUniformBuffer.size, pQ(LQ.instance, this._gpuUniformBuffer)), this._gpuShader && wQ(LQ.instance, this._gpuShader), this._gpuInputAssembler && SQ(LQ.instance, this._gpuInputAssembler) }, e.draw = function (t, e, i, n) { var r = LQ.instance, s = r.gl, a = r.stateCache, o = a.glFramebuffer; if (s.viewport(0, 0, e.width, e.height), s.scissor(0, 0, e.width, e.height), this._uniformBuffer && this._gpuUniformBuffer && this._gpuPipelineState && this._gpuInputAssembler && this._gpuDescriptorSet && this._drawInfo) { var u = this._gpuDescriptorSet.gpuDescriptors[1]; u.gpuTexture = t, u.gpuSampler = 1 === n ? this._gpuPointSampler : this._gpuLinearSampler; var h = Wp[e.format], c = 36064; h.hasStencil ? c = 33306 : h.hasDepth && (c = 36096); var l = i.map((function (t, e) { return e })); l.sort((function (t, e) { return i[t].srcSubres.mipLevel - i[e].srcSubres.mipLevel })), a.glFramebuffer !== this._glFramebuffer && (s.bindFramebuffer(36160, this._glFramebuffer), a.glFramebuffer = this._glFramebuffer); var f = i[0].dstSubres.mipLevel; e.glTexture ? s.framebufferTexture2D(36160, c, e.glTarget, e.glTexture, f) : s.framebufferRenderbuffer(36160, c, 36161, e.glRenderbuffer); for (var d = 0; d < l.length; ++d) { var p = i[l[d]]; t.glTexture && f !== p.srcSubres.mipLevel && (f = p.srcSubres.mipLevel, s.framebufferTexture2D(36160, c, e.glTarget, e.glTexture, f)); var _ = t.width, g = t.height, m = e.width, v = e.height; this._uniformBuffer[0] = p.srcExtent.width / _, this._uniformBuffer[1] = p.srcExtent.height / g, this._uniformBuffer[2] = p.srcOffset.x / _, this._uniformBuffer[3] = p.srcOffset.y / g, this._uniformBuffer[4] = p.dstExtent.width / m, this._uniformBuffer[5] = p.dstExtent.height / v, this._uniformBuffer[6] = p.dstOffset.x / m, this._uniformBuffer[7] = p.dstOffset.y / v, _Q(r, this._gpuUniformBuffer, this._uniformBuffer, 0, 4 * this._uniformBuffer.length), AQ(r, this._gpuPipelineState, this._gpuInputAssembler, [this._gpuDescriptorSet], [], null), CQ(r, this._drawInfo) } a.glFramebuffer !== o && (s.bindFramebuffer(36160, o), a.glFramebuffer = o); var y = a.viewport; s.viewport(y.left, y.top, y.width, y.height); var b = a.scissorRect; s.scissor(b.x, b.y, b.width, b.height) } }, t }(), zQ = function (t) { function e() { var e; return (e = t.call(this) || this)._gpuBuffer = null, e._gpuBufferView = null, e._uniformBuffer = null, e } s(e, t); var i = e.prototype; return i.initialize = function (t) { if ("buffer" in t) { this._isBufferView = !0; var e = t.buffer; this._usage = e.usage, this._memUsage = e.memUsage, this._size = this._stride = t.range, this._count = 1, this._flags = e.flags, this._gpuBufferView = { gpuBuffer: e.gpuBuffer, offset: t.offset, range: t.range } } else this._usage = t.usage, this._memUsage = t.memUsage, this._size = t.size, this._stride = Math.max(t.stride || this._size, 1), this._count = this._size / this._stride, this._flags = t.flags, 16 & this._usage && this._size > 0 && (this._uniformBuffer = new Uint8Array(this._size)), this._gpuBuffer = { usage: this._usage, memUsage: this._memUsage, size: this._size, stride: this._stride, buffer: null, vf32: null, indirects: new kQ, glTarget: 0, glBuffer: null }, 16 & this._usage && (this._gpuBuffer.buffer = this._uniformBuffer), dQ(LQ.instance, this._gpuBuffer), LQ.instance.memoryStatus.bufferSize += this._size }, i.destroy = function () { this._gpuBuffer && (pQ(LQ.instance, this._gpuBuffer), LQ.instance.memoryStatus.bufferSize -= this._size, this._gpuBuffer = null), this._gpuBufferView && (this._gpuBufferView = null) }, i.resize = function (t) { if (this._isBufferView) it(16379); else { var e, i, n, r, s, a = this._size; a !== t && (this._size = t, this._count = this._size / this._stride, this._uniformBuffer && (this._uniformBuffer = new Uint8Array(t)), this._gpuBuffer && (this._uniformBuffer && (this._gpuBuffer.buffer = this._uniformBuffer), this._gpuBuffer.size = t, t > 0 && (e = LQ.instance, i = this._gpuBuffer, n = e.gl, r = e.stateCache, s = 2 & i.memUsage ? 35048 : 35044, 8 & i.usage ? (e.extensions.useVAO && r.glVAO && (e.extensions.OES_vertex_array_object.bindVertexArrayOES(null), r.glVAO = null), TQ.gpuInputAssembler = null, r.glArrayBuffer !== i.glBuffer && n.bindBuffer(34962, i.glBuffer), i.buffer ? n.bufferData(34962, i.buffer, s) : n.bufferData(34962, i.size, s), n.bindBuffer(34962, null), r.glArrayBuffer = null) : 4 & i.usage ? (e.extensions.useVAO && r.glVAO && (e.extensions.OES_vertex_array_object.bindVertexArrayOES(null), r.glVAO = null), TQ.gpuInputAssembler = null, r.glElementArrayBuffer !== i.glBuffer && n.bindBuffer(34963, i.glBuffer), i.buffer ? n.bufferData(34963, i.buffer, s) : n.bufferData(34963, i.size, s), n.bindBuffer(34963, null), r.glElementArrayBuffer = null) : 16 & i.usage ? i.buffer && (i.vf32 = new Float32Array(i.buffer.buffer)) : (64 & i.usage || 2 & i.usage || 1 & i.usage || rt(16315), i.glTarget = 0), LQ.instance.memoryStatus.bufferSize -= a, LQ.instance.memoryStatus.bufferSize += t))) } }, i.update = function (t, e) { var i; this._isBufferView ? it(16380) : (i = void 0 !== e ? e : 64 & this._usage ? 0 : t.byteLength, _Q(LQ.instance, this._gpuBuffer, t, 0, i)) }, n(e, [{ key: "gpuBuffer", get: function () { return this._gpuBuffer } }, { key: "gpuBufferView", get: function () { return this._gpuBufferView } }]), e }(n_), UQ = function (t) { function e() { var e; return (e = t.call(this) || this)._isInRenderPass = !1, e._curGPUPipelineState = null, e._curGPUInputAssembler = null, e._curGPUDescriptorSets = [], e._curDynamicOffsets = Array(8).fill(0), e._curDynamicStates = new Np, e._isStateInvalied = !1, e } s(e, t); var i = e.prototype; return i.initialize = function (t) { this._type = t.type, this._queue = t.queue; for (var e = LQ.instance.bindingMappings.blockOffsets.length, i = 0; i < e; i++)this._curGPUDescriptorSets.push(null) }, i.destroy = function () { }, i.begin = function () { this._curGPUPipelineState = null, this._curGPUInputAssembler = null, this._curGPUDescriptorSets.length = 0, this._numDrawCalls = 0, this._numInstances = 0, this._numTris = 0 }, i.end = function () { this._isStateInvalied && this.bindStates(), this._isInRenderPass = !1 }, i.beginRenderPass = function () { rt(16401), this._isInRenderPass = !0 }, i.endRenderPass = function () { this._isInRenderPass = !1 }, i.bindPipelineState = function (t) { var e = t.gpuPipelineState; e !== this._curGPUPipelineState && (this._curGPUPipelineState = e, this._isStateInvalied = !0) }, i.bindDescriptorSet = function (t, e, i) { var n = e.gpuDescriptorSet; if (n !== this._curGPUDescriptorSets[t] && (this._curGPUDescriptorSets[t] = n, this._isStateInvalied = !0), i) { var r, s = null == (r = this._curGPUPipelineState) ? void 0 : r.gpuPipelineLayout; if (s) { for (var a = this._curDynamicOffsets, o = s.dynamicOffsetOffsets[t], u = 0; u < i.length; u++)a[o + u] = i[u]; this._isStateInvalied = !0 } } }, i.bindInputAssembler = function (t) { var e = t.getGpuInputAssembler(); this._curGPUInputAssembler = e, this._isStateInvalied = !0 }, i.setViewport = function (t) { var e = this._curDynamicStates.viewport; e.left === t.left && e.top === t.top && e.width === t.width && e.height === t.height && e.minDepth === t.minDepth && e.maxDepth === t.maxDepth || (e.left = t.left, e.top = t.top, e.width = t.width, e.height = t.height, e.minDepth = t.minDepth, e.maxDepth = t.maxDepth, this._isStateInvalied = !0) }, i.setScissor = function (t) { var e = this._curDynamicStates.scissor; e.x === t.x && e.y === t.y && e.width === t.width && e.height === t.height || (e.x = t.x, e.y = t.y, e.width = t.width, e.height = t.height, this._isStateInvalied = !0) }, i.setLineWidth = function (t) { this._curDynamicStates.lineWidth !== t && (this._curDynamicStates.lineWidth = t, this._isStateInvalied = !0) }, i.setDepthBias = function (t, e, i) { var n = this._curDynamicStates; n.depthBiasConstant === t && n.depthBiasClamp === e && n.depthBiasSlope === i || (n.depthBiasConstant = t, n.depthBiasClamp = e, n.depthBiasSlope = i, this._isStateInvalied = !0) }, i.setBlendConstants = function (t) { var e = this._curDynamicStates.blendConstant; e.x === t.x && e.y === t.y && e.z === t.z && e.w === t.w || (e.copy(t), this._isStateInvalied = !0) }, i.setDepthBound = function (t, e) { var i = this._curDynamicStates; i.depthMinBounds === t && i.depthMaxBounds === e || (i.depthMinBounds = t, i.depthMaxBounds = e, this._isStateInvalied = !0) }, i.setStencilWriteMask = function (t, e) { var i = this._curDynamicStates.stencilStatesFront, n = this._curDynamicStates.stencilStatesBack; 1 & t && i.writeMask !== e && (i.writeMask = e, this._isStateInvalied = !0), 2 & t && n.writeMask !== e && (n.writeMask = e, this._isStateInvalied = !0) }, i.setStencilCompareMask = function (t, e, i) { var n = this._curDynamicStates.stencilStatesFront, r = this._curDynamicStates.stencilStatesBack; 1 & t && (n.compareMask === i && n.reference === e || (n.reference = e, n.compareMask = i, this._isStateInvalied = !0)), 2 & t && (r.compareMask === i && r.reference === e || (r.reference = e, r.compareMask = i, this._isStateInvalied = !0)) }, i.draw = function () { rt(16328) }, i.updateBuffer = function () { rt(16329) }, i.copyBuffersToTexture = function () { rt(16330) }, i.execute = function () { rt(16402) }, i.pipelineBarrier = function () { }, i.bindStates = function () { rt(16401) }, i.blitTexture = function () { rt(16401) }, e }(r_), VQ = function (t) { s(i, t); var e = i.prototype; function i() { var e; return (e = t.call(this) || this)._gpuFramebuffer = null, e._gpuColorTextures = [], e._gpuDepthStencilTexture = void 0, e } return e.getGpuFramebuffer = function () { return this._gpuFramebuffer }, e.initialize = function (t) { var e, i = this; this._renderPass = t.renderPass, this._colorTextures = t.colorTextures || []; for (var n = this._depthStencilTexture = t.depthStencilTexture || null, r = 0, s = [], a = 0; a < t.colorTextures.length; ++a) { var o = t.colorTextures[a]; o && (s.push(o.gpuTexture), r = o.lodLevel) } var u = null; n && (u = n.gpuTexture, r = n.lodLevel); var h = Number.MAX_SAFE_INTEGER, c = Number.MAX_SAFE_INTEGER; this._gpuFramebuffer = { gpuRenderPass: t.renderPass.gpuRenderPass, gpuColorTextures: s, gpuDepthStencilTexture: u, glFramebuffer: null, isOffscreen: !0, get width() { return this.gpuColorTextures.length > 0 ? this.gpuColorTextures[0].width : this.gpuDepthStencilTexture ? this.gpuDepthStencilTexture.width : h }, set width(t) { h = t }, get height() { return this.gpuColorTextures.length > 0 ? this.gpuColorTextures[0].height : this.gpuDepthStencilTexture ? this.gpuDepthStencilTexture.height : c }, set height(t) { c = t }, lodLevel: r }, yQ(LQ.instance, this._gpuFramebuffer), this._gpuFramebuffer.gpuColorTextures.forEach((function (t) { return i._gpuColorTextures.push(t.glTexture) })), this._gpuDepthStencilTexture = null == (e = this._gpuFramebuffer.gpuDepthStencilTexture) ? void 0 : e.glTexture, this._width = this._gpuFramebuffer.width, this._height = this._gpuFramebuffer.height }, e.destroy = function () { var t, e, i, n; this._gpuFramebuffer && (t = LQ.instance, e = this._gpuFramebuffer, i = t.gl, n = t.stateCache, e.glFramebuffer && (i.deleteFramebuffer(e.glFramebuffer), n.glFramebuffer === e.glFramebuffer && (i.bindFramebuffer(36160, null), n.glFramebuffer = null), e.glFramebuffer = null), this._gpuFramebuffer = null, this._gpuColorTextures.length = 0, this._gpuDepthStencilTexture = null) }, n(i, [{ key: "needRebuild", get: function () { var t = this._gpuFramebuffer; if (t) { for (var e, i = 0; i < t.gpuColorTextures.length; i++)if (t.gpuColorTextures[i].glTexture !== this._gpuColorTextures[i]) return !0; if ((null == (e = t.gpuDepthStencilTexture) ? void 0 : e.glTexture) !== this._gpuDepthStencilTexture) return !0 } return !1 } }]), i }(u_), GQ = function (t) { s(i, t); var e = i.prototype; function i() { var e; return (e = t.call(this) || this)._gpuInputAssembler = null, e } return e.getGpuInputAssembler = function () { return this._gpuInputAssembler }, e.initialize = function (t) { if (0 !== t.vertexBuffers.length) { if (this._attributes = t.attributes, this._attributesHash = this.computeAttributesHash(), this._vertexBuffers = t.vertexBuffers, t.indexBuffer) this._indexBuffer = t.indexBuffer, this._drawInfo.indexCount = this._indexBuffer.size / this._indexBuffer.stride, this._drawInfo.firstIndex = 0; else { var e = this._vertexBuffers[0]; this._drawInfo.vertexCount = e.size / e.stride, this._drawInfo.firstVertex = 0, this._drawInfo.vertexOffset = 0 } this._drawInfo.instanceCount = 0, this._drawInfo.firstInstance = 0, this._indirectBuffer = t.indirectBuffer || null; for (var i = new Array(t.vertexBuffers.length), n = 0; n < t.vertexBuffers.length; ++n) { var r = t.vertexBuffers[n]; r.gpuBuffer && (i[n] = r.gpuBuffer) } var s = null, a = 0; if (t.indexBuffer && (s = t.indexBuffer.gpuBuffer)) switch (s.stride) { case 1: a = 5121; break; case 2: a = 5123; break; case 4: a = 5125; break; default: rt(16332) }var o = null; t.indirectBuffer && (o = t.indirectBuffer.gpuBuffer), this._gpuInputAssembler = { attributes: t.attributes, gpuVertexBuffers: i, gpuIndexBuffer: s, gpuIndirectBuffer: o, glAttribs: [], glIndexType: a, glVAOs: new Map }, xQ(LQ.instance, this._gpuInputAssembler) } else rt(16331) }, e.destroy = function () { var t = LQ.instance; this._gpuInputAssembler && t.extensions.useVAO && SQ(t, this._gpuInputAssembler), this._gpuInputAssembler = null }, i }(h_), HQ = function (t) { function e() { var e; return (e = t.call(this) || this)._gpuDescriptorSetLayout = null, e } s(e, t); var i = e.prototype; return i.initialize = function (t) { Array.prototype.push.apply(this._bindings, t.bindings); for (var e = 0, i = -1, n = [], r = 0; r < this._bindings.length; r++) { var s = this._bindings[r]; n.push(e), e += s.count, s.binding > i && (i = s.binding) } this._bindingIndices = Array(i + 1).fill(-1); for (var a = this._descriptorIndices = Array(i + 1).fill(-1), o = 0; o < this._bindings.length; o++) { var u = this._bindings[o]; this._bindingIndices[u.binding] = o, a[u.binding] = n[o] } for (var h = [], c = 0; c < this._bindings.length; c++) { var l = this._bindings[c]; if (10 & l.descriptorType) for (var f = 0; f < l.count; f++)h.push(l.binding) } this._gpuDescriptorSetLayout = { bindings: this._bindings, dynamicBindings: h, descriptorIndices: a, descriptorCount: e } }, i.destroy = function () { this._bindings.length = 0 }, n(e, [{ key: "gpuDescriptorSetLayout", get: function () { return this._gpuDescriptorSetLayout } }]), e }(l_), WQ = function (t) { function e() { var e; return (e = t.call(this) || this)._gpuPipelineLayout = null, e } s(e, t); var i = e.prototype; return i.initialize = function (t) { Array.prototype.push.apply(this._setLayouts, t.setLayouts); for (var e = [], i = [], n = 0, r = [], s = 0; s < this._setLayouts.length; s++) { for (var a = this._setLayouts[s], o = a.gpuDescriptorSetLayout.dynamicBindings, u = Array(a.bindingIndices.length).fill(-1), h = 0; h < o.length; h++) { var c = o[h]; u[c] < 0 && (u[c] = n + h) } i.push(a.gpuDescriptorSetLayout), e.push(u), r.push(n), n += o.length } this._gpuPipelineLayout = { gpuSetLayouts: i, dynamicOffsetIndices: e, dynamicOffsetCount: n, dynamicOffsetOffsets: r } }, i.destroy = function () { this._setLayouts.length = 0 }, n(e, [{ key: "gpuPipelineLayout", get: function () { return this._gpuPipelineLayout } }]), e }(f_), jQ = [0, 1, 3, 2, 0, 0, 0, 4, 5, 6, 0, 0, 0, 0], XQ = function (t) { function e() { var e; return (e = t.call(this) || this)._gpuPipelineState = null, e } s(e, t); var i = e.prototype; return i.initialize = function (t) { this._primitive = t.primitive, this._shader = t.shader, this._pipelineLayout = t.pipelineLayout; var e = this._bs; if (t.blendState) { var i = t.blendState, n = i.targets; n && n.forEach((function (t, i) { e.setTarget(i, t) })), void 0 !== i.isA2C && (e.isA2C = i.isA2C), void 0 !== i.isIndepend && (e.isIndepend = i.isIndepend), void 0 !== i.blendColor && (e.blendColor = i.blendColor) } Object.assign(this._rs, t.rasterizerState), Object.assign(this._dss, t.depthStencilState), this._is = t.inputState, this._renderPass = t.renderPass, this._dynamicStates = t.dynamicStates; for (var r = [], s = 0; s < 31; s++)this._dynamicStates & 1 << s && r.push(1 << s); this._gpuPipelineState = { glPrimitive: jQ[t.primitive], gpuShader: t.shader.gpuShader, gpuPipelineLayout: t.pipelineLayout.gpuPipelineLayout, rs: t.rasterizerState, dss: t.depthStencilState, bs: t.blendState, gpuRenderPass: t.renderPass.gpuRenderPass, dynamicStates: r } }, i.destroy = function () { this._gpuPipelineState = null }, n(e, [{ key: "gpuPipelineState", get: function () { return this._gpuPipelineState } }]), e }(v_), qQ = function (t) { function e() { return t.apply(this, arguments) || this } s(e, t); var i = e.prototype; return i.beginRenderPass = function (t, e, i, n, r, s) { EQ(LQ.instance, t.gpuRenderPass, e.getGpuFramebuffer(), i, n, r, s), this._isInRenderPass = !0 }, i.draw = function (t) { if (this._isInRenderPass) { this._isStateInvalied && this.bindStates(); var e = "drawInfo" in t ? t.drawInfo : t; CQ(LQ.instance, e), ++this._numDrawCalls, this._numInstances += e.instanceCount; var i = e.indexCount || e.vertexCount; if (this._curGPUPipelineState) switch (this._curGPUPipelineState.glPrimitive) { case 4: this._numTris += i / 3 * Math.max(e.instanceCount, 1); break; case 5: case 6: this._numTris += (i - 2) * Math.max(e.instanceCount, 1) } } else rt(16328) }, i.setViewport = function (t) { var e = LQ.instance, i = e.stateCache, n = e.gl; i.viewport.left === t.left && i.viewport.top === t.top && i.viewport.width === t.width && i.viewport.height === t.height || (n.viewport(t.left, t.top, t.width, t.height), i.viewport.left = t.left, i.viewport.top = t.top, i.viewport.width = t.width, i.viewport.height = t.height) }, i.setScissor = function (t) { var e = LQ.instance, i = e.stateCache, n = e.gl; i.scissorRect.x === t.x && i.scissorRect.y === t.y && i.scissorRect.width === t.width && i.scissorRect.height === t.height || (n.scissor(t.x, t.y, t.width, t.height), i.scissorRect.x = t.x, i.scissorRect.y = t.y, i.scissorRect.width = t.width, i.scissorRect.height = t.height) }, i.updateBuffer = function (t, e, i) { if (this._isInRenderPass) rt(16329); else { var n, r = t.gpuBuffer; r && (n = void 0 !== i ? i : 64 & t.usage ? 0 : e.byteLength, _Q(LQ.instance, r, e, 0, n)) } }, i.copyBuffersToTexture = function (t, e, i) { if (this._isInRenderPass) rt(16330); else { var n = e.gpuTexture; n && BQ(LQ.instance, t, n, i) } }, i.execute = function () { rt(16402) }, i.bindStates = function () { AQ(LQ.instance, this._curGPUPipelineState, this._curGPUInputAssembler, this._curGPUDescriptorSets, this._curDynamicOffsets, this._curDynamicStates), this._isStateInvalied = !1 }, i.blitTexture = function (t, e, i, n) { var r = t.gpuTexture, s = e.gpuTexture; OQ(LQ.instance, r, s, i, n) }, e }(UQ), YQ = function (t) { function e() { var e; return (e = t.call(this) || this).numDrawCalls = 0, e.numInstances = 0, e.numTris = 0, e } s(e, t); var i = e.prototype; return i.initialize = function (t) { this._type = t.type }, i.destroy = function () { }, i.submit = function (t) { for (var e = t.length, i = 0; i < e; i++) { var n = t[i]; this.numDrawCalls += n.numDrawCalls, this.numInstances += n.numInstances, this.numTris += n.numTris } }, i.clear = function () { this.numDrawCalls = 0, this.numInstances = 0, this.numTris = 0 }, e }(y_), KQ = function (t) { function e() { var e; return (e = t.call(this) || this)._gpuRenderPass = null, e } s(e, t); var i = e.prototype; return i.initialize = function (t) { this._colorInfos = t.colorAttachments, this._depthStencilInfo = t.depthStencilAttachment, this._subpasses = t.subpasses, this._gpuRenderPass = { colorAttachments: this._colorInfos, depthStencilAttachment: this._depthStencilInfo }, this._hash = this.computeHash() }, i.destroy = function () { this._gpuRenderPass = null }, n(e, [{ key: "gpuRenderPass", get: function () { return this._gpuRenderPass } }]), e }(b_), QQ = [10497, 33648, 33071, 33071], ZQ = function (t) { function e(e, i) { var n; (n = t.call(this, e, i) || this)._gpuSampler = null; var r, s, a = n._info.minFilter, o = n._info.magFilter, u = n._info.mipFilter; r = 2 === a || 3 === a ? 2 === u || 3 === u ? 9987 : 1 === u ? 9985 : 9729 : 2 === u || 3 === u ? 9986 : 1 === u ? 9984 : 9728, s = 2 === o || 3 === o ? 9729 : 9728; var h = QQ[n._info.addressU], c = QQ[n._info.addressV], l = QQ[n._info.addressW]; return n._gpuSampler = { glMinFilter: r, glMagFilter: s, glWrapS: h, glWrapT: c, glWrapR: l }, n } return s(e, t), n(e, [{ key: "gpuSampler", get: function () { return this._gpuSampler } }]), e }(w_), JQ = function (t) { function e() { var e; return (e = t.call(this) || this)._gpuShader = null, e } s(e, t); var i = e.prototype; return i.initialize = function (t) { this._name = t.name, this._stages = t.stages, this._attributes = t.attributes, this._blocks = t.blocks, this._samplers = t.samplers, this._gpuShader = { name: t.name, blocks: t.blocks.slice(), samplerTextures: t.samplerTextures.slice(), subpassInputs: t.subpassInputs.slice(), gpuStages: new Array(t.stages.length), glProgram: null, glInputs: [], glUniforms: [], glBlocks: [], glSamplerTextures: [] }; for (var e = 0; e < t.stages.length; ++e) { var i = t.stages[e]; this._gpuShader.gpuStages[e] = { type: i.stage, source: i.source, glShader: null } } }, i.destroy = function () { this._gpuShader && (wQ(LQ.instance, this._gpuShader), this._gpuShader = null) }, n(e, [{ key: "gpuShader", get: function () { return null === this._gpuShader.glProgram && bQ(LQ.instance, this._gpuShader), this._gpuShader } }]), e }(x_), $Q = function () { function t() { this.glArrayBuffer = null, this.glElementArrayBuffer = null, this.glVAO = null, this.texUnit = 0, this.glTexUnits = [], this.glRenderbuffer = null, this.glFramebuffer = null, this.viewport = new jd, this.scissorRect = new Nd(0, 0, 0, 0), this.rs = new d_, this.dss = new p_, this.bs = new g_, this.glProgram = null, this.glEnabledAttribLocs = [], this.glCurrentAttribLocs = [], this.texUnitCacheMap = {} } return t.prototype.initialize = function (t, e) { for (var i = 0; i < t; ++i)this.glTexUnits.push({ glTexture: null }); this.glEnabledAttribLocs.length = e, this.glEnabledAttribLocs.fill(!1), this.glCurrentAttribLocs.length = e, this.glCurrentAttribLocs.fill(!1) }, t }(), tZ = function (t) { function e() { var e; return (e = t.call(this) || this)._gpuTexture = null, e._lodLevel = 0, e } s(e, t); var i = e.prototype; return i.initialize = function (t, e) { var i = this, n = LQ.instance, r = t, s = t; "texture" in t && (r = s.texture.info, i._isTextureView = !0); var a = i._info; a.copy(r); var o = i._viewInfo; i._isPowerOf2 = qp(a.width) && qp(a.height), i._size = Qp(a.format, i.width, i.height, i.depth, a.levelCount) * a.layerCount, i._isTextureView ? (o.copy(s), i._lodLevel = s.baseLevel, i._gpuTexture = s.texture._gpuTexture) : (i._gpuTexture = { type: r.type, format: r.format, usage: r.usage, width: r.width, height: r.height, depth: r.depth, size: i._size, arrayLayer: r.layerCount, mipLevel: r.levelCount, samples: r.samples, flags: r.flags, isPowerOf2: i._isPowerOf2, glTarget: 0, glInternalFmt: 0, glFormat: 0, glType: 0, glUsage: 0, glTexture: null, glRenderbuffer: null, glWrapS: 0, glWrapT: 0, glMinFilter: 0, glMagFilter: 0, isSwapchainTexture: e || !1 }, i._gpuTexture.isSwapchainTexture || (gQ(n, i._gpuTexture), n.memoryStatus.textureSize += i._size), o.texture = i, o.type = t.type, o.format = t.format, o.baseLevel = 0, o.levelCount = t.levelCount, o.baseLayer = 0, o.layerCount = t.layerCount) }, i.destroy = function () { var t = this, e = LQ.instance; !t._isTextureView && t._gpuTexture && (mQ(e, t._gpuTexture), e.memoryStatus.textureSize -= t._size, t._gpuTexture = null) }, i.getTextureHandle = function () { var t = this._gpuTexture; return t ? t.glTexture ? t.glTexture : t.glRenderbuffer ? t.glRenderbuffer : 0 : 0 }, i.resize = function (t, i) { var n = this, r = LQ.instance, s = n._info; if (s.width !== t || s.height !== i) { s.levelCount === e.getLevelCount(s.width, s.height) ? s.levelCount = e.getLevelCount(t, i) : s.levelCount > 1 && (s.levelCount = Math.min(s.levelCount, e.getLevelCount(t, i))); var a = n._size; s.width = t, s.height = i, n._size = Qp(s.format, n.width, n.height, n.depth, s.levelCount) * s.layerCount; var o = n._gpuTexture; !n._isTextureView && o && (o.width = t, o.height = i, o.size = n._size, o.isSwapchainTexture || (vQ(r, o), r.memoryStatus.textureSize -= a, r.memoryStatus.textureSize += n._size)) } }, i.initAsSwapchainTexture = function (t) { var e = new ip; e.format = t.format, e.usage = Wp[t.format].hasDepth ? 32 : 16, e.width = t.width, e.height = t.height, this.initialize(e, !0) }, n(e, [{ key: "gpuTexture", get: function () { return this._gpuTexture } }, { key: "lodLevel", get: function () { return this._lodLevel } }]), e }(S_), eZ = "webglcontextlost"; function iZ(t) { t.activeTexture(33984), t.pixelStorei(3333, 1), t.pixelStorei(3317, 1), t.pixelStorei(37440, !1), t.bindFramebuffer(36160, null), t.enable(3089), t.enable(2884), t.cullFace(1029), t.frontFace(2305), t.disable(32823), t.polygonOffset(0, 0), t.enable(2929), t.depthMask(!0), t.depthFunc(513), t.depthRange(0, 1), t.stencilFuncSeparate(1028, 519, 1, 65535), t.stencilOpSeparate(1028, 7680, 7680, 7680), t.stencilMaskSeparate(1028, 65535), t.stencilFuncSeparate(1029, 519, 1, 65535), t.stencilOpSeparate(1029, 7680, 7680, 7680), t.stencilMaskSeparate(1029, 65535), t.disable(2960), t.disable(32926), t.disable(3042), t.blendEquationSeparate(32774, 32774), t.blendFuncSeparate(1, 0, 1, 0), t.colorMask(!0, !0, !0, !0), t.blendColor(0, 0, 0, 0) } function nZ(t, e) { for (var i = ["", "WEBKIT_", "MOZ_"], n = 0; n < i.length; ++n) { var r = t.getExtension(i[n] + e); if (r) return r } return null } function rZ(t) { var e = { EXT_texture_filter_anisotropic: nZ(t, "EXT_texture_filter_anisotropic"), EXT_blend_minmax: nZ(t, "EXT_blend_minmax"), EXT_frag_depth: nZ(t, "EXT_frag_depth"), EXT_shader_texture_lod: nZ(t, "EXT_shader_texture_lod"), EXT_sRGB: nZ(t, "EXT_sRGB"), OES_vertex_array_object: nZ(t, "OES_vertex_array_object"), EXT_color_buffer_half_float: nZ(t, "EXT_color_buffer_half_float"), WEBGL_color_buffer_float: nZ(t, "WEBGL_color_buffer_float"), WEBGL_compressed_texture_etc1: nZ(t, "WEBGL_compressed_texture_etc1"), WEBGL_compressed_texture_etc: nZ(t, "WEBGL_compressed_texture_etc"), WEBGL_compressed_texture_pvrtc: nZ(t, "WEBGL_compressed_texture_pvrtc"), WEBGL_compressed_texture_s3tc: nZ(t, "WEBGL_compressed_texture_s3tc"), WEBGL_compressed_texture_s3tc_srgb: nZ(t, "WEBGL_compressed_texture_s3tc_srgb"), WEBGL_debug_shaders: nZ(t, "WEBGL_debug_shaders"), WEBGL_draw_buffers: nZ(t, "WEBGL_draw_buffers"), WEBGL_lose_context: nZ(t, "WEBGL_lose_context"), WEBGL_depth_texture: nZ(t, "WEBGL_depth_texture"), OES_texture_half_float: nZ(t, "OES_texture_half_float"), OES_texture_half_float_linear: nZ(t, "OES_texture_half_float_linear"), OES_texture_float: nZ(t, "OES_texture_float"), OES_texture_float_linear: nZ(t, "OES_texture_float_linear"), OES_standard_derivatives: nZ(t, "OES_standard_derivatives"), OES_element_index_uint: nZ(t, "OES_element_index_uint"), ANGLE_instanced_arrays: nZ(t, "ANGLE_instanced_arrays"), WEBGL_debug_renderer_info: nZ(t, "WEBGL_debug_renderer_info"), WEBGL_multi_draw: null, WEBGL_compressed_texture_astc: null, destroyShadersImmediately: !0, noCompressedTexSubImage2D: !1, isLocationActive: function (t) { return !!t }, useVAO: !1 }; return Ro.os === Io.IOS && 14 === Ro.osMainVersion && Ro.isBrowser || (e.WEBGL_compressed_texture_astc = nZ(t, "WEBGL_compressed_texture_astc")), Ro.os !== Io.ANDROID && Ro.os !== Io.IOS && (e.WEBGL_multi_draw = nZ(t, "WEBGL_multi_draw")), Ro.browserType === xo.UC && (e.ANGLE_instanced_arrays = null), Ro.os === Io.IOS && Ro.osMainVersion <= 10 && (e.destroyShadersImmediately = !1), e.OES_vertex_array_object && (e.useVAO = !0), e } function sZ(t) { var e = null; try { var i = { alpha: Le.ENABLE_TRANSPARENT_CANVAS, antialias: Le.ENABLE_WEBGL_ANTIALIAS, depth: !0, stencil: !0, premultipliedAlpha: !1, preserveDrawingBuffer: !1, powerPreference: "default", failIfMajorPerformanceCaveat: !1 }; e = t.getContext("webgl", i) } catch (t) { return null } return e } var aZ = function (t) { function e() { var e; return (e = t.call(this) || this).stateCache = new $Q, e.nullTex2D = null, e.nullTexCube = null, e._canvas = null, e._webGLContextLostHandler = null, e._extensions = null, e._blitManager = null, e } s(e, t); var i = e.prototype; return i.initialize = function (t) { var e = this; e._canvas = t.windowHandle, e._webGLContextLostHandler = e._onWebGLContextLost.bind(e), e._canvas.addEventListener(eZ, e._webGLContextLostHandler); var i = LQ.instance, n = i.gl, r = i.capabilities; e.stateCache.initialize(r.maxTextureUnits, r.maxVertexAttributes), e._extensions = rZ(n), iZ(n); var s = 55, a = n.getParameter(3414), o = n.getParameter(3415); a && o ? s = 55 : a && (s = 54), e._colorTexture = new tZ, e._colorTexture.initAsSwapchainTexture({ swapchain: e, format: 35, width: t.width, height: t.height }), e._depthStencilTexture = new tZ, e._depthStencilTexture.initAsSwapchainTexture({ swapchain: e, format: s, width: t.width, height: t.height }), e.nullTex2D = i.createTexture(new ip(1, 4, 35, 2, 2, 1)), e.nullTexCube = i.createTexture(new ip(3, 4, 35, 2, 2, 1, 6)); var u = new Wd; u.texExtent.width = 2, u.texExtent.height = 2; var h = new Uint8Array(e.nullTex2D.size); h.fill(0), i.copyBuffersToTexture([h], e.nullTex2D, [u]), u.texSubres.layerCount = 6, i.copyBuffersToTexture([h, h, h, h, h, h], e.nullTexCube, [u]), e._blitManager = new NQ }, i.destroy = function () { var t = this; t._canvas && t._webGLContextLostHandler && (t._canvas.removeEventListener(eZ, t._webGLContextLostHandler), t._webGLContextLostHandler = null), t.nullTex2D && (t.nullTex2D.destroy(), t.nullTex2D = null), t.nullTexCube && (t.nullTexCube.destroy(), t.nullTexCube = null), t._blitManager && (t._blitManager.destroy(), t._blitManager = null), t._extensions = null, t._canvas = null }, i.resize = function (t, e) { var i = this; i._colorTexture.width === t && i._colorTexture.height === e || (q("Resizing swapchain: " + t + "x" + e), i._canvas.width = t, i._canvas.height = e, i._colorTexture.resize(t, e), i._depthStencilTexture.resize(t, e)) }, i._onWebGLContextLost = function (t) { it(11e3), W(t) }, n(e, [{ key: "extensions", get: function () { return this._extensions } }, { key: "blitManager", get: function () { return this._blitManager } }]), e }(o_); function oZ(t, e, i) { for (var n = 0; n < e.length; ++n)t[e[n]] = i } function uZ(t, e, i) { for (var n = 0; n < e.length; ++n)t[e[n]] |= i } function hZ(t, e, i) { for (var n = 0; n < e.length; ++n)t[e[n]] = i } var cZ = t("WebGLDevice", function (t) { function e() { var e; return (e = t.call(this) || this)._swapchain = null, e._context = null, e._bindingMappings = null, e._textureExclusive = new Array(117), e } s(e, t); var i = e.prototype; return i.initialize = function (t) { LQ.setInstance(this), this._gfxAPI = 6; var e = this._bindingMappingInfo = t.bindingMappingInfo, i = [], n = [], r = e.setIndices[0]; i[r] = 0, n[r] = 0; for (var s = 1; s < e.setIndices.length; ++s) { var a = e.setIndices[s], o = e.setIndices[s - 1]; i[a] = e.maxBlockCounts[o] + i[o], n[a] = e.maxSamplerTextureCounts[o] + n[o] } for (var u = 0; u < e.setIndices.length; ++u) { var h = e.setIndices[u]; n[h] -= e.maxBlockCounts[h] } this._bindingMappings = { blockOffsets: i, samplerTextureOffsets: n, flexibleSet: e.setIndices[e.setIndices.length - 1] }; var c = this._context = sZ(s_.canvas); if (!c) return rt(16333), !1; this._queue = this.createQueue(new Mp(0)), this._cmdBuff = this.createCommandBuffer(new Bp(this._queue)); var l = c.getParameter.bind(c), f = this._caps; f.maxVertexAttributes = l(34921), f.maxVertexUniformVectors = l(36347), f.maxFragmentUniformVectors = l(36349), f.maxTextureUnits = l(34930), f.maxVertexTextureUnits = l(35660), f.maxTextureSize = l(3379), f.maxCubeMapTextureSize = l(34076), f.maxArrayTextureLayers = 0, f.max3DTextureSize = 0, f.maxUniformBufferBindings = 16; var d = c.getSupportedExtensions(), p = ""; d && d.forEach((function (t) { p += t + " " })); var _ = rZ(c); _.WEBGL_debug_renderer_info ? (this._renderer = l(_.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL), this._vendor = l(_.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)) : (this._renderer = l(7937), this._vendor = l(7936)); var g = l(7938), m = this._features; m.fill(!1), this.initFormatFeatures(_), _.EXT_blend_minmax && (m[3] = !0), _.OES_element_index_uint && (m[0] = !0), _.ANGLE_instanced_arrays && (m[1] = !0), _.WEBGL_draw_buffers && (m[2] = !0); var v = ""; return this.getFormatFeatures(72) && (v += "etc1 "), this.getFormatFeatures(73) && (v += "etc2 "), this.getFormatFeatures(56) && (v += "dxt "), this.getFormatFeatures(83) && (v += "pvrtc "), this.getFormatFeatures(89) && (v += "astc "), q("WebGL device initialized."), q("RENDERER: " + this._renderer), q("VENDOR: " + this._vendor), q("VERSION: " + g), q("COMPRESSED_FORMAT: " + v), q("EXTENSIONS: " + p), !0 }, i.destroy = function () { this._queue && (this._queue.destroy(), this._queue = null), this._cmdBuff && (this._cmdBuff.destroy(), this._cmdBuff = null), this._swapchain = null }, i.flushCommands = function () { }, i.acquire = function () { }, i.present = function () { var t = this._queue; this._numDrawCalls = t.numDrawCalls, this._numInstances = t.numInstances, this._numTris = t.numTris, t.clear() }, i.initFormatFeatures = function (t) { var e = this._formatFeatures; e.fill(0); var i = this._textureExclusive; i.fill(!0), oZ(e, [24, 47, 35, 50, 49], 7), oZ(e, [54, 55], 1), hZ(i, [47, 50, 49, 54, 55], !1), uZ(e, [7, 17, 28, 40, 6, 16, 27, 39, 7, 17, 28, 40, 6, 16, 27, 39, 11, 21, 32, 44], 16), t.EXT_sRGB && (e[25] = 7, e[37] = 7, i[37] = !1), t.WEBGL_depth_texture && (e[54] |= 7, e[55] |= 7), t.WEBGL_color_buffer_float && (e[32] |= 1, e[44] |= 1, i[32] = !1, i[44] = !1), t.EXT_color_buffer_half_float && (e[29] |= 1, e[41] |= 1, i[29] = !1, i[41] = !1), t.OES_texture_float && (e[32] |= 3, e[44] |= 3), t.OES_texture_half_float && (e[29] |= 3, e[41] |= 3), t.OES_texture_float_linear && (e[32] |= 4, e[44] |= 4), t.OES_texture_half_float_linear && (e[29] |= 4, e[41] |= 4), t.WEBGL_compressed_texture_etc1 && (e[72] = 6), t.WEBGL_compressed_texture_etc && oZ(e, [73, 77, 74, 78, 75, 76], 6), t.WEBGL_compressed_texture_s3tc && oZ(e, [56, 57, 58, 59, 60, 61, 62, 63], 6), t.WEBGL_compressed_texture_pvrtc && uZ(e, [83, 84, 85, 86], 6), t.WEBGL_compressed_texture_astc && uZ(e, [89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116], 6) }, i.createCommandBuffer = function (t) { var e = new (0 === t.type ? qQ : UQ); return e.initialize(t), e }, i.createSwapchain = function (t) { var e = new aZ; return this._swapchain = e, e.initialize(t), e }, i.createBuffer = function (t) { var e = new zQ; return e.initialize(t), e }, i.createTexture = function (t) { var e = new tZ; return e.initialize(t), e }, i.createDescriptorSet = function (t) { var e = new JK; return e.initialize(t), e }, i.createShader = function (t) { var e = new JQ; return e.initialize(t), e }, i.createInputAssembler = function (t) { var e = new GQ; return e.initialize(t), e }, i.createRenderPass = function (t) { var e = new KQ; return e.initialize(t), e }, i.createFramebuffer = function (t) { var e = new VQ; return e.initialize(t), e }, i.createDescriptorSetLayout = function (t) { var e = new HQ; return e.initialize(t), e }, i.createPipelineLayout = function (t) { var e = new WQ; return e.initialize(t), e }, i.createPipelineState = function (t) { var e = new XQ; return e.initialize(t), e }, i.createQueue = function (t) { var e = new YQ; return e.initialize(t), e }, i.getSampler = function (t) { var e = w_.computeHash(t); return this._samplers.has(e) || this._samplers.set(e, new ZQ(t, e)), this._samplers.get(e) }, i.getSwapchains = function () { return [this._swapchain] }, i.getGeneralBarrier = function (t) { var e = T_.computeHash(t); return this._generalBarrierss.has(e) || this._generalBarrierss.set(e, new T_(t, e)), this._generalBarrierss.get(e) }, i.getTextureBarrier = function (t) { var e = I_.computeHash(t); return this._textureBarriers.has(e) || this._textureBarriers.set(e, new I_(t, e)), this._textureBarriers.get(e) }, i.getBufferBarrier = function (t) { var e = E_.computeHash(t); return this._bufferBarriers.has(e) || this._bufferBarriers.set(e, new E_(t, e)), this._bufferBarriers.get(e) }, i.copyBuffersToTexture = function (t, e, i) { BQ(this, t, e.gpuTexture, i) }, i.copyTextureToBuffers = function (t, e, i) { MQ(this, t.gpuTexture, e, i) }, i.copyTexImagesToTexture = function (t, e, i) { DQ(this, t, e.gpuTexture, i) }, n(e, [{ key: "gl", get: function () { return this._context } }, { key: "extensions", get: function () { return this._swapchain.extensions } }, { key: "stateCache", get: function () { return this._swapchain.stateCache } }, { key: "nullTex2D", get: function () { return this._swapchain.nullTex2D } }, { key: "nullTexCube", get: function () { return this._swapchain.nullTexCube } }, { key: "textureExclusive", get: function () { return this._textureExclusive } }, { key: "bindingMappings", get: function () { return this._bindingMappings } }, { key: "blitManager", get: function () { return this._swapchain.blitManager } }]), e }(s_)); T.WebGLDevice = cZ; var lZ = function (t, e, i) { this.prev = null, this.next = null, this.z = null, this.prevZ = null, this.nextZ = null, this.steiner = !1, this.i = t, this.x = e, this.y = i }; function fZ(t, e, i, n, r) { var s = 0, a = null; if (r === MZ(t, e, i, n) > 0) for (s = e; s < i; s += n)a = PZ(s, t[s], t[s + 1], a); else for (s = i - n; s >= e; s -= n)a = PZ(s, t[s], t[s + 1], a); return a && IZ(a, a.next) && (BZ(a), a = a.next), a } function dZ(t, e) { if (void 0 === e && (e = null), !t) return t; e || (e = t); var i = t, n = !1; do { if (n = !1, i.steiner || !IZ(i, i.next) && 0 !== TZ(i.prev, i, i.next)) i = i.next; else { if (BZ(i), (i = e = i.prev) === i.next) return null; n = !0 } } while (n || i !== e); return e } function pZ(t, e, i, n, r, s, a) { if (void 0 === a && (a = 0), t) { !a && s && yZ(t, n, r, s); for (var o = t, u = null, h = null; t.prev !== t.next;)if (u = t.prev, h = t.next, s ? gZ(t, n, r, s) : _Z(t)) e.push(u.i / i), e.push(t.i / i), e.push(h.i / i), BZ(t), t = h.next, o = h.next; else if ((t = h) === o) { a ? 1 === a ? pZ(t = mZ(t, e, i), e, i, n, r, s, 2) : 2 === a && vZ(t, e, i, n, r, s) : pZ(dZ(t), e, i, n, r, s, 1); break } } } function _Z(t) { var e = t.prev, i = t, n = t.next; if (TZ(e, i, n) >= 0) return !1; for (var r = t.next.next; r !== t.prev;) { if (xZ(e.x, e.y, i.x, i.y, n.x, n.y, r.x, r.y) && TZ(r.prev, r, r.next) >= 0) return !1; r = r.next } return !0 } function gZ(t, e, i, n) { var r = t.prev, s = t, a = t.next; if (TZ(r, s, a) >= 0) return !1; for (var o = r.x < s.x ? r.x < a.x ? r.x : a.x : s.x < a.x ? s.x : a.x, u = r.y < s.y ? r.y < a.y ? r.y : a.y : s.y < a.y ? s.y : a.y, h = r.x > s.x ? r.x > a.x ? r.x : a.x : s.x > a.x ? s.x : a.x, c = r.y > s.y ? r.y > a.y ? r.y : a.y : s.y > a.y ? s.y : a.y, l = wZ(o, u, e, i, n), f = wZ(h, c, e, i, n), d = t.nextZ; d && d.z <= f;) { if (d !== t.prev && d !== t.next && xZ(r.x, r.y, s.x, s.y, a.x, a.y, d.x, d.y) && TZ(d.prev, d, d.next) >= 0) return !1; d = d.nextZ } for (d = t.prevZ; d && d.z >= l;) { if (d !== t.prev && d !== t.next && xZ(r.x, r.y, s.x, s.y, a.x, a.y, d.x, d.y) && TZ(d.prev, d, d.next) >= 0) return !1; d = d.prevZ } return !0 } function mZ(t, e, i) { var n = t; do { var r = n.prev, s = n.next.next; !IZ(r, s) && EZ(r, n, n.next, s) && CZ(r, s) && CZ(s, r) && (e.push(r.i / i), e.push(n.i / i), e.push(s.i / i), BZ(n), BZ(n.next), n = t = s), n = n.next } while (n !== t); return n } function vZ(t, e, i, n, r, s) { var a = t; do { for (var o = a.next.next; o !== a.prev;) { if (a.i !== o.i && SZ(a, o)) { var u = RZ(a, o); return a = dZ(a, a.next), u = dZ(u, u.next), pZ(a, e, i, n, r, s), void pZ(u, e, i, n, r, s) } o = o.next } a = a.next } while (a !== t) } function yZ(t, e, i, n) { var r = t; do { null === r.z && (r.z = wZ(r.x, r.y, e, i, n)), r.prevZ = r.prev, r.nextZ = r.next, r = r.next } while (r !== t); r.prevZ.nextZ = null, r.prevZ = null, bZ(r) } function bZ(t) { var e = 0, i = null, n = null, r = null, s = null, a = 0, o = 0, u = 0, h = 1; do { for (i = t, t = null, s = null, a = 0; i;) { for (a++, n = i, o = 0, e = 0; e < h && (o++, n = n.nextZ); e++); for (u = h; o > 0 || u > 0 && n;)0 === o ? (r = n, n = n.nextZ, u--) : 0 !== u && n ? i.z <= n.z ? (r = i, i = i.nextZ, o--) : (r = n, n = n.nextZ, u--) : (r = i, i = i.nextZ, o--), s ? s.nextZ = r : t = r, r.prevZ = s, s = r; i = n } s.nextZ = null, h *= 2 } while (a > 1); return t } function wZ(t, e, i, n, r) { return (t = 1431655765 & ((t = 858993459 & ((t = 252645135 & ((t = 16711935 & ((t = 32767 * (t - i) / r) | t << 8)) | t << 4)) | t << 2)) | t << 1)) | (e = 1431655765 & ((e = 858993459 & ((e = 252645135 & ((e = 16711935 & ((e = 32767 * (e - n) / r) | e << 8)) | e << 4)) | e << 2)) | e << 1)) << 1 } function xZ(t, e, i, n, r, s, a, o) { return (r - a) * (e - o) - (t - a) * (s - o) >= 0 && (t - a) * (n - o) - (i - a) * (e - o) >= 0 && (i - a) * (s - o) - (r - a) * (n - o) >= 0 } function SZ(t, e) { return t.next.i !== e.i && t.prev.i !== e.i && !AZ(t, e) && CZ(t, e) && CZ(e, t) && DZ(t, e) } function TZ(t, e, i) { return (e.y - t.y) * (i.x - e.x) - (e.x - t.x) * (i.y - e.y) } function IZ(t, e) { return t.x === e.x && t.y === e.y } function EZ(t, e, i, n) { return !!(IZ(t, e) && IZ(i, n) || IZ(t, n) && IZ(i, e)) || TZ(t, e, i) > 0 != TZ(t, e, n) > 0 && TZ(i, n, t) > 0 != TZ(i, n, e) > 0 } function AZ(t, e) { var i = t; do { if (i.i !== t.i && i.next.i !== t.i && i.i !== e.i && i.next.i !== e.i && EZ(i, i.next, t, e)) return !0; i = i.next } while (i !== t); return !1 } function CZ(t, e) { return TZ(t.prev, t, t.next) < 0 ? TZ(t, e, t.next) >= 0 && TZ(t, t.prev, e) >= 0 : TZ(t, e, t.prev) < 0 || TZ(t, t.next, e) < 0 } function DZ(t, e) { var i = t, n = !1, r = (t.x + e.x) / 2, s = (t.y + e.y) / 2; do { i.y > s != i.next.y > s && r < (i.next.x - i.x) * (s - i.y) / (i.next.y - i.y) + i.x && (n = !n), i = i.next } while (i !== t); return n } function RZ(t, e) { var i = new lZ(t.i, t.x, t.y), n = new lZ(e.i, e.x, e.y), r = t.next, s = e.prev; return t.next = e, e.prev = t, i.next = r, r.prev = i, n.next = i, i.prev = n, s.next = n, n.prev = s, n } function PZ(t, e, i, n) { var r = new lZ(t, e, i); return n ? (r.next = n.next, r.prev = n, n.next.prev = r, n.next = r) : (r.prev = r, r.next = r), r } function BZ(t) { t.next.prev = t.prev, t.prev.next = t.next, t.prevZ && (t.prevZ.nextZ = t.nextZ), t.nextZ && (t.nextZ.prevZ = t.prevZ) } function MZ(t, e, i, n) { for (var r = 0, s = e, a = i - n; s < i; s += n)r += (t[a] - t[s]) * (t[s + 1] + t[a + 1]), a = s; return r } function OZ(t, e, i) { i = i || 3; var n = t.length, r = fZ(t, 0, n, i, !0), s = []; if (!r) return s; var a = 0, o = 0, u = 0, h = 0, c = 0, l = 0, f = 0; if (t.length > 80 * i) { a = u = t[0], o = h = t[1]; for (var d = i; d < n; d += i)(c = t[d]) < a && (a = c), (l = t[d + 1]) < o && (o = l), c > u && (u = c), l > h && (h = l); f = Math.max(u - a, h - o) } return pZ(r, s, i, a, o, f), s } for (var LZ = Math.PI, FZ = Math.min, kZ = Math.max, NZ = Math.ceil, zZ = Math.acos, UZ = Math.cos, VZ = Math.sin, GZ = Math.atan2, HZ = null, WZ = null, jZ = new rr, XZ = [], qZ = 0; qZ < 4; qZ++)XZ.push(new Kn); function YZ(t, e, i) { var n = 2 * zZ(t / (t + i)); return kZ(2, NZ(e / n)) } function KZ(t, e, i) { return t < e ? e : t > i ? i : t } var QZ = function () { function t() { } var e = t.prototype; return e.updateRenderData = function () { }, e.getRenderData = function (t, e) { if (!WZ) return null; var i = WZ.getRenderDataList(), n = i[WZ.dataOffset]; if (!n) return null; var r = n, s = r ? r.vertexStart + e : 0; return (s > 65535 || 3 * s > 131070) && (++WZ.dataOffset, WZ.dataOffset < i.length ? n = i[WZ.dataOffset] : (n = WZ.requestRenderData(), i[WZ.dataOffset] = n), r = n), r && r.vertexCount < s && r.request(e, 3 * e), n }, e.stroke = function (t) { rr.copy(jZ, t.strokeColor), t.impl && (this._flattenPaths(t.impl), this._expandStroke(t), t.impl.updatePathOffset = !0, this.end(t)) }, e.fill = function (t) { rr.copy(jZ, t.fillColor), this._expandFill(t), t.impl && (t.impl.updatePathOffset = !0), this.end(t) }, e.end = function (t) { t._markForUpdateRenderData() }, e._expandStroke = function (t) { var e = .5 * t.lineWidth, i = t.lineCap, n = t.lineJoin, r = t.miterLimit; if (WZ = t.impl) { var s = YZ(e, LZ, WZ.tessTol); this._calculateJoins(WZ, e, n, r); for (var a = WZ.paths, o = 0, u = WZ.pathOffset, h = WZ.pathLength; u < h; u++) { var c = a[u], l = c.points.length; o += 1 === n ? 2 * (l + c.bevel * (s + 2) + 1) : 2 * (l + 5 * c.bevel + 1), c.closed || (o += 1 === i ? 2 * (2 * s + 2) : 12) } var f = HZ = this.getRenderData(t, o); if (f) { for (var d = f.vData, p = f.iData, _ = WZ.pathOffset, g = WZ.pathLength; _ < g; _++) { var m = a[_], v = m.points, y = v.length, b = f.vertexStart, w = void 0, x = void 0, S = 0, T = 0, I = m.closed; if (I ? (w = v[y - 1], x = v[0], S = 0, T = y) : (w = v[0], x = v[1], S = 1, T = y - 1), x = x || w, !I) { var E = new az(x.x, x.y); E.subtract(w), E.normalize(); var A = E.x, C = E.y; 0 === i ? this._buttCapStart(w, A, C, e, 0) : 2 === i ? this._buttCapStart(w, A, C, e, e) : 1 === i && this._roundCapStart(w, A, C, e, s) } for (var D = S; D < T; ++D)1 === n ? this._roundJoin(w, x, e, e, s) : 12 & x.flags ? this._bevelJoin(w, x, e, e) : (this._vSet(x.x + x.dmx * e, x.y + x.dmy * e, 1), this._vSet(x.x - x.dmx * e, x.y - x.dmy * e, -1)), w = x, x = v[D + 1]; if (I) { var R = 8 * b; this._vSet(d[R], d[R + 1], 1), this._vSet(d[R + 8], d[R + 8 + 1], -1) } else { var P = new az(x.x, x.y); P.subtract(w), P.normalize(); var B = P.x, M = P.y; 0 === i ? this._buttCapEnd(x, B, M, e, 0) : 2 === i ? this._buttCapEnd(x, B, M, e, e) : 1 === i && this._roundCapEnd(x, B, M, e, s) } for (var O = f.indexStart, L = b + 2, F = f.vertexStart; L < F; L++)p[O++] = L - 2, p[O++] = L - 1, p[O++] = L; f.indexStart = O } HZ = null, WZ = null } } }, e._expandFill = function (t) { if (WZ = t.impl) { for (var e = WZ.paths, i = 0, n = WZ.pathOffset, r = WZ.pathLength; n < r; n++)i += e[n].points.length; var s = HZ = this.getRenderData(t, i); if (s) { for (var a = s, o = a.vData, u = a.iData, h = WZ.pathOffset, c = WZ.pathLength; h < c; h++) { var l = e[h], f = l.points, d = f.length; if (0 !== d) { for (var p = s.vertexStart, _ = 0; _ < d; ++_)this._vSet(f[_].x, f[_].y); var g = s.indexStart; if (l.complex) { for (var m = [], v = p, y = s.vertexStart; v < y; v++) { var b = 8 * v; m.push(o[b++]), m.push(o[b++]), m.push(o[b++]) } var w = OZ(m, 0, 3); if (!w || 0 === w.length) continue; for (var x = 0, S = w.length; x < S; x++)u[g++] = w[x] + p } else for (var T = p, I = p + 2, E = a.vertexStart; I < E; I++)u[g++] = T, u[g++] = I - 1, u[g++] = I; a.indexStart = g } } HZ = null, WZ = null } } }, e._calculateJoins = function (t, e, i, n) { var r = 0; e > 0 && (r = 1 / e); for (var s = t.paths, a = t.pathOffset, o = t.pathLength; a < o; a++) { var u = s[a], h = u.points, c = h.length, l = h[c - 1], f = h[0]; u.bevel = 0; for (var d = 0; d < c; d++) { var p, _, g = l.dy, m = -l.dx, v = f.dy, y = -f.dx; if (f.dmx = .5 * (g + v), f.dmy = .5 * (m + y), (p = f.dmx * f.dmx + f.dmy * f.dmy) > 1e-6) { var b = 1 / p; b > 600 && (b = 600), f.dmx *= b, f.dmy *= b } f.dx * l.dy - l.dx * f.dy > 0 && (f.flags |= 2), p * (_ = kZ(11, FZ(l.len, f.len) * r)) * _ < 1 && (f.flags |= 8), 1 & f.flags && (p * n * n < 1 || 0 === i || 1 === i) && (f.flags |= 4), 12 & f.flags && u.bevel++, l = f, f = h[d + 1] } } }, e._flattenPaths = function (t) { for (var e = t.paths, i = t.pathOffset, n = t.pathLength; i < n; i++) { var r = e[i], s = r.points, a = s[s.length - 1], o = s[0]; s.length > 2 && a.equals(o) && (r.closed = !0, s.pop(), a = s[s.length - 1]); for (var u = 0, h = s.length; u < h; u++) { var c = new az(o.x, o.y); c.subtract(a), a.len = c.length(), (c.x || c.y) && c.normalize(), a.dx = c.x, a.dy = c.y, a = o, o = s[u + 1] } } }, e._chooseBevel = function (t, e, i, n) { var r = i.x, s = i.y, a = 0, o = 0, u = 0, h = 0; return 0 !== t ? (a = r + e.dy * n, o = s - e.dx * n, u = r + i.dy * n, h = s - i.dx * n) : (a = u = r + i.dmx * n, o = h = s + i.dmy * n), [a, o, u, h] }, e._buttCapStart = function (t, e, i, n, r) { var s = t.x - e * r, a = t.y - i * r, o = i, u = -e; this._vSet(s + o * n, a + u * n, 1), this._vSet(s - o * n, a - u * n, -1) }, e._buttCapEnd = function (t, e, i, n, r) { var s = t.x + e * r, a = t.y + i * r, o = i, u = -e; this._vSet(s + o * n, a + u * n, 1), this._vSet(s - o * n, a - u * n, -1) }, e._roundCapStart = function (t, e, i, n, r) { for (var s = t.x, a = t.y, o = i, u = -e, h = 0; h < r; h++) { var c = h / (r - 1) * LZ, l = UZ(c) * n, f = VZ(c) * n; this._vSet(s - o * l - e * f, a - u * l - i * f, 1), this._vSet(s, a, 0) } this._vSet(s + o * n, a + u * n, 1), this._vSet(s - o * n, a - u * n, -1) }, e._roundCapEnd = function (t, e, i, n, r) { var s = t.x, a = t.y, o = i, u = -e; this._vSet(s + o * n, a + u * n, 1), this._vSet(s - o * n, a - u * n, -1); for (var h = 0; h < r; h++) { var c = h / (r - 1) * LZ, l = UZ(c) * n, f = VZ(c) * n; this._vSet(s, a, 0), this._vSet(s - o * l + e * f, a - u * l + i * f, 1) } }, e._roundJoin = function (t, e, i, n, r) { var s = t.dy, a = -t.dx, o = e.dy, u = -e.dx, h = e.x, c = e.y; if (2 & e.flags) { var l = this._chooseBevel(8 & e.flags, t, e, i), f = l[0], d = l[1], p = l[2], _ = l[3], g = GZ(-a, -s), m = GZ(-u, -o); m > g && (m -= 2 * LZ), this._vSet(f, d, 1), this._vSet(h - s * n, e.y - a * n, -1); for (var v = KZ(NZ((g - m) / LZ) * r, 2, r), y = 0; y < v; y++) { var b = g + y / (v - 1) * (m - g), w = h + UZ(b) * n, x = c + VZ(b) * n; this._vSet(h, c, 0), this._vSet(w, x, -1) } this._vSet(p, _, 1), this._vSet(h - o * n, c - u * n, -1) } else { var S = this._chooseBevel(8 & e.flags, t, e, -n), T = S[0], I = S[1], E = S[2], A = S[3], C = GZ(a, s), D = GZ(u, o); D < C && (D += 2 * LZ), this._vSet(h + s * n, c + a * n, 1), this._vSet(T, I, -1); for (var R = KZ(NZ((D - C) / LZ) * r, 2, r), P = 0; P < R; P++) { var B = C + P / (R - 1) * (D - C), M = h + UZ(B) * i, O = c + VZ(B) * i; this._vSet(M, O, 1), this._vSet(h, c, 0) } this._vSet(h + o * n, c + u * n, 1), this._vSet(E, A, -1) } }, e._bevelJoin = function (t, e, i, n) { var r = 0, s = 0, a = 0, o = 0, u = 0, h = 0, c = 0, l = 0, f = t.dy, d = -t.dx, p = e.dy, _ = -e.dx; if (2 & e.flags) { var g = this._chooseBevel(8 & e.flags, t, e, i); u = g[0], h = g[1], c = g[2], l = g[3], this._vSet(u, h, 1), this._vSet(e.x - f * n, e.y - d * n, -1), this._vSet(c, l, 1), this._vSet(e.x - p * n, e.y - _ * n, -1) } else { var m = this._chooseBevel(8 & e.flags, t, e, -n); r = m[0], s = m[1], a = m[2], o = m[3], this._vSet(e.x + f * i, e.y + d * i, 1), this._vSet(r, s, -1), this._vSet(e.x + p * i, e.y + _ * i, 1), this._vSet(a, o, -1) } }, e._vSet = function (t, e, i) { if (void 0 === i && (i = 0), HZ) { var n = HZ, r = 8 * n.vertexStart, s = n.vData; s[r++] = t, s[r++] = e, s[r++] = 0, rr.toArray(s, jZ, r), r += 4, s[r++] = i, n.vertexStart++ } }, t }(), ZZ = new QZ, JZ = t("graphicsAssembler", { getAssembler: function () { return ZZ } }); fz.Assembler = JZ, S.UI.graphicsAssembler = JZ; var $Z = new Kn, tJ = new Kn; function eJ(t, e) { var i = null; return { value: e.length > 0 ? e[e.length - 1] : Kn.ZERO, progress: function (t, e, n, r) { return i.getPoint(r) }, clone: function (t) { return Kn.clone(t) }, add: function (t, e) { return t.clone().add(e) }, sub: function (t, e) { return t.clone().subtract(e) }, onStart: function (n) { var r = n.start, s = n.end, a = n.relative, o = n.reversed; (i = df.create(t)).addKnot(r); var u = null; a && o && (u = tJ, Kn.subtract(u, r, e[e.length - 1])); for (var h = 0, c = e.length; h < c; ++h) { var l = o ? e[c - 1 - h] : e[h]; a ? o ? h > 0 && i.addKnot(Kn.copy($Z, u).add(l)) : i.addKnot(Kn.copy($Z, r).add(l)) : i.addKnot(l) } a && o && i.addKnot(s) }, onComplete: function () { i = null }, onStop: function () { i = null }, legacyProgress: !1 } } var iJ = Object.freeze({ __proto__: null, bezier: function () { for (var t = arguments.length, e = new Array(t), i = 0; i < t; i++)e[i] = arguments[i]; return eJ(1, e) }, catmullRom: function () { for (var t = arguments.length, e = new Array(t), i = 0; i < t; i++)e[i] = arguments[i]; return eJ(2, e) } }); t("tweenProgress", iJ); var nJ = function () { this.actions = [], this.target = null, this.actionIndex = 0, this.currentAction = null, this.paused = !1, this.lock = !1 }, rJ = function () { function t() { this._hashTargets = new Map, this._arrayTargets = [], this._currentTarget = void 0, this._elementPool = [] } var e = t.prototype; return e._getElement = function (t, e) { var i = this._elementPool.pop(); return i || (i = new nJ), i.target = t, i.paused = !!e, i }, e._putElement = function (t) { t.actions.length = 0, t.actionIndex = 0, t.currentAction = null, t.paused = !1, t.target = null, t.lock = !1, this._elementPool.push(t) }, e._onNodeActiveChanged = function (t, e) { e ? this.resumeTarget(t) : this.pauseTarget(t) }, e._onNodeDestroy = function (t) { this._removeAllActionsFromTarget(t, !1) }, e._registerNodeEvent = function (t) { t.isValid && (t.on("active-changed", this._onNodeActiveChanged, this), t.on("node-destroyed", this._onNodeDestroy, this)) }, e._unregisterNodeEvent = function (t) { t.isValid && (t.off("active-changed", this._onNodeActiveChanged, this), t.off("node-destroyed", this._onNodeDestroy, this)) }, e.addAction = function (t, e, i) { if (t && e) { var n = this._hashTargets.get(e); n ? n.actions || (n.actions = []) : (n = this._getElement(e, i), this._hashTargets.set(e, n), this._arrayTargets.push(n)), 0 === n.actions.length && e instanceof ky && this._registerNodeEvent(e), n.target = e, n.actions.push(t), t.startWithTarget(e) } else rt(1e3) }, e.removeAllActions = function () { for (var t = this._arrayTargets, e = 0; e < t.length; e++) { var i = t[e]; i && (i.target instanceof ky && this._unregisterNodeEvent(i.target), this._putElement(i)) } this._arrayTargets.length = 0, this._hashTargets = new Map }, e.removeAllActionsFromTarget = function (t) { this._removeAllActionsFromTarget(t, !0) }, e._removeAllActionsFromTarget = function (t, e) { if (null != t) { var i = this._hashTargets.get(t); i && (e && t instanceof ky && this._unregisterNodeEvent(t), i.actions.length = 0, this._deleteHashElement(i)) } }, e.removeAction = function (t) { if (null != t) { var e = t.getOriginalTarget(), i = this._hashTargets.get(e); if (i) for (var n = 0; n < i.actions.length; n++)if (i.actions[n] === t) { i.actions.splice(n, 1), i.actionIndex >= n && i.actionIndex--; break } } }, e._removeActionByTag = function (t, e, i) { for (var n = 0, r = e.actions.length; n < r; ++n) { var s = e.actions[n]; if (s && s.getTag() === t) { if (i && s.getOriginalTarget() !== i) continue; this._removeActionAtIndex(n, e); break } } }, e._removeAllActionsByTag = function (t, e, i) { for (var n = e.actions.length - 1; n >= 0; --n) { var r = e.actions[n]; if (r && r.getTag() === t) { if (i && r.getOriginalTarget() !== i) continue; this._removeActionAtIndex(n, e) } } }, e.removeActionByTag = function (t, e) { var i = this; -1 === t && J(1002); var n = this._hashTargets; if (e) { var r = n.get(e); r && this._removeActionByTag(t, r, e) } else n.forEach((function (e) { i._removeActionByTag(t, e) })) }, e.removeAllActionsByTag = function (t, e) { var i = this; -1 === t && J(1002); var n = this._hashTargets; if (e) { var r = n.get(e); r && this._removeAllActionsByTag(t, r, e) } else n.forEach((function (e) { i._removeAllActionsByTag(t, e) })) }, e.getActionByTag = function (t, e) { -1 === t && J(1004); var i = this._hashTargets.get(e); if (i) { if (null != i.actions) for (var n = 0; n < i.actions.length; ++n) { var r = i.actions[n]; if (r && r.getTag() === t) return r } J(1005, t) } return null }, e.getNumberOfRunningActionsInTarget = function (t) { var e = this._hashTargets.get(t); return e && e.actions ? e.actions.length : 0 }, e.pauseTarget = function (t) { var e = this._hashTargets.get(t); e && (e.paused = !0) }, e.resumeTarget = function (t) { var e = this._hashTargets.get(t); e && (e.paused = !1) }, e.pauseAllRunningActions = function () { for (var t = [], e = this._arrayTargets, i = 0; i < e.length; i++) { var n = e[i]; n && !n.paused && (n.paused = !0, n.target && t.push(n.target)) } return t }, e.resumeTargets = function (t) { if (t) for (var e = 0; e < t.length; e++)t[e] && this.resumeTarget(t[e]) }, e.pauseTargets = function (t) { if (t) for (var e = 0; e < t.length; e++)t[e] && this.pauseTarget(t[e]) }, e.isActionRunning = function (t) { var e = this._hashTargets.get(t.getOriginalTarget()), i = -1; return e && (i = e.actions.indexOf(t)), -1 !== i }, e._removeActionAtIndex = function (t, e) { e.actions.splice(t, 1), e.actionIndex >= t && e.actionIndex--, 0 === e.actions.length && (e.target instanceof ky && this._unregisterNodeEvent(e.target), this._deleteHashElement(e)) }, e._deleteHashElement = function (t) { var e = !1; if (t && !t.lock && this._hashTargets.get(t.target)) { this._hashTargets.delete(t.target); for (var i = this._arrayTargets, n = 0, r = i.length; n < r; n++)if (i[n] === t) { i.splice(n, 1); break } this._putElement(t), e = !0 } return e }, e.update = function (t) { for (var e, i = this._arrayTargets, n = 0; n < i.length; n++) { this._currentTarget = i[n]; var r = (e = this._currentTarget).target; if (!co(r) || r.isValid) { if (!e.paused && e.actions) { for (e.lock = !0, e.actionIndex = 0; e.actionIndex < e.actions.length; e.actionIndex++)if (e.currentAction = e.actions[e.actionIndex], e.currentAction) { if (e.currentAction.step(t), e.currentAction && e.currentAction.isDone()) { e.currentAction.stop(); var s = e.currentAction; e.currentAction = null, this.removeAction(s) } e.currentAction = null } e.lock = !1 } 0 === e.actions.length && (r instanceof ky && this._unregisterNodeEvent(r), this._deleteHashElement(e) && n--) } else this.removeAllActionsFromTarget(r), n-- } }, t }(), sJ = t("TweenSystem", function (t) { function e() { var e; return (e = t.call(this) || this).actionMgr = new rJ, e } return s(e, t), e.prototype.update = function (t) { this.actionMgr.update(t) }, n(e, [{ key: "ActionManager", get: function () { return this.actionMgr } }]), e }(If)); sJ.ID = "TWEEN", sJ.instance = void 0, yB.on("director_init", (function () { var t = new sJ; sJ.instance = t, yB.registerSystem(sJ.ID, t, 100) })); var aJ = function (t) { function e() { var e; return (e = t.call(this) || this)._duration = 0, e } s(e, t); var i = e.prototype; return i.getDurationScaled = function () { return this._duration }, i.getDuration = function () { return this._duration }, i.setDuration = function (t) { this._duration = t }, e }(function () { function t() { this.originalTarget = null, this.target = null, this._owner = null, this.tag = -1, this._id = void 0, this._paused = !1 } var e = t.prototype; return e.isDone = function () { return !0 }, e.startWithTarget = function (t) { this.originalTarget = t, this.target = t }, e.stop = function () { this.target = null }, e.getTarget = function () { return this.target }, e.setTarget = function (t) { this.target = t }, e.getOriginalTarget = function () { return this.originalTarget }, e.setOriginalTarget = function (t) { this.originalTarget = t }, e._getWorkerTarget = function () { var t, e = null == (t = this._owner) ? void 0 : t.getTarget(); return null != e ? e : this.target }, e.getTag = function () { return this.tag }, e.setTag = function (t) { this.tag = t }, e.setId = function (t) { this._id = t }, e.getId = function () { return this._id }, e.setPaused = function (t) { this._paused = t }, t }()), oJ = function (t) { function e() { return t.apply(this, arguments) || this } s(e, t); var i = e.prototype; return i.isDone = function () { return !0 }, i.step = function () { this.update(1) }, i.update = function () { }, i.reverse = function () { return this.clone() }, i.isUnknownDuration = function () { return !1 }, e }(aJ), uJ = function (t) { function e() { return t.apply(this, arguments) || this } s(e, t); var i = e.prototype; return i.update = function () { var t = this._getWorkerTarget(); if (t) for (var e = t.getComponentsInChildren(UF), i = 0; i < e.length; ++i)e[i].enabled = !0 }, i.reverse = function () { return new hJ }, i.clone = function () { var t = new e; return t._id = this._id, t }, i.toString = function () { return "<Show>" }, e }(oJ), hJ = function (t) { function e() { return t.apply(this, arguments) || this } s(e, t); var i = e.prototype; return i.update = function () { var t = this._getWorkerTarget(); if (t) for (var e = t.getComponentsInChildren(UF), i = 0; i < e.length; ++i)e[i].enabled = !1 }, i.reverse = function () { return new uJ }, i.clone = function () { var t = new e; return t._id = this._id, t }, i.toString = function () { return "<Hide>" }, e }(oJ); !function (t) { function e() { return t.apply(this, arguments) || this } s(e, t); var i = e.prototype; i.update = function () { var t = this._getWorkerTarget(); if (t) for (var e = t.getComponentsInChildren(UF), i = 0; i < e.length; ++i) { var n = e[i]; n.enabled = !n.enabled } }, i.reverse = function () { return new e }, i.clone = function () { var t = new e; return t._id = this._id, t }, i.toString = function () { return "<ToggleVisibility>" } }(oJ); var cJ = function (t) { function e(e) { var i; return (i = t.call(this) || this)._isNeedCleanUp = !0, void 0 !== e && i.init(e), i } s(e, t); var i = e.prototype; return i.update = function () { var t = this._getWorkerTarget(); t && (t.removeFromParent(), this._isNeedCleanUp && t.destroy()) }, i.init = function (t) { return this._isNeedCleanUp = t, !0 }, i.reverse = function () { return new e(this._isNeedCleanUp) }, i.clone = function () { var t = new e(this._isNeedCleanUp); return t._id = this._id, t }, i.toString = function () { return "<RemoveSelf>" }, e }(oJ); function lJ(t) { return new cJ(t) } var fJ = function (t) { function e(e, i, n) { var r; return (r = t.call(this) || this)._callbackThis = void 0, r._callback = void 0, r._data = void 0, r.initWithFunction(e, i, n), r } s(e, t); var i = e.prototype; return i.initWithFunction = function (t, e, i) { return t && (this._callback = t), e && (this._callbackThis = e), void 0 !== i && (this._data = i), !0 }, i.execute = function () { if (this._callback) { var t = this._getWorkerTarget(); this._callback.call(this._callbackThis, t, this._data) } }, i.update = function () { this.execute() }, i.getTargetCallback = function () { return this._callbackThis }, i.setTargetCallback = function (t) { t !== this._callbackThis && (this._callbackThis = t) }, i.clone = function () { var t = new e; return t._id = this._id, this._callback && t.initWithFunction(this._callback, this._callbackThis, this._data), t }, i.toString = function () { return "<CallFunc>" }, e }(oJ); function dJ(t, e, i) { return new fJ(t, e, i) } var pJ = function (t) { function e() { return t.apply(this, arguments) || this } s(e, t); var i = e.prototype; return i.clone = function () { return new e }, i.reverse = function () { return this.clone() }, i.update = function () { }, i.step = function () { }, i.isUnknownDuration = function () { return !1 }, i.toString = function () { return "DummyAction" }, e }(aJ), _J = function (t) { function e(e) { var i; return (i = t.call(this) || this).MAX_VALUE = 2, i._elapsed = 0, i._startTime = 0, i._firstTick = !1, i._speed = 1, void 0 === e || Number.isNaN(e) || i.initWithDuration(e), i } s(e, t); var i = e.prototype; return i.setStartTime = function (t) { t = t < 0 ? 0 : t > this._duration ? this._duration : t, this._startTime = t }, i.getElapsed = function () { return this._elapsed }, i.initWithDuration = function (t) { return this._duration = 0 === t ? Le.FLT_EPSILON : t, this._elapsed = 0, this._firstTick = !0, !0 }, i.isDone = function () { return this._elapsed >= this._duration && !this.isUnknownDuration() }, i._cloneDecoration = function (t) { t._speed = this._speed }, i.step = function (t) { if (!this._paused && 0 !== this._speed) { t *= this._speed, this._firstTick ? this._elapsed = this._startTime : this._elapsed += t; var e = this._elapsed / (this._duration > 1.192092896e-7 ? this._duration : 1.192092896e-7); e = e < 1 ? e : 1, this.update(e > 0 ? e : 0), this.isUnknownDuration() && !this._firstTick && (e < 1 ? this._elapsed -= t : this._elapsed = this._startTime + this._duration), this._firstTick && (this._firstTick = !1, this._startTime > 0 && (this._startTime = 0)) } }, i.startWithTarget = function (e) { t.prototype.startWithTarget.call(this, e), this._elapsed = 0, this._firstTick = !0 }, i.getSpeed = function () { return this._speed }, i.setSpeed = function (t) { this._speed = t }, i.getDurationScaled = function () { return this._duration / this._speed }, e }(aJ); function gJ(t, e) { var i = new mJ; return i.initWithTwoActions(t, e), i } var mJ = function (t) { function e(e) { var i; if ((i = t.call(this) || this)._actions = [], i._split = 0, i._last = 0, i._reversed = !1, !e || 0 === e.length) return l(i); 1 === e.length && e.push(new pJ); var n = e.length - 1; if (n >= 0 && null == e[n] && J(1015), n >= 0) { for (var r = e[0], s = 1; s < n; s++)e[s] && (r = gJ(r, e[s])); i.initWithTwoActions(r, e[n]) } return i } s(e, t); var i = e.prototype; return i.initWithTwoActions = function (t, e) { if (!t || !e) return rt(1025), !1; var i = t.getDurationScaled() + e.getDurationScaled(); return this.initWithDuration(i), this._actions[0] = t, this._actions[1] = e, !0 }, i.clone = function () { var t = new e; return t._id = this._id, t._speed = this._speed, this._cloneDecoration(t), t.initWithTwoActions(this._actions[0].clone(), this._actions[1].clone()), t }, i.startWithTarget = function (e) { t.prototype.startWithTarget.call(this, e), 0 !== this._actions.length && (this._split = this._actions[0].getDurationScaled() / this._duration, this._last = -1) }, i.stop = function () { 0 !== this._actions.length && (-1 !== this._last && this._actions[this._last].stop(), t.prototype.stop.call(this)) }, i.update = function (t) { var e = this._actions; if (0 !== e.length) { var i = 0, n = 0, r = this._split, s = this._last; if (t < r) { if (i = 0 !== r ? t / r : 1, 0 === n && 1 === s && this._reversed) { var a = e[1]; if (a.update(0), a.isUnknownDuration()) return; a.stop() } } else { var o = e[0]; if (n = 1, i = 1 === r ? 1 : (t - r) / (1 - r), -1 === s) { if (o.startWithTarget(this.target), o.update(1), o.isUnknownDuration()) return; o.stop() } if (0 === s) { if (o.update(1), o.isUnknownDuration()) return; o.stop() } } var u = e[n]; s === n && u.isDone() || (s !== n && u.startWithTarget(this.target), u.update(i > 1 ? i % 1 : i), this._last = n) } }, i.reverse = function () { var t = gJ(this._actions[1].reverse(), this._actions[0].reverse()); return this._cloneDecoration(t), t._reversed = !0, t }, i.updateOwner = function (t) { if (!(this._actions.length < 2)) { var i = this._actions[0], n = this._actions[1]; n._owner || (n._owner = t), i instanceof e || i instanceof TJ ? i.updateOwner(t) : i._owner || (i._owner = t) } }, i.findAction = function (t) { for (var i = 0, n = this._actions.length; i < n; ++i) { var r = this._actions[i]; if (r.getId() === t) return r; if ((r instanceof e || r instanceof TJ) && (r = r.findAction(t)) && r.getId() === t) return r } return null }, i.isUnknownDuration = function () { if (0 === this._actions.length) return !1; var t = this._actions[0], e = this._actions[1]; return this._last < 1 ? t.isUnknownDuration() : e.isUnknownDuration() }, i.toString = function () { return "<Sequence>" }, e }(_J); function vJ(t) { return new mJ(t) } var yJ = function (t) { function e(e, i) { var n; return (n = t.call(this) || this)._times = 0, n._total = 0, n._nextDt = 0, n._actionInstant = !1, n._innerAction = null, n.initWithAction(e, i), n } s(e, t); var i = e.prototype; return i.initWithAction = function (t, e) { if (!t || void 0 === e) return !1; var i = t.getDurationScaled() * e; return !!this.initWithDuration(i) && (this._times = e, this._innerAction = t, t instanceof oJ && (this._actionInstant = !0, this._times -= 1), this._total = 0, !0) }, i.clone = function () { var t = new e; return t._id = this._id, t._speed = this._speed, this._cloneDecoration(t), this._innerAction && t.initWithAction(this._innerAction.clone(), this._times), t }, i.startWithTarget = function (e) { this._total = 0, this._nextDt = (this._innerAction ? this._innerAction.getDurationScaled() : 0) / this._duration, t.prototype.startWithTarget.call(this, e), this._innerAction && this._innerAction.startWithTarget(e) }, i.stop = function () { this._innerAction && this._innerAction.stop(), t.prototype.stop.call(this) }, i.update = function (t) { var e = this._innerAction, i = this._duration, n = this._times, r = this._nextDt; if (e) if (t >= r) { for (; t > r && this._total < n;) { if (e.update(1), e.isUnknownDuration()) return; this._total++, e.stop(), e.startWithTarget(this.target), r += e.getDurationScaled() / i, this._nextDt = r > 1 ? 1 : r } if (t >= 1 && this._total < n) { if (e.update(1), e.isUnknownDuration()) return; this._total++ } this._actionInstant || (this._total === n ? e.stop() : e.update(t - (r - e.getDurationScaled() / i))) } else e.update(t * n % 1) }, i.isDone = function () { return this._total === this._times }, i.reverse = function () { var t = new e(this._innerAction ? this._innerAction.reverse() : void 0, this._times); return this._cloneDecoration(t), t }, i.setInnerAction = function (t) { this._innerAction !== t && (this._innerAction = t) }, i.getInnerAction = function () { return this._innerAction }, i.isUnknownDuration = function () { return !!this._innerAction && this._innerAction.isUnknownDuration() }, i.toString = function () { return "<Repeat>" }, e }(_J); function bJ(t, e) { return new yJ(t, e) } var wJ = function (t) { function e(e) { var i; return (i = t.call(this) || this)._innerAction = null, e && i.initWithAction(e), i } s(e, t); var i = e.prototype; return i.initWithAction = function (t) { return t ? (this._innerAction = t, this._duration = 1 / 0, !0) : (rt(1026), !1) }, i.clone = function () { var t = new e; return t._id = this._id, t._speed = this._speed, this._cloneDecoration(t), this._innerAction && t.initWithAction(this._innerAction.clone()), t }, i.startWithTarget = function (e) { t.prototype.startWithTarget.call(this, e), this._innerAction && this._innerAction.startWithTarget(e) }, i.stop = function () { this._innerAction && this._innerAction.stop(), t.prototype.stop.call(this) }, i.step = function (t) { if (!this._paused && 0 !== this._speed) { var e = this._innerAction; e && (t *= this._speed, e.step(t), e.isDone() && (e.startWithTarget(this.target), e.step(e.getElapsed() - e.getDurationScaled()))) } }, i.update = function () { J(1007) }, i.isDone = function () { return !1 }, i.reverse = function () { if (this._innerAction) { var t = new e(this._innerAction.reverse()); return this._cloneDecoration(t), t } return this }, i.setInnerAction = function (t) { this._innerAction !== t && (this._innerAction = t) }, i.getInnerAction = function () { return this._innerAction }, i.isUnknownDuration = function () { return !!this._innerAction && this._innerAction.isUnknownDuration() }, i.toString = function () { return "<RepeatForever>" }, e }(_J); function xJ(t) { return new wJ(t) } function SJ(t, e) { var i = new TJ; return i.initWithTwoActions(t, e), i } var TJ = function (t) { function e(e) { var i; if ((i = t.call(this) || this)._one = null, i._two = null, i._finished = !1, !e || 0 === e.length) return l(i); 1 === e.length && e.push(new pJ); var n = e.length - 1; if (n >= 0 && null == e[n] && J(1015), n >= 0) { for (var r = e[0], s = 1; s < n; s++)e[s] && (r = SJ(r, e[s])); i.initWithTwoActions(r, e[n]) } return i } s(e, t); var i = e.prototype; return i.initWithTwoActions = function (t, e) { if (!t || !e) return rt(1027), !1; var i = !1, n = t.getDurationScaled(), r = e.getDurationScaled(); return this.initWithDuration(Math.max(n, r)) && (this._one = t, this._two = e, n > r ? this._two = gJ(e, EJ(n - r)) : n < r && (this._one = gJ(t, EJ(r - n))), i = !0), i }, i.clone = function () { var t = new e; return t._id = this._id, t._speed = this._speed, this._cloneDecoration(t), this._one && this._two && t.initWithTwoActions(this._one.clone(), this._two.clone()), t }, i.startWithTarget = function (e) { t.prototype.startWithTarget.call(this, e), this._one && this._one.startWithTarget(e), this._two && this._two.startWithTarget(e) }, i.stop = function () { this._one && this._one.stop(), this._two && this._two.stop(), t.prototype.stop.call(this) }, i.update = function (t) { this._one && (this._finished && !this._one.isUnknownDuration() || this._one.update(t)), this._two && (this._finished && !this._two.isUnknownDuration() || this._two.update(t)), this._finished = 1 === t }, i.reverse = function () { if (this._one && this._two) { var t = SJ(this._one.reverse(), this._two.reverse()); return this._cloneDecoration(t), t } return this }, i.updateOwner = function (t) { if (this._one && this._two) { this._two._owner || (this._two._owner = t); var i = this._one; i instanceof e || i instanceof mJ ? i.updateOwner(t) : i._owner || (i._owner = t) } }, i.findAction = function (t) { var i = this._one, n = this._two, r = null, s = function (i) { if (i.getId() === t) return i; if (i instanceof mJ || i instanceof e) { var n = i.findAction(t); if (n) return n } return null }; return i && (r = s(i)) || n && (r = s(n)) ? r : null }, i.isUnknownDuration = function () { var t = this._one, e = this._two; if (null == t || null == e) return !1; var i = t.isUnknownDuration(), n = e.isUnknownDuration(); if (i || n) { if (i && n) return !0; if (this._finished) return !0 } return !1 }, i.toString = function () { return "<Spawn>" }, e }(_J), IJ = function (t) { function e() { return t.apply(this, arguments) || this } s(e, t); var i = e.prototype; return i.update = function () { }, i.reverse = function () { var t = new e(this._duration); return this._cloneDecoration(t), t }, i.clone = function () { var t = new e; return t._id = this._id, t._speed = this._speed, this._cloneDecoration(t), t.initWithDuration(this._duration), t }, i.isUnknownDuration = function () { return !1 }, i.toString = function () { return "<DelayTime>" }, e }(_J); function EJ(t) { return new IJ(t) } var AJ = function (t) { function e(e) { var i; return (i = t.call(this) || this)._other = null, e && i.initWithAction(e), i } s(e, t); var i = e.prototype; return i.initWithAction = function (e) { return e ? e === this._other ? (rt(1029), !1) : !!t.prototype.initWithDuration.call(this, e.getDurationScaled()) && (this._other = e, !0) : (rt(1028), !1) }, i.clone = function () { var t = new e; return t._id = this._id, t._speed = this._speed, this._cloneDecoration(t), this._other && t.initWithAction(this._other.clone()), t }, i.startWithTarget = function (e) { t.prototype.startWithTarget.call(this, e), this._other && this._other.startWithTarget(e) }, i.update = function (t) { this._other && this._other.update(1 - t) }, i.reverse = function () { return this._other ? this._other.clone() : this }, i.stop = function () { this._other && this._other.stop(), t.prototype.stop.call(this) }, i.isUnknownDuration = function () { return !1 }, i.toString = function () { return "<ReverseTime>" }, e }(_J); function CJ(t) { return new AJ(t) } var DJ = function (t) { function e(e, i, n) { var r; return (r = t.call(this, e) || this)._cb = i, r._args = n, r } s(e, t); var i = e.prototype; return i.clone = function () { return new e(this._duration, this._cb, this._args) }, i.update = function (t) { this._cb.apply(this, [this.target, t].concat(this._args)) }, i.reverse = function () { return this.clone() }, i.isUnknownDuration = function () { return !1 }, i.toString = function () { return "<ActionCustomUpdate>" }, e }(_J), RJ = function (t) { function e(e, i) { var n; return (n = t.call(this) || this)._finished = !1, n._cb = e, n._args = i, n } s(e, t); var i = e.prototype; return i.clone = function () { return new e(this._cb, this._args) }, i.reverse = function () { return this.clone() }, i.step = function () { throw new Error("should never go here") }, i.update = function () { var t = S.game.deltaTime; this._finished = this._cb.apply(this, [this.target, t].concat(this._args)) }, i.isDone = function () { return this._finished }, i.isUnknownDuration = function () { return !this.isDone() }, i.toString = function () { return "<ActionUnknownDuration>" }, e }(aJ); function PJ(t) { var e = t.charAt(0); if (/[A-Z]/.test(e)) { var i = (t = t.replace(e, e.toLowerCase())).split("-"); if (2 === i.length) { var n = i[0]; if ("linear" === n) t = "linear"; else { var r = i[1]; switch (n) { case "quadratic": t = "quad" + r; break; case "quartic": t = "quart" + r; break; case "quintic": t = "quint" + r; break; case "sinusoidal": t = "sine" + r; break; case "exponential": t = "expo" + r; break; case "circular": t = "circ" + r; break; default: t = n + r } } } } return t } function BJ(t) { var e = " [Tween:] ", i = " option is not support in v + " + I, n = t; n.delay && W(e + "delay" + i), n.repeat && W(e + "repeat" + i), n.repeatDelay && W(e + "repeatDelay" + i), n.interpolation && W(e + "interpolation" + i), n.onStop && W(e + "onStop" + i) } var MJ = t("TweenAction", function (t) { function e(e, i, n) { var r; if ((r = t.call(this) || this)._reversed = !1, null == n) n = Object.create(null); else if (BJ(n), n.easing && "string" == typeof n.easing && (n.easing = PJ(n.easing)), n.progress || (n.progress = r.progress), n.easing && "string" == typeof n.easing) { var s = n.easing; n.easing = Lc[s], n.easing || it(1031, s) } for (var a in r._opts = n, r._props = Object.create(null), i) { var o; if (i.hasOwnProperty(a)) { var u = i[a]; if ("function" == typeof u) u = u(); else if (null == u) continue; var h = void 0, c = void 0, l = void 0; void 0 !== u.value ? ("function" == typeof (l = u.value) && (l = l()), void 0 !== u.easing && ("string" == typeof u.easing ? (h = Lc[u.easing]) || it(1031, u.easing) : h = u.easing), void 0 !== u.progress && (c = u.progress)) : l = u; var f = Object.create(null); f.start = f.current = f.end = null, f.keys = null, f.value = l, f.easing = h, f.progress = c, f.convert = u.convert, f.clone = u.clone, f.add = u.add, f.sub = u.sub, f.legacyProgress = null === (o = u.legacyProgress) || void 0 === o || o, f.toFixed = u.toFixed, f.onStart = u.onStart, f.onStop = u.onStop, f.onComplete = u.onComplete, f.valid = !0, r._props[a] = f } } return r._originProps = i, r.initWithDuration(e), r } s(e, t); var i = e.prototype; return i.clone = function () { var t = new e(this._duration, this._originProps, this._opts); return t._reversed = this._reversed, t._owner = this._owner, t._id = this._id, this._cloneDecoration(t), t }, i.reverse = function () { if (!this._opts.relative) return it(16382), new e(0, {}); var t = new e(this._duration, this._originProps, this._opts); return this._cloneDecoration(t), t._reversed = !this._reversed, t._owner = this._owner, t }, i.startWithTarget = function (e) { t.prototype.startWithTarget.call(this, e); var i = this._getWorkerTarget(); if (i) { var n = !!this._opts.relative, r = this._props, s = this._reversed, a = function () { var t = i[o]; if (void 0 === t) return 0; var e = r[o], a = e.value; if ("number" == typeof t) e.start = t, e.current = t, e.end = n ? s ? t - a : t + a : a; else if ("object" == typeof t) if (e.legacyProgress) { if (null == e.start) { var u = t.constructor; e.start = new u, e.current = new u, e.end = new u } var h; h = a.getModifiableProperties ? a.getModifiableProperties() : Object.keys(a), e.keys = h; for (var c = 0, l = h.length; c < l; ++c) { var f = h[c]; isNaN(t[f]) || (e.start[f] = t[f], e.current[f] = t[f], e.end[f] = n ? s ? t[f] - a[f] : t[f] + a[f] : a[f]) } } else { var d = e.clone; if (!d) return it(16383, o), e.valid = !1, 0; var p = e.add, _ = e.sub; if (n && (p || (it(16384, o), e.valid = !1), s && !_ && (it(16385, o), e.valid = !1), !e.valid)) return 0; e.start = d(t), e.current = d(t), e.end = n ? s ? _(t, a) : p(t, a) : d(a) } else if ("string" == typeof t) { var g = e.convert, m = function (t) { if ("number" == typeof t) return t; var e = t; return g && (e = g(t)), "number" != typeof e && (e = Number(e), Number.isNaN(e)) ? (it(16386, "" + t), null) : e }, v = m(a), y = m(t); if (null == v || null == y) return e.valid = !1, 0; e.start = y, e.current = t, e.end = n ? s ? y - v : y + v : v } e.onStart && e.onStart({ relative: n, reversed: s, start: e.start, end: e.end }) }; for (var o in r) a(); this._opts.onStart && this._opts.onStart(i) } }, i.stop = function () { var e = this._props; for (var i in e) { var n = e[i]; n.valid && n.onStop && n.onStop() } t.prototype.stop.call(this) }, i.update = function (t) { var e = this._getWorkerTarget(); if (e && this._opts) { var i = this._props, n = this._opts, r = t; "function" == typeof n.easing && (r = n.easing(t)); var s = n.progress; for (var a in i) { var o = i[a]; if (o.valid) { var u = o.easing ? o.easing(t) : r, h = o.progress ? o.progress : s, c = o.start, l = o.end, f = o.current; if ("number" == typeof f) o.current = h(c, l, o.current, u); else if ("object" == typeof c) if (o.legacyProgress) for (var d = o.keys, p = 0, _ = d.length; p < _; ++p) { var g = d[p]; o.current[g] = h(c[g], l[g], o.current[g], u) } else o.current = h(c, l, o.current, u); else if ("string" == typeof f) { var m, v = h(c, l, o.current, u); if ("number" == typeof v) v = v.toFixed(null !== (m = o.toFixed) && void 0 !== m ? m : 0); else if ("string" != typeof v) { it(16387); continue } o.current = v } e[a] = o.current, 1 === t && o.onComplete && o.onComplete() } } n.onUpdate && n.onUpdate(e, t), 1 === t && n.onComplete && n.onComplete(e) } }, i.progress = function (t, e, i, n) { return t + (e - t) * n }, i.isUnknownDuration = function () { return !1 }, n(e, [{ key: "relative", get: function () { return !!this._opts.relative } }]), e }(_J)), OJ = function (t) { function e(e) { var i; return (i = t.call(this) || this)._props = void 0, i._props = {}, e && i.init(e), i } s(e, t); var i = e.prototype; return i.init = function (t) { for (var e in t) this._props[e] = t[e]; return !0 }, i.update = function () { var t = this._props, e = this._getWorkerTarget(); for (var i in t) e[i] = t[i] }, i.clone = function () { var t = new e; return t._id = this._id, t.init(this._props), t }, i.isUnknownDuration = function () { return !1 }, e }(oJ); function LJ() { return sJ.instance.ActionManager } var FJ, kJ, NJ, zJ, UJ, VJ, GJ, HJ, WJ, jJ, XJ, qJ, YJ, KJ, QJ, ZJ, JJ, $J, t$, e$, i$, n$, r$, s$, a$, o$, u$, h$ = t("Tween", function () { function t(t) { this._actions = [], this._finalAction = null, this._target = null, this._tag = -1, this._timeScale = 1, this._target = void 0 === t ? null : t } var e = t.prototype; return e.tag = function (t) { return this._tag = t, this }, e.id = function (t) { function e(e) { return t.apply(this, arguments) } return e.toString = function () { return t.toString() }, e }((function (t) { return this._actions.length > 0 && this._actions[this._actions.length - 1].setId(t), this })), e.then = function (t) { var e = t._union(!0); return e && (e.setSpeed(t._timeScale), this._actions.push(e)), this }, e.reverse = function (e, i) { if (null == e && null == i) return this.reverseTween(); var n, r; if (e instanceof t ? (n = e, void 0 !== i && (r = i)) : "number" == typeof e && (n = this, r = e), n) { var s = t.reverseAction(n, r); s && this._actions.push(s) } return this }, e.reverseTween = function () { if (0 === this._actions.length) return it(16388), this.clone(this._target); var t = this._union(!1), e = c$(this._target); return e._timeScale = this._timeScale, t && e.insertAction(t.reverse()), e }, t.reverseAction = function (t, e) { var i = t._actions; if (0 === i.length) return null; var n = null, r = null; return "number" == typeof e ? n = t.findAction(e, i) : t && (n = t._union(!1)), n ? (r = n.reverse())._owner = t : it(16391, "" + e), r }, e.findAction = function (t, e) { for (var i = null, n = 0, r = e.length; n < r; ++n) { if ((i = e[n]).getId() === t) return i; if ((i instanceof mJ || i instanceof TJ) && (i = i.findAction(t))) return i } return null }, e.insertAction = function (t) { var e = t.clone(); return this.updateOwnerForAction(e), this._actions.push(e), this }, e.updateOwnerForAction = function (t) { t && (t instanceof mJ || t instanceof TJ ? t.updateOwner(this) : t._owner || (t._owner = this)) }, e.target = function (t) { function e(e) { return t.apply(this, arguments) } return e.toString = function () { return t.toString() }, e }((function (t) { return this._target = t, this })), e.getTarget = function () { return this._target }, e.start = function (t) { if (void 0 === t && (t = 0), !this._target) return it(16392), this; this._finalAction && LJ().removeAction(this._finalAction); var e = this._unionForStart(); return this._finalAction = e, e ? (e.setTag(this._tag), e.setSpeed(this._timeScale), e.setStartTime(t), e.setPaused(!1), LJ().addAction(e, this._target, !1)) : it(16393), this }, e.stop = function () { return this._finalAction && (this._finalAction.stop(), LJ().removeAction(this._finalAction), this._finalAction = null), this }, e.pause = function () { return this._finalAction ? this._finalAction.setPaused(!0) : it(16389), this }, e.resume = function () { return this._finalAction ? this._finalAction.setPaused(!1) : it(16390), this }, e.clone = function (t) { var e = this._union(!1), i = c$(null != t ? t : this._target); return i._timeScale = this._timeScale, e ? i.insertAction(e) : i }, e.union = function (t) { var e, i = this; if (void 0 === t) return e = i._union(!1), i._actions.length = 0, e && i._actions.push(e), this; var n = this._actions, r = n.findIndex((function (e) { return e.getId() === t })); if (n.length > 1) { var s = n.splice(r); 1 === s.length ? n.push(s[0]) : n.push(vJ(s)) } return this }, e.to = function (t, e, i) { var n = i || Object.create(null); n.relative = !1; var r = new MJ(t, e, n); return this._actions.push(r), this }, e.by = function (t, e, i) { var n = i || Object.create(null); n.relative = !0; var r = new MJ(t, e, n); return this._actions.push(r), this }, e.update = function (t, e) { for (var i = arguments.length, n = new Array(i > 2 ? i - 2 : 0), r = 2; r < i; r++)n[r - 2] = arguments[r]; var s = new DJ(t, e, n); return this._actions.push(s), this }, e.updateUntil = function (t) { for (var e = arguments.length, i = new Array(e > 1 ? e - 1 : 0), n = 1; n < e; n++)i[n - 1] = arguments[n]; var r = new RJ(t, i); return this._actions.push(r), this }, e.set = function (t) { var e = new OJ(t); return this._actions.push(e), this }, e.delay = function (t) { var e = EJ(t); return this._actions.push(e), this }, e.call = function (t, e, i) { var n = dJ(t, e, i); return this._actions.push(n), this }, e.sequence = function () { for (var e = arguments.length, i = new Array(e), n = 0; n < e; n++)i[n] = arguments[n]; var r = t._wrappedSequence(i); return r && this._actions.push(r), this }, e.parallel = function () { for (var e = arguments.length, i = new Array(e), n = 0; n < e; n++)i[n] = arguments[n]; var r = t._wrappedParallel(i); return r && this._actions.push(r), this }, e.timeScale = function (t) { return this._timeScale = t, this._finalAction && this._finalAction.setSpeed(t), this }, e.getTimeScale = function () { return this._timeScale }, e.repeat = function (e, i) { if (e === 1 / 0) return this.repeatForever(i); var n, r = this._actions; return (n = i instanceof t ? i._union(!1) : r.pop()) && r.push(bJ(n, e)), this }, e.repeatForever = function (e) { var i, n = this._actions; return (i = e instanceof t ? e._union(!1) : n.pop()) && 0 !== n.length ? n.push(bJ(i, Number.MAX_SAFE_INTEGER)) : i instanceof _J ? n.push(xJ(i)) : it(16394), this }, e.reverseTime = function (e) { var i, n = this._actions; return (i = e instanceof t ? e._union(!1) : n.pop()) instanceof _J ? n.push(CJ(i)) : it(16395), this }, e.hide = function () { if (this._target instanceof ky) { var t = new hJ; this._actions.push(t) } return this }, e.show = function () { if (this._target instanceof ky) { var t = new uJ; this._actions.push(t) } return this }, e.removeSelf = function () { if (this._target instanceof ky) { var t = lJ(!1); this._actions.push(t) } return this }, e.destroySelf = function () { if (this._target instanceof ky) { var t = lJ(!0); this._actions.push(t) } return this }, t.getRunningCount = function (t) { return LJ().getNumberOfRunningActionsInTarget(t) }, t.stopAll = function () { LJ().removeAllActions() }, t.stopAllByTag = function (t, e) { LJ().removeAllActionsByTag(t, e) }, t.stopAllByTarget = function (t) { LJ().removeAllActionsFromTarget(t) }, t.pauseAllByTarget = function (t) { LJ().pauseTarget(t) }, t.resumeAllByTarget = function (t) { LJ().resumeTarget(t) }, e._union = function (t) { var e = this._actions; if (0 === e.length) return null; var i = vJ(e); return t && this.updateOwnerForAction(i), i }, e._unionForStart = function () { var t = this._actions; return 0 === t.length ? null : 1 === t.length && t[0] instanceof wJ ? t[0] : vJ(t) }, t._tweenToActions = function (e) { var i = t._tmpArgs; i.length = 0; for (var n = e.length, r = 0; r < n; r++) { var s = e[r], a = s._union(!0); a && (a.setSpeed(s._timeScale), i.push(a)) } }, t._wrappedSequence = function (e) { t._tweenToActions(e); var i = vJ(t._tmpArgs); return this._tmpArgs.length = 0, i }, t._wrappedParallel = function (e) { t._tweenToActions(e); var i, n = (i = t._tmpArgs, new TJ(i)); return this._tmpArgs.length = 0, n }, n(t, [{ key: "running", get: function () { return !!this._finalAction && LJ().isActionRunning(this._finalAction) } }, { key: "duration", get: function () { return this._finalAction ? this._finalAction.getDuration() : 0 } }]), t }()); function c$(t) { return new h$(t) } function l$(t) { return it(16396), new h$(t) } h$._tmpArgs = [], T.Tween = h$, T.tween = c$, T.tweenUtil = l$; var f$ = new rr, d$ = { NONE: 0, COLOR: 1, SPRITE: 2, SCALE: 3 }; De(d$); var p$ = { CLICK: "click" }, _$ = (FJ = Gu("cc.Button"), kJ = Wu(110), NJ = Hu(TF), zJ = Ih(ky), UJ = Ih(d$), VJ = Ih(vO), GJ = Ih(vO), HJ = Ih(vO), WJ = Ih(vO), jJ = Ih([rm]), FJ(XJ = kJ(XJ = NJ((u$ = function (t) { function e() { var e; return (e = t.call(this) || this).clickEvents = YJ && YJ(), e._interactable = KJ && KJ(), e._transition = QJ && QJ(), e._normalColor = ZJ && ZJ(), e._hoverColor = JJ && JJ(), e._pressedColor = $J && $J(), e._disabledColor = t$ && t$(), e._normalSprite = e$ && e$(), e._hoverSprite = i$ && i$(), e._pressedSprite = n$ && n$(), e._disabledSprite = r$ && r$(), e._duration = s$ && s$(), e._zoomScale = a$ && a$(), e._target = o$ && o$(), e._pressed = !1, e._hovered = !1, e._fromColor = new rr, e._toColor = new rr, e._time = 0, e._transitionFinished = !0, e._fromScale = Qn(), e._toScale = Qn(), e._originalScale = null, e._sprite = null, e._targetScale = Qn(), e } s(e, t); var i = e.prototype; return i.__preload = function () { this.target || (this.target = this.node), this._applyTarget(), this._resetState() }, i.onEnable = function () { this._registerNodeEvent() }, i.onDisable = function () { this._resetState(), this._unregisterNodeEvent() }, i.onDestroy = function () { this.target.isValid && this._unregisterTargetEvent(this.target) }, i.update = function (t) { var e = this.target; if (!this._transitionFinished && e && (1 === this._transition || 3 === this._transition)) { this._time += t; var i = 1; if (this._duration > 0 && (i = this._time / this._duration), i >= 1 && (i = 1), 1 === this._transition) { var n = e._uiProps.uiComp; rr.lerp(f$, this._fromColor, this._toColor, i), n && (n.color = f$) } else 3 === this.transition && (e.getScale(this._targetScale), this._targetScale.x = Yi(this._fromScale.x, this._toScale.x, i), this._targetScale.y = Yi(this._fromScale.y, this._toScale.y, i), e.setScale(this._targetScale)); 1 === i && (this._transitionFinished = !0) } }, i._resizeNodeToTargetNode = function () { this.target && this.target._getUITransformComp() }, i._resetState = function () { this._pressed = !1, this._hovered = !1; var t = this.target; if (t) { var e = this._transition; if (1 === e && this._interactable) { var i = t.getComponent(GF); i && (i.color = this._normalColor) } else 3 === e && this._originalScale && t.setScale(this._originalScale); this._transitionFinished = !0 } }, i._registerNodeEvent = function () { var t = this, e = t.node; e.on("touch-start", t._onTouchBegan, t), e.on("touch-move", t._onTouchMove, t), e.on("touch-end", t._onTouchEnded, t), e.on("touch-cancel", t._onTouchCancel, t), e.on("mouse-enter", t._onMouseMoveIn, t), e.on("mouse-leave", t._onMouseMoveOut, t) }, i._registerTargetEvent = function (t) { t.on("transform-changed", this._onTargetTransformChanged, this) }, i._unregisterNodeEvent = function () { var t = this, e = t.node; e.off("touch-start", t._onTouchBegan, t), e.off("touch-move", t._onTouchMove, t), e.off("touch-end", t._onTouchEnded, t), e.off("touch-cancel", t._onTouchCancel, t), e.off("mouse-enter", t._onMouseMoveIn, t), e.off("mouse-leave", t._onMouseMoveOut, t) }, i._unregisterTargetEvent = function (t) { t.off("transform-changed") }, i._getTargetSprite = function (t) { var e = null; return t && (e = t.getComponent(iN)), e }, i._applyTarget = function () { this.target && (this._sprite = this._getTargetSprite(this.target), this._originalScale || (this._originalScale = new Kn), Kn.copy(this._originalScale, this.target.scale), this._registerTargetEvent(this.target)) }, i._onTargetSpriteFrameChanged = function (t) { 2 === this._transition && this._setCurrentStateSpriteFrame(t.spriteFrame) }, i._setCurrentStateSpriteFrame = function (t) { if (t) switch (this._getButtonState()) { case 0: this._normalSprite = t; break; case 1: this._hoverSprite = t; break; case 2: this._pressedSprite = t; break; case 3: this._disabledSprite = t } }, i._onTargetColorChanged = function (t) { 1 === this._transition && this._setCurrentStateColor(t) }, i._setCurrentStateColor = function (t) { switch (this._getButtonState()) { case 0: this._normalColor = t; break; case 1: this._hoverColor = t; break; case 2: this._pressedColor = t; break; case 3: this._disabledColor = t } }, i._onTargetTransformChanged = function (t) { 4 & t && this._originalScale && 3 === this._transition && this._transitionFinished && Kn.copy(this._originalScale, this.target.scale) }, i._onTouchBegan = function (t) { this._interactable && this.enabledInHierarchy && (this._pressed = !0, this._updateState(), t && (t.propagationStopped = !0)) }, i._onTouchMove = function (t) { if (this._interactable && this.enabledInHierarchy && this._pressed && t) { var e = t.touch; if (e) { var i, n = this.node._getUITransformComp().hitTest(e.getLocation(), t.windowId); 3 === this._transition && this.target && this._originalScale ? n ? (Kn.copy(this._fromScale, this._originalScale), Kn.multiplyScalar(this._toScale, this._originalScale, this._zoomScale), this._transitionFinished = !1) : (this._time = 0, this._transitionFinished = !0, this.target.setScale(this._originalScale)) : (i = n ? 2 : 0, this._applyTransition(i)), t && (t.propagationStopped = !0) } } }, i._onTouchEnded = function (t) { this._interactable && this.enabledInHierarchy && (this._pressed && (rm.emitEvents(this.clickEvents, t), this.node.emit("click", this)), this._pressed = !1, this._updateState(), t && (t.propagationStopped = !0)) }, i._onTouchCancel = function () { this._interactable && this.enabledInHierarchy && (this._pressed = !1, this._updateState()) }, i._onMouseMoveIn = function () { !this._pressed && this.interactable && this.enabledInHierarchy && (2 !== this._transition || this._hoverSprite) && (this._hovered || (this._hovered = !0, this._updateState())) }, i._onMouseMoveOut = function () { this._hovered && (this._hovered = !1, this._updateState()) }, i._updateState = function () { var t = this._getButtonState(); this._applyTransition(t) }, i._getButtonState = function () { var t = 0; return this._interactable ? this._pressed ? t = 2 : this._hovered && (t = 1) : t = 3, t }, i._updateColorTransition = function (t) { var e, i = this._getColorByState(t), n = null == (e = this.target) ? void 0 : e.getComponent(GF); n && (3 === t ? (n.color = i, this._transitionFinished = !0) : (this._fromColor = n.color.clone(), this._toColor = i, this._time = 0, this._transitionFinished = !1)) }, i._updateSpriteTransition = function (t) { var e = this._getSpriteFrameByState(t); this._sprite && e && (this._sprite.spriteFrame = e) }, i._updateScaleTransition = function (t) { this._interactable && (2 === t ? this._zoomUp() : this._zoomBack()) }, i._zoomUp = function () { this._originalScale && (Kn.copy(this._fromScale, this._originalScale), Kn.multiplyScalar(this._toScale, this._originalScale, this._zoomScale), this._time = 0, this._transitionFinished = !1) }, i._zoomBack = function () { this.target && this._originalScale && (Kn.copy(this._fromScale, this.target.scale), Kn.copy(this._toScale, this._originalScale), this._time = 0, this._transitionFinished = !1) }, i._applyTransition = function (t) { var e = this._transition; 1 === e ? this._updateColorTransition(t) : 2 === e ? this._updateSpriteTransition(t) : 3 === e && this._updateScaleTransition(t) }, i._getSpriteFrameByState = function (t) { switch (t) { case 0: return this._normalSprite; case 3: return this._disabledSprite; case 1: return this.hoverSprite; case 2: return this._pressedSprite; default: return null } }, i._getColorByState = function (t) { switch (t) { case 0: return this._normalColor; case 3: return this._disabledColor; case 1: return this._hoverColor; case 2: return this._pressedColor; default: return new rr } }, i._xrHoverEnter = function () { }, i._xrHoverExit = function () { }, i._xrClick = function () { }, i._xrUnClick = function () { }, n(e, [{ key: "target", get: function () { return this._target || this.node }, set: function (t) { this._target !== t && (this._target && this._unregisterTargetEvent(this._target), this._target = t, this._applyTarget()) } }, { key: "interactable", get: function () { return this._interactable }, set: function (t) { this._interactable !== t && (this._interactable = t, this._updateState(), this._interactable || this._resetState()) } }, { key: "_resizeToTarget", set: function (t) { t && this._resizeNodeToTargetNode() } }, { key: "transition", get: function () { return this._transition }, set: function (t) { this._transition !== t && (1 === this._transition ? this._updateColorTransition(0) : 2 === this._transition && this._updateSpriteTransition(0), this._transition = t, this._updateState()) } }, { key: "normalColor", get: function () { return this._normalColor }, set: function (t) { this._normalColor !== t && (this._normalColor.set(t), this._updateState()) } }, { key: "pressedColor", get: function () { return this._pressedColor }, set: function (t) { this._pressedColor !== t && this._pressedColor.set(t) } }, { key: "hoverColor", get: function () { return this._hoverColor }, set: function (t) { this._hoverColor !== t && this._hoverColor.set(t) } }, { key: "disabledColor", get: function () { return this._disabledColor }, set: function (t) { this._disabledColor !== t && (this._disabledColor.set(t), this._updateState()) } }, { key: "duration", get: function () { return this._duration }, set: function (t) { this._duration !== t && (this._duration = t) } }, { key: "zoomScale", get: function () { return this._zoomScale }, set: function (t) { this._zoomScale !== t && (this._zoomScale = t) } }, { key: "normalSprite", get: function () { return this._normalSprite }, set: function (t) { if (this._normalSprite !== t) { this._normalSprite = t; var e = this.node.getComponent(iN); e && (e.spriteFrame = t), this._updateState() } } }, { key: "pressedSprite", get: function () { return this._pressedSprite }, set: function (t) { this._pressedSprite !== t && (this._pressedSprite = t, this._updateState()) } }, { key: "hoverSprite", get: function () { return this._hoverSprite }, set: function (t) { this._hoverSprite !== t && (this._hoverSprite = t, this._updateState()) } }, { key: "disabledSprite", get: function () { return this._disabledSprite }, set: function (t) { this._disabledSprite !== t && (this._disabledSprite = t, this._updateState()) } }]), e }(am), u$.Transition = d$, u$.EventType = p$, m((qJ = u$).prototype, "target", [zJ], Object.getOwnPropertyDescriptor(qJ.prototype, "target"), qJ.prototype), m(qJ.prototype, "transition", [UJ], Object.getOwnPropertyDescriptor(qJ.prototype, "transition"), qJ.prototype), m(qJ.prototype, "normalSprite", [VJ], Object.getOwnPropertyDescriptor(qJ.prototype, "normalSprite"), qJ.prototype), m(qJ.prototype, "pressedSprite", [GJ], Object.getOwnPropertyDescriptor(qJ.prototype, "pressedSprite"), qJ.prototype), m(qJ.prototype, "hoverSprite", [HJ], Object.getOwnPropertyDescriptor(qJ.prototype, "hoverSprite"), qJ.prototype), m(qJ.prototype, "disabledSprite", [WJ], Object.getOwnPropertyDescriptor(qJ.prototype, "disabledSprite"), qJ.prototype), YJ = Bu(qJ.prototype, "clickEvents", [jJ, eh], (function () { return [] })), KJ = Bu(qJ.prototype, "_interactable", [eh], (function () { return !0 })), QJ = Bu(qJ.prototype, "_transition", [eh], (function () { return 0 })), ZJ = Bu(qJ.prototype, "_normalColor", [eh], (function () { return rr.WHITE.clone() })), JJ = Bu(qJ.prototype, "_hoverColor", [eh], (function () { return new rr(211, 211, 211, 255) })), $J = Bu(qJ.prototype, "_pressedColor", [eh], (function () { return rr.WHITE.clone() })), t$ = Bu(qJ.prototype, "_disabledColor", [eh], (function () { return new rr(124, 124, 124, 255) })), e$ = Bu(qJ.prototype, "_normalSprite", [eh], (function () { return null })), i$ = Bu(qJ.prototype, "_hoverSprite", [eh], (function () { return null })), n$ = Bu(qJ.prototype, "_pressedSprite", [eh], (function () { return null })), r$ = Bu(qJ.prototype, "_disabledSprite", [eh], (function () { return null })), s$ = Bu(qJ.prototype, "_duration", [eh], (function () { return .1 })), a$ = Bu(qJ.prototype, "_zoomScale", [eh], (function () { return 1.2 })), o$ = Bu(qJ.prototype, "_target", [eh], (function () { return null })), XJ = qJ)) || XJ) || XJ) || XJ); t({ Button: _$, ButtonComponent: _$ }), T.Button = _$; var g$ = function () { function t() { } return t.add = function (t) { var e = this._tabIndexList; -1 === e.indexOf(t) && e.push(t) }, t.remove = function (t) { var e = this._tabIndexList, i = e.indexOf(t); -1 !== i && e.splice(i, 1) }, t.resort = function () { this._tabIndexList.sort((function (t, e) { return t._delegate.tabIndex - e._delegate.tabIndex })) }, t.next = function (t) { var e = this._tabIndexList, i = e.indexOf(t); if (t.setFocus(!1), -1 !== i) { var n = e[i + 1]; n && n._delegate.tabIndex >= 0 && n.setFocus(!0) } }, t }(); g$._tabIndexList = []; var m$ = function () { function t() { this._editing = !1, this._delegate = null } var e = t.prototype; return e.init = function () { }, e.onEnable = function () { }, e.beforeDraw = function () { }, e.onDisable = function () { this._editing && this.endEditing() }, e.clear = function () { this._delegate = null }, e.setTabIndex = function () { }, e.setSize = function () { }, e.setFocus = function (t) { t ? this.beginEditing() : this.endEditing() }, e.isFocused = function () { return this._editing }, e.beginEditing = function () { }, e.endEditing = function () { }, t }(), v$ = E.document, y$ = new Gr, b$ = new Gr, w$ = new Kn, x$ = null, S$ = 0, T$ = function (t) { function e() { var e; return (e = t.call(this) || this)._delegate = null, e._inputMode = -1, e._inputFlag = -1, e._returnType = -1, e.__eventListeners = {}, e.__autoResize = !1, e.__orientationChanged = void 0, e._edTxt = null, e._isTextArea = !1, e._textLabelFont = null, e._textLabelFontSize = null, e._textLabelFontColor = null, e._textLabelAlign = null, e._placeholderLabelFont = null, e._placeholderLabelFontSize = null, e._placeholderLabelFontColor = null, e._placeholderLabelAlign = null, e._placeholderLineHeight = null, e._placeholderStyleSheet = null, e._domId = "EditBoxId_" + ++S$, e._forceUpdate = !1, e } s(e, t); var i = e.prototype; return i.init = function (t) { t && (this._delegate = t, 0 === t.inputMode ? this._createTextArea() : this._createInput(), g$.add(this), this.setTabIndex(t.tabIndex), this._initStyleSheet(), this._registerEventListeners(), this._addDomToGameContainer(), $B.instance.on("canvas-resize", this._resize, this), Zo.on("window-resize", this._resize, this)) }, i.clear = function () { $B.instance.off("canvas-resize", this._resize, this), Zo.off("window-resize", this._resize, this), this._removeEventListeners(), this._removeDomFromGameContainer(), g$.remove(this), x$ === this && (x$ = null), this._delegate = null }, i._resize = function () { this._forceUpdate = !0 }, i.beforeDraw = function () { (this._delegate.node.hasChangedFlags || this._forceUpdate) && (this._forceUpdate = !1, this._updateMatrix()) }, i.setTabIndex = function (t) { this._edTxt.tabIndex = t, g$.resort() }, i.setSize = function (t, e) { var i = this._edTxt; i && (i.style.width = t + "px", i.style.height = e + "px") }, i.beginEditing = function () { x$ && x$ !== this && x$.setFocus(!1), this._editing = !0, x$ = this, this._delegate._editBoxEditingDidBegan(), this._showDom(), this._edTxt.focus() }, i.endEditing = function () { this._edTxt.blur() }, i._createInput = function () { this._isTextArea = !1, this._edTxt = v$.createElement("input") }, i._createTextArea = function () { this._isTextArea = !0, this._edTxt = v$.createElement("textarea") }, i._addDomToGameContainer = function () { mM.container && this._edTxt && (mM.container.appendChild(this._edTxt), v$.head.appendChild(this._placeholderStyleSheet)) }, i._removeDomFromGameContainer = function () { We(mM.container, this._edTxt) && this._edTxt && mM.container.removeChild(this._edTxt), We(v$.head, this._placeholderStyleSheet) && v$.head.removeChild(this._placeholderStyleSheet), this._edTxt = null, this._placeholderStyleSheet = null }, i._showDom = function () { this._updateMaxLength(), this._updateInputType(), this._updateStyleSheet(), this._edTxt && this._delegate && (this._edTxt.style.display = "", this._delegate._hideLabels()), tu.isMobile && this._showDomOnMobile() }, i._hideDom = function () { var t = this._edTxt; t && this._delegate && (t.style.display = "none", this._delegate._showLabels()), tu.isMobile && this._hideDomOnMobile() }, i._showDomOnMobile = function () { tu.os !== Io.ANDROID && tu.os !== Io.OHOS || (Zo.handleResizeEvent = !1, this._adjustWindowScroll()) }, i._hideDomOnMobile = function () { tu.os !== Io.ANDROID && tu.os !== Io.OHOS || (Zo.handleResizeEvent = !0), this._scrollBackWindow() }, i._isElementInViewport = function () { if (this._edTxt) { var t = this._edTxt.getBoundingClientRect(); return t.top >= 0 && t.left >= 0 && t.bottom <= (E.innerHeight || v$.documentElement.clientHeight) && t.right <= (E.innerWidth || v$.documentElement.clientWidth) } return !1 }, i._adjustWindowScroll = function () { var t = this; setTimeout((function () { E.scrollY < 40 && !t._isElementInViewport() && t._edTxt.scrollIntoView({ block: "start", inline: "nearest", behavior: "smooth" }) }), 400) }, i._scrollBackWindow = function () { setTimeout((function () { tu.browserType !== xo.WECHAT || tu.os !== Io.IOS ? E.scrollTo(0, 0) : E.top && E.top.scrollTo(0, 0) }), 400) }, i._updateMatrix = function () { if (this._edTxt) { var t = this._delegate.node, e = cM.getScaleX(), i = cM.getScaleY(), n = cM.getViewportRect(), r = Zo.devicePixelRatio; t.getWorldMatrix(y$); var s = t._getUITransformComp(); if (s && (Kn.set(w$, -s.anchorX * s.width, -s.anchorY * s.height, w$.z), Gr.transform(y$, y$, w$)), t._getUITransformComp()) { var a = yB.root.batcher2D.getFirstRenderCamera(t); if (a) { a.node.getWorldRT(b$); var o = b$.m12, u = b$.m13, h = eu.center; b$.m12 = h.x - (b$.m00 * o + b$.m04 * u), b$.m13 = h.y - (b$.m01 * o + b$.m05 * u), e /= r, i /= r, Kn.set(w$, e, i, 1), Gr.scale(b$, b$, w$); var c = mM.container, l = parseInt(c && c.style.paddingLeft || "0"); l += n.x / r; var f = parseInt(c && c.style.paddingBottom || "0"); f += n.y / r, b$.m12 += l, b$.m13 += f, Gr.multiply(b$, b$, y$); var d = "matrix(" + b$.m00 + "," + -b$.m01 + "," + -b$.m04 + "," + b$.m05 + "," + b$.m12 + "," + -b$.m13 + ")"; this._edTxt.style.transform = d, this._edTxt.style["-webkit-transform"] = d, this._edTxt.style["transform-origin"] = "0px 100% 0px", this._edTxt.style["-webkit-transform-origin"] = "0px 100% 0px" } } } }, i._updateInputType = function () { var t = this._delegate, e = t.inputMode, i = t.inputFlag, n = t.returnType, r = this._edTxt; if (this._inputMode !== e || this._inputFlag !== i || this._returnType !== n) { if (this._inputMode = e, this._inputFlag = i, this._returnType = n, this._isTextArea) { var s = "none"; return 4 === i ? s = "uppercase" : 2 === i && (s = "capitalize"), void (r.style.textTransform = s) } if (0 === i) return r.type = "password", void (r.style.textTransform = "none"); var a = r.type; 1 === e ? a = "email" : 2 === e ? a = "number" : 5 === e ? a = "digit" : 3 === e ? (a = "tel", r.addEventListener("wheel", (function () { return !1 }))) : 4 === e ? a = "url" : (a = "text", 3 === n && (a = "search")), r.type = a; var o = "none"; 4 === i ? o = "uppercase" : 2 === i && (o = "capitalize"), r.style.textTransform = o } }, i._updateMaxLength = function () { var t = this._delegate.maxLength; t < 0 && (t = 65535), this._edTxt.maxLength = t }, i._initStyleSheet = function () { if (this._edTxt) { var t = this._edTxt; t.style.color = "#000000", t.style.border = "0px", t.style.background = "transparent", t.style.width = "100%", t.style.height = "100%", t.style.outline = "medium", t.style.padding = "0", t.style.textTransform = "none", t.style.display = "none", t.style.position = "absolute", t.style.bottom = "0px", t.style.left = "2px", t.className = "cocosEditBox", t.style.fontFamily = "Arial", t.id = this._domId, this._isTextArea ? (t.style.resize = "none", t.style.overflowY = "scroll") : (t.type = "text", t.style["-moz-appearance"] = "textfield"), this._placeholderStyleSheet = v$.createElement("style") } }, i._updateStyleSheet = function () { var t = this._delegate, e = this._edTxt; e && t && (e.value = t.string, this._updateTextLabel(t.textLabel)) }, i._updateTextLabel = function (t) { if (t) { var e = t.font; e = !e || e instanceof EL ? t.fontFamily : e._fontFamily; var i = t.fontSize * t.node.scale.y; if ((this._textLabelFont !== e || this._textLabelFontSize !== i || this._textLabelFontColor !== t.fontColor || this._textLabelAlign !== t.horizontalAlign) && (this._textLabelFont = e, this._textLabelFontSize = i, this._textLabelFontColor = t.fontColor, this._textLabelAlign = t.horizontalAlign, this._edTxt)) { var n = this._edTxt; switch (n.style.fontSize = i + "px", n.style.color = t.color.toCSS(), n.style.fontFamily = e, t.horizontalAlign) { case Zk.HorizontalAlign.LEFT: n.style.textAlign = "left"; break; case Zk.HorizontalAlign.CENTER: n.style.textAlign = "center"; break; case Zk.HorizontalAlign.RIGHT: n.style.textAlign = "right" } } } }, i._updatePlaceholderLabel = function (t) { if (t) { var e = t.font; e = !e || e instanceof EL ? t.fontFamily : t.font._fontFamily; var i = t.fontSize * t.node.scale.y; if (this._placeholderLabelFont !== e || this._placeholderLabelFontSize !== i || this._placeholderLabelFontColor !== t.fontColor || this._placeholderLabelAlign !== t.horizontalAlign || this._placeholderLineHeight !== t.fontSize) { this._placeholderLabelFont = e, this._placeholderLabelFontSize = i, this._placeholderLabelFontColor = t.fontColor, this._placeholderLabelAlign = t.horizontalAlign, this._placeholderLineHeight = t.fontSize; var n = this._placeholderStyleSheet, r = t.color.toCSS(), s = t.fontSize, a = ""; switch (t.horizontalAlign) { case Zk.HorizontalAlign.LEFT: a = "left"; break; case Zk.HorizontalAlign.CENTER: a = "center"; break; case Zk.HorizontalAlign.RIGHT: a = "right" }n.innerHTML = "#" + this._domId + "::-webkit-input-placeholder{text-transform: initial;-family: " + e + ";font-size: " + i + "px;color: " + r + ";line-height: " + s + "px;text-align: " + a + ";}#" + this._domId + "::-moz-placeholder{text-transform: initial;-family: " + e + ";font-size: " + i + "px;color: " + r + ";line-height: " + s + "px;text-align: " + a + ";}#" + this._domId + "::-ms-input-placeholder{text-transform: initial;-family: " + e + ";font-size: " + i + "px;color: " + r + ";line-height: " + s + "px;text-align: " + a + ";}", tu.browserType === xo.EDGE && (n.innerHTML += "#" + this._domId + "::-ms-clear{display: none;}") } } }, i._registerEventListeners = function () { var t = this; if (this._edTxt) { var e = this._edTxt, i = !1, n = this.__eventListeners; n.compositionStart = function () { i = !0 }, n.compositionEnd = function () { i = !1, t._delegate._editBoxTextChanged(e.value) }, n.onInput = function () { if (!i) { var n = t._delegate, r = n.maxLength; r >= 0 && "number" !== e.type && (e.value = e.value.slice(0, r)), n._editBoxTextChanged(e.value) } }, n.onClick = function () { t._editing && tu.isMobile && t._adjustWindowScroll() }, n.onKeydown = function (i) { 13 === i.keyCode ? (i.propagationStopped = !0, t._delegate._editBoxEditingReturn(), t._isTextArea || e.blur()) : 9 === i.keyCode && (i.propagationStopped = !0, i.preventDefault(), g$.next(t)) }, n.onBlur = function () { tu.isMobile && i && n.compositionEnd(), t._editing = !1, x$ = null, t._hideDom(), t._delegate._editBoxEditingDidEnded() }, e.addEventListener("compositionstart", n.compositionStart), e.addEventListener("compositionend", n.compositionEnd), e.addEventListener("input", n.onInput), e.addEventListener("keydown", n.onKeydown), e.addEventListener("blur", n.onBlur), e.addEventListener("touchstart", n.onClick) } }, i._removeEventListeners = function () { if (this._edTxt) { var t = this._edTxt, e = this.__eventListeners; t.removeEventListener("compositionstart", e.compositionStart), t.removeEventListener("compositionend", e.compositionEnd), t.removeEventListener("input", e.onInput), t.removeEventListener("keydown", e.onKeydown), t.removeEventListener("blur", e.onBlur), t.removeEventListener("touchstart", e.onClick), e.compositionStart = null, e.compositionEnd = null, e.onInput = null, e.onKeydown = null, e.onBlur = null, e.onClick = null } }, e }(m$), I$ = { DEFAULT: 0, DONE: 1, SEND: 2, SEARCH: 3, GO: 4, NEXT: 5 }; Ee(I$); var E$ = { ANY: 0, EMAIL_ADDR: 1, NUMERIC: 2, PHONE_NUMBER: 3, URL: 4, DECIMAL: 5, SINGLE_LINE: 6 }; Ee(E$); var A$, C$, D$, R$, P$, B$, M$, O$, L$, F$, k$, N$, z$, U$, V$, G$, H$, W$, j$, X$, q$, Y$, K$, Q$, Z$, J$, $$, t0, e0, i0 = { PASSWORD: 0, SENSITIVE: 1, INITIAL_CAPS_WORD: 2, INITIAL_CAPS_SENTENCE: 3, INITIAL_CAPS_ALL_CHARACTERS: 4, DEFAULT: 5 }; Ee(i0); var n0, r0, s0, a0, o0, u0, h0, c0, l0, f0, d0, p0, _0, g0, m0, v0, y0, b0, w0, x0, S0, T0, I0, E0, A0, C0, D0, R0, P0 = (A$ = Gu("cc.EditBox"), C$ = Wu(110), D$ = Hu(TF), R$ = Ih(Zk), P$ = Ih(Zk), B$ = Ih(vO), M$ = Ih(i0), O$ = Ih(E$), L$ = Ih(I$), F$ = Ih([rm]), k$ = Ih([rm]), N$ = Ih([rm]), z$ = Ih([rm]), A$(U$ = C$(U$ = D$((e0 = function (t) { function e() { var e; return (e = t.call(this) || this).editingDidBegan = G$ && G$(), e.textChanged = H$ && H$(), e.editingDidEnded = W$ && W$(), e.editingReturn = j$ && j$(), e._impl = null, e._background = null, e._textLabel = X$ && X$(), e._placeholderLabel = q$ && q$(), e._returnType = Y$ && Y$(), e._string = K$ && K$(), e._tabIndex = Q$ && Q$(), e._backgroundImage = Z$ && Z$(), e._inputFlag = J$ && J$(), e._inputMode = $$ && $$(), e._maxLength = t0 && t0(), e._isLabelVisible = !1, e } s(e, t); var i = e.prototype; return i.__preload = function () { this._init() }, i.onEnable = function () { this._registerEvent(), this._ensureBackgroundSprite(), this._impl && this._impl.onEnable() }, i._beforeDraw = function () { this._impl && this._impl.beforeDraw() }, i.onDisable = function () { this._unregisterEvent(), this._unregisterBackgroundEvent(), this._impl && this._impl.onDisable() }, i.onDestroy = function () { yB.off("director_before_draw", this._beforeDraw, this), this._impl && this._impl.clear() }, i.setFocus = function () { this._impl && this._impl.setFocus(!0) }, i.focus = function () { this._impl && this._impl.setFocus(!0) }, i.blur = function () { this._impl && this._impl.setFocus(!1) }, i.isFocused = function () { return !!this._impl && this._impl.isFocused() }, i._editBoxEditingDidBegan = function () { rm.emitEvents(this.editingDidBegan, this), this.node.emit("editing-did-began", this) }, i._editBoxEditingDidEnded = function (t) { rm.emitEvents(this.editingDidEnded, this), this.node.emit("editing-did-ended", this, t) }, i._editBoxTextChanged = function (t) { t = this._updateLabelStringStyle(t, !0), this.string = t, rm.emitEvents(this.textChanged, t, this), this.node.emit("text-changed", this) }, i._editBoxEditingReturn = function (t) { rm.emitEvents(this.editingReturn, this), this.node.emit("editing-return", this, t) }, i._showLabels = function () { this._isLabelVisible = !0, this._updateLabels() }, i._hideLabels = function () { this._isLabelVisible = !1, this._textLabel && (this._textLabel.node.active = !1), this._placeholderLabel && (this._placeholderLabel.node.active = !1) }, i._onTouchBegan = function (t) { t.propagationStopped = !0 }, i._onTouchCancel = function (t) { t.propagationStopped = !0 }, i._onTouchEnded = function (t) { this._impl && this._impl.beginEditing(), t.propagationStopped = !0 }, i._init = function () { this._updatePlaceholderLabel(), this._updateTextLabel(), this._isLabelVisible = !0, this.node.on("size-changed", this._resizeChildNodes, this), yB.on("director_before_draw", this._beforeDraw, this), (this._impl = new e._EditBoxImpl).init(this), this._updateString(this._string), this._syncSize() }, i._ensureBackgroundSprite = function () { if (!this._background) { var t = this.node.getComponent(iN); t || (t = this.node.addComponent(iN)), t !== this._background && (t.type = iN.Type.SLICED, t.spriteFrame = this._backgroundImage, this._background = t, this._registerBackgroundEvent()) } }, i._updateTextLabel = function () { var t = this._textLabel; if (!t) { var e = this.node.getChildByName("TEXT_LABEL"); e || ((e = new ky("TEXT_LABEL")).layer = this.node.layer), (t = e.getComponent(Zk)) || (t = e.addComponent(Zk)), e.parent = this.node, this._textLabel = t } 0 === this._inputMode ? (t.verticalAlign = 0, t.enableWrapText = !0) : t.enableWrapText = !1, t.string = this._updateLabelStringStyle(this._string) }, i._updatePlaceholderLabel = function () { var t = this._placeholderLabel; if (!t) { var e = this.node.getChildByName("PLACEHOLDER_LABEL"); e || ((e = new ky("PLACEHOLDER_LABEL")).layer = this.node.layer), (t = e.getComponent(Zk)) || (t = e.addComponent(Zk)), e.parent = this.node, this._placeholderLabel = t } 0 === this._inputMode ? t.enableWrapText = !0 : t.enableWrapText = !1, t.string = this.placeholder }, i._syncSize = function () { var t = this.node._getUITransformComp(), e = t.contentSize; if (this._background) { var i = this._background.node._getUITransformComp(); i.anchorPoint = t.anchorPoint, i.setContentSize(e) } this._updateLabelPosition(e), this._impl && this._impl.setSize(e.width, e.height) }, i._updateLabels = function () { if (this._isLabelVisible) { var t = this._string; this._textLabel && (this._textLabel.node.active = "" !== t), this._placeholderLabel && (this._placeholderLabel.node.active = "" === t) } }, i._updateString = function (t) { var e = this._textLabel; if (e) { var i = t; i && (i = this._updateLabelStringStyle(i)), e.string = i, this._updateLabels() } }, i._updateLabelStringStyle = function (t, e) { void 0 === e && (e = !1); var i, n = this._inputFlag; if (e || 0 !== n) 4 === n ? t = t.toUpperCase() : 2 === n ? t = t.replace(/(?:^|\s)\S/g, (function (t) { return t.toUpperCase() })) : 3 === n && (t = (i = t).charAt(0).toUpperCase() + i.slice(1)); else { for (var r = "", s = t.length, a = 0; a < s; ++a)r += "●"; t = r } return t }, i._registerEvent = function () { var t = this, e = t.node; e.on("touch-start", t._onTouchBegan, t), e.on("touch-end", t._onTouchEnded, t) }, i._unregisterEvent = function () { var t = this, e = t.node; e.off("touch-start", t._onTouchBegan, t), e.off("touch-end", t._onTouchEnded, t) }, i._onBackgroundSpriteFrameChanged = function () { this._background && (this.backgroundImage = this._background.spriteFrame) }, i._registerBackgroundEvent = function () { var t = this._background && this._background.node; null == t || t.on("spriteframe-changed", this._onBackgroundSpriteFrameChanged, this) }, i._unregisterBackgroundEvent = function () { var t = this._background && this._background.node; null == t || t.off("spriteframe-changed", this._onBackgroundSpriteFrameChanged, this) }, i._updateLabelPosition = function (t) { var e = this.node._getUITransformComp(), i = -e.anchorX * e.width, n = -e.anchorY * e.height, r = this._placeholderLabel, s = this._textLabel; s && (s.node._getUITransformComp().setContentSize(t.width - 2, t.height), s.node.setPosition(i + 2, n + t.height, s.node.position.z), 0 === this._inputMode && (s.verticalAlign = 0), s.enableWrapText = 0 === this._inputMode), r && (r.node._getUITransformComp().setContentSize(t.width - 2, t.height), r.node.setPosition(i + 2, n + t.height, r.node.position.z), r.enableWrapText = 0 === this._inputMode) }, i._resizeChildNodes = function () { var t = this.node._getUITransformComp(), e = this._textLabel && this._textLabel.node; e && (e.setPosition(-t.width / 2, t.height / 2, e.position.z), e._getUITransformComp().setContentSize(t.contentSize)); var i = this._placeholderLabel && this._placeholderLabel.node; i && (i.setPosition(-t.width / 2, t.height / 2, i.position.z), i._getUITransformComp().setContentSize(t.contentSize)); var n = this._background && this._background.node; n && n._getUITransformComp().setContentSize(t.contentSize), this._syncSize() }, i._xrUnClick = function () { }, i._xrKeyBoardInput = function () { }, n(e, [{ key: "string", get: function () { return this._string }, set: function (t) { this._maxLength >= 0 && t.length >= this._maxLength && (t = t.slice(0, this._maxLength)), this._string !== t && (this._string = t, this._updateString(t)) } }, { key: "placeholder", get: function () { return this._placeholderLabel ? this._placeholderLabel.string : "" }, set: function (t) { this._placeholderLabel && (this._placeholderLabel.string = t) } }, { key: "textLabel", get: function () { return this._textLabel }, set: function (t) { this._textLabel !== t && (this._textLabel = t, this._textLabel && (this._updateTextLabel(), this._updateLabels())) } }, { key: "placeholderLabel", get: function () { return this._placeholderLabel }, set: function (t) { this._placeholderLabel !== t && (this._placeholderLabel = t, this._placeholderLabel && (this._updatePlaceholderLabel(), this._updateLabels())) } }, { key: "backgroundImage", get: function () { return this._backgroundImage }, set: function (t) { this._backgroundImage !== t && (this._backgroundImage = t, this._ensureBackgroundSprite(), this._background.spriteFrame = t) } }, { key: "inputFlag", get: function () { return this._inputFlag }, set: function (t) { this._inputFlag !== t && (this._inputFlag = t, this._updateString(this._string)) } }, { key: "inputMode", get: function () { return this._inputMode }, set: function (t) { this._inputMode !== t && (this._inputMode = t, this._updateTextLabel(), this._updatePlaceholderLabel()) } }, { key: "returnType", get: function () { return this._returnType }, set: function (t) { this._returnType = t } }, { key: "maxLength", get: function () { return this._maxLength }, set: function (t) { this._maxLength = t } }, { key: "tabIndex", get: function () { return this._tabIndex }, set: function (t) { this._tabIndex !== t && (this._tabIndex = t, this._impl && this._impl.setTabIndex(t)) } }]), e }(am), e0._EditBoxImpl = m$, e0.KeyboardReturnType = I$, e0.InputFlag = i0, e0.InputMode = E$, e0.EventType = { EDITING_DID_BEGAN: "editing-did-began", EDITING_DID_ENDED: "editing-did-ended", TEXT_CHANGED: "text-changed", EDITING_RETURN: "editing-return", XR_EDITING_DID_BEGAN: "xr-editing-did-began", XR_EDITING_DID_ENDED: "xr-editing-did-ended" }, m((V$ = e0).prototype, "textLabel", [R$], Object.getOwnPropertyDescriptor(V$.prototype, "textLabel"), V$.prototype), m(V$.prototype, "placeholderLabel", [P$], Object.getOwnPropertyDescriptor(V$.prototype, "placeholderLabel"), V$.prototype), m(V$.prototype, "backgroundImage", [B$], Object.getOwnPropertyDescriptor(V$.prototype, "backgroundImage"), V$.prototype), m(V$.prototype, "inputFlag", [M$], Object.getOwnPropertyDescriptor(V$.prototype, "inputFlag"), V$.prototype), m(V$.prototype, "inputMode", [O$], Object.getOwnPropertyDescriptor(V$.prototype, "inputMode"), V$.prototype), m(V$.prototype, "returnType", [L$], Object.getOwnPropertyDescriptor(V$.prototype, "returnType"), V$.prototype), G$ = Bu(V$.prototype, "editingDidBegan", [F$, eh], (function () { return [] })), H$ = Bu(V$.prototype, "textChanged", [k$, eh], (function () { return [] })), W$ = Bu(V$.prototype, "editingDidEnded", [N$, eh], (function () { return [] })), j$ = Bu(V$.prototype, "editingReturn", [z$, eh], (function () { return [] })), X$ = Bu(V$.prototype, "_textLabel", [eh], (function () { return null })), q$ = Bu(V$.prototype, "_placeholderLabel", [eh], (function () { return null })), Y$ = Bu(V$.prototype, "_returnType", [eh], (function () { return 0 })), K$ = Bu(V$.prototype, "_string", [eh], (function () { return "" })), Q$ = Bu(V$.prototype, "_tabIndex", [eh], (function () { return 0 })), Z$ = Bu(V$.prototype, "_backgroundImage", [eh], (function () { return null })), J$ = Bu(V$.prototype, "_inputFlag", [eh], (function () { return 5 })), $$ = Bu(V$.prototype, "_inputMode", [eh], (function () { return 0 })), t0 = Bu(V$.prototype, "_maxLength", [eh], (function () { return 20 })), U$ = V$)) || U$) || U$) || U$); t({ EditBox: P0, EditBoxComponent: P0 }), "object" == typeof window && "object" == typeof document && (P0._EditBoxImpl = T$), T.internal.EditBox = P0; var B0 = { NONE: 0, HORIZONTAL: 1, VERTICAL: 2, GRID: 3 }; De(B0); var M0 = { NONE: 0, CONTAINER: 1, CHILDREN: 2 }; De(M0); var O0 = { HORIZONTAL: 0, VERTICAL: 1 }; De(O0); var L0 = { BOTTOM_TO_TOP: 0, TOP_TO_BOTTOM: 1 }; De(L0); var F0 = { LEFT_TO_RIGHT: 0, RIGHT_TO_LEFT: 1 }; De(F0); var k0 = { NONE: 0, FIXED_ROW: 1, FIXED_COL: 2 }; De(k0); var N0, z0, U0, V0, G0, H0, W0, j0, X0, q0, Y0, K0, Q0, Z0 = new Kn, J0 = (n0 = Gu("cc.Layout"), r0 = Wu(110), s0 = Hu(TF), a0 = Ih(B0), o0 = Ih(M0), u0 = Ih(O0), h0 = Ih(L0), c0 = Ih(F0), l0 = Ih(k0), n0(f0 = r0(f0 = s0((R0 = function (t) { function e() { var e; return (e = t.call(this) || this)._resizeMode = p0 && p0(), e._layoutType = _0 && _0(), e._cellSize = g0 && g0(), e._startAxis = m0 && m0(), e._paddingLeft = v0 && v0(), e._paddingRight = y0 && y0(), e._paddingTop = b0 && b0(), e._paddingBottom = w0 && w0(), e._spacingX = x0 && x0(), e._spacingY = S0 && S0(), e._verticalDirection = T0 && T0(), e._horizontalDirection = I0 && I0(), e._constraint = E0 && E0(), e._constraintNum = A0 && A0(), e._affectedByScale = C0 && C0(), e._isAlign = D0 && D0(), e._layoutSize = new us(300, 200), e._layoutDirty = !0, e._childrenDirty = !1, e._usefulLayoutObj = [], e._init = !1, e } s(e, t); var i = e.prototype; return i.updateLayout = function (t) { void 0 === t && (t = !1), (this._layoutDirty || t) && (this._doLayout(), this._layoutDirty = !1) }, i.onEnable = function () { this._addEventListeners(); var t = this.node._getUITransformComp(); t.contentSize.equals(us.ZERO) && t.setContentSize(this._layoutSize), this._childrenChanged() }, i.onDisable = function () { this._usefulLayoutObj.length = 0, this._removeEventListeners() }, i._checkUsefulObj = function () { this._usefulLayoutObj.length = 0; for (var t = this.node.children, e = 0; e < t.length; ++e) { var i = t[e], n = i._getUITransformComp(); i.activeInHierarchy && n && this._usefulLayoutObj.push(n) } }, i._addEventListeners = function () { yB.on("director_after_update", this.updateLayout, this), this.node.on("size-changed", this._resized, this), this.node.on("anchor-changed", this._doLayoutDirty, this), this.node.on("child-added", this._childAdded, this), this.node.on("child-removed", this._childRemoved, this), this.node.on("sibling-order-changed", this._childrenChanged, this), this.node.on("childrenSiblingOrderChanged", this.updateLayout, this), this._addChildrenEventListeners() }, i._removeEventListeners = function () { yB.off("director_after_update", this.updateLayout, this), this.node.off("size-changed", this._resized, this), this.node.off("anchor-changed", this._doLayoutDirty, this), this.node.off("child-added", this._childAdded, this), this.node.off("child-removed", this._childRemoved, this), this.node.off("sibling-order-changed", this._childrenChanged, this), this.node.off("childrenSiblingOrderChanged", this.updateLayout, this), this._removeChildrenEventListeners() }, i._addChildrenEventListeners = function () { for (var t = this.node.children, e = 0; e < t.length; ++e) { var i = t[e]; i.on("size-changed", this._doLayoutDirty, this), i.on("transform-changed", this._transformDirty, this), i.on("anchor-changed", this._doLayoutDirty, this), i.on("active-in-hierarchy-changed", this._childrenChanged, this) } }, i._removeChildrenEventListeners = function () { for (var t = this.node.children, e = 0; e < t.length; ++e) { var i = t[e]; i.off("size-changed", this._doLayoutDirty, this), i.off("transform-changed", this._transformDirty, this), i.off("anchor-changed", this._doLayoutDirty, this), i.off("active-in-hierarchy-changed", this._childrenChanged, this) } }, i._childAdded = function (t) { t.on("size-changed", this._doLayoutDirty, this), t.on("transform-changed", this._transformDirty, this), t.on("anchor-changed", this._doLayoutDirty, this), t.on("active-in-hierarchy-changed", this._childrenChanged, this), this._childrenChanged() }, i._childRemoved = function (t) { t.off("size-changed", this._doLayoutDirty, this), t.off("transform-changed", this._transformDirty, this), t.off("anchor-changed", this._doLayoutDirty, this), t.off("active-in-hierarchy-changed", this._childrenChanged, this), this._childrenChanged() }, i._resized = function () { this._layoutSize.set(this.node._getUITransformComp().contentSize), this._doLayoutDirty() }, i._doLayoutHorizontally = function (t, e, i, n) { var r = this.node._getUITransformComp().anchorPoint, s = this._getFixedBreakingNum(), a = 1, o = this._paddingLeft; 1 === this._horizontalDirection && (a = -1, o = this._paddingRight); var u = (this._horizontalDirection - r.x) * t + a * o, h = u - a * this._spacingX, c = 0, l = 0, f = 0, d = 0, p = !1, _ = this._usefulLayoutObj.length, g = this._cellSize.width, m = this._getPaddingH(); 3 !== this._layoutType && 2 === this._resizeMode && (g = (t - m - (_ - 1) * this._spacingX) / _); for (var v = this._usefulLayoutObj, y = 0; y < v.length; ++y) { var b = v[y], w = b.node, x = w.scale, S = this._getUsedScaleValue(x.x), T = this._getUsedScaleValue(x.y); 2 === this._resizeMode && (b.width = g / S, 3 === this._layoutType && (b.height = this._cellSize.height / T)); var I = Math.abs(this._horizontalDirection - b.anchorX), E = b.width * S, A = b.height * T; A > f && (d = Math.max(f, d), l = f || A, f = A), h += a * (I * E + this._spacingX); var C = a * (1 - I) * E; if (e) { if (s > 0) (p = y / s > 0 && y % s == 0) && (l = f > A ? f : l); else if (E > t - m) h > u + a * I * E && (p = !0); else { var D = (1 - this._horizontalDirection - r.x) * t, R = h + C + a * (a > 0 ? this._paddingRight : this._paddingLeft); p = Math.abs(R) > Math.abs(D) } p && (h = u + a * I * E, A !== f && (l = f), c += l + this._spacingY, l = f = A) } var P = i(w, b, c); n && w.setPosition(h, P), h += C } return l = Math.max(l, f), Math.max(d, c + l) + this._getPaddingV() }, i._doLayoutVertically = function (t, e, i, n) { var r = this.node._getUITransformComp().anchorPoint, s = this._getFixedBreakingNum(), a = 1, o = this._paddingBottom; 1 === this._verticalDirection && (a = -1, o = this._paddingTop); var u = (this._verticalDirection - r.y) * t + a * o, h = u - a * this._spacingY, c = 0, l = 0, f = 0, d = 0, p = !1, _ = this._usefulLayoutObj.length, g = this._cellSize.height, m = this._getPaddingV(); 3 !== this._layoutType && 2 === this._resizeMode && (g = (t - m - (_ - 1) * this._spacingY) / _); for (var v = this._usefulLayoutObj, y = 0; y < v.length; ++y) { var b = v[y], w = b.node, x = w.scale, S = this._getUsedScaleValue(x.x), T = this._getUsedScaleValue(x.y); 2 === this._resizeMode && (b.height = g / T, 3 === this._layoutType && (b.width = this._cellSize.width / S)); var I = Math.abs(this._verticalDirection - b.anchorY), E = b.width * S, A = b.height * T; E > c && (l = Math.max(c, l), f = c || E, c = E), h += a * (I * A + this._spacingY); var C = a * (1 - I) * A; if (e) { if (s > 0) (p = y / s > 0 && y % s == 0) && (f = c > A ? c : f); else if (A > t - m) h > u + a * I * A && (p = !0); else { var D = (1 - this._verticalDirection - r.y) * t, R = h + C + a * (a > 0 ? this._paddingTop : this._paddingBottom); p = Math.abs(R) > Math.abs(D) } p && (h = u + a * I * A, E !== c && (f = c), d += f + this._spacingX, f = c = E) } var P = i(w, b, d); n && (w.getPosition(Z0), w.setPosition(P, h, Z0.z)), h += C } return f = Math.max(f, c), Math.max(l, d + f) + this._getPaddingH() }, i._doLayoutGridAxisHorizontal = function (t, e) { var i = this, n = e.width, r = 1, s = -t.y * e.height, a = this._paddingBottom; 1 === this._verticalDirection && (r = -1, s = (1 - t.y) * e.height, a = this._paddingTop); var o = function (t, e, n) { return s + r * (n + (1 - e.anchorY) * e.height * i._getUsedScaleValue(t.scale.y) + a) }, u = 0; 1 === this._resizeMode && (u = this._doLayoutHorizontally(n, !0, o, !1), s = -t.y * u, 1 === this._verticalDirection && (r = -1, s = (1 - t.y) * u)), this._doLayoutHorizontally(n, !0, o, !0), 1 === this._resizeMode && this.node._getUITransformComp().setContentSize(n, u) }, i._doLayoutGridAxisVertical = function (t, e) { var i = this, n = e.height, r = 1, s = -t.x * e.width, a = this._paddingLeft; 1 === this._horizontalDirection && (r = -1, s = (1 - t.x) * e.width, a = this._paddingRight); var o = function (t, e, n) { return s + r * (n + (1 - e.anchorX) * e.width * i._getUsedScaleValue(t.scale.x) + a) }, u = 0; 1 === this._resizeMode && (u = this._doLayoutVertically(n, !0, o, !1), s = -t.x * u, 1 === this._horizontalDirection && (r = -1, s = (1 - t.x) * u)), this._doLayoutVertically(n, !0, o, !0), 1 === this._resizeMode && this.node._getUITransformComp().setContentSize(u, n) }, i._doLayoutGrid = function () { var t = this.node._getUITransformComp(), e = t.anchorPoint, i = t.contentSize; 0 === this.startAxis ? this._doLayoutGridAxisHorizontal(e, i) : 1 === this.startAxis && this._doLayoutGridAxisVertical(e, i) }, i._getHorizontalBaseWidth = function () { var t = this._usefulLayoutObj, e = 0, i = t.length; if (1 === this._resizeMode) { for (var n = 0; n < t.length; ++n) { var r = t[n], s = r.node.scale; e += r.width * this._getUsedScaleValue(s.x) } e += (i - 1) * this._spacingX + this._getPaddingH() } else e = this.node._getUITransformComp().width; return e }, i._getVerticalBaseHeight = function () { var t = this._usefulLayoutObj, e = 0, i = t.length; if (1 === this._resizeMode) { for (var n = 0; n < t.length; ++n) { var r = t[n], s = r.node.scale; e += r.height * this._getUsedScaleValue(s.y) } e += (i - 1) * this._spacingY + this._getPaddingV() } else e = this.node._getUITransformComp().height; return e }, i._doLayout = function () { var t = this; if (this._init && !this._childrenDirty || (this._checkUsefulObj(), this._init = !0, this._childrenDirty = !1), 1 === this._layoutType) { var e = this._getHorizontalBaseWidth(); this._doLayoutHorizontally(e, !1, (function (e) { return (t._isAlign ? Kn.ZERO : e.position).y }), !0), this.node._getUITransformComp().width = e } else if (2 === this._layoutType) { var i = this._getVerticalBaseHeight(); this._doLayoutVertically(i, !1, (function (e) { return (t._isAlign ? Kn.ZERO : e.position).x }), !0), this.node._getUITransformComp().height = i } else 3 === this._layoutType && this._doLayoutGrid() }, i._getUsedScaleValue = function (t) { return this._affectedByScale ? Math.abs(t) : 1 }, i._transformDirty = function (t) { 4 & t && 1 & t && this._affectedByScale && this._doLayoutDirty() }, i._doLayoutDirty = function () { this._layoutDirty = !0 }, i._childrenChanged = function () { this._childrenDirty = !0, this._doLayoutDirty() }, i._getPaddingH = function () { return this._paddingLeft + this._paddingRight }, i._getPaddingV = function () { return this._paddingTop + this._paddingBottom }, i._getFixedBreakingNum = function () { if (3 !== this._layoutType || 0 === this._constraint || this._constraintNum <= 0) return 0; var t = 1 === this._constraint ? Math.ceil(this._usefulLayoutObj.length / this._constraintNum) : this._constraintNum; return 1 === this._startAxis && (t = 2 === this._constraint ? Math.ceil(this._usefulLayoutObj.length / this._constraintNum) : this._constraintNum), t }, n(e, [{ key: "alignHorizontal", get: function () { return this._isAlign }, set: function (t) { 1 === this._layoutType && (this._isAlign = t, this._doLayoutDirty()) } }, { key: "alignVertical", get: function () { return this._isAlign }, set: function (t) { 2 === this._layoutType && (this._isAlign = t, this._doLayoutDirty()) } }, { key: "type", get: function () { return this._layoutType }, set: function (t) { this._layoutType = t, this._doLayoutDirty() } }, { key: "resizeMode", get: function () { return this._resizeMode }, set: function (t) { 0 !== this._layoutType && (this._resizeMode = t, this._doLayoutDirty()) } }, { key: "cellSize", get: function () { return this._cellSize }, set: function (t) { this._cellSize !== t && (this._cellSize.set(t), this._doLayoutDirty()) } }, { key: "startAxis", get: function () { return this._startAxis }, set: function (t) { this._startAxis !== t && (this._startAxis = t, this._doLayoutDirty()) } }, { key: "paddingLeft", get: function () { return this._paddingLeft }, set: function (t) { this._paddingLeft !== t && (this._paddingLeft = t, this._doLayoutDirty()) } }, { key: "paddingRight", get: function () { return this._paddingRight }, set: function (t) { this._paddingRight !== t && (this._paddingRight = t, this._doLayoutDirty()) } }, { key: "paddingTop", get: function () { return this._paddingTop }, set: function (t) { this._paddingTop !== t && (this._paddingTop = t, this._doLayoutDirty()) } }, { key: "paddingBottom", get: function () { return this._paddingBottom }, set: function (t) { this._paddingBottom !== t && (this._paddingBottom = t, this._doLayoutDirty()) } }, { key: "spacingX", get: function () { return this._spacingX }, set: function (t) { this._spacingX !== t && (this._spacingX = t, this._doLayoutDirty()) } }, { key: "spacingY", get: function () { return this._spacingY }, set: function (t) { this._spacingY !== t && (this._spacingY = t, this._doLayoutDirty()) } }, { key: "verticalDirection", get: function () { return this._verticalDirection }, set: function (t) { this._verticalDirection !== t && (this._verticalDirection = t, this._doLayoutDirty()) } }, { key: "horizontalDirection", get: function () { return this._horizontalDirection }, set: function (t) { this._horizontalDirection !== t && (this._horizontalDirection = t, this._doLayoutDirty()) } }, { key: "padding", get: function () { return this._paddingLeft }, set: function (t) { this.paddingLeft === t && this._paddingRight === t && this._paddingTop === t && this._paddingBottom === t || (this._paddingLeft = this._paddingRight = this._paddingTop = this._paddingBottom = t, this._doLayoutDirty()) } }, { key: "constraint", get: function () { return this._constraint }, set: function (t) { 0 !== this._layoutType && this._constraint !== t && (this._constraint = t, this._doLayoutDirty()) } }, { key: "constraintNum", get: function () { return this._constraintNum }, set: function (t) { 0 !== this._constraint && this._constraintNum !== t && (t <= 0 && it(16400), this._constraintNum = t, this._doLayoutDirty()) } }, { key: "affectedByScale", get: function () { return this._affectedByScale }, set: function (t) { this._affectedByScale = t, this._doLayoutDirty() } }]), e }(am), R0.Type = B0, R0.VerticalDirection = L0, R0.HorizontalDirection = F0, R0.ResizeMode = M0, R0.AxisDirection = O0, R0.Constraint = k0, m((d0 = R0).prototype, "type", [a0], Object.getOwnPropertyDescriptor(d0.prototype, "type"), d0.prototype), m(d0.prototype, "resizeMode", [o0], Object.getOwnPropertyDescriptor(d0.prototype, "resizeMode"), d0.prototype), m(d0.prototype, "startAxis", [u0], Object.getOwnPropertyDescriptor(d0.prototype, "startAxis"), d0.prototype), m(d0.prototype, "verticalDirection", [h0], Object.getOwnPropertyDescriptor(d0.prototype, "verticalDirection"), d0.prototype), m(d0.prototype, "horizontalDirection", [c0], Object.getOwnPropertyDescriptor(d0.prototype, "horizontalDirection"), d0.prototype), m(d0.prototype, "constraint", [l0], Object.getOwnPropertyDescriptor(d0.prototype, "constraint"), d0.prototype), p0 = Bu(d0.prototype, "_resizeMode", [eh], (function () { return 0 })), _0 = Bu(d0.prototype, "_layoutType", [eh], (function () { return 0 })), g0 = Bu(d0.prototype, "_cellSize", [eh], (function () { return new us(40, 40) })), m0 = Bu(d0.prototype, "_startAxis", [eh], (function () { return 0 })), v0 = Bu(d0.prototype, "_paddingLeft", [eh], (function () { return 0 })), y0 = Bu(d0.prototype, "_paddingRight", [eh], (function () { return 0 })), b0 = Bu(d0.prototype, "_paddingTop", [eh], (function () { return 0 })), w0 = Bu(d0.prototype, "_paddingBottom", [eh], (function () { return 0 })), x0 = Bu(d0.prototype, "_spacingX", [eh], (function () { return 0 })), S0 = Bu(d0.prototype, "_spacingY", [eh], (function () { return 0 })), T0 = Bu(d0.prototype, "_verticalDirection", [eh], (function () { return 1 })), I0 = Bu(d0.prototype, "_horizontalDirection", [eh], (function () { return 0 })), E0 = Bu(d0.prototype, "_constraint", [eh], (function () { return 0 })), A0 = Bu(d0.prototype, "_constraintNum", [eh], (function () { return 2 })), C0 = Bu(d0.prototype, "_affectedByScale", [eh], (function () { return !1 })), D0 = Bu(d0.prototype, "_isAlign", [eh], (function () { return !1 })), f0 = d0)) || f0) || f0) || f0); t({ Layout: J0, LayoutComponent: J0 }), T.Layout = J0; var $0 = { HORIZONTAL: 0, VERTICAL: 1, FILLED: 2 }; Ee($0); var t1, e1, i1, n1, r1, s1, a1, o1, u1, h1, c1, l1, f1, d1 = (N0 = Gu("cc.ProgressBar"), z0 = Wu(110), U0 = Hu(TF), V0 = Ih(iN), G0 = Ih($0), N0(H0 = z0(H0 = U0((Q0 = function (t) { function e() { var e; return (e = t.call(this) || this)._barSprite = j0 && j0(), e._mode = X0 && X0(), e._totalLength = q0 && q0(), e._progress = Y0 && Y0(), e._reverse = K0 && K0(), e } s(e, t); var i = e.prototype; return i.onLoad = function () { this._updateBarStatus() }, i._initBarSprite = function () { if (this._barSprite) { var t = this._barSprite.node; if (!t) return; var e = this.node._getUITransformComp(), i = e.contentSize, n = e.anchorPoint, r = t._getUITransformComp().contentSize; if (2 === this._barSprite.fillType && (this._mode = 2), 0 === this._mode ? this.totalLength = r.width : 1 === this._mode ? this.totalLength = r.height : this.totalLength = this._barSprite.fillRange, t.parent === this.node) { var s = -i.width * n.x; t.setPosition(s, 0, 0) } } }, i._updateBarStatus = function () { if (this._barSprite) { var t = this._barSprite.node; if (!t) return; var e = t._getUITransformComp(), i = e.anchorPoint, n = e.contentSize, r = new as(0, .5), s = qi(this._progress), a = this._totalLength * s, o = n, u = 0, h = 0; switch (this._mode) { case 0: this._reverse && (r = new as(1, .5)), o = new us(a, n.height), u = this._totalLength, h = n.height; break; case 1: r = this._reverse ? new as(.5, 1) : new as(.5, 0), o = new us(n.width, a), u = n.width, h = this._totalLength }if (2 === this._mode) this._barSprite.type !== iN.Type.FILLED ? it(16397) : (this._reverse && (a *= -1), this._barSprite.fillRange = a); else if (this._barSprite.type !== iN.Type.FILLED) { var c = r.x - i.x, l = r.y - i.y, f = new Kn(t.position); f.add3f(u * c, h * l, 0), t.setPosition(f), e.setAnchorPoint(r), e.setContentSize(o) } else it(16398) } }, n(e, [{ key: "barSprite", get: function () { return this._barSprite }, set: function (t) { this._barSprite !== t && (this._barSprite = t, this._initBarSprite()) } }, { key: "mode", get: function () { return this._mode }, set: function (t) { if (this._mode !== t && (this._mode = t, this._barSprite)) { var e = this._barSprite.node; if (!e) return; var i = e._getUITransformComp().contentSize; 0 === this._mode ? this.totalLength = i.width : 1 === this._mode ? this.totalLength = i.height : 2 === this._mode && (this.totalLength = this._barSprite.fillRange) } } }, { key: "totalLength", get: function () { return this._totalLength }, set: function (t) { 2 === this._mode && (t = qi(t)), this._totalLength !== t && (this._totalLength = t, this._updateBarStatus()) } }, { key: "progress", get: function () { return this._progress }, set: function (t) { this._progress !== t && (this._progress = t, this._updateBarStatus()) } }, { key: "reverse", get: function () { return this._reverse }, set: function (t) { this._reverse !== t && (this._reverse = t, this._barSprite && (this._barSprite.fillStart = 1 - this._barSprite.fillStart), this._updateBarStatus()) } }]), e }(am), Q0.Mode = $0, m((W0 = Q0).prototype, "barSprite", [V0], Object.getOwnPropertyDescriptor(W0.prototype, "barSprite"), W0.prototype), m(W0.prototype, "mode", [G0], Object.getOwnPropertyDescriptor(W0.prototype, "mode"), W0.prototype), j0 = Bu(W0.prototype, "_barSprite", [eh], (function () { return null })), X0 = Bu(W0.prototype, "_mode", [eh], (function () { return 0 })), q0 = Bu(W0.prototype, "_totalLength", [eh], (function () { return 1 })), Y0 = Bu(W0.prototype, "_progress", [eh], (function () { return .1 })), K0 = Bu(W0.prototype, "_reverse", [eh], (function () { return !1 })), H0 = W0)) || H0) || H0) || H0); t({ ProgressBar: d1, ProgressBarComponent: d1 }), T.ProgressBar = d1; var p1 = new Kn, _1 = new Kn, g1 = new Kn, m1 = new as, v1 = new rr, y1 = new as, b1 = { HORIZONTAL: 0, VERTICAL: 1 }; De(b1); var w1, x1 = (t1 = Gu("cc.ScrollBar"), e1 = Wu(110), i1 = Hu(TF), n1 = Ih(iN), r1 = Ih(b1), t1(s1 = e1(s1 = i1((f1 = function (t) { function e() { var e; return (e = t.call(this) || this)._scrollView = o1 && o1(), e._handle = u1 && u1(), e._direction = h1 && h1(), e._enableAutoHide = c1 && c1(), e._autoHideTime = l1 && l1(), e._touching = !1, e._opacity = 255, e._autoHideRemainingTime = 0, e } s(e, t); var i = e.prototype; return i.hide = function () { this._autoHideRemainingTime = 0, this._setOpacity(0) }, i.show = function () { this._autoHideRemainingTime = this._autoHideTime, this._opacity = 255, this._setOpacity(this._opacity) }, i.onScroll = function (t) { if (this._scrollView) { var e = this._scrollView.content; if (e) { var i = e._getUITransformComp().contentSize, n = this._scrollView.node._getUITransformComp().contentSize, r = this.node._getUITransformComp().contentSize; if (!this._conditionalDisableScrollBar(i, n)) { this._enableAutoHide && (this._autoHideRemainingTime = this._autoHideTime, this._setOpacity(this._opacity)); var s = 0, a = 0, o = 0, u = 0, h = 0, c = y1; c.set(0, 0), 0 === this._direction ? (s = i.width, a = n.width, h = r.width, o = t.x, this._convertToScrollViewSpace(c, e), u = -c.x) : 1 === this._direction && (s = i.height, a = n.height, h = r.height, o = t.y, this._convertToScrollViewSpace(c, e), u = -c.y); var l = this._calculateLength(s, a, h, o), f = y1; this._calculatePosition(f, s, a, h, u, o, l), this._updateLength(l), this._updateHandlerPosition(f) } } } }, i.setScrollView = function (t) { this._scrollView = t }, i.onTouchBegan = function () { this._enableAutoHide && (this._touching = !0) }, i.onTouchEnded = function () { if (this._enableAutoHide && (this._touching = !1, !(this._autoHideTime <= 0))) { if (this._scrollView) { var t = this._scrollView.content; if (t) { var e = t._getUITransformComp().contentSize, i = this._scrollView.node._getUITransformComp().contentSize; if (this._conditionalDisableScrollBar(e, i)) return } } this._autoHideRemainingTime = this._autoHideTime } }, i.onEnable = function () { var t = this.node.getComponent(iN); t && (this._opacity = t.color.a) }, i.start = function () { this._enableAutoHide && this._setOpacity(0) }, i.update = function (t) { this._processAutoHide(t) }, i._convertToScrollViewSpace = function (t, e) { var i = this._scrollView && this._scrollView.node._getUITransformComp(), n = e._getUITransformComp(); if (i && n) { p1.set(-n.anchorX * n.width, -n.anchorY * n.height, 0), n.convertToWorldSpaceAR(p1, _1); var r = i.convertToNodeSpaceAR(_1); r.x += i.anchorX * i.width, r.y += i.anchorY * i.height, t.set(r.x, r.y) } else t.set(as.ZERO) }, i._setOpacity = function (t) { if (this._handle) { var e = this.node.getComponent(iN); e && (v1.set(e.color), v1.a = t, e.color = v1), (e = this._handle.getComponent(iN)) && (v1.set(e.color), v1.a = t, e.color = v1) } }, i._updateHandlerPosition = function (t) { if (this._handle) { var e = g1; this._fixupHandlerPosition(e), this._handle.node.setPosition(t.x + e.x, t.y + e.y, e.z) } }, i._fixupHandlerPosition = function (t) { var e = this.node._getUITransformComp(), i = e.contentSize, n = e.anchorPoint, r = this.handle.node._getUITransformComp().contentSize, s = this.handle.node.parent; Kn.set(p1, -i.width * n.x, -i.height * n.y, 0); var a = this.node._getUITransformComp().convertToWorldSpaceAR(p1, _1), o = t; o.set(0, 0, 0), s._getUITransformComp().convertToNodeSpaceAR(a, o), 0 === this.direction ? o.set(o.x, o.y + (i.height - r.height) / 2, o.z) : 1 === this.direction && o.set(o.x + (i.width - r.width) / 2, o.y, o.z), this.handle.node.setPosition(o) }, i._conditionalDisableScrollBar = function (t, e) { return t.width <= e.width && 0 === this._direction || t.height <= e.height && 1 === this._direction }, i._calculateLength = function (t, e, i, n) { var r = t; return n && (r += 20 * (n > 0 ? n : -n)), i * (e / r) }, i._calculatePosition = function (t, e, i, n, r, s, a) { var o = e - i; s && (o += Math.abs(s)); var u = 0; o && (u = qi(u = r / o)); var h = (n - a) * u; 1 === this._direction ? t.set(0, h) : t.set(h, 0) }, i._updateLength = function (t) { if (this._handle) { var e = this._handle.node._getUITransformComp(), i = e.contentSize, n = e.anchorPoint; n.x === m1.x && n.y === m1.y || e.setAnchorPoint(m1), 0 === this._direction ? e.setContentSize(t, i.height) : e.setContentSize(i.width, t) } }, i._processAutoHide = function (t) { if (this._enableAutoHide && !(this._autoHideRemainingTime <= 0) && !this._touching && (this._autoHideRemainingTime -= t, this._autoHideRemainingTime <= this._autoHideTime)) { this._autoHideRemainingTime = Math.max(0, this._autoHideRemainingTime); var e = this._opacity * (this._autoHideRemainingTime / this._autoHideTime); this._setOpacity(e) } }, n(e, [{ key: "handle", get: function () { return this._handle }, set: function (t) { this._handle !== t && (this._handle = t, this.onScroll(as.ZERO)) } }, { key: "direction", get: function () { return this._direction }, set: function (t) { this._direction !== t && (this._direction = t, this.onScroll(as.ZERO)) } }, { key: "enableAutoHide", get: function () { return this._enableAutoHide }, set: function (t) { this._enableAutoHide !== t && (this._enableAutoHide = t, this._enableAutoHide && this._setOpacity(0)) } }, { key: "autoHideTime", get: function () { return this._autoHideTime }, set: function (t) { this._autoHideTime !== t && (this._autoHideTime = t) } }]), e }(am), f1.Direction = b1, m((a1 = f1).prototype, "handle", [n1], Object.getOwnPropertyDescriptor(a1.prototype, "handle"), a1.prototype), m(a1.prototype, "direction", [r1], Object.getOwnPropertyDescriptor(a1.prototype, "direction"), a1.prototype), o1 = Bu(a1.prototype, "_scrollView", [eh], (function () { return null })), u1 = Bu(a1.prototype, "_handle", [eh], (function () { return null })), h1 = Bu(a1.prototype, "_direction", [eh], (function () { return 0 })), c1 = Bu(a1.prototype, "_enableAutoHide", [eh], (function () { return !1 })), l1 = Bu(a1.prototype, "_autoHideTime", [eh], (function () { return 1 })), s1 = a1)) || s1) || s1) || s1); t({ ScrollBar: x1, ScrollBarComponent: x1 }), T.ScrollBar = x1; var S1, T1, I1, E1, A1, C1, D1, R1, P1, B1, M1, O1, L1, F1, k1, N1, z1, U1, V1, G1, H1, W1 = t("ViewGroup", Gu("cc.ViewGroup")(w1 = Wu(110)(w1 = function (t) { function e() { return t.apply(this, arguments) || this } return s(e, t), e }(am)) || w1) || w1); T.ViewGroup = W1; var j1, X1, q1, Y1, K1, Q1, Z1, J1, $1, t2, e2, i2, n2, r2 = 1e-4, s2 = Qn(), a2 = Qn(), o2 = os(), u2 = os(), h2 = function () { return (new Date).getMilliseconds() }, c2 = { "scroll-to-top": 0, "scroll-to-bottom": 1, "scroll-to-left": 2, "scroll-to-right": 3, scrolling: 4, "bounce-bottom": 6, "bounce-left": 7, "bounce-right": 8, "bounce-top": 5, "scroll-ended": 9, "touch-up": 10, "scroll-ended-with-threshold": 11, "scroll-began": 12 }, l2 = { anchor: os(), applyToHorizontal: !1, applyToVertical: !1 }, f2 = function (t, e, i, n) { l2.anchor.set(t, e), l2.applyToHorizontal = i, l2.applyToVertical = n }, d2 = { NONE: "", SCROLL_TO_TOP: "scroll-to-top", SCROLL_TO_BOTTOM: "scroll-to-bottom", SCROLL_TO_LEFT: "scroll-to-left", SCROLL_TO_RIGHT: "scroll-to-right", SCROLL_BEGAN: "scroll-began", SCROLL_ENDED: "scroll-ended", BOUNCE_TOP: "bounce-top", BOUNCE_BOTTOM: "bounce-bottom", BOUNCE_LEFT: "bounce-left", BOUNCE_RIGHT: "bounce-right", SCROLLING: "scrolling", SCROLL_ENG_WITH_THRESHOLD: "scroll-ended-with-threshold", TOUCH_UP: "touch-up" }, p2 = (S1 = Gu("cc.ScrollView"), T1 = Wu(110), I1 = Hu(TF), E1 = Ih(ky), A1 = Ih(x1), C1 = Ih(x1), D1 = Ih([rm]), S1(R1 = T1(R1 = I1((H1 = function (t) { function e() { var e; return (e = t.call(this) || this).bounceDuration = B1 && B1(), e.brake = M1 && M1(), e.elastic = O1 && O1(), e.inertia = L1 && L1(), e.horizontal = F1 && F1(), e.vertical = k1 && k1(), e.cancelInnerEvents = N1 && N1(), e.scrollEvents = z1 && z1(), e._autoScrolling = !1, e._scrolling = !1, e._content = U1 && U1(), e._horizontalScrollBar = V1 && V1(), e._verticalScrollBar = G1 && G1(), e._topBoundary = 0, e._bottomBoundary = 0, e._leftBoundary = 0, e._rightBoundary = 0, e._touchMoveDisplacements = [], e._touchMoveTimeDeltas = [], e._touchMovePreviousTimestamp = 0, e._touchMoved = !1, e._autoScrollAttenuate = !1, e._autoScrollStartPosition = new Kn, e._autoScrollTargetDelta = new Kn, e._autoScrollTotalTime = 0, e._autoScrollAccumulatedTime = 0, e._autoScrollCurrentlyOutOfBoundary = !1, e._autoScrollBraking = !1, e._autoScrollBrakingStartPosition = new Kn, e._outOfBoundaryAmount = new Kn, e._outOfBoundaryAmountDirty = !0, e._stopMouseWheel = !1, e._mouseWheelEventElapsedTime = 0, e._isScrollEndedWithThresholdEventFired = !1, e._scrollEventEmitMask = 0, e._isBouncing = !1, e._contentPos = new Kn, e._deltaPos = new Kn, e._deltaAmount = new Kn, e._hoverIn = 0, e } s(e, t); var i = e.prototype; return i.scrollToBottom = function (t, e) { void 0 === e && (e = !0), this._doScroll(0, 0, !1, !0, t, e) }, i.scrollToTop = function (t, e) { void 0 === e && (e = !0), this._doScroll(0, 1, !1, !0, t, e) }, i.scrollToLeft = function (t, e) { void 0 === e && (e = !0), this._doScroll(0, 0, !0, !1, t, e) }, i.scrollToRight = function (t, e) { void 0 === e && (e = !0), this._doScroll(1, 0, !0, !1, t, e) }, i.scrollToTopLeft = function (t, e) { void 0 === e && (e = !0), this._doScroll(0, 1, !0, !0, t, e) }, i.scrollToTopRight = function (t, e) { void 0 === e && (e = !0), this._doScroll(1, 1, !0, !0, t, e) }, i.scrollToBottomLeft = function (t, e) { void 0 === e && (e = !0), this._doScroll(0, 0, !0, !0, t, e) }, i.scrollToBottomRight = function (t, e) { void 0 === e && (e = !0), this._doScroll(1, 0, !0, !0, t, e) }, i.scrollToOffset = function (t, e, i) { void 0 === i && (i = !0); var n = this.getMaxScrollOffset(), r = os(); 0 === n.x ? r.x = 0 : r.x = t.x / n.x, 0 === n.y ? r.y = 1 : r.y = (n.y - t.y) / n.y, this.scrollTo(r, e, i) }, i.getScrollOffset = function () { var t = this._getContentTopBoundary() - this._topBoundary, e = this._getContentLeftBoundary() - this._leftBoundary; return new as(e, t) }, i.getMaxScrollOffset = function () { if (!this._content || !this.view) return as.ZERO; var t = this._content._getUITransformComp().contentSize, e = t.width - this.view.width, i = t.height - this.view.height; return new as(e = e >= 0 ? e : 0, i = i >= 0 ? i : 0) }, i.scrollToPercentHorizontal = function (t, e, i) { this._doScroll(t, 0, !0, !1, e, i) }, i.scrollTo = function (t, e, i) { this._doScroll(t.x, t.y, !0, !0, e, i) }, i.scrollToPercentVertical = function (t, e, i) { this._doScroll(0, t, !1, !0, e, i) }, i._doScroll = function (t, e, i, n, r, s) { void 0 === s && (s = !0), f2(t, e, i, n); var a = this._calculateMovePercentDelta(l2); r ? this._startAutoScroll(a, r, s) : this._moveContent(a) }, i.stopAutoScroll = function () { this._autoScrolling = !1, this._autoScrollAccumulatedTime = this._autoScrollTotalTime }, i.setContentPosition = function (t) { this._setContentPosition(t) }, i._setContentPosition = function (t) { if (this._content) { var e = this._getContentPosition(); Math.abs(t.x - e.x) < r2 && Math.abs(t.y - e.y) < r2 || (this._content.setPosition(t), this._outOfBoundaryAmountDirty = !0) } }, i.getContentPosition = function () { return this._getContentPosition() }, i._getContentPosition = function () { return this._content ? (this._contentPos.set(this._content.position), this._contentPos) : Kn.ZERO.clone() }, i.isScrolling = function () { return this._scrolling }, i.isAutoScrolling = function () { return this._autoScrolling }, i.getScrollEndedEventTiming = function () { return r2 }, i.start = function () { this._calculateBoundary(), this._content && yB.once("director_before_draw", this._adjustContentOutOfBoundary, this) }, i.onEnable = function () { var t = this; t._registerEvent(); var e = this._content; if (e) { e.on("size-changed", t._calculateBoundary, t), e.on("transform-changed", t._scaleChanged, t); var i = t.view; i && (i.node.on("transform-changed", t._scaleChanged, t), i.node.on("size-changed", t._calculateBoundary, t)) } t._calculateBoundary(), t._updateScrollBarState() }, i.update = function (t) { var e = this._deltaAmount; this._autoScrolling ? (this._processAutoScrolling(t), e.x = 0, e.y = 0) : 0 === e.x && 0 === e.y || (this._processDeltaMove(e), e.x = 0, e.y = 0) }, i.onDisable = function () { var t = this; t._unregisterEvent(); var e = t.content; if (e) { e.off("size-changed", t._calculateBoundary, t), e.off("transform-changed", t._scaleChanged, t); var i = t.view; i && (i.node.off("transform-changed", t._scaleChanged, t), i.node.off("size-changed", t._calculateBoundary, t)) } t._deltaAmount.set(0, 0), t._hideScrollBar(), t.stopAutoScroll() }, i._registerEvent = function () { var t = this, e = t.node; e.on("touch-start", t._onTouchBegan, t, !0), e.on("touch-move", t._onTouchMoved, t, !0), e.on("touch-end", t._onTouchEnded, t, !0), e.on("touch-cancel", t._onTouchCancelled, t, !0), e.on("mouse-wheel", t._onMouseWheel, t, !0), QD.on("handle-input", t._dispatchEventHandleInput, t), QD.on("gamepad-input", t._dispatchEventHandleInput, t) }, i._unregisterEvent = function () { var t = this, e = t.node; e.off("touch-start", t._onTouchBegan, t, !0), e.off("touch-move", t._onTouchMoved, t, !0), e.off("touch-end", t._onTouchEnded, t, !0), e.off("touch-cancel", t._onTouchCancelled, t, !0), e.off("mouse-wheel", t._onMouseWheel, t, !0), QD.off("handle-input", t._dispatchEventHandleInput, t), QD.off("gamepad-input", t._dispatchEventHandleInput, t) }, i._onMouseWheel = function (t, e) { var i = this; if (i.enabledInHierarchy && !i._hasNestedViewGroup(t, e)) { var n = t.getScrollY(), r = s2; i.vertical ? r.set(0, -.1 * n, 0) : i.horizontal && r.set(-.1 * n, 0, 0), i._mouseWheelEventElapsedTime = 0, i._deltaAmount.add(r), i._stopMouseWheel || (i._handlePressLogic(), i.schedule(this._checkMouseWheel, 1 / 60), i._stopMouseWheel = !0), i._stopPropagationIfTargetIsMe(t) } }, i._onTouchBegan = function (t, e) { var i = this; i.enabledInHierarchy && i._content && (i._hasNestedViewGroup(t, e) || (i._handlePressLogic(), i._touchMoved = !1, i._stopPropagationIfTargetIsMe(t))) }, i._onTouchMoved = function (t, e) { var i = this; if (i.enabledInHierarchy && i._content && !i._hasNestedViewGroup(t, e)) { var n = t.touch; if (i._handleMoveLogic(n), i.cancelInnerEvents) { var r = n.getUILocation(o2); if (r.subtract(n.getUIStartLocation(u2)), r.length() > 7 && !i._touchMoved && t.target !== i.node) { var s = new Fv(t.getTouches(), t.bubbles, "touch-cancel"); s.touch = t.touch, s.simulate = !0, t.target.dispatchEvent(s), i._touchMoved = !0 } i._stopPropagationIfTargetIsMe(t) } } }, i._onTouchEnded = function (t, e) { var i = this; if (i.enabledInHierarchy && i._content && t && !i._hasNestedViewGroup(t, e)) { i._dispatchEvent("touch-up"); var n = t.touch; i._handleReleaseLogic(n), i._touchMoved ? t.propagationStopped = !0 : i._stopPropagationIfTargetIsMe(t) } }, i._onTouchCancelled = function (t, e) { var i = this; i.enabledInHierarchy && i._content && (i._hasNestedViewGroup(t, e) || (t && !t.simulate && i._handleReleaseLogic(t.touch), i._stopPropagationIfTargetIsMe(t))) }, i._calculateBoundary = function () { var t = this; if (t._content && t.view) { var e = t._content.getComponent(J0); e && e.enabledInHierarchy && e.updateLayout(); var i = t.view, n = i.width * i.anchorX, r = i.height * i.anchorY; t._leftBoundary = -n, t._bottomBoundary = -r, t._rightBoundary = t._leftBoundary + i.width, t._topBoundary = t._bottomBoundary + i.height, t._moveContentToTopLeft(i.contentSize) } }, i._hasNestedViewGroup = function (t, e) { if (!t || t.eventPhase !== Pv.CAPTURING_PHASE) return !1; if (e) for (var i = 0; i < e.length; i++) { var n = e[i]; if (this.node === n) return !(!t.target || !t.target.getComponent(W1)); if (n.getComponent(W1)) return !0 } return !1 }, i._startInertiaScroll = function (t) { s2.set(t), s2.multiplyScalar(.7), this._startAttenuatingAutoScroll(s2, t) }, i._calculateAttenuatedFactor = function (t) { return this.brake <= 0 ? 1 - this.brake : (1 - this.brake) * (1 / (1 + 14e-6 * t + t * t * 8e-9)) }, i._startAttenuatingAutoScroll = function (t, e) { var i = t.clone(); if (i.normalize(), this._content && this.view) { var n = this._content._getUITransformComp().contentSize, r = this.view.contentSize, s = n.width - r.width, a = n.height - r.height, o = this._calculateAttenuatedFactor(s), u = this._calculateAttenuatedFactor(a); i.x = i.x * s * (1 - this.brake) * o, i.y = i.y * a * u * (1 - this.brake), i.z = 0 } var h = t.length(), c = i.length() / h; this.brake > 0 && c > 7 ? (c = Math.sqrt(c), i.set(t), i.multiplyScalar(c + 1)) : i.add(t); var l = this._calculateAutoScrollTimeByInitialSpeed(e.length()); this.brake > 0 && c > 3 && (l *= c = 3), 0 === this.brake && c > 1 && (l *= c), this._startAutoScroll(i, l, !0) }, i._calculateAutoScrollTimeByInitialSpeed = function (t) { return Math.sqrt(Math.sqrt(t / 5)) }, i._startAutoScroll = function (t, e, i) { void 0 === i && (i = !1); var n = this, r = n._flattenVectorByDirection(t); n._autoScrolling = !0, n._autoScrollTargetDelta = r, n._autoScrollAttenuate = i, Kn.copy(n._autoScrollStartPosition, n._getContentPosition()), n._autoScrollTotalTime = e, n._autoScrollAccumulatedTime = 0, n._autoScrollBraking = !1, n._isScrollEndedWithThresholdEventFired = !1, n._autoScrollBrakingStartPosition.set(0, 0, 0), n._getHowMuchOutOfBoundary().equals(Kn.ZERO, r2) || (this._autoScrollCurrentlyOutOfBoundary = !0) }, i._calculateTouchMoveVelocity = function () { var t = new Kn, e = 0; if ((e = this._touchMoveTimeDeltas.reduce((function (t, e) { return t + e }), e)) <= 0 || e >= .5) t.set(Kn.ZERO); else { var i = s2; i.set(0, 0, 0), i = this._touchMoveDisplacements.reduce((function (t, e) { return t.add(e), t }), i), t.set(i.x * (1 - this.brake) / e, i.y * (1 - this.brake) / e, i.z) } return t }, i._flattenVectorByDirection = function (t) { return this.horizontal || (t.x = 0), this.vertical || (t.y = 0), t }, i._moveContent = function (t, e) { var i = this._flattenVectorByDirection(t); s2.set(this._getContentPosition()), s2.add(i), s2.set(Math.round(1e4 * s2.x) * r2, Math.round(1e4 * s2.y) * r2, s2.z), this._setContentPosition(s2); var n = this._getHowMuchOutOfBoundary(); o2.set(n.x, n.y), this._updateScrollBar(o2), this.elastic && e && this._startBounceBackIfNeeded() }, i._getContentLeftBoundary = function () { if (!this._content) return -1; var t = this._getContentPosition(), e = this._content._getUITransformComp(); return t.x - e.anchorX * e.width }, i._getContentRightBoundary = function () { if (!this._content) return -1; var t = this._content._getUITransformComp(); return this._getContentLeftBoundary() + t.width }, i._getContentTopBoundary = function () { if (!this._content) return -1; var t = this._content._getUITransformComp(); return this._getContentBottomBoundary() + t.height }, i._getContentBottomBoundary = function () { if (!this._content) return -1; var t = this._getContentPosition(), e = this._content._getUITransformComp(); return t.y - e.anchorY * e.height }, i._getHowMuchOutOfBoundary = function (t) { if (t || (t = Kn.ZERO), t.equals(Kn.ZERO, r2) && !this._outOfBoundaryAmountDirty) return this._outOfBoundaryAmount; var e = new Kn, i = this._getContentLeftBoundary(), n = this._getContentRightBoundary(); i + t.x > this._leftBoundary ? e.x = this._leftBoundary - (i + t.x) : n + t.x < this._rightBoundary && (e.x = this._rightBoundary - (n + t.x)); var r = this._getContentTopBoundary(), s = this._getContentBottomBoundary(); return r + t.y < this._topBoundary ? e.y = this._topBoundary - (r + t.y) : s + t.y > this._bottomBoundary && (e.y = this._bottomBoundary - (s + t.y)), t.equals(Kn.ZERO, r2) && (this._outOfBoundaryAmount = e, this._outOfBoundaryAmountDirty = !1), this._clampDelta(e), e }, i._updateScrollBar = function (t) { this._horizontalScrollBar && this._horizontalScrollBar.isValid && this._horizontalScrollBar.onScroll(t), this._verticalScrollBar && this._verticalScrollBar.isValid && this._verticalScrollBar.onScroll(t) }, i._onScrollBarTouchBegan = function () { this._horizontalScrollBar && this._horizontalScrollBar.isValid && this._horizontalScrollBar.onTouchBegan(), this._verticalScrollBar && this._verticalScrollBar.isValid && this._verticalScrollBar.onTouchBegan() }, i._onScrollBarTouchEnded = function () { this._horizontalScrollBar && this._horizontalScrollBar.isValid && this._horizontalScrollBar.onTouchEnded(), this._verticalScrollBar && this._verticalScrollBar.isValid && this._verticalScrollBar.onTouchEnded() }, i._dispatchEvent = function (t) { if ("scroll-ended" === t) this._scrollEventEmitMask = 0; else if ("scroll-to-top" === t || "scroll-to-bottom" === t || "scroll-to-left" === t || "scroll-to-right" === t) { var e = 1 << c2[t]; if (this._scrollEventEmitMask & e) return; this._scrollEventEmitMask |= e } rm.emitEvents(this.scrollEvents, this, c2[t]), this.node.emit(t, this) }, i._adjustContentOutOfBoundary = function () { if (this._content) { this._outOfBoundaryAmountDirty = !0; var t = this._getHowMuchOutOfBoundary(); !t.equals(Kn.ZERO, r2) && (s2.set(this._getContentPosition()), s2.add(t), this._setContentPosition(s2), this._updateScrollBar(as.ZERO)) } }, i._hideScrollBar = function () { this._horizontalScrollBar && this._horizontalScrollBar.isValid && this._horizontalScrollBar.hide(), this._verticalScrollBar && this._verticalScrollBar.isValid && this._verticalScrollBar.hide() }, i._updateScrollBarState = function () { var t = this; if (t._content && t.view) { var e = t.view, i = t._content._getUITransformComp(), n = t._verticalScrollBar; n && n.isValid && (i.height < e.height || ji(i.height, e.height) ? n.hide() : n.show()); var r = t._horizontalScrollBar; r && r.isValid && (i.width < e.width || ji(i.width, e.width) ? r.hide() : r.show()) } }, i._stopPropagationIfTargetIsMe = function (t) { t.eventPhase === Pv.AT_TARGET && t.target === this.node && (t.propagationStopped = !0) }, i._processDeltaMove = function (t) { this._scrollChildren(t), this._gatherTouchMove(t) }, i._handleMoveLogic = function (t) { this._getLocalAxisAlignDelta(this._deltaPos, t), this._deltaAmount.add(this._deltaPos) }, i._handleReleaseLogic = function (t) { var e = this; e._getLocalAxisAlignDelta(e._deltaPos, t), e._gatherTouchMove(e._deltaPos), e._processInertiaScroll(), e._scrolling && (e._scrolling = !1, e._autoScrolling || e._dispatchEvent("scroll-ended")) }, i._getLocalAxisAlignDelta = function (t, e) { var i = this.node._getUITransformComp(); i && (e.getUILocation(o2), e.getUIPreviousLocation(u2), s2.set(o2.x, o2.y, 0), a2.set(u2.x, u2.y, 0), i.convertToNodeSpaceAR(s2, s2), i.convertToNodeSpaceAR(a2, a2), Kn.subtract(t, s2, a2)) }, i._scrollChildren = function (t) { var e = this; e._clampDelta(t); var i, n = t; e.elastic && (i = e._getHowMuchOutOfBoundary(), n.x *= 0 === i.x ? 1 : .5, n.y *= 0 === i.y ? 1 : .5), e.elastic || (i = e._getHowMuchOutOfBoundary(n), n.add(i)); var r = "", s = ""; if (e._content) { var a = e._content._getUITransformComp(), o = a.anchorX, u = a.anchorY, h = a.width, c = a.height, l = e._content.position || Kn.ZERO; e.vertical && (n.y > 0 ? l.y - u * c + n.y >= e._bottomBoundary && (r = "scroll-to-bottom") : n.y < 0 && l.y - u * c + c + n.y <= e._topBoundary && (r = "scroll-to-top")), e.horizontal && (n.x < 0 ? l.x - o * h + h + n.x <= e._rightBoundary && (s = "scroll-to-right") : n.x > 0 && l.x - o * h + n.x >= e._leftBoundary && (s = "scroll-to-left")) } e._moveContent(n, !1), (e.horizontal && 0 !== n.x || e.vertical && 0 !== n.y) && (e._scrolling || (e._scrolling = !0, e._dispatchEvent("scroll-began")), e._dispatchEvent("scrolling")), "" !== r && e._dispatchEvent(r), "" !== s && e._dispatchEvent(s) }, i._handlePressLogic = function () { var t = this; t._autoScrolling && t._dispatchEvent("scroll-ended"), t._autoScrolling = !1, t._isBouncing = !1, t._touchMovePreviousTimestamp = h2(), t._touchMoveDisplacements.length = 0, t._touchMoveTimeDeltas.length = 0, t._onScrollBarTouchBegan() }, i._clampDelta = function (t) { if (this._content && this.view) { var e = this.view.contentSize, i = this._content._getUITransformComp(); i.width < e.width && (t.x = 0), i.height < e.height && (t.y = 0) } }, i._gatherTouchMove = function (t) { var e = this, i = t.clone(); for (e._clampDelta(i); e._touchMoveDisplacements.length >= 5;)e._touchMoveDisplacements.shift(), e._touchMoveTimeDeltas.shift(); e._touchMoveDisplacements.push(i); var n = h2(); e._touchMoveTimeDeltas.push((n - e._touchMovePreviousTimestamp) / 1e3), e._touchMovePreviousTimestamp = n }, i._startBounceBackIfNeeded = function () { var t = this; if (!t.elastic) return !1; var e = t._getHowMuchOutOfBoundary(); if (t._clampDelta(e), e.equals(Kn.ZERO, r2)) return !1; var i = Math.max(t.bounceDuration, 0); return t._startAutoScroll(e, i, !0), t._isBouncing || (e.y > 0 && t._dispatchEvent("bounce-top"), e.y < 0 && t._dispatchEvent("bounce-bottom"), e.x > 0 && t._dispatchEvent("bounce-right"), e.x < 0 && t._dispatchEvent("bounce-left"), t._isBouncing = !0), !0 }, i._processInertiaScroll = function () { if (!this._startBounceBackIfNeeded() && this.inertia) { var t = this._calculateTouchMoveVelocity(); !t.equals(Kn.ZERO, r2) && this.brake < 1 && this._startInertiaScroll(t) } this._onScrollBarTouchEnded() }, i._isOutOfBoundary = function () { return !this._getHowMuchOutOfBoundary().equals(Kn.ZERO, r2) }, i._isNecessaryAutoScrollBrake = function () { var t = this; if (t._autoScrollBraking) return !0; if (t._isOutOfBoundary()) { if (!t._autoScrollCurrentlyOutOfBoundary) return t._autoScrollCurrentlyOutOfBoundary = !0, t._autoScrollBraking = !0, Kn.copy(t._autoScrollBrakingStartPosition, t._getContentPosition()), !0 } else t._autoScrollCurrentlyOutOfBoundary = !1; return !1 }, i._processAutoScrolling = function (t) { var e = this, i = e._isNecessaryAutoScrollBrake(), n = i ? .05 : 1; e._autoScrollAccumulatedTime += t * (1 / n); var r, s = Math.min(1, e._autoScrollAccumulatedTime / e._autoScrollTotalTime); e._autoScrollAttenuate && (r = s, s = (r -= 1) * r * r * r * r + 1); var a = e._autoScrollTargetDelta.clone(); a.multiplyScalar(s); var o = e._autoScrollStartPosition.clone(); o.add(a); var u = Math.abs(s - 1) <= r2; if (Math.abs(s - 1) <= e.getScrollEndedEventTiming() && !e._isScrollEndedWithThresholdEventFired && (e._dispatchEvent("scroll-ended-with-threshold"), e._isScrollEndedWithThresholdEventFired = !0), e.elastic) { var h = o.clone(); h.subtract(e._autoScrollBrakingStartPosition), i && h.multiplyScalar(n), o.set(e._autoScrollBrakingStartPosition), o.add(h) } else { var c = o.clone(); c.subtract(e.getContentPosition()); var l = e._getHowMuchOutOfBoundary(c); l.equals(Kn.ZERO, r2) || (o.add(l), u = !0) } u && (e._autoScrolling = !1); var f = o.clone(); f.subtract(e._getContentPosition()), e._clampDelta(f), e._moveContent(f, u), e._dispatchEvent("scrolling"), e._autoScrolling || (e._isBouncing = !1, e._scrolling = !1, e._dispatchEvent("scroll-ended")) }, i._checkMouseWheel = function (t) { var e = this; if (!e._getHowMuchOutOfBoundary().equals(Kn.ZERO, r2)) return e._processInertiaScroll(), e._scrolling && (e._scrolling = !1, e._autoScrolling || e._dispatchEvent("scroll-ended")), e.unschedule(e._checkMouseWheel), void (e._stopMouseWheel = !1); e._mouseWheelEventElapsedTime += t, e._mouseWheelEventElapsedTime > .1 && (e._onScrollBarTouchEnded(), e._scrolling && (e._scrolling = !1, e._autoScrolling || e._dispatchEvent("scroll-ended")), e.unschedule(e._checkMouseWheel), e._stopMouseWheel = !1) }, i._calculateMovePercentDelta = function (t) { var e = t.anchor, i = t.applyToHorizontal, n = t.applyToVertical, r = this; r._calculateBoundary(), e.clampf(as.ZERO, as.ONE); var s = r._getContentBottomBoundary() - r._bottomBoundary; s = -s; var a = r._getContentLeftBoundary() - r._leftBoundary; a = -a; var o = new Kn; if (r._content && r.view) { var u = 0, h = r._content._getUITransformComp().contentSize, c = r.view.contentSize; i && (u = h.width - c.width, o.x = a - u * e.x), n && (u = h.height - c.height, o.y = s - u * e.y) } return o }, i._moveContentToTopLeft = function (t) { var e = this, i = e._getContentBottomBoundary() - e._bottomBoundary; i = -i; var n = new Kn, r = 0, s = e._getContentLeftBoundary() - e._leftBoundary; if (s = -s, e._content) { var a = e._content._getUITransformComp().contentSize; a.height < t.height && (r = a.height - t.height, n.y = i - r), a.width < t.width && (r = a.width - t.width, n.x = s) } e._updateScrollBarState(), e._moveContent(n), e._adjustContentOutOfBoundary() }, i._scaleChanged = function (t) { 4 === t && this._calculateBoundary() }, i._xrHoverEnter = function () { }, i._xrHoverExit = function () { }, i._dispatchEventHandleInput = function (t) { t instanceof kv ? t.gamepad : t instanceof Nv && t.handleInputDevice, this.enabledInHierarchy }, i._xrThumbStickMove = function (t) { var e = this; if (e.enabledInHierarchy) { var i = t.y, n = s2; e.vertical ? n.set(0, -62.5 * i, 0) : e.horizontal && n.set(-62.5 * i, 0, 0), e._mouseWheelEventElapsedTime = 0, e._deltaAmount.add(n), e._stopMouseWheel || (e._handlePressLogic(), e.schedule(e._checkMouseWheel, 1 / 60, NaN, 0), e._stopMouseWheel = !0) } }, n(e, [{ key: "content", get: function () { return this._content }, set: function (t) { if (this._content !== t) { var e = t && t.parent && t.parent._getUITransformComp(); !t || t && e ? (this._content = t, this._calculateBoundary()) : J(4302) } } }, { key: "horizontalScrollBar", get: function () { var t = this._horizontalScrollBar; return t && !t.isValid && rt(4303, "horizontal", this.node.name), t }, set: function (t) { this._horizontalScrollBar !== t && (this._horizontalScrollBar = t, this._horizontalScrollBar && (this._horizontalScrollBar.setScrollView(this), this._updateScrollBar(as.ZERO))) } }, { key: "verticalScrollBar", get: function () { var t = this._verticalScrollBar; return t && !t.isValid && rt(4303, "vertical", this.node.name), t }, set: function (t) { this._verticalScrollBar !== t && (this._verticalScrollBar = t, this._verticalScrollBar && (this._verticalScrollBar.setScrollView(this), this._updateScrollBar(as.ZERO))) } }, { key: "view", get: function () { var t = this._content && this._content.parent; return t ? t._getUITransformComp() : null } }]), e }(W1), H1.EventType = d2, B1 = Bu((P1 = H1).prototype, "bounceDuration", [eh], (function () { return 1 })), M1 = Bu(P1.prototype, "brake", [eh], (function () { return .5 })), O1 = Bu(P1.prototype, "elastic", [eh], (function () { return !0 })), L1 = Bu(P1.prototype, "inertia", [eh], (function () { return !0 })), m(P1.prototype, "content", [E1], Object.getOwnPropertyDescriptor(P1.prototype, "content"), P1.prototype), F1 = Bu(P1.prototype, "horizontal", [eh], (function () { return !0 })), m(P1.prototype, "horizontalScrollBar", [A1], Object.getOwnPropertyDescriptor(P1.prototype, "horizontalScrollBar"), P1.prototype), k1 = Bu(P1.prototype, "vertical", [eh], (function () { return !0 })), m(P1.prototype, "verticalScrollBar", [C1], Object.getOwnPropertyDescriptor(P1.prototype, "verticalScrollBar"), P1.prototype), N1 = Bu(P1.prototype, "cancelInnerEvents", [eh], (function () { return !0 })), z1 = Bu(P1.prototype, "scrollEvents", [D1, eh], (function () { return [] })), U1 = Bu(P1.prototype, "_content", [eh], (function () { return null })), V1 = Bu(P1.prototype, "_horizontalScrollBar", [eh], (function () { return null })), G1 = Bu(P1.prototype, "_verticalScrollBar", [eh], (function () { return null })), R1 = P1)) || R1) || R1) || R1); t({ ScrollView: p2, ScrollViewComponent: p2 }), T.ScrollView = p2; var _2 = new Kn, g2 = { Horizontal: 0, Vertical: 1 }; De(g2); var m2, v2, y2, b2, w2, x2, S2, T2, I2, E2, A2, C2 = (j1 = Gu("cc.Slider"), X1 = Wu(110), q1 = Hu(TF), Y1 = Ih(iN), K1 = Ih(g2), Q1 = Ih([rm]), j1(Z1 = X1(Z1 = q1((n2 = function (t) { function e() { var e; return (e = t.call(this) || this).slideEvents = $1 && $1(), e._handle = t2 && t2(), e._direction = e2 && e2(), e._progress = i2 && i2(), e._offset = new Kn, e._dragging = !1, e._touchHandle = !1, e._handleLocalPos = new Kn, e._touchPos = new Kn, e } s(e, t); var i = e.prototype; return i.__preload = function () { this._updateHandlePosition() }, i.onEnable = function () { var t = this, e = t.node, i = t._handle; if (t._updateHandlePosition(), e.on("touch-start", t._onTouchBegan, t), e.on("touch-move", t._onTouchMoved, t), e.on("touch-end", t._onTouchEnded, t), e.on("touch-cancel", t._onTouchCancelled, t), i && i.isValid) { var n = i.node; n.on("touch-start", t._onHandleDragStart, t), n.on("touch-move", t._onTouchMoved, t), n.on("touch-end", t._onTouchEnded, t) } }, i.onDisable = function () { var t = this, e = t.node, i = t._handle; if (e.off("touch-start", t._onTouchBegan, t), e.off("touch-move", t._onTouchMoved, t), e.off("touch-end", t._onTouchEnded, t), e.off("touch-cancel", t._onTouchCancelled, t), i && i.isValid) { var n = i.node; n.off("touch-start", t._onHandleDragStart, t), n.off("touch-move", t._onTouchMoved, t), n.off("touch-end", t._onTouchEnded, t) } }, i._onHandleDragStart = function (t) { if (t && this._handle && this._handle.node._getUITransformComp()) { this._dragging = !0, this._touchHandle = !0; var e = t.touch.getUILocation(); Kn.set(this._touchPos, e.x, e.y, 0), this._handle.node._getUITransformComp().convertToNodeSpaceAR(this._touchPos, this._offset), t.propagationStopped = !0 } }, i._onTouchBegan = function (t) { this._handle && t && (this._dragging = !0, this._touchHandle || this._handleSliderLogic(t.touch), t.propagationStopped = !0) }, i._onTouchMoved = function (t) { this._dragging && t && (this._handleSliderLogic(t.touch), t.propagationStopped = !0) }, i._onTouchEnded = function (t) { this._dragging = !1, this._touchHandle = !1, this._offset = new Kn, t && (t.propagationStopped = !0) }, i._onTouchCancelled = function (t) { this._dragging = !1, t && (t.propagationStopped = !0) }, i._handleSliderLogic = function (t) { this._updateProgress(t), this._emitSlideEvent() }, i._emitSlideEvent = function () { rm.emitEvents(this.slideEvents, this), this.node.emit("slide", this) }, i._updateProgress = function (t) { if (this._handle && t) { var e = t.getUILocation(); Kn.set(this._touchPos, e.x, e.y, 0); var i = this.node._getUITransformComp(), n = i.convertToNodeSpaceAR(this._touchPos, _2); 0 === this.direction ? this.progress = qi(.5 + (n.x - this._offset.x) / i.width) : this.progress = qi(.5 + (n.y - this._offset.y) / i.height) } }, i._updateHandlePosition = function () { if (this._handle) { this._handleLocalPos.set(this._handle.node.position); var t = this.node._getUITransformComp(); 0 === this._direction ? this._handleLocalPos.x = -t.width * t.anchorX + this.progress * t.width : this._handleLocalPos.y = -t.height * t.anchorY + this.progress * t.height, this._handle.node.setPosition(this._handleLocalPos) } }, i._changeLayout = function () { var t = this.node._getUITransformComp(), e = t.contentSize; if (t.setContentSize(e.height, e.width), this._handle) { var i = this._handle.node.position; 0 === this._direction ? this._handle.node.setPosition(i.x, 0, i.z) : this._handle.node.setPosition(0, i.y, i.z), this._updateHandlePosition() } }, i._xrHandleProgress = function () { }, i._xrClick = function () { }, i._xrUnClick = function () { }, i._xrHoverStay = function () { }, n(e, [{ key: "handle", get: function () { return this._handle }, set: function (t) { this._handle !== t && (this._handle = t) } }, { key: "direction", get: function () { return this._direction }, set: function (t) { this._direction !== t && (this._direction = t, this._changeLayout()) } }, { key: "progress", get: function () { return this._progress }, set: function (t) { this._progress !== t && (this._progress = t, this._updateHandlePosition()) } }]), e }(am), n2.Direction = g2, m((J1 = n2).prototype, "handle", [Y1], Object.getOwnPropertyDescriptor(J1.prototype, "handle"), J1.prototype), m(J1.prototype, "direction", [K1], Object.getOwnPropertyDescriptor(J1.prototype, "direction"), J1.prototype), $1 = Bu(J1.prototype, "slideEvents", [Q1, eh], (function () { return [] })), t2 = Bu(J1.prototype, "_handle", [eh], (function () { return null })), e2 = Bu(J1.prototype, "_direction", [eh], (function () { return 0 })), i2 = Bu(J1.prototype, "_progress", [eh], (function () { return .1 })), Z1 = J1)) || Z1) || Z1) || Z1); function D2() { for (var t = arguments.length, e = new Array(t), i = 0; i < t; i++)e[i] = arguments[i]; return Object.assign.apply(Object, [{}].concat(e)) } t({ Slider: C2, SliderComponent: C2 }), T.Slider = C2; var R2, P2, B2, M2, O2, L2, F2, k2 = (m2 = Gu("cc.Toggle"), v2 = Wu(110), y2 = Hu(TF), b2 = Ih(iN), w2 = Ih([rm]), m2(x2 = v2(x2 = y2((A2 = function (t) { function e() { var e; return (e = t.call(this) || this).checkEvents = T2 && T2(), e._isChecked = I2 && I2(), e._checkMark = E2 && E2(), e } s(e, t); var i = e.prototype; return i._internalToggle = function () { this.isChecked = !this.isChecked }, i._set = function (t, e) { if (void 0 === e && (e = !0), this._isChecked != t) { this._isChecked = t; var i = this._toggleContainer; i && i.enabled && this.enabled && (t || !i.anyTogglesChecked() && !i.allowSwitchOff) && (this._isChecked = !0, i.notifyToggleCheck(this, e)), this.playEffect(), e && this._emitToggleEvents() } }, i.playEffect = function () { this._checkMark && (this._checkMark.node.active = this._isChecked) }, i.setIsCheckedWithoutNotify = function (t) { this._set(t, !1) }, i.onEnable = function () { t.prototype.onEnable.call(this), this.playEffect(), this.node.on(e.EventType.CLICK, this._internalToggle, this) }, i.onDisable = function () { t.prototype.onDisable.call(this), this.node.off(e.EventType.CLICK, this._internalToggle, this) }, i._emitToggleEvents = function () { this.node.emit(e.EventType.TOGGLE, this), this.checkEvents && rm.emitEvents(this.checkEvents, this) }, n(e, [{ key: "isChecked", get: function () { return this._isChecked }, set: function (t) { this._set(t) } }, { key: "checkMark", get: function () { return this._checkMark }, set: function (t) { this._checkMark !== t && (this._checkMark = t) } }, { key: "_resizeToTarget", set: function (t) { t && this._resizeNodeToTargetNode() } }, { key: "_toggleContainer", get: function () { var t = this.node.parent; return T.Node.isNode(t) ? t.getComponent("cc.ToggleContainer") : null } }]), e }(_$), A2.EventType = D2({ TOGGLE: "toggle" }, p$), m((S2 = A2).prototype, "checkMark", [b2], Object.getOwnPropertyDescriptor(S2.prototype, "checkMark"), S2.prototype), T2 = Bu(S2.prototype, "checkEvents", [w2, eh], (function () { return [] })), I2 = Bu(S2.prototype, "_isChecked", [eh], (function () { return !0 })), E2 = Bu(S2.prototype, "_checkMark", [eh], (function () { return null })), x2 = S2)) || x2) || x2) || x2); t({ Toggle: k2, ToggleComponent: k2 }), T.Toggle = k2; var N2, z2, U2, V2, G2, H2, W2, j2, X2, q2, Y2, K2, Q2, Z2, J2, $2, t3, e3, i3, n3, r3, s3, a3, o3, u3, h3, c3 = (R2 = Gu("cc.ToggleContainer"), P2 = Wu(110), B2 = Ih([rm]), R2(M2 = P2((O2 = function (t) { function e() { var e; return (e = t.call(this) || this)._allowSwitchOff = L2 && L2(), e.checkEvents = F2 && F2(), e } s(e, t); var i = e.prototype; return i.onEnable = function () { this.ensureValidState(), this.node.on("child-added", this.ensureValidState, this), this.node.on("child-removed", this.ensureValidState, this) }, i.onDisable = function () { this.node.off("child-added", this.ensureValidState, this), this.node.off("child-removed", this.ensureValidState, this) }, i.activeToggles = function () { return this.toggleItems.filter((function (t) { return t.isChecked })) }, i.anyTogglesChecked = function () { return !!this.toggleItems.find((function (t) { return t.isChecked })) }, i.notifyToggleCheck = function (t, e) { if (void 0 === e && (e = !0), this.enabledInHierarchy) { for (var i = 0; i < this.toggleItems.length; i++) { var n = this.toggleItems[i]; n !== t && (e ? n.isChecked = !1 : n.setIsCheckedWithoutNotify(!1)) } this.checkEvents && T.Component.EventHandler.emitEvents(this.checkEvents, t) } }, i.ensureValidState = function () { var t = this.toggleItems; if (!this._allowSwitchOff && !this.anyTogglesChecked() && 0 !== t.length) { var e = t[0]; e.isChecked = !0, this.notifyToggleCheck(e) } var i = this.activeToggles(); if (i.length > 1) for (var n = i[0], r = 0; r < i.length; ++r) { var s = i[r]; s !== n && (s.isChecked = !1) } }, n(e, [{ key: "allowSwitchOff", get: function () { return this._allowSwitchOff }, set: function (t) { this._allowSwitchOff = t } }, { key: "toggleItems", get: function () { return this.node.children.map((function (t) { var e = t.getComponent("cc.Toggle"); return e && e.enabled ? e : null })).filter(Boolean) } }]), e }(am), L2 = Bu(O2.prototype, "_allowSwitchOff", [eh], (function () { return !1 })), F2 = Bu(O2.prototype, "checkEvents", [B2, eh], (function () { return [] })), M2 = O2)) || M2) || M2); t({ ToggleContainer: c3, ToggleContainerComponent: c3 }), T.ToggleContainer = c3; var l3 = new as; function f3(t) { var e = t._getUITransformComp(); return t instanceof hD ? eu : e ? e.contentSize : us.ZERO } function d3(t, e, i, n) { t.parent ? l3.set(t.parent.scale.x, t.parent.scale.y) : l3.set(0, 0); for (var r = l3.x, s = l3.y, a = 0, o = 0, u = t.parent; ;) { if (!u) return i.x = i.y = 0, void (n.x = n.y = 1); var h = u.position; if (a += h.x, o += h.y, (u = u.parent) === e) break; u ? l3.set(u.scale.x, u.scale.y) : l3.set(0, 0); var c = l3.x, l = l3.y; a *= c, o *= l, r *= c, s *= l } n.x = 0 !== r ? 1 / r : 1, n.y = 0 !== s ? 1 / s : 1, i.x = -a, i.y = -o } var p3 = { ONCE: 0, ALWAYS: 1, ON_WINDOW_RESIZE: 2 }; De(p3); var _3, g3, m3, v3, y3, b3, w3, x3, S3, T3, I3, E3, A3 = { TOP: 1, MID: 2, BOT: 4, LEFT: 8, CENTER: 16, RIGHT: 32, HORIZONTAL: 56, VERTICAL: 7 }, C3 = (N2 = Gu("cc.Widget"), z2 = Wu(110), U2 = Hu(TF), V2 = Ih(ky), G2 = Ih(p3), N2(H2 = z2(H2 = U2((h3 = function (t) { function e() { var e; return (e = t.call(this) || this)._lastPos = new Kn, e._lastSize = new us, e._dirty = !0, e._hadAlignOnce = !1, e._alignFlags = j2 && j2(), e._target = X2 && X2(), e._left = q2 && q2(), e._right = Y2 && Y2(), e._top = K2 && K2(), e._bottom = Q2 && Q2(), e._horizontalCenter = Z2 && Z2(), e._verticalCenter = J2 && J2(), e._isAbsLeft = $2 && $2(), e._isAbsRight = t3 && t3(), e._isAbsTop = e3 && e3(), e._isAbsBottom = i3 && i3(), e._isAbsHorizontalCenter = n3 && n3(), e._isAbsVerticalCenter = r3 && r3(), e._originalWidth = s3 && s3(), e._originalHeight = a3 && a3(), e._alignMode = o3 && o3(), e._lockFlags = u3 && u3(), e } s(e, t); var i = e.prototype; return i.updateAlignment = function () { S._widgetManager.updateAlignment(this.node) }, i._validateTargetInDEV = function () { }, i.setDirty = function () { this._recursiveDirty() }, i.onEnable = function () { this.node.getPosition(this._lastPos), this._lastSize.set(this.node._getUITransformComp().contentSize), S._widgetManager.add(this), this._hadAlignOnce = !1, this._registerEvent(), this._registerTargetEvents() }, i.onDisable = function () { S._widgetManager.remove(this), this._unregisterEvent(), this._unregisterTargetEvents() }, i.onDestroy = function () { this._removeParentEvent() }, i._adjustWidgetToAllowMovingInEditor = function () { }, i._adjustWidgetToAllowResizingInEditor = function () { }, i._adjustWidgetToAnchorChanged = function () { this.setDirty() }, i._adjustTargetToParentChanged = function (t) { t && this._unregisterOldParentEvents(t), this.node.getParent() && this._registerTargetEvents(), this._setDirtyByMode() }, i._registerEvent = function () { this.node.on("transform-changed", this._setDirtyByMode, this), this.node.on("size-changed", this._setDirtyByMode, this), this.node.on("anchor-changed", this._adjustWidgetToAnchorChanged, this), this.node.on("parent-changed", this._adjustTargetToParentChanged, this) }, i._unregisterEvent = function () { this.node.off("transform-changed", this._setDirtyByMode, this), this.node.off("size-changed", this._setDirtyByMode, this), this.node.off("anchor-changed", this._adjustWidgetToAnchorChanged, this) }, i._removeParentEvent = function () { this.node.off("parent-changed", this._adjustTargetToParentChanged, this) }, i._autoChangedValue = function (t, e) { if ((this._alignFlags & t) > 0) { var i = this.node.parent && this.node.parent._uiProps, n = i && i.uiTransformComp, r = n ? n.contentSize : eu; this.isAlignLeft && 8 === t ? this._left = e ? this._left * r.width : this._left / r.width : this.isAlignRight && 32 === t ? this._right = e ? this._right * r.width : this._right / r.width : this.isAlignHorizontalCenter && 16 === t ? this._horizontalCenter = e ? this._horizontalCenter * r.width : this._horizontalCenter / r.width : this.isAlignTop && 1 === t ? this._top = e ? this._top * r.height : this._top / r.height : this.isAlignBottom && 4 === t ? this._bottom = e ? this._bottom * r.height : this._bottom / r.height : this.isAbsoluteVerticalCenter && 2 === t && (this._verticalCenter = this._verticalCenter / r.height), this._recursiveDirty() } }, i._registerTargetEvents = function () { var t = this._target || this.node.parent; t && t.getComponent(TF) && (t.on("transform-changed", this._setDirtyByMode, this), t.on("size-changed", this._setDirtyByMode, this), t.on("anchor-changed", this._setDirtyByMode, this)) }, i._unregisterTargetEvents = function () { var t = this._target || this.node.parent; t && (t.off("transform-changed", this._setDirtyByMode, this), t.off("size-changed", this._setDirtyByMode, this), t.off("anchor-changed", this._setDirtyByMode, this)) }, i._unregisterOldParentEvents = function (t) { var e = this._target || t; e && (e.off("transform-changed", this._setDirtyByMode, this), e.off("size-changed", this._setDirtyByMode, this)) }, i._setDirtyByMode = function () { 1 === this.alignMode && this._recursiveDirty() }, i._setAlign = function (t, e) { if (e !== (this._alignFlags & t) > 0) { var i = (40 & t) > 0, n = this.node._getUITransformComp(); e ? (this._alignFlags |= t, i ? (this.isAlignHorizontalCenter = !1, this.isStretchWidth && (this._originalWidth = n.width)) : (this.isAlignVerticalCenter = !1, this.isStretchHeight && (this._originalHeight = n.height))) : (i ? this.isStretchWidth && (n.width = this._originalWidth) : this.isStretchHeight && (n.height = this._originalHeight), this._alignFlags &= ~t) } }, i._recursiveDirty = function () { this._dirty || (this._dirty = !0) }, n(e, [{ key: "target", get: function () { return this._target }, set: function (t) { this._target !== t && (this._unregisterTargetEvents(), this._target = t, this._registerTargetEvents(), this._validateTargetInDEV(), this._recursiveDirty()) } }, { key: "isAlignTop", get: function () { return (1 & this._alignFlags) > 0 }, set: function (t) { this._setAlign(1, t), this._recursiveDirty() } }, { key: "isAlignBottom", get: function () { return (4 & this._alignFlags) > 0 }, set: function (t) { this._setAlign(4, t), this._recursiveDirty() } }, { key: "isAlignLeft", get: function () { return (8 & this._alignFlags) > 0 }, set: function (t) { this._setAlign(8, t), this._recursiveDirty() } }, { key: "isAlignRight", get: function () { return (32 & this._alignFlags) > 0 }, set: function (t) { this._setAlign(32, t), this._recursiveDirty() } }, { key: "isAlignVerticalCenter", get: function () { return (2 & this._alignFlags) > 0 }, set: function (t) { t ? (this.isAlignTop = !1, this.isAlignBottom = !1, this._alignFlags |= 2) : this._alignFlags &= -3, this._recursiveDirty() } }, { key: "isAlignHorizontalCenter", get: function () { return (16 & this._alignFlags) > 0 }, set: function (t) { t ? (this.isAlignLeft = !1, this.isAlignRight = !1, this._alignFlags |= 16) : this._alignFlags &= -17, this._recursiveDirty() } }, { key: "isStretchWidth", get: function () { return !(40 & ~this._alignFlags) } }, { key: "isStretchHeight", get: function () { return !(5 & ~this._alignFlags) } }, { key: "top", get: function () { return this._top }, set: function (t) { this._top = t, this._recursiveDirty() } }, { key: "editorTop", get: function () { return this._isAbsTop ? this._top : 100 * this._top }, set: function (t) { this._top = this._isAbsTop ? t : t / 100, this._recursiveDirty() } }, { key: "bottom", get: function () { return this._bottom }, set: function (t) { this._bottom = t, this._recursiveDirty() } }, { key: "editorBottom", get: function () { return this._isAbsBottom ? this._bottom : 100 * this._bottom }, set: function (t) { this._bottom = this._isAbsBottom ? t : t / 100, this._recursiveDirty() } }, { key: "left", get: function () { return this._left }, set: function (t) { this._left = t, this._recursiveDirty() } }, { key: "editorLeft", get: function () { return this._isAbsLeft ? this._left : 100 * this._left }, set: function (t) { this._left = this._isAbsLeft ? t : t / 100, this._recursiveDirty() } }, { key: "right", get: function () { return this._right }, set: function (t) { this._right = t, this._recursiveDirty() } }, { key: "editorRight", get: function () { return this._isAbsRight ? this._right : 100 * this._right }, set: function (t) { this._right = this._isAbsRight ? t : t / 100, this._recursiveDirty() } }, { key: "horizontalCenter", get: function () { return this._horizontalCenter }, set: function (t) { this._horizontalCenter = t, this._recursiveDirty() } }, { key: "editorHorizontalCenter", get: function () { return this._isAbsHorizontalCenter ? this._horizontalCenter : 100 * this._horizontalCenter }, set: function (t) { this._horizontalCenter = this._isAbsHorizontalCenter ? t : t / 100, this._recursiveDirty() } }, { key: "verticalCenter", get: function () { return this._verticalCenter }, set: function (t) { this._verticalCenter = t, this._recursiveDirty() } }, { key: "editorVerticalCenter", get: function () { return this._isAbsVerticalCenter ? this._verticalCenter : 100 * this._verticalCenter }, set: function (t) { this._verticalCenter = this._isAbsVerticalCenter ? t : t / 100, this._recursiveDirty() } }, { key: "isAbsoluteTop", get: function () { return this._isAbsTop }, set: function (t) { this._isAbsTop !== t && (this._isAbsTop = t, this._autoChangedValue(1, this._isAbsTop)) } }, { key: "isAbsoluteBottom", get: function () { return this._isAbsBottom }, set: function (t) { this._isAbsBottom !== t && (this._isAbsBottom = t, this._autoChangedValue(4, this._isAbsBottom)) } }, { key: "isAbsoluteLeft", get: function () { return this._isAbsLeft }, set: function (t) { this._isAbsLeft !== t && (this._isAbsLeft = t, this._autoChangedValue(8, this._isAbsLeft)) } }, { key: "isAbsoluteRight", get: function () { return this._isAbsRight }, set: function (t) { this._isAbsRight !== t && (this._isAbsRight = t, this._autoChangedValue(32, this._isAbsRight)) } }, { key: "isAbsoluteHorizontalCenter", get: function () { return this._isAbsHorizontalCenter }, set: function (t) { this._isAbsHorizontalCenter !== t && (this._isAbsHorizontalCenter = t, this._autoChangedValue(16, this._isAbsHorizontalCenter)) } }, { key: "isAbsoluteVerticalCenter", get: function () { return this._isAbsVerticalCenter }, set: function (t) { this._isAbsVerticalCenter !== t && (this._isAbsVerticalCenter = t, this._autoChangedValue(2, this._isAbsVerticalCenter)) } }, { key: "alignMode", get: function () { return this._alignMode }, set: function (t) { this._alignMode = t, this._recursiveDirty() } }, { key: "alignFlags", get: function () { return this._alignFlags }, set: function (t) { this._alignFlags !== t && (this._alignFlags = t, this._recursiveDirty()) } }]), e }(am), h3.AlignMode = p3, m((W2 = h3).prototype, "target", [V2], Object.getOwnPropertyDescriptor(W2.prototype, "target"), W2.prototype), m(W2.prototype, "alignMode", [G2], Object.getOwnPropertyDescriptor(W2.prototype, "alignMode"), W2.prototype), j2 = Bu(W2.prototype, "_alignFlags", [eh], (function () { return 0 })), X2 = Bu(W2.prototype, "_target", [eh], (function () { return null })), q2 = Bu(W2.prototype, "_left", [eh], (function () { return 0 })), Y2 = Bu(W2.prototype, "_right", [eh], (function () { return 0 })), K2 = Bu(W2.prototype, "_top", [eh], (function () { return 0 })), Q2 = Bu(W2.prototype, "_bottom", [eh], (function () { return 0 })), Z2 = Bu(W2.prototype, "_horizontalCenter", [eh], (function () { return 0 })), J2 = Bu(W2.prototype, "_verticalCenter", [eh], (function () { return 0 })), $2 = Bu(W2.prototype, "_isAbsLeft", [eh], (function () { return !0 })), t3 = Bu(W2.prototype, "_isAbsRight", [eh], (function () { return !0 })), e3 = Bu(W2.prototype, "_isAbsTop", [eh], (function () { return !0 })), i3 = Bu(W2.prototype, "_isAbsBottom", [eh], (function () { return !0 })), n3 = Bu(W2.prototype, "_isAbsHorizontalCenter", [eh], (function () { return !0 })), r3 = Bu(W2.prototype, "_isAbsVerticalCenter", [eh], (function () { return !0 })), s3 = Bu(W2.prototype, "_originalWidth", [eh], (function () { return 0 })), a3 = Bu(W2.prototype, "_originalHeight", [eh], (function () { return 0 })), o3 = Bu(W2.prototype, "_alignMode", [eh], (function () { return 2 })), u3 = Bu(W2.prototype, "_lockFlags", [eh, nh], (function () { return 0 })), H2 = W2)) || H2) || H2) || H2); t({ Widget: C3, WidgetComponent: C3 }), S.internal.computeInverseTransForTarget = d3, S.internal.getReadonlyNodeSize = f3, S.Widget = C3; var D3 = new rr, R3 = { HORIZONTAL: 0, VERTICAL: 1 }; De(R3); var P3, B3, M3, O3, L3, F3, k3, N3, z3, U3, V3, G3, H3, W3, j3, X3, q3, Y3, K3, Q3, Z3, J3, $3, t4, e4 = (_3 = Gu("cc.PageViewIndicator"), g3 = Wu(110), m3 = Ih(vO), v3 = Ih(R3), y3 = Ih(us), _3(b3 = g3((E3 = function (t) { function e() { var e; return (e = t.call(this) || this).spacing = x3 && x3(), e._spriteFrame = S3 && S3(), e._direction = T3 && T3(), e._cellSize = I3 && I3(), e._layout = null, e._pageView = null, e._indicators = [], e } s(e, t); var i = e.prototype; return i.onLoad = function () { this._updateLayout() }, i.setPageView = function (t) { this._pageView = t, this._refresh() }, i._updateLayout = function () { this._layout = this.getComponent(J0), this._layout || (this._layout = this.addComponent(J0)); var t = this._layout; 0 === this.direction ? (t.type = 1, t.spacingX = this.spacing) : 1 === this.direction && (t.type = 2, t.spacingY = this.spacing), t.resizeMode = 1 }, i._createIndicator = function () { var t = new ky; t.layer = this.node.layer; var e = t.addComponent(iN); return e.spriteFrame = this.spriteFrame, e.sizeMode = 0, t.parent = this.node, t._getUITransformComp().setContentSize(this._cellSize), t }, i._changedState = function () { var t = this._indicators; if (0 !== t.length && this._pageView) { var e = this._pageView.curPageIdx; if (!(e >= t.length)) { for (var i = 0; i < t.length; ++i) { var n = t[i]; if (n._uiProps.uiComp) { var r = n._uiProps.uiComp; D3.set(r.color), D3.a = 127.5, r.color = D3 } } if (t[e]._uiProps.uiComp) { var s = t[e]._uiProps.uiComp; D3.set(s.color), D3.a = 255, s.color = D3 } } } }, i._refresh = function () { if (this._pageView) { var t = this._indicators, e = this._pageView.getPages(); if (e.length !== t.length) { var i = 0; if (e.length > t.length) for (i = 0; i < e.length; ++i)t[i] || (t[i] = this._createIndicator()); else for (i = t.length - e.length; i > 0; --i) { var n = t[i - 1]; this.node.removeChild(n), t.splice(i - 1, 1) } this._layout && this._layout.enabledInHierarchy && this._layout.updateLayout(), this._changedState() } } }, n(e, [{ key: "spriteFrame", get: function () { return this._spriteFrame }, set: function (t) { this._spriteFrame !== t && (this._spriteFrame = t) } }, { key: "direction", get: function () { return this._direction }, set: function (t) { this._direction !== t && (this._direction = t) } }, { key: "cellSize", get: function () { return this._cellSize }, set: function (t) { this._cellSize !== t && (this._cellSize = t) } }]), e }(am), E3.Direction = R3, m((w3 = E3).prototype, "spriteFrame", [m3], Object.getOwnPropertyDescriptor(w3.prototype, "spriteFrame"), w3.prototype), m(w3.prototype, "direction", [v3], Object.getOwnPropertyDescriptor(w3.prototype, "direction"), w3.prototype), m(w3.prototype, "cellSize", [y3], Object.getOwnPropertyDescriptor(w3.prototype, "cellSize"), w3.prototype), x3 = Bu(w3.prototype, "spacing", [eh], (function () { return 0 })), S3 = Bu(w3.prototype, "_spriteFrame", [eh], (function () { return null })), T3 = Bu(w3.prototype, "_direction", [eh], (function () { return 0 })), I3 = Bu(w3.prototype, "_cellSize", [eh], (function () { return new us(20, 20) })), b3 = w3)) || b3) || b3); t({ PageViewIndicator: e4, PageViewIndicatorComponent: e4 }), T.PageViewIndicator = e4; var i4 = new as, n4 = { Unified: 0, Free: 1 }; De(n4); var r4 = { HORIZONTAL: 0, VERTICAL: 1 }; De(r4); var s4 = (P3 = Gu("cc.PageView"), B3 = Wu(110), M3 = Ih(n4), O3 = Ih(r4), L3 = Ih(e4), F3 = Ih(x1), k3 = Ih(x1), N3 = Ih([rm]), z3 = Ih([rm]), P3(U3 = B3((t4 = function (t) { function e() { var e; return (e = t.call(this) || this).autoPageTurningThreshold = G3 && G3(), e.horizontal = H3 && H3(), e.vertical = W3 && W3(), e.cancelInnerEvents = j3 && j3(), e.scrollEvents = X3 && X3(), e.pageTurningSpeed = q3 && q3(), e.pageEvents = Y3 && Y3(), e._sizeMode = K3 && K3(), e._direction = Q3 && Q3(), e._scrollThreshold = Z3 && Z3(), e._pageTurningEventTiming = J3 && J3(), e._indicator = $3 && $3(), e._curPageIdx = 0, e._lastPageIdx = 0, e._pages = [], e._initContentPos = Qn(), e._scrollCenterOffsetX = [], e._scrollCenterOffsetY = [], e._touchBeganPosition = os(), e._touchEndPosition = os(), e } s(e, t); var i = e.prototype; return i.onEnable = function () { t.prototype.onEnable.call(this), this.node.on("size-changed", this._updateAllPagesSize, this), this.node.on(e.EventType.SCROLL_ENG_WITH_THRESHOLD, this._dispatchPageTurningEvent, this) }, i.onDisable = function () { t.prototype.onDisable.call(this), this.node.off("size-changed", this._updateAllPagesSize, this), this.node.off(e.EventType.SCROLL_ENG_WITH_THRESHOLD, this._dispatchPageTurningEvent, this) }, i.onLoad = function () { this._initPages(), this.indicator && this.indicator.setPageView(this) }, i.getCurrentPageIndex = function () { return this._curPageIdx }, i.setCurrentPageIndex = function (t) { this.scrollToPage(t, 1) }, i.getPages = function () { return this._pages }, i.addPage = function (t) { t && -1 === this._pages.indexOf(t) && this.content && (t._getUITransformComp() ? (this.content.addChild(t), this._pages.push(t), this._updatePageView()) : J(4301)) }, i.insertPage = function (t, e) { if (!(e < 0) && t && -1 === this._pages.indexOf(t) && this.content) if (e >= this._pages.length) this.addPage(t); else { if (!t._getUITransformComp()) return void J(4301); this._pages.splice(e, 0, t), this.content.insertChild(t, e), this._updatePageView() } }, i.removePage = function (t) { if (t && this.content) { var e = this._pages.indexOf(t); -1 !== e ? this.removePageAtIndex(e) : it(4300, t.name) } }, i.removePageAtIndex = function (t) { var e = this._pages; if (!(t < 0 || t >= e.length)) { var i = e[t]; i && this.content && (this.content.removeChild(i), e.splice(t, 1), this._updatePageView()) } }, i.removeAllPages = function () { if (this.content) { for (var t = this._pages, e = 0, i = t.length; e < i; e++)this.content.removeChild(t[e]); this._pages.length = 0, this._updatePageView() } }, i.scrollToPage = function (t, e) { void 0 === e && (e = .3), t < 0 || t >= this._pages.length || (this._curPageIdx = t, this.scrollToOffset(this._moveOffsetValue(t), e, !0), this.indicator && this.indicator._changedState()) }, i.getScrollEndedEventTiming = function () { return this.pageTurningEventTiming }, i._updatePageView = function () { if (this.content) { var t = this.content.getComponent(J0); t && t.enabled && t.updateLayout(); var e = this._pages.length; this._curPageIdx >= e && (this._curPageIdx = 0 === e ? 0 : e - 1, this._lastPageIdx = this._curPageIdx); for (var i = this._initContentPos, n = 0; n < e; ++n) { var r = this._pages[n].position; 0 === this.direction ? this._scrollCenterOffsetX[n] = Math.abs(i.x + r.x) : this._scrollCenterOffsetY[n] = Math.abs(i.y + r.y) } this.indicator && this.indicator._refresh() } }, i._updateAllPagesSize = function () { var t = this.view; if (this.content && t && 0 === this._sizeMode) for (var e = this._pages, i = t.contentSize, n = 0, r = e.length; n < r; n++)e[n]._getUITransformComp().setContentSize(i) }, i._handleReleaseLogic = function () { this._autoScrollToPage(), this._scrolling && (this._scrolling = !1, this._autoScrolling || this._dispatchEvent(e.EventType.SCROLL_ENDED)) }, i._onTouchBegan = function (e, i) { e.touch.getUILocation(i4), as.set(this._touchBeganPosition, i4.x, i4.y), t.prototype._onTouchBegan.call(this, e, i) }, i._onTouchMoved = function (e, i) { t.prototype._onTouchMoved.call(this, e, i) }, i._onTouchEnded = function (e, i) { e.touch.getUILocation(i4), as.set(this._touchEndPosition, i4.x, i4.y), t.prototype._onTouchEnded.call(this, e, i) }, i._onTouchCancelled = function (e, i) { e.touch.getUILocation(i4), as.set(this._touchEndPosition, i4.x, i4.y), t.prototype._onTouchCancelled.call(this, e, i) }, i._onMouseWheel = function () { }, i._syncScrollDirection = function () { this.horizontal = 0 === this.direction, this.vertical = 1 === this.direction }, i._syncSizeMode = function () { var t = this.view; if (this.content && t) { var e = this.content.getComponent(J0); if (e) { if (1 === this._sizeMode && this._pages.length > 0) { var i = this._pages[0]._getUITransformComp(), n = this._pages[this._pages.length - 1]._getUITransformComp(); 0 === this.direction ? (e.paddingLeft = (t.width - i.width) / 2, e.paddingRight = (t.width - n.width) / 2) : 1 === this.direction && (e.paddingTop = (t.height - i.height) / 2, e.paddingBottom = (t.height - n.height) / 2) } e.updateLayout() } } }, i._initPages = function () { if (this.content) { this._initContentPos = this.content.position; for (var t = this.content.children, e = 0; e < t.length; ++e) { var i = t[e]; this._pages.indexOf(i) >= 0 || this._pages.push(i) } this._syncScrollDirection(), this._syncSizeMode(), this._updatePageView() } }, i._dispatchPageTurningEvent = function () { this._lastPageIdx !== this._curPageIdx && (this._lastPageIdx = this._curPageIdx, rm.emitEvents(this.pageEvents, this, "page-turning"), this.node.emit("page-turning", this)) }, i._isQuicklyScrollable = function (t) { if (0 === this.direction) { if (Math.abs(t.x) > this.autoPageTurningThreshold) return !0 } else if (1 === this.direction && Math.abs(t.y) > this.autoPageTurningThreshold) return !0; return !1 }, i._moveOffsetValue = function (t) { var e = new as; if (1 === this._sizeMode) 0 === this.direction ? e.x = this._scrollCenterOffsetX[t] : 1 === this.direction && (e.y = this._scrollCenterOffsetY[t]); else { var i = this.view; if (!i) return e; 0 === this.direction ? e.x = t * i.width : 1 === this.direction && (e.y = t * i.height) } return e }, i._getDragDirection = function (t) { return 0 === this._direction ? 0 === t.x ? 0 : t.x > 0 ? 1 : -1 : 0 === t.y ? 0 : t.y < 0 ? 1 : -1 }, i._isScrollable = function (t, e, i) { if (1 === this._sizeMode) { var n = 0, r = 0; if (0 === this.direction) return n = this._scrollCenterOffsetX[e], r = this._scrollCenterOffsetX[i], Math.abs(t.x) >= Math.abs(n - r) * this.scrollThreshold; if (1 === this.direction) return n = this._scrollCenterOffsetY[e], r = this._scrollCenterOffsetY[i], Math.abs(t.y) >= Math.abs(n - r) * this.scrollThreshold } else { var s = this.view; if (!s) return !1; if (0 === this.direction) return Math.abs(t.x) >= s.width * this.scrollThreshold; if (1 === this.direction) return Math.abs(t.y) >= s.height * this.scrollThreshold } return !1 }, i._autoScrollToPage = function () { if (this._startBounceBackIfNeeded()) { var t = this._getHowMuchOutOfBoundary(); this._clampDelta(t), (t.x > 0 || t.y < 0) && (this._curPageIdx = 0 === this._pages.length ? 0 : this._pages.length - 1), (t.x < 0 || t.y > 0) && (this._curPageIdx = 0), this.indicator && this.indicator._changedState() } else { var e = new as; as.subtract(e, this._touchBeganPosition, this._touchEndPosition); var i = this._curPageIdx, n = i + this._getDragDirection(e), r = this.pageTurningSpeed * Math.abs(i - n); if (n < this._pages.length) { if (this._isScrollable(e, i, n)) return void this.scrollToPage(n, r); var s = this._calculateTouchMoveVelocity(); if (this._isQuicklyScrollable(s)) return void this.scrollToPage(n, r) } this.scrollToPage(i, r) } }, n(e, [{ key: "sizeMode", get: function () { return this._sizeMode }, set: function (t) { this._sizeMode !== t && (this._sizeMode = t, this._syncSizeMode()) } }, { key: "direction", get: function () { return this._direction }, set: function (t) { this._direction !== t && (this._direction = t, this._syncScrollDirection()) } }, { key: "scrollThreshold", get: function () { return this._scrollThreshold }, set: function (t) { this._scrollThreshold !== t && (this._scrollThreshold = t) } }, { key: "pageTurningEventTiming", get: function () { return this._pageTurningEventTiming }, set: function (t) { this._pageTurningEventTiming !== t && (this._pageTurningEventTiming = t) } }, { key: "indicator", get: function () { return this._indicator }, set: function (t) { this._indicator !== t && (this._indicator = t, this.indicator && this.indicator.setPageView(this)) } }, { key: "curPageIdx", get: function () { return this._curPageIdx } }, { key: "verticalScrollBar", get: function () { return t.prototype.verticalScrollBar }, set: function (t) { this.verticalScrollBar = t } }, { key: "horizontalScrollBar", get: function () { return t.prototype.horizontalScrollBar }, set: function (t) { this.horizontalScrollBar = t } }]), e }(p2), t4.SizeMode = n4, t4.Direction = r4, t4.EventType = D2({ PAGE_TURNING: "page-turning" }, d2), m((V3 = t4).prototype, "sizeMode", [M3], Object.getOwnPropertyDescriptor(V3.prototype, "sizeMode"), V3.prototype), m(V3.prototype, "direction", [O3], Object.getOwnPropertyDescriptor(V3.prototype, "direction"), V3.prototype), m(V3.prototype, "indicator", [L3], Object.getOwnPropertyDescriptor(V3.prototype, "indicator"), V3.prototype), G3 = Bu(V3.prototype, "autoPageTurningThreshold", [eh], (function () { return 100 })), m(V3.prototype, "verticalScrollBar", [F3, Oh], Object.getOwnPropertyDescriptor(V3.prototype, "verticalScrollBar"), V3.prototype), m(V3.prototype, "horizontalScrollBar", [k3, Oh], Object.getOwnPropertyDescriptor(V3.prototype, "horizontalScrollBar"), V3.prototype), H3 = Bu(V3.prototype, "horizontal", [Oh, eh], (function () { return !0 })), W3 = Bu(V3.prototype, "vertical", [Oh, eh], (function () { return !0 })), j3 = Bu(V3.prototype, "cancelInnerEvents", [Oh, eh], (function () { return !0 })), X3 = Bu(V3.prototype, "scrollEvents", [N3, eh, Oh], (function () { return [] })), q3 = Bu(V3.prototype, "pageTurningSpeed", [eh], (function () { return .3 })), Y3 = Bu(V3.prototype, "pageEvents", [z3, eh], (function () { return [] })), K3 = Bu(V3.prototype, "_sizeMode", [eh], (function () { return 0 })), Q3 = Bu(V3.prototype, "_direction", [eh], (function () { return 0 })), Z3 = Bu(V3.prototype, "_scrollThreshold", [eh], (function () { return .5 })), J3 = Bu(V3.prototype, "_pageTurningEventTiming", [eh], (function () { return .1 })), $3 = Bu(V3.prototype, "_indicator", [eh], (function () { return null })), U3 = V3)) || U3) || U3); t({ PageView: s4, PageViewComponent: s4 }), T.PageView = s4; var a4 = new Kn, o4 = new as, u4 = new as, h4 = new as(1, 1), c4 = new as, l4 = new as; function f4(t, e) { if (!e._hadAlignOnce) { 0 === e.alignMode && (e._hadAlignOnce = !0); var i, n = e.target, r = u4, s = h4; n ? d3(t, i = n, r, s) : i = t.parent; var a = f3(i), o = i instanceof hD || !i.getComponent(TF), u = o ? o4 : i.getComponent(TF).anchorPoint, h = o; t.getPosition(a4); var c = t._getUITransformComp(), l = a4.x, f = a4.y, d = c.anchorPoint, p = t.scale; if (56 & e.alignFlags) { var _ = 0, g = 0, m = a.width; h ? (_ = eu.left.x, g = eu.right.x) : g = (_ = -u.x * m) + m, _ += e.isAbsoluteLeft ? e.left : e.left * m, g -= e.isAbsoluteRight ? e.right : e.right * m, n && (_ += r.x, _ *= s.x, g += r.x, g *= s.x); var v = 0, y = d.x, b = p.x; if (b < 0 && (y = 1 - y, b = -b), e.isStretchWidth) v = g - _, 0 !== b && (c.width = v / b), l = _ + y * v; else { if (v = c.width * b, e.isAlignHorizontalCenter) { var w = e.isAbsoluteHorizontalCenter ? e.horizontalCenter : e.horizontalCenter * m, x = (.5 - u.x) * a.width; n && (w *= s.x, x += r.x, x *= s.x), l = x + (y - .5) * v + w } else l = e.isAlignLeft ? _ + y * v : g + (y - 1) * v; ji(b, 0, Hi) ? v = c.width : v /= b } e._lastSize.width = v } if (7 & e.alignFlags) { var S = 0, T = 0, I = a.height; h ? (T = eu.bottom.y, S = eu.top.y) : S = (T = -u.y * I) + I, T += e.isAbsoluteBottom ? e.bottom : e.bottom * I, S -= e.isAbsoluteTop ? e.top : e.top * I, n && (T += r.y, T *= s.y, S += r.y, S *= s.y); var E = 0, A = d.y, C = p.y; if (C < 0 && (A = 1 - A, C = -C), e.isStretchHeight) E = S - T, 0 !== C && (c.height = E / C), f = T + A * E; else { if (E = c.height * C, e.isAlignVerticalCenter) { var D = e.isAbsoluteVerticalCenter ? e.verticalCenter : e.verticalCenter * I, R = (.5 - u.y) * a.height; n && (D *= s.y, R += r.y, R *= s.y), f = R + (A - .5) * E + D } else f = e.isAlignBottom ? T + A * E : S + (A - 1) * E; ji(C, 0, Hi) ? E = c.height : E /= C } e._lastSize.height = E } t.setPosition(l, f, a4.z), Kn.set(e._lastPos, l, f, a4.z) } } function d4(t) { var e = t.getComponent(C3); if (e && e.enabled) { if (!S.isValid(t, !0)) return; v4.push(e) } for (var i, n = p(t.children); !(i = n()).done;) { var r = i.value; r.active && d4(r) } } function p4() { var t = yB.getScene(); if (t) { y4.isAligning = !0, y4._nodesOrderDirty && (v4.length = 0, d4(t), y4._nodesOrderDirty = !1); var e = null, i = y4._activeWidgetsIterator; for (i.i = 0; i.i < v4.length; ++i.i)(e = v4[i.i])._dirty && (f4(e.node, e), e._dirty = !1); y4.isAligning = !1 } } var _4, g4, m4, v4 = [], y4 = t("widgetManager", S._widgetManager = { isAligning: !1, _nodesOrderDirty: !1, _activeWidgetsIterator: new pe(v4), animationState: null, init: function () { yB.on("director_after_scene_launch", p4), yB.on("director_after_update", p4), $B.instance.on("design-resolution-changed", this.onResized, this); var t = this.onResized.bind(this); $B.instance.on("canvas-resize", t), Zo.on("window-resize", t) }, add: function () { this._nodesOrderDirty = !0 }, remove: function (t) { this._activeWidgetsIterator.remove(t) }, onResized: function () { var t = yB.getScene(); t && this.refreshWidgetOnResized(t) }, refreshWidgetOnResized: function (t) { var e = ky.isNode(t) && t.getComponent(C3); e && e.enabled && (2 === e.alignMode || 1 === e.alignMode) && e.setDirty(); for (var i, n = p(t.children); !(i = n()).done;) { var r = i.value; this.refreshWidgetOnResized(r) } }, updateOffsetsToStayPut: function (t, e) { function i(t, e) { return Math.abs(t - e) > 1e-10 ? e : t } var n = t.node, r = n.parent; if (r) { var s = c4; s.set(0, 0); var a = l4; if (a.set(1, 1), t.target && d3(n, r = t.target, s, a), !e) return; var o = r._uiProps && r._getUITransformComp(), u = o ? o.anchorPoint : o4, h = n._getUITransformComp(), c = f3(r), l = h.anchorPoint, f = n.position, d = A3, p = n.scale, _ = 0; if (e & d.LEFT) { var g = -u.x * c.width; g += s.x, g *= a.x, _ = f.x - l.x * h.width * Math.abs(p.x) - g, t.isAbsoluteLeft || (_ /= c.width), _ /= a.x, t.left = i(t.left, _) } if (e & d.RIGHT) { var m = (1 - u.x) * c.width; m += s.x, _ = (m *= a.x) - (f.x + (1 - l.x) * h.width * Math.abs(p.x)), t.isAbsoluteRight || (_ /= c.width), _ /= a.x, t.right = i(t.right, _) } if (e & d.TOP) { var v = (1 - u.y) * c.height; v += s.y, _ = (v *= a.y) - (f.y + (1 - l.y) * h.height * Math.abs(p.y)), t.isAbsoluteTop || (_ /= c.height), _ /= a.y, t.top = i(t.top, _) } if (e & d.BOT) { var y = -u.y * c.height; y += s.y, y *= a.y, _ = f.y - l.y * h.height * Math.abs(p.y) - y, t.isAbsoluteBottom || (_ /= c.height), _ /= a.y, t.bottom = i(t.bottom, _) } } }, updateAlignment: function t(e) { var i = e.parent; i && ky.isNode(i) && t(i); var n = e.getComponent(C3); n && i && f4(e, n) }, AlignMode: p3, AlignFlags: A3 }); yB.on("director_init", (function () { y4.init() })); var b4, w4, x4, S4, T4, I4, E4, A4, C4, D4, R4, P4, B4 = Gu("cc.SafeArea")(_4 = Wu(110)(_4 = Hu(C3)((g4 = function (t) { function e() { var e; return (e = t.call(this) || this)._symmetric = m4 && m4(), e } s(e, t); var i = e.prototype; return i.onEnable = function () { this.updateArea(), Zo.on("window-resize", this.updateArea, this), Zo.on("orientation-change", this.updateArea, this) }, i.onDisable = function () { Zo.off("window-resize", this.updateArea, this), Zo.off("orientation-change", this.updateArea, this) }, i.updateArea = function () { var t = this.node.getComponent(C3), e = this.node.getComponent(TF); if (t && e) { t.updateAlignment(); var i = this.node.position.clone(), n = e.anchorPoint.clone(); t.isAlignTop = t.isAlignBottom = t.isAlignLeft = t.isAlignRight = !0; var r = cM.getVisibleSize(), s = r.width, a = r.height, o = tu.getSafeAreaRect(this._symmetric); t.top = a - o.y - o.height, t.bottom = o.y, t.left = o.x, t.right = s - o.x - o.width, t.updateAlignment(); var u = this.node.position.clone(), h = n.x - (u.x - i.x) / e.width, c = n.y - (u.y - i.y) / e.height; e.setAnchorPoint(h, c), y4.add(t) } }, n(e, [{ key: "symmetric", get: function () { return this._symmetric }, set: function (t) { this._symmetric = t } }]), e }(am), m4 = Bu(g4.prototype, "_symmetric", [eh], (function () { return !0 })), _4 = g4)) || _4) || _4) || _4; t({ SafeArea: B4, SafeAreaComponent: B4 }), T.SafeArea = B4; var M4, O4 = (b4 = Gu("cc.UICoordinateTracker"), w4 = Wu(110), x4 = Ih(ky), S4 = Ih(gU), T4 = Ih([rm]), b4(I4 = w4((E4 = function (t) { function e() { var e; return (e = t.call(this) || this).syncEvents = A4 && A4(), e._target = C4 && C4(), e._camera = D4 && D4(), e._useScale = R4 && R4(), e._distance = P4 && P4(), e._transformPos = Qn(), e._viewPos = Qn(), e._canMove = !0, e._lastWPos = Qn(), e._lastCameraPos = Qn(), e } s(e, t); var i = e.prototype; return i.onEnable = function () { this._checkCanMove() }, i.update = function () { var t = this.node.worldPosition, e = this._camera; if (this._canMove && e && e.camera && (!this._lastWPos.equals(t) || !this._lastCameraPos.equals(e.node.worldPosition)) && (this._lastWPos.set(t), this._lastCameraPos.set(e.node.worldPosition), e.camera.update(), e.convertToUINode(t, this._target, this._transformPos), this._useScale && Kn.transformMat4(this._viewPos, this.node.worldPosition, e.camera.matView), this.syncEvents.length > 0)) { var i = this._distance / Math.abs(this._viewPos.z); rm.emitEvents(this.syncEvents, this._transformPos, i) } }, i._checkCanMove = function () { this._canMove = !(!this._camera || !this._target) }, n(e, [{ key: "target", get: function () { return this._target }, set: function (t) { this._target !== t && (this._target = t, this._checkCanMove()) } }, { key: "camera", get: function () { return this._camera }, set: function (t) { this._camera !== t && (this._camera = t, this._checkCanMove()) } }, { key: "useScale", get: function () { return this._useScale }, set: function (t) { this._useScale !== t && (this._useScale = t) } }, { key: "distance", get: function () { return this._distance }, set: function (t) { this._distance !== t && (this._distance = t) } }]), e }(am), m(E4.prototype, "target", [x4], Object.getOwnPropertyDescriptor(E4.prototype, "target"), E4.prototype), m(E4.prototype, "camera", [S4], Object.getOwnPropertyDescriptor(E4.prototype, "camera"), E4.prototype), A4 = Bu(E4.prototype, "syncEvents", [T4, eh], (function () { return [] })), C4 = Bu(E4.prototype, "_target", [eh], (function () { return null })), D4 = Bu(E4.prototype, "_camera", [eh], (function () { return null })), R4 = Bu(E4.prototype, "_useScale", [eh], (function () { return !0 })), P4 = Bu(E4.prototype, "_distance", [eh], (function () { return 1 })), I4 = E4)) || I4) || I4); t({ UICoordinateTracker: O4, UICoordinateTrackerComponent: O4 }); var L4 = ["touch-start", "touch-end", "touch-move", "mouse-down", "mouse-move", "mouse-up", "mouse-enter", "mouse-leave", "mouse-wheel"]; function F4(t) { t.propagationStopped = !0 } var k4, N4, z4, U4, V4 = Gu("cc.BlockInputEvents")(M4 = function (t) { function e() { return t.apply(this, arguments) || this } s(e, t); var i = e.prototype; return i.onEnable = function () { for (var t = 0; t < L4.length; t++)this.node.on(L4[t], F4, this) }, i.onDisable = function () { for (var t = 0; t < L4.length; t++)this.node.off(L4[t], F4, this) }, e }(am)) || M4; t({ BlockInputEvents: V4, BlockInputEventsComponent: V4 }); var G4, H4 = t("SubContextView", Gu("cc.SubContextView")(k4 = Wu(110)(k4 = Hu(TF)((N4 = function (t) { function e() { var e; return (e = t.call(this) || this)._fps = z4 && z4(), e._sprite = null, e._imageAsset = new Pg, e._texture = new bv, e._updatedTime = 0, e._updateInterval = 0, e._openDataContext = null, e._content = new ky("content"), e._designResolutionSize = U4 && U4(), e._content.hideFlags |= 1032, e._updatedTime = performance.now(), e } s(e, t); var i = e.prototype; return i.onLoad = function () { EO.getOpenDataContext ? (this._updateInterval = 1e3 / this._fps, this._openDataContext = EO.getOpenDataContext(), this._initSharedCanvas(), this._initContentNode(), this._updateSubContextView(), this._updateContentLayer()) : this.enabled = !1 }, i.onEnable = function () { this._registerNodeEvent() }, i.onDisable = function () { this._unregisterNodeEvent() }, i._initSharedCanvas = function () { if (this._openDataContext) { var t = this._openDataContext.canvas, e = this._designResolutionSize.width, i = this._designResolutionSize.height; t.width = e, t.height = i } }, i._initContentNode = function () { if (this._openDataContext) { var t = this._openDataContext.canvas, e = this._imageAsset; if (e.reset(t), this._texture.image = e, this._texture.create(t.width, t.height), this._sprite = this._content.getComponent(iN), this._sprite || (this._sprite = this._content.addComponent(iN)), this._sprite.spriteFrame) this._sprite.spriteFrame.texture = this._texture; else { var i = new vO; i.texture = this._texture, this._sprite.spriteFrame = i } this._content.parent = this.node } }, i._updateSubContextView = function () { if (this._openDataContext) { var t = this.node.getComponent(TF), e = this._content.getComponent(TF), i = t.width / e.width, n = t.height / e.height, r = i > n ? n : i; e.width *= r, e.height *= r; var s = cM.getViewportRect(), a = e.getBoundingBoxToWorld(), o = cM.getVisibleSize(), u = Zo.devicePixelRatio, h = (s.width * (a.x / o.width) + s.x) / u, c = (s.height * (a.y / o.height) + s.y) / u, l = s.width * (a.width / o.width) / u, f = s.height * (a.height / o.height) / u; this._openDataContext.postMessage({ fromEngine: !0, type: "engine", event: "viewport", x: h, y: c, width: l, height: f }) } }, i._updateSubContextTexture = function () { var t = this._imageAsset; if (t && this._openDataContext && !(t.width <= 0 || t.height <= 0)) { var e = this._openDataContext.canvas; t.reset(e), (e.width > t.width || e.height > t.height) && this._texture.create(e.width, e.height), this._texture.uploadData(e) } }, i._registerNodeEvent = function () { this.node.on("transform-changed", this._updateSubContextView, this), this.node.on("size-changed", this._updateSubContextView, this), this.node.on("layer-changed", this._updateContentLayer, this) }, i._unregisterNodeEvent = function () { this.node.off("transform-changed", this._updateSubContextView, this), this.node.off("size-changed", this._updateSubContextView, this), this.node.off("layer-changed", this._updateContentLayer, this) }, i._updateContentLayer = function () { this._content.layer = this.node.layer }, i.update = function (t) { void 0 === t ? this._updateSubContextTexture() : performance.now() - this._updatedTime >= this._updateInterval && (this._updatedTime += this._updateInterval, this._updateSubContextTexture()) }, i.onDestroy = function () { this._content.destroy(), this._texture.destroy(), this._sprite && this._sprite.destroy(), this._imageAsset.destroy(), this._openDataContext = null }, n(e, [{ key: "designResolutionSize", get: function () { return this._designResolutionSize }, set: function () { } }, { key: "fps", get: function () { return this._fps }, set: function (t) { this._fps !== t && (this._fps = t, this._updateInterval = 1e3 / t) } }]), e }(am), z4 = Bu(N4.prototype, "_fps", [eh], (function () { return 60 })), U4 = Bu(N4.prototype, "_designResolutionSize", [eh], (function () { return new us(640, 960) })), k4 = N4)) || k4) || k4) || k4); T.SubContextView = H4, St({ ButtonComponent: { newName: "Button", since: "1.2.0", removed: !1 }, EditBoxComponent: { newName: "EditBox", since: "1.2.0", removed: !1 }, LayoutComponent: { newName: "Layout", since: "1.2.0", removed: !1 }, ProgressBarComponent: { newName: "ProgressBar", since: "1.2.0", removed: !1 }, ScrollViewComponent: { newName: "ScrollView", since: "1.2.0", removed: !1 }, ScrollBarComponent: { newName: "ScrollBar", since: "1.2.0", removed: !1 }, SliderComponent: { newName: "Slider", since: "1.2.0", removed: !1 }, ToggleComponent: { newName: "Toggle", since: "1.2.0", removed: !1 }, ToggleContainerComponent: { newName: "ToggleContainer", since: "1.2.0", removed: !1 }, WidgetComponent: { newName: "Widget", since: "1.2.0", removed: !1 }, PageViewComponent: { newName: "PageView", since: "1.2.0", removed: !1 }, PageViewIndicatorComponent: { newName: "PageViewIndicator", since: "1.2.0", removed: !1 }, SafeAreaComponent: { newName: "SafeArea", since: "1.2.0", removed: !1 }, UICoordinateTrackerComponent: { newName: "UICoordinateTracker", since: "1.2.0", removed: !1 }, BlockInputEventsComponent: { newName: "BlockInputEvents", since: "1.2.0", removed: !1 } }); var W4 = t("UIReorderComponent", Gu("cc.UIReorderComponent")(G4 = function () { it(1408, "UIReorderComponent") }) || G4); T.UIReorderComponent = W4, T.ButtonComponent = _$, ae(_$, "cc.ButtonComponent"), T.EditBoxComponent = P0, ae(P0, "cc.EditBoxComponent"), T.LayoutComponent = J0, ae(J0, "cc.LayoutComponent"), T.ProgressBarComponent = d1, ae(d1, "cc.ProgressBarComponent"), T.ScrollViewComponent = p2, ae(p2, "cc.ScrollViewComponent"), T.ScrollBarComponent = x1, ae(x1, "cc.ScrollBarComponent"), T.SliderComponent = C2, ae(C2, "cc.SliderComponent"), T.ToggleComponent = k2, ae(k2, "cc.ToggleComponent"), T.ToggleContainerComponent = c3, ae(c3, "cc.ToggleContainerComponent"), T.WidgetComponent = C3, ae(C3, "cc.WidgetComponent"), T.PageViewComponent = s4, ae(s4, "cc.PageViewComponent"), T.PageViewIndicatorComponent = e4, ae(e4, "cc.PageViewIndicatorComponent"), T.SafeAreaComponent = B4, ae(B4, "cc.SafeAreaComponent"), ae(O4, "cc.UICoordinateTrackerComponent"), T.BlockInputEventsComponent = V4, ae(V4, "cc.BlockInputEventsComponent"), ft($B.prototype, "View.prototype", [{ name: "isAntiAliasEnabled", suggest: "The API of Texture2d have been largely modified, no alternative" }, { name: "enableAntiAlias", suggest: "The API of Texture2d have been largely modified, no alternative" }]), dt($B.prototype, "View.prototype", [{ name: "adjustViewportMeta" }, { name: "enableAutoFullScreen", suggest: "use screen.requestFullScreen() instead." }, { name: "isAutoFullScreenEnabled" }, { name: "setCanvasSize", suggest: "setting size in CSS pixels is not recommended, please use screen.windowSize instead." }, { name: "getCanvasSize", suggest: "please use screen.windowSize instead." }, { name: "getFrameSize", suggest: "getting size in CSS pixels is not recommended, please use screen.windowSize instead." }, { name: "setFrameSize", suggest: "setting size in CSS pixels is not recommended, please use screen.windowSize instead." }, { name: "getDevicePixelRatio", suggest: "use screen.devicePixelRatio instead." }, { name: "convertToLocationInView" }, { name: "enableRetina" }, { name: "isRetinaEnabled" }, { name: "setRealPixelResolution" }]); var j4 = function (t) { function e() { var e; return (e = t.call(this) || this)._gpuDescriptorSet = null, e } s(e, t); var i = e.prototype; return i.initialize = function (t) { this._layout = t.layout; var e = t.layout.getGpuDescriptorSetLayout(), i = e.bindings, n = e.descriptorIndices, r = e.descriptorCount; this._buffers = Array(r).fill(null), this._textures = Array(r).fill(null), this._samplers = Array(r).fill(null); var s = []; this._gpuDescriptorSet = { gpuDescriptors: s, descriptorIndices: n }; for (var a = 0; a < i.length; ++a)for (var o = i[a], u = 0; u < o.count; u++) { var h = { type: o.descriptorType, gpuBuffer: null, gpuTextureView: null, gpuSampler: null }; s.push(h) } }, i.destroy = function () { this._layout = null, this._gpuDescriptorSet = null }, i.update = function () { if (this._isDirty && this._gpuDescriptorSet) { for (var t = this._gpuDescriptorSet.gpuDescriptors, e = 0; e < t.length; ++e)t[e].type & jp ? this._buffers[e] && (t[e].gpuBuffer = this._buffers[e].getGpuBuffer()) : t[e].type & Xp && (this._textures[e] && (t[e].gpuTextureView = this._textures[e].gpuTextureView), this._samplers[e] && (t[e].gpuSampler = this._samplers[e].gpuSampler)); this._isDirty = !1 } }, n(e, [{ key: "gpuDescriptorSet", get: function () { return this._gpuDescriptorSet } }]), e }(c_), X4 = [10497, 33648, 33071, 33071], q4 = new Float32Array(4), Y4 = Math.max, K4 = Math.min; function Q4(t) { switch (t) { case 4: case 6: case 14: case 16: case 24: case 25: case 27: case 36: case 35: case 37: case 39: case 56: case 58: case 60: case 61: case 62: case 63: case 64: case 66: case 70: case 71: case 72: case 73: case 74: case 75: case 76: case 79: case 81: case 83: case 84: case 85: case 86: case 87: case 88: case 89: case 90: case 91: case 92: case 93: case 94: case 95: case 96: case 97: case 98: case 99: case 100: case 101: case 102: case 103: case 104: case 105: case 106: case 107: case 108: case 109: case 110: case 111: case 112: case 113: case 114: case 115: case 116: default: return 5121; case 5: case 7: case 15: case 17: case 26: case 28: case 38: case 40: case 65: case 67: case 80: case 82: return 5120; case 8: case 18: case 29: case 41: return 5131; case 9: case 19: case 30: case 42: return 5123; case 10: case 20: case 31: case 43: return 5122; case 11: case 21: case 32: case 44: case 53: case 54: case 69: case 68: return 5126; case 12: case 22: case 33: case 45: return 5125; case 13: case 23: case 34: case 46: return 5124; case 47: return 33635; case 48: return 35899; case 49: return 32820; case 50: return 32819; case 51: case 52: return 33640; case 55: return 34042 } } function Z4(t) { switch (t) { case 1: return 6406; case 2: return 6409; case 3: return 6410; case 4: return 33321; case 5: return 36756; case 6: return 33330; case 7: return 33329; case 14: return 33323; case 15: return 36757; case 16: return 33336; case 17: return 33335; case 24: return 32849; case 26: return 36758; case 27: return 36221; case 28: return 36239; case 36: case 35: return 32856; case 38: return 36759; case 39: return 36220; case 40: return 36238; case 10: return 33331; case 9: return 33332; case 8: return 33325; case 20: return 33337; case 19: return 33338; case 18: return 33327; case 31: return 36233; case 30: return 36215; case 29: return 34843; case 43: return 36232; case 42: return 36214; case 41: return 34842; case 13: return 33333; case 12: return 33334; case 11: return 33326; case 23: return 33339; case 22: return 33340; case 21: return 33328; case 34: return 36227; case 33: return 36209; case 32: return 34837; case 46: return 36226; case 45: return 36208; case 44: return 34836; case 47: return 36194; case 49: return 32855; case 50: return 32854; case 25: return 35905; case 37: return 35907; case 51: return 32857; case 52: return 36975; case 48: return 35898; case 54: return 36012; case 55: return 35056; case 56: return 33776; case 57: return 33777; case 58: return 35916; case 59: return 35917; case 60: return 33778; case 61: return 35918; case 62: return 33779; case 63: return 35919; case 72: return 36196; case 73: return 37492; case 74: return 37493; case 75: return 37494; case 76: return 37495; case 77: return 37496; case 78: return 37497; case 79: return 37488; case 80: return 37489; case 81: return 37490; case 82: return 37491; case 83: return 35841; case 84: return 35843; case 85: return 35840; case 86: return 35842; case 89: return 37808; case 90: return 37809; case 91: return 37810; case 92: return 37811; case 93: return 37812; case 94: return 37813; case 95: return 37814; case 96: return 37815; case 97: return 37816; case 98: return 37817; case 99: return 37818; case 100: return 37819; case 101: return 37820; case 102: return 37821; case 103: return 37840; case 104: return 37841; case 105: return 37842; case 106: return 37843; case 107: return 37844; case 108: return 37845; case 109: return 37846; case 110: return 37847; case 111: return 37848; case 112: return 37849; case 113: return 37850; case 114: return 37851; case 115: return 37852; case 116: return 37853; default: return rt(16309), 6408 } } function J4(t) { switch (t) { case 1: return 6406; case 2: return 6409; case 3: return 6410; case 4: case 5: case 6: case 7: case 9: case 10: case 8: case 12: case 13: case 11: return 6403; case 14: case 15: case 16: case 17: case 19: case 20: case 18: case 22: case 23: case 21: return 33319; case 24: case 26: case 27: case 28: case 30: case 31: case 29: case 33: case 34: case 32: case 48: case 47: case 25: return 6407; case 36: case 35: case 38: case 39: case 40: case 42: case 43: case 41: case 45: case 46: case 44: case 51: case 49: case 50: case 37: return 6408; case 54: return 6402; case 55: return 34041; case 56: return 33776; case 57: return 33777; case 58: return 35916; case 59: return 35917; case 60: return 33778; case 61: return 35918; case 62: return 33779; case 63: return 35919; case 72: return 36196; case 73: return 37492; case 74: return 37493; case 75: return 37494; case 76: return 37495; case 77: return 37496; case 78: return 37497; case 79: return 37488; case 80: return 37489; case 81: return 37490; case 82: return 37491; case 83: return 35841; case 84: return 35843; case 85: return 35840; case 86: return 35842; case 89: return 37808; case 90: return 37809; case 91: return 37810; case 92: return 37811; case 93: return 37812; case 94: return 37813; case 95: return 37814; case 96: return 37815; case 97: return 37816; case 98: return 37817; case 99: return 37818; case 100: return 37819; case 101: return 37820; case 102: return 37821; case 103: return 37840; case 104: return 37841; case 105: return 37842; case 106: return 37843; case 107: return 37844; case 108: return 37845; case 109: return 37846; case 110: return 37847; case 111: return 37848; case 112: return 37849; case 113: return 37850; case 114: return 37851; case 115: return 37852; case 116: return 37853; default: return rt(16310), 6408 } } function $4(t) { switch (t) { case 1: return 35670; case 2: return 35671; case 3: return 35672; case 4: return 35673; case 5: return 5124; case 6: return 35667; case 7: return 35668; case 8: return 35669; case 9: return 5125; case 13: return 5126; case 14: return 35664; case 15: return 35665; case 16: return 35666; case 17: return 35674; case 18: return 35685; case 19: return 35686; case 20: return 35687; case 21: return 35675; case 22: return 35688; case 23: return 35689; case 24: return 35690; case 25: return 35676; case 28: return 35678; case 29: return 36289; case 30: return 35679; case 31: return 35680; default: return rt(16311), 0 } } function t5(t) { switch (t) { case 35670: return 1; case 35671: return 2; case 35672: return 3; case 35673: return 4; case 5124: return 5; case 35667: return 6; case 35668: return 7; case 35669: return 8; case 5125: return 9; case 36294: return 10; case 36295: return 11; case 36296: return 12; case 5126: return 13; case 35664: return 14; case 35665: return 15; case 35666: return 16; case 35674: return 17; case 35685: return 18; case 35686: return 19; case 35687: return 20; case 35675: return 21; case 35688: return 22; case 35689: return 23; case 35690: return 24; case 35676: return 25; case 35678: return 28; case 36289: return 29; case 35679: return 30; case 35680: return 31; default: return rt(16313), 0 } } function e5(t) { switch (t) { case 35670: case 5124: case 5125: case 5126: case 35678: case 36289: case 36292: case 35679: case 35680: case 36298: case 36303: case 36299: case 36300: case 36306: case 36311: case 36307: case 36308: return 4; case 35671: case 35667: case 36294: case 35664: return 8; case 35672: case 35668: case 36295: case 35665: return 12; case 35673: case 35669: case 36296: case 35666: case 35674: return 16; case 35685: case 35687: return 24; case 35686: case 35689: return 32; case 35675: return 36; case 35688: case 35690: return 48; case 35676: return 64; default: return rt(16314), 0 } } function i5(t) { switch (t) { case 35674: case 35685: case 35686: return 2; case 35687: case 35675: case 35688: return 3; case 35689: case 35690: case 35676: return 4; default: return 1 } } var n5 = [512, 513, 514, 515, 516, 517, 518, 519], r5 = [0, 7680, 7681, 7682, 7683, 5386, 34055, 34056], s5 = [32774, 32778, 32779, 32775, 32776], a5 = [0, 1, 770, 772, 771, 773, 768, 774, 769, 775, 776, 32769, 32770, 32771, 32772]; function o5(t, e) { var i = t.gl, n = t.getStateCache(), r = 2 & e.memUsage ? 35048 : 35044; if (8 & e.usage) { e.glTarget = 34962; var s = i.createBuffer(); s && (e.glBuffer = s, e.size > 0 && (t.extensions.useVAO && n.glVAO && (i.bindVertexArray(null), n.glVAO = null), w5.gpuInputAssembler = null, n.glArrayBuffer !== e.glBuffer && (i.bindBuffer(34962, e.glBuffer), n.glArrayBuffer = e.glBuffer), i.bufferData(34962, e.size, r), i.bindBuffer(34962, null), n.glArrayBuffer = null)) } else if (4 & e.usage) { e.glTarget = 34963; var a = i.createBuffer(); a && (e.glBuffer = a, e.size > 0 && (t.extensions.useVAO && n.glVAO && (i.bindVertexArray(null), n.glVAO = null), w5.gpuInputAssembler = null, n.glElementArrayBuffer !== e.glBuffer && (i.bindBuffer(34963, e.glBuffer), n.glElementArrayBuffer = e.glBuffer), i.bufferData(34963, e.size, r), i.bindBuffer(34963, null), n.glElementArrayBuffer = null)) } else if (16 & e.usage) { e.glTarget = 35345; var o = i.createBuffer(); o && e.size > 0 && (e.glBuffer = o, n.glUniformBuffer !== e.glBuffer && (i.bindBuffer(35345, e.glBuffer), n.glUniformBuffer = e.glBuffer), i.bufferData(35345, e.size, r), i.bindBuffer(35345, null), n.glUniformBuffer = null) } else 64 & e.usage || 2 & e.usage || 1 & e.usage || rt(16315), e.glTarget = 0 } function u5(t, e) { var i = t.gl, n = t.getStateCache(), r = t.extensions.useVAO; if (e.glBuffer) { switch (e.glTarget) { case 34962: r && n.glVAO && (i.bindVertexArray(null), n.glVAO = null), w5.gpuInputAssembler = null, i.bindBuffer(34962, null), n.glArrayBuffer = null; break; case 34963: r && n.glVAO && (i.bindVertexArray(null), n.glVAO = null), w5.gpuInputAssembler = null, i.bindBuffer(34963, null), n.glElementArrayBuffer = null; break; case 35345: i.bindBuffer(35345, null), n.glUniformBuffer = null }i.deleteBuffer(e.glBuffer), e.glBuffer = null } } function h5(t, e) { var i = t.gl, n = t.getStateCache(), r = 2 & e.memUsage ? 35048 : 35044; 8 & e.usage ? (t.extensions.useVAO && n.glVAO && (i.bindVertexArray(null), n.glVAO = null), w5.gpuInputAssembler = null, n.glArrayBuffer !== e.glBuffer && i.bindBuffer(34962, e.glBuffer), e.buffer ? i.bufferData(34962, e.buffer, r) : i.bufferData(34962, e.size, r), i.bindBuffer(34962, null), n.glArrayBuffer = null) : 4 & e.usage ? (t.extensions.useVAO && n.glVAO && (i.bindVertexArray(null), n.glVAO = null), w5.gpuInputAssembler = null, n.glElementArrayBuffer !== e.glBuffer && i.bindBuffer(34963, e.glBuffer), e.buffer ? i.bufferData(34963, e.buffer, r) : i.bufferData(34963, e.size, r), i.bindBuffer(34963, null), n.glElementArrayBuffer = null) : 16 & e.usage ? (n.glUniformBuffer !== e.glBuffer && i.bindBuffer(35345, e.glBuffer), i.bufferData(35345, e.size, r), i.bindBuffer(35345, null), n.glUniformBuffer = null) : (64 & e.usage || 2 & e.usage || 1 & e.usage || rt(16315), e.glTarget = 0) } function c5(t, e, i, n, r) { if (64 & e.usage) { e.indirects.clearDraws(); for (var s = i.drawInfos, a = 0; a < s.length; ++a)e.indirects.setDrawInfo(n + a, s[a]) } else { var o = i, u = t.gl, h = t.getStateCache(); switch (e.glTarget) { case 34962: t.extensions.useVAO && h.glVAO && (u.bindVertexArray(null), h.glVAO = null), w5.gpuInputAssembler = null, h.glArrayBuffer !== e.glBuffer && (u.bindBuffer(34962, e.glBuffer), h.glArrayBuffer = e.glBuffer), Ro.os === Io.IOS && 2 & e.memUsage && 0 === n && r === o.byteLength ? u.bufferData(e.glTarget, o, u.DYNAMIC_DRAW) : r === o.byteLength ? u.bufferSubData(e.glTarget, n, o) : u.bufferSubData(e.glTarget, n, o.slice(0, r)); break; case 34963: t.extensions.useVAO && h.glVAO && (u.bindVertexArray(null), h.glVAO = null), w5.gpuInputAssembler = null, h.glElementArrayBuffer !== e.glBuffer && (u.bindBuffer(34963, e.glBuffer), h.glElementArrayBuffer = e.glBuffer), Ro.os === Io.IOS && 2 & e.memUsage && 0 === n && r === o.byteLength ? u.bufferData(e.glTarget, o, u.DYNAMIC_DRAW) : r === o.byteLength ? u.bufferSubData(e.glTarget, n, o) : u.bufferSubData(e.glTarget, n, o.slice(0, r)); break; case 35345: h.glUniformBuffer !== e.glBuffer && (u.bindBuffer(35345, e.glBuffer), h.glUniformBuffer = e.glBuffer), Ro.os === Io.IOS && 2 & e.memUsage && 0 === n && r === o.byteLength ? u.bufferData(e.glTarget, o, u.DYNAMIC_DRAW) : r === o.byteLength ? u.bufferSubData(e.glTarget, n, o) : u.bufferSubData(e.glTarget, n, new Float32Array(o, 0, r / 4)); break; default: rt(16316) } } } function l5(t, e) { var i = t.gl, n = t.getStateCache(), r = t.capabilities; e.glInternalFmt = Z4(e.format), e.glFormat = J4(e.format), e.glType = Q4(e.format); var s = e.width, a = e.height, o = e.depth, u = e.arrayLayer; switch (e.type) { case 1: e.glTarget = 3553; var h = Y4(s, a); if (h > r.maxTextureSize && rt(9100, h, r.maxTextureSize), 1 === e.samples) { if (e.glTexture = i.createTexture(), e.size > 0) { var c = n.glTexUnits[n.texUnit]; if (c.glTexture !== e.glTexture && (i.bindTexture(3553, e.glTexture), c.glTexture = e.glTexture), Wp[e.format].isCompressed) for (var l = 0; l < e.mipLevel; ++l) { var f = Kp(e.format, s, a, 1), d = new Uint8Array(f); i.compressedTexImage2D(3553, l, e.glInternalFmt, s, a, 0, d), s = Y4(1, s >> 1), a = Y4(1, a >> 1) } else 128 & e.flags ? i.texImage2D(3553, 0, e.glInternalFmt, s, a, 0, e.glFormat, e.glType, null) : i.texStorage2D(3553, e.mipLevel, e.glInternalFmt, s, a) } } else e.glRenderbuffer = i.createRenderbuffer(), e.size > 0 && (n.glRenderbuffer !== e.glRenderbuffer && (i.bindRenderbuffer(36161, e.glRenderbuffer), n.glRenderbuffer = e.glRenderbuffer), i.renderbufferStorageMultisample(36161, e.samples, e.glInternalFmt, e.width, e.height)); break; case 5: e.glTarget = 35866; var p = Y4(s, a); if (p > r.maxTextureSize && rt(9100, p, r.maxTextureSize), u > r.maxArrayTextureLayers && rt(9100, u, r.maxArrayTextureLayers), e.glTexture = i.createTexture(), e.size > 0) { var _ = n.glTexUnits[n.texUnit]; if (_.glTexture !== e.glTexture && (i.bindTexture(35866, e.glTexture), _.glTexture = e.glTexture), Wp[e.format].isCompressed) for (var g = 0; g < e.mipLevel; ++g) { var m = Kp(e.format, s, a, u), v = new Uint8Array(m); i.compressedTexImage3D(35866, g, e.glInternalFmt, s, a, u, 0, v), s = Y4(1, s >> 1), a = Y4(1, a >> 1) } else i.texStorage3D(35866, e.mipLevel, e.glInternalFmt, s, a, u) } break; case 2: e.glTarget = 32879; var y = Y4(Y4(s, a), o); if (y > r.max3DTextureSize && rt(9100, y, r.max3DTextureSize), e.glTexture = i.createTexture(), e.size > 0) { var b = n.glTexUnits[n.texUnit]; if (b.glTexture !== e.glTexture && (i.bindTexture(32879, e.glTexture), b.glTexture = e.glTexture), Wp[e.format].isCompressed) for (var w = 0; w < e.mipLevel; ++w) { var x = Kp(e.format, s, a, o), S = new Uint8Array(x); i.compressedTexImage3D(32879, w, e.glInternalFmt, s, a, o, 0, S), s = Y4(1, s >> 1), a = Y4(1, a >> 1) } else i.texStorage3D(32879, e.mipLevel, e.glInternalFmt, s, a, o) } break; case 3: e.glTarget = 34067; var T = Y4(s, a); if (T > r.maxCubeMapTextureSize && rt(9100, T, r.maxTextureSize), e.glTexture = i.createTexture(), e.size > 0) { var I = n.glTexUnits[n.texUnit]; if (I.glTexture !== e.glTexture && (i.bindTexture(34067, e.glTexture), I.glTexture = e.glTexture), Wp[e.format].isCompressed) for (var E = 0; E < e.mipLevel; ++E) { for (var A = Kp(e.format, s, a, 1), C = new Uint8Array(A), D = 0; D < 6; ++D)i.compressedTexImage2D(34069 + D, E, e.glInternalFmt, s, a, 0, C); s = Y4(1, s >> 1), a = Y4(1, a >> 1) } else i.texStorage2D(34067, e.mipLevel, e.glInternalFmt, s, a) } break; default: rt(16317), e.type = 1, e.glTarget = 3553 } } function f5(t, e) { var i = t.gl, n = t.getStateCache(); if (e.glTexture) { var r = n.glTexUnits, s = n.texUnit; i.deleteTexture(e.glTexture); for (var a = 0; a < r.length; ++a)r[a].glTexture === e.glTexture && (i.activeTexture(33984 + a), s = a, i.bindTexture(e.glTarget, null), r[a].glTexture = null); n.texUnit = s, e.glTexture = null } if (e.glRenderbuffer) { var o = n.glRenderbuffer; i.deleteRenderbuffer(e.glRenderbuffer), o === e.glRenderbuffer && (i.bindRenderbuffer(36161, null), n.glRenderbuffer = null), e.glRenderbuffer = null } } function d5(t, e) { if (e.size) { var i = t.gl, n = t.getStateCache(), r = t.capabilities, s = e.width, a = e.height, o = e.depth, u = e.arrayLayer; switch (e.type) { case 1: e.glTarget = 3553; var h = Y4(s, a); if (h > r.maxTextureSize && rt(9100, h, r.maxTextureSize), 1 === e.samples) { var c = n.glTexUnits[n.texUnit]; if (c.glTexture !== e.glTexture && (i.bindTexture(3553, e.glTexture), c.glTexture = e.glTexture), Wp[e.format].isCompressed) for (var l = 0; l < e.mipLevel; ++l) { var f = Kp(e.format, s, a, 1), d = new Uint8Array(f); i.compressedTexImage2D(3553, l, e.glInternalFmt, s, a, 0, d), s = Y4(1, s >> 1), a = Y4(1, a >> 1) } else f5(t, e), l5(t, e) } else e.glRenderbuffer && (n.glRenderbuffer !== e.glRenderbuffer && (i.bindRenderbuffer(36161, e.glRenderbuffer), n.glRenderbuffer = e.glRenderbuffer), i.renderbufferStorageMultisample(36161, e.samples, e.glInternalFmt, e.width, e.height)); break; case 5: e.glTarget = 35866; var p = Y4(s, a); if (p > r.maxTextureSize && rt(9100, p, r.maxTextureSize), u > r.maxArrayTextureLayers && rt(9100, u, r.maxArrayTextureLayers), e.glTexture = i.createTexture(), e.size > 0) { var _ = n.glTexUnits[n.texUnit]; if (_.glTexture !== e.glTexture && (i.bindTexture(35866, e.glTexture), _.glTexture = e.glTexture), Wp[e.format].isCompressed) for (var g = 0; g < e.mipLevel; ++g) { var m = Kp(e.format, s, a, u), v = new Uint8Array(m); i.compressedTexImage3D(35866, g, e.glInternalFmt, s, a, u, 0, v), s = Y4(1, s >> 1), a = Y4(1, a >> 1) } else i.texStorage3D(35866, e.mipLevel, e.glInternalFmt, s, a, u) } break; case 2: e.glTarget = 32879; var y = Y4(Y4(s, a), o); if (y > r.max3DTextureSize && rt(9100, y, r.max3DTextureSize), e.glTexture = i.createTexture(), e.size > 0) { var b = n.glTexUnits[n.texUnit]; if (b.glTexture !== e.glTexture && (i.bindTexture(32879, e.glTexture), b.glTexture = e.glTexture), Wp[e.format].isCompressed) for (var w = 0; w < e.mipLevel; ++w) { var x = Kp(e.format, s, a, o), S = new Uint8Array(x); i.compressedTexImage3D(32879, w, e.glInternalFmt, s, a, o, 0, S), s = Y4(1, s >> 1), a = Y4(1, a >> 1) } else i.texStorage3D(32879, e.mipLevel, e.glInternalFmt, s, a, o) } break; case 3: e.type = 3, e.glTarget = 34067; var T = Y4(s, a); T > r.maxCubeMapTextureSize && rt(9100, T, r.maxTextureSize); var I = n.glTexUnits[n.texUnit]; if (I.glTexture !== e.glTexture && (i.bindTexture(34067, e.glTexture), I.glTexture = e.glTexture), Wp[e.format].isCompressed) for (var E = 0; E < 6; ++E) { s = e.width, a = e.height; for (var A = 0; A < e.mipLevel; ++A) { var C = Kp(e.format, s, a, 1), D = new Uint8Array(C); i.compressedTexImage2D(34069 + E, A, e.glInternalFmt, s, a, 0, D), s = Y4(1, s >> 1), a = Y4(1, a >> 1) } } else f5(t, e), l5(t, e); break; default: rt(16317), e.type = 1, e.glTarget = 3553 } } } function p5(t, e) { for (var i = t.gl, n = e.glSamplers.values().next(); !n.done;) { i.deleteSampler(n.value); for (var r = t.getStateCache().glSamplerUnits, s = 0; s < r.length; ++s)r[s] === n.value && (i.bindSampler(s, null), r[s] = null) } e.glSamplers.clear() } function _5(t, e) { for (var i = t.getStateCache(), n = 0; n < e.gpuColorViews.length; ++n)if (e.gpuColorViews[n].gpuTexture.isSwapchainTexture) return void (e.isOffscreen = !1); var r = t.gl, s = [], a = r.createFramebuffer(); if (a) { e.glFramebuffer = a, i.glFramebuffer !== e.glFramebuffer && r.bindFramebuffer(36160, e.glFramebuffer); for (var o = 0; o < e.gpuColorViews.length; ++o) { var u = e.gpuColorViews[o], h = u.gpuTexture; h && (h.glTexture ? r.framebufferTexture2D(36160, 36064 + o, h.glTarget, h.glTexture, u.baseLevel) : r.framebufferRenderbuffer(36160, 36064 + o, 36161, h.glRenderbuffer), s.push(36064 + o), e.width = K4(e.width, h.width >> u.baseLevel), e.height = K4(e.height, h.height >> u.baseLevel)) } var c = e.gpuDepthStencilView; if (c) { var l = c.gpuTexture, f = Wp[l.format].hasStencil ? 33306 : 36096; l.glTexture ? r.framebufferTexture2D(36160, f, l.glTarget, l.glTexture, e.gpuDepthStencilView.baseLevel) : r.framebufferRenderbuffer(36160, f, 36161, l.glRenderbuffer), e.width = K4(e.width, l.width >> c.baseLevel), e.height = K4(e.height, l.height >> c.baseLevel) } r.drawBuffers(s); var d = r.checkFramebufferStatus(36160); if (36053 !== d) switch (d) { case 36054: rt(16318); break; case 36055: rt(16319); break; case 36057: rt(16320); break; case 36061: rt(16321) }i.glFramebuffer !== e.glFramebuffer && r.bindFramebuffer(36160, i.glFramebuffer) } } function g5(t, e) { var i = t.gl, n = t.getStateCache(); e.glFramebuffer && (i.deleteFramebuffer(e.glFramebuffer), n.glFramebuffer === e.glFramebuffer && (i.bindFramebuffer(36160, null), n.glFramebuffer = null), e.glFramebuffer = null) } function m5(t, e) { for (var i, n = t.gl, r = t.getStateCache(), s = t.capabilities, a = function () { var t = e.gpuStages[o], i = 0, r = "", s = 1; switch (t.type) { case 1: r = "VertexShader", i = 35633; break; case 16: r = "FragmentShader", i = 35632; break; default: return rt(16322), { v: void 0 } }var a = n.createShader(i); if (a && (t.glShader = a, n.shaderSource(t.glShader, "#version 300 es\n" + t.source), n.compileShader(t.glShader), !n.getShaderParameter(t.glShader, 35713))) { rt(16323, r, e.name), rt(16324, t.source.replace(/^|\n/g, (function () { return "\n" + s++ + " " }))), j(n.getShaderInfoLog(t.glShader)); for (var u = 0; u < e.gpuStages.length; u++) { var h = e.gpuStages[o]; h.glShader && (n.deleteShader(h.glShader), h.glShader = null) } return { v: void 0 } } }, o = 0; o < e.gpuStages.length; o++)if (i = a()) return i.v; var u = n.createProgram(); if (u) { e.glProgram = u; for (var h = !(!S.rendering || !S.rendering.enableEffectImport), c = 0; c < e.gpuStages.length; c++) { var l = e.gpuStages[c]; n.attachShader(e.glProgram, l.glShader) } n.linkProgram(e.glProgram); for (var f = 0; f < e.gpuStages.length; f++) { var d = e.gpuStages[f]; d.glShader && (n.detachShader(e.glProgram, d.glShader), n.deleteShader(d.glShader), d.glShader = null) } if (!n.getProgramParameter(e.glProgram, 35714)) return rt(16326, e.name), void j(n.getProgramInfoLog(e.glProgram)); tt(16325, e.name); var p = n.getProgramParameter(e.glProgram, 35721); e.glInputs = new Array(p); for (var _ = 0; _ < p; ++_) { var g = n.getActiveAttrib(e.glProgram, _); if (g) { var m, v = g.name.indexOf("["); m = -1 !== v ? g.name.substring(0, v) : g.name; var y = n.getAttribLocation(e.glProgram, m), b = t5(g.type), w = e5(g.type); e.glInputs[_] = { name: m, type: b, stride: w, count: g.size, size: w * g.size, glType: g.type, glLoc: y } } } var x, T, I, E, A = n.getProgramParameter(e.glProgram, 35382); if (A) { e.glBlocks = new Array(A); for (var C = 0; C < A; ++C) { var D = (x = n.getActiveUniformBlockName(e.glProgram, C)).indexOf("["); -1 !== D && (x = x.substring(0, D)), E = null; for (var R = 0; R < e.blocks.length; R++)if (e.blocks[R].name === x) { E = e.blocks[R]; break } if (E) { T = C, I = n.getActiveUniformBlockParameter(e.glProgram, T, 35392); var P = h ? E.flattened : E.binding + (t.bindingMappings.blockOffsets[E.set] || 0); n.uniformBlockBinding(e.glProgram, T, P), e.glBlocks[C] = { set: E.set, binding: E.binding, idx: T, name: x, size: I, glBinding: P } } else rt(16404, x) } } for (var B = 0; B < e.subpassInputs.length; ++B) { var M = e.subpassInputs[B]; e.samplerTextures.push(new op(M.set, M.binding, M.name, 28, M.count)) } if (e.samplerTextures.length > 0) { e.glSamplerTextures = new Array(e.samplerTextures.length); for (var O = 0; O < e.samplerTextures.length; ++O) { var L = e.samplerTextures[O]; e.glSamplerTextures[O] = { set: L.set, binding: L.binding, name: L.name, type: L.type, count: L.count, units: [], glUnits: null, glType: $4(L.type), glLoc: null } } } var F = [], k = [], N = r.texUnitCacheMap; if (h) for (var z = 0; z < e.samplerTextures.length; ++z) { var U = e.samplerTextures[z], V = n.getUniformLocation(e.glProgram, U.name); V && -1 !== V.id && (F.push(e.glSamplerTextures[z]), k.push(V)), void 0 === N[U.name] && (N[U.name] = U.flattened % s.maxTextureUnits) } else { for (var G = 0, H = 0; H < e.blocks.length; ++H)e.blocks[H].set === t.bindingMappings.flexibleSet && G++; for (var W = 0, X = 0; X < e.samplerTextures.length; ++X) { var q = e.samplerTextures[X], Y = n.getUniformLocation(e.glProgram, q.name); if (Y && -1 !== Y.id && (F.push(e.glSamplerTextures[X]), k.push(Y)), void 0 === N[q.name]) { var K = q.binding + t.bindingMappings.samplerTextureOffsets[q.set] + W; q.set === t.bindingMappings.flexibleSet && (K -= G), N[q.name] = K % s.maxTextureUnits, W += q.count - 1 } } } if (F.length) { for (var Q = [], Z = 0; Z < F.length; ++Z) { var J = F[Z], $ = N[J.name]; if (void 0 !== $) { J.glLoc = k[Z]; for (var et = 0; et < J.count; ++et) { for (; Q[$];)$ = ($ + 1) % s.maxTextureUnits; J.units.push($), Q[$] = !0 } } } for (var it = 0, nt = 0; nt < F.length; ++nt) { var st = F[nt]; if (!st.glLoc) { for (st.glLoc = k[nt]; Q[it];)it++; for (var at = 0; at < st.count; ++at) { for (; Q[it];)it = (it + 1) % s.maxTextureUnits; void 0 === N[st.name] && (N[st.name] = it), st.units.push(it), Q[it] = !0 } } } r.glProgram !== e.glProgram && n.useProgram(e.glProgram); for (var ot = 0; ot < F.length; ot++) { var ut = F[ot]; ut.glUnits = new Int32Array(ut.units), n.uniform1iv(ut.glLoc, ut.glUnits) } r.glProgram !== e.glProgram && n.useProgram(r.glProgram) } e.glSamplerTextures = F } } function v5(t, e) { var i = t.gl, n = t.getStateCache(); e.glProgram && (i.deleteProgram(e.glProgram), n.glProgram === e.glProgram && (i.useProgram(null), n.glProgram = null), e.glProgram = null) } function y5(t, e) { t.gl, e.glAttribs = new Array(e.attributes.length); for (var i = [0, 0, 0, 0, 0, 0, 0, 0], n = 0; n < e.attributes.length; ++n) { var r = e.attributes[n], s = void 0 !== r.stream ? r.stream : 0, a = e.gpuVertexBuffers[s], o = Q4(r.format), u = Wp[r.format].size; e.glAttribs[n] = { name: r.name, glBuffer: a.glBuffer, glType: o, size: u, count: Wp[r.format].count, stride: a.stride, componentCount: i5(o), isNormalized: void 0 !== r.isNormalized && r.isNormalized, isInstanced: void 0 !== r.isInstanced && r.isInstanced, offset: i[s] }, i[s] += u } } function b5(t, e) { for (var i = t.gl, n = t.getStateCache(), r = e.glVAOs.values(), s = r.next(), a = n.glVAO; !s.done;)i.deleteVertexArray(s.value), a === s.value && (i.bindVertexArray(null), a = null), s = r.next(); n.glVAO = a, e.glVAOs.clear() } var w5 = { gpuPipelineState: null, gpuInputAssembler: null, glPrimitive: 0, invalidateAttachments: [] }; function x5(t, e, i, n, r, s, a) { var o = t.gl, u = t.getStateCache(), h = 0; if (i && e) { u.glFramebuffer !== i.glFramebuffer && (o.bindFramebuffer(36160, i.glFramebuffer), u.glFramebuffer = i.glFramebuffer), u.viewport.left === n.x && u.viewport.top === n.y && u.viewport.width === n.width && u.viewport.height === n.height || (o.viewport(n.x, n.y, n.width, n.height), u.viewport.left = n.x, u.viewport.top = n.y, u.viewport.width = n.width, u.viewport.height = n.height), u.scissorRect.x === n.x && u.scissorRect.y === n.y && u.scissorRect.width === n.width && u.scissorRect.height === n.height || (o.scissor(n.x, n.y, n.width, n.height), u.scissorRect.x = n.x, u.scissorRect.y = n.y, u.scissorRect.width = n.width, u.scissorRect.height = n.height), w5.invalidateAttachments.length = 0; for (var c = 0; c < r.length; ++c) { var l = e.colorAttachments[c]; if (0 !== l.format) switch (l.loadOp) { case 0: break; case 1: if (15 !== u.bs.targets[0].blendColorMask && o.colorMask(!0, !0, !0, !0), 1 === e.colorAttachments.length) { var f = r[0]; o.clearColor(f.x, f.y, f.z, f.w), h |= 16384 } else q4[0] = r[c].x, q4[1] = r[c].y, q4[2] = r[c].z, q4[3] = r[c].w, o.clearBufferfv(6144, c, q4); break; case 2: w5.invalidateAttachments.push(36064 + c) } } if (e.depthStencilAttachment && 0 !== e.depthStencilAttachment.format) { switch (e.depthStencilAttachment.depthLoadOp) { case 0: break; case 1: u.dss.depthWrite || o.depthMask(!0), o.clearDepth(s), h |= 256; break; case 2: w5.invalidateAttachments.push(36096) }if (Wp[e.depthStencilAttachment.format].hasStencil) switch (e.depthStencilAttachment.stencilLoadOp) { case 0: break; case 1: u.dss.stencilWriteMaskFront || o.stencilMaskSeparate(1028, 65535), u.dss.stencilWriteMaskBack || o.stencilMaskSeparate(1029, 65535), o.clearStencil(a), h |= 1024; break; case 2: w5.invalidateAttachments.push(36128) } } if (i.glFramebuffer && w5.invalidateAttachments.length && o.invalidateFramebuffer(36160, w5.invalidateAttachments), h && o.clear(h), 16384 & h) { var d = u.bs.targets[0].blendColorMask; if (15 !== d) { var p = !!(1 & d), _ = !!(2 & d), g = !!(4 & d), m = !!(8 & d); o.colorMask(p, _, g, m) } } 256 & h && !u.dss.depthWrite && o.depthMask(!1), 1024 & h && (u.dss.stencilWriteMaskFront || o.stencilMaskSeparate(1028, 0), u.dss.stencilWriteMaskBack || o.stencilMaskSeparate(1029, 0)) } } function S5(t, e, i, n, r, s) { var a = t.gl, o = t.capabilities, u = t.getStateCache(), h = u.rs, c = u.dss, l = u.bs, f = l.blendColor, d = e && e.gpuShader, p = !1; if (e && w5.gpuPipelineState !== e) { if (w5.gpuPipelineState = e, w5.glPrimitive = e.glPrimitive, d) { var _ = d.glProgram; u.glProgram !== _ && (a.useProgram(_), u.glProgram = _, p = !0) } var g = e.rs; if (g) { if (h.cullMode !== g.cullMode) { switch (g.cullMode) { case 0: a.disable(2884); break; case 1: a.enable(2884), a.cullFace(1028); break; case 2: a.enable(2884), a.cullFace(1029) }h.cullMode = g.cullMode } var m = g.isFrontFaceCCW; h.isFrontFaceCCW !== m && (a.frontFace(m ? 2305 : 2304), h.isFrontFaceCCW = m), h.depthBias === g.depthBias && h.depthBiasSlop === g.depthBiasSlop || (a.polygonOffset(g.depthBias, g.depthBiasSlop), h.depthBias = g.depthBias, h.depthBiasSlop = g.depthBiasSlop), h.lineWidth !== g.lineWidth && (a.lineWidth(g.lineWidth), h.lineWidth = g.lineWidth) } var v = e.dss; v && (c.depthTest !== v.depthTest && (v.depthTest ? a.enable(2929) : a.disable(2929), c.depthTest = v.depthTest), c.depthWrite !== v.depthWrite && (a.depthMask(v.depthWrite), c.depthWrite = v.depthWrite), c.depthFunc !== v.depthFunc && (a.depthFunc(n5[v.depthFunc]), c.depthFunc = v.depthFunc), c.stencilTestFront === v.stencilTestFront && c.stencilTestBack === v.stencilTestBack || (v.stencilTestFront || v.stencilTestBack ? a.enable(2960) : a.disable(2960), c.stencilTestFront = v.stencilTestFront, c.stencilTestBack = v.stencilTestBack), c.stencilFuncFront === v.stencilFuncFront && c.stencilRefFront === v.stencilRefFront && c.stencilReadMaskFront === v.stencilReadMaskFront || (a.stencilFuncSeparate(1028, n5[v.stencilFuncFront], v.stencilRefFront, v.stencilReadMaskFront), c.stencilFuncFront = v.stencilFuncFront, c.stencilRefFront = v.stencilRefFront, c.stencilReadMaskFront = v.stencilReadMaskFront), c.stencilFailOpFront === v.stencilFailOpFront && c.stencilZFailOpFront === v.stencilZFailOpFront && c.stencilPassOpFront === v.stencilPassOpFront || (a.stencilOpSeparate(1028, r5[v.stencilFailOpFront], r5[v.stencilZFailOpFront], r5[v.stencilPassOpFront]), c.stencilFailOpFront = v.stencilFailOpFront, c.stencilZFailOpFront = v.stencilZFailOpFront, c.stencilPassOpFront = v.stencilPassOpFront), c.stencilWriteMaskFront !== v.stencilWriteMaskFront && (a.stencilMaskSeparate(1028, v.stencilWriteMaskFront), c.stencilWriteMaskFront = v.stencilWriteMaskFront), c.stencilFuncBack === v.stencilFuncBack && c.stencilRefBack === v.stencilRefBack && c.stencilReadMaskBack === v.stencilReadMaskBack || (a.stencilFuncSeparate(1029, n5[v.stencilFuncBack], v.stencilRefBack, v.stencilReadMaskBack), c.stencilFuncBack = v.stencilFuncBack, c.stencilRefBack = v.stencilRefBack, c.stencilReadMaskBack = v.stencilReadMaskBack), c.stencilFailOpBack === v.stencilFailOpBack && c.stencilZFailOpBack === v.stencilZFailOpBack && c.stencilPassOpBack === v.stencilPassOpBack || (a.stencilOpSeparate(1029, r5[v.stencilFailOpBack], r5[v.stencilZFailOpBack], r5[v.stencilPassOpBack]), c.stencilFailOpBack = v.stencilFailOpBack, c.stencilZFailOpBack = v.stencilZFailOpBack, c.stencilPassOpBack = v.stencilPassOpBack), c.stencilWriteMaskBack !== v.stencilWriteMaskBack && (a.stencilMaskSeparate(1029, v.stencilWriteMaskBack), c.stencilWriteMaskBack = v.stencilWriteMaskBack)); var y = e.bs; if (y) { l.isA2C !== y.isA2C && (y.isA2C ? a.enable(32926) : a.disable(32926), l.isA2C = y.isA2C); var b = y.blendColor; f.x === b.x && f.y === b.y && f.z === b.z && f.w === b.w || (a.blendColor(b.x, b.y, b.z, b.w), f.x = b.x, f.y = b.y, f.z = b.z, f.w = b.w); var w = y.targets[0], x = u.bs.targets[0]; x.blend !== w.blend && (w.blend ? a.enable(3042) : a.disable(3042), x.blend = w.blend), x.blendEq === w.blendEq && x.blendAlphaEq === w.blendAlphaEq || (a.blendEquationSeparate(s5[w.blendEq], s5[w.blendAlphaEq]), x.blendEq = w.blendEq, x.blendAlphaEq = w.blendAlphaEq), x.blendSrc === w.blendSrc && x.blendDst === w.blendDst && x.blendSrcAlpha === w.blendSrcAlpha && x.blendDstAlpha === w.blendDstAlpha || (a.blendFuncSeparate(a5[w.blendSrc], a5[w.blendDst], a5[w.blendSrcAlpha], a5[w.blendDstAlpha]), x.blendSrc = w.blendSrc, x.blendDst = w.blendDst, x.blendSrcAlpha = w.blendSrcAlpha, x.blendDstAlpha = w.blendDstAlpha), x.blendColorMask !== w.blendColorMask && (a.colorMask(!!(1 & w.blendColorMask), !!(2 & w.blendColorMask), !!(4 & w.blendColorMask), !!(8 & w.blendColorMask)), x.blendColorMask = w.blendColorMask) } } if (e && e.gpuPipelineLayout && d) { for (var S = d.glBlocks.length, T = e.gpuPipelineLayout.dynamicOffsetIndices, I = 0; I < S; I++) { var E = d.glBlocks[I], A = n[E.set], C = A && A.descriptorIndices[E.binding], D = C >= 0 && A.gpuDescriptors[C]; if (D && D.gpuBuffer) { var R = T[E.set], P = R && R[E.binding], B = D.gpuBuffer.glOffset; P >= 0 && (B += r[P]), u.glBindUBOs[E.glBinding] === D.gpuBuffer.glBuffer && u.glBindUBOOffsets[E.glBinding] === B || (B ? a.bindBufferRange(35345, E.glBinding, D.gpuBuffer.glBuffer, B, D.gpuBuffer.size) : a.bindBufferBase(35345, E.glBinding, D.gpuBuffer.glBuffer), u.glUniformBuffer = u.glBindUBOs[E.glBinding] = D.gpuBuffer.glBuffer, u.glBindUBOOffsets[E.glBinding] = B) } } for (var M = d.glSamplerTextures.length, O = 0; O < M; O++)for (var L = d.glSamplerTextures[O], F = n[L.set], k = F && F.descriptorIndices[L.binding], N = k >= 0 && F.gpuDescriptors[k], z = 0; z < L.units.length; z++) { var U = L.units[z], V = u.glTexUnits[U]; if (N && N.gpuTextureView && N.gpuTextureView.gpuTexture && N.gpuSampler) { var G = N.gpuTextureView, H = G.gpuTexture, W = G.baseLevel, j = W + G.levelCount; if (H.size > 0) { V.glTexture !== H.glTexture && (u.texUnit !== U && (a.activeTexture(33984 + U), u.texUnit = U), H.glTexture ? a.bindTexture(H.glTarget, H.glTexture) : a.bindTexture(H.glTarget, t.nullTex2D.gpuTexture.glTexture), V.glTexture = H.glTexture); var X = N.gpuSampler.getGLSampler(t, W, j); u.glSamplerUnits[U] !== X && (a.bindSampler(U, X), u.glSamplerUnits[U] = X) } N = F.gpuDescriptors[++k] } } } if (i && d && (p || w5.gpuInputAssembler !== i)) if (w5.gpuInputAssembler = i, t.extensions.useVAO) { var q = i.glVAOs.get(d.glProgram); if (!q) { var Y; q = a.createVertexArray(), i.glVAOs.set(d.glProgram, q), a.bindVertexArray(q), a.bindBuffer(34962, null), a.bindBuffer(34963, null), u.glArrayBuffer = null, u.glElementArrayBuffer = null; for (var K = 0; K < d.glInputs.length; K++) { var Q = d.glInputs[K]; Y = null; for (var Z = 0; Z < i.glAttribs.length; Z++) { var J = i.glAttribs[Z]; if (J.name === Q.name) { Y = J; break } } if (Y) { u.glArrayBuffer !== Y.glBuffer && (a.bindBuffer(34962, Y.glBuffer), u.glArrayBuffer = Y.glBuffer); for (var $ = 0; $ < Y.componentCount; ++$) { var tt = Q.glLoc + $, et = Y.offset + Y.size * $; a.enableVertexAttribArray(tt), u.glCurrentAttribLocs[tt] = !0, a.vertexAttribPointer(tt, Y.count, Y.glType, Y.isNormalized, Y.stride, et), a.vertexAttribDivisor(tt, Y.isInstanced ? 1 : 0) } } } var it = i.gpuIndexBuffer; it && a.bindBuffer(34963, it.glBuffer), a.bindVertexArray(null), a.bindBuffer(34962, null), a.bindBuffer(34963, null), u.glArrayBuffer = null, u.glElementArrayBuffer = null } u.glVAO !== q && (a.bindVertexArray(q), u.glVAO = q) } else { for (var nt = 0; nt < o.maxVertexAttributes; ++nt)u.glCurrentAttribLocs[nt] = !1; for (var rt = 0; rt < d.glInputs.length; rt++) { for (var st = d.glInputs[rt], at = null, ot = 0; ot < i.glAttribs.length; ot++) { var ut = i.glAttribs[ot]; if (ut.name === st.name) { at = ut; break } } if (at) { u.glArrayBuffer !== at.glBuffer && (a.bindBuffer(34962, at.glBuffer), u.glArrayBuffer = at.glBuffer); for (var ht = 0; ht < at.componentCount; ++ht) { var ct = st.glLoc + ht, lt = at.offset + at.size * ht; !u.glEnabledAttribLocs[ct] && ct >= 0 && (a.enableVertexAttribArray(ct), u.glEnabledAttribLocs[ct] = !0), u.glCurrentAttribLocs[ct] = !0, a.vertexAttribPointer(ct, at.count, at.glType, at.isNormalized, at.stride, lt), a.vertexAttribDivisor(ct, at.isInstanced ? 1 : 0) } } } var ft = i.gpuIndexBuffer; ft && u.glElementArrayBuffer !== ft.glBuffer && (a.bindBuffer(34963, ft.glBuffer), u.glElementArrayBuffer = ft.glBuffer); for (var dt = 0; dt < o.maxVertexAttributes; ++dt)u.glEnabledAttribLocs[dt] !== u.glCurrentAttribLocs[dt] && (a.disableVertexAttribArray(dt), u.glEnabledAttribLocs[dt] = !1) } if (e && e.dynamicStates.length) for (var pt = e.dynamicStates.length, _t = 0; _t < pt; _t++)switch (e.dynamicStates[_t]) { case 1: h.lineWidth !== s.lineWidth && (a.lineWidth(s.lineWidth), h.lineWidth = s.lineWidth); break; case 2: h.depthBias === s.depthBiasConstant && u.rs.depthBiasSlop === s.depthBiasSlope || (a.polygonOffset(s.depthBiasConstant, s.depthBiasSlope), h.depthBias = s.depthBiasConstant, h.depthBiasSlop = s.depthBiasSlope); break; case 4: var gt = s.blendConstant; f.x === gt.x && f.y === gt.y && f.z === gt.z && f.w === gt.w || (a.blendColor(gt.x, gt.y, gt.z, gt.w), f.copy(gt)); break; case 16: var mt = s.stencilStatesFront, vt = s.stencilStatesBack; c.stencilWriteMaskFront !== mt.writeMask && (a.stencilMaskSeparate(1028, mt.writeMask), c.stencilWriteMaskFront = mt.writeMask), c.stencilWriteMaskBack !== vt.writeMask && (a.stencilMaskSeparate(1029, vt.writeMask), c.stencilWriteMaskBack = vt.writeMask); break; case 32: var yt = s.stencilStatesFront, bt = s.stencilStatesBack; c.stencilRefFront === yt.reference && c.stencilReadMaskFront === yt.compareMask || (a.stencilFuncSeparate(1028, n5[c.stencilFuncFront], yt.reference, yt.compareMask), c.stencilRefFront = yt.reference, c.stencilReadMaskFront = yt.compareMask), c.stencilRefBack === bt.reference && c.stencilReadMaskBack === bt.compareMask || (a.stencilFuncSeparate(1029, n5[c.stencilFuncBack], bt.reference, bt.compareMask), c.stencilRefBack = bt.reference, c.stencilReadMaskBack = bt.compareMask) } } function T5(t, e) { var i = t.gl, n = w5.gpuInputAssembler, r = w5.glPrimitive, s = t.extensions.WEBGL_multi_draw; if (n) { var a = n.gpuIndexBuffer; if (n.gpuIndirectBuffer) { var o = n.gpuIndirectBuffer.indirects; if (o.drawByIndex) { for (var u = 0; u < o.drawCount; u++)o.byteOffsets[u] = o.offsets[u] * a.stride; if (s) o.instancedDraw ? s.multiDrawElementsInstancedWEBGL(r, o.counts, 0, n.glIndexType, o.byteOffsets, 0, o.instances, 0, o.drawCount) : s.multiDrawElementsWEBGL(r, o.counts, 0, n.glIndexType, o.byteOffsets, 0, o.drawCount); else for (var h = 0; h < o.drawCount; h++)o.instances[h] ? i.drawElementsInstanced(r, o.counts[h], n.glIndexType, o.byteOffsets[h], o.instances[h]) : i.drawElements(r, o.counts[h], n.glIndexType, o.byteOffsets[h]) } else if (s) o.instancedDraw ? s.multiDrawArraysInstancedWEBGL(r, o.offsets, 0, o.counts, 0, o.instances, 0, o.drawCount) : s.multiDrawArraysWEBGL(r, o.offsets, 0, o.counts, 0, o.drawCount); else for (var c = 0; c < o.drawCount; c++)o.instances[c] ? i.drawArraysInstanced(r, o.offsets[c], o.counts[c], o.instances[c]) : i.drawArrays(r, o.offsets[c], o.counts[c]) } else if (e.instanceCount) if (a) { if (e.indexCount > 0) { var l = e.firstIndex * a.stride; i.drawElementsInstanced(r, e.indexCount, n.glIndexType, l, e.instanceCount) } } else e.vertexCount > 0 && i.drawArraysInstanced(r, e.firstVertex, e.vertexCount, e.instanceCount); else if (a) { if (e.indexCount > 0) { var f = e.firstIndex * a.stride; i.drawElements(r, e.indexCount, n.glIndexType, f) } } else e.vertexCount > 0 && i.drawArrays(r, e.firstVertex, e.vertexCount) } } function I5(t, e) { if (t.length > 1 || e.length > 1) return !1; if (t[0] instanceof HTMLVideoElement) { var i = t[0]; return 0 === e[0].texOffset.x && 0 === e[0].texOffset.y && e[0].texExtent.width === i.videoWidth && e[0].texExtent.height === i.videoHeight } return !1 } function E5(t, e, i, n) { var r = t.gl, s = t.getStateCache(), a = s.glTexUnits[s.texUnit]; a.glTexture !== i.glTexture && (r.bindTexture(i.glTarget, i.glTexture), a.glTexture = i.glTexture); var o = 0, u = 0; switch (i.glTarget) { case 3553: if (128 & i.flags || I5(e, n)) r.texImage2D(3553, n[0].texSubres.mipLevel, i.glInternalFmt, n[0].texExtent.width, n[0].texExtent.height, 0, i.glFormat, i.glType, e[0]); else for (var h = 0; h < n.length; h++) { var c = n[h]; r.texSubImage2D(3553, c.texSubres.mipLevel, c.texOffset.x, c.texOffset.y, i.glFormat, i.glType, e[o++]) } break; case 34067: for (var l = 0; l < n.length; l++) { var f = n[l], d = f.texSubres, p = f.texOffset, _ = d.baseArrayLayer + d.layerCount; for (u = d.baseArrayLayer; u < _; ++u)r.texSubImage2D(34069 + u, d.mipLevel, p.x, p.y, i.glFormat, i.glType, e[o++]) } break; default: rt(16327) }1 & i.flags && r.generateMipmap(i.glTarget) } var A5 = new Uint8Array(1); function C5(t, e, i, n, r) { var s = t_(e).height, a = Kp(e, r.width, r.height, r.depth), o = Kp(e, n.width, 1, 1), u = Kp(e, n.width, n.height, 1), h = Kp(e, r.width, 1, 1), c = $p(Wp[e]); A5.byteLength < a && (A5 = new Uint8Array(a)); for (var l = 0, f = i, d = 0; d < r.depth; d++) { f = i + u * d; for (var p = 0; p < r.height; p += s)A5.subarray(l, l + h).set(new Uint8Array(t.buffer, t.byteOffset + f, h)), l += h, f += o } var _ = a / c.BYTES_PER_ELEMENT; return at(Number.isInteger(_), 9101), new c(A5.buffer, 0, _) } function D5(t, e, i, n) { var r = t.gl, s = t.getStateCache(), a = s.glTexUnits[s.texUnit]; a.glTexture !== i.glTexture && (r.bindTexture(i.glTarget, i.glTexture), a.glTexture = i.glTexture); var o = 0, u = 0, h = Wp[i.format], c = $p(h), l = h.isCompressed, f = t_(i.format), d = new zd, p = new kd, _ = new zd; switch (i.glTarget) { case 3553: for (var g = 0; g < n.length; g++) { var m = n[g], v = m.texSubres.mipLevel, y = m.texOffset, b = m.texExtent, w = b.width, x = b.height, S = f.width, T = f.height, I = m.buffStride; p.x = 0 === y.x ? 0 : e_(y.x, S), p.y = 0 === y.y ? 0 : e_(y.y, T), d.width = w < S ? w : e_(w, S), d.height = x < T ? w : e_(x, T), _.width = I > 0 ? I : d.width, _.height = m.buffTexHeight > 0 ? m.buffTexHeight : d.height; var E = w + p.x === i.width >> v ? w : d.width, A = x + p.y === i.height >> v ? x : d.height, C = void 0, D = e[o++]; if (_.width === d.width && _.height === d.height) { var R = Kp(i.format, E, A, 1) / c.BYTES_PER_ELEMENT; at(Number.isInteger(R), 9101), C = new c(D.buffer, D.byteOffset + m.buffOffset, R) } else C = C5(D, i.format, m.buffOffset, _, d); l ? 36196 !== i.glInternalFmt ? r.compressedTexSubImage2D(3553, v, p.x, p.y, E, A, i.glFormat, C) : r.compressedTexImage2D(3553, v, i.glInternalFmt, E, A, 0, C) : r.texSubImage2D(3553, v, p.x, p.y, E, A, i.glFormat, i.glType, C) } break; case 35866: for (var P = 0; P < n.length; P++) { var B = n[P], M = B.texSubres.mipLevel, O = B.texOffset, L = B.texExtent, F = L.width, k = L.height, N = f.width, z = f.height, U = B.buffStride, V = B.texSubres; p.x = 0 === O.x ? 0 : e_(O.x, N), p.y = 0 === O.y ? 0 : e_(O.y, z), d.width = F < N ? F : e_(F, N), d.height = k < z ? F : e_(k, z), d.depth = 1, _.width = U > 0 ? U : d.width, _.height = B.buffTexHeight > 0 ? B.buffTexHeight : d.height; var G = F + p.x === i.width >> M ? F : d.width, H = k + p.y === i.height >> M ? k : d.height, W = V.baseArrayLayer + V.layerCount; for (u = V.baseArrayLayer; u < W; ++u) { p.z = u; var j = void 0, X = e[o++]; if (_.width === d.width && _.height === d.height) { var q = Kp(i.format, G, H, 1) / c.BYTES_PER_ELEMENT; at(Number.isInteger(q), 9101), j = new c(X.buffer, X.byteOffset + B.buffOffset, q) } else j = C5(X, i.format, B.buffOffset, _, d); l ? 36196 !== i.glInternalFmt ? r.compressedTexSubImage3D(35866, M, p.x, p.y, p.z, G, H, d.depth, i.glFormat, j) : r.compressedTexImage3D(35866, M, i.glInternalFmt, G, H, d.depth, 0, j) : r.texSubImage3D(35866, M, p.x, p.y, p.z, G, H, d.depth, i.glFormat, i.glType, j) } } break; case 32879: for (var Y = 0; Y < n.length; Y++) { var K = n[Y], Q = K.texSubres.mipLevel, Z = K.texOffset, J = K.texExtent, $ = J.width, tt = J.height, et = f.width, it = f.height, nt = K.buffStride; p.x = 0 === Z.x ? 0 : e_(Z.x, et), p.y = 0 === Z.y ? 0 : e_(Z.y, it), p.z = Z.z, d.width = $ < et ? $ : e_($, et), d.height = tt < it ? $ : e_(tt, it), d.depth = J.depth, _.width = nt > 0 ? nt : d.width, _.height = K.buffTexHeight > 0 ? K.buffTexHeight : d.height; var st = $ + p.x === i.width >> Q ? $ : d.width, ot = tt + p.y === i.height >> Q ? tt : d.height, ut = void 0, ht = e[o++]; if (_.width === d.width && _.height === d.height) { var ct = Kp(i.format, st, ot, d.depth) / c.BYTES_PER_ELEMENT; at(Number.isInteger(ct), 9101), ut = new c(ht.buffer, ht.byteOffset + K.buffOffset, ct) } else ut = C5(ht, i.format, K.buffOffset, _, d); l ? 36196 !== i.glInternalFmt ? r.compressedTexSubImage3D(35866, Q, p.x, p.y, p.z, st, ot, d.depth, i.glFormat, ut) : r.compressedTexImage3D(35866, Q, i.glInternalFmt, st, ot, d.depth, 0, ut) : r.texSubImage3D(35866, Q, p.x, p.y, p.z, st, ot, d.depth, i.glFormat, i.glType, ut) } break; case 34067: for (var lt = 0; lt < n.length; lt++) { var ft = n[lt], dt = ft.texSubres.mipLevel, pt = ft.texOffset, _t = ft.texExtent, gt = _t.width, mt = _t.height, vt = f.width, yt = f.height, bt = ft.buffStride, wt = ft.texSubres; p.x = 0 === pt.x ? 0 : e_(pt.x, vt), p.y = 0 === pt.y ? 0 : e_(pt.y, yt), d.width = gt < vt ? gt : e_(gt, vt), d.height = mt < yt ? gt : e_(mt, yt), _.width = bt > 0 ? bt : d.width, _.height = ft.buffTexHeight > 0 ? ft.buffTexHeight : d.height; var xt = gt + p.x === i.width >> dt ? gt : d.width, St = mt + p.y === i.height >> dt ? mt : d.height, Tt = wt.baseArrayLayer + wt.layerCount; for (u = wt.baseArrayLayer; u < Tt; ++u) { var It = void 0, Et = e[o++]; if (_.width === d.width && _.height === d.height) { var At = Kp(i.format, xt, St, 1) / c.BYTES_PER_ELEMENT; at(Number.isInteger(At), 9101), It = new c(Et.buffer, Et.byteOffset + ft.buffOffset, At) } else It = C5(Et, i.format, ft.buffOffset, _, d); l ? 36196 !== i.glInternalFmt ? r.compressedTexSubImage2D(34069 + u, dt, p.x, p.y, xt, St, i.glFormat, It) : r.compressedTexImage2D(34069 + u, dt, i.glInternalFmt, xt, St, 0, It) : r.texSubImage2D(34069 + u, dt, p.x, p.y, xt, St, i.glFormat, i.glType, It) } } break; default: rt(16327) }1 & i.flags && r.generateMipmap(i.glTarget) } function R5(t, e, i, n) { var r = t.gl, s = t.getStateCache(), a = r.createFramebuffer(); r.bindFramebuffer(36160, a); var o = 0, u = 0, h = 1, c = 1; if (3553 === e.glTarget) for (var l = 0; l < n.length; l++) { var f = n[l]; r.framebufferTexture2D(36160, 36064, e.glTarget, e.glTexture, f.texSubres.mipLevel), o = f.texOffset.x, u = f.texOffset.y, h = f.texExtent.width, c = f.texExtent.height, r.readPixels(o, u, h, c, e.glFormat, e.glType, i[l]) } else rt(16399); r.bindFramebuffer(36160, null), s.glFramebuffer = null, r.deleteFramebuffer(a) } function P5(t, e, i, n, r) { var s = t.gl, a = t.getStateCache(), o = t.blitManager; if (o) { var u = 2 === r || 3 === r ? 9729 : 9728, h = o.srcFramebuffer, c = o.dstFramebuffer, l = a.glReadFramebuffer, f = a.glFramebuffer, d = n[0].srcSubres.mipLevel, p = n[0].dstSubres.mipLevel, _ = function (t) { var e = 0, i = 36064; return t.hasStencil ? i = 33306 : t.hasDepth && (i = 36096), t.hasDepth || t.hasStencil ? (t.hasDepth && (e |= 256), t.hasStencil && (e |= 1024)) : e |= 16384, { mask: e, attachment: i } }, g = n.map((function (t, e) { return e })); g.sort((function (t, e) { return n[t].srcSubres.mipLevel - n[e].srcSubres.mipLevel })); var m = _(Wp[e.format]), v = m.mask, y = m.attachment, b = _(Wp[i.format]).attachment; a.glReadFramebuffer !== h && (s.bindFramebuffer(36008, h), a.glReadFramebuffer = h), a.glFramebuffer !== c && (s.bindFramebuffer(36009, c), a.glFramebuffer = c), e.glTexture ? s.framebufferTexture2D(36008, y, e.glTarget, e.glTexture, d) : s.framebufferRenderbuffer(36008, y, 36161, e.glRenderbuffer), i.glTexture ? s.framebufferTexture2D(36009, b, i.glTarget, i.glTexture, p) : s.framebufferRenderbuffer(36009, b, 36161, i.glRenderbuffer); for (var w = 0; w < g.length; w++) { var x = n[g[w]]; e.glTexture && d !== x.srcSubres.mipLevel && (d = x.srcSubres.mipLevel, s.framebufferTexture2D(36008, y, e.glTarget, e.glTexture, d)), i.glTexture && p !== x.dstSubres.mipLevel && (p = x.dstSubres.mipLevel, s.framebufferTexture2D(36009, b, i.glTarget, i.glTexture, p)), s.blitFramebuffer(x.srcOffset.x, x.srcOffset.y, x.srcOffset.x + x.srcExtent.width, x.srcOffset.y + x.srcExtent.height, x.dstOffset.x, x.dstOffset.y, x.dstOffset.x + x.dstExtent.width, x.dstOffset.y + x.dstExtent.height, v, u) } a.glReadFramebuffer !== l && (s.bindFramebuffer(36008, l), a.glReadFramebuffer = l), a.glFramebuffer !== f && (s.bindFramebuffer(36009, f), a.glFramebuffer = f) } } var B5 = function () { function t() { } return t.setInstance = function (e) { t._instance = e }, n(t, null, [{ key: "instance", get: function () { return t._instance } }]), t }(); B5._instance = null; var M5 = function () { function t() { this.counts = void 0, this.offsets = void 0, this.instances = void 0, this.drawCount = 0, this.drawByIndex = !1, this.instancedDraw = !1, this.byteOffsets = void 0, this._capacity = 4, this.counts = new Int32Array(4), this.offsets = new Int32Array(4), this.instances = new Int32Array(4), this.byteOffsets = new Int32Array(4) } var e = t.prototype; return e.clearDraws = function () { this.drawCount = 0, this.drawByIndex = !1, this.instancedDraw = !1 }, e.setDrawInfo = function (t, e) { this._ensureCapacity(t), this.drawByIndex = e.indexCount > 0, this.instancedDraw = !!e.instanceCount, this.drawCount = Math.max(t + 1, this.drawCount), this.drawByIndex ? (this.counts[t] = e.indexCount, this.offsets[t] = e.firstIndex) : (this.counts[t] = e.vertexCount, this.offsets[t] = e.firstVertex), this.instances[t] = Math.max(1, e.instanceCount) }, e._ensureCapacity = function (t) { if (!(this._capacity > t)) { this._capacity = sn(t); var e = new Int32Array(this._capacity), i = new Int32Array(this._capacity), n = new Int32Array(this._capacity); this.byteOffsets = new Int32Array(this._capacity), e.set(this.counts), i.set(this.offsets), n.set(this.instances), this.counts = e, this.offsets = i, this.instances = n } }, t }(), O5 = function () { function t() { this._srcFramebuffer = void 0, this._dstFramebuffer = void 0; var t = B5.instance.gl; this._srcFramebuffer = t.createFramebuffer(), this._dstFramebuffer = t.createFramebuffer() } return t.prototype.destroy = function () { var t = B5.instance.gl; t.deleteFramebuffer(this._srcFramebuffer), t.deleteFramebuffer(this._dstFramebuffer) }, n(t, [{ key: "srcFramebuffer", get: function () { return this._srcFramebuffer } }, { key: "dstFramebuffer", get: function () { return this._dstFramebuffer } }]), t }(), L5 = function (t) { function e() { var e; return (e = t.call(this) || this)._gpuBuffer = null, e } s(e, t); var i = e.prototype; return i.getGpuBuffer = function () { return this._gpuBuffer }, i.initialize = function (t) { if ("buffer" in t) { this._isBufferView = !0; var e = t.buffer; this._usage = e.usage, this._memUsage = e.memUsage, this._size = this._stride = t.range, this._count = 1, this._flags = e.flags, this._gpuBuffer = { usage: this._usage, memUsage: this._memUsage, size: this._size, stride: this._stride, buffer: null, indirects: e.getGpuBuffer().indirects, glTarget: e.getGpuBuffer().glTarget, glBuffer: e.getGpuBuffer().glBuffer, glOffset: t.offset } } else this._usage = t.usage, this._memUsage = t.memUsage, this._size = t.size, this._stride = Math.max(t.stride || this._size, 1), this._count = this._size / this._stride, this._flags = t.flags, this._gpuBuffer = { usage: this._usage, memUsage: this._memUsage, size: this._size, stride: this._stride, buffer: null, indirects: new M5, glTarget: 0, glBuffer: null, glOffset: 0 }, o5(B5.instance, this._gpuBuffer), B5.instance.memoryStatus.bufferSize += this._size }, i.destroy = function () { this._gpuBuffer && (this._isBufferView || (u5(B5.instance, this._gpuBuffer), B5.instance.memoryStatus.bufferSize -= this._size), this._gpuBuffer = null) }, i.resize = function (t) { if (this._isBufferView) it(16379); else { var e = this._size; e !== t && (this._size = t, this._count = this._size / this._stride, this._gpuBuffer && (this._gpuBuffer.size = t, t > 0 && (h5(B5.instance, this._gpuBuffer), B5.instance.memoryStatus.bufferSize -= e, B5.instance.memoryStatus.bufferSize += t))) } }, i.update = function (t, e) { var i; this._isBufferView ? it(16380) : (i = void 0 !== e ? e : 64 & this._usage ? 0 : t.byteLength, c5(B5.instance, this._gpuBuffer, t, 0, i)) }, e }(n_), F5 = function (t) { function e() { var e; return (e = t.call(this) || this)._isInRenderPass = !1, e._curGPUPipelineState = null, e._curGPUDescriptorSets = [], e._curGPUInputAssembler = null, e._curDynamicOffsets = Array(8).fill(0), e._curDynamicStates = new Np, e._isStateInvalid = !1, e } s(e, t); var i = e.prototype; return i.initialize = function (t) { this._type = t.type, this._queue = t.queue; for (var e = B5.instance.bindingMappings.blockOffsets.length, i = 0; i < e; i++)this._curGPUDescriptorSets.push(null) }, i.destroy = function () { }, i.begin = function () { this._curGPUPipelineState = null, this._curGPUInputAssembler = null, this._curGPUDescriptorSets.length = 0, this._numDrawCalls = 0, this._numInstances = 0, this._numTris = 0 }, i.end = function () { this._isStateInvalid && this.bindStates(), this._isInRenderPass = !1 }, i.beginRenderPass = function () { rt(16401), this._isInRenderPass = !0 }, i.endRenderPass = function () { this._isInRenderPass = !1 }, i.bindPipelineState = function (t) { var e = t.gpuPipelineState; e !== this._curGPUPipelineState && (this._curGPUPipelineState = e, this._isStateInvalid = !0) }, i.bindDescriptorSet = function (t, e, i) { var n = e.gpuDescriptorSet; if (n !== this._curGPUDescriptorSets[t] && (this._curGPUDescriptorSets[t] = n, this._isStateInvalid = !0), i) { var r, s = null == (r = this._curGPUPipelineState) ? void 0 : r.gpuPipelineLayout; if (s) { for (var a = this._curDynamicOffsets, o = s.dynamicOffsetOffsets[t], u = 0; u < i.length; u++)a[o + u] = i[u]; this._isStateInvalid = !0 } } }, i.bindInputAssembler = function (t) { var e = t.gpuInputAssembler; this._curGPUInputAssembler = e, this._isStateInvalid = !0 }, i.setViewport = function (t) { var e = this._curDynamicStates.viewport; e.left === t.left && e.top === t.top && e.width === t.width && e.height === t.height && e.minDepth === t.minDepth && e.maxDepth === t.maxDepth || (e.left = t.left, e.top = t.top, e.width = t.width, e.height = t.height, e.minDepth = t.minDepth, e.maxDepth = t.maxDepth, this._isStateInvalid = !0) }, i.setScissor = function (t) { var e = this._curDynamicStates.scissor; e.x === t.x && e.y === t.y && e.width === t.width && e.height === t.height || (e.x = t.x, e.y = t.y, e.width = t.width, e.height = t.height, this._isStateInvalid = !0) }, i.setLineWidth = function (t) { this._curDynamicStates.lineWidth !== t && (this._curDynamicStates.lineWidth = t, this._isStateInvalid = !0) }, i.setDepthBias = function (t, e, i) { var n = this._curDynamicStates; n.depthBiasConstant === t && n.depthBiasClamp === e && n.depthBiasSlope === i || (n.depthBiasConstant = t, n.depthBiasClamp = e, n.depthBiasSlope = i, this._isStateInvalid = !0) }, i.setBlendConstants = function (t) { var e = this._curDynamicStates.blendConstant; e.x === t.x && e.y === t.y && e.z === t.z && e.w === t.w || (e.copy(t), this._isStateInvalid = !0) }, i.setDepthBound = function (t, e) { var i = this._curDynamicStates; i.depthMinBounds === t && i.depthMaxBounds === e || (i.depthMinBounds = t, i.depthMaxBounds = e, this._isStateInvalid = !0) }, i.setStencilWriteMask = function (t, e) { var i = this._curDynamicStates.stencilStatesFront, n = this._curDynamicStates.stencilStatesBack; 1 & t && i.writeMask !== e && (i.writeMask = e, this._isStateInvalid = !0), 2 & t && n.writeMask !== e && (n.writeMask = e, this._isStateInvalid = !0) }, i.setStencilCompareMask = function (t, e, i) { var n = this._curDynamicStates.stencilStatesFront, r = this._curDynamicStates.stencilStatesBack; 1 & t && (n.compareMask === i && n.reference === e || (n.reference = e, n.compareMask = i, this._isStateInvalid = !0)), 2 & t && (r.compareMask === i && r.reference === e || (r.reference = e, r.compareMask = i, this._isStateInvalid = !0)) }, i.draw = function () { rt(16328) }, i.updateBuffer = function () { rt(16329) }, i.copyBuffersToTexture = function () { rt(16330) }, i.execute = function () { rt(16402) }, i.pipelineBarrier = function () { }, i.bindStates = function () { rt(16401), this._isStateInvalid = !1 }, i.blitTexture = function () { rt(16401) }, e }(r_), k5 = function (t) { function e() { var e; return (e = t.call(this) || this)._gpuFramebuffer = null, e._gpuColorViews = [], e._gpuDepthStencilView = void 0, e } s(e, t); var i = e.prototype; return i.getGpuFramebuffer = function () { return this._gpuFramebuffer }, i.initialize = function (t) { var e, i = this; this._renderPass = t.renderPass, this._colorTextures = t.colorTextures || [], this._depthStencilTexture = t.depthStencilTexture || null; for (var n = [], r = 0; r < t.colorTextures.length; r++) { var s = t.colorTextures[r]; s && n.push(s.gpuTextureView) } var a = null; t.depthStencilTexture && (a = t.depthStencilTexture.gpuTextureView); var o = Number.MAX_SAFE_INTEGER, u = Number.MAX_SAFE_INTEGER; this._gpuFramebuffer = { gpuRenderPass: t.renderPass.getGpuRenderPass(), gpuColorViews: n, gpuDepthStencilView: a, glFramebuffer: null, isOffscreen: !0, get width() { return this.gpuColorViews.length > 0 ? this.gpuColorViews[0].gpuTexture.width : this.gpuDepthStencilView ? this.gpuDepthStencilView.gpuTexture.width : o }, set width(t) { o = t }, get height() { return this.gpuColorViews.length > 0 ? this.gpuColorViews[0].gpuTexture.height : this.gpuDepthStencilView ? this.gpuDepthStencilView.gpuTexture.height : u }, set height(t) { u = t } }, _5(B5.instance, this._gpuFramebuffer), this._gpuFramebuffer.gpuColorViews.forEach((function (t) { return i._gpuColorViews.push(t.gpuTexture.glTexture) })), this._gpuDepthStencilView = null == (e = this._gpuFramebuffer.gpuDepthStencilView) ? void 0 : e.gpuTexture.glTexture, this._width = this._gpuFramebuffer.width, this._height = this._gpuFramebuffer.height }, i.destroy = function () { this._gpuFramebuffer && (g5(B5.instance, this._gpuFramebuffer), this._gpuFramebuffer = null, this._gpuColorViews.length = 0, this._gpuDepthStencilView = null) }, n(e, [{ key: "needRebuild", get: function () { var t = this.getGpuFramebuffer(); if (t) { for (var e, i = 0; i < t.gpuColorViews.length; i++)if (t.gpuColorViews[i].gpuTexture.glTexture !== this._gpuColorViews[i]) return !0; if ((null == (e = t.gpuDepthStencilView) ? void 0 : e.gpuTexture.glTexture) !== this._gpuDepthStencilView) return !0 } return !1 } }]), e }(u_), N5 = function (t) { function e() { var e; return (e = t.call(this) || this)._gpuInputAssembler = null, e } s(e, t); var i = e.prototype; return i.initialize = function (t) { if (0 !== t.vertexBuffers.length) { if (this._attributes = t.attributes, this._attributesHash = this.computeAttributesHash(), this._vertexBuffers = t.vertexBuffers, t.indexBuffer) this._indexBuffer = t.indexBuffer, this._drawInfo.indexCount = this._indexBuffer.size / this._indexBuffer.stride, this._drawInfo.firstIndex = 0; else { var e = this._vertexBuffers[0]; this._drawInfo.vertexCount = e.size / e.stride, this._drawInfo.firstVertex = 0, this._drawInfo.vertexOffset = 0 } this._drawInfo.instanceCount = 0, this._drawInfo.firstInstance = 0, this._indirectBuffer = t.indirectBuffer || null; for (var i = new Array(t.vertexBuffers.length), n = 0; n < t.vertexBuffers.length; ++n) { var r = t.vertexBuffers[n]; r.getGpuBuffer() && (i[n] = r.getGpuBuffer()) } var s = null, a = 0; if (t.indexBuffer && (s = t.indexBuffer.getGpuBuffer())) switch (s.stride) { case 1: a = 5121; break; case 2: a = 5123; break; case 4: a = 5125; break; default: rt(16332) }var o = null; t.indirectBuffer && (o = t.indirectBuffer.getGpuBuffer()), this._gpuInputAssembler = { attributes: t.attributes, gpuVertexBuffers: i, gpuIndexBuffer: s, gpuIndirectBuffer: o, glAttribs: [], glIndexType: a, glVAOs: new Map }, y5(B5.instance, this._gpuInputAssembler) } else rt(16331) }, i.destroy = function () { var t = B5.instance; this._gpuInputAssembler && t.extensions.useVAO && b5(t, this._gpuInputAssembler), this._gpuInputAssembler = null }, n(e, [{ key: "gpuInputAssembler", get: function () { return this._gpuInputAssembler } }]), e }(h_), z5 = function (t) { s(i, t); var e = i.prototype; function i() { var e; return (e = t.call(this) || this)._gpuDescriptorSetLayout = null, e } return e.getGpuDescriptorSetLayout = function () { return this._gpuDescriptorSetLayout }, e.initialize = function (t) { Array.prototype.push.apply(this._bindings, t.bindings); for (var e = 0, i = -1, n = [], r = 0; r < this._bindings.length; r++) { var s = this._bindings[r]; n.push(e), e += s.count, s.binding > i && (i = s.binding) } this._bindingIndices = Array(i + 1).fill(-1); for (var a = this._descriptorIndices = Array(i + 1).fill(-1), o = 0; o < this._bindings.length; o++) { var u = this._bindings[o]; this._bindingIndices[u.binding] = o, a[u.binding] = n[o] } for (var h = [], c = 0; c < this._bindings.length; c++) { var l = this._bindings[c]; if (10 & l.descriptorType) for (var f = 0; f < l.count; f++)h.push(l.binding) } this._gpuDescriptorSetLayout = { bindings: this._bindings, dynamicBindings: h, descriptorIndices: a, descriptorCount: e } }, e.destroy = function () { this._bindings.length = 0 }, i }(l_), U5 = function (t) { function e() { var e; return (e = t.call(this) || this)._gpuPipelineLayout = null, e } s(e, t); var i = e.prototype; return i.getGpuPipelineLayout = function () { return this._gpuPipelineLayout }, i.initialize = function (t) { Array.prototype.push.apply(this._setLayouts, t.setLayouts); for (var e = [], i = [], n = 0, r = [], s = 0; s < this._setLayouts.length; s++) { for (var a = this._setLayouts[s], o = a.getGpuDescriptorSetLayout(), u = o.dynamicBindings, h = Array(a.bindingIndices.length).fill(-1), c = 0; c < u.length; c++) { var l = u[c]; h[l] < 0 && (h[l] = n + c) } i.push(o), e.push(h), r.push(n), n += u.length } this._gpuPipelineLayout = { gpuSetLayouts: i, dynamicOffsetIndices: e, dynamicOffsetCount: n, dynamicOffsetOffsets: r } }, i.destroy = function () { this._setLayouts.length = 0 }, e }(f_), V5 = [0, 1, 3, 2, 0, 0, 0, 4, 5, 6, 0, 0, 0, 0], G5 = function (t) { function e() { var e; return (e = t.call(this) || this)._gpuPipelineState = null, e } s(e, t); var i = e.prototype; return i.initialize = function (t) { this._primitive = t.primitive, this._shader = t.shader, this._pipelineLayout = t.pipelineLayout; var e = this._bs; if (t.blendState) { var i = t.blendState, n = i.targets; n && n.forEach((function (t, i) { e.setTarget(i, t) })), void 0 !== i.isA2C && (e.isA2C = i.isA2C), void 0 !== i.isIndepend && (e.isIndepend = i.isIndepend), void 0 !== i.blendColor && (e.blendColor = i.blendColor) } Object.assign(this._rs, t.rasterizerState), Object.assign(this._dss, t.depthStencilState), this._is = t.inputState, this._renderPass = t.renderPass, this._dynamicStates = t.dynamicStates; for (var r = [], s = 0; s < 31; s++)this._dynamicStates & 1 << s && r.push(1 << s); this._gpuPipelineState = { glPrimitive: V5[t.primitive], gpuShader: t.shader.gpuShader, gpuPipelineLayout: t.pipelineLayout.getGpuPipelineLayout(), rs: t.rasterizerState, dss: t.depthStencilState, bs: t.blendState, gpuRenderPass: t.renderPass.getGpuRenderPass(), dynamicStates: r } }, i.destroy = function () { this._gpuPipelineState = null }, n(e, [{ key: "gpuPipelineState", get: function () { return this._gpuPipelineState } }]), e }(v_), H5 = function (t) { function e() { return t.call(this) || this } s(e, t); var i = e.prototype; return i.beginRenderPass = function (t, e, i, n, r, s) { x5(B5.instance, t.getGpuRenderPass(), e.getGpuFramebuffer(), i, n, r, s), this._isInRenderPass = !0 }, i.draw = function (t) { if (this._isInRenderPass) { this._isStateInvalid && this.bindStates(); var e = "drawInfo" in t ? t.drawInfo : t; T5(B5.instance, e), ++this._numDrawCalls, this._numInstances += e.instanceCount; var i = e.indexCount || e.vertexCount; if (this._curGPUPipelineState) switch (this._curGPUPipelineState.glPrimitive) { case 4: this._numTris += i / 3 * Math.max(e.instanceCount, 1); break; case 5: case 6: this._numTris += (i - 2) * Math.max(e.instanceCount, 1) } } else rt(16328) }, i.setViewport = function (t) { var e = B5.instance.gl, i = B5.instance.getStateCache(); i.viewport.left === t.left && i.viewport.top === t.top && i.viewport.width === t.width && i.viewport.height === t.height || (e.viewport(t.left, t.top, t.width, t.height), i.viewport.left = t.left, i.viewport.top = t.top, i.viewport.width = t.width, i.viewport.height = t.height) }, i.setScissor = function (t) { var e = B5.instance.gl, i = B5.instance.getStateCache(); i.scissorRect.x === t.x && i.scissorRect.y === t.y && i.scissorRect.width === t.width && i.scissorRect.height === t.height || (e.scissor(t.x, t.y, t.width, t.height), i.scissorRect.x = t.x, i.scissorRect.y = t.y, i.scissorRect.width = t.width, i.scissorRect.height = t.height) }, i.updateBuffer = function (t, e, i) { if (this._isInRenderPass) rt(16329); else { var n, r = t.getGpuBuffer(); r && (n = void 0 !== i ? i : 64 & t.usage ? 0 : e.byteLength, c5(B5.instance, r, e, 0, n)) } }, i.copyBuffersToTexture = function (t, e, i) { if (this._isInRenderPass) rt(16330); else { var n = e.gpuTexture; n && D5(B5.instance, t, n, i) } }, i.execute = function () { rt(16402) }, i.bindStates = function () { S5(B5.instance, this._curGPUPipelineState, this._curGPUInputAssembler, this._curGPUDescriptorSets, this._curDynamicOffsets, this._curDynamicStates), this._isStateInvalid = !1 }, i.blitTexture = function (t, e, i, n) { var r = t.gpuTexture, s = e.gpuTexture; P5(B5.instance, r, s, i, n) }, e }(F5), W5 = function (t) { function e() { var e; return (e = t.call(this) || this).numDrawCalls = 0, e.numInstances = 0, e.numTris = 0, e } s(e, t); var i = e.prototype; return i.initialize = function (t) { this._type = t.type }, i.destroy = function () { }, i.submit = function (t) { for (var e = 0; e < t.length; e++) { var i = t[e]; this.numDrawCalls += i.numDrawCalls, this.numInstances += i.numInstances, this.numTris += i.numTris } }, i.clear = function () { this.numDrawCalls = 0, this.numInstances = 0, this.numTris = 0 }, e }(y_), j5 = function (t) { function e() { var e; return (e = t.call(this) || this)._gpuRenderPass = null, e } s(e, t); var i = e.prototype; return i.getGpuRenderPass = function () { return this._gpuRenderPass }, i.initialize = function (t) { this._colorInfos = t.colorAttachments, this._depthStencilInfo = t.depthStencilAttachment, this._subpasses = t.subpasses, this._gpuRenderPass = { colorAttachments: this._colorInfos, depthStencilAttachment: this._depthStencilInfo }, this._hash = this.computeHash() }, i.destroy = function () { this._gpuRenderPass = null }, e }(b_), X5 = function (t) { function e(e, i) { var n, r, s; return (n = t.call(this, e, i) || this)._gpuSampler = null, n._gpuSampler = { glSamplers: new Map, minFilter: n._info.minFilter, magFilter: n._info.magFilter, mipFilter: n._info.mipFilter, addressU: n._info.addressU, addressV: n._info.addressV, addressW: n._info.addressW, glMinFilter: 0, glMagFilter: 0, glWrapS: 0, glWrapT: 0, glWrapR: 0, getGLSampler: function (t, e, i) { var n = t.gl, r = e << 16 | i; if (!this.glSamplers.has(r)) { var s = n.createSampler(); if (s) { this.glSamplers.set(r, s); var a = n.samplerParameteri.bind(n), o = n.samplerParameterf.bind(n); a(s, 10241, this.glMinFilter), a(s, 10240, this.glMagFilter), a(s, 10242, this.glWrapS), a(s, 10243, this.glWrapT), a(s, 32882, this.glWrapR), o(s, 33082, e), o(s, 33083, i) } } return this.glSamplers.get(r) } }, r = B5.instance, s = n._gpuSampler, r.gl, 2 === s.minFilter || 3 === s.minFilter ? 2 === s.mipFilter || 3 === s.mipFilter ? s.glMinFilter = 9987 : 1 === s.mipFilter ? s.glMinFilter = 9985 : s.glMinFilter = 9729 : 2 === s.mipFilter || 3 === s.mipFilter ? s.glMinFilter = 9986 : 1 === s.mipFilter ? s.glMinFilter = 9984 : s.glMinFilter = 9728, 2 === s.magFilter || 3 === s.magFilter ? s.glMagFilter = 9729 : s.glMagFilter = 9728, s.glWrapS = X4[s.addressU], s.glWrapT = X4[s.addressV], s.glWrapR = X4[s.addressW], n } return s(e, t), e.prototype.destroy = function () { this._gpuSampler && (p5(B5.instance, this._gpuSampler), this._gpuSampler = null) }, n(e, [{ key: "gpuSampler", get: function () { return this._gpuSampler } }]), e }(w_), q5 = function (t) { function e() { var e; return (e = t.call(this) || this)._gpuShader = null, e } s(e, t); var i = e.prototype; return i.initialize = function (t) { this._name = t.name, this._stages = t.stages, this._attributes = t.attributes, this._blocks = t.blocks, this._samplers = t.samplers, this._gpuShader = { name: t.name, blocks: t.blocks.slice(), samplerTextures: t.samplerTextures.slice(), subpassInputs: t.subpassInputs.slice(), gpuStages: new Array(t.stages.length), glProgram: null, glInputs: [], glUniforms: [], glBlocks: [], glSamplerTextures: [] }; for (var e = 0; e < t.stages.length; ++e) { var i = t.stages[e]; this._gpuShader.gpuStages[e] = { type: i.stage, source: i.source, glShader: null } } }, i.destroy = function () { this._gpuShader && (v5(B5.instance, this._gpuShader), this._gpuShader = null) }, n(e, [{ key: "gpuShader", get: function () { return null === this._gpuShader.glProgram && m5(B5.instance, this._gpuShader), this._gpuShader } }]), e }(x_), Y5 = function () { function t() { this.glArrayBuffer = null, this.glElementArrayBuffer = null, this.glUniformBuffer = null, this.glBindUBOs = [], this.glBindUBOOffsets = [], this.glVAO = null, this.texUnit = 0, this.glTexUnits = [], this.glSamplerUnits = [], this.glRenderbuffer = null, this.glFramebuffer = null, this.glReadFramebuffer = null, this.viewport = new jd, this.scissorRect = new Nd(0, 0, 0, 0), this.rs = new d_, this.dss = new p_, this.bs = new g_, this.glProgram = null, this.glEnabledAttribLocs = [], this.glCurrentAttribLocs = [], this.texUnitCacheMap = {} } return t.prototype.initialize = function (t, e, i) { for (var n = 0; n < t; ++n)this.glTexUnits.push({ glTexture: null }); this.glSamplerUnits.length = t, this.glSamplerUnits.fill(null), this.glBindUBOs.length = e, this.glBindUBOs.fill(null), this.glBindUBOOffsets.length = e, this.glBindUBOOffsets.fill(0), this.glEnabledAttribLocs.length = i, this.glEnabledAttribLocs.fill(!1), this.glCurrentAttribLocs.length = i, this.glCurrentAttribLocs.fill(!1) }, t }(), K5 = function (t) { function e() { var e; return (e = t.call(this) || this)._gpuTexture = null, e._gpuTextureView = null, e } s(e, t); var i = e.prototype; return i.initialize = function (t, e) { var i = this, n = B5.instance, r = i._info, s = i._viewInfo, a = t, o = t; if ("texture" in t && (a = o.texture.info, i._isTextureView = !0), r.copy(a), i._isPowerOf2 = qp(r.width) && qp(r.height), i._size = Qp(r.format, i.width, i.height, i.depth, r.levelCount) * r.layerCount, i._isTextureView) { var u; if (s.copy(o), i._gpuTexture = o.texture._gpuTexture, (null == (u = i._gpuTexture) ? void 0 : u.format) !== a.format) return void J(16403); i._gpuTextureView = { gpuTexture: i._gpuTexture, type: o.type, format: o.format, baseLevel: o.baseLevel, levelCount: o.levelCount } } else i._gpuTexture = { type: a.type, format: a.format, usage: a.usage, width: a.width, height: a.height, depth: a.depth, size: i._size, arrayLayer: a.layerCount, mipLevel: a.levelCount, samples: a.samples, flags: a.flags, isPowerOf2: i._isPowerOf2, glTarget: 0, glInternalFmt: 0, glFormat: 0, glType: 0, glUsage: 0, glTexture: null, glRenderbuffer: null, glWrapS: 0, glWrapT: 0, glMinFilter: 0, glMagFilter: 0, isSwapchainTexture: e || !1 }, i._gpuTexture.isSwapchainTexture || (l5(n, i._gpuTexture), n.memoryStatus.textureSize += i._size), s.texture = i, s.type = t.type, s.format = t.format, s.baseLevel = 0, s.levelCount = t.levelCount, s.baseLayer = 0, s.layerCount = t.layerCount, i._gpuTextureView = { gpuTexture: i._gpuTexture, type: s.type, format: s.format, baseLevel: s.baseLevel, levelCount: s.levelCount } }, i.destroy = function () { var t = this, e = B5.instance; !t._isTextureView && t._gpuTexture && (f5(e, t._gpuTexture), e.memoryStatus.textureSize -= t._size, t._gpuTexture = null) }, i.getTextureHandle = function () { var t = this._gpuTexture; return t ? t.glTexture ? t.glTexture : t.glRenderbuffer ? t.glRenderbuffer : 0 : 0 }, i.resize = function (t, i) { var n = this, r = B5.instance, s = n._info; if (s.width !== t || s.height !== i) { s.levelCount === e.getLevelCount(s.width, s.height) ? s.levelCount = e.getLevelCount(t, i) : s.levelCount > 1 && (s.levelCount = Math.min(s.levelCount, e.getLevelCount(t, i))); var a = n._size; s.width = t, s.height = i, n._size = Qp(s.format, n.width, n.height, n.depth, s.levelCount) * s.layerCount; var o = n._gpuTexture; !n._isTextureView && o && (o.width = t, o.height = i, o.size = n._size, o.isSwapchainTexture || (d5(r, o), r.memoryStatus.textureSize -= a, r.memoryStatus.textureSize += n._size)) } }, i.initAsSwapchainTexture = function (t) { var e = new ip; e.format = t.format, e.usage = Wp[t.format].hasDepth ? 32 : 16, e.width = t.width, e.height = t.height, this.initialize(e, !0) }, n(e, [{ key: "gpuTexture", get: function () { return this._gpuTexture } }, { key: "gpuTextureView", get: function () { return this._gpuTextureView } }]), e }(S_), Q5 = "webglcontextlost"; function Z5(t) { t.activeTexture(33984), t.pixelStorei(3333, 1), t.pixelStorei(3317, 1), t.pixelStorei(37440, !1), t.bindFramebuffer(36160, null), t.enable(3089), t.enable(2884), t.cullFace(1029), t.frontFace(2305), t.polygonOffset(0, 0), t.enable(2929), t.depthMask(!0), t.depthFunc(513), t.stencilFuncSeparate(1028, 519, 1, 65535), t.stencilOpSeparate(1028, 7680, 7680, 7680), t.stencilMaskSeparate(1028, 65535), t.stencilFuncSeparate(1029, 519, 1, 65535), t.stencilOpSeparate(1029, 7680, 7680, 7680), t.stencilMaskSeparate(1029, 65535), t.disable(2960), t.disable(32926), t.disable(3042), t.blendEquationSeparate(32774, 32774), t.blendFuncSeparate(1, 0, 1, 0), t.colorMask(!0, !0, !0, !0), t.blendColor(0, 0, 0, 0) } function J5(t, e) { for (var i = ["", "WEBKIT_", "MOZ_"], n = 0; n < i.length; ++n) { var r = t.getExtension(i[n] + e); if (r) return r } return null } function $5(t) { var e = { EXT_texture_filter_anisotropic: J5(t, "EXT_texture_filter_anisotropic"), EXT_color_buffer_half_float: J5(t, "EXT_color_buffer_half_float"), EXT_color_buffer_float: J5(t, "EXT_color_buffer_float"), WEBGL_compressed_texture_etc1: J5(t, "WEBGL_compressed_texture_etc1"), WEBGL_compressed_texture_etc: J5(t, "WEBGL_compressed_texture_etc"), WEBGL_compressed_texture_pvrtc: J5(t, "WEBGL_compressed_texture_pvrtc"), WEBGL_compressed_texture_astc: J5(t, "WEBGL_compressed_texture_astc"), WEBGL_compressed_texture_s3tc: J5(t, "WEBGL_compressed_texture_s3tc"), WEBGL_compressed_texture_s3tc_srgb: J5(t, "WEBGL_compressed_texture_s3tc_srgb"), WEBGL_debug_shaders: J5(t, "WEBGL_debug_shaders"), WEBGL_lose_context: J5(t, "WEBGL_lose_context"), WEBGL_debug_renderer_info: J5(t, "WEBGL_debug_renderer_info"), OES_texture_half_float_linear: J5(t, "OES_texture_half_float_linear"), OES_texture_float_linear: J5(t, "OES_texture_float_linear"), WEBGL_multi_draw: null, useVAO: !0 }; return Ro.os !== Io.ANDROID && Ro.os !== Io.IOS && (e.WEBGL_multi_draw = J5(t, "WEBGL_multi_draw")), e } function t6(t) { var e = null; try { var i = { alpha: Le.ENABLE_TRANSPARENT_CANVAS, antialias: Le.ENABLE_WEBGL_ANTIALIAS, depth: !0, stencil: !0, premultipliedAlpha: !1, preserveDrawingBuffer: !1, powerPreference: "default", failIfMajorPerformanceCaveat: !1 }; e = t.getContext("webgl2", i) } catch (t) { return null } return e } var e6 = function (t) { function e() { var e; return (e = t.call(this) || this).stateCache = new Y5, e.nullTex2D = null, e.nullTexCube = null, e._canvas = null, e._webGL2ContextLostHandler = null, e._extensions = null, e._blitManager = null, e } s(e, t); var i = e.prototype; return i.initialize = function (t) { var e = this; e._canvas = t.windowHandle, e._webGL2ContextLostHandler = e._onWebGLContextLost.bind(e), e._canvas.addEventListener(Q5, e._onWebGLContextLost); var i = B5.instance, n = i.gl, r = i.capabilities; e.stateCache.initialize(r.maxTextureUnits, r.maxUniformBufferBindings, r.maxVertexAttributes), e._extensions = $5(n), Z5(n); var s = 55, a = n.getParameter(3414), o = n.getParameter(3415); a && o ? s = 55 : a && (s = 54), e._colorTexture = new K5, e._colorTexture.initAsSwapchainTexture({ swapchain: e, format: 35, width: t.width, height: t.height }), e._depthStencilTexture = new K5, e._depthStencilTexture.initAsSwapchainTexture({ swapchain: e, format: s, width: t.width, height: t.height }), e.nullTex2D = i.createTexture(new ip(1, 4, 35, 2, 2, 0)), e.nullTexCube = i.createTexture(new ip(3, 4, 35, 2, 2, 0, 6)); var u = new Wd; u.texExtent.width = 2, u.texExtent.height = 2; var h = new Uint8Array(e.nullTex2D.size); h.fill(0), i.copyBuffersToTexture([h], e.nullTex2D, [u]), u.texSubres.layerCount = 6, i.copyBuffersToTexture([h, h, h, h, h, h], e.nullTexCube, [u]), e._blitManager = new O5 }, i.destroy = function () { var t = this; t._canvas && t._webGL2ContextLostHandler && (t._canvas.removeEventListener(Q5, t._webGL2ContextLostHandler), t._webGL2ContextLostHandler = null), t.nullTex2D && (t.nullTex2D.destroy(), t.nullTex2D = null), t.nullTexCube && (t.nullTexCube.destroy(), t.nullTexCube = null), t._blitManager && (t._blitManager.destroy(), t._blitManager = null), t._extensions = null, t._canvas = null }, i.resize = function (t, e) { var i = this; i._colorTexture.width === t && i._colorTexture.height === e || (q("Resizing swapchain: " + t + "x" + e), i._canvas.width = t, i._canvas.height = e, i._colorTexture.resize(t, e), i._depthStencilTexture.resize(t, e)) }, i._onWebGLContextLost = function (t) { it(11e3), W(t) }, n(e, [{ key: "extensions", get: function () { return this._extensions } }, { key: "blitManager", get: function () { return this._blitManager } }]), e }(o_); function i6(t, e, i) { for (var n = 0; n < e.length; ++n)t[e[n]] = i } function n6(t, e, i) { for (var n = 0; n < e.length; ++n)t[e[n]] = i } var r6 = t("WebGL2Device", function (t) { function e() { var e; return (e = t.call(this) || this)._swapchain = null, e._context = null, e._bindingMappings = null, e._textureExclusive = new Array(117), e } s(e, t); var i = e.prototype; return i.getStateCache = function () { return this._swapchain.stateCache }, i.initialize = function (t) { B5.setInstance(this), this._gfxAPI = 7; var e = this._bindingMappingInfo = t.bindingMappingInfo, i = [], n = [], r = e.setIndices[0]; i[r] = 0, n[r] = 0; for (var s = 1; s < e.setIndices.length; ++s) { var a = e.setIndices[s], o = e.setIndices[s - 1]; i[a] = e.maxBlockCounts[o] + i[o], n[a] = e.maxSamplerTextureCounts[o] + n[o] } for (var u = 0; u < e.setIndices.length; ++u) { var h = e.setIndices[u]; n[h] -= e.maxBlockCounts[h] } this._bindingMappings = { blockOffsets: i, samplerTextureOffsets: n, flexibleSet: e.setIndices[e.setIndices.length - 1] }; var c = this._context = t6(s_.canvas); if (!c) return rt(16405), !1; this._queue = this.createQueue(new Mp(0)), this._cmdBuff = this.createCommandBuffer(new Bp(this._queue)); var l = c.getParameter.bind(c), f = this._caps; if (f.maxVertexAttributes = l(34921), f.maxVertexUniformVectors = l(36347), Ro.os === Io.IOS) { var d = f.maxVertexUniformVectors; tu.browserType === xo.WECHAT ? f.maxVertexUniformVectors = d < 256 ? d : 256 : tu.browserType === xo.SAFARI && (f.maxVertexUniformVectors = d < 512 ? d : 512) } f.maxFragmentUniformVectors = l(36349), f.maxTextureUnits = l(34930), f.maxVertexTextureUnits = l(35660), f.maxUniformBufferBindings = l(35375), f.maxUniformBlockSize = l(35376), f.maxTextureSize = l(3379), f.maxCubeMapTextureSize = l(34076), f.maxArrayTextureLayers = l(35071), f.max3DTextureSize = l(32883), f.uboOffsetAlignment = l(35380); var p = c.getSupportedExtensions(), _ = ""; p && p.forEach((function (t) { _ += t + " " })); var g = $5(c); g.WEBGL_debug_renderer_info ? (this._renderer = l(g.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL), this._vendor = l(g.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)) : (this._renderer = l(7937), this._vendor = l(7936)); var m = l(7938), v = this._features; v.fill(!1), this.initFormatFeatures(g), v[0] = !0, v[1] = !0, v[2] = !0, v[3] = !0; var y = ""; return this.getFormatFeatures(72) && (y += "etc1 "), this.getFormatFeatures(73) && (y += "etc2 "), this.getFormatFeatures(56) && (y += "dxt "), this.getFormatFeatures(83) && (y += "pvrtc "), this.getFormatFeatures(89) && (y += "astc "), q("WebGL2 device initialized."), q("RENDERER: " + this._renderer), q("VENDOR: " + this._vendor), q("VERSION: " + m), q("COMPRESSED_FORMAT: " + y), q("EXTENSIONS: " + _), !0 }, i.destroy = function () { this._queue && (this._queue.destroy(), this._queue = null), this._cmdBuff && (this._cmdBuff.destroy(), this._cmdBuff = null); for (var t = this._samplers.values(), e = t.next(); !e.done;)e.value.destroy(), e = t.next(); this._swapchain = null }, i.flushCommands = function () { }, i.acquire = function () { }, i.present = function () { var t = this._queue; this._numDrawCalls = t.numDrawCalls, this._numInstances = t.numInstances, this._numTris = t.numTris, t.clear() }, i.initFormatFeatures = function (t) { var e = this._formatFeatures, i = this._textureExclusive; e.fill(0), i.fill(!0); var n = 31; i6(e, [4, 14, 24, 35], n), i6(e, [5, 15, 26, 38, 47, 50, 49, 51, 25, 37, 48, 53, 54, 55], n = 15), e[52] = 15, i6(e, [8, 18, 29, 41], n = 27), i6(e, [11, 21, 32, 44], n = 26), e[52] = 15, i6(e, [7, 6, 10, 9, 13, 12, 17, 16, 20, 19, 23, 22, 28, 27, 31, 30, 34, 33, 40, 39, 43, 42, 46, 45], n = 31), n6(i, [4, 14, 24, 47, 50, 49, 35, 51, 52, 37, 7, 6, 10, 9, 13, 12, 17, 16, 20, 19, 23, 22, 40, 39, 43, 42, 46, 45, 54, 55], !1), t.EXT_color_buffer_float && (e[11] |= 1, e[21] |= 1, e[44] |= 1, n6(i, [11, 21, 44], !1)), t.EXT_color_buffer_half_float && n6(i, [8, 18, 41], !1), t.OES_texture_float_linear && (e[32] |= 4, e[44] |= 4, e[11] |= 4, e[21] |= 4), t.OES_texture_half_float_linear && (e[29] |= 4, e[41] |= 4, e[8] |= 4, e[18] |= 4), t.WEBGL_compressed_texture_etc1 && (e[72] = 6), t.WEBGL_compressed_texture_etc && i6(e, [73, 77, 74, 78, 75, 76], 6), t.WEBGL_compressed_texture_s3tc && i6(e, [56, 57, 58, 59, 60, 61, 62, 63], 6), t.WEBGL_compressed_texture_pvrtc && i6(e, [83, 84, 85, 86], 6), t.WEBGL_compressed_texture_astc && i6(e, [89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116], 6) }, i.createCommandBuffer = function (t) { var e = new (0 === t.type ? H5 : F5); return e.initialize(t), e }, i.createSwapchain = function (t) { var e = new e6; return this._swapchain = e, e.initialize(t), e }, i.createBuffer = function (t) { var e = new L5; return e.initialize(t), e }, i.createTexture = function (t) { var e = new K5; return e.initialize(t), e }, i.createDescriptorSet = function (t) { var e = new j4; return e.initialize(t), e }, i.createShader = function (t) { var e = new q5; return e.initialize(t), e }, i.createInputAssembler = function (t) { var e = new N5; return e.initialize(t), e }, i.createRenderPass = function (t) { var e = new j5; return e.initialize(t), e }, i.createFramebuffer = function (t) { var e = new k5; return e.initialize(t), e }, i.createDescriptorSetLayout = function (t) { var e = new z5; return e.initialize(t), e }, i.createPipelineLayout = function (t) { var e = new U5; return e.initialize(t), e }, i.createPipelineState = function (t) { var e = new G5; return e.initialize(t), e }, i.createQueue = function (t) { var e = new W5; return e.initialize(t), e }, i.getSampler = function (t) { var e = w_.computeHash(t); return this._samplers.has(e) || this._samplers.set(e, new X5(t, e)), this._samplers.get(e) }, i.getSwapchains = function () { return [this._swapchain] }, i.getGeneralBarrier = function (t) { var e = T_.computeHash(t); return this._generalBarrierss.has(e) || this._generalBarrierss.set(e, new T_(t, e)), this._generalBarrierss.get(e) }, i.getTextureBarrier = function (t) { var e = I_.computeHash(t); return this._textureBarriers.has(e) || this._textureBarriers.set(e, new I_(t, e)), this._textureBarriers.get(e) }, i.getBufferBarrier = function (t) { var e = E_.computeHash(t); return this._bufferBarriers.has(e) || this._bufferBarriers.set(e, new E_(t, e)), this._bufferBarriers.get(e) }, i.copyBuffersToTexture = function (t, e, i) { D5(this, t, e.gpuTexture, i) }, i.copyTextureToBuffers = function (t, e, i) { R5(this, t.gpuTexture, e, i) }, i.copyTexImagesToTexture = function (t, e, i) { E5(this, t, e.gpuTexture, i) }, n(e, [{ key: "gl", get: function () { return this._context } }, { key: "extensions", get: function () { return this._swapchain.extensions } }, { key: "nullTex2D", get: function () { return this._swapchain.nullTex2D } }, { key: "nullTexCube", get: function () { return this._swapchain.nullTexCube } }, { key: "textureExclusive", get: function () { return this._textureExclusive } }, { key: "bindingMappings", get: function () { return this._bindingMappings } }, { key: "blitManager", get: function () { return this._swapchain.blitManager } }]), e }(s_)); T.WebGL2Device = r6 } } }));
